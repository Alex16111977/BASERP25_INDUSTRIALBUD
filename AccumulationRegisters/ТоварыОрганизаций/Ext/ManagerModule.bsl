#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// См. УправлениеДоступомПереопределяемый.ПриЗаполненииСписковСОграничениемДоступа.
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(Организация)";

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ОбновлениеИнформационнойБазы

// Добавляет в список процедуры-обработчики обновления данных ИБ
// для всех поддерживаемых версий библиотеки или конфигурации.
// Вызывается перед началом обновления данных ИБ для построения плана обновления.
//
//  Обработчики - ТаблицаЗначений - описание полей, см. в процедуре
//                ОбновлениеИнформационнойБазы.НоваяТаблицаОбработчиковОбновления.
//
// Пример добавления процедуры-обработчика в список:
//  Обработчик = Обработчики.Добавить();
//  Обработчик.Версия              = "1.1.0.0";
//  Обработчик.Процедура           = "ОбновлениеИБ.ПерейтиНаВерсию_1_1_0_0";
//  Обработчик.МонопольныйРежим    = Ложь;
//
// Параметры:
// 	Обработчики - см. ОбновлениеИнформационнойБазы.НоваяТаблицаОбработчиковОбновления
//
Процедура ОписаниеОбработчиковОбновления(Обработчики) Экспорт

#Область ОбработатьДанныеДляПереходаНаНовуюВерсию
	
	Обработчик = Обработчики.Добавить();
	Обработчик.Процедура = "РегистрыНакопления.ТоварыОрганизаций.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	Обработчик.Версия = "3.5.4.400";
	Обработчик.РежимВыполнения = "Отложенно";
	Обработчик.Идентификатор = Новый УникальныйИдентификатор("ec811348-dd95-47d1-a9f6-aaf83d00c61c");
	Обработчик.ПроцедураЗаполненияДанныхОбновления = "РегистрыНакопления.ТоварыОрганизаций.ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию";
	Обработчик.ПроцедураПроверки = "ОбновлениеИнформационнойБазы.ДанныеОбновленыНаНовуюВерсиюПрограммы";
	Обработчик.Комментарий = НСтр("ru='Обновляет записи регистра накопления ""Товары организаций"". Данные в регистре накопления ""Товары организаций"" не рекомендуется использовать до момента завершения обработки. Данные будут некорректны.';uk='Оновлює записи регістру накопичення ""Товари організацій"". Дані в регістрі накопичення ""Товари організацій"" не рекомендується використовувати до завершення обробки. Дані будуть некоректні.'");
	
	Читаемые = Новый Массив;
	Читаемые.Добавить(Метаданные.РегистрыНакопления.ТоварыОрганизаций.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ПриобретениеТоваровУслуг.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.СборкаТоваров.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ПеремещениеТоваров.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Справочники.ВидыЗапасов.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Справочники.ДоговорыКонтрагентов.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Справочники.КлючиАналитикиУчетаНоменклатуры.ПолноеИмя());
	//++ НЕ УТ
	Читаемые.Добавить(Метаданные.Документы.ПередачаМатериаловВПроизводство.ПолноеИмя());
	//-- НЕ УТ
	Обработчик.ЧитаемыеОбъекты = СтрСоединить(Читаемые, ",");
	
	Изменяемые = Новый Массив;
	Изменяемые.Добавить(Метаданные.РегистрыНакопления.ТоварыОрганизаций.ПолноеИмя());
	Обработчик.ИзменяемыеОбъекты = СтрСоединить(Изменяемые, ",");
	
	Обработчик.ПриоритетыВыполнения = ОбновлениеИнформационнойБазы.ПриоритетыВыполненияОбработчика();

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.КорректировкаНазначенияТоваров.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.КорректировкаНалоговогоНазначенияЗапасов.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";
	
	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.КорректировкаОбособленногоУчетаЗапасов.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ПеремещениеТоваров.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ПорчаТоваров.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ПриобретениеТоваровУслуг.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.РеализацияТоваровУслуг.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.СборкаТоваров.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "РегистрыНакопления.ТоварыОрганизаций.СгенерироватьДокументыДляПереброскиОстатковСПустогоНазначенияПоДавальческойСхеме";
	НоваяСтрока.Порядок = "Любой";
	

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Справочники.ДоговорыКонтрагентов.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Справочники.КлючиАналитикиУчетаНоменклатуры.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	//++ НЕ УТ
	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ПередачаМатериаловВПроизводство.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";
	//-- НЕ УТ
	
	
	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Справочники.ДоговорыКонтрагентов.СоздатьРегистраторыГрафикаДвиженияТоваровПоДоговорам";
	НоваяСтрока.Порядок = "После";
	
	Исключения = ОбновлениеИнформационнойБазыПереопределяемый.ИсключенияПриДобавленииПриоритетов();
	ОбновлениеИнформационнойБазыПереопределяемый.ДобавитьПриоритетыСгенерироватьКлючиАналитикиНоменклатуры(
		Обработчик.ПриоритетыВыполнения,
		"После",
		Исключения
	);	                        

#КонецОбласти

//++ НЕ УТКА
	
#Область СгенерироватьДокументыДляПереброскиОстатковСПустогоНазначенияПоДавальческойСхеме

	Обработчик = Обработчики.Добавить();
	Обработчик.Версия = "3.5.4.400";
	Обработчик.РежимВыполнения = "Отложенно";
	Обработчик.Процедура = "РегистрыНакопления.ТоварыОрганизаций.СгенерироватьДокументыДляПереброскиОстатковСПустогоНазначенияПоДавальческойСхеме";
	Обработчик.Идентификатор = Новый УникальныйИдентификатор("63ba0784-a450-41fa-8708-6f34dd0e93d5");
	Обработчик.ПроцедураЗаполненияДанныхОбновления = "РегистрыНакопления.ТоварыОрганизаций.ЗарегистрироватьСгенерироватьДокументыДляПереброскиОстатковСПустогоНазначенияПоДавальческойСхеме";
	Обработчик.ПроцедураПроверки = "ОбновлениеИнформационнойБазы.ДанныеОбновленыНаНовуюВерсиюПрограммы";
	Обработчик.ЗапускатьТолькоВГлавномУзле = Истина;
	Обработчик.ЧитаемыеОбъекты = "Справочник.ВидыНоменклатуры,"
		+ "Документ.КорректировкаНазначенияТоваров,"
		+ "Справочник.Склады,"
		+ "Справочник.КлючиАналитикиУчетаНоменклатуры,"
		+ "Справочник.Назначения,"
		+ "Справочник.ПолитикиУчетаСерий,"
		+ "Справочник.ВидыЗапасов,"
		+ "Справочник.НаправленияДеятельности,"
		+ "РегистрСведений.АналитикаУчетаНоменклатуры,"
		+ "РегистрНакопления.ТоварыОрганизаций";
	Обработчик.ИзменяемыеОбъекты = "РегистрНакопления.ТоварыВЯчейках,"
		+ "Документ.КорректировкаНазначенияТоваров,"
		+ "Справочник.Назначения,"
		+ "РегистрСведений.ДатыПоступленияТоваровОрганизаций,"
		+ "РегистрНакопления.ОбеспечениеЗаказов,"
		+ "РегистрНакопления.ДвиженияНоменклатураНоменклатура,"
		+ "РегистрНакопления.СвободныеОстатки,"
		+ "РегистрСведений.АналитикаУчетаНоменклатуры,"
		+ "РегистрНакопления.СебестоимостьТоваров,"
		+ "РегистрНакопления.ТоварыНаСкладах,"
		+ "РегистрНакопления.ТоварыОрганизаций";
	Обработчик.БлокируемыеОбъекты = "Документ.КорректировкаНазначенияТоваров";
	Обработчик.Комментарий = НСтр("ru='Генерируются новые документы ""Корректировка назначения товаров"" для корректировки назначения по видам запасов давальцев.';uk='Генеруються нові документи ""Коригування призначення товарів"" для коригування призначення за видами запасів давальців.'");
	Обработчик.ПриоритетыВыполнения = ОбновлениеИнформационнойБазы.ПриоритетыВыполненияОбработчика();

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Справочники.КлючиАналитикиУчетаНоменклатуры.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";


	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.РеализацияТоваровУслуг.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ПорчаТоваров.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "РегистрыНакопления.ТоварыНаСкладах.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Справочники.НаправленияДеятельности.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Справочники.ВидыНоменклатуры.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Справочники.Назначения.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Справочники.ДоговорыКонтрагентов.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Справочники.Партнеры.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ЗаказПереработчику.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ВводОстатков.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "РегистрыНакопления.ПрочиеАктивыПассивы.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "До";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ВнутреннееПотреблениеТоваров.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "РегистрыНакопления.СвободныеОстатки.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "РегистрыНакопления.ОбеспечениеЗаказов.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.СборкаТоваров.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";
	//++ Локализация

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.КорректировкаНалоговогоНазначенияЗапасов.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";
	//-- Локализация

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.РаспределениеПроизводственныхЗатрат.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "РегистрыНакопления.ТоварыОрганизаций.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "РегистрыНакопления.СебестоимостьТоваров.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "До";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "РегистрыНакопления.ДвиженияНоменклатураНоменклатура.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.КорректировкаНазначенияТоваров.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.КорректировкаОбособленногоУчетаЗапасов.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ПриобретениеТоваровУслуг.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ЗаказНаСборку.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ЗаявкаНаВозвратТоваровОтКлиента.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ЗаказНаРемонт.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ЗаказНаПеремещение.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ЗаказНаВнутреннееПотребление.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ЗаказМатериаловВПроизводство.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "Документы.ЗаказКлиента.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "Любой";

	
	
	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "ОбновлениеИнформационнойБазыУТ.ОбновитьПредставленияПредопределенныхЭлементов";
	НоваяСтрока.Порядок = "Любой";   
	
	ОбновлениеИнформационнойБазыПереопределяемый.ДобавитьПриоритетыОбработатьДанныеДляГенерацииНазначений(
		Обработчик.ПриоритетыВыполнения,
		"Любой"
	);	
	
	ОбновлениеИнформационнойБазыПереопределяемый.ДобавитьПриоритетыСгенерироватьКлючиАналитикиНоменклатуры(
		Обработчик.ПриоритетыВыполнения,
		"Любой"
	);	

#КонецОбласти
	
//-- НЕ УТКА
	
КонецПроцедуры

// Параметры:
// 	Параметры - см. ОбновлениеИнформационнойБазы.ОсновныеПараметрыОтметкиКОбработке
//
Процедура ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	МетаданныеОбъекта = Метаданные.РегистрыНакопления.ТоварыОрганизаций;
	ПолноеИмяОбъекта = МетаданныеОбъекта.ПолноеИмя();
	
	ДополнительныеПараметры = ОбновлениеИнформационнойБазы.ДополнительныеПараметрыОтметкиОбработки();
	ДополнительныеПараметры.ЭтоДвижения = Истина;
	ДополнительныеПараметры.ПолноеИмяРегистра = "РегистрНакопления.ТоварыОрганизаций";
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДанныеРегистра.Регистратор КАК Ссылка
	|ПОМЕСТИТЬ ВтДанныеРегистра
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ДанныеРегистра
	|ГДЕ
	|	ДанныеРегистра.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СборкаТоваров)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Движения.Ссылка КАК Ссылка
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВтДанныеРегистра.Ссылка
	|	ИЗ
	|		ВтДанныеРегистра КАК ВтДанныеРегистра
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СборкаТоваров КАК СборкаТоваров
	|		ПО ВтДанныеРегистра.Ссылка = СборкаТоваров.Ссылка
	|			И (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СборкаТоваров) <> СборкаТоваров.ХозяйственнаяОперация)
	|	ГДЕ
	|		НЕ СборкаТоваров.Ссылка ЕСТЬ NULL
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ДанныеРегистра.Регистратор КАК Ссылка
	|	ИЗ
	|		РегистрНакопления.ТоварыОрганизаций КАК ДанныеРегистра
	|	ГДЕ
	|		(ДанныеРегистра.АналитикаУчетаНоменклатуры.Назначение <> ДанныеРегистра.ВидЗапасов.УстарелоНазначение
	|			И ДанныеРегистра.ВидЗапасов.УстарелоНазначение <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|		ИЛИ (ДанныеРегистра.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|			И ДанныеРегистра.КорВидЗапасов <> ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|			И ДанныеРегистра.КорАналитикаУчетаНоменклатуры.Назначение 
	|				<> ЕСТЬNULL(ДанныеРегистра.КорВидЗапасов.УстарелоНазначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|			И ЕСТЬNULL(ДанныеРегистра.КорВидЗапасов.УстарелоНазначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|				<> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|
	|
	//++ НЕ УТ
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Движения.Регистратор КАК Ссылка
	|	ИЗ
	|		РегистрНакопления.ТоварыОрганизаций КАК Движения
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПередачаМатериаловВПроизводство КАК ПередачаМатериаловВПроизводство
	|			ПО ПередачаМатериаловВПроизводство.Ссылка = Движения.Регистратор
	|	ГДЕ
	|		Движения.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаМатериаловВПроизводство)
	//-- НЕ УТ
	|
	|	) КАК Движения
	|");
	
	Регистраторы = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
	ОбновлениеИнформационнойБазы.ОтметитьКОбработке(
		Параметры, 
		Регистраторы, 
		ДополнительныеПараметры
	);
	
	ДополнительныеПараметры = ОбновлениеИнформационнойБазы.ДополнительныеПараметрыОтметкиОбработки();
	ДополнительныеПараметры.ЭтоДвижения = Истина;
	ДополнительныеПараметры.ПолноеИмяРегистра = "РегистрНакопления.ТоварыОрганизаций";
	
	Запрос = Новый Запрос;
	МассивТекстовЗапроса = Новый Массив;
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДанныеРегистра.Регистратор КАК Ссылка
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ДанныеРегистра
	|ГДЕ
	|	ДанныеРегистра.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|	И ДанныеРегистра.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)";
	
	МассивТекстовЗапроса.Добавить(ТекстЗапроса);
	
	
	
	
	// удаление движений для номенклатуры с типом "Работа"
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Движения.Регистратор КАК Ссылка
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК Движения
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КлючиАналитики
	|	ПО Движения.АналитикаУчетаНоменклатуры = КлючиАналитики.Ссылка
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
	|	ПО СпрНоменклатура.Ссылка = КлючиАналитики.Номенклатура
	|	И СпрНоменклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)";
	
	МассивТекстовЗапроса.Добавить(ТекстЗапроса);
	
	// исправление расхождения количества с документом сборки
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВложенныйЗапрос.Регистратор КАК Ссылка
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТоварыОрганизаций.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		ТоварыОрганизаций.Количество КАК Количество,
	|		ТоварыОрганизаций.Регистратор КАК Регистратор
	|	ИЗ
	|		РегистрНакопления.ТоварыОрганизаций КАК ТоварыОрганизаций
	|	ГДЕ
	|		ТоварыОрганизаций.Регистратор ССЫЛКА Документ.СборкаТоваров
	|		И ТоварыОрганизаций.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		СборкаТоваров.АналитикаУчетаНоменклатуры,
	|		-СборкаТоваров.Количество,
	|		СборкаТоваров.Ссылка
	|	ИЗ
	|		Документ.СборкаТоваров КАК СборкаТоваров
	|	ГДЕ
	|		СборкаТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СборкаТоваров)
	|		И ИСТИНА В
	|				(ВЫБРАТЬ ПЕРВЫЕ 1
	|					ИСТИНА
	|				ИЗ
	|					РегистрНакопления.ТоварыОрганизаций КАК Движения
	|				ГДЕ
	|					Движения.Регистратор = СборкаТоваров.Ссылка
	|					И Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		СборкаТоваровТовары.АналитикаУчетаНоменклатуры,
	|		-СборкаТоваровТовары.Количество,
	|		СборкаТоваровТовары.Ссылка
	|	ИЗ
	|		Документ.СборкаТоваров.Товары КАК СборкаТоваровТовары
	|	ГДЕ
	|		СборкаТоваровТовары.Ссылка.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РазборкаТоваров)
	|		И ИСТИНА В
	|				(ВЫБРАТЬ ПЕРВЫЕ 1
	|					ИСТИНА
	|				ИЗ
	|					РегистрНакопления.ТоварыОрганизаций КАК Движения
	|				ГДЕ
	|					Движения.Регистратор = СборкаТоваровТовары.Ссылка
	|					И Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))) КАК ВложенныйЗапрос
	|
	|СГРУППИРОВАТЬ ПО
	|	ВложенныйЗапрос.Регистратор,
	|	ВложенныйЗапрос.АналитикаУчетаНоменклатуры
	|
	|ИМЕЮЩИЕ
	|	СУММА(ВложенныйЗапрос.Количество) <> 0";
	МассивТекстовЗапроса.Добавить(ТекстЗапроса);
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ТоварыОрганизаций.Регистратор КАК Регистратор
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ТоварыОрганизаций
	|ГДЕ
	|	(ТоварыОрганизаций.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
	|	ИЛИ ТоварыОрганизаций.Регистратор ССЫЛКА Документ.КорректировкаНазначенияТоваров)
	|	И (ТоварыОрганизаций.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|				И ТоварыОрганизаций.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|			ИЛИ ТоварыОрганизаций.ВидЗапасов.РеализацияЗапасовДругойОрганизации)";
	МассивТекстовЗапроса.Добавить(ТекстЗапроса);
	
	Запрос.Текст = СтрСоединить(МассивТекстовЗапроса, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении(Истина));
	
	Регистраторы = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
	ОбновлениеИнформационнойБазы.ОтметитьКОбработке(
		Параметры, 
		Регистраторы, 
		ДополнительныеПараметры
	);
	
	ИмяРегистра = "ТоварыОрганизаций";
	ПолноеИмяРегистра = "РегистрНакопления.ТоварыОрганизаций";
	
	СписокДокументов = Новый Массив();
	СписокДокументов.Добавить("Документ.ТаможеннаяДекларацияИмпорт");
	СписокДокументов.Добавить("Документ.ПриобретениеТоваровУслуг");
	
	Для Каждого ПолноеИмяДокумента Из СписокДокументов Цикл
		ИмяДокумента = СтрРазделить(ПолноеИмяДокумента, ".")[1];
		ТекстЗапросаМеханизмаПроведения = Документы[ИмяДокумента].АдаптированныйТекстЗапросаДвиженийПоРегистру(ИмяРегистра);
		Регистраторы = ОбновлениеИнформационнойБазыУТ.РегистраторыДляПерепроведения(
			ТекстЗапросаМеханизмаПроведения,
			ПолноеИмяРегистра,
			ПолноеИмяДокумента
		);
								
		ОбновлениеИнформационнойБазы.ОтметитьРегистраторыКОбработке(
			Параметры, 
			Регистраторы, 
			ПолноеИмяРегистра
		);  
		
	КонецЦикла;
	
	
КонецПроцедуры

Процедура ОбработатьДанныеДляПереходаНаНовуюВерсию(Параметры) Экспорт

	ПолноеИмяРегистра = "РегистрНакопления.ТоварыОрганизаций";
	МетаданныеРегистра = Метаданные.РегистрыНакопления.ТоварыОрганизаций;
	
	Регистраторы = Новый Массив;
	Регистраторы.Добавить("Документ.СборкаТоваров");
	//++ НЕ УТ
	Регистраторы.Добавить("Документ.ПередачаМатериаловВПроизводство");
	//-- НЕ УТ
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	ДополнительныеПараметры = ОбновлениеИнформационнойБазы.ДополнительныеПараметрыОтметкиОбработки();
	ДополнительныеПараметры.ЭтоДвижения = Истина;
	ДополнительныеПараметры.ПолноеИмяРегистра = ПолноеИмяРегистра;
	
	Результат = ОбновлениеИнформационнойБазы.СоздатьВременнуюТаблицуРегистраторовРегистраДляОбработки(
		Параметры.Очередь,
		Неопределено,
		ПолноеИмяРегистра,
		МенеджерВременныхТаблиц
	);
		
	ДополнительныеПараметрыПроверкиБлокировки = ОбновлениеИнформационнойБазы.ДополнительныеПараметрыВыборкиДанныхДляОбработки();
	ДополнительныеПараметрыПроверкиБлокировки.ИмяВременнойТаблицы = "ВтЗаблокированныеСсылки";
	ЗаблокированныеСсылки = ОбновлениеИнформационнойБазы.СоздатьВременнуюТаблицуЗаблокированныхДляЧтенияИИзмененияСсылок(
		Параметры.Очередь,
		Регистраторы,
		МенеджерВременныхТаблиц,
		ДополнительныеПараметрыПроверкиБлокировки
	);
		
	Если НЕ Результат.ЕстьДанныеДляОбработки Тогда
		Параметры.ОбработкаЗавершена = Истина;
		Возврат;
	КонецЕсли;
	
	Если НЕ Результат.ЕстьЗаписиВоВременнойТаблице Тогда
		Параметры.ОбработкаЗавершена = Ложь;
		Возврат;
	КонецЕсли;
		
	ТекстЗапросаВыборки = 
	"ВЫБРАТЬ
	|	СсылкиДляОбработки.Регистратор КАК Регистратор
	|ИЗ
	|	&ВТДляОбработкиСсылка КАК СсылкиДляОбработки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВтЗаблокированныеСсылки
	|		ПО СсылкиДляОбработки.Регистратор = ВтЗаблокированныеСсылки.Ссылка
	|ГДЕ
	|	ВтЗаблокированныеСсылки.Ссылка ЕСТЬ NULL";
	
	ТекстЗапросаОбработчика = 
	"ВЫБРАТЬ
	|	Движения.Регистратор                   КАК Регистратор,
	|	Движения.Период                        КАК Период,
	|	Движения.ВидДвижения                   КАК ВидДвижения,
	|	ВЫБОР КОГДА Движения.ВидЗапасов <> ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|		И Движения.АналитикаУчетаНоменклатуры.Назначение <> Движения.ВидЗапасов.УстарелоНазначение
	|		И Движения.ВидЗапасов.УстарелоНазначение <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|		И НЕ Аналитика.КлючАналитики ЕСТЬ NULL
	|		ТОГДА Аналитика.КлючАналитики
	|		ИНАЧЕ Движения.АналитикаУчетаНоменклатуры
	|	КОНЕЦ                                  КАК АналитикаУчетаНоменклатуры,
	|	Движения.Организация                   КАК Организация,
	|	Движения.ВидЗапасов                    КАК ВидЗапасов,
	|	Движения.НомерГТД                      КАК НомерГТД,
	|	Движения.Количество                    КАК Количество,
	|	ВЫБОР КОГДА НЕ Сборка.ХозяйственнаяОперация ЕСТЬ NULL ТОГДА
	|		Сборка.ХозяйственнаяОперация
	//++ НЕ УТ
	|	КОГДА НЕ ПередачаМатериаловВПроизводство.ХозяйственнаяОперация ЕСТЬ NULL ТОГДА
	|		ПередачаМатериаловВПроизводство.ХозяйственнаяОперация
	//-- НЕ УТ
	|	ИНАЧЕ
	|		Движения.ХозяйственнаяОперация
	|	КОНЕЦ                                  КАК ХозяйственнаяОперация,
	|	Движения.НалоговоеНазначение           КАК НалоговоеНазначение,
	|	ВЫБОР КОГДА Движения.КорВидЗапасов <> ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|		И Движения.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		И Движения.КорАналитикаУчетаНоменклатуры.Назначение 
	|			<> ЕСТЬNULL(Движения.КорВидЗапасов.УстарелоНазначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|		И ЕСТЬNULL(Движения.КорВидЗапасов.УстарелоНазначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|			<> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|		И НЕ КорАналитика.КлючАналитики ЕСТЬ NULL
	|		ТОГДА КорАналитика.КлючАналитики
	|		ИНАЧЕ Движения.КорАналитикаУчетаНоменклатуры
	|	КОНЕЦ                                  КАК КорАналитикаУчетаНоменклатуры,
	|	ВЫБОР
	|		КОГДА Движения.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|		И Движения.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|		И Движения.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет)
	|		И Движения.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|		И Движения.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику)
	|		И Движения.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВПроизводство)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Движения.КорВидЗапасов
	|	КОНЕЦ                                  КАК КорВидЗапасов,
	|	Движения.ОрганизацияОтгрузки           КАК ОрганизацияОтгрузки,
	|	Движения.ДокументРеализации            КАК ДокументРеализации,
	|	Движения.СтатьяРасходов                КАК СтатьяРасходов,
	|	Движения.АналитикаРасходов             КАК АналитикаРасходов,
	|	Движения.Номенклатура                  КАК Номенклатура,
	|	Движения.Характеристика                КАК Характеристика,
	|	Движения.Первичное                     КАК Первичное,
	|
	|	ВЫБОР КОГДА (Аналитика.КлючАналитики ЕСТЬ NULL
	|			И Движения.АналитикаУчетаНоменклатуры.Назначение <> Движения.ВидЗапасов.УстарелоНазначение
	|			И Движения.ВидЗапасов.УстарелоНазначение <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|		ИЛИ (КорАналитика.КлючАналитики ЕСТЬ NULL 
	|			И Движения.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|			И Движения.КорАналитикаУчетаНоменклатуры.Назначение 
	|				<> ЕСТЬNULL(Движения.КорВидЗапасов.УстарелоНазначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|			И ЕСТЬNULL(Движения.КорВидЗапасов.УстарелоНазначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|				<> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|			И Движения.КорВидЗапасов <> ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка))
	|		ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК КлючиИнициализированы
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК Движения
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Ключи
	|	ПО Ключи.Ссылка = Движения.АналитикаУчетаНоменклатуры
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
	|	ПО СпрНоменклатура.Ссылка = Ключи.Номенклатура
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	|	ПО Ключи.Номенклатура = Аналитика.Номенклатура
	|		И Ключи.Характеристика = Аналитика.Характеристика
	|		И Ключи.Серия = Аналитика.Серия
	|		И Ключи.МестоХранения = Аналитика.МестоХранения
	|		И Ключи.СтатьяКалькуляции = Аналитика.СтатьяКалькуляции
	|		И Движения.ВидЗапасов.УстарелоНазначение = Аналитика.Назначение
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорКлючи
	|	ПО КорКлючи.Ссылка = Движения.КорАналитикаУчетаНоменклатуры
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КорАналитика
	|	ПО КорКлючи.Номенклатура = КорАналитика.Номенклатура
	|		И КорКлючи.Характеристика = КорАналитика.Характеристика
	|		И КорКлючи.Серия = КорАналитика.Серия
	|		И КорКлючи.МестоХранения = КорАналитика.МестоХранения
	|		И КорКлючи.СтатьяКалькуляции = КорАналитика.СтатьяКалькуляции
	|		И Движения.КорВидЗапасов.УстарелоНазначение = КорАналитика.Назначение
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СборкаТоваров КАК Сборка
	|	ПО Движения.Регистратор = Сборка.Ссылка
	|
	//++ НЕ УТ
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаМатериаловВПроизводство КАК ПередачаМатериаловВПроизводство
	|	ПО Движения.Регистратор = ПередачаМатериаловВПроизводство.Ссылка
	//-- НЕ УТ
	|
	|ГДЕ
	|	Движения.Регистратор = &Регистратор
	|	И НЕ СпрНоменклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|УПОРЯДОЧИТЬ ПО
	|	КлючиИнициализированы,
	|	НомерСтроки
	|";
	
	ТекстЗапросаВыборки = СтрЗаменить(ТекстЗапросаВыборки, "&ВТДляОбработкиСсылка", Результат.ИмяВременнойТаблицы);
	
	Запрос = Новый Запрос(ТекстЗапросаВыборки);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	ТаблицаРегистраторов = Запрос.Выполнить().Выгрузить();
	
	Для Каждого СтрокаТаблицы Из ТаблицаРегистраторов Цикл
		
		Регистратор = СтрокаТаблицы.Регистратор;
		
		Если ТипЗнч(Регистратор) = Тип("ДокументСсылка.ТаможеннаяДекларацияИмпорт")
			Или ТипЗнч(Регистратор) = Тип("ДокументСсылка.СборкаТоваров")
			Или ТипЗнч(Регистратор) = Тип("ДокументСсылка.ПриобретениеТоваровУслуг")
			Или ТипЗнч(Регистратор) = Тип("ДокументСсылка.ПеремещениеТоваров")
			Или ТипЗнч(Регистратор) = Тип("ДокументСсылка.КорректировкаНазначенияТоваров") Тогда
			
			Продолжить; 
			
		КонецЕсли;
		
		НачатьТранзакцию();
		Попытка
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить(ПолноеИмяРегистра + ".НаборЗаписей");
			ЭлементБлокировки.УстановитьЗначение("Регистратор", Регистратор);
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;

			Блокировка.Заблокировать();
			
			Запрос = Новый Запрос(ТекстЗапросаОбработчика);
			Запрос.УстановитьПараметр("Регистратор", Регистратор);
			
			Набор = РегистрыНакопления.ТоварыОрганизаций.СоздатьНаборЗаписей();
			Набор.Отбор.Регистратор.Установить(Регистратор);
			
			Результат = Запрос.Выполнить().Выгрузить();
			
			Если Результат.Количество() = 0 Тогда
				ОбновлениеИнформационнойБазы.ОтметитьВыполнениеОбработки(Регистратор, ДополнительныеПараметры);
				ЗафиксироватьТранзакцию();
				Продолжить;
			ИначеЕсли Результат[0].КлючиИнициализированы = 0 Тогда
				ТекстСообщения = НСтр("ru='есть необновленные ключи. Необходимо перепровести документ вручную.';uk='існують неоновлені ключі. Необхідно перепровести документ вручну.'");
				ВызватьИсключение ТекстСообщения;
			КонецЕсли;
			
			Набор.Загрузить(Результат);
			
			ОбновлениеИнформационнойБазы.ЗаписатьДанные(Набор);
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = НСтр("ru='Не удалось обработать документ: %Регистратор% по причине: %Причина%';uk='Не вдалося обробити документ: %Регистратор% по причині: %Причина%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Регистратор%", Регистратор);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ЗаписьЖурналаРегистрации(
				ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(), 
				УровеньЖурналаРегистрации.Ошибка,
				Регистратор.Метаданные(), 
				ТекстСообщения
			);
		КонецПопытки;
	КонецЦикла;
	
	Регистраторы = Новый Массив;
	Регистраторы.Добавить("Документ.ТаможеннаяДекларацияИмпорт");
	Регистраторы.Добавить("Документ.СборкаТоваров");
	Регистраторы.Добавить("Документ.ПриобретениеТоваровУслуг");
	Регистраторы.Добавить("Документ.ПеремещениеТоваров");
	Регистраторы.Добавить("Документ.КорректировкаНазначенияТоваров");
	
	ОбновлениеИнформационнойБазыУТ.ПерезаписатьДвиженияИзОчереди(
		Регистраторы, 
		ПолноеИмяРегистра, 
		Параметры.Очередь
	);
	
	Параметры.ОбработкаЗавершена = Не ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Параметры.Очередь, ПолноеИмяРегистра);
	
	
КонецПроцедуры

//++ НЕ УТКА

Процедура ЗарегистрироватьСгенерироватьДокументыДляПереброскиОстатковСПустогоНазначенияПоДавальческойСхеме(Параметры) Экспорт
	
	Возврат;
	
КонецПроцедуры

Процедура СгенерироватьДокументыДляПереброскиОстатковСПустогоНазначенияПоДавальческойСхеме(Параметры) Экспорт
	
	Если Не ОбновлениеИнформационнойБазы.ОбработкаДанныхЗавершена(Параметры.Очередь, "РегистрНакопления.ТоварыОрганизаций") Тогда
		Параметры.ОбработкаЗавершена = Ложь;
		Возврат;
	КонецЕсли;
	
	ИспользуетсяПроизводство2_2 = ПолучитьФункциональнуюОпцию("ИспользоватьУправлениеПроизводством2_2");
	
	ТекстРазделителяЗапросов = 
	"
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|";
	
	ТекстЗапросаОстатковТоваровОрганизаций =
	"ВЫБРАТЬ ПЕРВЫЕ 500
	|	ТоварыОрганизацийОстатки.АналитикаУчетаНоменклатуры,
	|	ИСТИНА КАК ИсходноеНазначениеДвиженияПоСкладскимРегистрам,
	|	ТоварыОрганизацийОстатки.Организация КАК Организация,
	|	ТоварыОрганизацийОстатки.ВидЗапасов,
	|	ТоварыОрганизацийОстатки.НомерГТД,
	|	ТоварыОрганизацийОстатки.КоличествоОстаток КАК Количество,
	|	ТоварыОрганизацийОстатки.КоличествоОстаток КАК КоличествоУпаковок,
	|	ТоварыОрганизацийОстатки.ВидЗапасов.ВладелецТовара КАК Партнер,
	|	ТоварыОрганизацийОстатки.ВидЗапасов.Договор КАК Договор,
	|	ТоварыОрганизацийОстатки.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	ТоварыОрганизацийОстатки.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ТоварыОрганизацийОстатки.АналитикаУчетаНоменклатуры.Серия КАК Серия,
	|	ТоварыОрганизацийОстатки.АналитикаУчетаНоменклатуры.СкладскаяТерритория КАК Склад,
	|	ТоварыОрганизацийОстатки.АналитикаУчетаНоменклатуры.СтатьяКалькуляции КАК СтатьяКалькуляции
	|ПОМЕСТИТЬ ВтТоварыОрганизаций
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций.Остатки(
	|			,
	|			АналитикаУчетаНоменклатуры.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|					И ВидЗапасов.ТипЗапасов В
	|						(ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца),
	|						 ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца))) КАК ТоварыОрганизацийОстатки
	|ГДЕ
	|	ТоварыОрганизацийОстатки.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)";
	
	Если ИспользуетсяПроизводство2_2 Тогда
		
		// В качестве новых назначений - назначения давальца "в целом"
		
		ТекстЗапросаБазовыеНазначения = 
		"ВЫБРАТЬ
		|	ВтТоварыОрганизаций.Партнер        КАК Партнер,
		|	ВтТоварыОрганизаций.Договор        КАК Договор,
		|	МАКСИМУМ(ТаблицаНазначения.Ссылка) КАК Назначение
		|ПОМЕСТИТЬ ВТБазовыеНазначенияДавальцев
		|ИЗ
		|	Справочник.Назначения КАК ТаблицаНазначения
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтТоварыОрганизаций КАК ВтТоварыОрганизаций
		|		ПО ТаблицаНазначения.Партнер = ВтТоварыОрганизаций.Партнер
		|			И ТаблицаНазначения.Договор = ВтТоварыОрганизаций.Договор
		|			И ТаблицаНазначения.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|			И ТаблицаНазначения.ТипНазначения = ЗНАЧЕНИЕ(Перечисление.ТипыНазначений.ДавальческоеМатериалы22)
		|ГДЕ
		|	НЕ ТаблицаНазначения.Ссылка.ПометкаУдаления
		|
		|СГРУППИРОВАТЬ ПО
		|	ВтТоварыОрганизаций.Партнер,
		|	ВтТоварыОрганизаций.Договор";
	Иначе
		
		// В качестве новых назначений - первое вхождение назначения заказа давальца
		
		ТекстЗапросаБазовыеНазначения = 
		"ВЫБРАТЬ
		|	ВтТоварыОрганизаций.Партнер        КАК Партнер,
		|	ВтТоварыОрганизаций.Договор        КАК Договор,
		|	МАКСИМУМ(ТаблицаНазначения.Ссылка) КАК Назначение
		|ПОМЕСТИТЬ ВТБазовыеНазначенияДавальцев
		|ИЗ
		|	Справочник.Назначения КАК ТаблицаНазначения
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтТоварыОрганизаций КАК ВтТоварыОрганизаций
		|		ПО ВтТоварыОрганизаций.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)
		|			И ТаблицаНазначения.Заказ ССЫЛКА Документ.ЗаказДавальца
		|			И ВЫРАЗИТЬ(ТаблицаНазначения.Заказ КАК Документ.ЗаказДавальца).Партнер = ВтТоварыОрганизаций.Партнер
		|			И ВЫРАЗИТЬ(ТаблицаНазначения.Заказ КАК Документ.ЗаказДавальца).Договор = ВтТоварыОрганизаций.Договор
		|			И ТаблицаНазначения.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|ГДЕ
		|	НЕ ТаблицаНазначения.Ссылка.ПометкаУдаления
		|	И НЕ ВЫРАЗИТЬ(ТаблицаНазначения.Заказ КАК Документ.ЗаказДавальца).ПометкаУдаления
		|
		|СГРУППИРОВАТЬ ПО
		|	ВтТоварыОрганизаций.Партнер,
		|	ВтТоварыОрганизаций.Договор";
	КонецЕсли;
	
	ТекстЗапросаВыборка = 
	"ВЫБРАТЬ
	|	ВтТоварыОрганизаций.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ИСТИНА                                         КАК ИсходноеНазначениеДвиженияПоСкладскимРегистрам,
	|	ВтТоварыОрганизаций.Организация                КАК Организация,
	|	ВтТоварыОрганизаций.ВидЗапасов                 КАК ВидЗапасов,
	|	ВтТоварыОрганизаций.НомерГТД                   КАК НомерГТД,
	|	ВтТоварыОрганизаций.Количество                 КАК Количество,
	|	ВтТоварыОрганизаций.КоличествоУпаковок         КАК КоличествоУпаковок,
	|	ВтТоварыОрганизаций.Партнер                    КАК Партнер,
	|	ВтТоварыОрганизаций.Договор                    КАК Договор,
	|	ВтТоварыОрганизаций.Номенклатура               КАК Номенклатура,
	|	ВтТоварыОрганизаций.Характеристика             КАК Характеристика,
	|	ВтТоварыОрганизаций.Серия                      КАК Серия,
	|	ВтТоварыОрганизаций.Склад                      КАК Склад,
	|	ВтТоварыОрганизаций.СтатьяКалькуляции          КАК СтатьяКалькуляции,
	|	МАКСИМУМ(ЕСТЬNULL(ВТБазовыеНазначенияДавальцев.Назначение,
	|		ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)))
	|	                                               КАК Назначение
	|ИЗ
	|	ВтТоварыОрганизаций КАК ВтТоварыОрганизаций
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТБазовыеНазначенияДавальцев
	|		ПО ВтТоварыОрганизаций.Партнер = ВТБазовыеНазначенияДавальцев.Партнер
	|			И ВтТоварыОрганизаций.Договор = ВТБазовыеНазначенияДавальцев.Договор
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтТоварыОрганизаций.АналитикаУчетаНоменклатуры,
	|	ВтТоварыОрганизаций.Организация,
	|	ВтТоварыОрганизаций.ВидЗапасов,
	|	ВтТоварыОрганизаций.НомерГТД,
	|	ВтТоварыОрганизаций.Количество,
	|	ВтТоварыОрганизаций.КоличествоУпаковок,
	|	ВтТоварыОрганизаций.Партнер,
	|	ВтТоварыОрганизаций.Договор,
	|	ВтТоварыОрганизаций.Номенклатура,
	|	ВтТоварыОрганизаций.Характеристика,
	|	ВтТоварыОрганизаций.Серия,
	|	ВтТоварыОрганизаций.Склад,
	|	ВтТоварыОрганизаций.СтатьяКалькуляции
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	Партнер";
	
	ТекстЗапроса = 
		ТекстЗапросаОстатковТоваровОрганизаций
		+ ТекстРазделителяЗапросов
		+ ТекстЗапросаБазовыеНазначения
		+ ТекстРазделителяЗапросов
		+ ТекстЗапросаВыборка;
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Период", ТекущаяДатаСеанса());
	
	РезультатЗапроса = Запрос.Выполнить().Выгрузить();
	
	ТекущаяОрганизация = Неопределено;
	ТекущийПартнер     = Неопределено;
	НовыйДокумент      = Неопределено;
	НазначениеПартнера = Неопределено;
	
	КоличествоИндексовСтрок = РезультатЗапроса.Количество() - 1;
	
	Для ИндексСтроки = 0 По КоличествоИндексовСтрок Цикл
		
		ТекущаяСтрока = РезультатЗапроса[ИндексСтроки];
		
		Если Не ЗначениеЗаполнено(ТекущаяСтрока.Назначение)
			И Не ИспользуетсяПроизводство2_2 Тогда
			Продолжить;
			// При отсутствии в БД подходящего назначения, можно создать новое только при включенном производстве 2.2.
		КонецЕсли;
		
		Если ТекущаяОрганизация <> ТекущаяСтрока.Организация
			Или ТекущийПартнер <> ТекущаяСтрока.Партнер Тогда
			
			ТекущаяОрганизация = ТекущаяСтрока.Организация;
			ТекущийПартнер = ТекущаяСтрока.Партнер;
			НазначениеПартнера = Неопределено;
			
			НовыйДокумент = Документы.КорректировкаНазначенияТоваров.СоздатьДокумент();
			НовыйДокумент.Организация = ТекущаяСтрока.Организация;
			НовыйДокумент.Дата = ТекущаяДатаСеанса();
			НовыйДокумент.ВидОперации = Перечисления.ВидыОперацийКорректировкиНазначения.ПроизвольнаяКорректировкаНазначений;
			НовыйДокумент.ВидыЗапасовУказаныВручную = Истина;
			НовыйДокумент.ДополнительныеСвойства.Вставить("ПрограммноеСозданиеДокумента");
			
			НомерВерсии = "2.5.4";
			Комментарий = НСтр("ru='Документ создан автоматически при переходе на версию %1. Организация: %2, Партнер: %3.';uk='Документ створено автоматично при переході на версію %1. Організація: %2, Партнер: %3.'");
			Комментарий = СтрШаблон(Комментарий, НомерВерсии, ТекущаяОрганизация, ТекущийПартнер);
			
			НовыйДокумент.Комментарий = Комментарий;
			
		КонецЕсли;
		
		// Довычисление полей
		
		Если ЗначениеЗаполнено(ТекущаяСтрока.Назначение) Тогда
			НазначениеПартнера = ТекущаяСтрока.Назначение;
		ИначеЕсли Не ЗначениеЗаполнено(ТекущаяСтрока.Назначение)
			И ЗначениеЗаполнено(НазначениеПартнера) Тогда
			// НазначениеПартнера уже создано в предыдущей итерации - оставить как есть.
		Иначе
			
			ПараметрыНазначения = Новый Структура();
			ПараметрыНазначения.Вставить("НаправлениеДеятельности", Справочники.НаправленияДеятельности.ПустаяСсылка());
			ПараметрыНазначения.Вставить("Партнер",                 ТекущаяСтрока.Партнер);
			ПараметрыНазначения.Вставить("Договор",                 ТекущаяСтрока.Договор);
			// Только с этой настройкой можно создать назначение под давальца в целом
			ПараметрыНазначения.Вставить("УправлениеПроизводством2_2", Истина);
			
			ШаблонНазначенияДавальца = Документы.ЗаказДавальца.ШаблонНазначенияМатериалы(ПараметрыНазначения);
			
			НачатьТранзакцию();
			Попытка
				// Перед созданием нового назначения убедимся, что его все еще нет в базе
				Справочники.Назначения.УстановитьБлокировкуПоШаблону(ШаблонНазначенияДавальца);
				НазначениеПартнера = Справочники.Назначения.НайтиПоШаблону(ШаблонНазначенияДавальца);
				
				Если Не ЗначениеЗаполнено(НазначениеПартнера) Тогда
				
					ПредставлениеНазначения = Справочники.Назначения.ПредставлениеНазначенияДляЗаписиВИнформационнуюБазу(ШаблонНазначенияДавальца, Неопределено);
					
					НовоеНазначение = Справочники.Назначения.СоздатьЭлемент();
					
					ЗаполнитьЗначенияСвойств(НовоеНазначение, ШаблонНазначенияДавальца);
					НовоеНазначение.Наименование = ПредставлениеНазначения;
					НовоеНазначение.КонтролироватьТолькоНаличие = Истина;
					
					СгенерироватьДокументыДляПереброскиОстатковСПустогоНазначенияПоДавальческойСхемеЗаписьНазначения(НовоеНазначение);
					
					НазначениеПартнера = НовоеНазначение.Ссылка;
					
				КонецЕсли;
				ЗафиксироватьТранзакцию();
			Исключение
				ОтменитьТранзакцию();
				ТекстСообщения = НСтр("ru='Не удалось создать или заблокировать назначение по шаблону: Партнер: %1, Договор: %2 по причине: %3';uk='Не вдалося створити або заблокувати призначення за шаблоном: Партнер: %1, Договір: %2 по причині: %3'");
				ТекстСообщения = СтрШаблон(
					ТекстСообщения,
					ТекущаяСтрока.Партнер,
					ТекущаяСтрока.Договор,
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке())
				);
				
				ЗаписьЖурналаРегистрации(
					ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
					УровеньЖурналаРегистрации.Предупреждение,
					Метаданные.Справочники.Назначения,
					,
					ТекстСообщения
				);
				Продолжить;
			КонецПопытки;
		КонецЕсли;
		
		ВидЗапасовОприходование = ТекущаяСтрока.ВидЗапасов;
		
		ПараметрыАналитики = Новый Структура("Номенклатура, Характеристика, Склад, СтатьяКалькуляции, Назначение");
		ЗаполнитьЗначенияСвойств(ПараметрыАналитики, ТекущаяСтрока);
		ПараметрыАналитики.Назначение = НазначениеПартнера;
		
		АналитикаУчетаНоменклатурыОприходование = РегистрыСведений.АналитикаУчетаНоменклатуры.ЗначениеКлючаАналитики(ПараметрыАналитики);
		
		// Заполнение ТЧ Товары
		
		НоваяСтрока = НовыйДокумент.Товары.Добавить();
		
		ПоляСтрокиТовары = "Номенклатура, Характеристика, Склад, Серия, Количество, КоличествоУпаковок, АналитикаУчетаНоменклатуры";
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекущаяСтрока, ПоляСтрокиТовары);
		НоваяСтрока.НовоеНазначение = НазначениеПартнера;
		НоваяСтрока.АналитикаУчетаНоменклатурыОприходование = АналитикаУчетаНоменклатурыОприходование;
		
		// Заполнение ТЧ ВидыЗапасов
		
		НоваяСтрокаВидЗапаса = НовыйДокумент.ВидыЗапасов.Добавить();
		
		ПоляСтрокиВидЗапасов = "ВидЗапасов, АналитикаУчетаНоменклатуры, НомерГТД, Количество";
		ЗаполнитьЗначенияСвойств(НоваяСтрокаВидЗапаса, ТекущаяСтрока, ПоляСтрокиВидЗапасов);
		НоваяСтрокаВидЗапаса.ВидЗапасовОприходование = ВидЗапасовОприходование;
		НоваяСтрокаВидЗапаса.АналитикаУчетаНоменклатурыОприходование = АналитикаУчетаНоменклатурыОприходование;
		
		// Сторнирование корректировок назначений, которые сняли давальческий резерв (давальческий тип запасов).
		Если ТекущаяСтрока.Количество < 0 Тогда
			
			НоваяСтрока.Количество = -ТекущаяСтрока.Количество;
			НоваяСтрока.КоличествоУпаковок = -ТекущаяСтрока.КоличествоУпаковок;
			НоваяСтрокаВидЗапаса.Количество = -ТекущаяСтрока.Количество;
			
			ПоменятьПоляМестами(НоваяСтрока, "НовоеНазначение", "ИсходноеНазначение");
			ПоменятьПоляМестами(НоваяСтрока, "АналитикаУчетаНоменклатурыОприходование", "АналитикаУчетаНоменклатуры");
			
			ПоменятьПоляМестами(НоваяСтрокаВидЗапаса, "ВидЗапасовОприходование", "ВидЗапасов");
			ПоменятьПоляМестами(НоваяСтрокаВидЗапаса, "АналитикаУчетаНоменклатурыОприходование", "АналитикаУчетаНоменклатуры");
			
		КонецЕсли;
		
		ОрганизацияСледующейСтроки = Неопределено;
		ПартнерСледующейСтроки     = Неопределено;
		Если ИндексСтроки + 1 <= КоличествоИндексовСтрок Тогда
			СледующаяСтрока = РезультатЗапроса[ИндексСтроки + 1];
			ОрганизацияСледующейСтроки = СледующаяСтрока.Организация;
			ПартнерСледующейСтроки = СледующаяСтрока.Партнер;
		КонецЕсли;
		
		// Другая аналитика следующей строки, либо последняя итерация
		Если ТекущаяОрганизация <> ОрганизацияСледующейСтроки
			Или ТекущийПартнер <> ПартнерСледующейСтроки Тогда
			
			ТаблицаДляРасчетаПомещенийЯчеек = НовыйДокумент.Товары.Выгрузить();
			ТаблицаДляРасчетаПомещенийЯчеек.Колонки.Добавить("Отметка", Новый ОписаниеТипов("Булево"));
			ТаблицаДляРасчетаПомещенийЯчеек.Колонки.Добавить("ВНаличии", Новый ОписаниеТипов("Число"));
			ТаблицаДляРасчетаПомещенийЯчеек.Колонки.Добавить("СвободныйОстаток", Новый ОписаниеТипов("Число"));
			
			ТаблицаПомещенияЯчейки = Документы.КорректировкаНазначенияТоваров.ТаблицаПомещенияЯчейкиПоТоварам(
				ТаблицаДляРасчетаПомещенийЯчеек,
				НовыйДокумент.Ссылка,
				Ложь);
			
			Документы.КорректировкаНазначенияТоваров.СлитьТаблицыПоСкладуИПомещениям(ТаблицаДляРасчетаПомещенийЯчеек, ТаблицаПомещенияЯчейки);
			
			Индексов = ТаблицаДляРасчетаПомещенийЯчеек.Количество() - 1;
			Для Инд = 0 По Индексов Цикл
				ТекСтрока = ТаблицаДляРасчетаПомещенийЯчеек[Индексов - Инд];
				Если ТекСтрока.Количество = 0 Тогда
					ТаблицаДляРасчетаПомещенийЯчеек.Удалить(ТекСтрока);
				КонецЕсли;
			КонецЦикла;
			
			НовыйДокумент.Товары.Загрузить(ТаблицаДляРасчетаПомещенийЯчеек);
			
			ПоляСвертки = "ВидЗапасов, АналитикаУчетаНоменклатурыОприходование, НомерГТД, ВидЗапасовОприходование, АналитикаУчетаНоменклатуры";
			НовыйДокумент.ВидыЗапасов.Свернуть(ПоляСвертки, "Количество");
			
			ПараметрыУказанияСерий = Новый ФиксированнаяСтруктура(
				НоменклатураСервер.ПараметрыУказанияСерий(НовыйДокумент,
				Документы.КорректировкаНазначенияТоваров));
			
			НоменклатураСервер.ЗаполнитьСтатусыУказанияСерий(НовыйДокумент, ПараметрыУказанияСерий);
			
			НачатьТранзакцию();
			Попытка
				ОбновлениеИнформационнойБазы.ЗаписатьОбъект(НовыйДокумент, Неопределено, Ложь, РежимЗаписиДокумента.Проведение);
				ЗафиксироватьТранзакцию();
			Исключение
				ОтменитьТранзакцию();
				ОбновлениеИнформационнойБазыУТ.СообщитьОНеудачнойОбработке(ИнформацияОбОшибке(), НовыйДокумент);
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	КоличествоОставшихсяСтрокКОбработке = Запрос.Выполнить().Выбрать().Количество();
	
	// Неуменьшаемое количество строк к обработке (при производстве 2.1) означает, что
	// нет назначения на которое можно было бы переместить остаток.
	// Такие ситуации должны быть решены пользователем в интерактивном режиме.
	ОбработкаЗавершена = КоличествоОставшихсяСтрокКОбработке = 0
						 Или (Не ИспользуетсяПроизводство2_2
							  И КоличествоОставшихсяСтрокКОбработке = КоличествоИндексовСтрок + 1);
	
	Параметры.ОбработкаЗавершена = ОбработкаЗавершена;
	
КонецПроцедуры

Процедура СгенерироватьДокументыДляПереброскиОстатковСПустогоНазначенияПоДавальческойСхемеЗаписьНазначения(НовоеНазначение)
	
	НачатьТранзакцию();
	Попытка
		НовоеНазначение.Записать();
		ЗафиксироватьТранзакцию();
	Исключение
		ОтменитьТранзакцию();
		ОбновлениеИнформационнойБазыУТ.СообщитьОНеудачнойОбработке(ИнформацияОбОшибке(), НовоеНазначение);
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

Процедура ПоменятьПоляМестами(Строка, Поле1, Поле2)
	
	Кеш = Строка[Поле1];
	Строка[Поле1] = Строка[Поле2];
	Строка[Поле2] = Кеш;
	
КонецПроцедуры

//-- НЕ УТКА

#КонецОбласти

#КонецОбласти

#КонецЕсли
