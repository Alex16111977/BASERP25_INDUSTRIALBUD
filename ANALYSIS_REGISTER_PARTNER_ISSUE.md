# Аналіз проблеми регістра накопичення ДвиженияДенежныеСредстваКонтрагент

## Проблема
Документ "СписаниеБезналичныхДенежныхСредств" створює рухи по регістру накопичення "ДвиженияДенежныеСредстваКонтрагент" з партнером = "Неизвестный партнер". При перепроведенні документа партнер в регістрі НЕ ЗМІНЮЄТЬСЯ.

## Знайдене джерело проблеми

### Ланцюг формування значення Партнер в рухах:

1. **Функція формування рухів** (ManagerModule.bsl:4596-4700):
   ```
   Функция ТекстЗапросаТаблицаДвиженияДенежныеСредстваКонтрагент(...)
   ```

2. **Ключовий рядок** (ManagerModule.bsl:4675):
   ```sql
   ТаблицаРасшифровкаПлатежа.АналитикаУчетаПоПартнерам.Партнер КАК Партнер,
   ```

   **Партнер береться НЕ напряму з документа, а з `АналитикаУчетаПоПартнерам.Партнер`!**

3. **Тимчасова таблиця ТаблицаРасшифровкаПлатежа** формується в функції (ManagerModule.bsl:2290-2430):
   ```
   Функция ТекстЗапросаВременнаяТаблицаРасшифровкаПлатежа(...)
   ```

4. **JOIN з регістром АналитикаУчетаПоПартнерам** (ManagerModule.bsl:2421-2428):
   ```sql
   ЛЕВОЕ СОЕДИНЕНИЕ
       РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
   ПО
       ТаблицаОбъектовРасчетов.Организация = Аналитика.Организация
       И &Контрагент = Аналитика.Контрагент
       И ТаблицаОбъектовРасчетов.Партнер = Аналитика.Партнер
       И ТаблицаОбъектовРасчетов.Договор = Аналитика.Договор
       И ТаблицаОбъектовРасчетов.НаправлениеДеятельности = Аналитика.НаправлениеДеятельности
   ```

5. **Поле АналитикаУчетаПоПартнерам** (ManagerModule.bsl:2409):
   ```sql
   ЕСТЬNULL(Аналитика.КлючАналитики, НЕОПРЕДЕЛЕНО) КАК АналитикаУчетаПоПартнерам
   ```

## Структура регістру АналитикаУчетаПоПартнерам

**Виміри:**
- `Партнер` - СправочникСсылка.Партнеры
- `Организация` - СправочникСсылка.Организации
- `Контрагент` - СправочникСсылка.Контрагенты / Организации
- `Договор` - СправочникСсылка.ДоговорыКонтрагентов / ДоговорыМеждуОрганизациями
- `НаправлениеДеятельности` - СправочникСсылка.НаправленияДеятельности

**Ресурс:**
- `КлючАналитики` - СправочникСсылка.КлючиАналитикиУчетаПоПартнерам

## Причина проблеми

При **першому** проведенні документа (коли в ТЧ `РасшифровкаПлатежа.Партнер` = "Неизвестный партнер"):
1. Система створює запис в регістрі `АналитикаУчетаПоПартнерам` з:
   - Партнер = "Неизвестный партнер"
   - Организация, Контрагент, Договор, НаправлениеДеятельности
2. Створюється `КлючАналитикиУчетаПоПартнерам` з Партнер = "Неизвестный партнер"
3. Цей ключ записується в рухи регістра

При **перепроведенні** (навіть якщо в ТЧ `РасшифровкаПлатежа.Партнер` вже правильний):
1. JOIN з регістром `АналитикаУчетаПоПартнерам` знаходить **СТАРИЙ запис**
2. Старий `КлючАналитики` все ще містить "Неизвестный партнер"
3. Тому рухи формуються з "Неизвестный партнер"

**Проблема в тому, що ключ аналітики "закешований" в регістрі сведений і не оновлюється при зміні партнера в документі!**

## Рішення

### Варіант 1: Ручне виправлення через запит (рекомендовано)

1. **Змінити партнера в ТЧ РасшифровкаПлатежа** документа (якщо ще не зроблено)

2. **Видалити/оновити запис в регістрі АналитикаУчетаПоПартнерам** для цього документа:
   ```sql
   // Знайти записи з "Неизвестный партнер"
   ВЫБРАТЬ * ИЗ РегистрСведений.АналитикаУчетаПоПартнерам
   ГДЕ Партнер.Наименование ПОДОБНО "%Неизвестный%"
   ```

3. **Перепровести документ** - система створить новий ключ аналітики з правильним партнером

### Варіант 2: Обробка для масового виправлення

Створити обробку яка:
1. Знаходить всі документи `СписаниеБезналичныхДенежныхСредств` з партнером "Неизвестный партнер" в рухах
2. Для кожного документа:
   - Перевіряє чи правильний партнер в ТЧ `РасшифровкаПлатежа`
   - Видаляє старий запис в `АналитикаУчетаПоПартнерам`
   - Перепроводить документ

### Варіант 3: Виправлення ключа аналітики напряму

Змінити партнера безпосередньо в:
1. Довіднику `КлючиАналитикиУчетаПоПартнерам`
2. Регістрі сведень `АналитикаУчетаПоПартнерам`
3. Регістрі накопичення `ДвиженияДенежныеСредстваКонтрагент`

## Ключові файли

| Файл | Рядки | Опис |
|------|-------|------|
| `Documents/СписаниеБезналичныхДенежныхСредств/Ext/ManagerModule.bsl` | 4596-4786 | Функція формування рухів `ТекстЗапросаТаблицаДвиженияДенежныеСредстваКонтрагент` |
| `Documents/СписаниеБезналичныхДенежныхСредств/Ext/ManagerModule.bsl` | 2290-2430 | Функція формування тимчасової таблиці `ТекстЗапросаВременнаяТаблицаРасшифровкаПлатежа` |
| `Documents/СписаниеБезналичныхДенежныхСредств/Ext/ManagerModule.bsl` | 4675 | **КЛЮЧОВИЙ РЯДОК** де партнер береться з ключа аналітики |
| `InformationRegisters/АналитикаУчетаПоПартнерам/Ext/ManagerModule.bsl` | 1-511 | Логіка створення/оновлення ключів аналітики |

## Запити для діагностики

### Перевірка ТЧ РасшифровкаПлатежа документа:
```sql
ВЫБРАТЬ
    РП.НомерСтроки,
    РП.Партнер,
    РП.ОбъектРасчетов
ИЗ
    Документ.СписаниеБезналичныхДенежныхСредств.РасшифровкаПлатежа КАК РП
ГДЕ
    РП.Ссылка.Номер = "00014415"
```

### Перевірка рухів регістра:
```sql
ВЫБРАТЬ
    Партнер,
    Контрагент,
    Договор,
    СуммаОплаты
ИЗ
    РегистрНакопления.ДвиженияДенежныеСредстваКонтрагент
ГДЕ
    Регистратор.Номер = "00014415"
```

### Перевірка записів аналітики:
```sql
ВЫБРАТЬ
    Партнер,
    Организация,
    Контрагент,
    Договор,
    КлючАналитики
ИЗ
    РегистрСведений.АналитикаУчетаПоПартнерам
ГДЕ
    Партнер.Наименование ПОДОБНО "%Неизвестный%"
```

---

**Дата аналізу:** 2025-11-24
**Автор:** Claude Code Analysis
