&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	СписокКодовСвязанности = КонтролируемыеОперацииПовтИсп.ПолучитьСписокВыбораКодыСвязанностиКонтрагентов();
	Для каждого ЭлементСпискаКодовСвязанности Из СписокКодовСвязанности Цикл
		Элементы.КодСвязанностиЛиц1.СписокВыбора.Добавить(ЭлементСпискаКодовСвязанности.Значение, ЭлементСпискаКодовСвязанности.Представление);
		Элементы.КодСвязанностиЛиц2.СписокВыбора.Добавить(ЭлементСпискаКодовСвязанности.Значение, ЭлементСпискаКодовСвязанности.Представление);
		Элементы.КодСвязанностиЛиц3.СписокВыбора.Добавить(ЭлементСпискаКодовСвязанности.Значение, ЭлементСпискаКодовСвязанности.Представление);
		Элементы.КодСвязанностиЛиц4.СписокВыбора.Добавить(ЭлементСпискаКодовСвязанности.Значение, ЭлементСпискаКодовСвязанности.Представление);
		Элементы.КодСвязанностиЛиц5.СписокВыбора.Добавить(ЭлементСпискаКодовСвязанности.Значение, ЭлементСпискаКодовСвязанности.Представление);
	КонецЦикла;
	
	СписокКодовОпераций = КонтролируемыеОперацииПовтИсп.ПолучитьСписокВыбораКодыОпераций();
	Для каждого ЭлементСпискаКодовОпераций Из СписокКодовОпераций Цикл
		Элементы.КодКонтролируемойОперации1.СписокВыбора.Добавить(ЭлементСпискаКодовОпераций.Значение, ЭлементСпискаКодовОпераций.Представление);
		Элементы.КодКонтролируемойОперации2.СписокВыбора.Добавить(ЭлементСпискаКодовОпераций.Значение, ЭлементСпискаКодовОпераций.Представление);
		Элементы.КодКонтролируемойОперации3.СписокВыбора.Добавить(ЭлементСпискаКодовОпераций.Значение, ЭлементСпискаКодовОпераций.Представление);
		Элементы.КодКонтролируемойОперации4.СписокВыбора.Добавить(ЭлементСпискаКодовОпераций.Значение, ЭлементСпискаКодовОпераций.Представление);
	КонецЦикла;
	
	Если Параметры.Ключ.Контрагент.Пустая() Тогда
		Статус = "Р";
	КонецЕсли;
	
	УстановитьВидимость();
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	ПрочитатьДанные(ТекущийОбъект);
КонецПроцедуры

&НаСервере
Процедура ПриЗаписиНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	ЗаписатьДаные();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимость()
	
		//2016
	Код501 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "501" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "501"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "501" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "501" 
		 ИЛИ Запись.КодСвязанностиЛиц5 = "501" Тогда
		Код501 = Истина;	
	КонецЕсли;	
	
	Код502 = Ложь;
	Если 	 Запись.КодСвязанностиЛиц1 = "502" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "502"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "502"
		 ИЛИ Запись.КодСвязанностиЛиц4 = "502" 
		 ИЛИ Запись.КодСвязанностиЛиц5 = "502" Тогда
		Код502 = Истина;	
	КонецЕсли;	
	
	Код503 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "503" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "503"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "503" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "503"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "503" Тогда
		 Код503 = Истина;
	КонецЕсли;
	
	Код504 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "504" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "504"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "504" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "504"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "504" Тогда
		 Код504 = Истина;
	КонецЕсли;

	Код505 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "505" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "505"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "505" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "505"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "505" Тогда
		 Код505	 = Истина;
	КонецЕсли;
	
	Код506 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "506" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "506"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "506" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "506"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "506" Тогда
		 Код506 = Истина;
	КонецЕсли;
	
	Код507 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "507" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "507"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "507" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "507"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "507" Тогда
		 Код507 = Истина;
	КонецЕсли;
	
	Код508 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "508" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "508"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "508" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "508"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "508" Тогда
		 Код508 = Истина;
	КонецЕсли;
	
	Код509 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "509" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "509"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "509" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "509"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "509" Тогда
		 Код509 = Истина;
	КонецЕсли;
	
	Код510 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "510" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "510"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "510" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "510"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "510" Тогда
		 Код510 = Истина;
	КонецЕсли;
	
	Код513 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "513" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "513"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "513" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "513"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "513" Тогда
		 Код513 = Истина;
	КонецЕсли;
	
	Код511 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "511" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "511"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "511" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "511"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "511" Тогда
		 Код511 = Истина;
	КонецЕсли;
	
	Код516 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "516" 
		ИЛИ Запись.КодСвязанностиЛиц2 = "516"
		ИЛИ Запись.КодСвязанностиЛиц3 = "516" 
		ИЛИ Запись.КодСвязанностиЛиц4 = "516"  
		ИЛИ Запись.КодСвязанностиЛиц5 = "516" Тогда
		Код516 = Истина;
	КонецЕсли;
	Код523 = Ложь;
	Если     Запись.КодСвязанностиЛиц1 = "523" 
		 ИЛИ Запись.КодСвязанностиЛиц2 = "523"
		 ИЛИ Запись.КодСвязанностиЛиц3 = "523" 
		 ИЛИ Запись.КодСвязанностиЛиц4 = "523"  
		 ИЛИ Запись.КодСвязанностиЛиц5 = "523" Тогда
		 Код523 = Истина;
	КонецЕсли;
	
	Элементы.Связанность501_2016.Видимость = Код501 ИЛИ Код509;
	Элементы.Связанность502_2016.Видимость = Код502;
	Элементы.Связанность503_2016.Видимость = Код503;
	Элементы.Связанность504_2016.Видимость = Код504;
	Элементы.Связанность505_2016.Видимость = Код505;
	Элементы.Связанность506_2016.Видимость = Код506;
	Элементы.Связанность507_2016.Видимость = Код507;
	Элементы.Связанность508_2016.Видимость = Код508 ИЛИ Код513;

	Элементы.СвязанностьНетНастроек_2016.Видимость = НЕ (Код501 ИЛИ Код502 ИЛИ Код503 ИЛИ Код504 ИЛИ Код505 ИЛИ Код506 ИЛИ Код507 ИЛИ Код508 ИЛИ Код509 ИЛИ Код513);
		
	Элементы.Связанность501_2019.Видимость = Код501 ИЛИ Код511;
	Элементы.Связанность502_2019.Видимость = Код502;
	Элементы.Связанность503_2019.Видимость = Код503;
	Элементы.Связанность504_2019.Видимость = Код504;
	Элементы.Связанность505_2019.Видимость = Код505;
	Элементы.Связанность506_2019.Видимость = Код506;
	Элементы.Связанность507_2019.Видимость = Код507;
	Элементы.Связанность508_2019.Видимость = Код508;
	Элементы.Связанность509_2019.Видимость = Код509;
	Элементы.Связанность510_2019.Видимость = Код510 ИЛИ Код516;
	Элементы.Связанность523_2021.Видимость = Код523;
	
	Элементы.СвязанностьНетНастроек_2019.Видимость = НЕ (Код501 ИЛИ Код502 ИЛИ Код503 ИЛИ Код504 ИЛИ Код505 ИЛИ Код506 ИЛИ Код507 ИЛИ Код508 ИЛИ Код509 ИЛИ Код510 ИЛИ Код511 ИЛИ Код516 ИЛИ Код523);
	
	Если Запись.Период >= '2018-01-01' Тогда
		Элементы.Приказ_242_2019.Видимость   = Истина;
		Элементы.Приказ_8_2016.Видимость     = Ложь;
	Иначе
		Элементы.Приказ_242_2019.Видимость   = Истина;
		Элементы.Приказ_8_2016.Видимость     = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПрочитатьДанные(ТекущийОбъект)

	ВариантыСвязей = Новый СписокЗначений;
	ВариантыСвязей.Добавить("2016");
	ВариантыСвязей.Добавить("2019");
	ВариантыСвязей.Добавить("2021");
	
	Для каждого ВариантСвязи Из ВариантыСвязей Цикл
		
		Год = ВариантСвязи.Значение;
		Для КодСвязи = 501 по 523  Цикл
			
			Если Год = "2016" И КодСвязи > 508 Тогда
				Продолжить;
			КонецЕсли;
			Если Год = "2019" И КодСвязи > 510 Тогда
				Продолжить;
			КонецЕсли;
			Если Год = "2021" И КодСвязи <> 523 Тогда
				Продолжить;
			КонецЕсли;
			
			ИмяХранилища 		= "Код" + КодСвязи + "_" + Год; 
			
			СтруктураНастроек = ТекущийОбъект[ИмяХранилища].Получить();
			
			Если СтруктураНастроек = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			Для каждого ЭлементНастройки Из СтруктураНастроек Цикл
				
				ИмяЭлемента = ЭлементНастройки.Ключ;
				
				Попытка
				
					ЭлФормы = Элементы[ИмяЭлемента];
					
					Если  ТипЗнч(ЭлФормы) = Тип("ПолеФормы") Тогда
						
						ВидЭлемента = ЭлФормы.Вид;
						Если ВидЭлемента = ВидПоляФормы.ПолеФлажка Тогда
							ЭтаФорма[ИмяЭлемента] = ЭлементНастройки.Значение;
						ИначеЕсли ВидЭлемента = ВидПоляФормы.ПолеВвода Тогда
							Если Не ПустаяСтрока(ЭлементНастройки.Значение) Тогда
								ЭтаФорма[ИмяЭлемента] = ЭлементНастройки.Значение;
							КонецЕсли;
						КонецЕсли;
						
					ИначеЕсли ТипЗнч(ЭлФормы) = Тип("ТаблицаФормы") Тогда
						
						ЗначениеВДанныеФормы(ЭлементНастройки.Значение.Получить(), ЭтаФорма[ИмяЭлемента]);
						
					КонецЕсли;
					
				Исключение 
				КонецПопытки;
			
			КонецЦикла;	
		
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ЗаписатьДаные()

	МенеджерЗаписи = РегистрыСведений.СвязанностьЛицКонтролируемыхОпераций.СоздатьМенеджерЗаписи();
	ЗаполнитьЗначенияСвойств(МенеджерЗаписи, Запись);
	
	ВариантыСвязей = Новый СписокЗначений;
	ВариантыСвязей.Добавить("2016");
	ВариантыСвязей.Добавить("2019");
	ВариантыСвязей.Добавить("2021");
	
	Для каждого ВариантСвязи Из ВариантыСвязей Цикл
		
		Год = ВариантСвязи.Значение;
		
		Для КодСвязи = 501 по 523  Цикл
			
			Если Год = "2016" И КодСвязи > 508 Тогда
				Продолжить;
			КонецЕсли;
			Если Год = "2019" И КодСвязи > 510 Тогда
				Продолжить;
			КонецЕсли;
			Если Год = "2021" И КодСвязи <> 523 Тогда
				Продолжить;
			КонецЕсли;
			
			СтруктураНастроек 	= Новый Структура;
			ИмяХранилища 		= "Код" + КодСвязи + "_" + Год; 
			ТипТаблица = Новый ОписаниеТипов("ТаблицаЗначений");
			
			Для каждого ЭлФормы Из ЭтаФорма.ПолучитьРеквизиты() Цикл
				
				ИмяЭлемента = ЭлФОрмы.Имя;
				
				Если  Найти(ИмяЭлемента, ИмяХранилища) > 0 Тогда
					
					Если ЭлФормы.ТипЗначения = ТипТаблица Тогда
					
						СтруктураНастроек.Вставить(ИмяЭлемента, Новый ХранилищеЗначения(ДанныеФормыВЗначение(ЭтаФорма[ИмяЭлемента], Тип("ТаблицаЗначений")))); 
						
					Иначе
						
						СтруктураНастроек.Вставить(ИмяЭлемента, ЭтаФорма[ИмяЭлемента]); 
						
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЦикла;	
			
			МенеджерЗаписи[ИмяХранилища] = Новый ХранилищеЗначения(СтруктураНастроек);
		
		КонецЦикла;
		
	КонецЦикла;
	
	МенеджерЗаписи.Записать(Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура КодСвязанностиЛицПриИзменении(Элемент)
	УстановитьВидимость();
КонецПроцедуры

&НаКлиенте
Процедура ПериодПриИзменении(Элемент)
	УстановитьВидимость();
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентПриИзменении(Элемент)
	
	КонтрагентПриИзмененииНаСервере(Запись.Контрагент, Запись.Код, Запись.Статус);
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура КонтрагентПриИзмененииНаСервере(Контрагент, Код, Статус)
	
	Код = Контрагент.КодПоЕДРПОУ;
	
	Если НЕ ЗначениеЗаполнено(Код) Тогда
		Статус = "Н";
	Иначе
		Статус = "Р";
	КонецЕсли;
	
КонецПроцедуры

