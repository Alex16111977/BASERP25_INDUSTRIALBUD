#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Процедура добавляет в регистр настройку подпитки по умолчанию, если
// еще нет настроек для склада (помещения) с адресным хранением.
//
//	Параметры:
//	Склад - СправочникСсылка.Склады - склад, для которого осуществляется настройка;
//	Помещение - СправочникСсылка.СкладскиеПомещения - складское помещение, для которого осуществляется настройка;
//	ИспользоватьАдресноеХранение - Булево, Истина - признак использования адресного хранения на складе / в помещении;
//	ДатаНачалаАдресногоХраненияОстатков - Дата - дата, с которой осуществляется использование адресного хранения 
//		остатков товаров на складе / в помещении;
//	ИспользоватьАдресноеХранениеСправочно - Булево, Истина - признак использования справочного хранения товаров 
//		на адресном складе / помещении;
//	ИспользоватьРабочиеУчастки - Булево, Истина - признак использования рабочих участков на складе / в помещении;
//	СкопироватьНастройкиВладельца - Булево, Истина - признак необходимости копирования настроек по складу 
//		в настройки помещения.
//
Процедура УстановитьНастройкиПоУмолчанию(Склад, Помещение, ИспользоватьАдресноеХранение,
										ДатаНачалаАдресногоХраненияОстатков, ИспользоватьАдресноеХранениеСправочно, ИспользоватьРабочиеУчастки,
										СкопироватьНастройкиВладельца = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	&Помещение КАК Помещение,
		|	НастройкиАдресныхСкладов.*
		|ИЗ
		|	РегистрСведений.НастройкиАдресныхСкладов КАК НастройкиАдресныхСкладов
		|ГДЕ
		|	НастройкиАдресныхСкладов.Склад = &Склад";
	Если СкопироватьНастройкиВладельца Тогда
		Запрос.Текст = Запрос.Текст + "
			|	И НастройкиАдресныхСкладов.Помещение = ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)";
	Иначе
		Запрос.Текст = Запрос.Текст + "
			|	И НастройкиАдресныхСкладов.Помещение = &Помещение";
	КонецЕсли;
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("Помещение", Помещение);
	
	Настройки = Запрос.Выполнить().Выбрать();
	
	Набор = РегистрыСведений.НастройкиАдресныхСкладов.СоздатьНаборЗаписей();
	Набор.Отбор.Склад.Установить(Склад);
	Набор.Отбор.Помещение.Установить(Помещение);
	
	СтрокаНастроек = Набор.Добавить();
	Если Настройки.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(СтрокаНастроек, Настройки);
	Иначе
		СтрокаНастроек.Склад = Склад;
		СтрокаНастроек.Помещение = Помещение;
		Набор.Заполнить(Неопределено);
	КонецЕсли;
	
	СтрокаНастроек.ИспользоватьАдресноеХранение          = ИспользоватьАдресноеХранение;
	СтрокаНастроек.ДатаНачалаАдресногоХраненияОстатков   = ДатаНачалаАдресногоХраненияОстатков;
	СтрокаНастроек.ИспользоватьАдресноеХранениеСправочно = ИспользоватьАдресноеХранениеСправочно;
	СтрокаНастроек.ИспользоватьРабочиеУчастки            = ИспользоватьРабочиеУчастки;
	
	Набор.Записать();
	
КонецПроцедуры

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// См. УправлениеДоступомПереопределяемый.ПриЗаполненииСписковСОграничениемДоступа.
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(Склад)";

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#КонецОбласти


#Область СлужебныеПроцедурыИФункции

#Область ОбновлениеИнформационнойБазы

// Добавляет в список процедуры-обработчики обновления данных ИБ
// для всех поддерживаемых версий библиотеки или конфигурации.
// Вызывается перед началом обновления данных ИБ для построения плана обновления.
//
//  Обработчики - ТаблицаЗначений - описание полей, см. в процедуре
//                ОбновлениеИнформационнойБазы.НоваяТаблицаОбработчиковОбновления.
//
// Пример добавления процедуры-обработчика в список:
//  Обработчик = Обработчики.Добавить();
//  Обработчик.Версия              = "1.1.0.0";
//  Обработчик.Процедура           = "ОбновлениеИБ.ПерейтиНаВерсию_1_1_0_0";
//  Обработчик.МонопольныйРежим    = Ложь;
//
// Параметры:
// 	Обработчики - см. ОбновлениеИнформационнойБазы.НоваяТаблицаОбработчиковОбновления
//
Процедура ОписаниеОбработчиковОбновления(Обработчики) Экспорт

	Обработчик = Обработчики.Добавить();
	Обработчик.Версия = "3.5.4.400";
	Обработчик.РежимВыполнения = "Отложенно";
	Обработчик.Процедура = "РегистрыСведений.НастройкиАдресныхСкладов.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	Обработчик.Идентификатор = Новый УникальныйИдентификатор("be7d3f63-59b5-4370-be3f-aa68b3fd248a");
	Обработчик.ПроцедураЗаполненияДанныхОбновления = "РегистрыСведений.НастройкиАдресныхСкладов.ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию";
	Обработчик.ПроцедураПроверки = "";
	Обработчик.ЗапускатьИВПодчиненномУзлеРИБСФильтрами = Истина;
	Обработчик.ЧитаемыеОбъекты = "РегистрСведений.НастройкиАдресныхСкладов";
	Обработчик.ИзменяемыеОбъекты = "РегистрСведений.НастройкиАдресныхСкладов";
	Обработчик.БлокируемыеОбъекты = "";
	Обработчик.Комментарий = НСтр("ru='Отключается регламентное задание ""Создание заданий на подпитку"". Функциональность, настройки и расписание переносятся в новое регламентное задание ""Создание заданий на перемещение"". Пока обработчик не выполнится, пользователи не смогут настраивать регламентное задание подпитки из формы настроек адресных складов. При острой необходимости на время обновления для этого можно использовать консоль регламентных заданий.';uk='Відключається регламентне завдання ""Створення завдань на підживлення"". Функціональність, налаштування та розклад переносяться до нового регламентного завдання ""Створення завдань на переміщення"". Поки обробник не виконається, користувачі не зможуть налаштовувати регламентне завдання підживлення форми настройок адресних складів. У разі гострої необхідності на час оновлення для цього можна використовувати консоль регламентних завдань.'");
	Обработчик.ПриоритетыВыполнения = ОбновлениеИнформационнойБазы.ПриоритетыВыполненияОбработчика();

	

	
КонецПроцедуры
	
Функция ПолноеИмяРегистра()
	
	Возврат "РегистрСведений.НастройкиАдресныхСкладов";
	
КонецФункции

// Регистрация данных к обработке при обновлении ИБ.
Процедура ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	ДополнительныеПараметры = ОбновлениеИнформационнойБазы.ДополнительныеПараметрыОтметкиОбработки();
	ДополнительныеПараметры.ЭтоНезависимыйРегистрСведений = Истина;
	ДополнительныеПараметры.ПолноеИмяРегистра = ПолноеИмяРегистра();
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	НастройкиАдресныхСкладов.Склад КАК Склад,
	|	НастройкиАдресныхСкладов.Помещение КАК Помещение
	|ИЗ
	|	РегистрСведений.НастройкиАдресныхСкладов КАК НастройкиАдресныхСкладов
	|ГДЕ
	|	НастройкиАдресныхСкладов.УдалитьРегламентноеЗаданиеСозданиеЗаданийНаПодпитку <> &ПустойГУИД
	|	И НастройкиАдресныхСкладов.УдалитьИспользоватьРегламентноеЗаданиеСозданияЗаданийНаПодпитку";
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("ПустойГУИД", Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000"));
	
	КлючиЗаписей = Запрос.Выполнить().Выгрузить();
	ОбновлениеИнформационнойБазы.ОтметитьКОбработке(Параметры, КлючиЗаписей, ДополнительныеПараметры);
	
КонецПроцедуры

// Обработка данных при обновлении ИБ.
Процедура ОбработатьДанныеДляПереходаНаНовуюВерсию(Параметры) Экспорт

	Набор = РегистрыСведений.НастройкиАдресныхСкладов.СоздатьНаборЗаписей();
	Набор.Записывать = Истина;
	
	ВыборкаДетальныеЗаписи = ОбновлениеИнформационнойБазы.ВыбратьИзмеренияНезависимогоРегистраСведенийДляОбработки(
		Параметры.Очередь,
		ПолноеИмяРегистра());
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		НачатьТранзакцию();
		
		Попытка
			
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить(ПолноеИмяРегистра());
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
			ЭлементБлокировки.УстановитьЗначение("Склад", ВыборкаДетальныеЗаписи.Склад);
			ЭлементБлокировки.УстановитьЗначение("Помещение", ВыборкаДетальныеЗаписи.Помещение);
			
			Блокировка.Заблокировать();
			
		Исключение
			
			ОтменитьТранзакцию();
			Продолжить;
			
		КонецПопытки;
		
		Набор.Отбор.Склад.Установить(ВыборкаДетальныеЗаписи.Склад);
		Набор.Отбор.Помещение.Установить(ВыборкаДетальныеЗаписи.Помещение);
		Набор.Прочитать();
		
		// Если между чтением в ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию 
		// и блокировкой запись была удалена.
		Если Не Набор.Количество() Тогда
			ОтменитьТранзакцию();
			Продолжить;
		КонецЕсли;
		
		// Если между чтением в ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию
		// и блокировкой подпитка была отключена.
		Если Набор[0].УдалитьИспользоватьРегламентноеЗаданиеСозданияЗаданийНаПодпитку = Ложь Тогда
			ОтменитьТранзакцию();
			Продолжить;
		КонецЕсли;
		
		РегЗаданиеНаПодпитку = РегламентныеЗаданияСервер.Задание(Набор[0].УдалитьРегламентноеЗаданиеСозданиеЗаданийНаПодпитку);
		РегЗаданиеНаПодпитку.Использование = Ложь;
		РегЗаданиеНаПодпитку.Записать();
		
		РегЗаданиеНаПеремещение = РегламентныеЗаданияСервер.ДобавитьЗадание(
			Новый Структура("Метаданные", Метаданные.РегламентныеЗадания.СозданиеЗаданийНаПеремещение));
		ЗаполнитьЗначенияСвойств(РегЗаданиеНаПеремещение, РегЗаданиеНаПодпитку);
		РегЗаданиеНаПеремещение.Параметры[0].Вставить(
			"ПравилоСозданияЗаданий", 
			Перечисления.ПравилаСозданияЗаданийНаОтборРазмещение.ПодпиткаЗонБыстрогоОтбора);
		РегЗаданиеНаПеремещение.Использование = Истина;
		РегЗаданиеНаПеремещение.Записать();
		
		Набор[0].РегламентныеЗаданияСозданияЗаданийНаПеремещение = Строка(РегЗаданиеНаПеремещение.УникальныйИдентификатор);
		Набор[0].УдалитьИспользоватьРегламентноеЗаданиеСозданияЗаданийНаПодпитку = Ложь;
			
		Попытка
				
			ОбновлениеИнформационнойБазы.ЗаписатьНаборЗаписей(Набор);
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			ОтменитьТранзакцию();
			
			ТекстСообщения = НСтр("ru='Не удалось записать данные в регистр %ИмяРегистра% по причине: %Причина%';uk='Не вдалося записати дані в регістр %ИмяРегистра% через: %Причина%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ИмяРегистра%", ПолноеИмяРегистра());
			
			ЗаписьЖурналаРегистрации(
				ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Предупреждение,
				Метаданные.РегистрыСведений.НастройкаКонтроляОбеспечения,
				Неопределено,
				ТекстСообщения);
			
			ВызватьИсключение;
			
		КонецПопытки;
		
	КонецЦикла;
	
	Параметры.ОбработкаЗавершена = Не ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Параметры.Очередь, ПолноеИмяРегистра());
	
КонецПроцедуры


#КонецОбласти

#КонецОбласти


#КонецЕсли