
Функция А_ПолучитьОрганизациюУпр() Экспорт
	
	Возврат Справочники.Организации.НайтиПоРеквизиту("КодПоЕДРПОУ","40645273"); //ТОВ "ІНДАСТРІАЛБУД"
	
КонецФункции //

 Функция А_ПроверкаВыбораЗаказаВДокументахПрихода(ЗаказПоставщику) Экспорт
 
 	     Запрос = Новый Запрос;
		 Запрос.УстановитьПараметр("ЗаказПоставщику",ЗаказПоставщику);
		 Запрос.Текст =   "ВЫБРАТЬ
		                  |	ПоступлениеТоваровНаСклад.Ссылка КАК Ссылка
		                  |ИЗ
		                  |	Документ.ПриобретениеТоваровУслуг КАК ПоступлениеТоваровНаСклад
		                  |ГДЕ
		                  |	ПоступлениеТоваровНаСклад.ЗаказПоставщику = &ЗаказПоставщику
		                  |	И ПоступлениеТоваровНаСклад.Проведен" ;
		 
		 Пустой = Запрос.Выполнить().Пустой();
		 Если НЕ Пустой Тогда
		 
		 	 Возврат Истина
			 
		 Иначе
			 Возврат Ложь;
		 
		 КонецЕсли; 
 
	 КонецФункции //      
	 
	 
	 
	
Функция А_СоздатьВедомостьНаВыплатуЗарплатыВБанкПоСписаниеБезналичныхДенежныхСредств(ДокументОснование) Экспорт
    
      	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДокументОснование",ДокументОснование);
	Запрос.Текст =   "ВЫБРАТЬ
	|	Ведомость.Ссылка
	|ИЗ
	|	Документ.ВедомостьНаВыплатуЗарплатыВБанк КАК Ведомость
	|ГДЕ
	|	Ведомость.А_СписаниеБезналичныхДенежныхСредств = &ДокументОснование";
	
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока   Выборка.Следующий() Цикл
		ДокПлатежка = Выборка.Ссылка.ПолучитьОбъект(); 
		ДокПлатежка.УстановитьПометкуУдаления(Истина);
	КонецЦикла;
	
	Если НЕ ДокументОснование.Проведен
		Тогда
		Возврат Документы.ВедомостьНаВыплатуЗарплатыВБанк.ПустаяСсылка();
	КонецЕсли;      
	
 
    ЗапросПоиска = Новый Запрос;
    ЗапросПоиска.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |	Ведомость.Ссылка КАК Ссылка
        |ИЗ
        |	Документ.ВедомостьНаВыплатуЗарплатыВБанк КАК Ведомость
        |ГДЕ
        |	Ведомость.А_СписаниеБезналичныхДенежныхСредств = &ДокументОснование
        |	";
        
    ЗапросПоиска.УстановитьПараметр("ДокументОснование", ДокументОснование.Ссылка);
    Выборка = ЗапросПоиска.Выполнить().Выбрать();
    
    Если Выборка.Следующий() Тогда
        ВедомостьОбъект = Выборка.Ссылка.ПолучитьОбъект(); 
		ВедомостьОбъект.УстановитьПометкуУдаления(Ложь);

    Иначе
        ВедомостьОбъект = Документы.ВедомостьНаВыплатуЗарплатыВБанк.СоздатьДокумент();
        ВедомостьОбъект.А_СписаниеБезналичныхДенежныхСредств = ДокументОснование.Ссылка;
        ВедомостьОбъект.Дата = ДокументОснование.Дата;
    КонецЕсли;
    
    ВедомостьОбъект.Организация = ДокументОснование.Организация;
    ВедомостьОбъект.ПериодРегистрации = НачалоМесяца(ДокументОснование.Дата);
    
    СпособВыплаты = Справочники.СпособыВыплатыЗарплаты.НайтиПоНаименованию("Зарплата за месяц");
    Если ЗначениеЗаполнено(СпособВыплаты) Тогда
        ВедомостьОбъект.СпособВыплаты = СпособВыплаты;
    Иначе
        ЗапросСпособВыплаты = Новый Запрос;
        ЗапросСпособВыплаты.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Спр.Ссылка ИЗ Справочник.СпособыВыплатыЗарплаты КАК Спр ГДЕ НЕ Спр.ПометкаУдаления";
        ВыборкаСпособ = ЗапросСпособВыплаты.Выполнить().Выбрать();
        Если ВыборкаСпособ.Следующий() Тогда
            ВедомостьОбъект.СпособВыплаты = ВыборкаСпособ.Ссылка;
        КонецЕсли;
    КонецЕсли;
    
    СпособОкругления = Справочники.СпособыОкругленияПриРасчетеЗарплаты.НайтиПоНаименованию("Без округления");
    Если ЗначениеЗаполнено(СпособОкругления) Тогда
        ВедомостьОбъект.Округление = СпособОкругления;
    КонецЕсли;
    
    ВедомостьОбъект.ПроцентВыплаты = 100;
    ВедомостьОбъект.ПорядокЗаполненияНалогов = Перечисления.ПорядокЗаполненияНалогов.БезНалогов;
    
    Если НЕ ЗначениеЗаполнено(ВедомостьОбъект.ЗарплатныйПроект) Тогда
        ЗапросЗП = Новый Запрос;
        ЗапросЗП.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 ЗП.Ссылка ИЗ Справочник.ЗарплатныеПроекты КАК ЗП ГДЕ ЗП.Организация = &Организация И НЕ ЗП.ПометкаУдаления";
        ЗапросЗП.УстановитьПараметр("Организация", ДокументОснование.Организация);
        ВыборкаЗП = ЗапросЗП.Выполнить().Выбрать();
        Если ВыборкаЗП.Следующий() Тогда
            ВедомостьОбъект.ЗарплатныйПроект = ВыборкаЗП.Ссылка;
        КонецЕсли;
    КонецЕсли;
    
    ВедомостьОбъект.Зарплата.Очистить();
    ВедомостьОбъект.ФизическиеЛица.Очистить();
    ВедомостьОбъект.Состав.Очистить();
    
          
    НоваяСтрока = ВедомостьОбъект.Зарплата.Добавить();
    НоваяСтрока.ФизическоеЛицо = ДокументОснование.А_Субконто1;
    НоваяСтрока.КВыплате = ДокументОснование.СуммаДокумента;
    НоваяСтрока.ПериодВзаиморасчетов = ВедомостьОбъект.ПериодРегистрации;
    
    
    ТЗ_ФизЛица = ВедомостьОбъект.Зарплата.Выгрузить();
    ТЗ_ФизЛица.Свернуть("ФизическоеЛицо");
    ВедомостьОбъект.ФизическиеЛица.Загрузить(ТЗ_ФизЛица);
    
    Для Каждого СтрЗарплата Из ВедомостьОбъект.Зарплата Цикл
        СтрСостав = ВедомостьОбъект.Состав.Добавить();
        СтрСостав.ФизическоеЛицо = СтрЗарплата.ФизическоеЛицо;
        СтрСостав.НомерЛицевогоСчета = СтрЗарплата.НомерЛицевогоСчета;
    КонецЦикла;
    
    ТЗ_Состав = ВедомостьОбъект.Состав.Выгрузить();
    ТЗ_Состав.Свернуть("ФизическоеЛицо,НомерЛицевогоСчета");
    ВедомостьОбъект.Состав.Загрузить(ТЗ_Состав);
    
    Для Каждого СтрокаТабличнойЧасти Из ВедомостьОбъект.Состав Цикл
        СтрокаТабличнойЧасти.ИдентификаторСтроки = Новый УникальныйИдентификатор;
    КонецЦикла;
    
    Для Каждого СтрокаТабличнойЧасти Из ВедомостьОбъект.Зарплата Цикл
        
                  СтрокаТабличнойЧасти.ГруппаУчетаНачислений = Справочники.ГруппыУчетаНачисленийИУдержаний.Зарплата;
        
        СтрокаТабличнойЧасти.ПериодВзаиморасчетов = ВедомостьОбъект.ПериодРегистрации;
        
        Если ЗначениеЗаполнено(СтрокаТабличнойЧасти.ФизическоеЛицо) Тогда
            СтрокаТабличнойЧасти.Сотрудник = А_Привилегированный.СоздатьСотрудникаИзФизическогоЛица(СтрокаТабличнойЧасти.ФизическоеЛицо);
        КонецЕсли;
        
        СтрокаСостава = ВедомостьОбъект.Состав.Найти(СтрокаТабличнойЧасти.ФизическоеЛицо, "ФизическоеЛицо");
        Если СтрокаСостава <> Неопределено Тогда
            СтрокаТабличнойЧасти.ИдентификаторСтроки = СтрокаСостава.ИдентификаторСтроки;
        КонецЕсли;
        
    КонецЦикла;
    
    Попытка
        ВедомостьОбъект.Записать(РежимЗаписиДокумента.Проведение);
    Исключение
        Сообщить("Ошибка при обновлении Ведомости в банк для документа " + ДокументОснование.Ссылка + ": " + ОписаниеОшибки());
    КонецПопытки;
	
	Возврат ВедомостьОбъект.Ссылка; 
КонецФункции
  	 
Функция СоздатьСотрудникаИзФизическогоЛица(ФизическоеЛицоСсылка) Экспорт

	// Проверка входных параметров
	Если НЕ ЗначениеЗаполнено(ФизическоеЛицоСсылка) Тогда
		Сообщить("Ошибка: Не указано физическое лицо!");
		Возврат Неопределено;
	КонецЕсли;

	// Проверяем, существует ли уже сотрудник для данного физического лица
	СуществующийСотрудник = НайтиСотрудникаПоФизическомуЛицу(ФизическоеЛицоСсылка);

	Если ЗначениеЗаполнено(СуществующийСотрудник) Тогда
		Возврат СуществующийСотрудник;
	КонецЕсли;

	// Создаем нового сотрудника
	Попытка
		НовыйСотрудник = Справочники.Сотрудники.СоздатьЭлемент();

		// Заполняем основные реквизиты
		НовыйСотрудник.ФизическоеЛицо = ФизическоеЛицоСсылка;
		НовыйСотрудник.Наименование = Строка(ФизическоеЛицоСсылка);

		// Заполняем организацию, если указана
		НовыйСотрудник.ГоловнаяОрганизация = А_ПолучитьОрганизациюУпр();

		// Записываем элемент
		НовыйСотрудник.Записать();

		Возврат НовыйСотрудник.Ссылка;

	Исключение
		Сообщить("Ошибка при создании сотрудника: " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;

КонецФункции

// Ищет сотрудника по физическому лицу
//
// Параметры:
//   ФизическоеЛицоСсылка - СправочникСсылка.ФизическиеЛица - ссылка на физическое лицо
//
// Возвращаемое значение:
//   СправочникСсылка.Сотрудники - найденный сотрудник или пустая ссылка
//
Функция НайтиСотрудникаПоФизическомуЛицу(ФизическоеЛицоСсылка) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Сотрудники.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.Сотрудники КАК Сотрудники
		|ГДЕ
		|	Сотрудники.ФизическоеЛицо = &ФизическоеЛицо
		|	";

	Запрос.УстановитьПараметр("ФизическоеЛицо", ФизическоеЛицоСсылка);

	Результат = Запрос.Выполнить();

	Если Результат.Пустой() Тогда
		Возврат Справочники.Сотрудники.ПустаяСсылка();
	Иначе
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;

КонецФункции


Функция СоздатьПоступлениеБезналичныхДенежныхСредствПоСписаниеБезналичныхДенежныхСредств(ДокументОснование) Экспорт
	
	Если ЗначениеЗаполнено(ДокументОснование.А_ПоступлениеБезналичныхДенежныхСредств) Тогда
		 Возврат Документы.ПоступлениеБезналичныхДенежныхСредств.ПустаяСсылка();
		КонецЕсли;
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДокументОснование",ДокументОснование);
	Запрос.Текст =   "ВЫБРАТЬ
	|	ПоступлениеБезналичныхДенежныхСредств.Ссылка
	|ИЗ
	|	Документ.ПоступлениеБезналичныхДенежныхСредств КАК ПоступлениеБезналичныхДенежныхСредств
	|ГДЕ
	|	ПоступлениеБезналичныхДенежныхСредств.А_СписаниеБезналичныхДенежныхСредств = &ДокументОснование";
	
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока   Выборка.Следующий() Цикл
		ДокПлатежка = Выборка.Ссылка.ПолучитьОбъект(); 
		ДокПлатежка.УстановитьПометкуУдаления(Истина);
	КонецЦикла;
	
	Если НЕ ДокументОснование.Проведен
		Тогда
		Возврат Документы.ПоступлениеБезналичныхДенежныхСредств.ПустаяСсылка();
	КонецЕсли;
	
	ЗапросПоиска = Новый Запрос;
    ЗапросПоиска.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |	ПоступлениеБезналичныхДенежныхСредств.Ссылка КАК Ссылка
        |ИЗ
        |	Документ.ПоступлениеБезналичныхДенежныхСредств КАК ПоступлениеБезналичныхДенежныхСредств
        |ГДЕ
        |	ПоступлениеБезналичныхДенежныхСредств.А_СписаниеБезналичныхДенежныхСредств = &ДокументОснование";
        
    ЗапросПоиска.УстановитьПараметр("ДокументОснование", ДокументОснование.Ссылка);
    Выборка = ЗапросПоиска.Выполнить().Выбрать();
    
    Если Выборка.Следующий() Тогда
        Док_ПоступлениеБезналичныхДенежныхСредств = Выборка.Ссылка.ПолучитьОбъект(); 
		Док_ПоступлениеБезналичныхДенежныхСредств.УстановитьПометкуУдаления(Ложь);
    Иначе
        Док_ПоступлениеБезналичныхДенежныхСредств = Документы.ПоступлениеБезналичныхДенежныхСредств.СоздатьДокумент();
        Док_ПоступлениеБезналичныхДенежныхСредств.А_СписаниеБезналичныхДенежныхСредств = ДокументОснование;
        Док_ПоступлениеБезналичныхДенежныхСредств.Дата = ДокументОснование.Дата;
    КонецЕсли;
	
	
	
	
	Док_ПоступлениеБезналичныхДенежныхСредств.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПоступлениеДенежныхСредствСДругогоСчета;
	Док_ПоступлениеБезналичныхДенежныхСредств.Дата = ДокументОснование.Дата;   
	Док_ПоступлениеБезналичныхДенежныхСредств.ДатаВходящегоДокумента = ДокументОснование.Дата;
    Док_ПоступлениеБезналичныхДенежныхСредств.НомерВходящегоДокумента = ДокументОснование.НомерВходящегоДокумента;
	
	Док_ПоступлениеБезналичныхДенежныхСредств.Организация =  ДокументОснование.Организация;
	Док_ПоступлениеБезналичныхДенежныхСредств.Контрагент =  ДокументОснование.Контрагент;
	Док_ПоступлениеБезналичныхДенежныхСредств.Подразделение =  ДокументОснование.Подразделение;
	Док_ПоступлениеБезналичныхДенежныхСредств.СтатьяДвиженияДенежныхСредств =  Справочники.СтатьиДвиженияДенежныхСредств.ПеречислениеДенежныхСредствНаДругойСчет; //Внутреннее перемещение (приход)
	Док_ПоступлениеБезналичныхДенежныхСредств.СуммаДокумента =  ДокументОснование.СуммаДокумента;
	Док_ПоступлениеБезналичныхДенежныхСредств.Валюта = ДокументОснование.БанковскийСчет.ВалютаДенежныхСредств ;
	Док_ПоступлениеБезналичныхДенежныхСредств.ДатаПроведенияБанком =  ДокументОснование.ДатаПроведенияБанком;
	Док_ПоступлениеБезналичныхДенежныхСредств.ПроведеноБанком =  ДокументОснование.ПроведеноБанком;
	Док_ПоступлениеБезналичныхДенежныхСредств.ТипПлатежногоДокумента =  ДокументОснование.ТипПлатежногоДокумента;
	Док_ПоступлениеБезналичныхДенежныхСредств.БанковскийСчетОтправитель =  ДокументОснование.БанковскийСчет;
	Док_ПоступлениеБезналичныхДенежныхСредств.БанковскийСчет =  ДокументОснование.БанковскийСчетПолучатель;
		
	
	Док_ПоступлениеБезналичныхДенежныхСредств.РасшифровкаПлатежа.Очистить();
	
	СтрокаТабличнойЧасти = Док_ПоступлениеБезналичныхДенежныхСредств.РасшифровкаПлатежа.Добавить();
	СтрокаТабличнойЧасти.Сумма =  Док_ПоступлениеБезналичныхДенежныхСредств.СуммаДокумента;
	СтрокаТабличнойЧасти.СтатьяДвиженияДенежныхСредств = Док_ПоступлениеБезналичныхДенежныхСредств.СтатьяДвиженияДенежныхСредств;
	СтрокаТабличнойЧасти.Подразделение =  Док_ПоступлениеБезналичныхДенежныхСредств.Подразделение;
	
	Док_ПоступлениеБезналичныхДенежныхСредств.Записать(РежимЗаписиДокумента.Проведение);
	
	 

КонецФункции


Функция СоздатьСписаниеБезналичныхДенежныхСредствПоПоступлениеБезналичныхДенежныхСредств(ДокументОснование) Экспорт
	
	Если ЗначениеЗаполнено(ДокументОснование.А_СписаниеБезналичныхДенежныхСредств) Тогда
		Возврат Документы.СписаниеБезналичныхДенежныхСредств.ПустаяСсылка();
	КонецЕсли; 
	 
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДокументОснование",ДокументОснование);
	Запрос.Текст =   "ВЫБРАТЬ
	|	СписаниеБезналичныхДенежныхСредств.Ссылка
	|ИЗ
	|	Документ.СписаниеБезналичныхДенежныхСредств КАК СписаниеБезналичныхДенежныхСредств
	|ГДЕ
	|	СписаниеБезналичныхДенежныхСредств.А_ПоступлениеБезналичныхДенежныхСредств = &ДокументОснование";
	
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока   Выборка.Следующий() Цикл
		ДокПлатежка = Выборка.Ссылка.ПолучитьОбъект(); 
		ДокПлатежка.УстановитьПометкуУдаления(Истина);
	КонецЦикла;
	
	Если НЕ ДокументОснование.Проведен
		Тогда
		Возврат Документы.СписаниеБезналичныхДенежныхСредств.ПустаяСсылка();
	КонецЕсли;
	
	ЗапросПоиска = Новый Запрос;
    ЗапросПоиска.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |	СписаниеБезналичныхДенежныхСредств.Ссылка КАК Ссылка
        |ИЗ
        |	Документ.СписаниеБезналичныхДенежныхСредств КАК СписаниеБезналичныхДенежныхСредств
        |ГДЕ
        |	СписаниеБезналичныхДенежныхСредств.А_ПоступлениеБезналичныхДенежныхСредств = &ДокументОснование";
        
    ЗапросПоиска.УстановитьПараметр("ДокументОснование", ДокументОснование.Ссылка);
    Выборка = ЗапросПоиска.Выполнить().Выбрать();
    
    Если Выборка.Следующий() Тогда
        Док_СписаниеБезналичныхДенежныхСредств = Выборка.Ссылка.ПолучитьОбъект(); 
		Док_СписаниеБезналичныхДенежныхСредств.УстановитьПометкуУдаления(Ложь);
    Иначе
        Док_СписаниеБезналичныхДенежныхСредств = Документы.СписаниеБезналичныхДенежныхСредств.СоздатьДокумент();
        Док_СписаниеБезналичныхДенежныхСредств.А_ПоступлениеБезналичныхДенежныхСредств = ДокументОснование;
        Док_СписаниеБезналичныхДенежныхСредств.Дата = ДокументОснование.Дата;
    КонецЕсли;
	
	
	
	
	Док_СписаниеБезналичныхДенежныхСредств.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеречислениеДенежныхСредствНаДругойСчет;
	Док_СписаниеБезналичныхДенежныхСредств.Дата = ДокументОснование.Дата;   
	Док_СписаниеБезналичныхДенежныхСредств.ДатаВходящегоДокумента = ДокументОснование.Дата;
    Док_СписаниеБезналичныхДенежныхСредств.НомерВходящегоДокумента = ДокументОснование.НомерВходящегоДокумента;
	
	Док_СписаниеБезналичныхДенежныхСредств.Организация =  ДокументОснование.Организация;
	Док_СписаниеБезналичныхДенежныхСредств.Контрагент =  ДокументОснование.Контрагент;
	Док_СписаниеБезналичныхДенежныхСредств.Подразделение =  ДокументОснование.Подразделение;
	Док_СписаниеБезналичныхДенежныхСредств.СтатьяДвиженияДенежныхСредств =  Справочники.СтатьиДвиженияДенежныхСредств.ПеречислениеДенежныхСредствНаДругойСчет; //Внутреннее перемещение (приход)
	Док_СписаниеБезналичныхДенежныхСредств.СуммаДокумента =  ДокументОснование.СуммаДокумента;
	Док_СписаниеБезналичныхДенежныхСредств.Валюта = ДокументОснование.БанковскийСчет.ВалютаДенежныхСредств ;
	Док_СписаниеБезналичныхДенежныхСредств.ДатаПроведенияБанком =  ДокументОснование.ДатаПроведенияБанком;
	Док_СписаниеБезналичныхДенежныхСредств.ПроведеноБанком =  ДокументОснование.ПроведеноБанком;
	Док_СписаниеБезналичныхДенежныхСредств.ТипПлатежногоДокумента =  ДокументОснование.ТипПлатежногоДокумента;
	Док_СписаниеБезналичныхДенежныхСредств.БанковскийСчетПолучатель =  ДокументОснование.БанковскийСчет;
	Док_СписаниеБезналичныхДенежныхСредств.БанковскийСчет =  ДокументОснование.БанковскийСчетОтправитель;
		
	
	Док_СписаниеБезналичныхДенежныхСредств.РасшифровкаПлатежа.Очистить();
	
	СтрокаТабличнойЧасти = Док_СписаниеБезналичныхДенежныхСредств.РасшифровкаПлатежа.Добавить();
	СтрокаТабличнойЧасти.Сумма =  Док_СписаниеБезналичныхДенежныхСредств.СуммаДокумента;
	СтрокаТабличнойЧасти.СтатьяДвиженияДенежныхСредств = Док_СписаниеБезналичныхДенежныхСредств.СтатьяДвиженияДенежныхСредств;
	СтрокаТабличнойЧасти.Подразделение =  Док_СписаниеБезналичныхДенежныхСредств.Подразделение;
	
	Док_СписаниеБезналичныхДенежныхСредств.Записать(РежимЗаписиДокумента.Проведение);
	
	 

КонецФункции

	 

	 
	 
	 