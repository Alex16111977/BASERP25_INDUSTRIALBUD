#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область СлужебныйПрограммныйИнтерфейс

// Настройки общей формы отчета подсистемы "Варианты отчетов".
//
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - Форма отчета.
//   КлючВарианта - Строка - Имя предопределенного варианта отчета или уникальный идентификатор пользовательского.
//   Настройки - Структура - см. возвращаемое значение ОтчетыКлиентСервер.ПолучитьНастройкиОтчетаПоУмолчанию().
//
Процедура ОпределитьНастройкиФормы(Форма, КлючВарианта, Настройки) Экспорт
	
	Настройки.События.ПередЗагрузкойНастроекВКомпоновщик = Истина;
	
КонецПроцедуры

Процедура ПередЗагрузкойНастроекВКомпоновщик(Контекст, КлючСхемы, КлючВарианта, НовыеНастройкиКД, НовыеПользовательскиеНастройкиКД) Экспорт
	
	Если ТипЗнч(Контекст) = Тип("ФормаКлиентскогоПриложения") Тогда
		
		Если НовыеПользовательскиеНастройкиКД = Неопределено Тогда
			НастроитьПараметрыОтчетаПоВариантуОтчета(Контекст.НастройкиОтчета, НовыеНастройкиКД, Контекст.Отчет.КомпоновщикНастроек.ПользовательскиеНастройки);
		Иначе
			НастроитьПараметрыОтчетаПоВариантуОтчета(Контекст.НастройкиОтчета, НовыеНастройкиКД, НовыеПользовательскиеНастройкиКД);
		КонецЕсли;
		ОтчетыСервер.ПодключитьСхему(ЭтотОбъект, Контекст, СхемаКомпоновкиДанных, КлючСхемы);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытий

Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	СегментыСервер.ВключитьОтборПоСегментуНоменклатурыВСКД(КомпоновщикНастроек);
	
	ПараметрПартионныйУчетВерсии22 = КомпоновкаДанныхКлиентСервер.ПолучитьПараметр(КомпоновщикНастроек, "ПартионныйУчетВерсии22");
	Если ПараметрПартионныйУчетВерсии22 <> Неопределено Тогда
		КомпоновкаДанныхКлиентСервер.УстановитьПараметр(КомпоновщикНастроек, "ПартионныйУчетВерсии22",
			РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии22());
	КонецЕсли;
	
	ПараметрДатаПереходаНаПартионныйУчетВерсии22 = КомпоновкаДанныхКлиентСервер.ПолучитьПараметр(КомпоновщикНастроек, "ДатаПереходаНаПартионныйУчетВерсии22");
	Если ПараметрДатаПереходаНаПартионныйУчетВерсии22 <> Неопределено Тогда
		КомпоновкаДанныхКлиентСервер.УстановитьПараметр(КомпоновщикНастроек, "ДатаПереходаНаПартионныйУчетВерсии22",
			РасчетСебестоимостиПовтИсп.ДатаПереходаНаПартионныйУчетВерсии22());
	КонецЕсли;
	ТекстЗапросаМатериальные = РасчетСебестоимостиЛокализация.АнализСебестоимостиВыпущеннойПродукции_ТекстЗапросаМатериальные();
	Если ЗначениеЗаполнено(ТекстЗапросаМатериальные) Тогда
		
		НаборДанных = СхемаКомпоновкиДанных.НаборыДанных.Затраты; // НаборДанныхОбъединениеСхемыКомпоновкиДанных
		НаборДанных.Элементы.Материальные.Запрос = ТекстЗапросаМатериальные;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Настраивает доступные значения у параметра компоновки данных "Данные по себестоимости" в зависимости от варианта.
// 
// Параметры:
//	Документ - ДокументСсылка.РаспределениеПрочихЗатрат - расшифровывающийся документ.
//	НовыеНастройкиКД - НастройкиКомпоновкиДанных - переопределяемые настройки отчета.
//	НовыеПользовательскиеНастройкиКД - ПользовательскиеНастройкиКомпоновкиДанных - настройки схемы компоновки данных.
Процедура НастроитьПараметрыОтчетаПоВариантуОтчета(НастройкиОтчета, НовыеНастройкиКД, НовыеПользовательскиеНастройкиКД)
	
	КлючиВариантов = КлючиПредопределенныхВариантов();
	ПредопределенныйВариант = ПолучитьПредопределенныйВариант(НастройкиОтчета.ВариантСсылка);
	КлючПредопределенногоВарианта = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПредопределенныйВариант, "КлючВарианта");
	Если Не ЗначениеЗаполнено(ПредопределенныйВариант) 
		Или КлючиВариантов.Найти(КлючПредопределенногоВарианта) = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрДанныеОтчета = СхемаКомпоновкиДанных.Параметры.Найти("ДанныеПоСебестоимости");
	ПараметрПоПредприятию = СхемаКомпоновкиДанных.Параметры.Найти("ПоПредприятию");
	
	СписокВыбора = Новый СписокЗначений;
	
	Если ПредопределенныйВариант.КлючВарианта = "АнализСебестоимостиВыпущеннойПродукцииПоПредприятию"
		Или ПредопределенныйВариант.КлючВарианта = "АнализСебестоимостиВыпущеннойПродукции22ПоПредприятию"
		Или ПредопределенныйВариант.КлючВарианта = "СравнениеСебестоимостиВыпущеннойПродукцииПоЗаказамПоПредприятию" Тогда
		
		СписокВыбора.Добавить(1, НСтр("ru='В валюте упр. учета с НДС';uk='У валюті упр. обліку з ПДВ'"));
		СписокВыбора.Добавить(2, НСтр("ru='В валюте упр. учета без НДС';uk='У валюті упр. обліку без ПДВ'"));
		ПараметрПоПредприятию.Значение = Истина;
		
	Иначе
		
		Если РасчетСебестоимостиПовтИсп.УправленческийУчетОрганизаций() Тогда
            СписокВыбора.Добавить(3, НСтр("ru='В валюте упр. учета (по МФУ)';uk='У валюті упр. обліку (по МФО)'"));
            СписокВыбора.Добавить(5, НСтр("ru='В валюте упр. учета (по МФУ) без НДС';uk='У валюті упр. обліку (по МФО) без ПДВ'"));
		КонецЕсли;
		СписокВыбора.Добавить(4, НСтр("ru='В валюте регл. учета';uk='У валюті регл. обліку'"));
        СписокВыбора.Добавить(6, НСтр("ru='В валюте регл. учета без НДС';uk='У валюті регл. обліку без ПДВ'"));
		ПараметрПоПредприятию.Значение = Ложь;
		
	КонецЕсли;
	
	ПараметрДанныеОтчета.УстановитьДоступныеЗначения(СписокВыбора);
	
	Если НовыеНастройкиКД = Неопределено
		Или НовыеПользовательскиеНастройкиКД = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЗначениеПараметраДанныеОтчета = НовыеНастройкиКД.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ДанныеПоСебестоимости"));
	НастройкаДанныеОтчета = НовыеПользовательскиеНастройкиКД.Элементы.Найти(ЗначениеПараметраДанныеОтчета.ИдентификаторПользовательскойНастройки);
	
	Если Не НастройкаДанныеОтчета = Неопределено
		И СписокВыбора.НайтиПоЗначению(НастройкаДанныеОтчета.Значение) = Неопределено Тогда
		НастройкаДанныеОтчета.Значение = СписокВыбора[0].Значение;
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьПредопределенныйВариант(Знач Вариант)
	
	КлючиВариантов = КлючиПредопределенныхВариантов();
	
	Пока КлючиВариантов.Найти(Вариант.КлючВарианта) = Неопределено
		И ЗначениеЗаполнено(Вариант.Родитель) Цикл
		Вариант = Вариант.Родитель;
	КонецЦикла;
	
	Возврат Вариант;
	
КонецФункции

Функция КлючиПредопределенныхВариантов()
	
	КлючиВариантов = Новый Массив;
	КлючиВариантов.Добавить("АнализСебестоимостиВыпущеннойПродукции");
	КлючиВариантов.Добавить("АнализСебестоимостиВыпущеннойПродукцииПоПредприятию");
	КлючиВариантов.Добавить("СравнениеСебестоимостиВыпущеннойПродукцииПоЗаказам");
	КлючиВариантов.Добавить("СравнениеСебестоимостиВыпущеннойПродукцииПоЗаказамПоПредприятию");
	
	Возврат КлючиВариантов;
	
КонецФункции

#КонецОбласти

#КонецЕсли