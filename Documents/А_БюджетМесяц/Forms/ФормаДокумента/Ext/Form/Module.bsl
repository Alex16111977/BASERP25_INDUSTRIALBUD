
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
			
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;

	ОбновлениеИнформационнойБазы.ПроверитьОбъектОбработан(Объект, ЭтотОбъект);
	
	// Обработчик механизма "ВерсионированиеОбъектов"
	ВерсионированиеОбъектов.ПриСозданииНаСервере(ЭтотОбъект);
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	ПодключаемыеКоманды.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
	// ИнтеграцияС1СДокументооборотом
	ИнтеграцияС1СДокументооборот.ПриСозданииНаСервере(ЭтаФорма);
	// Конец ИнтеграцияС1СДокументооборотом
	
	СобытияФорм.ПриСозданииНаСервере(ЭтаФорма, Отказ, СтандартнаяОбработка);
	
	Если Не ЗначениеЗаполнено(Объект.Ссылка) Тогда
		Если Параметры.Свойство("ДоначислениеВНУ") Тогда
			Объект.ДоначислениеВНУ = Параметры.ДоначислениеВНУ;
		КонецЕсли;
		ПриСозданииЧтенииНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)

	// СтандартныеПодсистемы.УправлениеДоступом
	Если ОбщегоНазначения.ПодсистемаСуществует("СтандартныеПодсистемы.УправлениеДоступом") Тогда
		МодульУправлениеДоступом = ОбщегоНазначения.ОбщийМодуль("УправлениеДоступом");
		МодульУправлениеДоступом.ПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект);
	КонецЕсли;
	// Конец СтандартныеПодсистемы.УправлениеДоступом
	
	// Обработчик механизма "ДатыЗапретаИзменения"
	ДатыЗапретаИзменения.ОбъектПриЧтенииНаСервере(ЭтаФорма, ТекущийОбъект);
	
	МодификацияКонфигурацииПереопределяемый.ПриЧтенииНаСервере(ЭтаФорма, ТекущийОбъект);
	
	ПриСозданииЧтенииНаСервере();
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	ПодключаемыеКомандыКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	МодификацияКонфигурацииПереопределяемый.ПередЗаписьюНаСервере(ЭтаФорма, Отказ, ТекущийОбъект, ПараметрыЗаписи);
	
	// ИнтеграцияС1СДокументооборотом
	ИнтеграцияС1СДокументооборот.ПередЗаписьюНаСервере(ЭтаФорма, ТекущийОбъект, ПараметрыЗаписи);
	// Конец ИнтеграцияС1СДокументооборотом
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)

	// СтандартныеПодсистемы.УправлениеДоступом
	УправлениеДоступом.ПослеЗаписиНаСервере(ЭтотОбъект, ТекущийОбъект, ПараметрыЗаписи);
	// Конец СтандартныеПодсистемы.УправлениеДоступом
	
	МодификацияКонфигурацииПереопределяемый.ПослеЗаписиНаСервере(ЭтаФорма, ТекущийОбъект, ПараметрыЗаписи);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	ПодключаемыеКомандыКлиент.НачатьОбновлениеКоманд(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиЭлементовФормы

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиКомандФормы

// СтандартныеПодсистемы.ПодключаемыеКоманды
&НаСервере
Процедура ВыполнитьКомандуНаСервере(ПараметрыВыполнения)
	ПодключаемыеКоманды.ВыполнитьКоманду(ЭтотОбъект, ПараметрыВыполнения, Объект);
КонецПроцедуры
// Конец СтандартныеПодсистемы.ПодключаемыеКоманды


// СтандартныеПодсистемы.ПодключаемыеКоманды
&НаКлиенте
Процедура Подключаемый_ПродолжитьВыполнениеКомандыНаСервере(ПараметрыВыполнения, ДополнительныеПараметры) Экспорт
	ВыполнитьКомандуНаСервере(ПараметрыВыполнения);
КонецПроцедуры
// Конец СтандартныеПодсистемы.ПодключаемыеКоманды


// ИнтеграцияС1СДокументооборотом
&НаКлиенте
Процедура Подключаемый_ВыполнитьКомандуИнтеграции(Команда)
	
	ИнтеграцияС1СДокументооборотКлиент.ВыполнитьПодключаемуюКомандуИнтеграции(Команда, ЭтаФорма, Объект);
	
КонецПроцедуры
// Конец ИнтеграцияС1СДокументооборотом

&НаКлиенте
Процедура Подключаемый_ВыполнитьПереопределяемуюКоманду(Команда)
	
	СобытияФормКлиент.ВыполнитьПереопределяемуюКоманду(ЭтаФорма, Команда);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаписатьДокумент(Команда)
	
	ОбщегоНазначенияУТКлиент.Записать(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ПровестиДокумент(Команда)
	
	ОбщегоНазначенияУТКлиент.Провести(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ПровестиИЗакрыть(Команда)
	
	ОбщегоНазначенияУТКлиент.ПровестиИЗакрыть(ЭтаФорма);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ПриСозданииЧтенииНаСервере()
	
	


КонецПроцедуры


// СтандартныеПодсистемы.ПодключаемыеКоманды
&НаКлиенте
Процедура Подключаемый_ВыполнитьКоманду(Команда)
	ПодключаемыеКомандыКлиент.НачатьВыполнениеКоманды(ЭтотОбъект, Команда, Объект);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ОбновитьКоманды()
	ПодключаемыеКомандыКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
КонецПроцедуры
// Конец СтандартныеПодсистемы.ПодключаемыеКоманды

#КонецОбласти



#Область ЗагрузитьExel

&НаКлиенте
Процедура ЗагрузитьExel(Команда)
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Заголовок = "Выберите файл";
	Диалог.ПолноеИмяФайла = ""; 
	Фильтр = "xlsx (*.xlsx)|*.xlsx"; 
	Диалог.Фильтр = Фильтр; 
	Диалог.МножественныйВыбор = Ложь;	
	Диалог.Показать(Новый ОписаниеОповещения("ЗагрузитьФайлЗавершение", ЭтаФорма, Новый Структура("Диалог", Диалог)));
КонецПроцедуры  

&НаКлиенте
Процедура ЗагрузитьФайлЗавершение(ВыбранныеФайлы, ДополнительныеПараметры) Экспорт
	
	Диалог = ДополнительныеПараметры.Диалог; 
	
	Если (ВыбранныеФайлы <> Неопределено) Тогда				
		
		АдресВХ = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(Диалог.ПолноеИмяФайла));
		Области =ОбработатьФайлНаСервере(АдресВХ); 
		ИмяОбласти = ВыбратьИзМеню(Области,Элементы.Подразделение);
		ЗаполнитьТабЧасть(ИмяОбласти.Значение);		
	КонецЕсли;
	
КонецПроцедуры    

&НаСервере
Процедура ЗаполнитьТабЧасть(Имя)  
	
	Для Каждого Область Из ТабДок.Области Цикл  
		Если СокрЛп(Область.Имя) = Имя Тогда 
		//Если СтрНачинаетсяС(Область.Имя, Имя) Тогда    
			
			МесяцГод = НазваниеМесяцаСГодом(Объект.Дата);
			
			КолонкаБезнал = Неопределено;
			Строка = Область.Верх + 2;
			Для НомерКолонки =2 По ТабДок.ШиринаСтраницы Цикл  
				Данные = ТабДок.Область(Строка, НомерКолонки, Строка, НомерКолонки).Текст; 
				Если МесяцГод =  Данные Тогда  
					КолонкаБезнал = НомерКолонки;
					Прервать;;
				КонецЕсли;
			КонецЦикла;
			
			Если КолонкаБезнал = Неопределено Тогда 
			 Сообщить("Не знайшли місяць, який відповідає даті документа!");
			Иначе
			Начало = Область.Верх+4;
			КоличествоСтрок = Область.Низ ;
			//КоличествоСтрок = Табдок.ВысотаТаблицы;  
			Н = 1; 
			КолонкаНал = КолонкаБезнал +1; 
			
			
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СтатьиДвиженияДенежныхСредств.Ссылка,
		|	СтатьиДвиженияДенежныхСредств.Наименование
		|ИЗ
		|	Справочник.СтатьиДвиженияДенежныхСредств КАК СтатьиДвиженияДенежныхСредств
		|ГДЕ
		|	НЕ СтатьиДвиженияДенежныхСредств.ЭтоГруппа
		|	И НЕ СтатьиДвиженияДенежныхСредств.Ссылка В ИЕРАРХИИ (&ГруппаНеУчитывать)";
	
	Запрос.УстановитьПараметр("ГруппаНеУчитывать", Справочники.СтатьиДвиженияДенежныхСредств.НайтиПоКоду("УТ-000965"));
	Выборка =  Запрос.Выполнить().Выбрать();
	СоответствиеСтатей = Новый Соответствие;
	Пока Выборка.Следующий() Цикл
		СоответствиеСтатей.Вставить(Нрег(Выборка.Наименование),Выборка.Ссылка);
	КонецЦикла;
		
			
			Для НомерСтроки = Начало По КоличествоСтрок Цикл
				
				Если ТабДок.Область(НомерСтроки, Н, НомерСтроки, Н).шрифт.Размер = 8 Тогда 
				Наименование = ТабДок.Область(НомерСтроки, Н, НомерСтроки, Н).Текст; 
				Если не значениезаполнено(Наименование) Тогда 
					Продолжить;
				КонецЕсли;  
				Попытка
					Безнал       = Число(ТабДок.Область(НомерСтроки, КолонкаБезнал, НомерСтроки, КолонкаБезнал).Текст);
				Исключение 
					Безнал = 0;
				КонецПопытки;    
				
				Попытка
					Нал          = Число(ТабДок.Область(НомерСтроки, КолонкаНал, НомерСтроки, КолонкаНал).Текст); 
				Исключение 
					Нал    = 0;
				КонецПопытки;
				
				Если Безнал>0 Или Нал>0 Тогда 
					Статья = СоответствиеСтатей.Получить(Нрег(Наименование));
					Если ЗначениеЗаполнено(Статья) Тогда    
						
						Если Безнал>0 Тогда  
							ДобавитьСтрокуВТЧ(Статья,Безнал,Истина);
						КонецЕсли;
						
						Если Нал>0 Тогда  
							ДобавитьСтрокуВТЧ(Статья,Нал,Ложь);
						КонецЕсли;
						
					Иначе
						Сообщить("Не нашли статью " + Наименование);
					КонецЕсли;
				КонецЕсли;
				КонецЕсли;
				
			КонецЦикла;
		    КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры    

Процедура ДобавитьСтрокуВТЧ(Статья,Сумма,ЭтоБезнал); 
	
	Нстрока = Объект.ПоказателиБДДС.Добавить();
	Нстрока.СтатьяДвиженияДенежныхСредств = Статья;
	Нстрока.Подразделение = Объект.Подразделение ; 
	Если ЭтоБезнал  Тогда 
		Нстрока.ВидОплаты = Перечисления.ВидыДенежныхСредств.Безналичные;
	Иначе 
		Нстрока.ВидОплаты = Перечисления.ВидыДенежныхСредств.Наличные;
	КонецЕсли;  
	Нстрока.Сумма = Сумма;
	
КонецПроцедуры

Функция НазваниеМесяцаСГодом(Дата) Экспорт
	
	// Проверяем, что передана дата
	Если ТипЗнч(Дата) <> Тип("Дата") Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Список месяцев на украинском языке
	Месяцы = Новый Массив;
	Месяцы.Добавить("Січень");
	Месяцы.Добавить("Лютий");
	Месяцы.Добавить("Березень");
	Месяцы.Добавить("Квітень");
	Месяцы.Добавить("Травень");
	Месяцы.Добавить("Червень");
	Месяцы.Добавить("Липень");
	Месяцы.Добавить("Серпень");
	Месяцы.Добавить("Вересень");
	Месяцы.Добавить("Жовтень");
	Месяцы.Добавить("Листопад");
	Месяцы.Добавить("Грудень");
	
	// Получаем месяц и год
	НомерМесяца = Месяц(Дата);
	Год = СтрЗаменить(Год(Дата)," ","");
	
	// Формируем строку вида "Лютий 2025"
	Возврат Месяцы[НомерМесяца - 1] + " " + Строка(Год);
	
КонецФункции

&НаСервере
Функция ОбработатьФайлНаСервере(Адрес)
	
	//Загрузка из файла PromUA
	
	Объект.ПоказателиБДДС.Очистить();
	
	//ТабДок = Новый ТабличныйДокумент;
	ТабДок.Очистить();
	Попытка
		ДвоичныеДанные = ПолучитьИзВременногоХранилища(Адрес);
		тПуть = КаталогВременныхФайлов() + "tmp.xlsx"; 
		ДвоичныеДанные.Записать(тПуть);	
		
		ТабДок.Прочитать(тПуть,СпособЧтенияЗначенийТабличногоДокумента.Значение);   
		
		Список = Новый СписокЗначений; 
		Для Каждого Строка Из ТабДок.Области Цикл  
			Список.Добавить(Строка.Имя);
		КонецЦикла;
		
	Исключение
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не удалось прочитать указанный файл по причине: "+ ОписаниеОшибки();
		Сообщение.Сообщить();
	КонецПопытки;     
	
	Возврат Список
	
	
КонецФункции    

#КонецОбласти

