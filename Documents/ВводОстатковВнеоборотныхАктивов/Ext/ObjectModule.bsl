#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	ИнициализироватьДокумент(ДанныеЗаполнения);
	
	Если ДанныеЗаполнения <> Неопределено Тогда
		ЗаполнитьЗначенияСвойств(ЭтотОбъект, ДанныеЗаполнения);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриКопировании(ОбъектКопирования)
	
	
	ИнициализироватьДокумент();
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	ОбновлениеИнформационнойБазы.ПроверитьОбъектОбработан(ЭтотОбъект);
	
	ПроведениеДокументов.ПередЗаписьюДокумента(ЭтотОбъект, РежимЗаписи, РежимПроведения);
	
	
	Если ХозяйственнаяОперация <> Перечисления.ХозяйственныеОперации.ВводОстатковОсновныхСредств Тогда
		ОС.Очистить();
	Иначе
		Для Каждого Строка Из ОС Цикл
			ОчиститьНеИспользуемыеРеквизитыОС(Строка);
		КонецЦикла;
	КонецЕсли;
	
	Если ХозяйственнаяОперация <> Перечисления.ХозяйственныеОперации.ВводОстатковНМАиРасходовНаНИОКР Тогда
		НМА.Очистить();
	КонецЕсли;
	
	
	ЗначенияЗаполнения = Новый Структура;
	
		
	Для Каждого Строка Из ОС Цикл
		Если ЗначенияЗаполнения.Количество() <> 0 Тогда
			ЗаполнитьЗначенияСвойств(Строка, ЗначенияЗаполнения);
		КонецЕсли;
		
		Если НЕ Строка.НачислятьАмортизациюБУ Тогда
			
			Строка.МетодНачисленияАмортизацииБУ = Неопределено;
			Строка.СрокИспользованияБУ = 0;
						
			Строка.СтатьяРасходовАмортизации = Неопределено;
			Строка.АналитикаРасходовАмортизации = Неопределено;
			
		КонецЕсли;
		
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	ПроведениеДокументов.ПриЗаписиДокумента(ЭтотОбъект, Отказ);
	
КонецПроцедуры

Процедура ПроверитьВводВременнойРазницы2020(Отказ)

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПорядокУчетаОСБУ.ОсновноеСредство КАК ОсновноеСредство,
		|	ПорядокУчетаОСБУ.ОсновноеСредство.Код КАК КодОС,
		|	ПорядокУчетаОСБУ.Регистратор КАК Регистратор
		|ИЗ
		|	РегистрСведений.ПорядокУчетаОСБУ КАК ПорядокУчетаОСБУ
		|ГДЕ
		|	ПорядокУчетаОСБУ.Организация = &Организация
		|	И ПорядокУчетаОСБУ.СтатьяРасходовБУ = &СтатьяРасходов
		|	И ПорядокУчетаОСБУ.Регистратор <> &ТекущийРегистратор";
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("ТекущийРегистратор", Ссылка);
	Запрос.УстановитьПараметр("СтатьяРасходов", ПланыВидовХарактеристик.СтатьиРасходов.АмортизацияВременнойРазницы2020);
	
			Результат = Запрос.Выполнить();
	
			Выборка = Результат.Выбрать();

			ШаблонСообщения = НСтр("ru='В организации <%1> уже введенно основное средство <%2 (%3)>, имеющее статью расходов по амортизации <%4>"
			"документом <%5>.';uk='В організації <%1> вже введене основний засіб <%2 (%3)>, що має статтю витрат по амортизації <%4>"
			"документом <%5>.'");
			
			Пока Выборка.Следующий() Цикл
				
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонСообщения, Организация,
									Выборка.ОсновноеСредство, Выборка.КодОС, ПланыВидовХарактеристик.СтатьиРасходов.АмортизацияВременнойРазницы2020, Выборка.Регистратор);
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , , , Отказ);
				
			КонецЦикла;

КонецПроцедуры // ПроверитьВводВременнойРазницы2020()

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	
	МассивНепроверяемыхРеквизитов = Новый Массив;
	
	ВнеоборотныеАктивы.ПроверитьСоответствиеДатыВерсииУчета(ЭтотОбъект, Ложь, Отказ);
	
	Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковОсновныхСредств Тогда
			
		ВнеоборотныеАктивы.ПроверитьОтсутствиеДублейВТабличнойЧасти(ЭтотОбъект, "ОС", "ОсновноеСредство", Отказ);
		
		ПроверкаТабличнойЧастиОС(Отказ);
		
	Иначе
		МассивНепроверяемыхРеквизитов.Добавить("ОС");
	КонецЕсли;
	
	Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковНМАиРасходовНаНИОКР Тогда
		
		ВнеоборотныеАктивы.ПроверитьОтсутствиеДублейВТабличнойЧасти(ЭтотОбъект, "НМА", "НематериальныйАктив", Отказ);
		
	Иначе
		МассивНепроверяемыхРеквизитов.Добавить("НМА");
	КонецЕсли;
	
	Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковВременнаяРазницаОСЗа2020 Тогда
		
		МассивНепроверяемыхРеквизитов.Добавить("ОС");
		МассивНепроверяемыхРеквизитов.Добавить("НМА");
		МассивНепроверяемыхРеквизитов.Добавить("Подразделение");
		
		МожноВводитьОСВременнаяНалоговаяРазница = (Дата < '20141231000000') 
												ИЛИ (Дата >= '20200301000000' И Дата < '20251201000000');
	
		Если НЕ МожноВводитьОСВременнаяНалоговаяРазница Тогда

			СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Для основного средства  %1 указана дата ввода  <%2> !"
				"Для корректного начисления амортизации дата ввода должна быть в период с 01.03.20 по 01.12.2025.';uk='Для основного засобу %1 зазначена дата вводу <%2> міс.!"
				"Для коректного нарахування амортизації  дата вводу повинна бути в період з 01.03.20 по 01.12.2025.'"),
													ОсновноеСредствоВременнаяНалоговаяРазница, Дата);
				
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтрокаСообщения);
		
		КонецЕсли;
		
		Если СрокИспользованияВременнаяНалоговаяРазница > 60 Тогда
										
			СтрокаСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Для основного средства  %1 указан срок полезного использования <%2> мес.!"
				"Для корректного начисления амортизации срок использования должен быть не более 60 месяцев.';uk='Для основного засобу %1 зазначений строк корисного використання <%2> міс.!"
				"Для коректного нарахування амортизації строк використання повинен бути не більше 60 місяців.'"),
													ОсновноеСредствоВременнаяНалоговаяРазница, СрокИспользованияВременнаяНалоговаяРазница);
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтрокаСообщения);
		
		КонецЕсли;
		
		ПроверитьВводВременнойРазницы2020(Отказ);
	
	Иначе
		
		МассивНепроверяемыхРеквизитов.Добавить("ОсновноеСредствоВременнаяНалоговаяРазница");
		МассивНепроверяемыхРеквизитов.Добавить("СтоимостьНУВременнаяНалоговаяРазница");
		МассивНепроверяемыхРеквизитов.Добавить("СрокИспользованияВременнаяНалоговаяРазница");
		
	КонецЕсли;

	
	ПараметрыВыбораСтатейИАналитик = Документы.ВводОстатковВнеоборотныхАктивов.ПараметрыВыбораСтатейИАналитик();
	ДоходыИРасходыСервер.ОбработкаПроверкиЗаполнения(ЭтотОбъект, Отказ, ПроверяемыеРеквизиты, ПараметрыВыбораСтатейИАналитик);
	
	ОбщегоНазначения.УдалитьНепроверяемыеРеквизитыИзМассива(ПроверяемыеРеквизиты, МассивНепроверяемыхРеквизитов);
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	ПроведениеДокументов.ОбработкаПроведенияДокумента(ЭтотОбъект, Отказ);
	
	Если Не Отказ Тогда
		РеглУчетПроведениеСервер.ОтразитьДокумент(Новый Структура("Ссылка, Дата, Организация", Ссылка, Дата));
	КонецЕсли;

	ОбновлениеОбъектовЭксплуатацииПриПроведении(Отказ);
	
КонецПроцедуры

Процедура ОбновлениеОбъектовЭксплуатацииПриПроведении(Отказ)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ОбъектыЭксплуатации", ОС.ВыгрузитьКолонку("ОсновноеСредство"));
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ОбъектыЭксплуатации.Ссылка
	|ИЗ
	|	Справочник.ОбъектыЭксплуатации КАК ОбъектыЭксплуатации
	|ГДЕ
	|	ОбъектыЭксплуатации.Ссылка В(&ОбъектыЭксплуатации)
	|		И ОбъектыЭксплуатации.ИнвентарныйНомер = """"
	|";
		
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить("Справочник.ОбъектыЭксплуатации");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Ссылка", "Ссылка");
		ЭлементБлокировки.ИсточникДанных = Результат;
		Блокировка.Заблокировать();
		
	Исключение
		Отказ = Истина;
		ТекстСообщения = НСтр("ru='Ошибка при попытке обновления инвентарный номера для принимаемых к учету объектов основных средств""
|		""%1'
|;uk='Помилка при спробі оновлення інвентарні номери для прийнятих до обліку об''єктів основних засобів ""
|   ""%1'");
		
		ТекстСообщения = СтрШаблон(ТекстСообщения, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЗаписьЖурналаРегистрации(
			ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
			УровеньЖурналаРегистрации.Предупреждение,
			Ссылка.Метаданные(),
			Ссылка,
			ТекстСообщения);
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, "ОС",, Отказ);
		
	КонецПопытки;
	
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ОбъектСправочника = Выборка.Ссылка.ПолучитьОбъект();
		Если Не ЗначениеЗаполнено(ОбъектСправочника.ИнвентарныйНомер) Тогда
			СтрокаТаблицы = ОС.Найти(Выборка.Ссылка, "ОсновноеСредство");
			ОбъектСправочника.ИнвентарныйНомер = СтрокаТаблицы.ИнвентарныйНомер;
		КонецЕсли;

		Попытка
			ОбъектСправочника.Записать();
		Исключение
			ТекстСообщения = НСтр("ru='Ошибка при попытке обновления реквизитов принимаемых к учету объектов основных средств
|%1'
|;uk='Помилка при спробі оновлення реквізитів прийнятих до обліку об''єктів основних засобів
|%1'");
			ТекстСообщения = СтрШаблон(ТекстСообщения, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ЗаписьЖурналаРегистрации(
				ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Предупреждение,
				Ссылка.Метаданные(),
				Ссылка,
				ТекстСообщения);
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, "ОС",, Отказ);
		КонецПопытки;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ)
	
	ПроведениеДокументов.ОбработкаУдаленияПроведенияДокумента(ЭтотОбъект, Отказ);
	
КонецПроцедуры

Процедура ПередУдалением(Отказ)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ИнициализироватьДокумент(ДанныеЗаполнения = Неопределено)
	
	Ответственный = Пользователи.ТекущийПользователь();
	Организация = ЗначениеНастроекПовтИсп.ПолучитьОрганизациюПоУмолчанию(Организация);
	
КонецПроцедуры

Процедура ПроверкаТабличнойЧастиОС(Отказ)
	
	Для Каждого Строка Из ОС Цикл 
	КонецЦикла;
	
КонецПроцедуры
Процедура ОчиститьНеИспользуемыеРеквизитыОС(Описание)
	
	Если Описание.НалоговоеНазначение = Справочники.НалоговыеНазначенияАктивовИЗатрат.НДС_НеоблагаемаяНеХозДеятельность Тогда
		Описание.НачислятьАмортизациюНУ = Ложь;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли