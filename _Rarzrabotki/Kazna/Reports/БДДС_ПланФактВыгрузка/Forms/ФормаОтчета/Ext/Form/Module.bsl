
&НаСервере
Функция ВыгрузитьДанныеНаСервере()
	ОтчетОбъект = РеквизитФормыВЗначение("Отчет"); 
	
	Настройки = ОтчетОбъект.КомпоновщикНастроек.ПолучитьНастройки();

	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;

	МакетКомпоновкиДанных = КомпоновщикМакета.Выполнить(ОтчетОбъект.СхемаКомпоновкиДанных,  
	Настройки, , , Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));

	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;

	ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновкиДанных);

	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;

	ДеревоЗначений = Новый ДеревоЗначений;
	ПроцессорВывода.УстановитьОбъект(ДеревоЗначений);

	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных); 
	
	//Сообщить(ДеревоЗначений.Строки.Количество());
	Для каждого СтрПодразделение Из ДеревоЗначений.Строки Цикл
		Сообщить("Подр "+СтрПодразделение.Подразделение);
		Для каждого СтрСтатьяГруппа Из СтрПодразделение.Строки Цикл
			Сообщить("Статья "+СтрСтатьяГруппа.СтатьяДвиженияДенежныхСредств);
		КонецЦикла;
	КонецЦикла;
	
	Возврат 1;
	//АдресВХ = ПоместитьВоВременноеХранилище(ДеревоЗначений);
	//Возврат   АдресВХ ;
КонецФункции

&НаКлиенте
Процедура ВыгрузитьДанные(Команда)     
	
		//Эксель = Новый COMObject("Excel.Application");
		//newWindow=Эксель.Workbooks; 
		//newWindow.Open(ПутьКФайлу); 
		//
		//СпЛистов = Новый СписокЗначений;
		//
		//
		//СмещениеКолонкиСтоимость=0;
		//
		//Для СчЛистов=1  По Эксель.Sheets.COUNT() Цикл
		//	//Если Эксель.Sheets(СчЛистов).name="Sale KZT" Тогда
		//	//	Прервать;
		//	//КонецЕсли;
		//	СпЛистов.Добавить(СчЛистов,Эксель.Sheets(СчЛистов).name);
		//КонецЦикла;
		////
		//
		//   СпЛистов.ВыбратьЭлемент();
		//Возврат;

	
	//Помещаем файл во временное хранилище
	ОповещениеЗавершенияСозданиеДвоичныхДанныхИзФайла = Новый ОписаниеОповещения("ЗавершенияСозданиеДвоичныхДанныхИзФайла",ЭтаФорма);
	НачатьСозданиеДвоичныхДанныхИзФайла(ОповещениеЗавершенияСозданиеДвоичныхДанныхИзФайла,ПутьКФайлу);

	
	//локДерево =ПолучитьИзВременногоХранилища(ВыгрузитьДанныеНаСервере());
КонецПроцедуры


&НаКлиенте
Процедура ЗавершенияСозданиеДвоичныхДанныхИзФайла(ДвоичныеДанные,ДополнительныеПараметры)  Экспорт 
	АдресВременногоХранилища = ПоместитьВоВременноеХранилище(ДвоичныеДанные, ЭтаФорма.УникальныйИдентификатор);
	
	Рез  = ОбработкаФайлаНаСервере(АдресВременногоХранилища); 
	ИмяФайлаДанных=Рез.Адрес;
	
	локФайл = ПолучитьИзВременногоХранилища(ИмяФайлаДанных);
	НовоеИмяФайла = Сред(ПутьКФайлу,1,СтрДлина(ПутьКФайлу)-5)+Формат(ТекущаяДата(),"ДФ=_ddMMyyyy_hhmmss")+".xlsx";
	локФайл.ЗАписать(НовоеИмяФайла);
	Сообщить("Сохранили результат "+НовоеИмяФайла);
	Рез.ТД.Показать("Резуьтаты выгрузки");
КонецПроцедуры


//&НаСервереБезКонтекста
&НаСервере
Функция ОбработкаФайлаНаСервере(АдресВХ)
	
	БинДанные = ПолучитьИзВременногоХранилища(АдресВХ);
	Если БинДанные <> Неопределено Тогда
		ИмяФайлаДанных =   ПолучитьИмяВременногоФайла("xlsx");
		ИмяФайлаДанных2 =   ПолучитьИмяВременногоФайла("xlsx");
		БинДанные.Записать(ИмяФайлаДанных);  
		
		
		
		Эксель = Новый COMObject("Excel.Application");
		Эксель.Visible = Ложь;  
		newWindow=Эксель.Workbooks; 
		newWindow.Open(ИмяФайлаДанных); 
		
		
		СпЛистов = Новый СписокЗначений;
		
		
		СмещениеКолонкиСтоимость=0;
		
		Для СчЛистов=1  По Эксель.Sheets.COUNT() Цикл
			СпЛистов.Добавить(СтрЗАменить(ВРЕГ(СокрЛП(Эксель.Sheets(СчЛистов).name))," ",""),СчЛистов);
		КонецЦикла;
			
		
		
		ОтчетОбъект = РеквизитФормыВЗначение("Отчет"); 
		Макет =ОтчетОбъект.ПолучитьМакет("РезультатВыгрузки"); 
		ОблПодразделение = Макет.ПолучитьОбласть("Подразделение");
		ОблСтрока = Макет.ПолучитьОбласть("Строка");
		
		Настройки = ОтчетОбъект.КомпоновщикНастроек.ПолучитьНастройки();
		
		КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
		
		МакетКомпоновкиДанных = КомпоновщикМакета.Выполнить(ОтчетОбъект.СхемаКомпоновкиДанных,  
		Настройки, , , Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));
		
		ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
		
		ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновкиДанных);
		
		ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
		
		ДеревоЗначений = Новый ДеревоЗначений;
		ПроцессорВывода.УстановитьОбъект(ДеревоЗначений);
		
		ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных); 
		
		//Сообщить(ДеревоЗначений.Строки.Количество()); 
		;
		ТД  = Новый ТабличныйДокумент;
		
		НазваниеМесяца = ВРЕГ(ФОрмат(Настройки.ПараметрыДанных.Элементы[2].Значение.ДатаНачала,"Л=ru; ДФ='MMMM yyyy'"));
		Для каждого СтрПодразделение Из ДеревоЗначений.Строки Цикл
			//Сообщить("Подр "+СтрПодразделение.Подразделение);
			Если Не ЗначениеЗаполнено(СтрПодразделение.Подразделение) Тогда
				Продолжить;
			КонецЕсли;
			ОблПодразделение.Параметры.Подразделение =СтрПодразделение.Подразделение;
			ТД.Вывести(ОблПодразделение);
			
			ТекЛист = СпЛистов.НайтиПоЗначению(СтрЗаменить(ВРЕГ(СтрПодразделение.Подразделение.Наименование)," ",""));
			Если ТекЛист =Неопределено Тогда
				//Сообщить("В файле не найден лист "+СтрПодразделение.Подразделение);
				ОблСтрока.Параметры.КОмментарий ="В файле не найден лист "+СтрПодразделение.Подразделение; 
				ТД.Вывести(ОблСтрока);
				Продолжить;
			КонецЕсли;
			
			//Ищем начальную колонку
			Лист = Эксель.Sheets(Число(ТекЛист.Представление));
			ВсегоСтрок = Лист.UsedRange.Rows.Count;
			ВсегоКолонок = Лист.UsedRange.Columns.Count; 
			НачКолонка=0;
			Для СчКолонок =Макс(1,ВсегоКолонок-200)  По ВсегоКолонок Цикл
				ТекЗначение=ВРЕГ(Лист.cells(1,СчКолонок).value);
				Если ТекЗначение=НазваниеМесяца Тогда
					 НачКолонка =СчКолонок;
					Прервать;; 
				КонецЕсли;
			КонецЦикла;
			
			Если НачКолонка=0 Тогда
				//Сообщить("Лист "+СтрПодразделение.Подразделение+", не наден раздел "+НазваниеМесяца);			
				ОблСтрока.Параметры.КОмментарий ="Лист "+СтрПодразделение.Подразделение+", не наден раздел "+НазваниеМесяца; 
				ТД.Вывести(ОблСтрока);
				Продолжить;
			КонецЕсли; 
			
			
			ТзСтатей = Новый ТаблицаЗначений;
			ТзСтатей.Колонки.Добавить("Статья");
			ТзСтатей.Колонки.Добавить("Номер");
			
			ЭтоДоход = Истина;
			Для СчСтрок=4 По ВсегоСтрок Цикл
				НазваниеСтатьи =ВРЕГ(Лист.cells(СчСтрок,1).value); 
				Если СтрНайти(НазваниеСтатьи,"СПИСАНИЕ")>0 Тогда
					ЭтоДоход= Ложь;
				КонецЕсли;
				НазваниеСтатьи= СтрЗаменить(НазваниеСтатьи," ","")+?(ЭтоДоход,"_Д","_Р");
				НазваниеСтатьи=СтрЗаменить(НазваниеСтатьи,"1.","");
				НазваниеСтатьи=СтрЗаменить(НазваниеСтатьи,"2.","");
				НазваниеСтатьи=СтрЗаменить(НазваниеСтатьи,"3.","");
				
				ТекСтрокаСтатьи= ТзСтатей.Найти(НазваниеСтатьи);
				Если ТекСтрокаСтатьи=Неопределено Тогда
					нСтр = ТзСтатей.Добавить();
					нСтр.Статья= НазваниеСтатьи;
					нСтр.Номер = СчСтрок;                     
					//Сообщить(""+ НазваниеСтатьи);
				Иначе             
					//Название группы и статьи совпадают. Запишем номер статьи
					
					ТекСтрокаСтатьи.Номер = СчСтрок;                     
					//Сообщить("Дубль статьи "+ НазваниеСтатьи);
				КонецЕсли;
			КонецЦикла;
			
			
			//Сообщить("*** Обработка листа "+СтрПодразделение.Подразделение);
			Для каждого СтрВидОплаты Из СтрПодразделение.Строки Цикл
				//вид оплаты 
				Если СтрВидОплаты.ВидОПлаты = Перечисления.ВидыДенежныхСредств.Наличные Тогда
					ТекКолонка  = НачКолонка+3;
				Иначе	
					ТекКолонка  = НачКолонка;
				КонецЕсли;
				
				ВывестиДанныеПоСтатьям(СтрВидОплаты,Лист,ТекКолонка,ТзСтатей,ТД,ОблСтрока);
				//Сообщить("Статья "+СтрСтатьяГруппа.СтатьяДвиженияДенежныхСредств);
								
			КонецЦикла;
		КонецЦикла;
		
		
		
		
		
		//
		//Лист = Эксель.Sheets(1);
		////
		//Всего = Лист.UsedRange.Rows.Count;
		//Лист.cells(2,2).value="Дата измененеия "+ ТекущаяДата();
		
		Эксель.DisplayAlerts = False; // отключение
		Эксель.ActiveWorkbook.SaveAs(ИмяФайлаДанных);
		Эксель.Quit();    
		Эксель = 0;
		
		//ТД.Показать();
		
		//Сообщить("Записали временный файл "+ИмяФайлаДанных);
		
		Возврат Новый Структура("ТД,Адрес",ТД,ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(ИмяФайлаДанных)));
	КонецЕсли;     
	
КонецФункции


&НаКлиенте
Процедура ИмяФайлаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Фильтр = "Книга Excel (*.xls*)|*.xls*";
	Диалог.Заголовок = "Выберите файл Excel";
	ОповещениеЗавершения = Новый ОписаниеОповещения("ВыборФайлаЗавершение", ЭтотОбъект);
	Диалог.Показать(ОповещениеЗавершения);
КонецПроцедуры                    

&НаКлиенте
Процедура ВыборФайлаЗавершение(ВыбранныеФайлы, ДополнительныеПараметры) Экспорт
	Если ВыбранныеФайлы <> Неопределено Тогда
		ПутьКФайлу = ВыбранныеФайлы[0];
	КонецЕсли;
КонецПроцедуры

Процедура ВывестиДанныеПоСтатьям(СтрокиСтатей,Лист,ТекКолонка,ТзСтатей, ТД, ОблСтрока) ЭКспорт
	
	Для каждого СтрСтатьяГруппа Из СтрокиСтатей.Строки Цикл
		Если СтрСтатьяГруппа.Строки.Количество()=0 Тогда
			
		Иначе
			ВывестиДанныеПоСтатьям(СтрСтатьяГруппа,Лист,ТекКолонка,ТзСтатей,ТД, ОблСтрока);	
		КонецЕсли;
		
		
		НазваниеСтатьи=СтрЗаменить((ВРЕГ(СтрСтатьяГруппа.СтатьяДвиженияДенежныхСредств.Наименование))," ","");
		НазваниеСтатьи=СтрЗаменить(НазваниеСтатьи,"1.","");
		НазваниеСтатьи=СтрЗаменить(НазваниеСтатьи,"2.","");
		НазваниеСтатьи=СтрЗаменить(НазваниеСтатьи,"3.","")+?(ЭтоДоход(СтрСтатьяГруппа.СтатьяДвиженияДенежныхСредств),"_Д","_Р");
		
		СтрокаСтатьи  =ТзСтатей.Найти(НазваниеСтатьи); 
		Если СтрокаСтатьи=Неопределено Тогда
			
				ОблСтрока.Параметры.КОмментарий ="Для статьи "+ НазваниеСтатьи+" не найдена строка в файле"; 
				ТД.Вывести(ОблСтрока);

			//Сообщить(); 
			Продолжить;
		КонецЕсли;
		НомерСтрокиФайла  = СтрокаСтатьи.Номер;
		
		НеВыводитьИтогиПоГруппам=Истина;
		Если ЭтоСТатьяГруппа(СтрСтатьяГруппа.СтатьяДвиженияДенежныхСредств) И НеВыводитьИтогиПоГруппам Тогда
		   Продолжить;;
	    КонецЕсли;
	   
		Попытка
			Лист.cells(НомерСтрокиФайла,ТекКолонка).value =  СтрСтатьяГруппа.СуммаПлан;
		Исключение
		КонецПопытки;
		
		Попытка
			Лист.cells(НомерСтрокиФайла,ТекКолонка+1).value =СтрСтатьяГруппа.СуммаИтого;
		Исключение
		КонецПопытки;
		
		
		//Лист.cells(НомерСтрокиФайла,ТекКолонка+2).value =СтрСтатьяГруппа.Разница;
		//Сообщить(""+ НазваниеСтатьи+", стр= "+ НомерСтрокиФайла+", кол= " +(ТекКолонка+1)+"  = "+СтрСтатьяГруппа.СуммаИтого);
	КонецЦикла;
	
	
КонецПроцедуры

Функция ЭтоДоход(текСтатья) Экспорт  
	Если НЕ ЗначениеЗаполнено(текСтатья) Тогда
		Возврат Ложь;
	КонецЕсли;
	СпрДоход = Справочники.СтатьиДвиженияДенежныхСредств.НайтиПоКоду("1Д");
	Если текСтатья=СпрДоход ИЛИ текСтатья.ПринадлежитЭлементу(СпрДоход) Тогда
	     Возврат  Истина;
	 ИНаче
		 Возврат Ложь;
	КонецЕсли;
КонецФункции // ()

Функция ЭтоСТатьяГруппа(локСтатья)
	Возврат локСтатья.ЭтоГруппа;
КонецФункции // ()
