Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Ответственный = Пользователи.ТекущийПользователь();
	
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ЗаявкаНаРасходованиеДенежныхСредств") Тогда
				
		ВалютаДокумента = ДанныеЗаполнения.ВалютаДокумента;
		Комментарий = ДанныеЗаполнения.Комментарий;
		Контрагент = ДанныеЗаполнения.Контрагент;
		Организация = ДанныеЗаполнения.Организация;
		Ответственный = ДанныеЗаполнения.Ответственный;
		//**Подразделение = ДанныеЗаполнения.Подразделение.Родитель;
		Подразделение = ДанныеЗаполнения.Подразделение;
		СтатьяДвиженияДенежныхСредств = ДанныеЗаполнения.СтатьяДвиженияДенежныхСредств;
		СуммаДокумента = ДанныеЗаполнения.СуммаДокумента;
		ДокументОснование = ДанныеЗаполнения;   
		
		//Тютюн         
		Если ЗначениеЗаполнено(ДанныеЗаполнения.СчетНаОплатуПоставщика) Тогда  
			Если  ДанныеЗаполнения.СчетНаОплатуПоставщика.ВидОперации = Перечисления.ВидыОперацийСчетНаОплатуПоставщику.Перемещение Тогда 
				ВидОперации = Перечисления.ВидыОперацийРКО.ПеремещениеДС;
				Касса           =  ДанныеЗаполнения.СчетНаОплатуПоставщика._Касса;
				КассаПолучатель =  ДанныеЗаполнения.СчетНаОплатуПоставщика._КассаПолучатель;  
				СтатьяЗатрат    =  ДанныеЗаполнения.СчетНаОплатуПоставщика.СтатьяЗатрат;
			КонецЕсли;
		КонецЕсли;
		//КОнецИзменений
		
	ИначеЕсли ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ПриходныйКассовыйОрдер") Тогда
		Если Ложь Тогда                 
			ДанныеЗаполнения= Документы.ПриходныйКассовыйОрдер.СоздатьДокумент();
		КонецЕсли;
		ВалютаДокумента = ДанныеЗаполнения.ВалютаДокумента;
		Комментарий = ДанныеЗаполнения.Комментарий;
		Контрагент = ДанныеЗаполнения.Контрагент;
		Организация = ДанныеЗаполнения.Организация;
		Ответственный = ДанныеЗаполнения.Ответственный;
		//**Подразделение = ДанныеЗаполнения.Подразделение.Родитель;
		Подразделение = ДанныеЗаполнения.Подразделение;
		СтатьяДвиженияДенежныхСредств = ДанныеЗаполнения.СтатьяДвиженияДенежныхСредств;
		СуммаДокумента = ДанныеЗаполнения.СуммаДокумента;
		ДокументОснование = ДанныеЗаполнения;
		Касса= ДанныеЗаполнения.Касса;  
		
	ИначеЕсли ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.РаспределениеФ2") Тогда 
		
				
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	РаспределениеФ2Распределение.Подразделение,
		|	СУММА(РаспределениеФ2Распределение.СуммаНачисления) КАК Сумма,
		|	РаспределениеФ2Распределение.Направление,
		|	РаспределениеФ2Распределение.Сотрудник.СтатьяЗарплата КАК СтатьяДвиженияДенежныхСредств
		|ИЗ
		|	Документ.РаспределениеФ2.Распределение КАК РаспределениеФ2Распределение
		|ГДЕ
		|	РаспределениеФ2Распределение.Ссылка = &Основание
		|
		|СГРУППИРОВАТЬ ПО
		|	РаспределениеФ2Распределение.Направление,
		|	РаспределениеФ2Распределение.Подразделение,
		|	РаспределениеФ2Распределение.Сотрудник.СтатьяЗарплата";
	
	Запрос.УстановитьПараметр("Основание", ДанныеЗаполнения.Ссылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
         Нстрока = Расшифровка.Добавить();
		 ЗаполнитьЗначенияСвойств(Нстрока,Выборка);
	 КонецЦикла;  
	 
	 Направление = ДанныеЗаполнения.Направление;
	 Организация = ДанныеЗаполнения.Организация;
	// ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("980");
	 СуммаДокумента  = Расшифровка.Итог("Сумма");
		
	КонецЕсли;
		
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, Режим)
		
	//++ Бахтишаев А.Э. , 22/09/16 03:43,278
	КонтрольОстатковПоКассе(Отказ);
	//-- Бахтишаев А.Э. , 22/09/16 03:43
	
	//++ Павел Чистяков 12.10.2016 17:58:21 №320
	Документы.РасходныйКассовыйОрдер.ПроверитьДокументОснование(ДокументОснование, Отказ);
	
	// регистр ДенежныеСредства Приход
	Движения.ДенежныеСредства.Записывать = Истина;
	Движения.БДДС.Записывать = Истина;
	Движение = Движения.ДенежныеСредства.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
	Движение.Период = Дата;
	Движение.БанковскийСчетКасса=Касса;
	Движение.Сумма=СуммаДокумента;
	Движение.ВидДенежныхСредств=Перечисления.ВидыДенежныхСредств.Наличные;
	Движение.Организация = Организация;
	
	Движения.БДДС.ВыполнитьДвижение(ЭтотОбъект);
	
	Если Расшифровка.Количество()>0 Тогда
		Движения.БДДС.Очистить();
		Для каждого Стр Из Расшифровка Цикл
			Движение = Движения.БДДС.Добавить();
			Движение.Период = Дата;
			
			
			Движение.Активность=Истина;
			Движение.ВидОплаты=Перечисления.ВидыДенежныхСредств.Наличные;
			Движение.СтатьяДвиженияДенежныхСредств=Стр.СтатьяДвиженияДенежныхСредств;
			Движение.Подразделение=Стр.Подразделение;
			Движение.НаправлениеДДС	= Перечисления.НаправленияДвиженийДенежныхСредств.Расход;
			Движение.СуммаРасход=Стр.Сумма;
			Движение.Сумма=Стр.Сумма;
			Движение.ДокументОснование=ДокументОснование;
			Движение.Направление=Стр.Направление;
		КонецЦикла;
	КонецЕсли;
	
	
	Если ЗначениеЗаполнено(ДокументОснование) И ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ЗаявкаНаРасходованиеДенежныхСредств") Тогда 
		Движения.ЗаявкиНаРасходованиеДС.Записывать = Истина;
		Движение 			= Движения.ЗаявкиНаРасходованиеДС.Добавить();
		Движение.Период 	= Дата;
		Движение.ВидДвижения= ВидДвиженияНакопления.Расход;
		Движение.ЗаявкаНаРасходованиеДС = ДокументОснование;
		Движение.Сумма 		= СуммаДокумента;
	КонецЕсли;
		
	Если ЗначениеЗаполнено( ДокументОснование ) 				И ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ЗаявкаНаРасходованиеДенежныхСредств" )
		И ЗначениеЗаполнено(ДокументОснование.ДокументОснование)И ТипЗнч(ДокументОснование.ДокументОснование) = Тип("ДокументСсылка.СчетНаОплатуПоставщика" ) Тогда  
		
		Движения.СчетаПоставщиков.Записывать = Истина;
		Движение 						= Движения.СчетаПоставщиков.Добавить();
		Движение.Период 				= Дата;
		Движение.ВидДвижения			= ВидДвиженияНакопления.Расход;
		Движение.СчетНаОплатуПоставщика = ДокументОснование.ДокументОснование;
		Движение.Сумма 					= 0;
		Движение.НаОплату 				= СуммаДокумента;
		
	КонецЕсли;
	
	//Тютюн  
	ДатаНачалаДС = Константы.ДатаНачалаУчетаСтоимостиНаличных.Получить();
	Если ЗначениеЗаполнено(ДатаНачалаДС) И Дата >= ДатаНачалаДС Тогда 
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ДСКассаОстатки.СуммаОстаток <> 0
		|			ТОГДА ДСКассаОстатки.СуммаКомиссииФАОстаток / ДСКассаОстатки.СуммаОстаток
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК ПроцентКомиссии
		|ИЗ
		|	РегистрНакопления.ДСКасса.Остатки(&Дата, Касса = &Касса) КАК ДСКассаОстатки";
		
		Запрос.УстановитьПараметр("Дата", Дата-1);
		Запрос.УстановитьПараметр("Касса", Касса);
		
		ВыборкаКасса = Запрос.Выполнить().Выбрать();
		
		Если ВыборкаКасса.Следующий() ТОгда
			ПроцентКомиссии = ВыборкаКасса.ПроцентКомиссии;
		Иначе
			ПроцентКомиссии = 0;
		КонецЕсли;
		
		Движения.ДСКасса.Записывать = Истина;
		Движение 						= Движения.ДСКасса.Добавить();  
		Движение.Касса                  = Касса;
		Движение.Период 				= Дата;
		Движение.ВидДвижения			= ВидДвиженияНакопления.Расход;
		Движение.Сумма 					= СуммаДокумента;
		Движение.СуммаКомиссииФА 		= СуммаДокумента * ПроцентКомиссии;    
		
		Если НЕ Отказ Тогда 
			ДопМодуль.ОбновитьПоследовательностьКассы(Ссылка);
		КонецЕсли;
		
		Если ВидОперации= Перечисления.ВидыОперацийРКО.ОплатаПоставщику ИЛИ  ВидОперации= Перечисления.ВидыОперацийРКО.ПрочийРасход Тогда  
			Если ПроцентКомиссии <>0 Тогда
				Если Расшифровка.Количество() = 0 Тогда 
					Движение 						= Движения.БДДС.Добавить();	
					Движение.Активность=Истина;
					//			Движение.ВидДвижения=ВидДвиженияНакопления.Расход;
					Движение.Период= Дата;
					Движение.ВидОплаты=Перечисления.ВидыДенежныхСредств.Безналичные;
					Движение.Комментарий="Комиссия финагента";
					Движение.НаправлениеДДС=Перечисления.НаправленияДвиженийДенежныхСредств.Расход;
					Движение.ПланФакт=Ложь;
					//Движение.Подразделение= КассаПолучатель.Владелец;
					Движение.Подразделение= Подразделение;
					Движение.Сумма=  СуммаДокумента * ПроцентКомиссии;
					Движение.СуммаРасход=  Движение.Сумма;
					Движение.Направление= Направление;
					Движение.СтатьяДвиженияДенежныхСредств=Константы.СтатьяКомиссияФинАгента.Получить();  
					СтруктураПроцентФинАгента = РегистрыСведений.ПроцентКомиссииФинАгента.ПолучитьПоследнее(Дата,Новый Структура("Направление",Направление));
					Если СтруктураПроцентФинАгента.ПроцентКомиссии<>0 Тогда  
						Движение.СтараяСумма=  СуммаДокумента*(СтруктураПроцентФинАгента.ПроцентКомиссии/100);
					КонецЕсли;   
				Иначе      
					
					СтруктураПроцентФинАгента = РегистрыСведений.ПроцентКомиссииФинАгента.ПолучитьПоследнее(Дата,Новый Структура("Направление",Направление));
					Для Каждого СтрокаТЧ Из Расшифровка Цикл 
						Движение 						= Движения.БДДС.Добавить();	
						Движение.Активность=Истина;
						//			Движение.ВидДвижения=ВидДвиженияНакопления.Расход;
						Движение.Период= Дата;
						Движение.ВидОплаты=Перечисления.ВидыДенежныхСредств.Безналичные;
						Движение.Комментарий="Комиссия финагента";
						Движение.НаправлениеДДС=Перечисления.НаправленияДвиженийДенежныхСредств.Расход;
						Движение.ПланФакт=Ложь;
						//Движение.Подразделение= КассаПолучатель.Владелец;
						Движение.Подразделение= СтрокаТЧ.Подразделение;
						Движение.Сумма=  СтрокаТЧ.Сумма * ПроцентКомиссии;
						Движение.СуммаРасход =  Движение.Сумма;
						Движение.Направление = СтрокаТЧ.Направление;
						Движение.СтатьяДвиженияДенежныхСредств=Константы.СтатьяКомиссияФинАгента.Получить();  
						
						Если СтруктураПроцентФинАгента.ПроцентКомиссии<>0 Тогда  
							Движение.СтараяСумма=  СтрокаТЧ.Сумма *(СтруктураПроцентФинАгента.ПроцентКомиссии/100);
						КонецЕсли;   
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;  
		
	Иначе
		Если ВидОперации= Перечисления.ВидыОперацийРКО.ОплатаПоставщику ИЛИ  ВидОперации= Перечисления.ВидыОперацийРКО.ПрочийРасход Тогда
			//Добавим комиссию фин агента
			СтруктураПроцентФинАгента = РегистрыСведений.ПроцентКомиссииФинАгента.ПолучитьПоследнее(Дата,Новый Структура("Направление",Направление));
			Если СтруктураПроцентФинАгента.ПроцентКомиссии<>0 Тогда
				Движение 						= Движения.БДДС.Добавить();	
				Движение.Активность=Истина;
				//			Движение.ВидДвижения=ВидДвиженияНакопления.Расход;
				Движение.Период= Дата;
				Движение.ВидОплаты=Перечисления.ВидыДенежныхСредств.Безналичные;
				Движение.Комментарий="Комиссия финагента";
				Движение.НаправлениеДДС=Перечисления.НаправленияДвиженийДенежныхСредств.Расход;
				Движение.ПланФакт=Ложь;
				//Движение.Подразделение= КассаПолучатель.Владелец;
				Движение.Подразделение= Подразделение;
				Движение.Сумма=  СуммаДокумента*(СтруктураПроцентФинАгента.ПроцентКомиссии/100);
				Движение.СуммаРасход=  Движение.Сумма;
				Движение.Направление= Направление;
				Движение.СтатьяДвиженияДенежныхСредств=Константы.СтатьяКомиссияФинАгента.Получить();
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	//КонецИзменений
	
		
		
КонецПроцедуры

Процедура КонтрольОстатковПоКассе(Отказ)
	//Тютюн отключил отрицательные остатки
	//Если Не Константы.АХ_ПроверятьОстаткиПоКассе.Получить() Тогда
	//	Возврат;
	//КонецЕсли;
	//
	//
	//Если РольДоступна("АХ_ПроводитьКассуВМинус") Тогда
	//	Возврат;
	//КонецЕсли;
	//
	//Если РольДоступна("ПолныеПрава") Тогда
	//	Возврат;
	//КонецЕсли;   
	//КонецИзменений

	
	Запрос	= Новый Запрос;
	
	Запрос.УстановитьПараметр("Период", Новый Граница(Дата, ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("Касса", Касса);
	Запрос.Текст	= "ВЫБРАТЬ
	            	  |	ДенежныеСредстваОстатки.СуммаОстаток
	            	  |ИЗ
	            	  |	РегистрНакопления.ДенежныеСредства.Остатки(
	            	  |			&Период,
	            	  |			ВидДенежныхСредств = ЗНАЧЕНИЕ(Перечисление.ВидыДенежныхСредств.Наличные)
	            	  |				И БанковскийСчетКасса = &Касса) КАК ДенежныеСредстваОстатки";
					  
	РезультатЗапроса	= Запрос.Выполнить().Выбрать();
	
	Если РезультатЗапроса.Следующий() Тогда
		Если РезультатЗапроса.СуммаОстаток < СуммаДокумента Тогда
			Отказ = Истина;
		КонецЕсли;
	Иначе
		Отказ = Истина;
	КонецЕсли;
	
	Если Отказ Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru='Остаток ДС по кассе отрицательный. Проведение невозможно.'"),
			Ссылка,
			,
			,
			Отказ);
	КонецЕсли;		
	
КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	
	Если ВидОперации=Перечисления.ВидыОперацийРКО.ПеремещениеДС Тогда
		ПроверяемыеРеквизиты.Добавить("КассаОтправитель");
	КонецЕсли;	
	
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ) 

	ДатаНачалаДС = Константы.ДатаНачалаУчетаСтоимостиНаличных.Получить();

	Если ЗначениеЗаполнено(ДатаНачалаДС) И Дата >= ДатаНачалаДС Тогда 
		ДопМодуль.ОбновитьПоследовательностьКассы(Ссылка);
	КонецЕсли; 
КонецПроцедуры

