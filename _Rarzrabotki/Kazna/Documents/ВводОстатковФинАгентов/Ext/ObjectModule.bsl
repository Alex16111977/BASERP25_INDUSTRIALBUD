Процедура ОбработкаПроведения(Отказ, РежимПроведения)
    
    // Инициализация движений
    Движения.ДенежныеСредстваФинАгенты.Записывать = Истина;
    Движения.ДенежныеСредстваФинАгенты.Очистить();
    
    // Формирование движений по табличной части
    Для Каждого СтрокаОстатка Из Остатки Цикл
        
		//// Проверка заполнения обязательных полей
		//Если Не ЗначениеЗаполнено(СтрокаОстатка.ФинАгент) Тогда
		//    Сообщить("В строке " + СтрокаОстатка.НомерСтроки + " не заполнен ФинАгент!");
		//    Отказ = Истина;
		//    Продолжить;
		//КонецЕсли;
		//
		//Если Не ЗначениеЗаполнено(СтрокаОстатка.Направление) Тогда
		//    Сообщить("В строке " + СтрокаОстатка.НомерСтроки + " не заполнено Направление!");
		//    Отказ = Истина;
		//    Продолжить;
		//КонецЕсли;
		//
		//Если СтрокаОстатка.Сумма = 0 Тогда
		//    Сообщить("В строке " + СтрокаОстатка.НомерСтроки + " указана нулевая сумма!");
		//    Отказ = Истина;
		//    Продолжить;
		//КонецЕсли;
        
        // Создаем движение
        Движение = Движения.ДенежныеСредстваФинАгенты.Добавить();
        Движение.Период = Дата;
        Движение.ФинАгент = СтрокаОстатка.ФинАгент;
        Движение.Направление = СтрокаОстатка.Направление;
        
        // Определяем вид движения, сумму и ДокументПередачи
        Если СтрокаОстатка.Сумма > 0 Тогда
            Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
            Движение.Сумма = СтрокаОстатка.Сумма;
            Движение.ДокументПередачи = ЭтотОбъект.Ссылка; // Ссылка на текущий документ
        Иначе
            Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
            Движение.Сумма = -СтрокаОстатка.Сумма; // Сумма в регистре всегда положительная
           // Движение.ДокументПередачи = Документы.ВводОстатковФинАгентов.ПустаяСсылка(); // Пустой для расхода
        КонецЕсли;
        
    КонецЦикла;
    
    // Проверка заполнения табличной части
    Если Остатки.Количество() = 0 Тогда
        Сообщить("Не заполнена табличная часть Остатки!");
        Отказ = Истина;
    КонецЕсли;
    
    // Проверка дублирования строк
    ТаблицаПроверки = Остатки.Выгрузить(, "ФинАгент, Направление");
    ТаблицаПроверки.Свернуть("ФинАгент, Направление", "");
    Если ТаблицаПроверки.Количество() < Остатки.Количество() Тогда
        Сообщить("В табличной части присутствуют дублирующиеся строки по ФинАгенту и Направлению!");
        Отказ = Истина;
    КонецЕсли;
    
КонецПроцедуры