Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	//Тютюн
	Отказ = ПроверитьЛимит();
	Если Не Отказ Тогда 
		
		// регистр ДенежныеСредства Приход
		Движения.ДенежныеСредства.Записывать = Истина;
		Движение 				= Движения.ДенежныеСредства.Добавить();
		Движение.ВидДвижения 	= ВидДвиженияНакопления.Приход;
		Движение.Период 		= Дата;
		Движение.БанковскийСчетКасса=Касса;
		Движение.ВидДенежныхСредств=Перечисления.ВидыДенежныхСредств.Наличные;
		Движение.Организация 	= Организация;
		Движение.Сумма			=СуммаДокумента;
		
		Движения.БДДС.ВыполнитьДвижение(ЭтотОбъект);
		
		Если ВидОперации=Перечисления.ВидыОперацийПКО.ПоступлениеСРасчетногоСчета Тогда
			Движения.ДенежныеСредстваВПути.ВыполнитьРасход(ЭтотОбъект);
		КонецЕсли;
		
		ДвиженияФИнАгент(Отказ);
	КонецЕсли;
КонецПроцедуры   

//Тютюн проверить лимит 
Функция ПроверитьЛимит() 
	Отказ = Ложь;
	Если Касса._Лимит>0 Тогда  
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДенежныеСредстваОстатки.СуммаОстаток
		|ИЗ
		|	РегистрНакопления.ДенежныеСредства.Остатки(&ДатаДокумента, БанковскийСчетКасса = &Касса) КАК ДенежныеСредстваОстатки";
		
		Запрос.УстановитьПараметр("ДатаДокумента", Дата); 
		Запрос.УстановитьПараметр("Касса", Касса);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Остаток = 0;
		Если Выборка.Следующий() Тогда 
			Остаток = Выборка.СуммаОстаток;
		КонецЕсли;    
		
		СуммаПревышения = СуммаДокумента + Остаток - Касса._Лимит;
		
		Если СуммаПревышения > 0 Тогда  
			Отказ = Истина; 
			Сообщить("Превышен лимит кассы на " + СуммаПревышения + " " + ВалютаДокумента );
		КонецЕсли;
		
	КонецЕсли;   
	
	Возврат Отказ
КонецФункции

Процедура ДвиженияФИнАгент(Отказ)
	
	НаборЗаписейДСКасса = РегистрыНакопления.ДСКасса.СоздатьНаборЗаписей();
	НаборЗаписейДСКасса.Отбор.Регистратор.Установить(ЭтотОбъект.Ссылка);   
	ДатаНачалаДС = Константы.ДатаНачалаУчетаСтоимостиНаличных.Получить();
	 

	
	Если СтатьяДвиженияДенежныхСредств = Справочники.СтатьиДвиженияДенежныхСредств.НайтиПоКоду("УТ-001082") Тогда 
		
		// Получаем остаток по финансовому агенту
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|    ДенежныеСредстваФинАгентыОстатки.ДокументПередачи КАК ДокументПередачи,
		|    ДенежныеСредстваФинАгентыОстатки.СуммаОстаток КАК СуммаОстаток
		|ИЗ
		|    РегистрНакопления.ДенежныеСредстваФинАгенты.Остатки(
		|            &МоментВремени,
		|            ФинАгент = &ФинАгент
		|            И Направление = &Направление) КАК ДенежныеСредстваФинАгентыОстатки
		|ГДЕ
		|    ДенежныеСредстваФинАгентыОстатки.СуммаОстаток > 0
		|УПОРЯДОЧИТЬ ПО
		|    ДокументПередачи.Дата";
		
		Запрос.УстановитьПараметр("МоментВремени", ЭтотОбъект.МоментВремени());
		Запрос.УстановитьПараметр("ФинАгент", ЭтотОбъект._ФинАгент);
		Запрос.УстановитьПараметр("Направление", ЭтотОбъект.Направление); // Берем из реквизита документа
		
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		ОстатокСписания = ЭтотОбъект.СуммаДокумента; // Сумма, которую нужно списать
		
		// Проверяем достаточность остатка
		//ЗапросОстаток = Новый Запрос;
		//ЗапросОстаток.Текст = 
		//"ВЫБРАТЬ
		//|    ДенежныеСредстваФинАгентыОстатки.ДокументПередачи КАК ДокументПередачи,
		//|    ДенежныеСредстваФинАгентыОстатки.СуммаОстаток КАК СуммаОстаток
		//|ИЗ
		//|    РегистрНакопления.ДенежныеСредстваФинАгенты.Остатки(
		//|            &МоментВремени,
		//|            ФинАгент = &ФинАгент
		//|            И Направление = &Направление) КАК ДенежныеСредстваФинАгентыОстатки
		//|ГДЕ
		//|    ДенежныеСредстваФинАгентыОстатки.СуммаОстаток > 0
		//|УПОРЯДОЧИТЬ ПО
		//|    ДокументПередачи.Дата";
		//
		//ЗапросОстаток.УстановитьПараметр("МоментВремени", ЭтотОбъект.МоментВремени());
		//ЗапросОстаток.УстановитьПараметр("ФинАгент", ЭтотОбъект._ФинАгент);
		//ЗапросОстаток.УстановитьПараметр("Направление", ЭтотОбъект.Направление); // Берем из реквизита документа
		//
		//ВыборкаОстаток = ЗапросОстаток.Выполнить().Выбрать();
		//Если ВыборкаОстаток.Следующий() Тогда
		//	Если ВыборкаОстаток.СуммаОстаток < ЭтотОбъект.СуммаДокумента Тогда 
		//		Если _ПроцентФинАгента = 0 Тогда 
		//			Сообщить("Не хватает остатка ДС у Фин агента, укажите % фин агента");
		//			Отказ = Истина; 
		//		КонецЕсли;
		//	КонецЕсли;
		//Иначе  
		//	Если _ПроцентФинАгента = 0 Тогда
		//		Отказ = Истина;
		//		Сообщить("Не хватает остатка ДС у Фин агента, укажите % фин агента");  
		//	КонецЕсли;
		//КонецЕсли;
		
		НаборЗаписей = РегистрыНакопления.ДенежныеСредстваФинАгенты.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ЭтотОбъект.Ссылка); 
		
		Пока Выборка.Следующий() И ОстатокСписания > 0 Цикл
			
			СуммаСписания = Мин(ОстатокСписания, Выборка.СуммаОстаток);
			
			Если СуммаСписания > 0 Тогда
				// Добавляем запись расхода
				Запись = НаборЗаписей.Добавить();
				Запись.Период = ЭтотОбъект.Дата;
				Запись.Регистратор = ЭтотОбъект.Ссылка;
				Запись.ВидДвижения = ВидДвиженияНакопления.Расход;
				Запись.ФинАгент = ЭтотОбъект._ФинАгент;
				Запись.Направление = ЭтотОбъект.Направление; // Добавляем новое измерение
				Запись.ДокументПередачи = Выборка.ДокументПередачи;
				Запись.Сумма = СуммаСписания;  
				
				//Добавим запись в ДСКасса    
				Если ЗначениеЗаполнено(ДатаНачалаДС) И Дата >= ДатаНачалаДС Тогда
				Запись = НаборЗаписейДСКасса.Добавить();
				Запись.Период = ЭтотОбъект.Дата;
				Запись.Регистратор = ЭтотОбъект.Ссылка;
				Запись.ВидДвижения = ВидДвиженияНакопления.Приход;
				Запись.Касса = ЭтотОбъект.Касса;
				Запись.ДокументПередачи = Выборка.ДокументПередачи;
				Запись.Сумма = СуммаСписания; 
				Попытка
					Процент = Выборка.ДокументПередачи._ПроцентФинАгента/100; 
				Исключение
					Процент =0;
				КонецПопытки;
				Запись.СуммаКомиссииФА = (СуммаСписания *Процент)  /  (1 - Процент);  
				КонецЕсли;
				//************************
				
				ОстатокСписания = ОстатокСписания - СуммаСписания;
			КонецЕсли;
			
		КонецЦикла; 
		
		Если ОстатокСписания > 0 Тогда  
			Запись = НаборЗаписей.Добавить();
			Запись.Период = ЭтотОбъект.Дата;
			Запись.Регистратор = ЭтотОбъект.Ссылка;
			Запись.ВидДвижения = ВидДвиженияНакопления.Расход;
			Запись.ФинАгент = ЭтотОбъект._ФинАгент;
			Запись.Направление = ЭтотОбъект.Направление; // Добавляем новое измерение
			Запись.Сумма = ОстатокСписания;     
			
			
			Если _ПроцентФинАгента = 0 Тогда
					Отказ = Истина;
					Сообщить("Не хватает остатка ДС у Фин агента, укажите % фин агента");  
			КонецЕсли;

			//Добавим запись в ДСКасса  
			Если НЕ Отказ И ЗначениеЗаполнено(ДатаНачалаДС) И Дата >= ДатаНачалаДС Тогда
            Запись = НаборЗаписейДСКасса.Добавить();
			Запись.Период = ЭтотОбъект.Дата;
			Запись.Регистратор = ЭтотОбъект.Ссылка;
			Запись.ВидДвижения = ВидДвиженияНакопления.Приход;
			Запись.Касса = ЭтотОбъект.Касса;
			Запись.ДокументПередачи = ЭтотОбъект.Ссылка;
			Запись.Сумма = СуммаСписания;  
			Процент = _ПроцентФинАгента/100;
			Запись.СуммаКомиссииФА = (СуммаСписания *Процент)  /  (1 - Процент);
            КонецЕсли;
			//************************
		КонецЕсли;
		
		НаборЗаписей.Записать(); 
		НаборЗаписейДСКасса.Записать();  
		
	Иначе   
		Если ЗначениеЗаполнено(ДатаНачалаДС) И Дата >= ДатаНачалаДС Тогда
        Если ВидОперации = Перечисления.ВидыОперацийПКО.ПеремещениеДС И Значениезаполнено(Основание) Тогда
			Если ТипЗнч(Основание) = Тип("ДокументСсылка.РасходныйКассовыйОрдер") И Основание.Проведен Тогда  
				
				Запрос = Новый Запрос;
				Запрос.Текст = 
				"ВЫБРАТЬ
				|	ВЫБОР
				|		КОГДА ДСКассаОбороты.СуммаРасход <> 0
				|			ТОГДА ДСКассаОбороты.СуммаКомиссииФАРасход / ДСКассаОбороты.СуммаРасход
				|	КОНЕЦ КАК ПроцентКомиссии,
				|	ДСКассаОбороты.СуммаКомиссииФАРасход
				|ИЗ
				|	РегистрНакопления.ДСКасса.Обороты(, , Регистратор, ) КАК ДСКассаОбороты
				|ГДЕ
				|	ДСКассаОбороты.Регистратор = &РКО";
				
				Запрос.УстановитьПараметр("РКО", Основание);
				
				РезультатРКО = Запрос.Выполнить();
				
				ВыборкаРКО = Запрос.Выполнить().Выбрать();
				
				Если ВыборкаРКО.Следующий() Тогда 
					ПроцентКомиссии =  ВыборкаРКО.ПроцентКомиссии ;
				Иначе 
					ПроцентКомиссии = 0;
				КонецЕсли;    
				
				Запись = НаборЗаписейДСКасса.Добавить();
				Запись.Период = ЭтотОбъект.Дата;
				Запись.Регистратор = ЭтотОбъект.Ссылка;
				Запись.ВидДвижения = ВидДвиженияНакопления.Приход;
				Запись.Касса = ЭтотОбъект.Касса;
				Запись.ДокументПередачи = ЭтотОбъект.Ссылка;
				Запись.Сумма = СуммаДокумента;  
				Запись.СуммаКомиссииФА = СуммаДокумента * ПроцентКомиссии ; 
				НаборЗаписейДСКасса.Записать(); 
				
			Иначе
				Отказ = Истина;
				Сообщить("Укажите в основании проведенный документ РКО");
			КонецЕсли;
		Иначе 
			//Добавим запись в ДСКасса   
			Запись = НаборЗаписейДСКасса.Добавить();
			Запись.Период = ЭтотОбъект.Дата;
			Запись.Регистратор = ЭтотОбъект.Ссылка;
			Запись.ВидДвижения = ВидДвиженияНакопления.Приход;
			Запись.Касса = ЭтотОбъект.Касса;
			Запись.ДокументПередачи = ЭтотОбъект.Ссылка;
			Запись.Сумма = СуммаДокумента;  
			Запись.СуммаКомиссииФА = 0 ;  
			НаборЗаписейДСКасса.Записать(); 
			//************************
			
		КонецЕсли; 
		КонецЕсли;
		
	КонецЕсли;   
	
	    Если НЕ Отказ И ЗначениеЗаполнено(ДатаНачалаДС) И Дата >= ДатаНачалаДС Тогда 
			ДопМодуль.ОбновитьПоследовательностьКассы(Ссылка);
		КонецЕсли;
	
	
КонецПроцедуры   

Процедура ОбработкаУдаленияПроведения(Отказ) 

	ДатаНачалаДС = Константы.ДатаНачалаУчетаСтоимостиНаличных.Получить();

	Если ЗначениеЗаполнено(ДатаНачалаДС) И Дата >= ДатаНачалаДС Тогда 
		ДопМодуль.ОбновитьПоследовательностьКассы(Ссылка);
	КонецЕсли; 
КонецПроцедуры
//КонецИзменений

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Ответственный= Пользователи.ТекущийПользователь();
	ВалютаДокумента = Константы.ВалютаРегламентированногоУчета.Получить();
	Если ТипЗнч(ДанныеЗаполнения)=Тип("ДокументСсылка.ЗаявкаНаРасходованиеДенежныхСредств") Тогда
		ЗаполнитьЗначенияСвойств(ЭтотОбъект, ДанныеЗаполнения);
		ЭтотОбъект.Основание = ДанныеЗаполнения;   
		 //Тютюн
		Если ЗначениеЗаполнено(ДанныеЗаполнения.СчетНаОплатуПоставщика) Тогда  
			Если  ДанныеЗаполнения.СчетНаОплатуПоставщика.ВидОперации = Перечисления.ВидыОперацийСчетНаОплатуПоставщику.Перемещение Тогда 
				ВидОперации = Перечисления.ВидыОперацийПКО.ПеремещениеДС;
				Касса           =  ДанныеЗаполнения.СчетНаОплатуПоставщика._КассаПолучатель; 
				КассаОтправитель =    ДанныеЗаполнения.СчетНаОплатуПоставщика._Касса;
//				СтатьяЗатрат    =  ДанныеЗаполнения.СчетНаОплатуПоставщика.СтатьяЗатрат;
			КонецЕсли;
		КонецЕсли;
        //КонецИзменений
		
	ИначеЕсли ТипЗнч(ДанныеЗаполнения)=Тип("ДокументСсылка.РасходныйКассовыйОрдер") Тогда
		ЗаполнитьЗначенияСвойств(ЭтотОбъект, ДанныеЗаполнения);
		ЭтотОбъект.Основание = ДанныеЗаполнения;
		
		Если ДанныеЗаполнения.ВидОперации = Перечисления.ВидыОперацийРКО.ПеремещениеДС Тогда
			ВидОперации= Перечисления.ВидыОперацийПКО.ПеремещениеДС;
		Иначе	
			ВидОперации= Перечисления.ВидыОперацийПКО.ПриходДенежныхСредствПрочее;
		КонецЕсли;
		
		
		Подразделение= ДанныеЗаполнения.КассаПолучатель.Владелец;
		Касса=ДанныеЗаполнения.КассаПолучатель;
		КассаОтправитель=ДанныеЗаполнения.Касса;
		//Касса=ДанныеЗаполнения.КассаПолучатель 
		Дата= ТекущаяДата();
		Ответственный= ПараметрыСеанса.ТекущийПользователь;
		Комментарий="";
		Номер="";
		УстановитьНовыйНомер();
	КонецЕсли; 
	
КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	
	Если ВидОперации=Перечисления.ВидыОперацийПКО.ПоступлениеСРасчетногоСчета Тогда
		ПроверяемыеРеквизиты.Добавить("Касса");
		ПроверяемыеРеквизиты.Добавить("Контрагент");
		ПроверяемыеРеквизиты.Добавить("СуммаДокумента");
	ИначеЕсли ВидОперации=Перечисления.ВидыОперацийПКО.ПеремещениеДС Тогда
		ПроверяемыеРеквизиты.Добавить("КассаОтправитель");
	КонецЕсли;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Если ВидОперации = Перечисления.ВидыОперацийПКО.ПеремещениеДС И Значениезаполнено(Основание) Тогда
		Если ТипЗнч(Основание) = Тип("ДокументСсылка.РасходныйКассовыйОрдер") Тогда 
			Если Дата<= Основание.Дата Тогда 
				Если Формат(Дата,"ДФ=dd.MM.yyyy") = Формат(Основание.Дата,"ДФ=dd.MM.yyyy")   Тогда
					Дата = Основание.Дата+1;
				Иначе
					Отказ = Истина;
					Сообщить("Дата документа должна быть больше даты РКО");
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры
