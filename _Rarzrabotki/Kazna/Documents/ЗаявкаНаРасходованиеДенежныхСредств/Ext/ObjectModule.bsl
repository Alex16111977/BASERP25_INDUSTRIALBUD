Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	//По бюджетам, помесячно
	Ответ = ПроверитьНаСоответствиеЛимитов();
	Если НЕ Ответ.Результат Тогда
		//МожноПревышатьЛимит,СуммаПревышения
		Если Ответ.МожноПревышатьЛимит Тогда
			локОтказ= Ложь;
			//**ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Ответ.ТекстОшибки, Ссылка, , , локОтказ);
		Иначе	
			//**ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Ответ.ТекстОшибки, Ссылка, , , Отказ);
		КонецЕсли;
	КонецЕсли;	
	
	//По лимитам, с вторника по понедельник  по статьяим ддс
	Ответ = ПроверитьНаСоответствиеЛимитовОригинал();
	Если НЕ Ответ.Результат Тогда
		//МожноПревышатьЛимит,СуммаПревышения
		Если Ответ.МожноПревышатьЛимит Тогда
			локОтказ= Ложь;
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Ответ.ТекстОшибки, Ссылка, , , локОтказ);
		Иначе	
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Ответ.ТекстОшибки, Ссылка, , , Отказ);
		КонецЕсли;
	КонецЕсли;	
	
	
	
	// регистр СчетаПоставщиков Приход
	Движения.СчетаПоставщиков.Записывать = Истина;
	Если ЗначениеЗаполнено(СчетНаОплатуПоставщика) И ТипЗнч(СчетНаОплатуПоставщика) = Тип("ДокументСсылка.СчетНаОплатуПоставщика") Тогда
		Движение 				= Движения.СчетаПоставщиков.Добавить();
		Движение.ВидДвижения 	= ВидДвиженияНакопления.Расход;
		Движение.Период 		= Дата;
		Движение.СчетНаОплатуПоставщика = СчетНаОплатуПоставщика;
		Движение.Сумма 			= СуммаДокумента;
		Движение.НаОплату 		= 0;
		
		Движение 				= Движения.СчетаПоставщиков.Добавить();
		Движение.ВидДвижения 	= ВидДвиженияНакопления.Приход;
		Движение.Период 		= Дата;
		Движение.СчетНаОплатуПоставщика = СчетНаОплатуПоставщика;
		Движение.НаОплату 		= СуммаДокумента;
		Движение.Сумма			= 0;
		
		
	КонецЕсли;
	Движения.ЗаявкиНаРасходованиеДС.Записывать = Истина;
	Движение 				= Движения.ЗаявкиНаРасходованиеДС.Добавить();
	Движение.ВидДвижения 	= ВидДвиженияНакопления.Приход;
	Движение.Период 		= Дата;
	Движение.ЗаявкаНаРасходованиеДС = Ссылка;
	Движение.Сумма			= СуммаДокумента;
	
	Если Движения.ЛимитыДДС.НадоСписыватьЛимиты(ЭтотОбъект) Тогда
		Движения.ЛимитыДДС.ВыполнитьРасход(ЭтотОбъект);
	КонецЕсли; 
	
	
	//++ Бахтишаев А.Э. , 09/11/16 06:15,393
	// Т.к. в 1С неленивое "И", делаем вложенным условием
	Если ЗначениеЗаполнено(СчетНаОплатуПоставщика) Тогда
		Если Константы.ДатаНачалаРаботыПоНовойСхемеТранзитаДС.Получить() <= Дата И СчетНаОплатуПоставщика.ВидОплаты = Перечисления.ВидыДенежныхСредств.Наличные Тогда
			Движения.СчетаНал.ВыполнитьПриходДляПодчиненного(ЭтотОбъект);
		КонецЕсли;
	КонецЕсли;
	//-- Бахтишаев А.Э. , 09/11/16 06:16
	
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Ответственный = Пользователи.ТекущийПользователь();
	Подразделение = Ответственный.Подразделение;
	
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.СчетНаОплатуПоставщика") Тогда
		// Заполнение шапки
		ВалютаДокумента 	= ДанныеЗаполнения.ВалютаДокумента;
		ВидОплаты 			= ДанныеЗаполнения.ВидОплаты;
		Комментарий 		= ДанныеЗаполнения.Комментарий;
		Контрагент 			= ДанныеЗаполнения.Контрагент;
		НазначениеПлатежа 	= ДанныеЗаполнения.НазначениеПлатежа;
		Организация 		= ДанныеЗаполнения.Организация;
		//Ответственный 	= ДанныеЗаполнения.Ответственный;
		ПлановаяДатаОплаты	= ДанныеЗаполнения.ПлановаяДатаОплаты;
		Подразделение		= ДанныеЗаполнения.Подразделение;
		СчетНаОплатуПоставщика = ДанныеЗаполнения.Ссылка;
		СтатьяДвиженияДенежныхСредств = ДанныеЗаполнения.СтатьяДвиженияДенежныхСредств;
		СуммаДокумента		= ДанныеЗаполнения.СуммаДокумента; 
		СчетКонтрагента		= ДанныеЗаполнения.СчетКонтрагента;
		ДокументОснование	= ДанныеЗаполнения;
		СчетНаОплатуПоставщика =  ДанныеЗаполнения;
		Секция				= ДанныеЗаполнения.Секция;   
		//Тютюн    
		
		Если ДанныеЗаполнения.СтатьяДвиженияДенежныхСредств = Справочники.СтатьиДвиженияДенежныхСредств.НайтиПоКоду("УТ-001096") ТОгда 
			_ФинАгент              = ДанныеЗаполнения._ФинАгент;  
			_ПроцентФинАгента      = ДанныеЗаполнения._ПроцентФинАгента;
			_ДатаВозвратаФинАгента = ДанныеЗаполнения._ДатаВозвратаФинАгента;
		КонецЕсли;
		
		лЗапрос = Новый Запрос(
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ЕСТЬNULL(Т_ОстатокСчета.СуммаОстаток, 0) КАК Сумма_Счет,
		|	ЕСТЬNULL(Т_Лимиты.СуммаОстаток, 0) КАК Сумма_Лимит,
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(Т_ОстатокСчета.СуммаОстаток, 0) > ЕСТЬNULL(Т_Лимиты.СуммаОстаток, 0)
		|			ТОГДА ЕСТЬNULL(Т_Лимиты.СуммаОстаток, 0)
		|		ИНАЧЕ ЕСТЬNULL(Т_ОстатокСчета.СуммаОстаток, 0)
		|	КОНЕЦ КАК Сумма
		|ИЗ
		|	РегистрНакопления.СчетаПоставщиков.Остатки(, СчетНаОплатуПоставщика = &СчетНаОплатуПоставщика) КАК Т_ОстатокСчета,
		|	РегистрНакопления.ЛимитыДДС.Остатки(, Подразделение = &Подразделение) КАК Т_Лимиты");
		лЗапрос.УстановитьПараметр("СчетНаОплатуПоставщика",  	ДанныеЗаполнения);
		лЗапрос.УстановитьПараметр("Подразделение", 			Подразделение);
		лВыборка = лЗапрос.Выполнить().Выбрать();
		
		//2016/06 Сава: Отключаем лимиты (причина - сейчас схема: Утвердили = оплатили);
		лДата = Константы.Лимиты_ДатаНачалаИспользования.Получить();
		
		Если ДанныеЗаполнения.ВидОперации<>Перечисления.ВидыОперацийСчетНаОплатуПоставщику.Транзит
			И ЗначениеЗаполнено(лДата) И лДата <= ?(ЗначениеЗаполнено(Дата), Дата, ТекущаяДата() ) Тогда 
			СуммаДокумента = ?(лВыборка.Следующий(), лВыборка.Сумма , 0);
		Иначе
			СуммаДокумента = ?(лВыборка.Следующий(), лВыборка.Сумма_Счет, 0);
		КонецЕсли;
		
		
		//80\20                   
		
		Если ДанныеЗаполнения.СтавкаНДС=Перечисления.СтавкиНДС.НДС20  И Константы.ИспользоватьПроверку80_20.Получить() Тогда
			Если РегистрыСведений.ОтметкиРегистрацииНН.ННЗарегистирована(ДанныеЗаполнения) Тогда
			    //Сумму не режем
			Иначе	
			   СуммаДокумента= Окр(СуммаДокумента*0.8,2);
			   Сообщить("Документ "+ДанныеЗаполнения+", оплата 80% от суммы документа",СтатусСообщения.ОченьВажное);
			КонецЕсли;
		КонецЕсли;

		
		Если ДанныеЗаполнения.ВидОплаты = Перечисления.ВидыДенежныхСредств.Безналичные Тогда
			Если ТипЗнч(ДокументОснование.Секция)=Тип("СправочникСсылка.Секции")
				И ЗначениеЗаполнено(ДокументОснование.Секция.ОсновнойБанковскийСчет) Тогда
				СтруктурнаяЕдиница = ДокументОснование.Секция.ОсновнойБанковскийСчет;
			Иначе
				СтруктурнаяЕдиница = Организация.ОсновнойБанковскийСчет;				
			КонецЕсли;
		Иначе
			СтруктурнаяЕдиница = Организация.ОсновнаяКасса;
		КонецЕсли;
		
		//Тютюн         
		Если ДанныеЗаполнения.ВидОперации = Перечисления.ВидыОперацийСчетНаОплатуПоставщику.Перемещение Тогда  
			СтруктурнаяЕдиница = ДанныеЗаполнения._Касса ;
		КонецЕсли;
		//КонецИзменений
		
	КонецЕсли;
	
КонецПроцедуры

Функция ПроверитьНаСоответствиеЛимитовОригинал()Экспорт
	
	//++ Павел Чистяков 24.05.2016 14:02:59 
	Если Не Движения.ЛимитыДДС.НадоСписыватьЛимиты(ЭтотОбъект) Тогда
		Возврат Новый Структура("Результат,ТекстОшибки",Истина,"");
	КонецЕсли;
	
	СтруктураОтвета = Новый Структура("Результат,ТекстОшибки,МожноПревышатьЛимит",Ложь,"",Ложь);
	//СтруктураОтвета.МожноПревышатьЛимит=РольДоступна("ПолныеПрава") ИЛИ РольДоступна("ПолныеПрава");
	СтруктураОтвета.МожноПревышатьЛимит=ЛОЖЬ;;
	
	Запрос = Новый Запрос;
	Запрос.Текст=  "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	               |	СУММА(ЛимитыДДСОбороты.СуммаПриход - ЛимитыДДСОбороты.СуммаРасход) КАК Лимит_СуммаОстаток
	               |ПОМЕСТИТЬ НужныеЛимиты
	               |ИЗ
	               |	РегистрНакопления.ЛимитыДДС.Обороты(
	               |			&НачДата,
	               |			&КонДата,
	               |			,
	               |			ВидОплаты = &ВидОплаты
	               |				И Подразделение = &Подразделение И Направление = &Направление 
	               //**|				И СтатьяДвиженияДенежныхСредств = &СтатьяДвиженияДенежныхСредств
				   |) КАК ЛимитыДДСОбороты
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ЕСТЬNULL(СчетаПоставщиковОстатки.СуммаОстаток, 0) КАК Счет_СуммаОстаток,
	               |	ЕСТЬNULL(НужныеЛимиты.Лимит_СуммаОстаток,0) Как  Лимит_СуммаОстаток
	               |ИЗ
	               |	РегистрНакопления.СчетаПоставщиков.Остатки(, СчетНаОплатуПоставщика = &СчетНаОплатуПоставщика) КАК СчетаПоставщиковОстатки,
	               |	НужныеЛимиты КАК НужныеЛимиты"  ;
				   
				   
	Если ЗначениеЗаполнено(СчетНаОплатуПоставщика.Направление) Тогда
		локНаправление = СчетНаОплатуПоставщика.Направление;
	Иначе
		локНаправление=Справочники.Направления.ПустаяСсылка();
	КонецЕсли;			   
	
	Если локНаправление.ЛимитВЦеломПоНаправлению Тогда
	    Запрос.Текст=СтрЗаменить(Запрос.Текст,"И Подразделение = &Подразделение","");
	КонецЕсли;
	ЗАпрос.УстановитьПараметр("Направление",			локНаправление);
	//Вторник - понедельник
	ТекДень=ДеньНедели(Дата);
	Если ТекДень=1 Тогда
		НачДата =Дата-60*60*24*6; 
		КонДата=Дата;
	Иначе
		НачДата=НачалоНедели(Дата)+ 60*60*24*1;
		КонДата=КонецНедели(Дата)+ 60*60*24*1;
	КонецЕсли;
	
	ЗАпрос.УстановитьПараметр("НачДата",				НачалоДня(НачДата));
	ЗАпрос.УстановитьПараметр("КонДата",				КонецДня(КонДата));
	ЗАпрос.УстановитьПараметр("Организация",			Организация);
	ЗАпрос.УстановитьПараметр("Подразделение",			Подразделение);
	ЗАпрос.УстановитьПараметр("ВидОплаты",				ВидОплаты);
	ЗАпрос.УстановитьПараметр("СчетНаОплатуПоставщика", ДокументОснование);
	ЗАпрос.УстановитьПараметр("СтатьяДвиженияДенежныхСредств",СтатьяДвиженияДенежныхСредств);
	ЗАпрос.УстановитьПараметр("ВидОплаты",ВидОплаты);
	ЗАпрос.УстановитьПараметр("СтатьяДвиженияДенежныхСредств",СтатьяДвиженияДенежныхСредств);
	
	Выборка = запрос.Выполнить().Выбрать();
	
	//Сава: 2016/05 - на перспективу, если нет счета
	Если ЗначениеЗаполнено(ДокументОснование) И ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.СчетНаОплатуПоставщика") Тогда 
		Если Выборка.Следующий() Тогда
			Если 	Выборка.Лимит_СуммаОстаток>=СуммаДокумента 
				И	Выборка.Счет_СуммаОстаток >=СуммаДокумента	Тогда
				СтруктураОтвета.Результат=Истина;
			Иначе
				СтруктураОтвета.ТекстОшибки="Проверка 3. "+
				?(Выборка.Лимит_СуммаОстаток>=СуммаДокумента, "",  " Превышен лимит расхода на "+(-Выборка.Лимит_СуммаОстаток+СуммаДокумента))
				+?(Выборка.Счет_СуммаОстаток >=СуммаДокумента, "",  ", Превышена сумма по счету на "+(-Выборка.Счет_СуммаОстаток+СуммаДокумента)); 
				СтруктураОтвета.ТекстОшибки = СокрЛП(Сред(СтруктураОтвета.ТекстОшибки, 2) );
			КонецЕсли;
		Иначе	
			СтруктураОтвета.ТекстОшибки="Проверка 3. "+"Превышен лимит расхода и сумма по счету на "+СуммаДокумента ;
		КонецЕсли;
	Иначе 
		Если Выборка.Следующий() Тогда
			Если 	Выборка.Лимит_СуммаОстаток>=СуммаДокумента Тогда
				СтруктураОтвета.Результат=Истина;
			Иначе
				СтруктураОтвета.ТекстОшибки="Проверка 3. "+
				?(Выборка.Лимит_СуммаОстаток>=СуммаДокумента, "",  " Превышен лимит расхода на "+(-Выборка.Лимит_СуммаОстаток+СуммаДокумента));
			КонецЕсли;
		Иначе	
			СтруктураОтвета.ТекстОшибки="Проверка 3. "+"Превышен лимит расхода на "+СуммаДокумента ;
		КонецЕсли;	 
	КонецЕсли;
	
	Возврат СтруктураОтвета;
	
КонецФункции



Функция ПроверитьНаСоответствиеЛимитов()Экспорт
	
	////++ Павел Чистяков 24.05.2016 14:02:59 
	//Если Не Движения.ЛимитыДДС.НадоСписыватьЛимиты(ЭтотОбъект) Тогда
	//	Возврат Новый Структура("Результат,ТекстОшибки",Истина,"");
	//КонецЕсли;
	
	СтруктураОтвета = Новый Структура("Результат,ТекстОшибки,МожноПревышатьЛимит,СуммаПревышения",Ложь,"",Ложь,0);
	//СтруктураОтвета = Новый Структура("Результат,ТекстОшибки",Истина,"");
	//Возврат СтруктураОтвета ; 
	
	СтруктураОтвета.МожноПревышатьЛимит=РольДоступна("ПолныеПрава") ИЛИ РольДоступна("ПолныеПрава");
	//СтруктураОтвета.МожноПревышатьЛимит=Ложь;
	
	Запрос = Новый Запрос;
	Запрос.Текст=  "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	БюджетыНаМесяцОбороты.СуммаОборот
	|ПОМЕСТИТЬ Запланировано
	|ИЗ
	|	РегистрНакопления.БюджетыНаМесяц.Обороты(
	|			&НачДата,
	|			&КонДата,
	|			,
	|			Подразделение = &Подразделение
	|				И ПоказательБюджета = &СтатьяДвиженияДенежныхСредств
	|				И ВидПериода <> &ВидПериодаОбъект
	|				И ВидОплаты = &ВидОплаты) КАК БюджетыНаМесяцОбороты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	БДДСОбороты.СуммаОборот
	|ПОМЕСТИТЬ Потрачено
	|ИЗ
	|	РегистрНакопления.БДДС.Обороты(
	|			&НачДата,
	|			&КонДата,
	|			,
	|			Подразделение = &Подразделение
	|				И ВидОплаты = &ВидОплаты
	|				И СтатьяДвиженияДенежныхСредств = &СтатьяДвиженияДенежныхСредств) КАК БДДСОбороты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(Запланировано.СуммаОборот, 0) - ЕСТЬNULL(Потрачено.СуммаОборот, 0) КАК СуммаОстаток
	|ИЗ
	|	Запланировано КАК Запланировано,
	|	Потрачено КАК Потрачено";
	
	
	ЗАпрос.УстановитьПараметр("НачДата",				НачалоМесяца(Дата));
	ЗАпрос.УстановитьПараметр("КонДата",				КонецМесяца(Дата));
	
	ЗАпрос.УстановитьПараметр("Организация",			Организация);
	ЗАпрос.УстановитьПараметр("Подразделение",			Подразделение);
	ЗАпрос.УстановитьПараметр("ВидОплаты",				ВидОплаты);
	ЗАпрос.УстановитьПараметр("ВидПериодаОбъект",				Перечисления.ВидыПериодовБюджетирования.Объект);
	ЗАпрос.УстановитьПараметр("СтатьяДвиженияДенежныхСредств",СтатьяДвиженияДенежныхСредств);
	
	Выборка = запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Если Выборка.СуммаОстаток >=СуммаДокумента Тогда
			СтруктураОтвета.Результат=Истина;
		Иначе	
			СтруктураОтвета.СуммаПревышения=  (-Выборка.СуммаОстаток+СуммаДокумента);
			СтруктураОтвета.ТекстОшибки="Проверка 2. Превышен лимит расхода на "+(-Выборка.СуммаОстаток+СуммаДокумента);
			
		КонецЕсли;
	Иначе
		СтруктураОтвета.СуммаПревышения=  (СуммаДокумента);
		СтруктураОтвета.ТекстОшибки="Проверка 2. Превышен лимит расхода на "+(СуммаДокумента);
	КонецЕсли;
	
	////Сава: 2016/05 - на перспективу, если нет счета
	//Если ЗначениеЗаполнено(ДокументОснование) И ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.СчетНаОплатуПоставщика") Тогда 
	//	Если Выборка.Следующий() Тогда
	//		Если 	Выборка.Лимит_СуммаОстаток>=СуммаДокумента 
	//			И	Выборка.Счет_СуммаОстаток >=СуммаДокумента	Тогда
	//			СтруктураОтвета.Результат=Истина;
	//		 Иначе
	//		 	СтруктураОтвета.ТекстОшибки=
	//				?(Выборка.Лимит_СуммаОстаток>=СуммаДокумента, "",  " Превышен лимит расхода на "+(-Выборка.Лимит_СуммаОстаток+СуммаДокумента))
	//			   +?(Выборка.Счет_СуммаОстаток >=СуммаДокумента, "",  ", Превышена сумма по счету на "+(-Выборка.Счет_СуммаОстаток+СуммаДокумента)); 
	//			СтруктураОтвета.ТекстОшибки = СокрЛП(Сред(СтруктураОтвета.ТекстОшибки, 2) );
	//		 КонецЕсли;
	//	Иначе	
	//		 СтруктураОтвета.ТекстОшибки="Превышен лимит расхода и сумма по счету на "+СуммаДокумента ;
	//	 КонецЕсли;
	//Иначе 
	//	Если Выборка.Следующий() Тогда
	//		Если 	Выборка.Лимит_СуммаОстаток>=СуммаДокумента Тогда
	//			СтруктураОтвета.Результат=Истина;
	//		 Иначе
	//		 	СтруктураОтвета.ТекстОшибки=
	//				?(Выборка.Лимит_СуммаОстаток>=СуммаДокумента, "",  " Превышен лимит расхода на "+(-Выборка.Лимит_СуммаОстаток+СуммаДокумента));
	//		 КонецЕсли;
	//	Иначе	
	//		 СтруктураОтвета.ТекстОшибки="Превышен лимит расхода на "+СуммаДокумента ;
	//	КонецЕсли;	 
	//КонецЕсли;
	
	Возврат СтруктураОтвета;
	
КонецФункции


