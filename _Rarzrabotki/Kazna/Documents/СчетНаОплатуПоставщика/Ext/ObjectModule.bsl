Функция  Получить_Виза_ТекущиеВизирующие() Экспорт 
	 Если Виза_Состояние = Перечисления.Визы_Состояния.НаВизировании Тогда 
		лРезультат = "";
		Для Каждого лСтрока Из ЭтотОбъект.ТекущиеВизирующие Цикл 
			лРезультат = лРезультат + ?(ПустаяСтрока(лРезультат), "", "; ")  + Строка(лСтрока.Пользователь);
		КонецЦикла;
		
		Возврат лРезультат;
		
	Иначе
		
		Возврат ?( ЗначениеЗаполнено( Ответственный), Строка(Ответственный) ,  "Инициатор");
		
	КонецЕсли;
	
КонецФункции

Процедура ЗаполнитьТекущиеВизирующие(Роль) Экспорт
	
	ПараметрыОтбора = Новый Структура("Подразделение, СтатьяДвиженияДенежныхСредств, ВидОплаты, Организация, Сумма, ВидЗатрат,Направление");
	ЗаполнитьЗначенияСвойств(ПараметрыОтбора, ЭтотОбъект);
	ПараметрыОтбора.Вставить("Роль", Роль);
	МассивПользователей = РегистрыСведений.ИдентификацияВизирующихПоРолям.ПолучитьМассивПользователей(ПараметрыОтбора);
	ТекущиеВизирующие.Очистить();
	Для Каждого Строка Из МассивПользователей Цикл 
		ТекущиеВизирующие.Добавить().Пользователь = Строка;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если Не ЗначениеЗаполнено(ПлановаяДатаОплаты) Тогда
		ПлановаяДатаОплаты = Дата;
	КонецЕсли; 
	Виза_ТекущиеВизирующие = Получить_Виза_ТекущиеВизирующие();
	
	Если Не ЗначениеЗаполнено(ВидОперации) Тогда
		ВидОперации = Перечисления.ВидыОперацийСчетНаОплатуПоставщику.НаОплату;
	КонецЕсли;	
	
	Если ЭтотОбъект.ОбменДанными.Загрузка тогда 
		Возврат;
	КонецЕсли;
		
	//++ Павел Чистяков 09.08.2016 13:17:31 №174
	Если Виза_Состояние=Перечисления.Визы_Состояния.Утвержден
		И ЭтотОбъект.ПометкаУдаления
		И НЕ ЭтотОбъект.Ссылка.ПометкаУдаления  И Не РольДоступна("ПолныеПрава") Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			"Нельзя пометить на удаление Утвержденный счет",
			Ссылка,,,Отказ);
	КонецЕсли;
	//++ Павел Чистяков 09.08.2016 13:17:42
	
	//++ Павел Чистяков 09.08.2016 13:17:31 №174
	Если ПометкаУдаления Тогда
		Виза_Состояние=Перечисления.Визы_Состояния.Анулировано;
	КонецЕсли;
	//++ Павел Чистяков 09.08.2016 13:17:42
	
	Если ВидОплаты=Перечисления.ВидыДенежныхСредств.Безналичные
		И Не ЗначениеЗаполнено(СчетКонтрагента.НомерСчета) Тогда
		Если РежимЗаписи= РежимЗаписиДокумента.ОтменаПроведения Тогда
			
		Иначе	
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			"Не заполнен номер счета получателя",
			Ссылка,"СчетКонтрагента",,Отказ);
		КонецЕсли;
	КонецЕсли;	
	
	
	Если Виза_Состояние=Перечисления.Визы_Состояния.НаВизировании Тогда
		Если ТекущиеВизирующие.Количество()=0 Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			"Не определен следующий визирующий",
			Ссылка,"Организация",,Отказ);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура ПриКопировании(ОбъектКопирования)
	
	ВидОперации		= Перечисления.ВидыОперацийСчетНаОплатуПоставщику.НаОплату;
	Ответственный   = Пользователи.ТекущийПользователь();
	Автор           = Пользователи.ТекущийПользователь();
	ДатаСоздания	= ТекущаяДата();
	
	Виза_Дата			= Неопределено;
	Виза_Причина		= Неопределено;
	Виза_Состояние		= Неопределено;
	Виза_ТекущаяРоль	= Неопределено;
	Виза_ТекущиеВизирующие	= Неопределено;
	
	Визы.Очистить();
	ТекущиеВизирующие.Очистить();
	СчетаОснования.Очистить();
		
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, Режим)

	ПроверитьЗаполнениеОбязательныхРевизитов(Отказ);
	
	// Проверки безнала
	Если ВидОперации=Перечисления.ВидыОперацийСчетНаОплатуПоставщику.Транзит
		И СчетаОснования.Количество()>0 Тогда
		СуммаКСравнению = 0;
		Если СтатьяДвиженияДенежныхСредств=Константы.СтатьяТранзитНал.Получить() Тогда
			Для Каждого Строка Из СчетаОснования Цикл
				СуммаКСравнению = СуммаКСравнению + Строка.Счет.СуммаДокумента;
			КонецЦикла;
			Если СуммаКСравнению<>СуммаДокумента Тогда
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
					"Сумма документа не совпадает с суммой всех счетов оснований",
					Ссылка,"СуммаДокумента",,Отказ);
			КонецЕсли;
		ИначеЕсли СтатьяДвиженияДенежныхСредств=Константы.СтатьяКомисияНал.Получить() Тогда
			Для Каждого Строка Из СчетаОснования Цикл
				СуммаКСравнению = СуммаКСравнению + Строка.Счет.СуммаКоммисии;
			КонецЦикла;
			Если СуммаКСравнению<>СуммаДокумента Тогда
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				"Сумма документа не совпадает с суммой коммисии всех счетов оснований",
				Ссылка,"СуммаДокумента",,Отказ);
			КонецЕсли;			
		КонецЕсли;
	КонецЕсли; 
	
	Лимиты(Отказ);
	
	//++ Павел Чистяков 06.09.2016 09:49:49 №227
	// Не утвержденные счета не делают никаких важных движений
	Если Виза_Состояние <> Перечисления.Визы_Состояния.Утвержден Тогда
		Возврат;
	КонецЕсли;
	
	// СчетаПоставщиков Приход	
	Движение 				= Движения.СчетаПоставщиков.Добавить();
	Движение.ВидДвижения 	= ВидДвиженияНакопления.Приход;
	Движение.Период 		= Дата;
	Движение.СчетНаОплатуПоставщика = Ссылка;
	Движение.Сумма 			= СуммаДокумента;
	Движения.СчетаПоставщиков.Записывать = Истина;

	Если ВидОплаты=Перечисления.ВидыДенежныхСредств.Наличные Тогда
	//++ Бахтишаев А.Э. , 09/11/16 07:32, 393
		//Движения.СчетаНал.ВыполнитьПриход(ЭтотОбъект);
	    Если (Константы.ДатаНачалаРаботыПоНовойСхемеТранзитаДС.Получить() >= Дата ИЛИ Не ЗначениеЗаполнено(Константы.ДатаНачалаРаботыПоНовойСхемеТранзитаДС.Получить())) Тогда
			Движения.СчетаНал.ВыполнитьПриход(ЭтотОбъект);
		КонецЕсли;
	//-- Бахтишаев А.Э. , 09/11/16 07:32
	Иначе
		Если СтатьяДвиженияДенежныхСредств=Константы.СтатьяТранзитНал.Получить() Тогда
			Движения.СчетаНал.ВыполнитьРасход(ЭтотОбъект);
		КонецЕсли; 
	КонецЕсли;	
	
	
		
КонецПроцедуры

Процедура Виза_УстановитьСостояние(пСостояние, пДопы) Экспорт 
	лСостояние 		=  пСостояние;
	лТекПользователь= ?(НЕ пДопы.Свойство("ТекущийПользователь"), 	Пользователи.ТекущийПользователь(), пДопы.ТекущийПользователь);
	лЭтоАвтоВиза	= ?(НЕ пДопы.Свойство("ЭтоАвтоВиза"), 			Ложь, 			пДопы.ЭтоАвтоВиза);
	лЭтоИзФормы		= ?(НЕ пДопы.Свойство("ЭтоИзФормы"), 				Ложь, 			пДопы.ЭтоИзФормы);
	лДатаВизы		= ?(НЕ пДопы.Свойство("ДатаВизы"), 				ТекущаяДата(), 	пДопы.ДатаВизы);
	
	
	лДатаВизы		= ?(НЕ ЗначениеЗаполнено(лДатаВизы),			ТекущаяДата(), 	лДатаВизы  );
	
	лДокОбъект = ЭтотОбъект; //Историчестки ;)
	
	лНужныВизы 		= Ложь;
	лНужныПольз		= Ложь;
	
	Если лСостояние = Перечисления.Визы_Состояния.Черновик Тогда 
		лДокОбъект.Визы.Очистить();
	    лДокОбъект.Виза_Состояние 	= Перечисления.Визы_Состояния.Черновик;
		лДокОбъект.Виза_ТекущаяРоль = Справочники.РолиВизирования.Инициатор;
		лНужныПольз 				= Истина;
		
	ИначеЕсли 	лСостояние = Перечисления.Визы_Состояния.Утвержден 
			ИЛИ лСостояние = Перечисления.Визы_Состояния.Отклонено тогда
			
		лНужныВизы  = НЕ лДокОбъект.Виза_Состояние = Перечисления.Визы_Состояния.НаВизировании;
			////Сава 2016/09 "Транзит" - только для Казначеев и полніх прав (не требует утверждения, технические счета);
			//И НЕ лДокОбъект.ВидОперации = Перечисления.ВидыОперацийСчетНаОплатуПоставщику.Транзит; 
		//Если ранее было состояние на визировании, то значит не надо определять кто по ролям должен утвердить, иначе - надо )
	  	лНужныПольз = Истина;
		
	ИначеЕсли лСостояние = Перечисления.Визы_Состояния.ПустаяСсылка() Тогда 
		//Сава 2016/08 - отложенное визирование
		лСтрока 				= лДокОбъект.ПредварительныеВизы.Найти(лТекПользователь, "Пользователь");  
		лСтрока 				= ?(лСтрока = Неопределено, лДокОбъект.ПредварительныеВизы.Добавить(), лСтрока);
		лСтрока.Пользователь	= лТекПользователь;
		лСтрока.Утверждено 		= ?( лЭтоИзФормы = Истина,  НЕ лСтрока.Утверждено, Истина);
		лСтрока.ДатаУтверждения = ТекущаяДата();
		//++ Павел Чистяков 17.10.2016 10:33:14 №324
		Если Типзнч(пДопы)=Тип("Структура") И пДопы.Свойство("ТЧ_Виза_Причина") Тогда
			лСтрока.Комментарий = пДопы.ТЧ_Виза_Причина;
		КонецЕсли;
		//-- Павел Чистяков 17.10.2016 10:37:07		
		
		Если НЕ лДокОбъект.ТекущиеВизирующие.НайтиСтроки(Новый Структура("Пользователь", лТекПользователь)).Количество() = 0 Тогда 
			лДопы = Новый Структура();
			лДопы.Вставить("ТекущийПользователь",	лТекПользователь);
			лДопы.Вставить("ЭтоАвтоВиза", 			Истина);
			лДопы.Вставить("ДатаВизы", 				лСтрока.ДатаУтверждения);
						
			лДокОбъект.Виза_УстановитьСостояние(Перечисления.Визы_Состояния.Утвержден, лДопы );
		КонецЕсли;
		
		лДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
		Возврат;
		
	Иначе//Анулировано только остается... но это творит ответвенный или Автор
		лНужныПольз = Истина;
		
	КонецЕсли;
	
	лПараметры 		= Новый Структура("Подразделение, СтатьяДвиженияДенежныхСредств, ВидОплаты, Организация, Сумма, ВидЗатрат,Направление");
	ЗаполнитьЗначенияСвойств(лПараметры, лДокОбъект);
	Если ЗначениеЗаполнено(лДокОбъект.СуммаСчета) Тогда
		лПараметры.Сумма= лДокОбъект.СуммаСчета;;
	Иначе	
	     лПараметры.Сумма= лДокОбъект.СуммаДокумента;
	КонецЕсли;
	
	
	Если лНужныВизы Тогда 
		
		Если лДокОбъект.ВидОперации = Перечисления.ВидыОперацийСчетНаОплатуПоставщику.Транзит Тогда 
			
			лМассВизерей = Новый Массив();//Сава 2016/09
			
		Иначе
			
			////++ Павел Чистяков 17.10.2016 11:29:19   
			лПараметры.Вставить("Должность",Ответственный.Должность);
			Если Ответственный.Должность.Пустая() Тогда
				Сообщить("Не определена должность инициатора, операция прервана");
				 Возврат;
			КонецЕсли;

			лСхемаВизирования = ?(НЕ пДопы.Свойство("СхемаВизирования"), Неопределено, пДопы.СхемаВизирования);
			Если лСхемаВизирования =Неопределено Тогда
				лСхемаВизирования =РегистрыСведений.ОпределениеСхемыВизированияПоСчетам.ПолучитьСхемуВизирования(лПараметры)
			КонецЕсли;                                                     
			
			Если ЗначениеЗаполнено(лДокОбъект.ПриоритетнаяСхемаВизирования) Тогда
				лСхемаВизирования=лДокОбъект.ПриоритетнаяСхемаВизирования;
			КонецЕсли;                                                     
			
			Если лСхемаВизирования.Пустая() Тогда
				Сообщить("Не определена схема визирования, операция прервана");
				 Возврат;
			КонецЕсли;
			лМассВизерей = РегистрыСведений.ОпределениеСхемыВизированияПоСчетам.ПолучитьМассивВизерейПоСхеме(лСхемаВизирования);
			//-- Павел Чистяков 17.10.2016 11:32:15 
			
		КонецЕсли;
		
		лДокОбъект.Визы.Очистить();
		Для Каждого лСтрока Из лМассВизерей Цикл
			лДокОбъект.Визы.Добавить().Роль = лСтрока;
		КонецЦикла;
		лДокОбъект.ТекущиеВизирующие.Очистить();
		
		//Сава 2016/08
		//Определеим наших "героев", а именно, кто поименно должен поставить визы
		//Когда мы их будет знать - то сможем им дать возможность установить "педварительную визу" не дожидаясь своей очереди
		// в таком случаее, если есть предварительная виза - то при наступлении очереди установим ее (визу) 
		лДокОбъект.ПредварительныеВизы.Очистить();
		лТЗ = Новый ТаблицаЗначений(); 
		лТЗ.Колонки.Добавить("Роль");
		лТЗ.Колонки.Добавить("Пользователь");
		
		Для Каждого лСтрока2 Из лМассВизерей Цикл
			лМассПользователей  = РегистрыСведений.ИдентификацияВизирующихПоРолям.ПолучитьМассивПользователей(
				Новый Структура("Организация, Подразделение, Дата, Роль,Направление", Организация, Подразделение, ТекущаяДата(), лСтрока2,Направление));
			
			Для Каждого лПользователь Из  лМассПользователей Цикл
				//лНовСтрока 				= ЭтотОбъект.ПредварительныеВизы.Добавить();
				лНовСтрока				= лТЗ.Добавить();
				лНовСтрока.Роль 		= лСтрока2;
				лНовСтрока.Пользователь = лПользователь;
			КонецЦикла;
			
		КонецЦикла;
		
		лТЗ.Сортировать("Пользователь");
		лНовСтрока = Неопределено;
		Для Каждого лСтрока2 Из лТЗ Цикл 
			Если лНовСтрока = Неопределено ИЛИ НЕ лНовСтрока.Пользователь = лСтрока2.Пользователь Тогда 
				лНовСтрока				= ЭтотОбъект.ПредварительныеВизы.Добавить();
				лНовСтрока.Пользователь = лСтрока2.Пользователь;
				//++ Бахтишаев А.Э. , 10/10/16 11:41, 308, проверка на возможность доступа
				Если Не АХ_ОбщегоНазначения.ПользовательИмеетДоступКПодразделению(лСтрока2.Пользователь, Подразделение) Тогда
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Визирующий " + лСтрока2.Пользователь + " не имеет прав на просмотр подразделения " + Подразделение, Ссылка);
				КонецЕсли;
				//-- Бахтишаев А.Э. , 10/10/16 11:41
			КонецЕсли;
			лНовСтрока.Роли = лНовСтрока.Роли + ?(ПустаяСтрока(лНовСтрока.Роли), "", ", ") + Строка(лСтрока2.Роль);
		КонецЦикла;

	КонецЕсли;
	
	//Раз тут  - значит можем утвердить
	лТекРоль 	= лДокОбъект.Виза_ТекущаяРоль;
	лТекРоль	=?(НЕ ЗначениеЗаполнено(лТекРоль) И (лДокОбъект.Ответственный = лТекПользователь ИЛИ лДокОбъект.Автор = лТекПользователь), 
		Справочники.РолиВизирования.Инициатор, лТекРоль);
	
	лТекСтрока 				= лДокОбъект.Визы.НайтиСтроки( Новый Структура("Роль", лДокОбъект.Виза_ТекущаяРоль));
	//Сава 2016/08 выдвигаем инициатора на 1-е место
	Если лТекРоль = Справочники.РолиВизирования.Инициатор И лТекСтрока.Количество() = 0 И НЕ лДокОбъект.Визы.Количество() = 0  Тогда 
		лТекСтрока = лДокОбъект.Визы.Вставить(0);
	Иначе
		лТекСтрока = ?(лТекСтрока.Количество() = 0 ИЛИ лДокОбъект.Виза_ТекущаяРоль.Пустая(), лДокОбъект.Визы.Добавить(), лТекСтрока[0]);//лДокОбъект.Визы.Вставить(0), лТекСтрока[0]);
	КонецЕсли;
	
	лТекСтрока.Роль			= лТекРоль;
	лТекСтрока.Пользователь = лТекПользователь;
	лТекСтрока.Дата			= лДатаВизы;
	лТекСтрока.Виза_Состояние=лСостояние;
	лТекСтрока.Авто			= лЭтоАвтоВиза;
	
	//++ Павел Чистяков 17.10.2016 10:33:14 №324
	Если Типзнч(пДопы)=Тип("Структура") И пДопы.Свойство("Виза_Причина") Тогда
		лТекСтрока.Комментарий = пДопы.Виза_Причина;
	КонецЕсли;
	//-- Павел Чистяков 17.10.2016 10:37:07
	
	лДокОбъект.Виза_Дата	= ТекущаяДата();
	
	Если НЕ пДопы =Неопределено Тогда 
		ЗаполнитьЗначенияСвойств(лДокОбъект, пДопы);
	КонецЕсли;
		
	
	лМассПользователей = Новый Массив();
	
	Если лНужныВизы ИЛИ лНужныПольз Тогда 
		
		Если	лСостояние = Перечисления.Визы_Состояния.Утвержден Тогда 
			
			лДокОбъект.Виза_ТекущаяРоль = Неопределено;
			лСтрока 					= Неопределено;
			Для Каждого лСтрока Из лДокОбъект.Визы Цикл
				Если НЕ ЗначениеЗаполнено(лСтрока.Виза_Состояние) тогда 
					лДокОбъект.Виза_ТекущаяРоль = лСтрока.Роль;
					
					лПараметры.Вставить("Роль", лДокОбъект.Виза_ТекущаяРоль);
					лМассПользователей =  РегистрыСведений.ИдентификацияВизирующихПоРолям.ПолучитьМассивПользователей(лПараметры);  
					//Тютюн отправка сообщения пользователям о документе на визировании
					АХ_ОбщегоНазначения.ОтправитьУведомлениеОНеобходимостиВизированияСчета(лДокОбъект,лМассПользователей,лДокОбъект.Виза_ТекущаяРоль); 
					//КонецИзменений
					лДокОбъект.ТекущиеВизирующие.Очистить();
					Для Каждого лСтрока2 Из лМассПользователей Цикл 
						лДокОбъект.ТекущиеВизирующие.Добавить().Пользователь = лСтрока2;
					КонецЦикла;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			лДокОбъект.Виза_Состояние = ?(лДокОбъект.Виза_ТекущаяРоль.Пустая(), Перечисления.Визы_Состояния.Утвержден, Перечисления.Визы_Состояния.НаВизировании);
			
			//Сава 2016/08 Авто утвержение 
			Если НЕ лСтрока	= Неопределено И лДокОбъект.Виза_Состояние = Перечисления.Визы_Состояния.НаВизировании Тогда 
				лАвтоВизири = лДокОбъект.ПредварительныеВизы.НайтиСтроки(Новый Структура( "Утверждено", Истина) ); 
				Для Каждого лАвтоВиза Из лАвтоВизири Цикл                                                             
					Если НЕ лДокОбъект.ТекущиеВизирующие.Найти(лАвтоВиза.Пользователь, "Пользователь") = Неопределено Тогда 
						
						лДопы = Новый Структура();
						лДопы.Вставить("ТекущийПользователь",	лАвтоВиза.Пользователь );
						лДопы.Вставить("ЭтоАвтоВиза", 			Истина);
						лДопы.Вставить("ДатаВизы", 				лАвтоВиза.ДатаУтверждения);
						//++ Павел Чистяков 17.10.2016 14:57:32 №324
						лДопы.Вставить("Виза_Причина", 			лАвтоВиза.Комментарий);
						//-- Павел Чистяков 17.10.2016 14:57:34 
						лДокОбъект.Виза_УстановитьСостояние(лСостояние, лДопы );
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
		ИНачеЕсли 	лСостояние = Перечисления.Визы_Состояния.Черновик
			ИЛИ 	лСостояние = Перечисления.Визы_Состояния.Отклонено
			ИЛИ 	лСостояние = Перечисления.Визы_Состояния.Анулировано тогда  
			
			лМассПользователей = Новый Массив;
			Если  ЗначениеЗаполнено( лДокОбъект.Ответственный ) Тогда 
				лМассПользователей.Добавить( лДокОбъект.Ответственный );
			КонецЕсли;
			
			Если  ЗначениеЗаполнено( лДокОбъект.Автор ) И НЕ лДокОбъект.Автор = лДокОбъект.Ответственный Тогда 
				лМассПользователей.Добавить( лДокОбъект.Автор );
			КонецЕсли;
			
			лДокОбъект.ТекущиеВизирующие.Очистить();
			Для Каждого лСтрока Из лМассПользователей Цикл
				лДокОбъект.ТекущиеВизирующие.Добавить().Пользователь = лСтрока;
			КонецЦикла;
			
			лДокОбъект.Виза_Состояние   = лСостояние;
			лДокОбъект.Виза_ТекущаяРоль = Справочники.РолиВизирования.Инициатор;
			
		КонецЕсли;	
		
	КонецЕсли;
	
	Если НЕ лЭтоАвтоВиза = Истина Тогда 
		лДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
	КонецЕсли;
	
	
	//-----------------------------
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Ответственный = Пользователи.ТекущийПользователь();
	ВалютаДокумента = Константы.ВалютаРегламентированногоУчета.Получить();
	
	//++ Павел Чистяков 08.07.2016 14:45:36 №56
	Если ДанныеЗаполнения=Неопределено Тогда
		//**Убрали, Марина**	НазначениеПлатежа = "Оплата за згідно рахунку б\н від " + Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy");
	ИначеЕсли ТипЗнч(ДанныеЗаполнения)=Тип("Структура") Тогда
		
		Если ДанныеЗаполнения.Свойство("СчетаОснования") Тогда
			СтандартнаяОбработка = Ложь;
			ЗаполнитьЗначенияСвойств(ЭтотОбъект, ДанныеЗаполнения);
			Для Каждого Строка Из ДанныеЗаполнения.СчетаОснования Цикл
				//-- Павел Чистяков 13.10.2016 19:26:58 №328
				НоваяСтрока = СчетаОснования.Добавить();
				НоваяСтрока.Счет = Строка;
				Документы.СчетНаОплатуПоставщика.ОбновитьСтрокуСчетаОснования(ЭтотОбъект, НоваяСтрока);
			КонецЦикла; 
		КонецЕсли; 
		// Закоментил согласно №255
		//Если ДанныеЗаполнения.Свойство("Визы") Тогда
		//	Если ТипЗнч(ДанныеЗаполнения.Визы)=Тип("Массив") Тогда
		//		Виза_Состояние = Перечисления.Визы_Состояния.Утвержден;
		//		Для Каждого Строка Из ДанныеЗаполнения.Визы Цикл
		//			НоваяСтрока = Визы.Добавить();
		//			НоваяСтрока.Авто = Истина;
		//			НоваяСтрока.Дата = ТекущаяДата();
		//			НоваяСтрока.Пользователь = Строка;
		//			НоваяСтрока.Виза_Состояние = Перечисления.Визы_Состояния.Утвержден;
		//		КонецЦикла; 
		//	КонецЕсли; 
		//КонецЕсли;       
	ИначеЕсли ТипЗнч(ДанныеЗаполнения)=Тип("ДокументСсылка.СчетНаОплатуПоставщика") Тогда	
		ЗаполнитьЗначенияСвойств(ЭтотОбъект, ДанныеЗаполнения); 
		ЭтотОбъект.ДокументОснование=ДанныеЗаполнения;          
		ЭтотОбъект.Дата=ТекущаяДата();
		
		ЭтотОбъект.УстановитьНовыйНомер();
		НоваяСтрока = СчетаОснования.Добавить();
		НоваяСтрока.Счет = ДанныеЗаполнения;   
		НоваяСтрока.Сумма=ДанныеЗаполнения.СуммаДокумента;
		
		Если ЭтотОбъект.ПроцентОплаты>0 Тогда
			ЭтотОбъект.ПроцентОплаты=100-ЭтотОбъект.ПроцентОплаты;
			ЭтотОбъект.СуммаДокумента=Окр(ЭтотОбъект.СуммаСчета *(ЭтотОбъект.ПроцентОплаты/100),2);
		КонецЕсли;
		//Для Каждого Строка Из ДанныеЗаполнения.СчетаОснования Цикл
			//	НоваяСтрока = СчетаОснования.Добавить();
			//	НоваяСтрока.Счет = Строка;
			//	//Документы.СчетНаОплатуПоставщика.ОбновитьСтрокуСчетаОснования(ЭтотОбъект, НоваяСтрока);
			//КонецЦикла; 

	КонецЕсли; 
	
	Если Не ЗначениеЗаполнено(СтавкаНДС) Тогда
		СтавкаНДС= Перечисления.СтавкиНДС.НДС20;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверитьЗаполнениеОбязательныхРевизитов(Отказ)
	
	МассивПроверяемыхРеквизитов = Новый Массив;
	
	Если Подразделение.ДетализацияДоСекций Тогда
		МассивПроверяемыхРеквизитов.Добавить("Секция");
	КонецЕсли;
	
	Если Подразделение.ДетализацияДоВидаЗатрат Тогда
		МассивПроверяемыхРеквизитов.Добавить("ВидЗатрат");
	КонецЕсли;
	
	Если Не ВидОплаты = Перечисления.ВидыДенежныхСредств.Наличные Тогда
		МассивПроверяемыхРеквизитов.Добавить("Контрагент");   
		МассивПроверяемыхРеквизитов.Добавить("НомерВходящегоДокумента");
	КонецЕсли;
	
	АХ_ОбщегоНазначения.КонтрольЗаполненияОбязательныхРеквизитовШапкиОбъекта(ЭтотОбъект, МассивПроверяемыхРеквизитов, Отказ);
		
КонецПроцедуры
  //Тютюн
Процедура Лимиты(Отказ)
	//Проверка лимитов
	//Лимит по подразделению
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СУММА(ЕСТЬNULL(ЛимитыПроектовОстатки.СуммаОстаток, 0)) КАК СуммаОстаток,
		|	ЛимитыПроектовОбороты.Подразделение,
		|	СУММА(ЛимитыПроектовОбороты.СуммаПриход) КАК СуммаПриход
		|ИЗ
		|	РегистрНакопления.ЛимитыПроектов.Обороты(, , , Подразделение = &Подразделение) КАК ЛимитыПроектовОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЛимитыПроектов.Остатки(&Дата, Подразделение = &Подразделение) КАК ЛимитыПроектовОстатки
		|		ПО ЛимитыПроектовОбороты.Подразделение = ЛимитыПроектовОстатки.Подразделение
		|
		|СГРУППИРОВАТЬ ПО
		|	ЛимитыПроектовОбороты.Подразделение";
	
	Запрос.УстановитьПараметр("Дата", Новый Граница(Дата, ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("Подразделение", Подразделение);
	
	ВыборкаЛимитов = Запрос.Выполнить().Выбрать();
	
	Если ВыборкаЛимитов.Следующий() Тогда 
		Если  ВыборкаЛимитов.СуммаОстаток - СуммаДокумента < 0 Тогда 
			Отказ = Истина;
			Сообщить("Превышен общий лимит счетов по подразделению: " + Подразделение);
		Иначе 
			
		Движения.ЛимитыПроектов.Записывать = Истина;
		Движение = Движения.ЛимитыПроектов.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Подразделение = Подразделение;
		Движение.Сумма = СуммаДокумента;

		КонецЕсли;
		
	КонецЕсли;   
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СУММА(ЕСТЬNULL(ЛимитыНаМесяцОстатки.СуммаОстаток, 0)) КАК СуммаОстаток,
		|	ЛимитыНаМесяцОбороты.Подразделение,
		|	СУММА(ЛимитыНаМесяцОбороты.СуммаПриход) КАК СуммаПриход,
		|	ЛимитыНаМесяцОбороты.ПоказательБюджета
		|ИЗ
		|	РегистрНакопления.ЛимитыНаМесяц.Обороты(
		|			,
		|			,
		|			,
		|			Подразделение = &Подразделение
		|				И ПоказательБюджета = &СтатьяДДС
		|				И Месяц = &Месяц) КАК ЛимитыНаМесяцОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЛимитыНаМесяц.Остатки(
		|				&Дата,
		|				Подразделение = &Подразделение
		|					И ПоказательБюджета = &СтатьяДДС
		|					И Месяц = &Месяц) КАК ЛимитыНаМесяцОстатки
		|		ПО ЛимитыНаМесяцОбороты.Подразделение = ЛимитыНаМесяцОстатки.Подразделение
		|
		|СГРУППИРОВАТЬ ПО
		|	ЛимитыНаМесяцОбороты.Подразделение,
		|	ЛимитыНаМесяцОбороты.ПоказательБюджета";
	
	Запрос.УстановитьПараметр("Дата", Новый Граница(Дата, ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("Подразделение", Подразделение); 
	Запрос.УстановитьПараметр("СтатьяДДС", СтатьяДвиженияДенежныхСредств);  
	Запрос.УстановитьПараметр("Месяц", НачалоМесяца(Дата)); 
	
	
	ВыборкаЛимитов = Запрос.Выполнить().Выбрать();
	
	Если ВыборкаЛимитов.Следующий() Тогда 
		Если  ВыборкаЛимитов.СуммаОстаток - СуммаДокумента < 0 Тогда 
			Отказ = Истина;
			Сообщить("Превышен лимит счетов " + "/ Подразделение: "+Подразделение + "/ Статья: " + СтатьяДвиженияДенежныхСредств);
		Иначе 
			
		Движения.ЛимитыНаМесяц.Записывать = Истина;
		Движение = Движения.ЛимитыНаМесяц.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;  
		Движение.Месяц = НачалоМесяца(Дата);
		Движение.Подразделение = Подразделение; 
		Движение.ПоказательБюджета   =   СтатьяДвиженияДенежныхСредств;
		Движение.Сумма = СуммаДокумента;

		КонецЕсли;
		
	КонецЕсли;

	
	
	
	
	
КонецПроцедуры