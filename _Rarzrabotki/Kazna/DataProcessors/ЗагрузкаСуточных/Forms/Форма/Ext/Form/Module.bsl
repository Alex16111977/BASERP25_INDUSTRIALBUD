
&НаСервере
Процедура ПрочитатьДанныеНаСервере()
	Для каждого Стр Из Объект.Сотрудники Цикл
		Стр.Сотрудник= Справочники.Сотрудники.НайтиПоРеквизиту("ИНН",Стр.ИНн);
		Если Стр.Сотрудник.пустая() Тогда
			Сообщить("НЕ найден сотрудник "+Стр.ИНН+"  "+СТр.ФИО);
		КонецЕсли;
	КонецЦикла;
	Сообщить("Чтение данных завершено");
	Элементы.Группа1.ТекущаяСтраница=Элементы.Группа3;
КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьДанные(Команда)
	Объект.Сотрудники.Очистить();
	
	Для Сч=1 По ТекстСДанными.КоличествоСтрок() Цикл
		текСтрока = ТекстСДанными.ПолучитьСтроку(Сч);
		ИНН=Сред(текСтрока,1,10);
		ИНН2=Сред(текСтрока,4,10);
		ИНН3=Сред(текСтрока,3,10);
		нПп=Сред(текСтрока,1,2);
		
		ТипСхемы= 0;
		Если ЭтоЧисло(ИНН) Тогда
			ТипСхемы				=1;
		ИНачеЕсли ЭтоЧисло(ИНН3) И ЭтоЧисло(нПп) Тогда
			Если Сред(текСтрока,2,1)=" " Тогда
				ТипСхемы =2;	
			Иначе	
				ТипСхемы =3;	
			КонецЕсли;
		КонецЕсли;	
	
			
		Если ТипСхемы>0 Тогда
			
			Если ТипСхемы=2 Тогда
				текСтрока=Сред(текСтрока,3);
			ИначеЕсли ТипСхемы=3 Тогда
				текСтрока=Сред(текСтрока,4);	
			КонецЕсли;
			ИНН=Сред(текСтрока,1,10);
			ПозицияUA=СтрНайти(текСтрока,"UA");
			Если ПозицияUA>0 Тогда
				нСТр = Объект.Сотрудники.Добавить();
				нСТр.ИНН=ИНН;
				нСТр.ФИО=Сред(текСтрока,12,ПозицияUA-13);
				нСТр.РасчетныйСчет=СтрЗаменить(Сред(текСтрока,ПозицияUA,32)," ","");
				локСумма=СтрЗаменить(Сред(текСтрока,ПозицияUA+33)," ","");
				
				локСумма=Сред(локСумма,1,СтрДлина(локСумма)-?(ТипСхемы=1,2,0));
				нСТр.Сумма=Число(локСумма);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ПрочитатьДанныеНаСервере();
КонецПроцедуры

&НаСервере
Процедура СоздатьДокументыНаСервере()
	ВалютаГрн= Константы.ВалютаРегламентированногоУчета.Получить();
	СтатьяДвиженияДенежныхСредств= Справочники.СтатьиДвиженияДенежныхСредств.НайтиПоКоду("УТ-001047");
	СтатьяЗатрат = Справочники.СтатьиЗатрат.НайтиПоКоду("000000078");
	
	СчДок=0;
	
	Для каждого Стр Из Объект.Сотрудники Цикл
		Если НЕ ЗначениеЗаполнено(Стр.Сотрудник)  Тогда
			Сообщить("Не найден сотрудник "+Стр.ФИО);
			Продолжить;
		КонецЕсли;		
		докППИ = НайтиППИ(Стр.ИНН);
		Если НЕ докППИ.Пустая() Тогда
			Продолжить;;
		КонецЕсли;
		
		СчДок=СчДок+1;
		
		докППИ = Документы.ПлатежноеПоручениеИсходящее.СоздатьДокумент();
		докППИ.Организация=Организация;
		докППИ.СчетОрганизации=СчетОрганизации;
		докППИ.Дата= ДатаОплаты;
		докППИ.ДатаОплаты= ДатаОплаты;
		докППИ.Оплачено=Истина;
		докППИ.Направление=Направление;
		
		докППИ.ВалютаДокумента=ВалютаГрн;    
		докППИ.ВидОперации=Перечисления.ВидыОперацийППИсходящее.ПеречислениеДенежныхСредствПодотчетнику;
		докППИ.СтатьяДвиженияДенежныхСредств=СтатьяДвиженияДенежныхСредств;
		докППИ.СтатьяЗатрат =СтатьяЗатрат;
		текСОтр = Справочники.Сотрудники.НайтиПоРеквизиту("ИНН",Стр.ИНН);
		Если ЗначениеЗаполнено(текСОтр) Тогда
			Если ЗначениеЗаполнено(текСОтр.Родитель.СтатьяЗарплата) Тогда
				докППИ.СтатьяДвиженияДенежныхСредств=текСОтр.Родитель.СтатьяЗарплата;		
			КонецЕсли;
		КонецЕсли;
		докППИ.Контрагент= НайтиСоздатьКонтрагента(Стр.ИНН,Стр.ФИО);
		докППИ.СчетКонтрагента= НайтиСоздатьСчетКонтрагента(докППИ.Контрагент,Стр.РасчетныйСчет);
		//докППИ.ДоговорКонтрагента= НайтиСоздатьСчетКонтрагента(докППИ.Контрагент,Стр.РасчетныйСчет);
		
		докППИ.СуммаДокумента=Стр.Сумма;
		докППИ.Ответственный=ПараметрыСеанса.ТекущийПользователь;
		докППИ.НазначениеПлатежа="Аванс на відрядження";
		Попытка
		
				докППИ.Записать(РежимЗаписиДокумента.Проведение);
			
		
		Исключение
				докППИ.Записать(РежимЗаписиДокумента.Запись);
				Сообщить("Документ "+ докППИ+" записан, не проведен");
		КонецПопытки;
	
		//Для тестов, создаем 1
		//Возврат;
	КонецЦикла;
	Сообщить("Создание ППИ завершено, создано "+СчДок+" новый документа");
КонецПроцедуры

Функция НайтиСоздатьКонтрагента(ИНН,Наименование)
	Запрос= Новый ЗАпрос;
	Запрос.Текст=    "ВЫБРАТЬ
	              |	Контрагенты.Ссылка
	              |ИЗ
	              |	Справочник.Контрагенты КАК Контрагенты
	              |ГДЕ
	              |	Контрагенты.ЕГРПОУ = &ЕГРПОУ
	              |	И Контрагенты.ПометкаУдаления = ЛОЖЬ"    ;
	Запрос.УстановитьПараметр("ЕГРПОУ",ИНН);
	Выборка = ЗАпрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат ВЫборка.Ссылка;
	КонецЕсли;
	
	СпрК = Справочники.Контрагенты.СоздатьЭлемент();
	СпрК.ЕГРПОУ= ИНН;
	СпрК.Наименование= Наименование;
	СпрК.ФизЮрЛицо=Перечисления.ЮридическоеФизическоеЛицо.ФизическоеЛицо;
	СпрК.Записать();
	
	Возврат СпрК.Ссылка;

КонецФункции // ()

Функция НайтиСоздатьСчетКонтрагента(Контрагент,НомерСчета)
	Запрос= Новый ЗАпрос;
	Запрос.Текст=    "ВЫБРАТЬ
	                 |	БанковскиеСчета.Ссылка
	                 |ИЗ
	                 |	Справочник.БанковскиеСчета КАК БанковскиеСчета
	                 |ГДЕ
	                 |	БанковскиеСчета.Владелец = &Контрагент
	                 |	И БанковскиеСчета.НомерСчета = &НомерСчета
	                 |	И БанковскиеСчета.ПометкаУдаления = ЛОЖЬ"    ;
	Запрос.УстановитьПараметр("Контрагент",Контрагент);
	Запрос.УстановитьПараметр("НомерСчета",НомерСчета);
	
	Выборка = ЗАпрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат ВЫборка.Ссылка;
	КонецЕсли;
	
	СпрК = Справочники.БанковскиеСчета.СоздатьЭлемент();
	СпрК.Владелец= Контрагент;
	СпрК.НомерСчета=НомерСчета;
	СпрК.Наименование= НомерСчета;
	СпрК.Банк=Справочники.Банки.НайтиПоКоду("300528");
	СпрК.Записать();
	
	Возврат СпрК.Ссылка;

КонецФункции // ()


Функция НайтиППИ(Инн)
	Запрос = Новый Запрос;
	ЗАпрос.Текст= "ВЫБРАТЬ
	|	ПлатежноеПоручениеИсходящее.Ссылка
	|ИЗ
	|	Документ.ПлатежноеПоручениеИсходящее КАК ПлатежноеПоручениеИсходящее
	|ГДЕ
	|	ПлатежноеПоручениеИсходящее.Организация = &Организация
	|	И ПлатежноеПоручениеИсходящее.СчетОрганизации = &СчетОрганизации
	|	И ПлатежноеПоручениеИсходящее.Контрагент.ЕГРПОУ = &ЕГРПОУ
	|	И НАЧАЛОПЕРИОДА(ПлатежноеПоручениеИсходящее.Дата ,ДЕНЬ)= &Дата
	|	И ПлатежноеПоручениеИсходящее.ПометкаУдаления = ЛОЖЬ" ;
	ЗАпрос.УстановитьПараметр("Организация",Организация);
	ЗАпрос.УстановитьПараметр("СчетОрганизации",СчетОрганизации);
	ЗАпрос.УстановитьПараметр("ЕГРПОУ",ИНН);
	ЗАпрос.УстановитьПараметр("Дата",НачалоДня(ДатаОплаты));
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Документы.ПлатежноеПоручениеИсходящее.ПустаяСсылка();
	
	
КонецФункции // ()

&НаКлиенте
Процедура СоздатьДокументы(Команда)
	Если Не ЗначениеЗаполнено(Организация) Тогда
		Предупреждение("Не заполнена организация",15);
		Возврат;	
	КонецЕсли;
	Если Не ЗначениеЗаполнено(СчетОрганизации) Тогда
		Предупреждение("Не заполнен СчетОрганизации",15);
		Возврат;	
	КонецЕсли;

	Если Не ЗначениеЗаполнено(ДатаОплаты) Тогда
		Предупреждение("Не заполнена ДатаОплаты",15);
		Возврат;	
	КонецЕсли;

	СоздатьДокументыНаСервере();
КонецПроцедуры

Функция ЭтоЧИсло(Знач ТекСтрока ) ЭКспорт
	локЧисло =0;
	Попытка
	    локЧисло = Число(ТекСтрока);
	Исключение
	
	КонецПопытки;
	Возврат локЧисло>0;
	//ТекСтрока=СокрЛП(ТекСтрока);
	//Для СчСимволов=1 По СтрДлина(ТекСтрока) Цикл
	//	локСимвол=СРед();
	//	
	//
	//КонецЦикла;
КонецФункции // ()

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Организация=Справочники.Организации.НайтиПоКоду("000000058");
	ДатаОплаты=ТекущаяДата();
КонецПроцедуры
