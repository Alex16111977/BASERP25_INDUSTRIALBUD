
&НаСервере
Процедура ВосстановитьНаСервере()
	
	Объект.Ошибки.Очистить();
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПриходныйКассовыйОрдер.Ссылка,
	|	ПриходныйКассовыйОрдер.Дата КАК Дата
	|ИЗ
	|	Документ.ПриходныйКассовыйОрдер КАК ПриходныйКассовыйОрдер
	|ГДЕ
	|	ПриходныйКассовыйОрдер.Дата >= &Дата
	|	И ПриходныйКассовыйОрдер.Проведен
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РасходныйКассовыйОрдер.Ссылка,
	|	РасходныйКассовыйОрдер.Дата
	|ИЗ
	|	Документ.РасходныйКассовыйОрдер КАК РасходныйКассовыйОрдер
	|ГДЕ
	|	РасходныйКассовыйОрдер.Дата >= &Дата
	|	И РасходныйКассовыйОрдер.Проведен
	|
	|УПОРЯДОЧИТЬ ПО
	|	Дата";
	
	Запрос.УстановитьПараметр("Дата", Объект.ДатаНачала);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ДокументОбъект = Выборка.Ссылка.ПолучитьОбъект(); 
		Попытка
			ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение)
		Исключение 
			Нстрока = Объект.Ошибки.Добавить();
			Нстрока.Документ = ДокументОбъект.Ссылка; 
			
			Если Типзнч(Выборка.Ссылка) = Тип("ДокументСсылка.ПриходныйКассовыйОрдер") Тогда   
				Если Выборка.Ссылка.ВидОперации = Перечисления.ВидыОперацийПКО.ПеремещениеДС Тогда 
					Основание = Выборка.Ссылка.Основание;
					Если Значениезаполнено(Основание) Тогда
						Если ТипЗнч(Основание) = Тип("ДокументСсылка.РасходныйКассовыйОрдер") И Основание.Проведен Тогда 
							Если Основание.Дата >= Выборка.Ссылка.Дата Тогда   
								//Нстрока = Объект.Ошибки.Добавить();
								//Нстрока.Документ = ДокументОбъект.Ссылка;
								Нстрока.Ошибка = "Дата документа раньше чем дата РКО";
								
							КонецЕсли;
							
						Иначе
							//Нстрока = Объект.Ошибки.Добавить();
							//Нстрока.Документ = ДокументОбъект.Ссылка;
							Нстрока.Ошибка = "Укажите в основании проведенный документ РКО";
							
						КонецЕсли;  
					Иначе
						//Нстрока = Объект.Ошибки.Добавить();
						//Нстрока.Документ = ДокументОбъект.Ссылка;
						Нстрока.Ошибка = "Не указан документ основание";
					КонецЕсли;
					
				ИначеЕсли Выборка.Ссылка.СтатьяДвиженияДенежныхСредств = Справочники.СтатьиДвиженияДенежныхСредств.НайтиПоКоду("УТ-001082")  Тогда 
					
					Нстрока.Ошибка = "Не хватает остатка ДС у Фин агента, укажите % фин агента";
					
				КонецЕсли; 
			Иначе
				   Нстрока.Ошибка =  "Остаток ДС по кассе отрицательный. Проведение невозможно.";
			КонецЕсли;
			
		КонецПопытки; 
		
		
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|   ДатаПоследовательностиКассы.Документ КАК Документ,
	|   ДатаПоследовательностиКассы.Дата КАК Дата
	|ИЗ
	|   РегистрСведений.ДатаПоследовательностиКассы КАК ДатаПоследовательностиКассы";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда 
		ДатаПоследовательности = Выборка.Дата;
	Иначе
		ДатаПоследовательности = Неопределено;
	КонецЕсли;
	
	ДатаНачалаДС = Константы.ДатаНачалаУчетаСтоимостиНаличных.Получить();
	
	
	
	Если ЗначениеЗаполнено(ДатаПоследовательности) Тогда 
		Объект.ДатаНачала = ДатаПоследовательности; 
	Иначе  
		Объект.ДатаНачала = ДатаНачалаДС; 
	КонецЕсли;  
	
	
КонецПроцедуры

&НаКлиенте
Процедура Восстановить(Команда)   
	Если ЗначениеЗаполнено(Объект.ДатаНачала) Тогда 
		ВосстановитьНаСервере();                        
	Иначе 
		Предупреждение("Введите остатки стоимости касс");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)  
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|   ДатаПоследовательностиКассы.Документ КАК Документ,
	|   ДатаПоследовательностиКассы.Дата КАК Дата
	|ИЗ
	|   РегистрСведений.ДатаПоследовательностиКассы КАК ДатаПоследовательностиКассы";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда 
		ДатаПоследовательности = Выборка.Дата;
	Иначе
		ДатаПоследовательности = Неопределено;
	КонецЕсли;

	ДатаНачалаДС = Константы.ДатаНачалаУчетаСтоимостиНаличных.Получить();

	
	
	Если ЗначениеЗаполнено(ДатаПоследовательности) Тогда 
		Объект.ДатаНачала = ДатаПоследовательности; 
	Иначе  
		Объект.ДатаНачала = ДатаНачалаДС; 
	КонецЕсли;  
	
КонецПроцедуры

&НаКлиенте
Процедура ОшибкиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Если Поле = Элементы.ОшибкиДокумент Тогда
		СтандартнаяОбработка = Ложь; 
		Док = Элемент.ТекущиеДанные.Документ;
		ОткрытьЗначение(Док);
		//Форма = Док.ПолучитьФорму("ФормаДокумента",Док);  
		//Форма.Открыть();  
	КонецЕсли;   
	
КонецПроцедуры
