&НаСервере
Процедура ДобавитьНовогоВизирующегоНаСервере()
	
	Если	НЕ ЗначениеЗаполнено(Объект.Прользователь)
		ИЛИ	НЕ ЗначениеЗаполнено(Объект.Виза_ТекущаяРоль)
		ИЛИ	НЕ ЗначениеЗаполнено(Объект.ПрользовательДобавляемый) Тогда 
		
		Сообщить("Не все данные указаны");
		Возврат;
	КонецЕсли;
	лЗапрос = Новый Запрос(
	"ВЫБРАТЬ
	|	Т.Ссылка КАК Счет
	|ИЗ
	|	Документ.СчетНаОплатуПоставщика.ТекущиеВизирующие КАК Т
	|ГДЕ
	|	Т.Пользователь = &Прользователь
	|	И Т.Ссылка.Виза_ТекущаяРоль = &Виза_ТекущаяРоль
	|	И Т.Ссылка.Виза_Состояние = &Виза_Состояние");
	лЗапрос.УстановитьПараметр("Прользователь", 	Объект.Прользователь);
	лЗапрос.УстановитьПараметр("Виза_ТекущаяРоль",	Объект.Виза_ТекущаяРоль);
	лЗапрос.УстановитьПараметр("Виза_Состояние", 	Перечисления.Визы_Состояния.НаВизировании);

	лВыборка = лЗапрос.Выполнить().Выбрать();
	Пока лВыборка.Следующий() Цикл
		лОб = лВыборка.Счет.ПолучитьОбъект();
		Если Ложь Тогда 
			лОб = Документы.СчетНаОплатуПоставщика.СоздатьДокумент();
		КонецЕсли;	
		
		Если лОб.ТекущиеВизирующие.Найти( Объект.ПрользовательДобавляемый, "Прользователь" ) = Неопределено Тогда 
			лОб.ТекущиеВизирующие.Добавить().Прользователь = Объект.ПрользовательДобавляемый;
			лОб.Записать();
		КонецЕсли;
		
	КонецЦикла;
	
	
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьНовогоВизирующего(Команда)
	ДобавитьНовогоВизирующегоНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПереопределитьТекущихВизирующихНаСервере( пРоль = Неопределено )
	лЗапрос 		= Новый Запрос();
	лЗапрос.Текст 	= "ВЫБРАТЬ
					|	Т.Ссылка
		            |ИЗ
		            |	Документ.СчетНаОплатуПоставщика КАК Т
		            |ГДЕ
		            |	Т.Виза_Состояние = &Виза_Состояние
					|	И (&пРоль = Неопределено ИЛИ  Т.Виза_ТекущаяРоль = &пРоль ) ";
	лЗапрос.УстановитьПараметр("Виза_Состояние", Перечисления.Визы_Состояния.НаВизировании);
	лЗапрос.УстановитьПараметр("пРоль", пРоль);
	
	
	лВыборка = лЗапрос.Выполнить().Выбрать();
	
	Пока лВыборка.Следующий() Цикл
		
		лДокОбъект = лВыборка.Ссылка.ПолучитьОбъект();
		
		лПараметры 		= Новый Структура("Подразделение, СтатьяДвиженияДенежныхСредств, ВидОплаты, Организация, Сумма, ВидЗатрат");
		ЗаполнитьЗначенияСвойств(лПараметры, лДокОбъект);
		лПараметры.Сумма= лДокОбъект.СуммаДокумента;
		лПараметры.Вставить("Роль", лДокОбъект.Виза_ТекущаяРоль);
		лМассПользователей =  РегистрыСведений.ИдентификацияВизирующихПоРолям.ПолучитьМассивПользователей(лПараметры);
		лДокОбъект.ТекущиеВизирующие.Очистить();
		Для Каждого лСтрока2 Из лМассПользователей Цикл 
			лДокОбъект.ТекущиеВизирующие.Добавить().Пользователь = лСтрока2;
		КонецЦикла;
		
		Попытка
			лДокОбъект.Записать();
		Исключение
			
		КонецПопытки;
		
	КонецЦикла;
		
КонецПроцедуры

&НаКлиенте
Процедура ПереопределитьТекущихВизирующих(Команда)
	ПереопределитьТекущихВизирующихНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПереопределитьДляРолиНаСервере()
	
КонецПроцедуры

&НаКлиенте
Процедура ПереопределитьДляРоли(Команда)
	ПереопределитьТекущихВизирующихНаСервере( Объект.Виза_ТекущаяРоль );
КонецПроцедуры
