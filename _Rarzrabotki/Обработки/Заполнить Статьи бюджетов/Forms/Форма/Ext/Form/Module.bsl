
&НаКлиенте
Процедура Заполнить(Команда)

    // Валідація
    Если НЕ ЗначениеЗаполнено(Объект.СтатьяБюджета) Тогда
        Сообщить("Не выбрана статья бюджета (папка-приемник)!");
        Возврат;
    КонецЕсли;

    Если Объект.Статьи.Количество() = 0 Тогда
        Сообщить("Не выбраны статьи движения денежных средств (папки-источники)!");
        Возврат;
    КонецЕсли;

    // Виклик серверної процедури
    Результат = ЗаполнитьНаСервере();

    Сообщить("Создано элементов: " + Результат.Создано);
    Сообщить("Пропущено (уже существуют): " + Результат.Пропущено);

КонецПроцедуры

&НаСервере
Функция ЗаполнитьНаСервере()

    Результат = Новый Структура("Создано, Пропущено", 0, 0);

    // Отримати аналітики для елементів
    АналитикаСтатьиДДС = ПланыВидовХарактеристик.АналитикиСтатейБюджетов.НайтиПоНаименованию("Статьи ДДС");
    АналитикаТипыДС = ПланыВидовХарактеристик.АналитикиСтатейБюджетов.НайтиПоНаименованию("Типы денежных средств");

    // Для кожної папки-джерела
    Для Каждого СтрокаТаблицы Из Объект.Статьи Цикл

        ПапкаИсточник = СтрокаТаблицы.СтатьяДвиженияДенежныхСредств;

        Если НЕ ЗначениеЗаполнено(ПапкаИсточник) Тогда
            Продолжить;
        КонецЕсли;

        // Обробити папку та всі вкладені елементи
        ОбработатьПапкуИсточник(ПапкаИсточник, Объект.СтатьяБюджета,
                                АналитикаСтатьиДДС, АналитикаТипыДС, Результат);

    КонецЦикла;

    Возврат Результат;

КонецФункции

&НаСервере
Процедура ОбработатьПапкуИсточник(ПапкаИсточник, ПапкаПриемник, АналитикаСтатьиДДС, АналитикаТипыДС, Результат)

    // Запит на отримання всіх елементів папки-джерела
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |    СтатьиДДС.Ссылка КАК Ссылка,
    |    СтатьиДДС.Наименование КАК Наименование,
    |    СтатьиДДС.ЭтоГруппа КАК ЭтоГруппа,
    |    СтатьиДДС.Родитель КАК Родитель
    |ИЗ
    |    Справочник.СтатьиДвиженияДенежныхСредств КАК СтатьиДДС
    |ГДЕ
    |    СтатьиДДС.Ссылка В ИЕРАРХИИ(&ПапкаИсточник)
    |    И СтатьиДДС.Ссылка <> &ПапкаИсточник
    |УПОРЯДОЧИТЬ ПО
    |    СтатьиДДС.Ссылка ИЕРАРХИЯ";

    Запрос.УстановитьПараметр("ПапкаИсточник", ПапкаИсточник);

    Выборка = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);

    // Кеш відповідності: СтатьяДДС -> СтатьяБюджетов
    СоответствиеСтатей = Новый Соответствие;

    // Папка-джерело відповідає папці-приймачу
    СоответствиеСтатей.Вставить(ПапкаИсточник, ПапкаПриемник);

    Пока Выборка.Следующий() Цикл

        СтатьяДДС = Выборка.Ссылка;

        // Перевірити чи вже є такий елемент в СтатьиБюджетов
        СуществующийЭлемент = НайтиСтатьюБюджетовПоСтатьеДДС(СтатьяДДС);

        Если ЗначениеЗаполнено(СуществующийЭлемент) Тогда
            // Вже існує - запам'ятати і пропустити
            СоответствиеСтатей.Вставить(СтатьяДДС, СуществующийЭлемент);
            Результат.Пропущено = Результат.Пропущено + 1;
            Продолжить;
        КонецЕсли;

        // Визначити батька в приймачі
        РодительВПриемнике = СоответствиеСтатей.Получить(Выборка.Родитель);
        Если РодительВПриемнике = Неопределено Тогда
            // Батько ще не створений - спочатку створити його
            РодительВПриемнике = СоздатьИлиНайтиРодителя(Выборка.Родитель, ПапкаИсточник,
                                                         ПапкаПриемник, СоответствиеСтатей,
                                                         АналитикаСтатьиДДС, АналитикаТипыДС, Результат);
        КонецЕсли;

        // Створити новий елемент
        НоваяСтатья = СоздатьСтатьюБюджетов(СтатьяДДС, Выборка.Наименование,
                                            Выборка.ЭтоГруппа, РодительВПриемнике,
                                            АналитикаСтатьиДДС, АналитикаТипыДС);

        СоответствиеСтатей.Вставить(СтатьяДДС, НоваяСтатья);
        Результат.Создано = Результат.Создано + 1;

    КонецЦикла;

КонецПроцедуры

&НаСервере
Функция НайтиСтатьюБюджетовПоСтатьеДДС(СтатьяДДС)

    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |    СтатьиБюджетов.Ссылка КАК Ссылка
    |ИЗ
    |    Справочник.СтатьиБюджетов КАК СтатьиБюджетов
    |ГДЕ
    |    СтатьиБюджетов.А_СтатьяДвиженияДенежныхСредств = &СтатьяДДС";

    Запрос.УстановитьПараметр("СтатьяДДС", СтатьяДДС);

    РезультатЗапроса = Запрос.Выполнить();
    Если НЕ РезультатЗапроса.Пустой() Тогда
        Возврат РезультатЗапроса.Выгрузить()[0].Ссылка;
    КонецЕсли;

    Возврат Неопределено;

КонецФункции

&НаСервере
Функция СоздатьИлиНайтиРодителя(РодительВИсточнике, КорневаяПапкаИсточника, КорневаяПапкаПриемника,
                                 СоответствиеСтатей, АналитикаСтатьиДДС, АналитикаТипыДС, Результат)

    // Якщо батько = корінь джерела, то батько в приймачі = корінь приймача
    Если РодительВИсточнике = КорневаяПапкаИсточника Тогда
        Возврат КорневаяПапкаПриемника;
    КонецЕсли;

    // Перевірити кеш
    РодительВПриемнике = СоответствиеСтатей.Получить(РодительВИсточнике);
    Если РодительВПриемнике <> Неопределено Тогда
        Возврат РодительВПриемнике;
    КонецЕсли;

    // Перевірити чи існує
    СуществующийРодитель = НайтиСтатьюБюджетовПоСтатьеДДС(РодительВИсточнике);
    Если ЗначениеЗаполнено(СуществующийРодитель) Тогда
        СоответствиеСтатей.Вставить(РодительВИсточнике, СуществующийРодитель);
        Возврат СуществующийРодитель;
    КонецЕсли;

    // Рекурсивно отримати батька батька
    РодительИсточникаОбъект = РодительВИсточнике.ПолучитьОбъект();
    ПраРодительВПриемнике = СоздатьИлиНайтиРодителя(РодительИсточникаОбъект.Родитель,
                                                     КорневаяПапкаИсточника, КорневаяПапкаПриемника,
                                                     СоответствиеСтатей, АналитикаСтатьиДДС, АналитикаТипыДС, Результат);

    // Створити батька (це завжди група)
    НовыйРодитель = СоздатьСтатьюБюджетов(РодительВИсточнике,
                                          РодительИсточникаОбъект.Наименование,
                                          Истина, // Це група
                                          ПраРодительВПриемнике,
                                          АналитикаСтатьиДДС, АналитикаТипыДС);

    СоответствиеСтатей.Вставить(РодительВИсточнике, НовыйРодитель);
    Результат.Создано = Результат.Создано + 1;

    Возврат НовыйРодитель;

КонецФункции

&НаСервере
Функция СоздатьСтатьюБюджетов(СтатьяДДС, Наименование, ЭтоГруппа, Родитель, АналитикаСтатьиДДС, АналитикаТипыДС)

    Если ЭтоГруппа Тогда
        НовыйОбъект = Справочники.СтатьиБюджетов.СоздатьГруппу();
    Иначе
        НовыйОбъект = Справочники.СтатьиБюджетов.СоздатьЭлемент();
    КонецЕсли;

    НовыйОбъект.Наименование = Наименование;
    НовыйОбъект.Родитель = Родитель;
    НовыйОбъект.А_СтатьяДвиженияДенежныхСредств = СтатьяДДС;

    // Аналітики тільки для елементів (не груп)
    Если НЕ ЭтоГруппа Тогда
        НовыйОбъект.ВидАналитики1 = АналитикаСтатьиДДС;
        НовыйОбъект.ВидАналитики2 = АналитикаТипыДС;
        НовыйОбъект.КоличествоИспользуемыхАналитик = 2;
    КонецЕсли;

    НовыйОбъект.Записать();

    Возврат НовыйОбъект.Ссылка;

КонецФункции
