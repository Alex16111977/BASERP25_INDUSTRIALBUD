&НаКлиенте
Процедура Заполнить(Команда)

    // Валідація
    Если НЕ ЗначениеЗаполнено(Объект.СтатьяБюджета) Тогда
        Сообщить("Не выбрана статья бюджета (папка-приемник)!");
        Возврат;
    КонецЕсли;

    Если Объект.Статьи.Количество() = 0 Тогда
        Сообщить("Не выбраны статьи движения денежных средств (папки-источники)!");
        Возврат;
    КонецЕсли;

    // Виклик серверної процедури
    Результат = ЗаполнитьНаСервере();

    Сообщить("Создано элементов: " + Результат.Создано);
    Сообщить("Исправлено родителей: " + Результат.Исправлено);
    Сообщить("Пропущено (без изменений): " + Результат.Пропущено);

КонецПроцедуры

&НаСервере
Функция ЗаполнитьНаСервере()

    Результат = Новый Структура("Создано, Исправлено, Пропущено", 0, 0, 0);

    // Отримати аналітики для елементів
    АналитикаСтатьиДДС = ПланыВидовХарактеристик.АналитикиСтатейБюджетов.НайтиПоНаименованию("Статьи ДДС");
    АналитикаТипыДС = ПланыВидовХарактеристик.АналитикиСтатейБюджетов.НайтиПоНаименованию("Типы денежных средств");

    // Для кожної папки-джерела
    Для Каждого СтрокаТаблицы Из Объект.Статьи Цикл

        ПапкаИсточник = СтрокаТаблицы.СтатьяДвиженияДенежныхСредств;

        Если НЕ ЗначениеЗаполнено(ПапкаИсточник) Тогда
            Продолжить;
        КонецЕсли;

        // Обробити папку та всі вкладені елементи
        ОбработатьПапкуИсточник(ПапкаИсточник, Объект.СтатьяБюджета,
                                АналитикаСтатьиДДС, АналитикаТипыДС, Результат);

    КонецЦикла;

    Возврат Результат;

КонецФункции

&НаСервере
Процедура ОбработатьПапкуИсточник(ПапкаИсточник, ПапкаПриемник, АналитикаСтатьиДДС, АналитикаТипыДС, Результат)

    // Кеш відповідності: СтатьяДДС -> СтатьяБюджетов
    СоответствиеСтатей = Новый Соответствие;

    // КРОК 1: Знайти або створити саму папку-джерело як підпапку приймача
    ПодпапкаВПриемнике = НайтиСтатьюБюджетовПоСтатьеДДС(ПапкаИсточник);
    
    Если НЕ ЗначениеЗаполнено(ПодпапкаВПриемнике) Тогда
        // Створити нову підпапку
        ПодпапкаВПриемнике = СоздатьСтатьюБюджетов(ПапкаИсточник, 
                                                    ПапкаИсточник.Наименование,
                                                    Истина, // Це група
                                                    ПапкаПриемник,
                                                    АналитикаСтатьиДДС, АналитикаТипыДС);
        Результат.Создано = Результат.Создано + 1;
    Иначе
        // Перевірити чи батько правильний (має бути ПапкаПриемник)
        Если ПодпапкаВПриемнике.Родитель <> ПапкаПриемник Тогда
            // Виправити батька
            ОбъектПодпапки = ПодпапкаВПриемнике.ПолучитьОбъект();
            ОбъектПодпапки.Родитель = ПапкаПриемник;
            ОбъектПодпапки.Записать();
            ПодпапкаВПриемнике = ОбъектПодпапки.Ссылка;
            Результат.Исправлено = Результат.Исправлено + 1;
        Иначе
            Результат.Пропущено = Результат.Пропущено + 1;
        КонецЕсли;
    КонецЕсли;
    
    // Папка-джерело відповідає СТВОРЕНІЙ/ЗНАЙДЕНІЙ підпапці
    СоответствиеСтатей.Вставить(ПапкаИсточник, ПодпапкаВПриемнике);

    // КРОК 2: Запит на отримання всіх елементів папки-джерела
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |    СтатьиДДС.Ссылка КАК Ссылка,
    |    СтатьиДДС.Наименование КАК Наименование,
    |    СтатьиДДС.ЭтоГруппа КАК ЭтоГруппа,
    |    СтатьиДДС.Родитель КАК Родитель
    |ИЗ
    |    Справочник.СтатьиДвиженияДенежныхСредств КАК СтатьиДДС
    |ГДЕ
    |    СтатьиДДС.Ссылка В ИЕРАРХИИ(&ПапкаИсточник)
    |    И СтатьиДДС.Ссылка <> &ПапкаИсточник
    |УПОРЯДОЧИТЬ ПО
    |    СтатьиДДС.Родитель ИЕРАРХИЯ";

    Запрос.УстановитьПараметр("ПапкаИсточник", ПапкаИсточник);

    // КРОК 3: Обійти всі елементи (впорядковані по рівню для коректного заповнення кешу)
    Выборка = Запрос.Выполнить().Выбрать();

    Пока Выборка.Следующий() Цикл

        СтатьяДДС = Выборка.Ссылка;
        РодительИсточника = Выборка.Родитель;

        // Визначити ПРАВИЛЬНОГО батька в приймачі
        ПравильныйРодитель = СоответствиеСтатей.Получить(РодительИсточника);
        Если ПравильныйРодитель = Неопределено Тогда
            // Батько ще не в кеші - спочатку обробити його
            ПравильныйРодитель = СоздатьИлиНайтиРодителя(РодительИсточника, 
                                                         СоответствиеСтатей,
                                                         АналитикаСтатьиДДС, АналитикаТипыДС, Результат);
        КонецЕсли;

        // Перевірити чи вже є такий елемент в СтатьиБюджетов
        СуществующийЭлемент = НайтиСтатьюБюджетовПоСтатьеДДС(СтатьяДДС);

        Если ЗначениеЗаполнено(СуществующийЭлемент) Тогда
            // Елемент вже існує - ПЕРЕВІРИТИ БАТЬКА!
            Если СуществующийЭлемент.Родитель <> ПравильныйРодитель Тогда
                // Батько НЕПРАВИЛЬНИЙ - виправити!
                ОбъектЭлемента = СуществующийЭлемент.ПолучитьОбъект();
                ОбъектЭлемента.Родитель = ПравильныйРодитель;
                ОбъектЭлемента.Записать();
                СоответствиеСтатей.Вставить(СтатьяДДС, ОбъектЭлемента.Ссылка);
                Результат.Исправлено = Результат.Исправлено + 1;
            Иначе
                // Батько правильний - пропустити
                СоответствиеСтатей.Вставить(СтатьяДДС, СуществующийЭлемент);
                Результат.Пропущено = Результат.Пропущено + 1;
            КонецЕсли;
            Продолжить;
        КонецЕсли;

        // Елемент не існує - створити новий
        НоваяСтатья = СоздатьСтатьюБюджетов(СтатьяДДС, Выборка.Наименование,
                                            Выборка.ЭтоГруппа, ПравильныйРодитель,
                                            АналитикаСтатьиДДС, АналитикаТипыДС);

        СоответствиеСтатей.Вставить(СтатьяДДС, НоваяСтатья);
        Результат.Создано = Результат.Создано + 1;

    КонецЦикла;

КонецПроцедуры

&НаСервере
Функция НайтиСтатьюБюджетовПоСтатьеДДС(СтатьяДДС)

    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |    СтатьиБюджетов.Ссылка КАК Ссылка
    |ИЗ
    |    Справочник.СтатьиБюджетов КАК СтатьиБюджетов
    |ГДЕ
    |    СтатьиБюджетов.А_СтатьяДвиженияДенежныхСредств = &СтатьяДДС";

    Запрос.УстановитьПараметр("СтатьяДДС", СтатьяДДС);

    РезультатЗапроса = Запрос.Выполнить();
    Если НЕ РезультатЗапроса.Пустой() Тогда
        Возврат РезультатЗапроса.Выгрузить()[0].Ссылка;
    КонецЕсли;

    Возврат Неопределено;

КонецФункции

&НаСервере
Функция СоздатьИлиНайтиРодителя(РодительВИсточнике, СоответствиеСтатей,
                                 АналитикаСтатьиДДС, АналитикаТипыДС, Результат)

    // Перевірити кеш
    РодительВПриемнике = СоответствиеСтатей.Получить(РодительВИсточнике);
    Если РодительВПриемнике <> Неопределено Тогда
        Возврат РодительВПриемнике;
    КонецЕсли;

    // Перевірити чи існує в базі
    СуществующийРодитель = НайтиСтатьюБюджетовПоСтатьеДДС(РодительВИсточнике);
    Если ЗначениеЗаполнено(СуществующийРодитель) Тогда
        СоответствиеСтатей.Вставить(РодительВИсточнике, СуществующийРодитель);
        Возврат СуществующийРодитель;
    КонецЕсли;

    // Рекурсивно отримати батька батька
    РодительИсточникаОбъект = РодительВИсточнике.ПолучитьОбъект();
    ПраРодительВПриемнике = СоздатьИлиНайтиРодителя(РодительИсточникаОбъект.Родитель,
                                                     СоответствиеСтатей, АналитикаСтатьиДДС, АналитикаТипыДС, Результат);

    // Створити батька (це завжди група)
    НовыйРодитель = СоздатьСтатьюБюджетов(РодительВИсточнике,
                                          РодительИсточникаОбъект.Наименование,
                                          Истина, // Це група
                                          ПраРодительВПриемнике,
                                          АналитикаСтатьиДДС, АналитикаТипыДС);

    СоответствиеСтатей.Вставить(РодительВИсточнике, НовыйРодитель);
    Результат.Создано = Результат.Создано + 1;

    Возврат НовыйРодитель;

КонецФункции

&НаСервере
Функция СоздатьСтатьюБюджетов(СтатьяДДС, Наименование, ЭтоГруппа, Родитель, АналитикаСтатьиДДС, АналитикаТипыДС)

    Если ЭтоГруппа Тогда
        НовыйОбъект = Справочники.СтатьиБюджетов.СоздатьГруппу();
    Иначе
        НовыйОбъект = Справочники.СтатьиБюджетов.СоздатьЭлемент();
    КонецЕсли;

    НовыйОбъект.Наименование = Наименование;
    НовыйОбъект.Родитель = Родитель;
    НовыйОбъект.А_СтатьяДвиженияДенежныхСредств = СтатьяДДС;

    // Аналітики тільки для елементів (не груп)
    Если НЕ ЭтоГруппа Тогда
        НовыйОбъект.ВидАналитики1 = АналитикаТипыДС;
        НовыйОбъект.ВидАналитики2 = АналитикаСтатьиДДС;
        НовыйОбъект.КоличествоИспользуемыхАналитик = 2;
    КонецЕсли;

    НовыйОбъект.Записать();

    Возврат НовыйОбъект.Ссылка;

КонецФункции
