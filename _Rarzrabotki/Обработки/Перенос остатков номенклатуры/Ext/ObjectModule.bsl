#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

// Процедура завантажує залишки товарів з бухгалтерської бази BuhBud
// через COM-підключення
//
Процедура ЗагрузитьОстатки() Экспорт

    // 1. Перевірка заповнення дати
    Если НЕ ЗначениеЗаполнено(ОкончаниеПериода) Тогда
        ВызватьИсключение "Не вказана дата залишків (Окончание периода)!";
    КонецЕсли;

    // 2. Параметри підключення до бухгалтерської бази
    СтрокаПодключенияБух = "Srvr=""SQLSERVER"";Ref=""BuhBud"";Usr=""1cAdmin"";Pwd=""""";

    // 3. Створення COM-конектора
    V8 = Новый COMОбъект("V83.COMConnector");

    Попытка
        V83 = V8.Connect(СокрЛП(СтрокаПодключенияБух));
    Исключение
        ВызватьИсключение "Помилка підключення до бази BuhBud: " + ОписаниеОшибки();
    КонецПопытки;

    // 4. Формування тексту запиту для отримання залишків
    ТекстЗапроса =
    "ВЫБРАТЬ
    |    Остатки.Счет.Код КАК СчетКод,
    |    ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Номенклатура).Код КАК НоменклатураКод,
    |    ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Номенклатура).Наименование КАК НоменклатураНаименование,
    |    ВЫРАЗИТЬ(Остатки.Субконто3 КАК Справочник.Склады).Код КАК СкладКод,
    |    ВЫРАЗИТЬ(Остатки.Субконто3 КАК Справочник.Склады).Наименование КАК СкладНаименование,
    |    Остатки.КоличествоОстатокДт КАК Количество,
    |    Остатки.СуммаОстатокДт КАК Сумма
    |ИЗ
    |    РегистрБухгалтерии.Хозрасчетный.Остатки(
    |        &ДатаОстатков,
    |        Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.Товары))
    |            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроизводственныеЗапасы))
    |            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ГотоваяПродукция))
    |            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.МалоценныеИБыстроизнашивающиесяПредметы)),
    |    ) КАК Остатки
    |ГДЕ
    |    Остатки.КоличествоОстатокДт > 0";

    // 5. Виконання запиту в бухгалтерській базі
    Попытка
        Запрос = V83.NewObject("Запрос");
        Запрос.Текст = ТекстЗапроса;
        Запрос.УстановитьПараметр("ДатаОстатков", КонецДня(ОкончаниеПериода));

        РезультатЗапроса = Запрос.Выполнить();
        ТЗОстатки = РезультатЗапроса.Выгрузить();
    Исключение
        V83 = Неопределено;
        V8 = Неопределено;
        ВызватьИсключение "Помилка виконання запиту в базі BuhBud: " + ОписаниеОшибки();
    КонецПопытки;

    // 6. Серіалізація таблиці значень для передачі через COM
    Попытка
        стр_ТЗ = V83.ЗначениеВСтрокуВнутр(ТЗОстатки);
    Исключение
        V83 = Неопределено;
        V8 = Неопределено;
        ВызватьИсключение "Помилка серіалізації даних: " + ОписаниеОшибки();
    КонецПопытки;

    // 7. Відключення від бухгалтерської бази
    V83 = Неопределено;
    V8 = Неопределено;

    // 8. Десеріалізація таблиці значень в поточній базі
    ТаблицаОстатков = ЗначениеИзСтрокиВнутр(стр_ТЗ);

    // 9. Очистка табличної частини
    Товары.Очистить();

    // 10. Заповнення табличної частини з зіставленням довідників
    СчетчикОшибок = 0;
    СчетчикЗагружено = 0;

    Для Каждого СтрокаТЗ Из ТаблицаОстатков Цикл

        // 10.1. Пошук номенклатури по коду
        НоменклатураКод = СокрЛП(СтрокаТЗ.НоменклатураКод);
        Если ПустаяСтрока(НоменклатураКод) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Продолжить;
        КонецЕсли;

        НоменклатураЕРП = Справочники.Номенклатура.НайтиПоКоду(НоменклатураКод);
        Если НЕ ЗначениеЗаполнено(НоменклатураЕРП) Тогда
            // Спроба знайти без ведучих нулів
            НоменклатураЕРП = Справочники.Номенклатура.НайтиПоКоду(НоменклатураКод, Истина);
        КонецЕсли;

        Если НЕ ЗначениеЗаполнено(НоменклатураЕРП) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Продолжить; // Номенклатура не знайдена - пропускаємо рядок
        КонецЕсли;

        // 10.2. Пошук складу по коду (якщо вказано)
        СкладЕРП = Неопределено;
        СкладНаименование = СокрЛП(СтрокаТЗ.СкладНаименование);
        Если НЕ ПустаяСтрока(СкладНаименование) Тогда
            СкладЕРП = Справочники.Склады.НайтиПоНаименованию(СкладНаименование);
        КонецЕсли;

        // 10.3. Додавання рядка в табличну частину
        НоваяСтрока = Товары.Добавить();
        НоваяСтрока.Номенклатура = НоменклатураЕРП;
        НоваяСтрока.Склад = СкладЕРП;

        // Рахунок обліку - знайти по коду в ERP
        СчетЕРП = ПланыСчетов.Хозрасчетный.НайтиПоКоду(СокрЛП(СтрокаТЗ.СчетКод));
        НоваяСтрока.СчетУчета = СчетЕРП;

        // Кількість та сума
        НоваяСтрока.Количество = СтрокаТЗ.Количество;
        НоваяСтрока.КоличествоУпаковок = СтрокаТЗ.Количество;

        // Ціна = Сума / Кількість
        Если СтрокаТЗ.Количество <> 0 Тогда
            НоваяСтрока.Цена = СтрокаТЗ.Сумма / СтрокаТЗ.Количество;
        КонецЕсли;

        НоваяСтрока.Сумма = СтрокаТЗ.Сумма;

        СчетчикЗагружено = СчетчикЗагружено + 1;

    КонецЦикла;

    // 11. Виведення статистики
    Если СчетчикОшибок > 0 Тогда
        Сообщить("Завантажено: " + СчетчикЗагружено + " позицій. Помилок зіставлення: " + СчетчикОшибок);
    КонецЕсли;

КонецПроцедуры

// Процедура создает документы "Ввод остатков" по складам
// На каждый склад создается один документ с товарами этого склада
//
Процедура СоздатьДокументыВводаОстатков() Экспорт

    // 1. Проверка заполнения обязательных реквизитов
    Если НЕ ЗначениеЗаполнено(Организация) Тогда
        ВызватьИсключение "Не выбрана организация!";
    КонецЕсли;

    Если Товары.Количество() = 0 Тогда
        ВызватьИсключение "Табличная часть Товары пуста! Сначала загрузите остатки.";
    КонецЕсли;

    Если НЕ ЗначениеЗаполнено(ОкончаниеПериода) Тогда
        ВызватьИсключение "Не указана дата остатков (Окончание периода)!";
    КонецЕсли;

    // 2. Группировка строк по складам
    СкладыТаблица = Товары.Выгрузить(, "Склад");
    СкладыТаблица.Свернуть("Склад");

    СчетчикДокументов = 0;
    СчетчикОшибок = 0;
    СчетчикПропущено = 0;

    // Поиск ставки НДС 20%
    СтавкаНДС20 = Справочники.СтавкиНДС.НайтиПоРеквизиту("Ставка", 20);

    // Дата документа
    ДатаДокумента = КонецДня(ОкончаниеПериода);

    // Хозяйственная операция для проверки и создания документов
    ХозОперация = Перечисления.ХозяйственныеОперации.ВводОстатковСобственныхТоваров;

    // 3. Создание документов по каждому складу
    Для Каждого СтрокаСклада Из СкладыТаблица Цикл

        Если НЕ ЗначениеЗаполнено(СтрокаСклада.Склад) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Сообщить("Пропущены строки без указания склада");
            Продолжить;
        КонецЕсли;

        // 3.1. Проверка существования документа с такими параметрами
        ЗапросПроверки = Новый Запрос;
        ЗапросПроверки.Текст =
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |    ВводОстатков.Ссылка КАК Ссылка
        |ИЗ
        |    Документ.ВводОстатков КАК ВводОстатков
        |ГДЕ
        |    ВводОстатков.Организация = &Организация
        |    И ВводОстатков.Склад = &Склад
        |    И ВводОстатков.Дата = &Дата
        |    И ВводОстатков.ХозяйственнаяОперация = &ХозяйственнаяОперация";

        ЗапросПроверки.УстановитьПараметр("Организация", Организация);
        ЗапросПроверки.УстановитьПараметр("Склад", СтрокаСклада.Склад);
        ЗапросПроверки.УстановитьПараметр("Дата", ДатаДокумента);
        ЗапросПроверки.УстановитьПараметр("ХозяйственнаяОперация", ХозОперация);

        РезультатПроверки = ЗапросПроверки.Выполнить();
        Если НЕ РезультатПроверки.Пустой() Тогда
            ВыборкаПроверки = РезультатПроверки.Выбрать();
            ВыборкаПроверки.Следующий();
            Сообщить("Документ для склада " + СтрокаСклада.Склад + " уже существует: " + ВыборкаПроверки.Ссылка);
            СчетчикПропущено = СчетчикПропущено + 1; 
			 // 3.2. Создание нового документа
        НовыйДокумент = Документы.ВводОстатков.СоздатьДокумент();

	Иначе    
		Выборка = РезультатПроверки.Выбрать(); 
		Выборка.Следующий();
		
		 // 3.2. Создание нового документа
        НовыйДокумент = Выборка.Ссылка.ПолучитьОбъект();
	
        КонецЕсли;

               НовыйДокумент.Дата = ДатаДокумента;
        НовыйДокумент.Организация = Организация;
        НовыйДокумент.Склад = СтрокаСклада.Склад;
        НовыйДокумент.ХозяйственнаяОперация = ХозОперация;   
		
		
		 НовыйДокумент.ОтражатьВОперативномУчете = Истина;
		 НовыйДокумент.ОтражатьСебестоимость = Истина;
		 НовыйДокумент.ОтражатьВБУиНУ = Истина;
		 НовыйДокумент.ОтражатьВУУ = Истина;
 
		 
		 НовыйДокумент = СтрокаСклада.Склад.Подразделение;
        НовыйДокумент.Комментарий = "Создано обработкой переноса остатков " + Формат(ТекущаяДатаСеанса(), "ДЛФ=DT");

        // 3.3. Отбор строк для текущего склада
        СтруктураОтбора = Новый Структура("Склад", СтрокаСклада.Склад);
        СтрокиСклада = Товары.НайтиСтроки(СтруктураОтбора);

        // 3.4. Заполнение табличной части документа
        Для Каждого СтрокаТовара Из СтрокиСклада Цикл
            НоваяСтрокаДок = НовыйДокумент.Товары.Добавить();
            НоваяСтрокаДок.Номенклатура = СтрокаТовара.Номенклатура;
            НоваяСтрокаДок.Количество = СтрокаТовара.Количество;
            НоваяСтрокаДок.КоличествоУпаковок = СтрокаТовара.КоличествоУпаковок;
            НоваяСтрокаДок.Цена = СтрокаТовара.Цена;
            НоваяСтрокаДок.Сумма = СтрокаТовара.Сумма;

            // Заполнение ставки НДС и сумм НДС
            Если ЗначениеЗаполнено(СтавкаНДС20) Тогда
                НоваяСтрокаДок.СтавкаНДС = СтавкаНДС20;
                // Расчет суммы НДС (сумма включает НДС, т.е. НДС = Сумма * 20 / 120)
                НоваяСтрокаДок.СуммаНДС = Окр(СтрокаТовара.Сумма * 20 / 120, 2);
                НоваяСтрокаДок.СуммаБезНДС = СтрокаТовара.Сумма - НоваяСтрокаДок.СуммаНДС;
            КонецЕсли;

            // Дополнительные реквизиты из обработки, если заполнены
            Если ЗначениеЗаполнено(СтрокаТовара.Характеристика) Тогда
                НоваяСтрокаДок.Характеристика = СтрокаТовара.Характеристика;
            КонецЕсли;

            Если ЗначениеЗаполнено(СтрокаТовара.Назначение) Тогда
                НоваяСтрокаДок.Назначение = СтрокаТовара.Назначение;
            КонецЕсли;

            Если ЗначениеЗаполнено(СтрокаТовара.Упаковка) Тогда
                НоваяСтрокаДок.Упаковка = СтрокаТовара.Упаковка;
            КонецЕсли;

        КонецЦикла;

        // 3.5. Запись документа
        Попытка
            НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение);
            СчетчикДокументов = СчетчикДокументов + 1;
            Сообщить("Создан документ: " + НовыйДокумент.Ссылка + " (склад: " + СтрокаСклада.Склад + ")");
        Исключение
            СчетчикОшибок = СчетчикОшибок + 1;
            Сообщить("Ошибка создания документа для склада " + СтрокаСклада.Склад + ": " + ОписаниеОшибки());
        КонецПопытки;

    КонецЦикла;

    // 4. Вывод результата
    Сообщить("===============================================");
    Сообщить("Создано документов ввода остатков: " + СчетчикДокументов);
    Если СчетчикПропущено > 0 Тогда
        Сообщить("Пропущено (уже существуют): " + СчетчикПропущено);
    КонецЕсли;
    Если СчетчикОшибок > 0 Тогда
        Сообщить("Ошибок: " + СчетчикОшибок);
    КонецЕсли;

КонецПроцедуры

#КонецЕсли