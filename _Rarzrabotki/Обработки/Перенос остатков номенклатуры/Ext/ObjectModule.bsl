#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

// Процедура завантажує залишки товарів з бухгалтерської бази BuhBud
// через COM-підключення
//
Процедура ЗагрузитьОстатки() Экспорт

    // 1. Перевірка заповнення дати
    Если НЕ ЗначениеЗаполнено(ОкончаниеПериода) Тогда
        ВызватьИсключение "Не вказана дата залишків (Окончание периода)!";
    КонецЕсли;

    // 2. Параметри підключення до бухгалтерської бази
    СтрокаПодключенияБух = "Srvr=""SQLSERVER"";Ref=""BuhBud"";Usr=""1cAdmin"";Pwd=""""";

    // 3. Створення COM-конектора
    V8 = Новый COMОбъект("V83.COMConnector");

    Попытка
        V83 = V8.Connect(СокрЛП(СтрокаПодключенияБух));
    Исключение
        ВызватьИсключение "Помилка підключення до бази BuhBud: " + ОписаниеОшибки();
    КонецПопытки;

    // 4. Формування тексту запиту для отримання залишків
    ТекстЗапроса =
    "ВЫБРАТЬ
    |	Остатки.Счет.Код КАК СчетКод,
    |	ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Номенклатура).Код КАК НоменклатураКод,
    |	ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Номенклатура).Наименование КАК НоменклатураНаименование,
    |	ВЫРАЗИТЬ(Остатки.Субконто3 КАК Справочник.Склады).Код КАК СкладКод,
    |	ВЫРАЗИТЬ(Остатки.Субконто3 КАК Справочник.Склады).Наименование КАК СкладНаименование,
    |	Остатки.КоличествоОстатокДт КАК Количество,
    |	Остатки.СуммаОстатокДт КАК Сумма,
    |	Остатки.Организация.КодПоЕДРПОУ КАК ОрганизацияКодПоЕДРПОУ
    |ИЗ
    |	РегистрБухгалтерии.Хозрасчетный.Остатки(
    |			&ДатаОстатков,
    |			Счет В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.Товары))
    |				ИЛИ Счет В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроизводственныеЗапасы))
    |				ИЛИ Счет В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ГотоваяПродукция))
    |				ИЛИ Счет В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.МалоценныеИБыстроизнашивающиесяПредметы)),
    |			,
    |			) КАК Остатки
    |ГДЕ
    |	Остатки.КоличествоОстатокДт > 0";
	

    // 5. Виконання запиту в бухгалтерській базі
    Попытка
        Запрос = V83.NewObject("Запрос");
        Запрос.Текст = ТекстЗапроса;
        Запрос.УстановитьПараметр("ДатаОстатков", КонецДня(ОкончаниеПериода));

        РезультатЗапроса = Запрос.Выполнить();
        ТЗОстатки = РезультатЗапроса.Выгрузить();
    Исключение
        V83 = Неопределено;
        V8 = Неопределено;
        ВызватьИсключение "Помилка виконання запиту в базі BuhBud: " + ОписаниеОшибки();
    КонецПопытки;

    // 6. Серіалізація таблиці значень для передачі через COM
    Попытка
        стр_ТЗ = V83.ЗначениеВСтрокуВнутр(ТЗОстатки);
    Исключение
        V83 = Неопределено;
        V8 = Неопределено;
        ВызватьИсключение "Помилка серіалізації даних: " + ОписаниеОшибки();
    КонецПопытки;

    // 7. Відключення від бухгалтерської бази
    V83 = Неопределено;
    V8 = Неопределено;

    // 8. Десеріалізація таблиці значень в поточній базі
    ТаблицаОстатков = ЗначениеИзСтрокиВнутр(стр_ТЗ);

    // 9. Очистка табличної частини
    Товары.Очистить();

    // 10. Заповнення табличної частини з зіставленням довідників
    СчетчикОшибок = 0;
    СчетчикЗагружено = 0;

    Для Каждого СтрокаТЗ Из ТаблицаОстатков Цикл
         Если СокрЛП(СтрокаТЗ.СчетКод)="2051" Тогда
		 
		 СтрокаТЗ.СчетКод = "205";	
		 
	 КонецЕсли; 
	 
	   Если СокрЛП(СтрокаТЗ.СчетКод)="2072" Тогда
		 
		 СтрокаТЗ.СчетКод = "207";	
		 
	 КонецЕсли; 
	 
        // 10.1. Пошук номенклатури по коду
        НоменклатураКод = СокрЛП(СтрокаТЗ.НоменклатураКод);
        Если ПустаяСтрока(НоменклатураКод) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Продолжить;
        КонецЕсли;

        НоменклатураЕРП = Справочники.Номенклатура.НайтиПоКоду(НоменклатураКод);
        Если НЕ ЗначениеЗаполнено(НоменклатураЕРП) Тогда
            // Спроба знайти без ведучих нулів
            НоменклатураЕРП = Справочники.Номенклатура.НайтиПоКоду(НоменклатураКод, Истина);
        КонецЕсли;

        Если НЕ ЗначениеЗаполнено(НоменклатураЕРП) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Продолжить; // Номенклатура не знайдена - пропускаємо рядок
        КонецЕсли;

        // 10.2. Пошук складу по коду (якщо вказано)
        СкладЕРП = Неопределено;
        СкладНаименование = СокрЛП(СтрокаТЗ.СкладНаименование);
        Если НЕ ПустаяСтрока(СкладНаименование) Тогда
            СкладЕРП = Справочники.Склады.НайтиПоНаименованию(СкладНаименование);
        КонецЕсли;

        // 10.3. Додавання рядка в табличну частину
        НоваяСтрока = Товары.Добавить();
        НоваяСтрока.Номенклатура = НоменклатураЕРП;
        НоваяСтрока.Склад = СкладЕРП;

        // Рахунок обліку - знайти по коду в ERP
        СчетЕРП = ПланыСчетов.Хозрасчетный.НайтиПоКоду(СокрЛП(СтрокаТЗ.СчетКод));
        НоваяСтрока.СчетУчета = СчетЕРП;
		
		Если ЗначениеЗаполнено(НоваяСтрока.СчетУчета) и ЗначениеЗаполнено(НоваяСтрока.Номенклатура)
			 Тогда
		
		НоваяСтрока.ВидНоменклатуры = Справочники.ВидыНоменклатуры.НайтиПоРеквизиту("А_СчетБухгалтерский",НоваяСтрока.СчетУчета);	
		НоваяСтрока.Организация = Справочники.Организации.НайтиПоРеквизиту("КодПоЕДРПОУ",СтрокаТЗ.ОрганизацияКодПоЕДРПОУ);
		
		КонецЕсли;
		
		Если ЗначениеЗаполнено(НоваяСтрока.СчетУчета)
			И ЗначениеЗаполнено(НоваяСтрока.Номенклатура)
			И ЗначениеЗаполнено(НоваяСтрока.Номенклатура.ВидНоменклатуры<>НоваяСтрока.ВидНоменклатуры) 
			Тогда
			
			Попытка
			
			СпрНоменклатура=НоваяСтрока.Номенклатура.ПолучитьОбъект();
			СпрНоменклатура.ВидНоменклатуры = НоваяСтрока.ВидНоменклатуры;
			СпрНоменклатура.А_СчетУчетаБух = НоваяСтрока.А_СчетУчетаБух;
            СпрНоменклатура.А_Организация = НоваяСтрока.Организация;
			СпрНоменклатура.ОбменДанными.Загрузка = Истина;
			СпрНоменклатура.Записать();
			
	
			
		Исключение 
			ТекстСообщения = "Ошибка обновления реквизита ВидНоменклатуры в карточке номенклатуры "+СокрЛП(НоваяСтрока.Номенклатура)+"с кодом ("+СокрЛП(НоваяСтрока.Номенклатура.Код)+")";
			  ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			ТекстСообщения,
			НоваяСтрока.Номенклатура);
			КонецПопытки;
					КонецЕсли; 
   
        // Кількість та сума
        НоваяСтрока.Количество = СтрокаТЗ.Количество;
        НоваяСтрока.КоличествоУпаковок = СтрокаТЗ.Количество;

        // Ціна = Сума / Кількість
        Если СтрокаТЗ.Количество <> 0 Тогда
            НоваяСтрока.Цена = СтрокаТЗ.Сумма / СтрокаТЗ.Количество;
        КонецЕсли;

        НоваяСтрока.Сумма = СтрокаТЗ.Сумма;

        СчетчикЗагружено = СчетчикЗагружено + 1;

    КонецЦикла;

    // 11. Виведення статистики
    Если СчетчикОшибок > 0 Тогда
        Сообщить("Завантажено: " + СчетчикЗагружено + " позицій. Помилок зіставлення: " + СчетчикОшибок);
    КонецЕсли;

КонецПроцедуры

// Процедура создает документы "Ввод остатков" по складам
// На каждый склад создается один документ с товарами этого склада
// Если документ с такими параметрами уже существует - обновляет его
//
Процедура СоздатьДокументыВводаОстатков() Экспорт

    // 1. Проверка заполнения обязательных реквизитов
    Если НЕ ЗначениеЗаполнено(Организация) Тогда
        ВызватьИсключение "Не выбрана организация!";
    КонецЕсли;

    Если Товары.Количество() = 0 Тогда
        ВызватьИсключение "Табличная часть Товары пуста! Сначала загрузите остатки.";
    КонецЕсли;

    Если НЕ ЗначениеЗаполнено(ОкончаниеПериода) Тогда
        ВызватьИсключение "Не указана дата остатков (Окончание периода)!";
    КонецЕсли;

    // 2. Группировка строк по складам
    СкладыТаблица = Товары.Выгрузить(, "Склад");
    СкладыТаблица.Свернуть("Склад");

    СчетчикДокументов = 0;
    СчетчикОшибок = 0;
    СчетчикОбновлено = 0;

    // Поиск ставки НДС 20%
    СтавкаНДС20 = Справочники.СтавкиНДС.НайтиПоРеквизиту("Ставка", 20);

    // Дата документа
    ДатаДокумента = КонецДня(ОкончаниеПериода);

    // Получение коэффициента пересчёта валют (из управленческой в регламентированную)
    ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
    ВалютаУправленческогоУчета = Константы.ВалютаУправленческогоУчета.Получить();
    КоэффициентПересчетаИзВалютыУпрВРегл = РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(
        ВалютаУправленческогоУчета,
        ВалютаРегламентированногоУчета,
        ДатаДокумента);

    // Для ввода остатков цена обычно не включает НДС
    ЦенаВключаетНДС = Ложь;

    // Хозяйственная операция для проверки и создания документов
    ХозОперация = Перечисления.ХозяйственныеОперации.ВводОстатковСобственныхТоваров;

    // 3. Создание/обновление документов по каждому складу
    Для Каждого СтрокаСклада Из СкладыТаблица Цикл

        Если НЕ ЗначениеЗаполнено(СтрокаСклада.Склад) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Сообщить("Пропущены строки без указания склада");
            Продолжить;
        КонецЕсли;

        // 3.1. Проверка существования документа с такими параметрами
        ЗапросПроверки = Новый Запрос;
        ЗапросПроверки.Текст =
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |    ВводОстатков.Ссылка КАК Ссылка
        |ИЗ
        |    Документ.ВводОстатков КАК ВводОстатков
        |ГДЕ
        |    ВводОстатков.Организация = &Организация
        |    И ВводОстатков.Склад = &Склад
        |    И ВводОстатков.Дата = &Дата
        |    И ВводОстатков.ХозяйственнаяОперация = &ХозяйственнаяОперация";

        ЗапросПроверки.УстановитьПараметр("Организация", Организация);
        ЗапросПроверки.УстановитьПараметр("Склад", СтрокаСклада.Склад);
        ЗапросПроверки.УстановитьПараметр("Дата", ДатаДокумента);
        ЗапросПроверки.УстановитьПараметр("ХозяйственнаяОперация", ХозОперация);

        РезультатПроверки = ЗапросПроверки.Выполнить();

        ЭтоОбновление = Ложь;

        Если НЕ РезультатПроверки.Пустой() Тогда
            // Документ существует - получаем его для обновления
            ВыборкаПроверки = РезультатПроверки.Выбрать();
            ВыборкаПроверки.Следующий();

            // 3.2. Получение объекта существующего документа для обновления
            ДокументОбъект = ВыборкаПроверки.Ссылка.ПолучитьОбъект();

            // Очистка табличной части Товары перед заполнением новыми данными
            ДокументОбъект.Товары.Очистить();

            // Установка комментария для обновленного документа
            ДокументОбъект.Комментарий = "Обновлено обработкой переноса остатков " + Формат(ТекущаяДатаСеанса(), "ДЛФ=DT");

            ЭтоОбновление = Истина;
        Иначе
            // Документ не существует - создаем новый
            ДокументОбъект = Документы.ВводОстатков.СоздатьДокумент();

            // Установка комментария для нового документа
            ДокументОбъект.Комментарий = "Создано обработкой переноса остатков " + Формат(ТекущаяДатаСеанса(), "ДЛФ=DT");
        КонецЕсли;

        // 3.3. Заполнение основных реквизитов документа
        ДокументОбъект.Дата = ДатаДокумента;
        ДокументОбъект.Организация = Организация;
        ДокументОбъект.Склад = СтрокаСклада.Склад;
        ДокументОбъект.ХозяйственнаяОперация = ХозОперация;
        ДокументОбъект.НалоговоеНазначение = Справочники.НалоговыеНазначенияАктивовИЗатрат.НДС_Облагаемая;
		
        // 3.4. Заполнение дополнительных реквизитов документа
        ДокументОбъект.ОтражатьВОперативномУчете = Истина;
        ДокументОбъект.ОтражатьСебестоимость = Истина;
        ДокументОбъект.ОтражатьВБУиНУ = Истина;
        ДокументОбъект.ОтражатьВУУ = Истина;
        ДокументОбъект.Подразделение = СтрокаСклада.Склад.Подразделение;
        ДокументОбъект.ЦенаВключаетНДС = ЦенаВключаетНДС;

        // 3.5. Отбор строк для текущего склада
        СтруктураОтбора = Новый Структура("Склад", СтрокаСклада.Склад);
        СтрокиСклада = Товары.НайтиСтроки(СтруктураОтбора);

        // 3.6. Заполнение табличной части документа
        Для Каждого СтрокаТовара Из СтрокиСклада Цикл
            НоваяСтрокаДок = ДокументОбъект.Товары.Добавить();
            НоваяСтрокаДок.Номенклатура = СтрокаТовара.Номенклатура;
            НоваяСтрокаДок.Количество = СтрокаТовара.Количество;
            НоваяСтрокаДок.Цена = СтрокаТовара.Цена;

            // Дополнительные реквизиты из обработки, если заполнены
            Если ЗначениеЗаполнено(СтрокаТовара.Характеристика) Тогда
                НоваяСтрокаДок.Характеристика = СтрокаТовара.Характеристика;
            КонецЕсли;

            Если ЗначениеЗаполнено(СтрокаТовара.Назначение) Тогда
                НоваяСтрокаДок.Назначение = СтрокаТовара.Назначение;
            КонецЕсли;

            Если ЗначениеЗаполнено(СтрокаТовара.Упаковка) Тогда
                НоваяСтрокаДок.Упаковка = СтрокаТовара.Упаковка;
            КонецЕсли;

            // ===== РАСЧЁТ ВСЕХ ПОЛЕЙ СТРОКИ =====

            // 1. Коэффициент упаковки и количество упаковок
            КоэффициентУпаковки = 1;
            Если ЗначениеЗаполнено(НоваяСтрокаДок.Упаковка) Тогда
                КоэффициентУпаковки = НоваяСтрокаДок.Упаковка.Коэффициент;
                Если КоэффициентУпаковки = 0 Тогда
                    КоэффициентУпаковки = 1;
                КонецЕсли;
            КонецЕсли;
            НоваяСтрокаДок.КоличествоУпаковок = НоваяСтрокаДок.Количество / КоэффициентУпаковки;

            // 2. Сумма = Количество * Цена
            НоваяСтрокаДок.Сумма = НоваяСтрокаДок.Количество * НоваяСтрокаДок.Цена;

            // 3. Заполнение ставки НДС
            Если ЗначениеЗаполнено(СтавкаНДС20) Тогда
                НоваяСтрокаДок.СтавкаНДС = СтавкаНДС20;
            КонецЕсли;

            // 4. Расчёт суммы НДС с использованием типовой функции
            СтавкаНДСЧисло = УчетНДСУПКлиентСервер.ЗначениеСтавкиНДС(НоваяСтрокаДок.СтавкаНДС);
            НоваяСтрокаДок.СуммаНДС = Окр(УчетНДСУПКлиентСервер.РассчитатьСуммуНДС(
                НоваяСтрокаДок.Сумма,
                СтавкаНДСЧисло,
                ЦенаВключаетНДС), 2, РежимОкругления.Окр15как20);

            // 5. СуммаСНДС - сумма с НДС
            Если ЦенаВключаетНДС Тогда
                НоваяСтрокаДок.СуммаСНДС = НоваяСтрокаДок.Сумма;
            Иначе
                НоваяСтрокаДок.СуммаСНДС = НоваяСтрокаДок.Сумма + НоваяСтрокаДок.СуммаНДС;
            КонецЕсли;

            // 6. СуммаБезНДС - сумма без НДС
            Если ЦенаВключаетНДС Тогда
                НоваяСтрокаДок.СуммаБезНДС = Окр(НоваяСтрокаДок.Сумма - НоваяСтрокаДок.СуммаНДС, 2, РежимОкругления.Окр15как20);
            Иначе
                НоваяСтрокаДок.СуммаБезНДС = НоваяСтрокаДок.Сумма;
            КонецЕсли;

            // 7. СуммаРегл - сумма в регламентированной валюте
            НоваяСтрокаДок.СуммаРегл = Окр(НоваяСтрокаДок.СуммаБезНДС * КоэффициентПересчетаИзВалютыУпрВРегл, 2, РежимОкругления.Окр15как20);

            // 8. НДСРегл - НДС в регламентированной валюте
            НоваяСтрокаДок.НДСРегл = Окр(УчетНДСУПКлиентСервер.РассчитатьСуммуНДС(
                НоваяСтрокаДок.СуммаРегл,
                СтавкаНДСЧисло,
                Ложь), 2, РежимОкругления.Окр15как20);

        КонецЦикла;

        // 3.7. Запись документа
        Попытка
            ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);

            Если ЭтоОбновление Тогда
                СчетчикОбновлено = СчетчикОбновлено + 1;
                Сообщить("Документ для склада " + СтрокаСклада.Склад + " обновлён: " + ДокументОбъект.Ссылка);
            Иначе
                СчетчикДокументов = СчетчикДокументов + 1;
                Сообщить("Создан документ: " + ДокументОбъект.Ссылка + " (склад: " + СтрокаСклада.Склад + ")");
            КонецЕсли;
        Исключение
            СчетчикОшибок = СчетчикОшибок + 1;
            Сообщить("Ошибка обработки документа для склада " + СтрокаСклада.Склад + ": " + ОписаниеОшибки());
        КонецПопытки;

    КонецЦикла;

    // 4. Вывод результата
    Сообщить("===============================================");
    Сообщить("Создано документов ввода остатков: " + СчетчикДокументов);
    Если СчетчикОбновлено > 0 Тогда
        Сообщить("Обновлено существующих: " + СчетчикОбновлено);
    КонецЕсли;
    Если СчетчикОшибок > 0 Тогда
        Сообщить("Ошибок: " + СчетчикОшибок);
    КонецЕсли;

КонецПроцедуры

#КонецЕсли