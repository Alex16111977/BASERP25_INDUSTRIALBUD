
&НаКлиенте
Процедура ЗагрузитьОстатки(Команда)

    // Перевірка заповнення дати
    Если НЕ ЗначениеЗаполнено(Объект.ОкончаниеПериода) Тогда
        ПоказатьПредупреждение(, "Вкажіть дату залишків (Окончание периода)!");
        Возврат;
    КонецЕсли;

    // Підтвердження операції
    ОписаниеОповещения = Новый ОписаниеОповещения("ЗагрузитьОстаткиЗавершение", ЭтотОбъект);
    ПоказатьВопрос(ОписаниеОповещения,
        "Завантажити залишки з бази BuhBud на дату " + Формат(Объект.ОкончаниеПериода, "ДЛФ=D") + "?
        |
        |Поточні дані в табличній частині будуть очищені!",
        РежимДиалогаВопрос.ДаНет,
        ,
        КодВозвратаДиалога.Нет,
        "Завантаження залишків");

КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьОстаткиЗавершение(Результат, ДополнительныеПараметры) Экспорт

    Если Результат <> КодВозвратаДиалога.Да Тогда
        Возврат;
    КонецЕсли;

    // Показати стан
    Состояние("Завантаження залишків з BuhBud...");

    Попытка
        КоличествоЗагружено = ЗагрузитьОстаткиНаСервере();
        ПоказатьПредупреждение(, "Завантажено " + КоличествоЗагружено + " позицій");
    Исключение
        ПоказатьПредупреждение(, "Помилка: " + ОписаниеОшибки());
    КонецПопытки;

КонецПроцедуры

&НаСервере
Функция ЗагрузитьОстаткиНаСервере()

    ОбъектОбработки = РеквизитФормыВЗначение("Объект");
    ОбъектОбработки.ЗагрузитьОстатки();
    ЗначениеВРеквизитФормы(ОбъектОбработки, "Объект");

    Возврат Объект.Товары.Количество();

КонецФункции

// Обробник ПриСозданииНаСервере - встановлення значень за замовчуванням
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

    // Встановити поточну дату як дату залишків за замовчуванням
    Если НЕ ЗначениеЗаполнено(Объект.ОкончаниеПериода) Тогда
        Объект.ОкончаниеПериода = КонецМесяца(ТекущаяДатаСеанса());
    КонецЕсли;

КонецПроцедуры

// Команда создания документов ввода остатков
&НаКлиенте
Процедура СоздатьДокументы(Команда)

    // Проверка заполнения организации
    Если НЕ ЗначениеЗаполнено(Объект.Организация) Тогда
        ПоказатьПредупреждение(, "Необходимо выбрать организацию!");
        Возврат;
    КонецЕсли;

    // Проверка заполнения даты
    Если НЕ ЗначениеЗаполнено(Объект.ОкончаниеПериода) Тогда
        ПоказатьПредупреждение(, "Необходимо указать дату остатков (Окончание периода)!");
        Возврат;
    КонецЕсли;

    // Проверка наличия данных
    Если Объект.Товары.Количество() = 0 Тогда
        ПоказатьПредупреждение(, "Табличная часть Товары пуста! Сначала загрузите остатки.");
        Возврат;
    КонецЕсли;

    // Подтверждение операции
    ОписаниеОповещения = Новый ОписаниеОповещения("СоздатьДокументыЗавершение", ЭтотОбъект);
    ПоказатьВопрос(ОписаниеОповещения,
        "Создать документы ввода остатков на дату " + Формат(Объект.ОкончаниеПериода, "ДЛФ=D") + "?
        |
        |Будет создан отдельный документ для каждого склада.
        |Организация: " + Объект.Организация + "
        |Строк в табличной части: " + Объект.Товары.Количество(),
        РежимДиалогаВопрос.ДаНет,
        ,
        КодВозвратаДиалога.Нет,
        "Создание документов ввода остатков");

КонецПроцедуры

&НаКлиенте
Процедура СоздатьДокументыЗавершение(Результат, ДополнительныеПараметры) Экспорт

    Если Результат <> КодВозвратаДиалога.Да Тогда
        Возврат;
    КонецЕсли;

    // Показать состояние
    Состояние("Создание документов ввода остатков...");

    Попытка
        СоздатьДокументыНаСервере();
        ПоказатьПредупреждение(, "Документы успешно созданы! Подробности см. в сообщениях.");
    Исключение
        ПоказатьПредупреждение(, "Ошибка: " + ОписаниеОшибки());
    КонецПопытки;

КонецПроцедуры

&НаСервере
Процедура СоздатьДокументыНаСервере()

    ОбъектОбработки = РеквизитФормыВЗначение("Объект");
    ОбъектОбработки.СоздатьДокументыВводаОстатков();
    ЗначениеВРеквизитФормы(ОбъектОбработки, "Объект");

КонецПроцедуры

