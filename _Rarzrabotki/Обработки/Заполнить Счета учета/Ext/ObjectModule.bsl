#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

// Процедура заполняет табличную часть Товары данными из регистра бухгалтерии Хозрасчетный
// Определяет счет учета и организацию для каждой номенклатуры на основе остатков
//
Процедура ЗаполнитьТаблицу() Экспорт

    Товары.Очистить();

    // Запрос: отримати залишки з субконто Номенклатура
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ РАЗРЕШЕННЫЕ
    |    Остатки.Организация КАК Организация,
    |    Остатки.Счет КАК Счет,
    |    Остатки.Субконто1 КАК Номенклатура
    |ПОМЕСТИТЬ ВТ_Остатки
    |ИЗ
    |    РегистрБухгалтерии.Хозрасчетный.Остатки(
    |        &ДатаОкончания,
    |        Счет.Код ПОДОБНО ""20%""
    |            ИЛИ Счет.Код ПОДОБНО ""28%""
    |            ИЛИ Счет.Код ПОДОБНО ""22%""
    |            ИЛИ Счет.Код ПОДОБНО ""23%""
    |            ИЛИ Счет.Код ПОДОБНО ""26%"",
    |        ,
    |    ) КАК Остатки
    |ГДЕ
    |    НЕ Остатки.Субконто1 = НЕОПРЕДЕЛЕНО
    |    И Остатки.Субконто1 ССЫЛКА Справочник.Номенклатура
    |    И (&Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
    |        ИЛИ Остатки.Организация = &Организация)
    |
    |СГРУППИРОВАТЬ ПО
    |    Остатки.Субконто1,
    |    Остатки.Счет,
    |    Остатки.Организация
    |;
    |
    |////////////////////////////////////////////////////////////////////////////////
    |ВЫБРАТЬ
    |    ВТ_Остатки.Номенклатура КАК Номенклатура,
    |    ВТ_Остатки.Счет КАК СчетУчета,
    |    ВТ_Остатки.Организация КАК Организация,
    |    ВТ_Остатки.Номенклатура.А_СчетУчетаБух КАК ТекущийСчет,
    |    ВТ_Остатки.Номенклатура.А_Организация КАК ТекущаяОрганизация
    |ИЗ
    |    ВТ_Остатки КАК ВТ_Остатки
    |ГДЕ
    |    НЕ &ТолькоПустые
    |    ИЛИ (ВТ_Остатки.Номенклатура.А_СчетУчетаБух = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПустаяСсылка)
    |        ИЛИ ВТ_Остатки.Номенклатура.А_СчетУчетаБух = НЕОПРЕДЕЛЕНО)";

    // Установка параметров запроса
    Если ЗначениеЗаполнено(ДатаОкончания) Тогда
        Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаОкончания));
    Иначе
        Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ТекущаяДата()));
    КонецЕсли;

    Запрос.УстановитьПараметр("Организация", Организация);
    Запрос.УстановитьПараметр("ТолькоПустые", ТолькоПустые);

    Попытка
        Результат = Запрос.Выполнить();
    Исключение
        ВызватьИсключение "Помилка виконання запиту: " + ОписаниеОшибки();
    КонецПопытки;

    Выборка = Результат.Выбрать();

    СчетчикЗагружено = 0;

    Пока Выборка.Следующий() Цикл

        НоваяСтрока = Товары.Добавить();
        НоваяСтрока.Номенклатура = Выборка.Номенклатура;
        НоваяСтрока.СчетУчета = Выборка.СчетУчета;
        НоваяСтрока.Организация = Выборка.Организация;
        НоваяСтрока.ТекущийСчет = Выборка.ТекущийСчет;
        НоваяСтрока.ТекущаяОрганизация = Выборка.ТекущаяОрганизация;
        НоваяСтрока.Обработано = Ложь;

        СчетчикЗагружено = СчетчикЗагружено + 1;

    КонецЦикла;

    Сообщить("Загружено позиций: " + СчетчикЗагружено);

КонецПроцедуры

// Процедура обновляет карточки номенклатуры полями А_СчетУчетаБух и А_Организация
// на основе данных табличной части Товары
//
Процедура ОбновитьКарточкиНоменклатуры() Экспорт

    КоличествоОбновленных = 0;
    КоличествоОшибок = 0;
    КоличествоПропущенных = 0;

    Для Каждого СтрокаТовары Из Товары Цикл

        // Пропускаємо вже оброблені рядки
        Если СтрокаТовары.Обработано Тогда
            Продолжить;
        КонецЕсли;

        // Пропускаємо якщо значення не змінилися
        Если СтрокаТовары.СчетУчета = СтрокаТовары.ТекущийСчет
            И СтрокаТовары.Организация = СтрокаТовары.ТекущаяОрганизация Тогда
            СтрокаТовары.Обработано = Истина;
            КоличествоПропущенных = КоличествоПропущенных + 1;
            Продолжить;
        КонецЕсли;

        Попытка

            СпрНоменклатура = СтрокаТовары.Номенклатура.ПолучитьОбъект();

            Если СпрНоменклатура = Неопределено Тогда
                КоличествоОшибок = КоличествоОшибок + 1;
                Сообщить("Номенклатура не знайдена: " + СтрокаТовары.Номенклатура);
                Продолжить;
            КонецЕсли;

            // Оновлюємо поля в картці номенклатури
            СпрНоменклатура.А_СчетУчетаБух = СтрокаТовары.СчетУчета;
            СпрНоменклатура.А_Организация = СтрокаТовары.Организация;

            // Записуємо без перевірок і обробників подій
            СпрНоменклатура.ОбменДанными.Загрузка = Истина;
            СпрНоменклатура.Записать();

            СтрокаТовары.Обработано = Истина;
            КоличествоОбновленных = КоличествоОбновленных + 1;

        Исключение
            КоличествоОшибок = КоличествоОшибок + 1;
            Сообщить("Ошибка при обновлении " + СтрокаТовары.Номенклатура + ": " + ОписаниеОшибки());
        КонецПопытки;

    КонецЦикла;

    // Виведення результатів
    Сообщить("===============================================");
    Сообщить("Обновлено карточек: " + КоличествоОбновленных);
    Если КоличествоПропущенных > 0 Тогда
        Сообщить("Пропущено (без изменений): " + КоличествоПропущенных);
    КонецЕсли;
    Если КоличествоОшибок > 0 Тогда
        Сообщить("Ошибок: " + КоличествоОшибок);
    КонецЕсли;

КонецПроцедуры

// Процедура очищает табличную часть Товары
//
Процедура ОчиститьТаблицу() Экспорт

    Товары.Очистить();
    Сообщить("Таблица очищена");

КонецПроцедуры

#КонецЕсли
