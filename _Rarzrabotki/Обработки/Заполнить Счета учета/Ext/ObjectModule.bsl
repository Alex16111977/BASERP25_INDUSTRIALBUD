#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

// Процедура заполняет табличную часть Товары данными из регистра бухгалтерии Хозрасчетный
// Определяет счет учета и организацию для каждой номенклатуры на основе оборотов за период
//
Процедура ЗаполнитьТаблицу() Экспорт

    Товары.Очистить();

    // Запрос: отримати обороти з субконто Номенклатура за період
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ РАЗРЕШЕННЫЕ
    |    Обороты.Организация КАК Организация,
    |    Обороты.Счет КАК Счет,
    |    Обороты.Субконто1 КАК Номенклатура
    |ПОМЕСТИТЬ ВТ_Обороты
    |ИЗ
    |    РегистрБухгалтерии.Хозрасчетный.Обороты(
    |        &НачалоПериода,
    |        &КонецПериода,
    |        ,
    |        Счет.Код ПОДОБНО ""20%""
    |            ИЛИ Счет.Код ПОДОБНО ""28%""
    |            ИЛИ Счет.Код ПОДОБНО ""22%""
    |            ИЛИ Счет.Код ПОДОБНО ""23%""
    |            ИЛИ Счет.Код ПОДОБНО ""26%"",
    |        ,
    |    ) КАК Обороты
    |ГДЕ
    |    НЕ Обороты.Субконто1 = НЕОПРЕДЕЛЕНО
    |    И Обороты.Субконто1 ССЫЛКА Справочник.Номенклатура
    |
    |СГРУППИРОВАТЬ ПО
    |    Обороты.Субконто1,
    |    Обороты.Счет,
    |    Обороты.Организация
    |;
    |
    |////////////////////////////////////////////////////////////////////////////////
    |ВЫБРАТЬ
    |    ВТ_Обороты.Номенклатура КАК Номенклатура,
    |    ВТ_Обороты.Счет КАК СчетУчета,
    |    ВТ_Обороты.Организация КАК Организация,
    |    ВТ_Обороты.Номенклатура.А_СчетУчетаБух КАК ТекущийСчет,
    |    ВТ_Обороты.Номенклатура.А_Организация КАК ТекущаяОрганизация
    |ИЗ
    |    ВТ_Обороты КАК ВТ_Обороты
    |ГДЕ
    |    НЕ &ТолькоПустые
    |    ИЛИ (ВТ_Обороты.Номенклатура.А_СчетУчетаБух = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПустаяСсылка)
    |        ИЛИ ВТ_Обороты.Номенклатура.А_СчетУчетаБух = НЕОПРЕДЕЛЕНО)";

    // Встановлення параметрів періоду
    Если ЗначениеЗаполнено(НачалоПериода) Тогда
        Запрос.УстановитьПараметр("НачалоПериода", НачалоДня(НачалоПериода));
    Иначе
        Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ТекущаяДата()));
    КонецЕсли;

    Если ЗначениеЗаполнено(КонецПериода) Тогда
        Запрос.УстановитьПараметр("КонецПериода", КонецДня(КонецПериода));
    Иначе
        Запрос.УстановитьПараметр("КонецПериода", КонецДня(ТекущаяДата()));
    КонецЕсли;

    Запрос.УстановитьПараметр("ТолькоПустые", ТолькоПустые);

    Попытка
        Результат = Запрос.Выполнить();
    Исключение
        ВызватьИсключение "Помилка виконання запиту: " + ОписаниеОшибки();
    КонецПопытки;

    Выборка = Результат.Выбрать();

    СчетчикЗагружено = 0;

    Пока Выборка.Следующий() Цикл

        НоваяСтрока = Товары.Добавить();
        НоваяСтрока.Номенклатура = Выборка.Номенклатура;
        НоваяСтрока.СчетУчета = Выборка.СчетУчета;
        НоваяСтрока.Организация = Выборка.Организация;
        НоваяСтрока.ТекущийСчет = Выборка.ТекущийСчет;
        НоваяСтрока.ТекущаяОрганизация = Выборка.ТекущаяОрганизация;
        НоваяСтрока.Обработано = Ложь;

        СчетчикЗагружено = СчетчикЗагружено + 1;

    КонецЦикла;

    Сообщить("Загружено позиций: " + СчетчикЗагружено);

КонецПроцедуры

// Процедура обновляет карточки номенклатуры полями А_СчетУчетаБух и А_Организация
// на основе данных табличной части Товары
// Организация определяется с приоритетом: А_Привилегированный.А_ПолучитьОрганизациюУпр() > организация из оборотов
//
Процедура ОбновитьКарточкиНоменклатуры() Экспорт

    КоличествоОбновленных = 0;
    КоличествоОшибок = 0;
    КоличествоПропущенных = 0;

    // Отримати організацію УПР з привілейованого режиму
    ОрганизацияУпр = А_Привилегированный.А_ПолучитьОрганизациюУпр();

    Для Каждого СтрокаТовары Из Товары Цикл

        // Пропускаємо вже оброблені рядки
        Если СтрокаТовары.Обработано Тогда
            Продолжить;
        КонецЕсли;

        // Визначити організацію з пріоритетом
        ОрганизацияДляЗаписи = ?(ЗначениеЗаполнено(ОрганизацияУпр),
                                 ОрганизацияУпр,
                                 СтрокаТовары.Организация);

        // Пропускаємо якщо значення не змінилися (з урахуванням пріоритету)
        Если СтрокаТовары.СчетУчета = СтрокаТовары.ТекущийСчет
            И ОрганизацияДляЗаписи = СтрокаТовары.ТекущаяОрганизация Тогда
            СтрокаТовары.Обработано = Истина;
            КоличествоПропущенных = КоличествоПропущенных + 1;
            Продолжить;
        КонецЕсли;

        Попытка

            СпрНоменклатура = СтрокаТовары.Номенклатура.ПолучитьОбъект();

            Если СпрНоменклатура = Неопределено Тогда
                КоличествоОшибок = КоличествоОшибок + 1;
                Сообщить("Номенклатура не знайдена: " + СтрокаТовары.Номенклатура);
                Продолжить;
            КонецЕсли;

            // Оновлюємо поля в картці номенклатури
            СпрНоменклатура.А_СчетУчетаБух = СтрокаТовары.СчетУчета;
            // Використовуємо організацію з пріоритетом
            СпрНоменклатура.А_Организация = ОрганизацияДляЗаписи;

            // Записуємо без перевірок і обробників подій
            СпрНоменклатура.ОбменДанными.Загрузка = Истина;
            СпрНоменклатура.Записать();

            СтрокаТовары.Обработано = Истина;
            КоличествоОбновленных = КоличествоОбновленных + 1;

        Исключение
            КоличествоОшибок = КоличествоОшибок + 1;
            Сообщить("Ошибка при обновлении " + СтрокаТовары.Номенклатура + ": " + ОписаниеОшибки());
        КонецПопытки;

    КонецЦикла;

    // Виведення результатів
    Сообщить("===============================================");
    Сообщить("Обновлено карточек: " + КоличествоОбновленных);
    Если ЗначениеЗаполнено(ОрганизацияУпр) Тогда
        Сообщить("Организация (приоритет): " + ОрганизацияУпр);
    КонецЕсли;
    Если КоличествоПропущенных > 0 Тогда
        Сообщить("Пропущено (без изменений): " + КоличествоПропущенных);
    КонецЕсли;
    Если КоличествоОшибок > 0 Тогда
        Сообщить("Ошибок: " + КоличествоОшибок);
    КонецЕсли;

КонецПроцедуры

// Процедура очищает табличную часть Товары
//
Процедура ОчиститьТаблицу() Экспорт

    Товары.Очистить();
    Сообщить("Таблица очищена");

КонецПроцедуры

#КонецЕсли
