=== РЕЗУЛЬТАТ КРОКУ 5: КОД МОДУЛЯ ОБ'ЄКТА ===
Дата: 2025-11-29

Використані дані з попередніх кроків:
- Рахунки: Товары (28), ПроизводственныеЗапасы (20), ГотоваяПродукция (26), МБП (22)
- Регістр: Хозрасчетный
- Зіставлення: по Коду через НайтиПоКоду()
- Запит: з step4_query_text.txt

КОД:
----- початок -----
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

// Процедура завантажує залишки товарів з бухгалтерської бази BuhBud
// через COM-підключення
//
Процедура ЗагрузитьОстатки() Экспорт

    // 1. Перевірка заповнення дати
    Если НЕ ЗначениеЗаполнено(ОкончаниеПериода) Тогда
        ВызватьИсключение "Не вказана дата залишків (Окончание периода)!";
    КонецЕсли;

    // 2. Параметри підключення до бухгалтерської бази
    СтрокаПодключенияБух = "Srvr=""SQLSERVER"";Ref=""BuhBud"";Usr=""1cAdmin"";Pwd=""""";

    // 3. Створення COM-конектора
    V8 = Новый COMОбъект("V83.COMConnector");

    Попытка
        V83 = V8.Connect(СокрЛП(СтрокаПодключенияБух));
    Исключение
        ВызватьИсключение "Помилка підключення до бази BuhBud: " + ОписаниеОшибки();
    КонецПопытки;

    // 4. Формування тексту запиту для отримання залишків
    ТекстЗапроса =
    "ВЫБРАТЬ
    |    Остатки.Счет.Код КАК СчетКод,
    |    ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Номенклатура).Код КАК НоменклатураКод,
    |    ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Номенклатура).Наименование КАК НоменклатураНаименование,
    |    ВЫРАЗИТЬ(Остатки.Субконто2 КАК Справочник.Склады).Код КАК СкладКод,
    |    ВЫРАЗИТЬ(Остатки.Субконто2 КАК Справочник.Склады).Наименование КАК СкладНаименование,
    |    Остатки.КоличествоОстатокДт КАК Количество,
    |    Остатки.СуммаОстатокДт КАК Сумма
    |ИЗ
    |    РегистрБухгалтерии.Хозрасчетный.Остатки(
    |        &ДатаОстатков,
    |        Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.Товары))
    |            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроизводственныеЗапасы))
    |            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ГотоваяПродукция))
    |            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.МалоценныеИБыстроизнашивающиесяПредметы)),
    |    ) КАК Остатки
    |ГДЕ
    |    Остатки.КоличествоОстатокДт > 0";

    // 5. Виконання запиту в бухгалтерській базі
    Попытка
        Запрос = V83.NewObject("Запрос");
        Запрос.Текст = ТекстЗапроса;
        Запрос.УстановитьПараметр("ДатаОстатков", КонецДня(ОкончаниеПериода));

        РезультатЗапроса = Запрос.Выполнить();
        ТЗОстатки = РезультатЗапроса.Выгрузить();
    Исключение
        V83 = Неопределено;
        V8 = Неопределено;
        ВызватьИсключение "Помилка виконання запиту в базі BuhBud: " + ОписаниеОшибки();
    КонецПопытки;

    // 6. Серіалізація таблиці значень для передачі через COM
    Попытка
        стр_ТЗ = V83.ЗначениеВСтрокуВнутр(ТЗОстатки);
    Исключение
        V83 = Неопределено;
        V8 = Неопределено;
        ВызватьИсключение "Помилка серіалізації даних: " + ОписаниеОшибки();
    КонецПопытки;

    // 7. Відключення від бухгалтерської бази
    V83 = Неопределено;
    V8 = Неопределено;

    // 8. Десеріалізація таблиці значень в поточній базі
    ТаблицаОстатков = ЗначениеИзСтрокиВнутр(стр_ТЗ);

    // 9. Очистка табличної частини
    Товары.Очистить();

    // 10. Заповнення табличної частини з зіставленням довідників
    СчетчикОшибок = 0;
    СчетчикЗагружено = 0;

    Для Каждого СтрокаТЗ Из ТаблицаОстатков Цикл

        // 10.1. Пошук номенклатури по коду
        НоменклатураКод = СокрЛП(СтрокаТЗ.НоменклатураКод);
        Если ПустаяСтрока(НоменклатураКод) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Продолжить;
        КонецЕсли;

        НоменклатураЕРП = Справочники.Номенклатура.НайтиПоКоду(НоменклатураКод);
        Если НЕ ЗначениеЗаполнено(НоменклатураЕРП) Тогда
            // Спроба знайти без ведучих нулів
            НоменклатураЕРП = Справочники.Номенклатура.НайтиПоКоду(НоменклатураКод, Истина);
        КонецЕсли;

        Если НЕ ЗначениеЗаполнено(НоменклатураЕРП) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Продолжить; // Номенклатура не знайдена - пропускаємо рядок
        КонецЕсли;

        // 10.2. Пошук складу по коду (якщо вказано)
        СкладЕРП = Неопределено;
        СкладКод = СокрЛП(СтрокаТЗ.СкладКод);
        Если НЕ ПустаяСтрока(СкладКод) Тогда
            СкладЕРП = Справочники.Склады.НайтиПоКоду(СкладКод);
            Если НЕ ЗначениеЗаполнено(СкладЕРП) Тогда
                СкладЕРП = Справочники.Склады.НайтиПоКоду(СкладКод, Истина);
            КонецЕсли;
        КонецЕсли;

        // 10.3. Додавання рядка в табличну частину
        НоваяСтрока = Товары.Добавить();
        НоваяСтрока.Номенклатура = НоменклатураЕРП;

        // Кількість та сума
        НоваяСтрока.Количество = СтрокаТЗ.Количество;
        НоваяСтрока.КоличествоУпаковок = СтрокаТЗ.Количество;

        // Ціна = Сума / Кількість
        Если СтрокаТЗ.Количество <> 0 Тогда
            НоваяСтрока.Цена = СтрокаТЗ.Сумма / СтрокаТЗ.Количество;
        КонецЕсли;

        НоваяСтрока.Сумма = СтрокаТЗ.Сумма;

        СчетчикЗагружено = СчетчикЗагружено + 1;

    КонецЦикла;

    // 11. Виведення статистики
    Если СчетчикОшибок > 0 Тогда
        Сообщить("Завантажено: " + СчетчикЗагружено + " позицій. Помилок зіставлення: " + СчетчикОшибок);
    КонецЕсли;

КонецПроцедуры

#КонецЕсли
----- кінець -----

ПРИМІТКИ:
1. Код використовує COM-підключення V83.COMConnector
2. Рядок підключення: Srvr="SQLSERVER";Ref="BuhBud";Usr="1cAdmin";Pwd=""
3. Серіалізація через ЗначениеВСтрокуВнутр/ЗначениеИзСтрокиВнутр
4. Зіставлення по Коду через НайтиПоКоду()
5. Обробка помилок з підрахунком незіставлених позицій

СТРУКТУРА ТАБЛИЧНОЇ ЧАСТИНИ Товары (з обробки):
- Номенклатура: CatalogRef.Номенклатура
- Характеристика: CatalogRef.ХарактеристикиНоменклатуры
- Назначение: CatalogRef.Назначения
- Упаковка: CatalogRef.УпаковкиЕдиницыИзмерения
- КоличествоУпаковок: Number(15,3)
- Количество: Number(15,3)
- Цена: ДенежнаяСуммаНеотрицательная
- Сумма: ДенежнаяСуммаНеотрицательная
