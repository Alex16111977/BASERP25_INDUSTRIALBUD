=== ФІНАЛЬНИЙ РЕЗУЛЬТАТ: ОБРОБКА ПЕРЕНОСУ ЗАЛИШКІВ ===
Дата: 2025-11-29

================================================================================
1. АНАЛІЗ МЕТАДАНИХ
================================================================================

ПЛАН РАХУНКІВ BuhBud:
- Назва: Хозрасчетный
- Тип субконто: ВидыСубконтоХозрасчетные
- Максимум субконто: 3

РАХУНКИ ДЛЯ ЗАПАСІВ:
- 20 (ПроизводственныеЗапасы) - група
- 201 (СырьеИМатериалы) - кількісний
- 209 (ДругиеМатериалы) - кількісний
- 22 (МалоценныеИБыстроизнашивающиесяПредметы) - кількісний
- 26 (ГотоваяПродукция) - кількісний
- 28 (Товары) - група
- 281 (ТоварыНаСкладе) - кількісний
- 283 (ТоварыНаКомиссии) - кількісний
- 284 (ТараПодТоварами) - кількісний
- 289 (ТоварыВТорговлеПоПокупнойСтоимости) - кількісний

РЕГІСТР БУХГАЛТЕРІЇ:
- Назва: Хозрасчетный
- Ресурси: Сумма, ВалютнаяСумма, Количество, СуммаНУ
- Виміри: Организация, Валюта, НалоговоеНазначение

ЗІСТАВЛЕННЯ ДОВІДНИКІВ:
- Номенклатура: по Коду (String 11)
- Склады: по Коду (String 9)

================================================================================
2. ТЕКСТ ЗАПИТУ
================================================================================

ВЫБРАТЬ
    Остатки.Счет.Код КАК СчетКод,
    ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Номенклатура).Код КАК НоменклатураКод,
    ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Номенклатура).Наименование КАК НоменклатураНаименование,
    ВЫРАЗИТЬ(Остатки.Субконто2 КАК Справочник.Склады).Код КАК СкладКод,
    ВЫРАЗИТЬ(Остатки.Субконто2 КАК Справочник.Склады).Наименование КАК СкладНаименование,
    Остатки.КоличествоОстатокДт КАК Количество,
    Остатки.СуммаОстатокДт КАК Сумма
ИЗ
    РегистрБухгалтерии.Хозрасчетный.Остатки(
        &ДатаОстатков,
        Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.Товары))
            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроизводственныеЗапасы))
            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ГотоваяПродукция))
            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.МалоценныеИБыстроизнашивающиесяПредметы)),
    ) КАК Остатки
ГДЕ
    Остатки.КоличествоОстатокДт > 0

================================================================================
3. КОД МОДУЛЯ ОБ'ЄКТА
================================================================================

#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

// Процедура завантажує залишки товарів з бухгалтерської бази BuhBud
// через COM-підключення
//
Процедура ЗагрузитьОстатки() Экспорт

    // 1. Перевірка заповнення дати
    Если НЕ ЗначениеЗаполнено(ОкончаниеПериода) Тогда
        ВызватьИсключение "Не вказана дата залишків (Окончание периода)!";
    КонецЕсли;

    // 2. Параметри підключення до бухгалтерської бази
    СтрокаПодключенияБух = "Srvr=""SQLSERVER"";Ref=""BuhBud"";Usr=""1cAdmin"";Pwd=""""";

    // 3. Створення COM-конектора
    V8 = Новый COMОбъект("V83.COMConnector");

    Попытка
        V83 = V8.Connect(СокрЛП(СтрокаПодключенияБух));
    Исключение
        ВызватьИсключение "Помилка підключення до бази BuhBud: " + ОписаниеОшибки();
    КонецПопытки;

    // 4. Формування тексту запиту для отримання залишків
    ТекстЗапроса =
    "ВЫБРАТЬ
    |    Остатки.Счет.Код КАК СчетКод,
    |    ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Номенклатура).Код КАК НоменклатураКод,
    |    ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Номенклатура).Наименование КАК НоменклатураНаименование,
    |    ВЫРАЗИТЬ(Остатки.Субконто2 КАК Справочник.Склады).Код КАК СкладКод,
    |    ВЫРАЗИТЬ(Остатки.Субконто2 КАК Справочник.Склады).Наименование КАК СкладНаименование,
    |    Остатки.КоличествоОстатокДт КАК Количество,
    |    Остатки.СуммаОстатокДт КАК Сумма
    |ИЗ
    |    РегистрБухгалтерии.Хозрасчетный.Остатки(
    |        &ДатаОстатков,
    |        Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.Товары))
    |            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроизводственныеЗапасы))
    |            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ГотоваяПродукция))
    |            ИЛИ Счет В ИЕРАРХИИ(ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.МалоценныеИБыстроизнашивающиесяПредметы)),
    |    ) КАК Остатки
    |ГДЕ
    |    Остатки.КоличествоОстатокДт > 0";

    // 5. Виконання запиту в бухгалтерській базі
    Попытка
        Запрос = V83.NewObject("Запрос");
        Запрос.Текст = ТекстЗапроса;
        Запрос.УстановитьПараметр("ДатаОстатков", КонецДня(ОкончаниеПериода));

        РезультатЗапроса = Запрос.Выполнить();
        ТЗОстатки = РезультатЗапроса.Выгрузить();
    Исключение
        V83 = Неопределено;
        V8 = Неопределено;
        ВызватьИсключение "Помилка виконання запиту в базі BuhBud: " + ОписаниеОшибки();
    КонецПопытки;

    // 6. Серіалізація таблиці значень для передачі через COM
    Попытка
        стр_ТЗ = V83.ЗначениеВСтрокуВнутр(ТЗОстатки);
    Исключение
        V83 = Неопределено;
        V8 = Неопределено;
        ВызватьИсключение "Помилка серіалізації даних: " + ОписаниеОшибки();
    КонецПопытки;

    // 7. Відключення від бухгалтерської бази
    V83 = Неопределено;
    V8 = Неопределено;

    // 8. Десеріалізація таблиці значень в поточній базі
    ТаблицаОстатков = ЗначениеИзСтрокиВнутр(стр_ТЗ);

    // 9. Очистка табличної частини
    Товары.Очистить();

    // 10. Заповнення табличної частини з зіставленням довідників
    СчетчикОшибок = 0;
    СчетчикЗагружено = 0;

    Для Каждого СтрокаТЗ Из ТаблицаОстатков Цикл

        // 10.1. Пошук номенклатури по коду
        НоменклатураКод = СокрЛП(СтрокаТЗ.НоменклатураКод);
        Если ПустаяСтрока(НоменклатураКод) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Продолжить;
        КонецЕсли;

        НоменклатураЕРП = Справочники.Номенклатура.НайтиПоКоду(НоменклатураКод);
        Если НЕ ЗначениеЗаполнено(НоменклатураЕРП) Тогда
            // Спроба знайти без ведучих нулів
            НоменклатураЕРП = Справочники.Номенклатура.НайтиПоКоду(НоменклатураКод, Истина);
        КонецЕсли;

        Если НЕ ЗначениеЗаполнено(НоменклатураЕРП) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Продолжить; // Номенклатура не знайдена - пропускаємо рядок
        КонецЕсли;

        // 10.2. Пошук складу по коду (якщо вказано)
        СкладЕРП = Неопределено;
        СкладКод = СокрЛП(СтрокаТЗ.СкладКод);
        Если НЕ ПустаяСтрока(СкладКод) Тогда
            СкладЕРП = Справочники.Склады.НайтиПоКоду(СкладКод);
            Если НЕ ЗначениеЗаполнено(СкладЕРП) Тогда
                СкладЕРП = Справочники.Склады.НайтиПоКоду(СкладКод, Истина);
            КонецЕсли;
        КонецЕсли;

        // 10.3. Додавання рядка в табличну частину
        НоваяСтрока = Товары.Добавить();
        НоваяСтрока.Номенклатура = НоменклатураЕРП;

        // Кількість та сума
        НоваяСтрока.Количество = СтрокаТЗ.Количество;
        НоваяСтрока.КоличествоУпаковок = СтрокаТЗ.Количество;

        // Ціна = Сума / Кількість
        Если СтрокаТЗ.Количество <> 0 Тогда
            НоваяСтрока.Цена = СтрокаТЗ.Сумма / СтрокаТЗ.Количество;
        КонецЕсли;

        НоваяСтрока.Сумма = СтрокаТЗ.Сумма;

        СчетчикЗагружено = СчетчикЗагружено + 1;

    КонецЦикла;

    // 11. Виведення статистики
    Если СчетчикОшибок > 0 Тогда
        Сообщить("Завантажено: " + СчетчикЗагружено + " позицій. Помилок зіставлення: " + СчетчикОшибок);
    КонецЕсли;

КонецПроцедуры

#КонецЕсли

================================================================================
4. КОД МОДУЛЯ ФОРМИ
================================================================================

&НаКлиенте
Процедура ЗагрузитьОстатки(Команда)

    // Перевірка заповнення дати
    Если НЕ ЗначениеЗаполнено(Объект.ОкончаниеПериода) Тогда
        ПоказатьПредупреждение(, "Вкажіть дату залишків (Окончание периода)!");
        Возврат;
    КонецЕсли;

    // Підтвердження операції
    ОписаниеОповещения = Новый ОписаниеОповещения("ЗагрузитьОстаткиЗавершение", ЭтотОбъект);
    ПоказатьВопрос(ОписаниеОповещения,
        "Завантажити залишки з бази BuhBud на дату " + Формат(Объект.ОкончаниеПериода, "ДЛФ=D") + "?
        |
        |Поточні дані в табличній частині будуть очищені!",
        РежимДиалогаВопрос.ДаНет,
        ,
        КодВозвратаДиалога.Нет,
        "Завантаження залишків");

КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьОстаткиЗавершение(Результат, ДополнительныеПараметры) Экспорт

    Если Результат <> КодВозвратаДиалога.Да Тогда
        Возврат;
    КонецЕсли;

    // Показати стан
    Состояние("Завантаження залишків з BuhBud...");

    Попытка
        КоличествоЗагружено = ЗагрузитьОстаткиНаСервере();
        ПоказатьПредупреждение(, "Завантажено " + КоличествоЗагружено + " позицій");
    Исключение
        ПоказатьПредупреждение(, "Помилка: " + ОписаниеОшибки());
    КонецПопытки;

КонецПроцедуры

&НаСервере
Функция ЗагрузитьОстаткиНаСервере()

    ОбъектОбработки = РеквизитФормыВЗначение("Объект");
    ОбъектОбработки.ЗагрузитьОстатки();
    ЗначениеВРеквизитФормы(ОбъектОбработки, "Объект");

    Возврат Объект.Товары.Количество();

КонецФункции

// Обробник ПриСозданииНаСервере - встановлення значень за замовчуванням
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

    // Встановити поточну дату як дату залишків за замовчуванням
    Если НЕ ЗначениеЗаполнено(Объект.ОкончаниеПериода) Тогда
        Объект.ОкончаниеПериода = КонецМесяца(ТекущаяДатаСеанса());
    КонецЕсли;

КонецПроцедуры

================================================================================
5. ІНСТРУКЦІЯ ПО ВПРОВАДЖЕННЮ
================================================================================

КРОК 1: МОДУЛЬ ОБ'ЄКТА
- Відкрити обробку А_ПереносОстатковНоменклатуры в конфігураторі
- Відкрити модуль об'єкта обробки
- Скопіювати код з розділу "3. КОД МОДУЛЯ ОБ'ЄКТА"

КРОК 2: МОДУЛЬ ФОРМИ
- Відкрити форму "Форма" обробки
- Відкрити модуль форми
- Скопіювати код з розділу "4. КОД МОДУЛЯ ФОРМИ"

КРОК 3: КОМАНДА НА ФОРМІ
- Переконатися, що команда "ЗагрузитьОстатки" існує на формі
- Якщо немає - створити команду з назвою "ЗагрузитьОстатки"
- Прив'язати команду до кнопки на формі

КРОК 4: ПЕРЕВІРКА ПІДКЛЮЧЕННЯ
- Переконатися, що:
  * Сервер 1С (SQLSERVER) доступний
  * База BuhBud існує на сервері
  * Користувач 1cAdmin має права доступу
  * На сервері встановлено COM-конектор V83.COMConnector

ПАРАМЕТРИ ПІДКЛЮЧЕННЯ:
Srvr="SQLSERVER";Ref="BuhBud";Usr="1cAdmin";Pwd=""

ТЕСТУВАННЯ:
1. Відкрити обробку
2. Вказати дату залишків (Окончание периода)
3. Натиснути кнопку "Завантажити залишки"
4. Перевірити заповнення табличної частини

================================================================================
СТРУКТУРА ПРОМІЖНИХ ФАЙЛІВ
================================================================================

_Rarzrabotki/Обработки/test/
├── step1_chart_of_accounts.txt    # Результат аналізу плану рахунків
├── step2_accounting_register.txt   # Результат аналізу регістра бухгалтерії
├── step3_catalogs_mapping.txt      # Результат аналізу зіставлення довідників
├── step4_query_text.txt            # Сформований текст запиту
├── step5_module_code.txt           # Код модуля об'єкта
├── step6_form_code.txt             # Код модуля форми
└── step7_final_result.txt          # Фінальний результат (цей файл)
