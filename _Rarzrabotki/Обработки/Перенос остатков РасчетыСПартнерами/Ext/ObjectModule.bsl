#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

// Процедура завантажує залишки взаєморозрахунків з бухгалтерської бази BuhBud
// через COM-підключення
//
Процедура ЗагрузитьОстатки() Экспорт

    // 1. Перевірка заповнення дати
    Если НЕ ЗначениеЗаполнено(ОкончаниеПериода) Тогда
        ВызватьИсключение "Не вказана дата залишків (Окончание периода)!";
    КонецЕсли;

    // 2. Параметри підключення до бухгалтерської бази
    СтрокаПодключенияБух = "Srvr=""SQLSERVER"";Ref=""BuhBud"";Usr=""1cAdmin"";Pwd=""""";

    // 3. Створення COM-конектора
    V8 = Новый COMОбъект("V83.COMConnector");

    Попытка
        V83 = V8.Connect(СокрЛП(СтрокаПодключенияБух));
    Исключение
        ВызватьИсключение "Помилка підключення до бази BuhBud: " + ОписаниеОшибки();
    КонецПопытки;

    // 4. Формування списку рахунків для запиту
    Если НЕ ЗначениеЗаполнено(СчетаВзаиморасчетов) Тогда
        СчетаВзаиморасчетов = "361,631,371,681,632,377";
    КонецЕсли;

    // 5. Формування тексту запиту для отримання залишків
    ТекстЗапроса =
    "ВЫБРАТЬ
    |   Остатки.Счет КАК Счет,
    |   Остатки.Счет.Код КАК КодСчета,
    |   Остатки.Организация КАК Организация,
    |   Остатки.Организация.КодПоЕДРПОУ КАК ОрганизацияКодПоЕДРПОУ,
    |   Остатки.Субконто1 КАК Контрагент,
    |   ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Контрагенты).Код КАК КонтрагентКод,
    |   ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Контрагенты).Наименование КАК КонтрагентНаименование,
    |   ВЫРАЗИТЬ(Остатки.Субконто1 КАК Справочник.Контрагенты).ИНН КАК КонтрагентИНН,
    |   Остатки.Субконто2 КАК Договор,
    |   ВЫРАЗИТЬ(Остатки.Субконто2 КАК Справочник.ДоговорыКонтрагентов).Наименование КАК ДоговорНаименование,
    |   ВЫРАЗИТЬ(Остатки.Субконто2 КАК Справочник.ДоговорыКонтрагентов).Номер КАК ДоговорНомер,
    |   Остатки.Субконто3 КАК ДокументРасчетов,
    |   Остатки.Валюта КАК Валюта,
    |   Остатки.Валюта.Код КАК ВалютаКод,
    |   Остатки.СуммаОстатокДт КАК СуммаДт,
    |   Остатки.СуммаОстатокКт КАК СуммаКт,
    |   Остатки.СуммаОстатокДт - Остатки.СуммаОстатокКт КАК Сумма,
    |   Остатки.ВалютнаяСуммаОстатокДт КАК ВалютнаяСуммаДт,
    |   Остатки.ВалютнаяСуммаОстатокКт КАК ВалютнаяСуммаКт,
    |   Остатки.ВалютнаяСуммаОстатокДт - Остатки.ВалютнаяСуммаОстатокКт КАК ВалютнаяСумма
    |ИЗ
    |   РегистрБухгалтерии.Хозрасчетный.Остатки(
    |       &ДатаОстатков,
    |       Счет.Код В (&СписокСчетов),
    |       ,
    |       ) КАК Остатки
    |ГДЕ
    |   (Остатки.СуммаОстатокДт <> 0 ИЛИ Остатки.СуммаОстатокКт <> 0)";

    // 6. Виконання запиту в бухгалтерській базі
    Попытка
        Запрос = V83.NewObject("Запрос");
        Запрос.Текст = ТекстЗапроса;
        Запрос.УстановитьПараметр("ДатаОстатков", КонецДня(ОкончаниеПериода));

        // Формуємо масив кодів рахунків
        МассивСчетов = V83.NewObject("Массив");
        СписокКодов = СтрРазделить(СчетаВзаиморасчетов, ",", Ложь);
        Для Каждого КодСчета Из СписокКодов Цикл
            МассивСчетов.Добавить(СокрЛП(КодСчета));
        КонецЦикла;
        Запрос.УстановитьПараметр("СписокСчетов", МассивСчетов);

        РезультатЗапроса = Запрос.Выполнить();
        ТЗОстатки = РезультатЗапроса.Выгрузить();
    Исключение
        V83 = Неопределено;
        V8 = Неопределено;
        ВызватьИсключение "Помилка виконання запиту в базі BuhBud: " + ОписаниеОшибки();
    КонецПопытки;

    // 7. Серіалізація таблиці значень для передачі через COM
    Попытка
        стр_ТЗ = V83.ЗначениеВСтрокуВнутр(ТЗОстатки);
    Исключение
        V83 = Неопределено;
        V8 = Неопределено;
        ВызватьИсключение "Помилка серіалізації даних: " + ОписаниеОшибки();
    КонецПопытки;

    // 8. Відключення від бухгалтерської бази
    V83 = Неопределено;
    V8 = Неопределено;

    // 9. Десеріалізація таблиці значень в поточній базі
    ТаблицаОстатков = ЗначениеИзСтрокиВнутр(стр_ТЗ);

    // 10. Очистка табличної частини
    РасчетыСПартнерами.Очистить();

    // 11. Заповнення табличної частини з зіставленням довідників
    СчетчикОшибок = 0;
    СчетчикЗагружено = 0;

    // Отримання валюти за замовчуванням
    ВалютаРеглУчета = Константы.ВалютаРегламентированногоУчета.Получить();

    Для Каждого СтрокаТЗ Из ТаблицаОстатков Цикл

        // 11.1. Визначення хоз.операції за рахунком та сумою
        КодСчета = СокрЛП(СтрокаТЗ.КодСчета);
        СуммаОстатка = СтрокаТЗ.Сумма;

        ХозОперация = ОпределитьХозОперацию(КодСчета, СуммаОстатка);
        Если ХозОперация = Неопределено Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Сообщить("Невідомий тип рахунку: " + КодСчета);
            Продолжить;
        КонецЕсли;

        // 11.2. Пошук контрагента в ERP по ІНН або наименованию
        КонтрагентЕРП = Неопределено;
        КонтрагентИНН = СокрЛП(СтрокаТЗ.КонтрагентИНН);
        КонтрагентНаименование = СокрЛП(СтрокаТЗ.КонтрагентНаименование);

        Если НЕ ПустаяСтрока(КонтрагентИНН) Тогда
            // Пошук по коду ЄДРПОУ (в ERP реквізит називається "КодПоЕДРПОУ")
            КонтрагентЕРП = Справочники.Контрагенты.НайтиПоРеквизиту("КодПоЕДРПОУ", КонтрагентИНН);
        КонецЕсли;

        Если НЕ ЗначениеЗаполнено(КонтрагентЕРП) И НЕ ПустаяСтрока(КонтрагентНаименование) Тогда
            КонтрагентЕРП = Справочники.Контрагенты.НайтиПоНаименованию(КонтрагентНаименование, Истина);
        КонецЕсли;

        // 11.3. Пошук партнера
        ПартнерЕРП = Неопределено;
        Если ЗначениеЗаполнено(КонтрагентЕРП) Тогда
            ПартнерЕРП = КонтрагентЕРП.Партнер;
        КонецЕсли;

        // 11.4. Пошук договору
        ДоговорЕРП = Неопределено;
        ДоговорНомер = СокрЛП(СтрокаТЗ.ДоговорНомер);
        Если НЕ ПустаяСтрока(ДоговорНомер) И ЗначениеЗаполнено(КонтрагентЕРП) Тогда
            // Пошук договору по номеру для контрагента
            ЗапросДоговора = Новый Запрос;
            ЗапросДоговора.Текст =
            "ВЫБРАТЬ ПЕРВЫЕ 1
            |   ДоговорыКонтрагентов.Ссылка КАК Ссылка
            |ИЗ
            |   Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
            |ГДЕ
            |   ДоговорыКонтрагентов.Владелец = &Контрагент
            |   И ДоговорыКонтрагентов.Номер ПОДОБНО &Номер";
            ЗапросДоговора.УстановитьПараметр("Контрагент", КонтрагентЕРП);
            ЗапросДоговора.УстановитьПараметр("Номер", "%" + ДоговорНомер + "%");
            РезДоговора = ЗапросДоговора.Выполнить();
            Если НЕ РезДоговора.Пустой() Тогда
                ВыборкаДог = РезДоговора.Выбрать();
                ВыборкаДог.Следующий();
                ДоговорЕРП = ВыборкаДог.Ссылка;
            КонецЕсли;
        КонецЕсли;

        // 11.5. Пошук валюти
        ВалютаЕРП = ВалютаРеглУчета;
        ВалютаКод = СокрЛП(СтрокаТЗ.ВалютаКод);
        Если НЕ ПустаяСтрока(ВалютаКод) Тогда
            ВалютаПоКоду = Справочники.Валюты.НайтиПоКоду(ВалютаКод);
            Если ЗначениеЗаполнено(ВалютаПоКоду) Тогда
                ВалютаЕРП = ВалютаПоКоду;
            КонецЕсли;
        КонецЕсли;

        // 11.6. Визначення суми (модуль для документа)
        СуммаДокумента = Макс(СуммаОстатка, -СуммаОстатка);

        // Якщо валютний облік - беремо валютну суму
        Если ВалютаЕРП <> ВалютаРеглУчета И СтрокаТЗ.ВалютнаяСумма <> 0 Тогда
            СуммаДокумента = Макс(СтрокаТЗ.ВалютнаяСумма, -СтрокаТЗ.ВалютнаяСумма);
        КонецЕсли;

        // 11.7. Отримання даних документа розрахунків
        НомерДокумента = "";
        ДатаДокумента = ОкончаниеПериода;
        Попытка
            Если ТипЗнч(СтрокаТЗ.ДокументРасчетов) <> Тип("Неопределено")
               И СтрокаТЗ.ДокументРасчетов <> Неопределено Тогда
                НомерДокумента = Строка(СтрокаТЗ.ДокументРасчетов);
            КонецЕсли;
        Исключение
            // Ігноруємо помилку
        КонецПопытки;

        // 11.8. Додавання рядка в табличну частину
        НоваяСтрока = РасчетыСПартнерами.Добавить();
        НоваяСтрока.КодСчета = КодСчета;
        НоваяСтрока.ХозяйственнаяОперация = ХозОперация;
        НоваяСтрока.Партнер = ПартнерЕРП;
        НоваяСтрока.Контрагент = КонтрагентЕРП;
        НоваяСтрока.Договор = ДоговорЕРП;
        НоваяСтрока.ВалютаВзаиморасчетов = ВалютаЕРП;
        НоваяСтрока.Сумма = СуммаДокумента;
        НоваяСтрока.СуммаРегл = СуммаДокумента;
        НоваяСтрока.НомерРасчетногоДокумента = НомерДокумента;
        НоваяСтрока.ДатаРасчетногоДокумента = ДатаДокумента;

        // Формуємо примітку з інформацією про помилки
        Примечание = "";
        Если НЕ ЗначениеЗаполнено(КонтрагентЕРП) Тогда
            Примечание = Примечание + "Контрагент не знайдено: " + КонтрагентНаименование + " (ІНН: " + КонтрагентИНН + "); ";
        КонецЕсли;
        Если НЕ ЗначениеЗаполнено(ПартнерЕРП) И ЗначениеЗаполнено(КонтрагентЕРП) Тогда
            Примечание = Примечание + "Партнер не заповнено; ";
        КонецЕсли;
        Если НЕ ЗначениеЗаполнено(ДоговорЕРП) И НЕ ПустаяСтрока(ДоговорНомер) Тогда
            Примечание = Примечание + "Договір не знайдено: " + ДоговорНомер + "; ";
        КонецЕсли;
        НоваяСтрока.Примечание = Примечание;

        СчетчикЗагружено = СчетчикЗагружено + 1;

    КонецЦикла;

    // 12. Виведення статистики
    Сообщить("Завантажено: " + СчетчикЗагружено + " позицій.");
    Если СчетчикОшибок > 0 Тогда
        Сообщить("Помилок типу рахунку: " + СчетчикОшибок);
    КонецЕсли;

КонецПроцедуры

// Функція визначення хоз.операції за рахунком та знаком суми
//
// Параметри:
//  КодСчета - Строка - код рахунку
//  Сумма - Число - сальдо (Дт - Кт)
//
// Повертає:
//  ПеречислениеСсылка.ХозяйственныеОперации - тип операції
//
Функция ОпределитьХозОперацию(КодСчета, Сумма)

    // Рахунки дебіторів (361, 371, 377)
    Если СтрНачинаетсяС(КодСчета, "361")
        ИЛИ СтрНачинаетсяС(КодСчета, "362")
        ИЛИ СтрНачинаетсяС(КодСчета, "371")
        ИЛИ СтрНачинаетсяС(КодСчета, "377") Тогда
        Если Сумма > 0 Тогда // Дебетове сальдо = заборгованість клієнта
            Возврат Перечисления.ХозяйственныеОперации.ВводОстатковЗадолженностиКлиентов;
        Иначе // Кредитове сальдо = аванс від клієнта
            Возврат Перечисления.ХозяйственныеОперации.ВводОстатковАвансовКлиентов;
        КонецЕсли;
    КонецЕсли;

    // Рахунки кредиторів (631, 632, 685, 681, 682, 683)
    Если СтрНачинаетсяС(КодСчета, "631")
        ИЛИ СтрНачинаетсяС(КодСчета, "632")
        ИЛИ СтрНачинаетсяС(КодСчета, "685")
        ИЛИ СтрНачинаетсяС(КодСчета, "681")
        ИЛИ СтрНачинаетсяС(КодСчета, "682")
        ИЛИ СтрНачинаетсяС(КодСчета, "683") Тогда
        Если Сумма < 0 Тогда // Кредитове сальдо = заборгованість постачальнику
            Возврат Перечисления.ХозяйственныеОперации.ВводОстатковЗадолженностиПоставщикам;
        Иначе // Дебетове сальдо = аванс постачальнику
            Возврат Перечисления.ХозяйственныеОперации.ВводОстатковАвансовПоставщикам;
        КонецЕсли;
    КонецЕсли;

    // Рахунки кредитів (602)
    Если СтрНачинаетсяС(КодСчета, "602") Тогда
        Если Сумма < 0 Тогда
            Возврат Перечисления.ХозяйственныеОперации.ВводОстатковЗадолженностиПоставщикам;
        Иначе
            Возврат Перечисления.ХозяйственныеОперации.ВводОстатковАвансовПоставщикам;
        КонецЕсли;
    КонецЕсли;

    Возврат Неопределено;

КонецФункции

// Процедура создает документы "ВводОстатковВзаиморасчетов"
// Групує по хоз.операціях
//
Процедура СоздатьДокументыВводаОстатков() Экспорт

    // 1. Проверка заполнения обязательных реквизитов
    Если НЕ ЗначениеЗаполнено(Организация) Тогда
        ВызватьИсключение "Не выбрана организация!";
    КонецЕсли;

    Если РасчетыСПартнерами.Количество() = 0 Тогда
        ВызватьИсключение "Табличная часть РасчетыСПартнерами пуста! Сначала загрузите остатки.";
    КонецЕсли;

    Если НЕ ЗначениеЗаполнено(ОкончаниеПериода) Тогда
        ВызватьИсключение "Не указана дата остатков (Окончание периода)!";
    КонецЕсли;

    // 2. Группировка строк по хоз.операциям
    ХозОперацииТаблица = РасчетыСПартнерами.Выгрузить(, "ХозяйственнаяОперация");
    ХозОперацииТаблица.Свернуть("ХозяйственнаяОперация");

    СчетчикДокументов = 0;
    СчетчикОшибок = 0;

    // Дата документа
    ДатаДокумента = КонецДня(ОкончаниеПериода);

    // Отримання валюти
    ВалютаРеглУчета = Константы.ВалютаРегламентированногоУчета.Получить();

    // 3. Створення документів по кожній хоз.операції
    Для Каждого СтрокаОперации Из ХозОперацииТаблица Цикл

        Если НЕ ЗначениеЗаполнено(СтрокаОперации.ХозяйственнаяОперация) Тогда
            СчетчикОшибок = СчетчикОшибок + 1;
            Сообщить("Пропущені рядки без господарської операції");
            Продолжить;
        КонецЕсли;

        // 3.1. Відбір рядків по поточній хоз.операції
        СтруктураОтбора = Новый Структура("ХозяйственнаяОперация", СтрокаОперации.ХозяйственнаяОперация);
        СтрокиОперации = РасчетыСПартнерами.НайтиСтроки(СтруктураОтбора);

        Если СтрокиОперации.Количество() = 0 Тогда
            Продолжить;
        КонецЕсли;

        // 3.2. Проверка существования документа
        ЗапросПроверки = Новый Запрос;
        ЗапросПроверки.Текст =
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |    ВводОстатковВзаиморасчетов.Ссылка КАК Ссылка
        |ИЗ
        |    Документ.ВводОстатковВзаиморасчетов КАК ВводОстатковВзаиморасчетов
        |ГДЕ
        |    ВводОстатковВзаиморасчетов.Организация = &Организация
        |    И ВводОстатковВзаиморасчетов.Дата = &Дата
        |    И ВводОстатковВзаиморасчетов.ХозяйственнаяОперация = &ХозяйственнаяОперация";

        ЗапросПроверки.УстановитьПараметр("Организация", Организация);
        ЗапросПроверки.УстановитьПараметр("Дата", ДатаДокумента);
        ЗапросПроверки.УстановитьПараметр("ХозяйственнаяОперация", СтрокаОперации.ХозяйственнаяОперация);

        РезультатПроверки = ЗапросПроверки.Выполнить();

        ЭтоОбновление = Ложь;

        Если НЕ РезультатПроверки.Пустой() Тогда
            // Документ существует - получаем его для обновления
            ВыборкаПроверки = РезультатПроверки.Выбрать();
            ВыборкаПроверки.Следующий();
            ДокументОбъект = ВыборкаПроверки.Ссылка.ПолучитьОбъект();
            ДокументОбъект.РасчетыСПартнерами.Очистить();
            ДокументОбъект.Комментарий = "Оновлено обробкою переносу залишків " + Формат(ТекущаяДатаСеанса(), "ДЛФ=DT");
            ЭтоОбновление = Истина;
        Иначе
            // Створення нового документа
            ДокументОбъект = Документы.ВводОстатковВзаиморасчетов.СоздатьДокумент();
            ДокументОбъект.Комментарий = "Створено обробкою переносу залишків " + Формат(ТекущаяДатаСеанса(), "ДЛФ=DT");
        КонецЕсли;

        // 3.3. Заповнення реквізитів документа
        ДокументОбъект.Дата = ДатаДокумента;
        ДокументОбъект.Организация = Организация;
        ДокументОбъект.ХозяйственнаяОперация = СтрокаОперации.ХозяйственнаяОперация;
        ДокументОбъект.Валюта = ВалютаРеглУчета;
        ДокументОбъект.ОтражатьВОперативномУчете = Истина;
        ДокументОбъект.ОтражатьВБУиНУ = Истина;
        ДокументОбъект.ОтражатьВУУ = Истина;

        // 3.4. Заповнення табличної частини
        Для Каждого СтрокаРасчетов Из СтрокиОперации Цикл

            // Пропускаємо рядки без контрагента або суми
            Если НЕ ЗначениеЗаполнено(СтрокаРасчетов.Контрагент) Тогда
                Продолжить;
            КонецЕсли;

            Если СтрокаРасчетов.Сумма = 0 Тогда
                Продолжить;
            КонецЕсли;

            НоваяСтрокаДок = ДокументОбъект.РасчетыСПартнерами.Добавить();
            НоваяСтрокаДок.Партнер = СтрокаРасчетов.Партнер;
            НоваяСтрокаДок.Контрагент = СтрокаРасчетов.Контрагент;
            НоваяСтрокаДок.Договор = СтрокаРасчетов.Договор;
            НоваяСтрокаДок.ВалютаВзаиморасчетов = СтрокаРасчетов.ВалютаВзаиморасчетов;
            НоваяСтрокаДок.Сумма = СтрокаРасчетов.Сумма;
            НоваяСтрокаДок.СуммаРегл = СтрокаРасчетов.СуммаРегл;
            НоваяСтрокаДок.СуммаУпр = СтрокаРасчетов.СуммаРегл;
            НоваяСтрокаДок.НомерРасчетногоДокумента = СтрокаРасчетов.НомерРасчетногоДокумента;
            НоваяСтрокаДок.ДатаРасчетногоДокумента = СтрокаРасчетов.ДатаРасчетногоДокумента;
            НоваяСтрокаДок.ДатаПлатежа = СтрокаРасчетов.ДатаРасчетногоДокумента;

            // Заповнення об'єкта розрахунків
            Если ЗначениеЗаполнено(СтрокаРасчетов.ОбъектРасчетовОтправитель) Тогда
                НоваяСтрокаДок.ОбъектРасчетовОтправитель = СтрокаРасчетов.ОбъектРасчетовОтправитель;
            КонецЕсли;

        КонецЦикла;

        // 3.5. Запис документа
        Если ДокументОбъект.РасчетыСПартнерами.Количество() = 0 Тогда
            Сообщить("Для операції " + СтрокаОперации.ХозяйственнаяОперация + " немає рядків для запису");
            Продолжить;
        КонецЕсли;

        Попытка
            ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);

            Если ЭтоОбновление Тогда
                Сообщить("Документ оновлено: " + ДокументОбъект.Ссылка + " (" + СтрокаОперации.ХозяйственнаяОперация + ")");
            Иначе
                Сообщить("Створено документ: " + ДокументОбъект.Ссылка + " (" + СтрокаОперации.ХозяйственнаяОперация + ")");
            КонецЕсли;
            СчетчикДокументов = СчетчикДокументов + 1;
        Исключение
            СчетчикОшибок = СчетчикОшибок + 1;
            Сообщить("Помилка запису документа для " + СтрокаОперации.ХозяйственнаяОперация + ": " + ОписаниеОшибки());
        КонецПопытки;

    КонецЦикла;

    // 4. Вывод результата
    Сообщить("===============================================");
    Сообщить("Створено/оновлено документів: " + СчетчикДокументов);
    Если СчетчикОшибок > 0 Тогда
        Сообщить("Помилок: " + СчетчикОшибок);
    КонецЕсли;

КонецПроцедуры

#КонецЕсли
