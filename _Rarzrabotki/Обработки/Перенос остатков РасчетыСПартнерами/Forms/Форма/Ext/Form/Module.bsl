
&НаКлиенте
Процедура ЗагрузитьОстатки(Команда)

    // Перевірка заповнення дати
    Если НЕ ЗначениеЗаполнено(Объект.ОкончаниеПериода) Тогда
        ПоказатьПредупреждение(, "Вкажіть дату залишків (Окончание периода)!");
        Возврат;
    КонецЕсли;

    // Підтвердження операції
    ОписаниеОповещения = Новый ОписаниеОповещения("ЗагрузитьОстаткиЗавершение", ЭтотОбъект);
    ПоказатьВопрос(ОписаниеОповещения,
        "Завантажити залишки взаєморозрахунків з бази BuhBud на дату " + Формат(Объект.ОкончаниеПериода, "ДЛФ=D") + "?
        |
        |Поточні дані в табличній частині будуть очищені!",
        РежимДиалогаВопрос.ДаНет,
        ,
        КодВозвратаДиалога.Нет,
        "Завантаження залишків");

КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьОстаткиЗавершение(Результат, ДополнительныеПараметры) Экспорт

    Если Результат <> КодВозвратаДиалога.Да Тогда
        Возврат;
    КонецЕсли;

    // Показати стан
    Состояние("Завантаження залишків взаєморозрахунків з BuhBud...");

    Попытка
        КоличествоЗагружено = ЗагрузитьОстаткиНаСервере();
        ПоказатьПредупреждение(, "Завантажено " + КоличествоЗагружено + " позицій");
    Исключение
        ПоказатьПредупреждение(, "Помилка: " + ОписаниеОшибки());
    КонецПопытки;

КонецПроцедуры

&НаСервере
Функция ЗагрузитьОстаткиНаСервере()

    ОбъектОбработки = РеквизитФормыВЗначение("Объект");
    ОбъектОбработки.ЗагрузитьОстатки();
    ЗначениеВРеквизитФормы(ОбъектОбработки, "Объект");

    Возврат Объект.РасчетыСПартнерами.Количество();

КонецФункции

// Обробник ПриСозданииНаСервере - встановлення значень за замовчуванням
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

    // Встановити поточну дату як дату залишків за замовчуванням
    Если НЕ ЗначениеЗаполнено(Объект.ОкончаниеПериода) Тогда
        Объект.ОкончаниеПериода = КонецМесяца(ТекущаяДатаСеанса());
    КонецЕсли;

    // Встановити рахунки за замовчуванням
    Если НЕ ЗначениеЗаполнено(Объект.СчетаВзаиморасчетов) Тогда
        Объект.СчетаВзаиморасчетов = "361,362,371,377,631,632,681,682,683";
    КонецЕсли;

КонецПроцедуры

// Команда создания документов ввода остатков
&НаКлиенте
Процедура СоздатьДокументы(Команда)

    // Проверка заполнения организации
    Если НЕ ЗначениеЗаполнено(Объект.Организация) Тогда
        ПоказатьПредупреждение(, "Необхідно вибрати організацію!");
        Возврат;
    КонецЕсли;

    // Проверка заполнения даты
    Если НЕ ЗначениеЗаполнено(Объект.ОкончаниеПериода) Тогда
        ПоказатьПредупреждение(, "Необхідно вказати дату залишків (Закінчення періоду)!");
        Возврат;
    КонецЕсли;

    // Проверка наличия данных
    Если Объект.РасчетыСПартнерами.Количество() = 0 Тогда
        ПоказатьПредупреждение(, "Таблична частина порожня! Спочатку завантажте залишки.");
        Возврат;
    КонецЕсли;

    // Подтверждение операции
    ОписаниеОповещения = Новый ОписаниеОповещения("СоздатьДокументыЗавершение", ЭтотОбъект);
    ПоказатьВопрос(ОписаниеОповещения,
        "Створити документи введення залишків взаєморозрахунків на дату " + Формат(Объект.ОкончаниеПериода, "ДЛФ=D") + "?
        |
        |Буде створено окремий документ для кожної господарської операції.
        |Організація: " + Объект.Организация + "
        |Рядків в табличній частині: " + Объект.РасчетыСПартнерами.Количество(),
        РежимДиалогаВопрос.ДаНет,
        ,
        КодВозвратаДиалога.Нет,
        "Створення документів введення залишків");

КонецПроцедуры

&НаКлиенте
Процедура СоздатьДокументыЗавершение(Результат, ДополнительныеПараметры) Экспорт

    Если Результат <> КодВозвратаДиалога.Да Тогда
        Возврат;
    КонецЕсли;

    // Показать состояние
    Состояние("Створення документів введення залишків...");

    Попытка
        СоздатьДокументыНаСервере();
        ПоказатьПредупреждение(, "Документи успішно створено! Подробиці див. в повідомленнях.");
    Исключение
        ПоказатьПредупреждение(, "Помилка: " + ОписаниеОшибки());
    КонецПопытки;

КонецПроцедуры

&НаСервере
Процедура СоздатьДокументыНаСервере()

    ОбъектОбработки = РеквизитФормыВЗначение("Объект");
    ОбъектОбработки.СоздатьДокументыВводаОстатков();
    ЗначениеВРеквизитФормы(ОбъектОбработки, "Объект");

КонецПроцедуры

