
&НаСервере
Процедура ОбновитьПоступлениеНаСервере()

	// Получаем объект документа
	Док = Объект.ДокПриобретениеТоваровУслуг.ПолучитьОбъект();

	// Если документ проведен - сначала отменяем проведение
	БылПроведен = Док.Проведен;
	Если БылПроведен Тогда
		Док.Записать(РежимЗаписиДокумента.ОтменаПроведения);
	КонецЕсли;

	// Очищаем ТЧ Товары
	Док.Товары.Очистить();

	// Получаем склад из шапки документа для заполнения строк
	СкладИзШапки = Док.Склад;

	// Счетчик для КодСтроки
	КодСтроки = 0;

	// Получаем признак "Цена включает НДС" из шапки документа
	ЦенаВключаетНДС = Док.ЦенаВключаетНДС;

	// Переносим данные из А_Товары в Товары
	Для каждого СтрокаИсточник Из Док.А_Товары Цикл

		КодСтроки = КодСтроки + 1;

		СтрокаТовары = Док.Товары.Добавить();

		// === Основные реквизиты - прямой перенос ===
		СтрокаТовары.Номенклатура = СтрокаИсточник.Номенклатура;
		СтрокаТовары.Упаковка = СтрокаИсточник.Упаковка;
		СтрокаТовары.Количество = СтрокаИсточник.Количество;
		СтрокаТовары.Цена = СтрокаИсточник.Цена;
		СтрокаТовары.СуммаНДС = СтрокаИсточник.СуммаНДС;

		// === КоличествоУпаковок - расчет с учетом коэффициента ===
		Коэффициент = 1;
		Попытка
			Если ЗначениеЗаполнено(СтрокаИсточник.Коэффициент) И СтрокаИсточник.Коэффициент <> 0 Тогда
				Коэффициент = СтрокаИсточник.Коэффициент;
			КонецЕсли;
		Исключение
			// Поле Коэффициент может отсутствовать
		КонецПопытки;
		СтрокаТовары.КоличествоУпаковок = СтрокаИсточник.Количество / Коэффициент;

		// === СтавкаНДС - КОНВЕРТАЦИЯ из Перечисления в Справочник ===
		Попытка
			Если ТипЗнч(СтрокаИсточник.СтавкаНДС) = Тип("ПеречислениеСсылка.СтавкиНДС") Тогда
				// Конвертируем перечисление в справочник через типовую функцию
				СтрокаТовары.СтавкаНДС = НДСКлиентСерверПовтИсп.СтавкаНДСПоЗначениюПеречисления(СтрокаИсточник.СтавкаНДС);
			ИначеЕсли ТипЗнч(СтрокаИсточник.СтавкаНДС) = Тип("СправочникСсылка.СтавкиНДС") Тогда
				// Уже справочник - просто присваиваем
				СтрокаТовары.СтавкаНДС = СтрокаИсточник.СтавкаНДС;
			Иначе
				// Попробуем найти ставку НДС по значению 20%
				СтрокаТовары.СтавкаНДС = Справочники.СтавкиНДС.НайтиПоРеквизиту("Ставка", 20);
			КонецЕсли;
		Исключение
			// В случае ошибки пробуем найти ставку 20%
			СтрокаТовары.СтавкаНДС = Справочники.СтавкиНДС.НайтиПоРеквизиту("Ставка", 20);
		КонецПопытки;

		// === Расчетные поля сумм с учетом ЦенаВключаетНДС ===
		Если ЦенаВключаетНДС Тогда
			// Цена включает НДС: Сумма в источнике = СуммаСНДС (сумма с НДС)
			СтрокаТовары.Сумма = СтрокаИсточник.Сумма - СтрокаИсточник.СуммаНДС;
			СтрокаТовары.СуммаСНДС = СтрокаИсточник.Сумма;
		Иначе
			// Цена без НДС: Сумма в источнике = сумма без НДС
			СтрокаТовары.Сумма = СтрокаИсточник.Сумма;
			СтрокаТовары.СуммаСНДС = СтрокаИсточник.Сумма + СтрокаИсточник.СуммаНДС;
		КонецЕсли;
		СтрокаТовары.СуммаВзаиморасчетов = СтрокаТовары.СуммаСНДС;
		СтрокаТовары.СуммаНДСВзаиморасчетов = СтрокаИсточник.СуммаНДС;

		// === Склад из шапки документа ===
		СтрокаТовары.Склад = СкладИзШапки;

		// === ИдентификаторСтроки - генерируем новый GUID ===
		СтрокаТовары.ИдентификаторСтроки = Строка(Новый УникальныйИдентификатор);

		// === КодСтроки - автоинкремент ===
		СтрокаТовары.КодСтроки = КодСтроки;

		// === НалоговоеНазначение - прямой перенос ===
		Попытка
			Если ЗначениеЗаполнено(СтрокаИсточник.НалоговоеНазначение) Тогда
				СтрокаТовары.НалоговоеНазначение = СтрокаИсточник.НалоговоеНазначение;
			КонецЕсли;
		Исключение
			// Поле может отсутствовать
		КонецПопытки;

		// === Необязательные поля - пустые значения ===
		// Характеристика, Серия, Назначение - оставляем пустыми (нет в А_Товары)

	КонецЦикла;

	// Переносим данные из А_Услуги в Товары
	Для каждого СтрокаУслуга Из Док.А_Услуги Цикл

		КодСтроки = КодСтроки + 1;

		СтрокаТовары = Док.Товары.Добавить();

		// === Основные реквизиты - прямой перенос ===
		СтрокаТовары.Номенклатура = СтрокаУслуга.Номенклатура;
		СтрокаТовары.Количество = СтрокаУслуга.Количество;
		СтрокаТовары.КоличествоУпаковок = СтрокаУслуга.Количество;
		СтрокаТовары.Цена = СтрокаУслуга.Цена;
		СтрокаТовары.СуммаНДС = СтрокаУслуга.СуммаНДС;

		// Упаковка - для услуг обычно пустая или базовая ЕИ номенклатуры
		// СтрокаТовары.Упаковка = ... (оставляем пустым)

		// === СтавкаНДС - КОНВЕРТАЦИЯ из Перечисления в Справочник ===
		Попытка
			Если ТипЗнч(СтрокаУслуга.СтавкаНДС) = Тип("ПеречислениеСсылка.СтавкиНДС") Тогда
				// Конвертируем перечисление в справочник через типовую функцию
				СтрокаТовары.СтавкаНДС = НДСКлиентСерверПовтИсп.СтавкаНДСПоЗначениюПеречисления(СтрокаУслуга.СтавкаНДС);
			ИначеЕсли ТипЗнч(СтрокаУслуга.СтавкаНДС) = Тип("СправочникСсылка.СтавкиНДС") Тогда
				// Уже справочник - просто присваиваем
				СтрокаТовары.СтавкаНДС = СтрокаУслуга.СтавкаНДС;
			Иначе
				// Попробуем найти ставку НДС по значению 20%
				СтрокаТовары.СтавкаНДС = Справочники.СтавкиНДС.НайтиПоРеквизиту("Ставка", 20);
			КонецЕсли;
		Исключение
			// В случае ошибки пробуем найти ставку 20%
			СтрокаТовары.СтавкаНДС = Справочники.СтавкиНДС.НайтиПоРеквизиту("Ставка", 20);
		КонецПопытки;

		// === Расчетные поля сумм с учетом ЦенаВключаетНДС ===
		Если ЦенаВключаетНДС Тогда
			// Цена включает НДС: Сумма в источнике = СуммаСНДС (сумма с НДС)
			СтрокаТовары.Сумма = СтрокаУслуга.Сумма - СтрокаУслуга.СуммаНДС;
			СтрокаТовары.СуммаСНДС = СтрокаУслуга.Сумма;
		Иначе
			// Цена без НДС: Сумма в источнике = сумма без НДС
			СтрокаТовары.Сумма = СтрокаУслуга.Сумма;
			СтрокаТовары.СуммаСНДС = СтрокаУслуга.Сумма + СтрокаУслуга.СуммаНДС;
		КонецЕсли;
		СтрокаТовары.СуммаВзаиморасчетов = СтрокаТовары.СуммаСНДС;
		СтрокаТовары.СуммаНДСВзаиморасчетов = СтрокаУслуга.СуммаНДС;

		// === Склад из шапки документа ===
		СтрокаТовары.Склад = СкладИзШапки;

		// === ИдентификаторСтроки - генерируем новый GUID ===
		СтрокаТовары.ИдентификаторСтроки = Строка(Новый УникальныйИдентификатор);

		// === КодСтроки - автоинкремент ===
		СтрокаТовары.КодСтроки = КодСтроки;

		// === НалоговоеНазначение - прямой перенос ===
		Попытка
			Если ЗначениеЗаполнено(СтрокаУслуга.НалоговоеНазначение) Тогда
				СтрокаТовары.НалоговоеНазначение = СтрокаУслуга.НалоговоеНазначение;
			КонецЕсли;
		Исключение
			// Поле может отсутствовать
		КонецПопытки;

		// === КРИТИЧНО для услуг - списать на расходы ===
		СтрокаТовары.СписатьНаРасходы = Истина;

	КонецЦикла;

	// Записываем документ
	Если БылПроведен Тогда
		// Если документ был проведен - проводим снова
		Док.Записать(РежимЗаписиДокумента.Проведение);
	Иначе
		// Просто записываем без проведения
		Док.Записать(РежимЗаписиДокумента.Запись);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ОбновитьПоступление(Команда)
	ОбновитьПоступлениеНаСервере();
КонецПроцедуры
