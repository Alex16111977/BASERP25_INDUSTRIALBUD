////////////////////////////////////////////////////////////////////////////////
// Обработка неизвестного партнера (внешняя обработка EPF)
// Модуль поиска и замены ссылок на НеизвестныйПартнер в документах
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Выполняет поиск документов со ссылкой на НеизвестныйПартнер
//
// Параметры:
//   ТолькоПоиск - Булево - Если Истина, только поиск без обработки
//
// Возвращаемое значение:
//   ТаблицаЗначений - Найденные документы
//
Функция НайтиДокументыСНеизвестнымПартнером(ТолькоПоиск = Истина) Экспорт

	НеизвестныйПартнер = Справочники.Партнеры.НеизвестныйПартнер;

	// Получаем все ссылки на НеизвестныйПартнер в базе
	МассивСсылок = НайтиПоСсылкам(НеизвестныйПартнер);

	// Таблица результатов
	ТаблицаРезультатов = Новый ТаблицаЗначений;
	ТаблицаРезультатов.Колонки.Добавить("Документ");
	ТаблицаРезультатов.Колонки.Добавить("ТипДокумента");
	ТаблицаРезультатов.Колонки.Добавить("Реквизит");
	ТаблицаРезультатов.Колонки.Добавить("ТаблицаИлиШапка");
	ТаблицаРезультатов.Колонки.Добавить("Контрагент");
	ТаблицаРезультатов.Колонки.Добавить("НовыйПартнер");
	ТаблицаРезультатов.Колонки.Добавить("Обработан");

	Для Каждого ЭлементСсылки Из МассивСсылок Цикл

		// Работаем только с документами
		Если НЕ Документы.ТипВсеСсылки().СодержитТип(ТипЗнч(ЭлементСсылки.Ключ)) Тогда
			Продолжить;
		КонецЕсли;

		ДокументСсылка = ЭлементСсылки.Ключ;

		Для Каждого МестоИспользования Из ЭлементСсылки.Значение Цикл

			НоваяСтрока = ТаблицаРезультатов.Добавить();
			НоваяСтрока.Документ = ДокументСсылка;
			НоваяСтрока.ТипДокумента = ТипЗнч(ДокументСсылка);
			НоваяСтрока.Реквизит = МестоИспользования.Метаданные;
			НоваяСтрока.Обработан = Ложь;

			// Определяем тип использования (шапка или табличная часть)
			Если СтрНайти(МестоИспользования.Метаданные, "ТабличнаяЧасть") > 0
				ИЛИ СтрНайти(МестоИспользования.Метаданные, "TabularSection") > 0 Тогда
				НоваяСтрока.ТаблицаИлиШапка = "ТабличнаяЧасть";
			Иначе
				НоваяСтрока.ТаблицаИлиШапка = "Шапка";
			КонецЕсли;

			// Пытаемся получить контрагента документа
			Попытка
				СтруктураРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка, "Контрагент");
				НоваяСтрока.Контрагент = СтруктураРеквизитов.Контрагент;
			Исключение
				НоваяСтрока.Контрагент = Неопределено;
			КонецПопытки;

		КонецЦикла;

	КонецЦикла;

	// Сворачиваем дубли по документам
	ТаблицаРезультатов.Свернуть("Документ, ТипДокумента, ТаблицаИлиШапка, Контрагент", "");

	Возврат ТаблицаРезультатов;

КонецФункции

// Обрабатывает документ - заменяет НеизвестныйПартнер на партнера по контрагенту
//
// Параметры:
//   ДокументСсылка - ДокументСсылка - Ссылка на обрабатываемый документ
//   ТаблицаИлиШапка - Строка - "Шапка" или "ТабличнаяЧасть"
//
// Возвращаемое значение:
//   Структура - Результат обработки
//
Функция ОбработатьДокумент(ДокументСсылка, ТаблицаИлиШапка = "") Экспорт

	Результат = Новый Структура("Успех, Сообщение, НовыйПартнер", Ложь, "", Неопределено);

	Попытка

		ДокументОбъект = ДокументСсылка.ПолучитьОбъект();

		Если ДокументОбъект = Неопределено Тогда
			Результат.Сообщение = "Не удалось получить объект документа";
			Возврат Результат;
		КонецЕсли;

		// Проверяем наличие реквизита Контрагент
		ЕстьКонтрагент = Ложь;
		Попытка
			Контрагент = ДокументОбъект.Контрагент;
			ЕстьКонтрагент = Истина;
		Исключение
			ЕстьКонтрагент = Ложь;
		КонецПопытки;

		Если НЕ ЕстьКонтрагент ИЛИ НЕ ЗначениеЗаполнено(ДокументОбъект.Контрагент) Тогда
			Результат.Сообщение = "Документ не содержит заполненного контрагента";
			Возврат Результат;
		КонецЕсли;

		// Получаем партнера по контрагенту
		ПартнерПолученныйПоКонтрагенту = ДенежныеСредстваСервер.ПолучитьПартнераПоКонтрагенту(ДокументОбъект.Контрагент);

		Изменен = Ложь;

		// Обработка в зависимости от местоположения партнера
		Если ТаблицаИлиШапка = "ТабличнаяЧасть" ИЛИ ТаблицаИлиШапка = "" Тогда
			// Обработка табличных частей
			Изменен = ОбработатьТабличныеЧастиДокумента(ДокументОбъект, ПартнерПолученныйПоКонтрагенту) ИЛИ Изменен;
		КонецЕсли;

		Если ТаблицаИлиШапка = "Шапка" ИЛИ ТаблицаИлиШапка = "" Тогда
			// Обработка шапки
			Изменен = ОбработатьШапкуДокумента(ДокументОбъект, ПартнерПолученныйПоКонтрагенту) ИЛИ Изменен;
		КонецЕсли;

		Если Изменен Тогда
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			ДокументОбъект.Записать();

			Результат.Успех = Истина;
			Результат.НовыйПартнер = ПартнерПолученныйПоКонтрагенту;
			Результат.Сообщение = "Документ успешно обработан";
		Иначе
			Результат.Сообщение = "Изменения не требуются";
		КонецЕсли;

	Исключение
		Результат.Сообщение = ОписаниеОшибки();
	КонецПопытки;

	Возврат Результат;

КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Обрабатывает табличные части документа
//
Функция ОбработатьТабличныеЧастиДокумента(ДокументОбъект, ПартнерПолученныйПоКонтрагенту)

	Изменен = Ложь;
	НеизвестныйПартнер = Справочники.Партнеры.НеизвестныйПартнер;

	// Получаем контрагента из базы для сравнения
	КонтрагентВБазе = Неопределено;
	Попытка
		Если ЗначениеЗаполнено(ДокументОбъект.Ссылка) Тогда
			СтруктураРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументОбъект.Ссылка, "Контрагент");
			КонтрагентВБазе = СтруктураРеквизитов.Контрагент;
		КонецЕсли;
	Исключение
		КонтрагентВБазе = Неопределено;
	КонецПопытки;

	// Перебираем все табличные части документа
	МетаданныеДокумента = ДокументОбъект.Метаданные();

	Для Каждого ТЧ Из МетаданныеДокумента.ТабличныеЧасти Цикл

		// Проверяем наличие реквизита Партнер в табличной части
		ЕстьРеквизитПартнер = Ложь;
		Для Каждого Реквизит Из ТЧ.Реквизиты Цикл
			Если Реквизит.Имя = "Партнер" Тогда
				ЕстьРеквизитПартнер = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;

		Если НЕ ЕстьРеквизитПартнер Тогда
			Продолжить;
		КонецЕсли;

		// Обрабатываем строки табличной части
		ТабличнаяЧасть = ДокументОбъект[ТЧ.Имя];

		Для Каждого Строка Из ТабличнаяЧасть Цикл

			// Условие замены: партнер не заполнен ИЛИ партнер = НеизвестныйПартнер ИЛИ контрагент изменился
			КонтрагентИзменился = (КонтрагентВБазе <> Неопределено) И (КонтрагентВБазе <> ДокументОбъект.Контрагент);

			Если НЕ ЗначениеЗаполнено(Строка.Партнер)
				ИЛИ Строка.Партнер = НеизвестныйПартнер
				ИЛИ КонтрагентИзменился Тогда

				Строка.Партнер = ПартнерПолученныйПоКонтрагенту;

				Если НЕ ЗначениеЗаполнено(Строка.Партнер) Тогда
					Строка.Партнер = НеизвестныйПартнер;
				КонецЕсли;

				Изменен = Истина;

			КонецЕсли;

		КонецЦикла;

	КонецЦикла;

	Возврат Изменен;

КонецФункции

// Обрабатывает шапку документа
//
Функция ОбработатьШапкуДокумента(ДокументОбъект, ПартнерПолученныйПоКонтрагенту)

	Изменен = Ложь;
	НеизвестныйПартнер = Справочники.Партнеры.НеизвестныйПартнер;

	// Проверяем наличие реквизита Партнер в шапке
	МетаданныеДокумента = ДокументОбъект.Метаданные();
	ЕстьРеквизитПартнер = Ложь;

	Для Каждого Реквизит Из МетаданныеДокумента.Реквизиты Цикл
		Если Реквизит.Имя = "Партнер" Тогда
			ЕстьРеквизитПартнер = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;

	Если НЕ ЕстьРеквизитПартнер Тогда
		Возврат Ложь;
	КонецЕсли;

	// Получаем контрагента из базы для сравнения
	КонтрагентВБазе = Неопределено;
	Попытка
		Если ЗначениеЗаполнено(ДокументОбъект.Ссылка) Тогда
			СтруктураРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументОбъект.Ссылка, "Контрагент");
			КонтрагентВБазе = СтруктураРеквизитов.Контрагент;
		КонецЕсли;
	Исключение
		КонтрагентВБазе = Неопределено;
	КонецПопытки;

	// Проверяем условия для замены
	Если ЗначениеЗаполнено(ДокументОбъект.Контрагент) Тогда

		КонтрагентИзменился = (КонтрагентВБазе <> Неопределено) И (КонтрагентВБазе <> ДокументОбъект.Контрагент);

		Если НЕ ЗначениеЗаполнено(ДокументОбъект.Партнер)
			ИЛИ ДокументОбъект.Партнер = НеизвестныйПартнер
			ИЛИ КонтрагентИзменился Тогда

			ДокументОбъект.Партнер = ПартнерПолученныйПоКонтрагенту;

			Если НЕ ЗначениеЗаполнено(ДокументОбъект.Партнер) Тогда
				ДокументОбъект.Партнер = НеизвестныйПартнер;
			КонецЕсли;

			Изменен = Истина;

		КонецЕсли;

	КонецЕсли;

	Возврат Изменен;

КонецФункции

#КонецОбласти
