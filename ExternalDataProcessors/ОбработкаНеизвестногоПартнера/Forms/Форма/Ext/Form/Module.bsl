////////////////////////////////////////////////////////////////////////////////
// УНИВЕРСАЛЬНАЯ ОБРАБОТКА ЗАМЕНЫ НЕИЗВЕСТНОГО ПАРТНЕРА
// Версия: 2.4 (Исправлена проблема с кэшированием ключей аналитики)
// Дата: 2025-11-24
// Описание: Автоматический поиск ВСЕХ объектов с партнером и замена
//
// ВОЗМОЖНОСТИ:
// - Автоматическое сканирование метаданных конфигурации
// - Поиск всех справочников, документов, регистров с реквизитом Партнер
// - Динамическое построение запросов
// - Универсальная замена с учетом типа объекта
// - Обработка регистров через перепроведение документов-регистраторов
//
// ИСПРАВЛЕНИЯ v2.4:
// - Новая функция УдалитьКэшированныеКлючиАналитики() - обрабатывает ВСЕ комбинации
//   аналитики из ТЧ документа (Организация, Контрагент, Договор, НаправлениеДеятельности)
// - Новая функция УдалитьЗаписьАналитикиПоПартнерам() - удаление через МенеджерЗаписи
// - Корректное удаление кэша АналитикаУчетаПоПартнерам перед перепроведением
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	// Найти неизвестного партнера по наименованию
	НеизвестныйПартнер = Справочники.Партнеры.НайтиПоНаименованию("Неизвестный партнер", Истина);

	Если НЕ ЗначениеЗаполнено(НеизвестныйПартнер) Тогда
		Попытка
			НеизвестныйПартнер = Справочники.Партнеры.НеизвестныйПартнер;
		Исключение
		КонецПопытки;
	КонецЕсли;

	// Сканировать метаданные при открытии
	СканироватьМетаданные();

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура СканироватьМетаданныеКоманда(Команда)
	СканироватьМетаданные();
КонецПроцедуры

&НаКлиенте
Процедура НайтиСсылки(Команда)

	Если НЕ ЗначениеЗаполнено(НеизвестныйПартнер) Тогда
		ПоказатьПредупреждение(, "Не указан неизвестный партнер для поиска!");
		Возврат;
	КонецЕсли;

	КоличествоНайденных = НайтиСсылкиНаСервере();

	ПоказатьПредупреждение(, "Найдено объектов: " + КоличествоНайденных);

КонецПроцедуры

&НаКлиенте
Процедура ЗаменитьПартнеров(Команда)

	Если ТаблицаОбъектов.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Сначала выполните поиск ссылок!");
		Возврат;
	КонецЕсли;

	КоличествоОбработанных = ЗаменитьПартнеровНаСервере();

	ПоказатьПредупреждение(, "Обработано объектов: " + КоличествоОбработанных);

	// Обновить таблицу
	НайтиСсылкиНаСервере();

КонецПроцедуры

#КонецОбласти

#Область СканированиеМетаданных

&НаСервере
Процедура СканироватьМетаданные()

	ТаблицаМетаданных.Очистить();

	ТипПартнер = Тип("СправочникСсылка.Партнеры");

	// 1. СКАНИРОВАНИЕ СПРАВОЧНИКОВ
	Для Каждого МетаданныеСправочника Из Метаданные.Справочники Цикл

		// Стандартные реквизиты
		Для Каждого СтандартныйРеквизит Из МетаданныеСправочника.СтандартныеРеквизиты Цикл
			Если СодержитТипПартнер(СтандартныйРеквизит.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("Справочник", МетаданныеСправочника.Имя,
					"Реквизит", СтандартныйРеквизит.Имя, "Стандартный");
			КонецЕсли;
		КонецЦикла;

		// Реквизиты
		Для Каждого Реквизит Из МетаданныеСправочника.Реквизиты Цикл
			Если СодержитТипПартнер(Реквизит.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("Справочник", МетаданныеСправочника.Имя,
					"Реквизит", Реквизит.Имя, "Шапка");
			КонецЕсли;
		КонецЦикла;

		// Табличные части
		Для Каждого ТабличнаяЧасть Из МетаданныеСправочника.ТабличныеЧасти Цикл
			Для Каждого Реквизит Из ТабличнаяЧасть.Реквизиты Цикл
				Если СодержитТипПартнер(Реквизит.Тип, ТипПартнер) Тогда
					ДобавитьВТаблицуМетаданных("Справочник", МетаданныеСправочника.Имя,
						"ТабличнаяЧасть", Реквизит.Имя, ТабличнаяЧасть.Имя);
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;

	КонецЦикла;

	// 2. СКАНИРОВАНИЕ ДОКУМЕНТОВ
	Для Каждого МетаданныеДокумента Из Метаданные.Документы Цикл

		// Стандартные реквизиты
		Для Каждого СтандартныйРеквизит Из МетаданныеДокумента.СтандартныеРеквизиты Цикл
			Если СодержитТипПартнер(СтандартныйРеквизит.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("Документ", МетаданныеДокумента.Имя,
					"Реквизит", СтандартныйРеквизит.Имя, "Стандартный");
			КонецЕсли;
		КонецЦикла;

		// Реквизиты шапки
		Для Каждого Реквизит Из МетаданныеДокумента.Реквизиты Цикл
			Если СодержитТипПартнер(Реквизит.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("Документ", МетаданныеДокумента.Имя,
					"Реквизит", Реквизит.Имя, "Шапка");
			КонецЕсли;
		КонецЦикла;

		// Табличные части
		Для Каждого ТабличнаяЧасть Из МетаданныеДокумента.ТабличныеЧасти Цикл
			Для Каждого Реквизит Из ТабличнаяЧасть.Реквизиты Цикл
				Если СодержитТипПартнер(Реквизит.Тип, ТипПартнер) Тогда
					ДобавитьВТаблицуМетаданных("Документ", МетаданныеДокумента.Имя,
						"ТабличнаяЧасть", Реквизит.Имя, ТабличнаяЧасть.Имя);
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;

	КонецЦикла;

	// 3. СКАНИРОВАНИЕ РЕГИСТРОВ СВЕДЕНИЙ
	Для Каждого МетаданныеРегистра Из Метаданные.РегистрыСведений Цикл

		// Измерения
		Для Каждого Измерение Из МетаданныеРегистра.Измерения Цикл
			Если СодержитТипПартнер(Измерение.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("РегистрСведений", МетаданныеРегистра.Имя,
					"Измерение", Измерение.Имя, "");
			КонецЕсли;
		КонецЦикла;

		// Ресурсы
		Для Каждого Ресурс Из МетаданныеРегистра.Ресурсы Цикл
			Если СодержитТипПартнер(Ресурс.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("РегистрСведений", МетаданныеРегистра.Имя,
					"Ресурс", Ресурс.Имя, "");
			КонецЕсли;
		КонецЦикла;

		// Реквизиты
		Для Каждого Реквизит Из МетаданныеРегистра.Реквизиты Цикл
			Если СодержитТипПартнер(Реквизит.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("РегистрСведений", МетаданныеРегистра.Имя,
					"Реквизит", Реквизит.Имя, "");
			КонецЕсли;
		КонецЦикла;

	КонецЦикла;

	// 4. СКАНИРОВАНИЕ РЕГИСТРОВ НАКОПЛЕНИЯ
	Для Каждого МетаданныеРегистра Из Метаданные.РегистрыНакопления Цикл

		// Измерения
		Для Каждого Измерение Из МетаданныеРегистра.Измерения Цикл
			Если СодержитТипПартнер(Измерение.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("РегистрНакопления", МетаданныеРегистра.Имя,
					"Измерение", Измерение.Имя, "");
			КонецЕсли;
		КонецЦикла;

		// Ресурсы
		Для Каждого Ресурс Из МетаданныеРегистра.Ресурсы Цикл
			Если СодержитТипПартнер(Ресурс.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("РегистрНакопления", МетаданныеРегистра.Имя,
					"Ресурс", Ресурс.Имя, "");
			КонецЕсли;
		КонецЦикла;

		// Реквизиты
		Для Каждого Реквизит Из МетаданныеРегистра.Реквизиты Цикл
			Если СодержитТипПартнер(Реквизит.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("РегистрНакопления", МетаданныеРегистра.Имя,
					"Реквизит", Реквизит.Имя, "");
			КонецЕсли;
		КонецЦикла;

	КонецЦикла;

	// 5. СКАНИРОВАНИЕ РЕГИСТРОВ БУХГАЛТЕРИИ
	Для Каждого МетаданныеРегистра Из Метаданные.РегистрыБухгалтерии Цикл

		// Измерения
		Для Каждого Измерение Из МетаданныеРегистра.Измерения Цикл
			Если СодержитТипПартнер(Измерение.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("РегистрБухгалтерии", МетаданныеРегистра.Имя,
					"Измерение", Измерение.Имя, "");
			КонецЕсли;
		КонецЦикла;

		// Ресурсы
		Для Каждого Ресурс Из МетаданныеРегистра.Ресурсы Цикл
			Если СодержитТипПартнер(Ресурс.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("РегистрБухгалтерии", МетаданныеРегистра.Имя,
					"Ресурс", Ресурс.Имя, "");
			КонецЕсли;
		КонецЦикла;

		// Реквизиты
		Для Каждого Реквизит Из МетаданныеРегистра.Реквизиты Цикл
			Если СодержитТипПартнер(Реквизит.Тип, ТипПартнер) Тогда
				ДобавитьВТаблицуМетаданных("РегистрБухгалтерии", МетаданныеРегистра.Имя,
					"Реквизит", Реквизит.Имя, "");
			КонецЕсли;
		КонецЦикла;

	КонецЦикла;

КонецПроцедуры

&НаСервере
Функция СодержитТипПартнер(ОписаниеТипов, ТипПартнер)

	Если ОписаниеТипов = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;

	Возврат ОписаниеТипов.СодержитТип(ТипПартнер);

КонецФункции

&НаСервере
Процедура ДобавитьВТаблицуМетаданных(ТипОбъекта, ИмяОбъекта, ВидРеквизита, ИмяРеквизита, ДопИнформация)

	НоваяСтрока = ТаблицаМетаданных.Добавить();
	НоваяСтрока.ТипОбъекта = ТипОбъекта;
	НоваяСтрока.ИмяОбъекта = ИмяОбъекта;
	НоваяСтрока.ВидРеквизита = ВидРеквизита;
	НоваяСтрока.ИмяРеквизита = ИмяРеквизита;
	НоваяСтрока.ДопИнформация = ДопИнформация;
	НоваяСтрока.Использовать = Истина;

КонецПроцедуры

#КонецОбласти

#Область ПоискСсылок

&НаСервере
Функция НайтиСсылкиНаСервере()

	ТаблицаОбъектов.Очистить();

	Если НЕ ЗначениеЗаполнено(НеизвестныйПартнер) Тогда
		Возврат 0;
	КонецЕсли;

	КоличествоНайденных = 0;

	// Группируем метаданные по объектам для оптимизации запросов
	СтруктураОбъектов = Новый Соответствие;

	Для Каждого СтрокаМетаданных Из ТаблицаМетаданных Цикл

		Если НЕ СтрокаМетаданных.Использовать Тогда
			Продолжить;
		КонецЕсли;

		КлючОбъекта = СтрокаМетаданных.ТипОбъекта + "." + СтрокаМетаданных.ИмяОбъекта;

		Если СтруктураОбъектов.Получить(КлючОбъекта) = Неопределено Тогда
			СтруктураОбъектов.Вставить(КлючОбъекта, Новый Массив);
		КонецЕсли;

		СтруктураОбъектов[КлючОбъекта].Добавить(СтрокаМетаданных);

	КонецЦикла;

	// Выполняем поиск по каждому объекту
	Для Каждого КлючЗначение Из СтруктураОбъектов Цикл

		КлючОбъекта = КлючЗначение.Ключ;
		МассивРеквизитов = КлючЗначение.Значение;

		Если МассивРеквизитов.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;

		ПервыйЭлемент = МассивРеквизитов[0];
		ТипОбъекта = ПервыйЭлемент.ТипОбъекта;
		ИмяОбъекта = ПервыйЭлемент.ИмяОбъекта;

		Попытка
			Если ТипОбъекта = "Справочник" ИЛИ ТипОбъекта = "Документ" Тогда
				КоличествоНайденных = КоличествоНайденных +
					НайтиВСправочникеИлиДокументе(ТипОбъекта, ИмяОбъекта, МассивРеквизитов);

			ИначеЕсли ТипОбъекта = "РегистрСведений" Тогда
				КоличествоНайденных = КоличествоНайденных +
					НайтиВРегистреСведений(ИмяОбъекта, МассивРеквизитов);

			ИначеЕсли ТипОбъекта = "РегистрНакопления" ИЛИ ТипОбъекта = "РегистрБухгалтерии" Тогда
				КоличествоНайденных = КоличествоНайденных +
					НайтиВРегистреДвижений(ТипОбъекта, ИмяОбъекта, МассивРеквизитов);
			КонецЕсли;
		Исключение
			Сообщить("Ошибка при поиске в " + КлючОбъекта + ": " + ОписаниеОшибки());
		КонецПопытки;

	КонецЦикла;

	Возврат КоличествоНайденных;

КонецФункции

&НаСервере
Функция НайтиВСправочникеИлиДокументе(ТипОбъекта, ИмяОбъекта, МассивРеквизитов)

	КоличествоНайденных = 0;

	// Собираем реквизиты шапки и табличных частей
	РеквизитыШапки = Новый Массив;
	ТабличныеЧасти = Новый Соответствие;

	Для Каждого СтрокаМетаданных Из МассивРеквизитов Цикл
		Если СтрокаМетаданных.ВидРеквизита = "Реквизит" Тогда
			РеквизитыШапки.Добавить(СтрокаМетаданных.ИмяРеквизита);
		ИначеЕсли СтрокаМетаданных.ВидРеквизита = "ТабличнаяЧасть" Тогда
			ИмяТЧ = СтрокаМетаданных.ДопИнформация;
			Если ТабличныеЧасти.Получить(ИмяТЧ) = Неопределено Тогда
				ТабличныеЧасти.Вставить(ИмяТЧ, Новый Массив);
			КонецЕсли;
			ТабличныеЧасти[ИмяТЧ].Добавить(СтрокаМетаданных.ИмяРеквизита);
		КонецЕсли;
	КонецЦикла;

	// Формируем имя таблицы
	Если ТипОбъекта = "Справочник" Тогда
		ИмяТаблицы = "Справочник." + ИмяОбъекта;
	Иначе
		ИмяТаблицы = "Документ." + ИмяОбъекта;
	КонецЕсли;

	// 1. Поиск в шапке
	Если РеквизитыШапки.Количество() > 0 Тогда

		// Строим условие WHERE
		УсловияГде = Новый Массив;
		Для Каждого ИмяРеквизита Из РеквизитыШапки Цикл
			УсловияГде.Добавить("Т." + ИмяРеквизита + " = &НеизвестныйПартнер");
		КонецЦикла;

		// Определяем поле для получения контрагента
		ПолеКонтрагент = ОпределитьПолеКонтрагента(ТипОбъекта, ИмяОбъекта);

		ТекстЗапроса =
			"ВЫБРАТЬ
			|	Т.Ссылка КАК Объект" +
			?(ЗначениеЗаполнено(ПолеКонтрагент), ",
			|	Т." + ПолеКонтрагент + " КАК Контрагент", "") +
			?(ТипОбъекта = "Документ", ",
			|	Т.Проведен КАК Проведен", "") + "
			|ИЗ
			|	" + ИмяТаблицы + " КАК Т
			|ГДЕ
			|	(" + СтрСоединить(УсловияГде, " ИЛИ ") + ")
			|	И НЕ Т.ПометкаУдаления";

		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.УстановитьПараметр("НеизвестныйПартнер", НеизвестныйПартнер);

		Попытка
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();

			Пока Выборка.Следующий() Цикл
				НоваяСтрока = ТаблицаОбъектов.Добавить();
				НоваяСтрока.Объект = Выборка.Объект;
				НоваяСтрока.ТипОбъекта = ИмяТаблицы;
				НоваяСтрока.КатегорияОбъекта = ТипОбъекта;
				НоваяСтрока.Расположение = "Шапка: " + СтрСоединить(РеквизитыШапки, ", ");
				Если ЗначениеЗаполнено(ПолеКонтрагент) Тогда
					НоваяСтрока.Контрагент = Выборка.Контрагент;
				КонецЕсли;
				НоваяСтрока.ТекущийПартнер = НеизвестныйПартнер;
				Если ТипОбъекта = "Документ" Тогда
					НоваяСтрока.Проведен = Выборка.Проведен;
				КонецЕсли;
				НоваяСтрока.Обработан = Ложь;
				КоличествоНайденных = КоличествоНайденных + 1;
			КонецЦикла;
		Исключение
			Сообщить("Ошибка запроса к " + ИмяТаблицы + ": " + ОписаниеОшибки());
		КонецПопытки;

	КонецЕсли;

	// 2. Поиск в табличных частях
	Для Каждого КлючЗначениеТЧ Из ТабличныеЧасти Цикл

		ИмяТЧ = КлючЗначениеТЧ.Ключ;
		РеквизитыТЧ = КлючЗначениеТЧ.Значение;

		УсловияГдеТЧ = Новый Массив;
		Для Каждого ИмяРеквизита Из РеквизитыТЧ Цикл
			УсловияГдеТЧ.Добавить("ТЧ." + ИмяРеквизита + " = &НеизвестныйПартнер");
		КонецЦикла;

		ПолеКонтрагент = ОпределитьПолеКонтрагента(ТипОбъекта, ИмяОбъекта);

		ТекстЗапросаТЧ =
			"ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ТЧ.Ссылка КАК Объект" +
			?(ЗначениеЗаполнено(ПолеКонтрагент), ",
			|	ТЧ.Ссылка." + ПолеКонтрагент + " КАК Контрагент", "") +
			?(ТипОбъекта = "Документ", ",
			|	ТЧ.Ссылка.Проведен КАК Проведен", "") + "
			|ИЗ
			|	" + ИмяТаблицы + "." + ИмяТЧ + " КАК ТЧ
			|ГДЕ
			|	(" + СтрСоединить(УсловияГдеТЧ, " ИЛИ ") + ")
			|	И НЕ ТЧ.Ссылка.ПометкаУдаления";

		ЗапросТЧ = Новый Запрос(ТекстЗапросаТЧ);
		ЗапросТЧ.УстановитьПараметр("НеизвестныйПартнер", НеизвестныйПартнер);

		Попытка
			РезультатТЧ = ЗапросТЧ.Выполнить();
			ВыборкаТЧ = РезультатТЧ.Выбрать();

			Пока ВыборкаТЧ.Следующий() Цикл
				// Проверяем, не добавлен ли уже этот объект
				НайденнаяСтрока = Неопределено;
				Для Каждого СуществующаяСтрока Из ТаблицаОбъектов Цикл
					Если СуществующаяСтрока.Объект = ВыборкаТЧ.Объект Тогда
						НайденнаяСтрока = СуществующаяСтрока;
						Прервать;
					КонецЕсли;
				КонецЦикла;

				Если НайденнаяСтрока <> Неопределено Тогда
					// Дополняем информацию
					НайденнаяСтрока.Расположение = НайденнаяСтрока.Расположение +
						"; ТЧ." + ИмяТЧ + ": " + СтрСоединить(РеквизитыТЧ, ", ");
				Иначе
					НоваяСтрока = ТаблицаОбъектов.Добавить();
					НоваяСтрока.Объект = ВыборкаТЧ.Объект;
					НоваяСтрока.ТипОбъекта = ИмяТаблицы;
					НоваяСтрока.КатегорияОбъекта = ТипОбъекта;
					НоваяСтрока.Расположение = "ТЧ." + ИмяТЧ + ": " + СтрСоединить(РеквизитыТЧ, ", ");
					Если ЗначениеЗаполнено(ПолеКонтрагент) Тогда
						НоваяСтрока.Контрагент = ВыборкаТЧ.Контрагент;
					КонецЕсли;
					НоваяСтрока.ТекущийПартнер = НеизвестныйПартнер;
					Если ТипОбъекта = "Документ" Тогда
						НоваяСтрока.Проведен = ВыборкаТЧ.Проведен;
					КонецЕсли;
					НоваяСтрока.Обработан = Ложь;
					КоличествоНайденных = КоличествоНайденных + 1;
				КонецЕсли;
			КонецЦикла;
		Исключение
			Сообщить("Ошибка запроса к ТЧ " + ИмяТЧ + ": " + ОписаниеОшибки());
		КонецПопытки;

	КонецЦикла;

	Возврат КоличествоНайденных;

КонецФункции

&НаСервере
Функция НайтиВРегистреСведений(ИмяРегистра, МассивРеквизитов)

	КоличествоНайденных = 0;

	// Собираем все поля для условия
	УсловияГде = Новый Массив;
	ПоляВыборки = Новый Массив;

	Для Каждого СтрокаМетаданных Из МассивРеквизитов Цикл
		УсловияГде.Добавить("Т." + СтрокаМетаданных.ИмяРеквизита + " = &НеизвестныйПартнер");
		ПоляВыборки.Добавить(СтрокаМетаданных.ИмяРеквизита);
	КонецЦикла;

	Если УсловияГде.Количество() = 0 Тогда
		Возврат 0;
	КонецЕсли;

	// Проверяем наличие регистратора
	МетаданныеРегистра = Метаданные.РегистрыСведений[ИмяРегистра];
	ЕстьРегистратор = (МетаданныеРегистра.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору);

	ТекстЗапроса =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ" +
		?(ЕстьРегистратор, "
		|	Т.Регистратор КАК Регистратор,", "") + "
		|	""РегистрСведений." + ИмяРегистра + """ КАК ТипОбъекта
		|ИЗ
		|	РегистрСведений." + ИмяРегистра + " КАК Т
		|ГДЕ
		|	(" + СтрСоединить(УсловияГде, " ИЛИ ") + ")";

	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("НеизвестныйПартнер", НеизвестныйПартнер);

	Попытка
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();

		Пока Выборка.Следующий() Цикл
			НоваяСтрока = ТаблицаОбъектов.Добавить();
			Если ЕстьРегистратор Тогда
				НоваяСтрока.Объект = Выборка.Регистратор;
			КонецЕсли;
			НоваяСтрока.ТипОбъекта = "РегистрСведений." + ИмяРегистра;
			НоваяСтрока.КатегорияОбъекта = "РегистрСведений";
			НоваяСтрока.Расположение = СтрСоединить(ПоляВыборки, ", ");
			НоваяСтрока.ТекущийПартнер = НеизвестныйПартнер;
			НоваяСтрока.Обработан = Ложь;
			КоличествоНайденных = КоличествоНайденных + 1;
		КонецЦикла;
	Исключение
		Сообщить("Ошибка запроса к РегистрСведений." + ИмяРегистра + ": " + ОписаниеОшибки());
	КонецПопытки;

	Возврат КоличествоНайденных;

КонецФункции

&НаСервере
Функция НайтиВРегистреДвижений(ТипРегистра, ИмяРегистра, МассивРеквизитов)

	КоличествоНайденных = 0;

	// Собираем все поля для условия
	УсловияГде = Новый Массив;
	ПоляВыборки = Новый Массив;

	Для Каждого СтрокаМетаданных Из МассивРеквизитов Цикл
		УсловияГде.Добавить("Т." + СтрокаМетаданных.ИмяРеквизита + " = &НеизвестныйПартнер");
		ПоляВыборки.Добавить(СтрокаМетаданных.ИмяРеквизита);
	КонецЦикла;

	Если УсловияГде.Количество() = 0 Тогда
		Возврат 0;
	КонецЕсли;

	Если ТипРегистра = "РегистрНакопления" Тогда
		ИмяТаблицы = "РегистрНакопления." + ИмяРегистра;
	Иначе
		ИмяТаблицы = "РегистрБухгалтерии." + ИмяРегистра;
	КонецЕсли;

	// Запрос с получением контрагента из документа-регистратора
	ТекстЗапроса =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Регистратор КАК Регистратор,
		|	Т.Регистратор.Проведен КАК Проведен,
		|	""" + ИмяТаблицы + """ КАК ТипОбъекта
		|ИЗ
		|	" + ИмяТаблицы + " КАК Т
		|ГДЕ
		|	(" + СтрСоединить(УсловияГде, " ИЛИ ") + ")";

	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("НеизвестныйПартнер", НеизвестныйПартнер);

	Попытка
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();

		Пока Выборка.Следующий() Цикл
			// Проверяем, не добавлен ли уже этот регистратор
			УжеДобавлен = Ложь;
			Для Каждого СуществующаяСтрока Из ТаблицаОбъектов Цикл
				Если СуществующаяСтрока.Объект = Выборка.Регистратор Тогда
					// Дополняем расположение
					Если СтрНайти(СуществующаяСтрока.Расположение, ИмяТаблицы) = 0 Тогда
						СуществующаяСтрока.Расположение = СуществующаяСтрока.Расположение +
							"; " + ИмяТаблицы + "." + СтрСоединить(ПоляВыборки, ", ");
					КонецЕсли;
					УжеДобавлен = Истина;
					Прервать;
				КонецЕсли;
			КонецЦикла;

			Если НЕ УжеДобавлен Тогда
				НоваяСтрока = ТаблицаОбъектов.Добавить();
				НоваяСтрока.Объект = Выборка.Регистратор;
				НоваяСтрока.ТипОбъекта = ИмяТаблицы;
				НоваяСтрока.КатегорияОбъекта = ТипРегистра;
				НоваяСтрока.Расположение = СтрСоединить(ПоляВыборки, ", ") + " (перепровести документ)";
				НоваяСтрока.ТекущийПартнер = НеизвестныйПартнер;
				НоваяСтрока.Проведен = Выборка.Проведен;
				НоваяСтрока.Обработан = Ложь;

				// Пытаемся получить контрагента из документа
				НоваяСтрока.Контрагент = ПолучитьКонтрагентаИзДокумента(Выборка.Регистратор);

				КоличествоНайденных = КоличествоНайденных + 1;
			КонецЕсли;
		КонецЦикла;
	Исключение
		Сообщить("Ошибка запроса к " + ИмяТаблицы + ": " + ОписаниеОшибки());
	КонецПопытки;

	Возврат КоличествоНайденных;

КонецФункции

&НаСервере
Функция ПолучитьКонтрагентаИзДокумента(ДокументСсылка)

	Если НЕ ЗначениеЗаполнено(ДокументСсылка) Тогда
		Возврат Неопределено;
	КонецЕсли;

	Попытка
		МетаданныеДокумента = ДокументСсылка.Метаданные();

		// Ищем реквизит Контрагент
		Для Каждого Реквизит Из МетаданныеДокумента.Реквизиты Цикл
			Если НРег(Реквизит.Имя) = "контрагент" Тогда
				Возврат ДокументСсылка[Реквизит.Имя];
			КонецЕсли;
		КонецЦикла;
	Исключение
	КонецПопытки;

	Возврат Неопределено;

КонецФункции

&НаСервере
Функция ОпределитьПолеКонтрагента(ТипОбъекта, ИмяОбъекта)

	// Пытаемся найти поле Контрагент в метаданных
	Попытка
		Если ТипОбъекта = "Справочник" Тогда
			МетаданныеОбъекта = Метаданные.Справочники[ИмяОбъекта];
		Иначе
			МетаданныеОбъекта = Метаданные.Документы[ИмяОбъекта];
		КонецЕсли;

		// Ищем реквизит Контрагент
		Для Каждого Реквизит Из МетаданныеОбъекта.Реквизиты Цикл
			Если НРег(Реквизит.Имя) = "контрагент" Тогда
				Возврат Реквизит.Имя;
			КонецЕсли;
		КонецЦикла;
	Исключение
	КонецПопытки;

	Возврат "";

КонецФункции

#КонецОбласти

#Область ЗаменаПартнеров

&НаСервере
Функция ЗаменитьПартнеровНаСервере()

	КоличествоОбработанных = 0;

	// ПОРЯДОК ОБРАБОТКИ:
	// 1. Справочники
	// 2. Документы (с перепроведением)
	// 3. Регистры - через обработку документов-регистраторов

	// 1. СПРАВОЧНИКИ
	Для Каждого СтрокаТаблицы Из ТаблицаОбъектов Цикл
		Если СтрокаТаблицы.Обработан ИЛИ СтрокаТаблицы.КатегорияОбъекта <> "Справочник" Тогда
			Продолжить;
		КонецЕсли;

		Попытка
			Если ОбработатьОбъектУниверсально(СтрокаТаблицы) Тогда
				СтрокаТаблицы.Обработан = Истина;
				КоличествоОбработанных = КоличествоОбработанных + 1;
			КонецЕсли;
		Исключение
			СтрокаТаблицы.Ошибка = ОписаниеОшибки();
		КонецПопытки;
	КонецЦикла;

	// 2. ДОКУМЕНТЫ
	Для Каждого СтрокаТаблицы Из ТаблицаОбъектов Цикл
		Если СтрокаТаблицы.Обработан ИЛИ СтрокаТаблицы.КатегорияОбъекта <> "Документ" Тогда
			Продолжить;
		КонецЕсли;

		Попытка
			Если ОбработатьОбъектУниверсально(СтрокаТаблицы) Тогда
				СтрокаТаблицы.Обработан = Истина;
				КоличествоОбработанных = КоличествоОбработанных + 1;
			КонецЕсли;
		Исключение
			СтрокаТаблицы.Ошибка = ОписаниеОшибки();
		КонецПопытки;
	КонецЦикла;

	// 3. РЕГИСТРЫ СВЕДЕНИЙ (независимые)
	Для Каждого СтрокаТаблицы Из ТаблицаОбъектов Цикл
		Если СтрокаТаблицы.Обработан ИЛИ СтрокаТаблицы.КатегорияОбъекта <> "РегистрСведений" Тогда
			Продолжить;
		КонецЕсли;

		Попытка
			Если ОбработатьРегистрСведенийУниверсально(СтрокаТаблицы) Тогда
				СтрокаТаблицы.Обработан = Истина;
				КоличествоОбработанных = КоличествоОбработанных + 1;
			КонецЕсли;
		Исключение
			СтрокаТаблицы.Ошибка = ОписаниеОшибки();
		КонецПопытки;
	КонецЦикла;

	// 4. РЕГИСТРЫ НАКОПЛЕНИЯ/БУХГАЛТЕРИИ - обрабатываем через документ-регистратор
	Для Каждого СтрокаТаблицы Из ТаблицаОбъектов Цикл
		Если СтрокаТаблицы.Обработан Тогда
			Продолжить;
		КонецЕсли;

		Если СтрокаТаблицы.КатегорияОбъекта = "РегистрНакопления"
			ИЛИ СтрокаТаблицы.КатегорияОбъекта = "РегистрБухгалтерии" Тогда

			Попытка
				Если ОбработатьРегистраторДляРегистра(СтрокаТаблицы) Тогда
					СтрокаТаблицы.Обработан = Истина;
					КоличествоОбработанных = КоличествоОбработанных + 1;
				КонецЕсли;
			Исключение
				СтрокаТаблицы.Ошибка = ОписаниеОшибки();
			КонецПопытки;

		КонецЕсли;
	КонецЦикла;

	Возврат КоличествоОбработанных;

КонецФункции

&НаСервере
Функция ОбработатьРегистраторДляРегистра(СтрокаТаблицы)

	// Объект - это документ-регистратор
	Ссылка = СтрокаТаблицы.Объект;

	Если НЕ ЗначениеЗаполнено(Ссылка) Тогда
		СтрокаТаблицы.Ошибка = "Пустая ссылка на документ-регистратор";
		Возврат Ложь;
	КонецЕсли;

	// Проверяем что это документ
	Если НЕ Документы.ТипВсеСсылки().СодержитТип(ТипЗнч(Ссылка)) Тогда
		СтрокаТаблицы.Ошибка = "Объект не является документом";
		Возврат Ложь;
	КонецЕсли;

	// Получаем объект документа
	ДокументОбъект = Ссылка.ПолучитьОбъект();

	Если ДокументОбъект = Неопределено Тогда
		СтрокаТаблицы.Ошибка = "Документ не найден";
		Возврат Ложь;
	КонецЕсли;

	// Определяем нового партнера
	НовыйПартнер = Неопределено;

	// Сначала пытаемся по контрагенту из таблицы
	Если ЗначениеЗаполнено(СтрокаТаблицы.Контрагент) Тогда
		НовыйПартнер = ПолучитьПартнераПоКонтрагенту(СтрокаТаблицы.Контрагент);
	КонецЕсли;

	// Если не получилось - ищем контрагента в документе
	Если НЕ ЗначениеЗаполнено(НовыйПартнер) Тогда
		КонтрагентИзДокумента = ПолучитьКонтрагентаИзДокумента(Ссылка);
		Если ЗначениеЗаполнено(КонтрагентИзДокумента) Тогда
			СтрокаТаблицы.Контрагент = КонтрагентИзДокумента;
			НовыйПартнер = ПолучитьПартнераПоКонтрагенту(КонтрагентИзДокумента);
		КонецЕсли;
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(НовыйПартнер) Тогда
		СтрокаТаблицы.Ошибка = "Не удалось определить нового партнера по контрагенту";
		Возврат Ложь;
	КонецЕсли;

	Изменен = Ложь;

	// Получаем метаданные документа
	МетаданныеДокумента = ДокументОбъект.Метаданные();

	// 1. Обрабатываем реквизиты шапки (включая Партнер)
	Для Каждого Реквизит Из МетаданныеДокумента.Реквизиты Цикл
		Если СодержитТипПартнер(Реквизит.Тип, Тип("СправочникСсылка.Партнеры")) Тогда
			ТекущееЗначение = ДокументОбъект[Реквизит.Имя];
			Если ТекущееЗначение = НеизвестныйПартнер Тогда
				ДокументОбъект[Реквизит.Имя] = НовыйПартнер;
				Изменен = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;

	// 2. Обрабатываем табличные части
	Для Каждого ТабличнаяЧасть Из МетаданныеДокумента.ТабличныеЧасти Цикл
		Для Каждого РеквизитТЧ Из ТабличнаяЧасть.Реквизиты Цикл
			Если СодержитТипПартнер(РеквизитТЧ.Тип, Тип("СправочникСсылка.Партнеры")) Тогда
				Для Каждого СтрокаТЧ Из ДокументОбъект[ТабличнаяЧасть.Имя] Цикл
					Если СтрокаТЧ[РеквизитТЧ.Имя] = НеизвестныйПартнер Тогда
						СтрокаТЧ[РеквизитТЧ.Имя] = НовыйПартнер;
						Изменен = Истина;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;

	// 3. КРИТИЧЕСКИ ВАЖНО: Удаляем записи АналитикаУчетаПоПартнерам с "Неизвестный партнер"
	// БЕЗ этого перепроведение НЕ обновит партнера в регистрах накопления!
	// Причина: ДвиженияДенежныеСредстваКонтрагент берет Партнер из КлючАналитики!
	УдалитьКэшированныеКлючиАналитики(ДокументОбъект, НовыйПартнер);

	// 4. ЗАПИСЫВАЕМ И ПЕРЕПРОВОДИМ ДОКУМЕНТ
	// Это обновит движения по регистрам!
	Если Изменен ИЛИ ДокументОбъект.Проведен Тогда

		СтрокаТаблицы.НовыйПартнер = НовыйПартнер;

		Если ДокументОбъект.Проведен Тогда
			// ПЕРЕПРОВОДИМ - это обновит регистры!
			ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
		Иначе
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			ДокументОбъект.Записать();
		КонецЕсли;

		Возврат Истина;

	КонецЕсли;

	СтрокаТаблицы.Ошибка = "Документ не изменен";
	Возврат Ложь;

КонецФункции

// ============================================================================
// КРИТИЧЕСКАЯ ФУНКЦИЯ: Удаление закэшированных ключей аналитики
// ============================================================================
// ПРОБЛЕМА:
// При проведении документа, рух по регистру ДвиженияДенежныеСредстваКонтрагент
// берет Партнер НЕ из ТЧ документа, а из регистра сведений АналитикаУчетаПоПартнерам!
//
// ManagerModule.bsl:4675:
//   ТаблицаРасшифровкаПлатежа.АналитикаУчетаПоПартнерам.Партнер КАК Партнер
//
// Поэтому если в АналитикаУчетаПоПартнерам есть запись с "Неизвестный партнер",
// то даже после замены партнера в ТЧ документа и перепроведения,
// в регистрах накопления останется "Неизвестный партнер"!
//
// РЕШЕНИЕ:
// Перед перепроведением удаляем записи из АналитикаУчетаПоПартнерам
// для данной комбинации (Организация, Контрагент, Договор, НаправлениеДеятельности)
// где Партнер = "Неизвестный партнер"
// После этого при проведении система создаст НОВЫЙ ключ аналитики с правильным партнером.
// ============================================================================
&НаСервере
Процедура УдалитьКэшированныеКлючиАналитики(ДокументОбъект, НовыйПартнер)

	// Собираем уникальные комбинации из ТЧ документа
	КомбинацииДляОчистки = Новый Массив;

	МетаданныеДокумента = ДокументОбъект.Метаданные();

	// Ищем ТЧ с полями для аналитики (Организация, Контрагент, Договор и т.д.)
	// Типичные ТЧ: РасшифровкаПлатежа, Товары, Услуги
	Для Каждого ТабличнаяЧасть Из МетаданныеДокумента.ТабличныеЧасти Цикл

		// Проверяем наличие нужных полей в ТЧ
		ЕстьКонтрагент = Ложь;
		ЕстьДоговор = Ложь;
		ЕстьНаправлениеДеятельности = Ложь;

		Для Каждого РеквизитТЧ Из ТабличнаяЧасть.Реквизиты Цикл
			ИмяВНижнемРегистре = НРег(РеквизитТЧ.Имя);
			Если ИмяВНижнемРегистре = "контрагент" Тогда
				ЕстьКонтрагент = Истина;
			ИначеЕсли СтрНайти(ИмяВНижнемРегистре, "договор") > 0 Тогда
				ЕстьДоговор = Истина;
			ИначеЕсли ИмяВНижнемРегистре = "направлениедеятельности" Тогда
				ЕстьНаправлениеДеятельности = Истина;
			КонецЕсли;
		КонецЦикла;

		// Обрабатываем только ТЧ с аналитикой
		Если ЕстьКонтрагент ИЛИ ЕстьДоговор Тогда
			Для Каждого СтрокаТЧ Из ДокументОбъект[ТабличнаяЧасть.Имя] Цикл

				// Получаем значения полей аналитики из строки ТЧ
				Комбинация = Новый Структура;
				Комбинация.Вставить("Организация", ДокументОбъект.Организация);

				// Контрагент
				Попытка
					Комбинация.Вставить("Контрагент", СтрокаТЧ.Контрагент);
				Исключение
					Попытка
						Комбинация.Вставить("Контрагент", ДокументОбъект.Контрагент);
					Исключение
						Комбинация.Вставить("Контрагент", Справочники.Контрагенты.ПустаяСсылка());
					КонецПопытки;
				КонецПопытки;

				// Договор
				Попытка
					Комбинация.Вставить("Договор", СтрокаТЧ.ДоговорКонтрагента);
				Исключение
					Попытка
						Комбинация.Вставить("Договор", СтрокаТЧ.Договор);
					Исключение
						Попытка
							Комбинация.Вставить("Договор", ДокументОбъект.ДоговорКонтрагента);
						Исключение
							Комбинация.Вставить("Договор", Справочники.ДоговорыКонтрагентов.ПустаяСсылка());
						КонецПопытки;
					КонецПопытки;
				КонецПопытки;

				// Направление деятельности
				Попытка
					Комбинация.Вставить("НаправлениеДеятельности", СтрокаТЧ.НаправлениеДеятельности);
				Исключение
					Попытка
						Комбинация.Вставить("НаправлениеДеятельности", ДокументОбъект.НаправлениеДеятельности);
					Исключение
						Комбинация.Вставить("НаправлениеДеятельности", Справочники.НаправленияДеятельности.ПустаяСсылка());
					КонецПопытки;
				КонецПопытки;

				// Добавляем комбинацию, если не добавлена ранее
				УжеЕсть = Ложь;
				Для Каждого СуществующаяКомбинация Из КомбинацииДляОчистки Цикл
					Если СуществующаяКомбинация.Организация = Комбинация.Организация
						И СуществующаяКомбинация.Контрагент = Комбинация.Контрагент
						И СуществующаяКомбинация.Договор = Комбинация.Договор
						И СуществующаяКомбинация.НаправлениеДеятельности = Комбинация.НаправлениеДеятельности Тогда
						УжеЕсть = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;

				Если НЕ УжеЕсть Тогда
					КомбинацииДляОчистки.Добавить(Комбинация);
				КонецЕсли;

			КонецЦикла;
		КонецЕсли;

	КонецЦикла;

	// Удаляем записи из АналитикаУчетаПоПартнерам с "Неизвестный партнер"
	Для Каждого Комбинация Из КомбинацииДляОчистки Цикл
		УдалитьЗаписьАналитикиПоПартнерам(Комбинация);
	КонецЦикла;

	// Также удаляем по данным шапки документа
	Попытка
		КомбинацияШапки = Новый Структура;
		КомбинацияШапки.Вставить("Организация", ДокументОбъект.Организация);

		Попытка
			КомбинацияШапки.Вставить("Контрагент", ДокументОбъект.Контрагент);
		Исключение
			КомбинацияШапки.Вставить("Контрагент", Справочники.Контрагенты.ПустаяСсылка());
		КонецПопытки;

		Попытка
			КомбинацияШапки.Вставить("Договор", ДокументОбъект.ДоговорКонтрагента);
		Исключение
			Попытка
				КомбинацияШапки.Вставить("Договор", ДокументОбъект.Договор);
			Исключение
				КомбинацияШапки.Вставить("Договор", Справочники.ДоговорыКонтрагентов.ПустаяСсылка());
			КонецПопытки;
		КонецПопытки;

		Попытка
			КомбинацияШапки.Вставить("НаправлениеДеятельности", ДокументОбъект.НаправлениеДеятельности);
		Исключение
			КомбинацияШапки.Вставить("НаправлениеДеятельности", Справочники.НаправленияДеятельности.ПустаяСсылка());
		КонецПопытки;

		УдалитьЗаписьАналитикиПоПартнерам(КомбинацияШапки);
	Исключение
		// Игнорируем ошибки - документ может не иметь нужных реквизитов
	КонецПопытки;

КонецПроцедуры

// Удаление записи из регистра АналитикаУчетаПоПартнерам
&НаСервере
Процедура УдалитьЗаписьАналитикиПоПартнерам(Комбинация)

	// Ищем запись с "Неизвестный партнер" для данной комбинации
	Отбор = Новый Структура;
	Отбор.Вставить("Партнер", НеизвестныйПартнер);
	Отбор.Вставить("Организация", Комбинация.Организация);

	Если ЗначениеЗаполнено(Комбинация.Контрагент) Тогда
		Отбор.Вставить("Контрагент", Комбинация.Контрагент);
	КонецЕсли;

	Если ЗначениеЗаполнено(Комбинация.Договор) Тогда
		Отбор.Вставить("Договор", Комбинация.Договор);
	КонецЕсли;

	Если ЗначениеЗаполнено(Комбинация.НаправлениеДеятельности) Тогда
		Отбор.Вставить("НаправлениеДеятельности", Комбинация.НаправлениеДеятельности);
	КонецЕсли;

	Попытка
		// Получаем менеджер записи и удаляем
		МенеджерЗаписи = РегистрыСведений.АналитикаУчетаПоПартнерам.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Партнер = НеизвестныйПартнер;
		МенеджерЗаписи.Организация = Комбинация.Организация;

		Если ЗначениеЗаполнено(Комбинация.Контрагент) Тогда
			МенеджерЗаписи.Контрагент = Комбинация.Контрагент;
		КонецЕсли;

		Если ЗначениеЗаполнено(Комбинация.Договор) Тогда
			МенеджерЗаписи.Договор = Комбинация.Договор;
		КонецЕсли;

		Если ЗначениеЗаполнено(Комбинация.НаправлениеДеятельности) Тогда
			МенеджерЗаписи.НаправлениеДеятельности = Комбинация.НаправлениеДеятельности;
		КонецЕсли;

		МенеджерЗаписи.Прочитать();

		Если МенеджерЗаписи.Выбран() Тогда
			МенеджерЗаписи.Удалить();
		КонецЕсли;

	Исключение
		// Запись не найдена или ошибка - игнорируем
	КонецПопытки;

КонецПроцедуры

&НаСервере
Функция ОбработатьОбъектУниверсально(СтрокаТаблицы)

	Ссылка = СтрокаТаблицы.Объект;

	Если НЕ ЗначениеЗаполнено(Ссылка) Тогда
		СтрокаТаблицы.Ошибка = "Пустая ссылка на объект";
		Возврат Ложь;
	КонецЕсли;

	// Получаем объект
	ОбъектДанных = Ссылка.ПолучитьОбъект();

	Если ОбъектДанных = Неопределено Тогда
		СтрокаТаблицы.Ошибка = "Объект не найден";
		Возврат Ложь;
	КонецЕсли;

	// Определяем нового партнера
	НовыйПартнер = ПолучитьПартнераПоКонтрагенту(СтрокаТаблицы.Контрагент);

	Если НЕ ЗначениеЗаполнено(НовыйПартнер) Тогда
		СтрокаТаблицы.Ошибка = "Не удалось определить нового партнера по контрагенту";
		Возврат Ложь;
	КонецЕсли;

	Изменен = Ложь;

	// Получаем метаданные объекта
	МетаданныеОбъекта = ОбъектДанных.Метаданные();

	// 1. Обрабатываем реквизиты шапки
	Для Каждого Реквизит Из МетаданныеОбъекта.Реквизиты Цикл
		Если СодержитТипПартнер(Реквизит.Тип, Тип("СправочникСсылка.Партнеры")) Тогда
			ТекущееЗначение = ОбъектДанных[Реквизит.Имя];
			Если ТекущееЗначение = НеизвестныйПартнер Тогда
				ОбъектДанных[Реквизит.Имя] = НовыйПартнер;
				Изменен = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;

	// 2. Обрабатываем табличные части
	Для Каждого ТабличнаяЧасть Из МетаданныеОбъекта.ТабличныеЧасти Цикл
		Для Каждого РеквизитТЧ Из ТабличнаяЧасть.Реквизиты Цикл
			Если СодержитТипПартнер(РеквизитТЧ.Тип, Тип("СправочникСсылка.Партнеры")) Тогда
				Для Каждого СтрокаТЧ Из ОбъектДанных[ТабличнаяЧасть.Имя] Цикл
					Если СтрокаТЧ[РеквизитТЧ.Имя] = НеизвестныйПартнер Тогда
						СтрокаТЧ[РеквизитТЧ.Имя] = НовыйПартнер;
						Изменен = Истина;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;

	// 3. Записываем объект
	Если Изменен Тогда

		СтрокаТаблицы.НовыйПартнер = НовыйПартнер;

		// Для документов - с перепроведением
		Если СтрокаТаблицы.КатегорияОбъекта = "Документ" И СтрокаТаблицы.Проведен Тогда
			ОбъектДанных.Записать(РежимЗаписиДокумента.Проведение);
		Иначе
			ОбъектДанных.ОбменДанными.Загрузка = Истина;
			ОбъектДанных.Записать();
		КонецЕсли;

		Возврат Истина;

	КонецЕсли;

	Возврат Ложь;

КонецФункции

&НаСервере
Функция ОбработатьРегистрСведенийУниверсально(СтрокаТаблицы)

	// Получаем имя регистра из типа объекта
	ИмяРегистра = СтрЗаменить(СтрокаТаблицы.ТипОбъекта, "РегистрСведений.", "");

	МетаданныеРегистра = Метаданные.РегистрыСведений[ИмяРегистра];

	Если МетаданныеРегистра = Неопределено Тогда
		СтрокаТаблицы.Ошибка = "Регистр не найден в метаданных";
		Возврат Ложь;
	КонецЕсли;

	// Проверяем режим записи
	Если МетаданныеРегистра.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору Тогда
		// Записи подчинены регистратору - обработаем документ
		Если ЗначениеЗаполнено(СтрокаТаблицы.Объект) Тогда
			Возврат ОбработатьРегистраторДляРегистра(СтрокаТаблицы);
		Иначе
			СтрокаТаблицы.Ошибка = "Регистр подчинен регистратору - нет ссылки на документ";
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;

	// Для независимых регистров
	СтрокаТаблицы.Ошибка = "Независимый регистр - требуется ручная обработка";
	Возврат Ложь;

КонецФункции

#КонецОбласти

#Область ПолучениеПартнера

&НаСервере
Функция ПолучитьПартнераПоКонтрагенту(Контрагент)

	Если НЕ ЗначениеЗаполнено(Контрагент) Тогда
		Возврат Справочники.Партнеры.ПустаяСсылка();
	КонецЕсли;

	Если ТипЗнч(Контрагент) <> Тип("СправочникСсылка.Контрагенты") Тогда
		Возврат Справочники.Партнеры.ПустаяСсылка();
	КонецЕсли;

	// Используем типовой механизм
	Попытка
		Возврат ДенежныеСредстваСервер.ПолучитьПартнераПоКонтрагенту(Контрагент);
	Исключение
	КонецПопытки;

	// Fallback - получить партнера из реквизита контрагента
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст =
			"ВЫБРАТЬ
			|	Контрагенты.Партнер КАК Партнер
			|ИЗ
			|	Справочник.Контрагенты КАК Контрагенты
			|ГДЕ
			|	Контрагенты.Ссылка = &Контрагент";

		Запрос.УстановитьПараметр("Контрагент", Контрагент);

		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Партнер;
			КонецЕсли;
		КонецЕсли;
	Исключение
	КонецПопытки;

	Возврат Справочники.Партнеры.ПустаяСсылка();

КонецФункции

#КонецОбласти
