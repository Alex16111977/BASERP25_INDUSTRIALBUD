////////////////////////////////////////////////////////////////////////////////
// Обработка неизвестного партнера - Модуль формы (внешняя обработка EPF)
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	ИнформационноеСообщение = "Нажмите ""Найти документы"" для поиска документов со ссылкой на НеизвестныйПартнер";

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура НайтиДокументы(Команда)

	НайтиДокументыНаСервере();

КонецПроцедуры

&НаКлиенте
Процедура ОбработатьВсе(Команда)

	Если ТаблицаДокументов.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Сначала выполните поиск документов");
		Возврат;
	КонецЕсли;

	ОбработатьВсеНаСервере();

КонецПроцедуры

&НаКлиенте
Процедура ОбработатьВыделенные(Команда)

	ВыделенныеСтроки = Элементы.ТаблицаДокументов.ВыделенныеСтроки;

	Если ВыделенныеСтроки.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Выделите документы для обработки");
		Возврат;
	КонецЕсли;

	ОбработатьВыделенныеНаСервере(ВыделенныеСтроки);

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункцииНаСервере

&НаСервере
Процедура НайтиДокументыНаСервере()

	ТаблицаДокументов.Очистить();
	ИнформационноеСообщение = "Выполняется поиск...";

	НеизвестныйПартнер = Справочники.Партнеры.НеизвестныйПартнер;

	// Получаем все ссылки на НеизвестныйПартнер в базе
	МассивСсылок = НайтиПоСсылкам(НеизвестныйПартнер);

	КоличествоНайденных = 0;

	Для Каждого ЭлементСсылки Из МассивСсылок Цикл

		// Работаем только с документами
		Если НЕ Документы.ТипВсеСсылки().СодержитТип(ТипЗнч(ЭлементСсылки.Ключ)) Тогда
			Продолжить;
		КонецЕсли;

		ДокументСсылка = ЭлементСсылки.Ключ;

		Для Каждого МестоИспользования Из ЭлементСсылки.Значение Цикл

			НоваяСтрока = ТаблицаДокументов.Добавить();
			НоваяСтрока.Документ = ДокументСсылка;
			НоваяСтрока.ТипДокумента = Строка(ТипЗнч(ДокументСсылка));
			НоваяСтрока.Обработан = Ложь;

			// Определяем тип использования (шапка или табличная часть)
			Если СтрНайти(МестоИспользования.Метаданные, "ТабличнаяЧасть") > 0
				ИЛИ СтрНайти(МестоИспользования.Метаданные, "TabularSection") > 0 Тогда
				НоваяСтрока.ТаблицаИлиШапка = "ТабличнаяЧасть";
			Иначе
				НоваяСтрока.ТаблицаИлиШапка = "Шапка";
			КонецЕсли;

			// Пытаемся получить контрагента документа
			Попытка
				СтруктураРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка, "Контрагент");
				НоваяСтрока.Контрагент = СтруктураРеквизитов.Контрагент;
			Исключение
				НоваяСтрока.Контрагент = Неопределено;
			КонецПопытки;

			КоличествоНайденных = КоличествоНайденных + 1;

		КонецЦикла;

	КонецЦикла;

	// Сворачиваем дубли по документам
	СвернутьТаблицуДокументов();

	ИнформационноеСообщение = "Найдено документов: " + Строка(ТаблицаДокументов.Количество());

КонецПроцедуры

&НаСервере
Процедура СвернутьТаблицуДокументов()

	// Создаем временную таблицу для сворачивания
	ВременнаяТаблица = Новый ТаблицаЗначений;
	ВременнаяТаблица.Колонки.Добавить("Документ");
	ВременнаяТаблица.Колонки.Добавить("ТипДокумента");
	ВременнаяТаблица.Колонки.Добавить("ТаблицаИлиШапка");
	ВременнаяТаблица.Колонки.Добавить("Контрагент");
	ВременнаяТаблица.Колонки.Добавить("НовыйПартнер");
	ВременнаяТаблица.Колонки.Добавить("Обработан");

	Для Каждого СтрокаТЗ Из ТаблицаДокументов Цикл
		НоваяСтрока = ВременнаяТаблица.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЗ);
	КонецЦикла;

	ВременнаяТаблица.Свернуть("Документ, ТипДокумента, ТаблицаИлиШапка, Контрагент", "");

	ТаблицаДокументов.Очистить();

	Для Каждого СтрокаВТ Из ВременнаяТаблица Цикл
		НоваяСтрока = ТаблицаДокументов.Добавить();
		НоваяСтрока.Документ = СтрокаВТ.Документ;
		НоваяСтрока.ТипДокумента = СтрокаВТ.ТипДокумента;
		НоваяСтрока.ТаблицаИлиШапка = СтрокаВТ.ТаблицаИлиШапка;
		НоваяСтрока.Контрагент = СтрокаВТ.Контрагент;
		НоваяСтрока.Обработан = Ложь;
	КонецЦикла;

КонецПроцедуры

&НаСервере
Процедура ОбработатьВсеНаСервере()

	ОбработаноУспешно = 0;
	ОбработаноСОшибками = 0;

	Для Каждого СтрокаТаблицы Из ТаблицаДокументов Цикл

		Если СтрокаТаблицы.Обработан Тогда
			Продолжить;
		КонецЕсли;

		Результат = ОбработатьДокументНаСервере(СтрокаТаблицы.Документ, СтрокаТаблицы.ТаблицаИлиШапка);

		Если Результат.Успех Тогда
			СтрокаТаблицы.Обработан = Истина;
			СтрокаТаблицы.НовыйПартнер = Результат.НовыйПартнер;
			ОбработаноУспешно = ОбработаноУспешно + 1;
		Иначе
			ОбработаноСОшибками = ОбработаноСОшибками + 1;
		КонецЕсли;

	КонецЦикла;

	ИнформационноеСообщение = "Обработано успешно: " + Строка(ОбработаноУспешно) + ", с ошибками: " + Строка(ОбработаноСОшибками);

КонецПроцедуры

&НаСервере
Процедура ОбработатьВыделенныеНаСервере(ВыделенныеСтроки)

	ОбработаноУспешно = 0;
	ОбработаноСОшибками = 0;

	Для Каждого ИдентификаторСтроки Из ВыделенныеСтроки Цикл

		СтрокаТаблицы = ТаблицаДокументов.НайтиПоИдентификатору(ИдентификаторСтроки);

		Если СтрокаТаблицы = Неопределено ИЛИ СтрокаТаблицы.Обработан Тогда
			Продолжить;
		КонецЕсли;

		Результат = ОбработатьДокументНаСервере(СтрокаТаблицы.Документ, СтрокаТаблицы.ТаблицаИлиШапка);

		Если Результат.Успех Тогда
			СтрокаТаблицы.Обработан = Истина;
			СтрокаТаблицы.НовыйПартнер = Результат.НовыйПартнер;
			ОбработаноУспешно = ОбработаноУспешно + 1;
		Иначе
			ОбработаноСОшибками = ОбработаноСОшибками + 1;
		КонецЕсли;

	КонецЦикла;

	ИнформационноеСообщение = "Обработано успешно: " + Строка(ОбработаноУспешно) + ", с ошибками: " + Строка(ОбработаноСОшибками);

КонецПроцедуры

&НаСервере
Функция ОбработатьДокументНаСервере(ДокументСсылка, ТаблицаИлиШапка)

	Результат = Новый Структура("Успех, Сообщение, НовыйПартнер", Ложь, "", Неопределено);

	НеизвестныйПартнер = Справочники.Партнеры.НеизвестныйПартнер;

	Попытка

		ДокументОбъект = ДокументСсылка.ПолучитьОбъект();

		Если ДокументОбъект = Неопределено Тогда
			Результат.Сообщение = "Не удалось получить объект документа";
			Возврат Результат;
		КонецЕсли;

		// Проверяем наличие реквизита Контрагент
		ЕстьКонтрагент = Ложь;
		Попытка
			Контрагент = ДокументОбъект.Контрагент;
			ЕстьКонтрагент = Истина;
		Исключение
			ЕстьКонтрагент = Ложь;
		КонецПопытки;

		Если НЕ ЕстьКонтрагент ИЛИ НЕ ЗначениеЗаполнено(ДокументОбъект.Контрагент) Тогда
			Результат.Сообщение = "Документ не содержит заполненного контрагента";
			Возврат Результат;
		КонецЕсли;

		// Получаем партнера по контрагенту
		ПартнерПолученныйПоКонтрагенту = ДенежныеСредстваСервер.ПолучитьПартнераПоКонтрагенту(ДокументОбъект.Контрагент);

		Изменен = Ложь;

		// Получаем контрагента из базы для сравнения
		КонтрагентВБазе = Неопределено;
		Попытка
			Если ЗначениеЗаполнено(ДокументОбъект.Ссылка) Тогда
				СтруктураРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументОбъект.Ссылка, "Контрагент");
				КонтрагентВБазе = СтруктураРеквизитов.Контрагент;
			КонецЕсли;
		Исключение
			КонтрагентВБазе = Неопределено;
		КонецПопытки;

		// Обработка табличных частей
		Если ТаблицаИлиШапка = "ТабличнаяЧасть" ИЛИ ТаблицаИлиШапка = "" Тогда

			МетаданныеДокумента = ДокументОбъект.Метаданные();

			Для Каждого ТЧ Из МетаданныеДокумента.ТабличныеЧасти Цикл

				// Проверяем наличие реквизита Партнер
				ЕстьРеквизитПартнер = Ложь;
				Для Каждого Реквизит Из ТЧ.Реквизиты Цикл
					Если Реквизит.Имя = "Партнер" Тогда
						ЕстьРеквизитПартнер = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;

				Если НЕ ЕстьРеквизитПартнер Тогда
					Продолжить;
				КонецЕсли;

				ТабличнаяЧасть = ДокументОбъект[ТЧ.Имя];

				Для Каждого Строка Из ТабличнаяЧасть Цикл

					КонтрагентИзменился = (КонтрагентВБазе <> Неопределено) И (КонтрагентВБазе <> ДокументОбъект.Контрагент);

					Если НЕ ЗначениеЗаполнено(Строка.Партнер)
						ИЛИ Строка.Партнер = НеизвестныйПартнер
						ИЛИ КонтрагентИзменился Тогда

						Строка.Партнер = ПартнерПолученныйПоКонтрагенту;

						Если НЕ ЗначениеЗаполнено(Строка.Партнер) Тогда
							Строка.Партнер = НеизвестныйПартнер;
						КонецЕсли;

						Изменен = Истина;

					КонецЕсли;

				КонецЦикла;

			КонецЦикла;

		КонецЕсли;

		// Обработка шапки
		Если ТаблицаИлиШапка = "Шапка" ИЛИ ТаблицаИлиШапка = "" Тогда

			МетаданныеДокумента = ДокументОбъект.Метаданные();
			ЕстьРеквизитПартнер = Ложь;

			Для Каждого Реквизит Из МетаданныеДокумента.Реквизиты Цикл
				Если Реквизит.Имя = "Партнер" Тогда
					ЕстьРеквизитПартнер = Истина;
					Прервать;
				КонецЕсли;
			КонецЦикла;

			Если ЕстьРеквизитПартнер И ЗначениеЗаполнено(ДокументОбъект.Контрагент) Тогда

				КонтрагентИзменился = (КонтрагентВБазе <> Неопределено) И (КонтрагентВБазе <> ДокументОбъект.Контрагент);

				Если НЕ ЗначениеЗаполнено(ДокументОбъект.Партнер)
					ИЛИ ДокументОбъект.Партнер = НеизвестныйПартнер
					ИЛИ КонтрагентИзменился Тогда

					ДокументОбъект.Партнер = ПартнерПолученныйПоКонтрагенту;

					Если НЕ ЗначениеЗаполнено(ДокументОбъект.Партнер) Тогда
						ДокументОбъект.Партнер = НеизвестныйПартнер;
					КонецЕсли;

					Изменен = Истина;

				КонецЕсли;

			КонецЕсли;

		КонецЕсли;

		Если Изменен Тогда
			ДокументОбъект.ОбменДанными.Загрузка = Истина;
			ДокументОбъект.Записать();

			Результат.Успех = Истина;
			Результат.НовыйПартнер = ПартнерПолученныйПоКонтрагенту;
			Результат.Сообщение = "Документ успешно обработан";
		Иначе
			Результат.Успех = Истина;
			Результат.Сообщение = "Изменения не требуются";
		КонецЕсли;

	Исключение
		Результат.Сообщение = ОписаниеОшибки();
	КонецПопытки;

	Возврат Результат;

КонецФункции

#КонецОбласти
