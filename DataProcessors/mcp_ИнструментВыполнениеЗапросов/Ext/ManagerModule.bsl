Процедура ДобавитьИнструменты(Инструменты) Экспорт

	ДобавитьИнструментВыполнениеЗапроса(Инструменты);

КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт

	Если ИмяИнструмента = "execute_query" Тогда
		Возврат ВыполнитьЗапрос(Аргументы);
	Иначе
		ВызватьИсключение "Неизвестный инструмент: " + ИмяИнструмента;
	КонецЕсли;

КонецФункции

#Область ИнструментВыполнениеЗапроса

Процедура ДобавитьИнструментВыполнениеЗапроса(Инструменты)

	// Создаем описания параметров для инструмента execute_query
	МассивПараметров = Новый Массив;
	
	// Параметр query_text - текст запроса (ОБЯЗАТЕЛЬНЫЙ)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"query_text",
		"string",
		"Текст запроса на языке запросов 1С. Поддерживает параметры через &ИмяПараметра",
		,
		Истина
	));
	
	// Параметр parameters - параметры запроса в виде объекта
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"parameters",
		"object",
		"Параметры запроса в виде объекта {ИмяПараметра: Значение}. Используйте для фильтрации по складам, контрагентам, датам, организациям, счетам и т.д."
	));
	
	// Параметр max_rows - максимальное количество возвращаемых строк
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"max_rows",
		"number",
		"Максимальное количество возвращаемых строк результата",
		100
	));
	
	// Создаем JSON-схему параметров
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	// Добавляем инструмент в таблицу
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"execute_query",
		"Выполнение универсального запроса на языке 1С с поддержкой параметров. Работает с: документами, регистрами накопления (остатки/обороты), РегистрБухгалтерии.Хозрасчетный, регистрами сведений, справочниками. Поддерживает параметры для фильтрации.",
		СхемаПараметров
	);

КонецПроцедуры

Функция ВыполнитьЗапрос(Аргументы)

	// Получаем обязательный параметр query_text
	ТекстЗапроса = Аргументы.query_text;
	
	// Получаем опциональный параметр max_rows
	МаксимумСтрок = 100;
	Если Аргументы.Свойство("max_rows") Тогда
		МаксимумСтрок = Аргументы.max_rows;
	КонецЕсли;
	
	// Получаем опциональный параметр parameters
	Параметры = Неопределено;
	Если Аргументы.Свойство("parameters") Тогда
		Параметры = Аргументы.parameters;
	КонецЕсли;
	
	// Создаем и выполняем запрос
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	// Устанавливаем параметры запроса
	Если Параметры <> Неопределено Тогда
		Для Каждого Параметр Из Параметры Цикл
			Запрос.УстановитьПараметр(Параметр.Ключ, Параметр.Значение);
		КонецЦикла;
	КонецЕсли;
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
	Исключение
		// Возвращаем ошибку выполнения запроса
		ТекстОшибки = "Ошибка выполнения запроса: " + ОписаниеОшибки();
		ВызватьИсключение ТекстОшибки;
	КонецПопытки;
	
	Выборка = РезультатЗапроса.Выбрать();
	
	// Обрабатываем результат
	МассивРезультатов = Новый Массив;
	Счетчик = 0;
	
	Пока Выборка.Следующий() И Счетчик < МаксимумСтрок Цикл
		СтрокаРезультата = Новый Структура;
		
		// Проходим по всем колонкам результата
		Для Каждого Колонка Из РезультатЗапроса.Колонки Цикл
			Значение = Выборка[Колонка.Имя];
			
			// Преобразуем значение для JSON
			ЗначениеДляJSON = ПреобразоватьЗначениеДляJSON(Значение);
			
			СтрокаРезультата.Вставить(Колонка.Имя, ЗначениеДляJSON);
		 КонецЦикла;
		
		МассивРезультатов.Добавить(СтрокаРезультата);
		Счетчик = Счетчик + 1;
	КонецЦикла;
	
	// Возвращаем результат в формате JSON
	ТекстJSON = mcp_ОбщегоНазначения.СтруктураВJSON(МассивРезультатов);
	
	Возврат ТекстJSON;

КонецФункции

// Преобразует значение 1С в формат, подходящий для JSON
//
// Параметры:
//  Значение - Произвольный - значение для преобразования
//
// Возвращаемое значение:
//  Произвольный - преобразованное значение
//
Функция ПреобразоватьЗначениеДляJSON(Значение)
	
	Если Значение = Неопределено Тогда
		Возврат Null;
	ИначеЕсли ТипЗнч(Значение) = Тип("Дата") Тогда
		// Преобразуем дату в ISO формат
		Если Значение = '00010101' Тогда
			Возврат Null;
		Иначе
			Возврат Формат(Значение, "ДФ=yyyy-MM-ddTHH:mm:ss");
		КонецЕсли;
	ИначеЕсли ТипЗнч(Значение) = Тип("Булево") Тогда
		Возврат Значение;
	ИначеЕсли ТипЗнч(Значение) = Тип("Число") Тогда
		Возврат Значение;
	ИначеЕсли ТипЗнч(Значение) = Тип("Строка") Тогда
		Возврат Значение;
	ИначеЕсли ЭтоСсылка(Значение) Тогда
		// Для ссылочных типов возвращаем представление
		Возврат Строка(Значение);
	Иначе
		// Для остальных типов - строковое представление
		Возврат Строка(Значение);
	КонецЕсли;
	
КонецФункции

// Проверяет, является ли значение ссылкой
//
// Параметры:
//  Значение - Произвольный - проверяемое значение
//
// Возвращаемое значение:
//  Булево - Истина, если значение является ссылкой
//
Функция ЭтоСсылка(Значение)
	
	Если Значение = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	ТипЗначения = ТипЗнч(Значение);
	
	// Проверяем ссылочные типы
	Возврат Метаданные.Справочники.Содержит(Метаданные.НайтиПоТипу(ТипЗначения))
		Или Метаданные.Документы.Содержит(Метаданные.НайтиПоТипу(ТипЗначения))
		Или Метаданные.ПланыВидовХарактеристик.Содержит(Метаданные.НайтиПоТипу(ТипЗначения))
		Или Метаданные.ПланыСчетов.Содержит(Метаданные.НайтиПоТипу(ТипЗначения))
		Или Метаданные.ПланыВидовРасчета.Содержит(Метаданные.НайтиПоТипу(ТипЗначения))
		Или Метаданные.БизнесПроцессы.Содержит(Метаданные.НайтиПоТипу(ТипЗначения))
		Или Метаданные.Задачи.Содержит(Метаданные.НайтиПоТипу(ТипЗначения))
		Или Метаданные.ПланыОбмена.Содержит(Метаданные.НайтиПоТипу(ТипЗначения));
	
КонецФункции

#КонецОбласти
