#Область ПрограммныйИнтерфейс

// Добавляет инструменты контейнера в таблицу
//
// Параметры:
//  Инструменты - ТаблицаЗначений - таблица для регистрации инструментов
//
Процедура ДобавитьИнструменты(Инструменты) Экспорт
	
	ДобавитьИнструментCreateCatalogItem(Инструменты);
	ДобавитьИнструментFindCatalogRef(Инструменты);
	ДобавитьИнструментUpdateCatalogItem(Инструменты);
	ДобавитьИнструментDeleteCatalogItem(Инструменты);
	ДобавитьИнструментCheckCatalogRefExists(Инструменты);
	
КонецПроцедуры

// Выполняет инструмент контейнера
//
// Параметры:
//  ИмяИнструмента - Строка - имя инструмента
//  Параметры - Структура - параметры выполнения
//
// Возвращаемое значение:
//  Произвольный - результат выполнения
//
Функция ВыполнитьИнструмент(ИмяИнструмента, Параметры) Экспорт
	
	Если ИмяИнструмента = "create_catalog_item" Тогда
		Возврат СоздатьЭлементСправочника(Параметры);
	ИначеЕсли ИмяИнструмента = "find_catalog_ref" Тогда
		Возврат НайтиСсылкуЭлементаСправочника(Параметры);
	ИначеЕсли ИмяИнструмента = "update_catalog_item" Тогда
		Возврат ОбновитьЭлементСправочника(Параметры);
	ИначеЕсли ИмяИнструмента = "delete_catalog_item" Тогда
		Возврат УстановитьПометкуУдаленияЭлементаСправочника(Параметры);
	ИначеЕсли ИмяИнструмента = "check_catalog_ref_exists" Тогда
		Возврат ПроверитьСуществованиеСсылкиСправочника(Параметры);
	Иначе
		ВызватьИсключение СтрШаблон("Неизвестный инструмент: %1", ИмяИнструмента);
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область РегистрацияИнструментов

Процедура ДобавитьИнструментCreateCatalogItem(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"catalog_type",
		"string",
		"Тип справочника (ТОЧНА назва з metadata!). Приклад: Номенклатура",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"data",
		"object",
		"Дані елемента: реквізити (Код, Наименование, Родитель, та ін.). Використовуй ТОЧНІ назви полів з get_metadata_structure!",
		,
		Истина
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"create_catalog_item",
		"Створити новий елемент справочника в 1С. КРИТИЧНО: спочатку перевір структуру через get_metadata_structure!",
		СхемаПараметров
	);
	
КонецПроцедуры

Процедура ДобавитьИнструментFindCatalogRef(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"catalog_type",
		"string",
		"Тип справочника (ТОЧНА назва з metadata!). Приклад: Номенклатура",
		,
		Истина
	));
	
	// ВАРІАНТ 1: Пошук за кодом
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"code",
		"string",
		"Код елемента для пошуку"
	));
	
	// ВАРІАНТ 2: Пошук за найменуванням
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"name",
		"string",
		"Найменування елемента для пошуку"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"find_catalog_ref",
		"Знайти елемент справочника за кодом або найменуванням та отримати його UUID для використання в update_catalog_item/delete_catalog_item. КРИТИЧНО: використовуй цей інструмент перед оновленням елемента знайденого через execute_query!",
		СхемаПараметров
	);
	
КонецПроцедуры

Процедура ДобавитьИнструментUpdateCatalogItem(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"catalog_ref",
		"string",
		"Посилання на елемент справочника у вигляді рядка UUID",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"data",
		"object",
		"Нові дані для оновлення (Код, Наименование, інші реквізити)",
		,
		Истина
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"update_catalog_item",
		"Оновити існуючий елемент справочника в 1С",
		СхемаПараметров
	);
	
КонецПроцедуры

Процедура ДобавитьИнструментDeleteCatalogItem(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"catalog_ref",
		"string",
		"Посилання на елемент (UUID)",
		,
		Истина
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"delete_catalog_item",
		"Встановити помітку на видалення елемента справочника в 1С",
		СхемаПараметров
	);
	
КонецПроцедуры

Процедура ДобавитьИнструментCheckCatalogRefExists(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"catalog_ref",
		"string",
		"UUID посилання на елемент справочника для перевірки існування",
		,
		Истина
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"check_catalog_ref_exists",
		"Швидка перевірка чи існує елемент справочника з заданим UUID та визначення його типу. Використовується системою аудиту для визначення catalog_type за UUID.",
		СхемаПараметров
	);
	
КонецПроцедуры

#КонецОбласти

#Область РеализацияИнструментов

Функция СоздатьЭлементСправочника(Параметры)
	
	Попытка
		ТипСправочника = Параметры.catalog_type;
		Данные = Параметры.data;
		
		// Перевіряємо чи створювати групу
		СоздатьГруппу = Ложь;
		Если Данные.Свойство("ЭтоГруппа") И Данные.ЭтоГруппа = Истина Тогда
			СоздатьГруппу = Истина;
		КонецЕсли;
		
		// Створюємо новий елемент або групу
		МенеджерСправочника = Справочники[ТипСправочника];
		
		Если СоздатьГруппу Тогда
			НовыйЭлемент = МенеджерСправочника.СоздатьГруппу();
		Иначе
			НовыйЭлемент = МенеджерСправочника.СоздатьЭлемент();
		КонецЕсли;
		
		// Заповнюємо реквізити
		Для Каждого КлючЗначение Из Данные Цикл
			ИмяРеквизита = КлючЗначение.Ключ;
			ЗначениеРеквизита = КлючЗначение.Значение;
			
			// Пропускаємо ЭтоГруппа - воно встановлюється автоматично
			Если ИмяРеквизита = "ЭтоГруппа" Тогда
				Продолжить;
			КонецЕсли;
			
			// КРИТИЧНО: Обробка ієрархії
			Если ИмяРеквизита = "Родитель" Тогда
				// Якщо передано UUID - знайти ссылку
				Если ТипЗнч(ЗначениеРеквизита) = Тип("Строка") И СтрДлина(ЗначениеРеквизита) = 36 Тогда
					УИД = Новый УникальныйИдентификатор(ЗначениеРеквизита);
					РодительСсылка = МенеджерСправочника.ПолучитьСсылку(УИД);
					НовыйЭлемент.Родитель = РодительСсылка;
				Иначе
					НовыйЭлемент.Родитель = ПреобразоватьЗначение(ЗначениеРеквизита);
				КонецЕсли;
			Иначе
				НовыйЭлемент[ИмяРеквизита] = ПреобразоватьЗначение(ЗначениеРеквизита);
			КонецЕсли;
		КонецЦикла;
		
		// Записуємо
		НовыйЭлемент.Записать();
		
		// Формуємо результат
		// КРИТИЧНО: Перевіряємо ВИД ІЄРАРХІЇ правильним синтаксисом!
		МетаСправочник = Метаданные.Справочники[ТипСправочника];
		ИмеетПолеЭтоГруппа = МетаСправочник.Иерархический 
			И МетаСправочник.ВидИерархии = Метаданные.СвойстваОбъектов.ВидИерархии.ИерархияГруппИЭлементов;
		
		Результат = Новый Структура;
		Результат.Вставить("success", Истина);
		Результат.Вставить("mode", "create");
		Результат.Вставить("ref", Строка(НовыйЭлемент.Ссылка.УникальныйИдентификатор()));
		Результат.Вставить("code", НовыйЭлемент.Код);
		Результат.Вставить("name", НовыйЭлемент.Наименование);
		
		// Тільки для справочників з ГРУПАМИ І ЕЛЕМЕНТАМИ
		Если ИмеетПолеЭтоГруппа Тогда
			Результат.Вставить("is_group", НовыйЭлемент.ЭтоГруппа);
		Иначе
			Результат.Вставить("is_group", Ложь);
		КонецЕсли;
		
		Возврат ПреобразоватьРезультатВМассив(Результат);
		
	Исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

Функция НайтиСсылкуЭлементаСправочника(Параметры)
	
	Попытка
		ТипСправочника = Параметры.catalog_type;
		
		// Визначаємо критерій пошуку
		ПоискПоКоду = Параметры.Свойство("code") И ЗначениеЗаполнено(Параметры.code);
		ПоискПоНаименованию = Параметры.Свойство("name") И ЗначениеЗаполнено(Параметры.name);
		
		Если НЕ ПоискПоКоду И НЕ ПоискПоНаименованию Тогда
			ВызватьИсключение "Необхідно вказати 'code' або 'name' для пошуку";
		КонецЕсли;
		
		// КРИТИЧНО: Перевіряємо ВИД ІЄРАРХІЇ правильним синтаксисом!
		МетаСправочник = Метаданные.Справочники[ТипСправочника];
		ИмеетПолеЭтоГруппа = МетаСправочник.Иерархический 
			И МетаСправочник.ВидИерархии = Метаданные.СвойстваОбъектов.ВидИерархии.ИерархияГруппИЭлементов;
		
		// Створюємо запит
		Запрос = Новый Запрос;
		
		Если ПоискПоКоду Тогда
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|    Ссылка,
			|    Код,
			|    Наименование,";
			
			// Додаємо ЭтоГруппа ТІЛЬКИ для справочників з ГРУПАМИ І ЕЛЕМЕНТАМИ
			Если ИмеетПолеЭтоГруппа Тогда
				ТекстЗапроса = ТекстЗапроса + "
			|    ЭтоГруппа,";
			КонецЕсли;
			
			ТекстЗапроса = ТекстЗапроса + "
			|    ПометкаУдаления
			|ИЗ
			|    Справочник." + ТипСправочника + " КАК Справочник
			|ГДЕ
			|    Справочник.Код = &Код";
			
			Запрос.Текст = ТекстЗапроса;
			Запрос.УстановитьПараметр("Код", Параметры.code);
		Иначе
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|    Ссылка,
			|    Код,
			|    Наименование,";
			
			// Додаємо ЭтоГруппа ТІЛЬКИ для справочників з ГРУПАМИ І ЕЛЕМЕНТАМИ
			Если ИмеетПолеЭтоГруппа Тогда
				ТекстЗапроса = ТекстЗапроса + "
			|    ЭтоГруппа,";
			КонецЕсли;
			
			ТекстЗапроса = ТекстЗапроса + "
			|    ПометкаУдаления
			|ИЗ
			|    Справочник." + ТипСправочника + " КАК Справочник
			|ГДЕ
			|    Справочник.Наименование = &Наименование";
			
			Запрос.Текст = ТекстЗапроса;
			Запрос.УстановитьПараметр("Наименование", Параметры.name);
		КонецЕсли;
		
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		Если Выборка.Следующий() Тогда
			// Елемент знайдено
			СсылкаЭлемента = Выборка.Ссылка;
			УИД = Строка(СсылкаЭлемента.УникальныйИдентификатор());
			
			РезультатПоиска = Новый Структура;
			РезультатПоиска.Вставить("found", Истина);
			РезультатПоиска.Вставить("uuid", УИД);
			РезультатПоиска.Вставить("catalog_type", ТипСправочника);
			РезультатПоиска.Вставить("code", Выборка.Код);
			РезультатПоиска.Вставить("name", Выборка.Наименование);
			
			// Тільки для справочників з ГРУПАМИ І ЕЛЕМЕНТАМИ
			Если ИмеетПолеЭтоГруппа Тогда
				РезультатПоиска.Вставить("is_group", Выборка.ЭтоГруппа);
			Иначе
				РезультатПоиска.Вставить("is_group", Ложь);
			КонецЕсли;
			
			РезультатПоиска.Вставить("deletion_mark", Выборка.ПометкаУдаления);
			РезультатПоиска.Вставить("presentation", Строка(СсылкаЭлемента));
			
			Возврат ПреобразоватьРезультатВМассив(РезультатПоиска);
		Иначе
			// Елемент не знайдено
			РезультатПоиска = Новый Структура;
			РезультатПоиска.Вставить("found", Ложь);
			РезультатПоиска.Вставить("error", "Элемент справочника не найден");
			РезультатПоиска.Вставить("catalog_type", ТипСправочника);
			
			Если ПоискПоКоду Тогда
				РезультатПоиска.Вставить("code", Параметры.code);
			Иначе
				РезультатПоиска.Вставить("name", Параметры.name);
			КонецЕсли;
			
			Возврат ПреобразоватьРезультатВМассив(РезультатПоиска);
		КонецЕсли;
		
	Исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

Функция ОбновитьЭлементСправочника(Параметры)
	
	Попытка
		УИД = Новый УникальныйИдентификатор(Параметры.catalog_ref);
		Данные = Параметры.data;
		
		// Знаходимо елемент
		СсылкаНаЭлемент = НайтиСправочникПоУИД(УИД);
		
		Если СсылкаНаЭлемент = Неопределено Тогда
			ВызватьИсключение "Элемент справочника не найден по UUID: " + Параметры.catalog_ref;
		КонецЕсли;
		
		ЭлементОбъект = СсылкаНаЭлемент.ПолучитьОбъект();
		
		// Оновлюємо реквізити
		Для Каждого КлючЗначение Из Данные Цикл
			ИмяРеквизита = КлючЗначение.Ключ;
			ЗначениеРеквизита = КлючЗначение.Значение;
			
			// КРИТИЧНО: Обробка ієрархії
			Если ИмяРеквизита = "Родитель" Тогда
				Если ТипЗнч(ЗначениеРеквизита) = Тип("Строка") И СтрДлина(ЗначениеРеквизита) = 36 Тогда
					УИДРодителя = Новый УникальныйИдентификатор(ЗначениеРеквизита);
					ТипСправочника = СсылкаНаЭлемент.Метаданные().Имя;
					МенеджерСправочника = Справочники[ТипСправочника];
					РодительСсылка = МенеджерСправочника.ПолучитьСсылку(УИДРодителя);
					ЭлементОбъект.Родитель = РодительСсылка;
				Иначе
					ЭлементОбъект.Родитель = ПреобразоватьЗначение(ЗначениеРеквизита);
				КонецЕсли;
			Иначе
				ЭлементОбъект[ИмяРеквизита] = ПреобразоватьЗначение(ЗначениеРеквизита);
			КонецЕсли;
		КонецЦикла;
		
		// Записуємо
		ЭлементОбъект.Записать();
		
		// Формуємо результат
		Результат = Новый Структура;
		Результат.Вставить("success", Истина);
		Результат.Вставить("mode", "update");
		Результат.Вставить("ref", Строка(ЭлементОбъект.Ссылка.УникальныйИдентификатор()));
		Результат.Вставить("code", ЭлементОбъект.Код);
		Результат.Вставить("name", ЭлементОбъект.Наименование);
		
		// ✅ AUDIT FIX: Додаємо catalog_type для системи аудиту
		ТипСправочника = СсылкаНаЭлемент.Метаданные().Имя;
		Результат.Вставить("catalog_type", ТипСправочника);
		
		Возврат ПреобразоватьРезультатВМассив(Результат);
		
	Исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

Функция УстановитьПометкуУдаленияЭлементаСправочника(Параметры)
	
	Попытка
		УИД = Новый УникальныйИдентификатор(Параметры.catalog_ref);
		СсылкаНаЭлемент = НайтиСправочникПоУИД(УИД);
		
		Если СсылкаНаЭлемент = Неопределено Тогда
			ВызватьИсключение "Элемент не найден";
		КонецЕсли;
		
		ЭлементОбъект = СсылкаНаЭлемент.ПолучитьОбъект();
		ЭлементОбъект.УстановитьПометкуУдаления(Истина);
		
		Результат = Новый Структура;
		Результат.Вставить("success", Истина);
		Результат.Вставить("deletion_mark", Истина);
		Результат.Вставить("ref", Строка(ЭлементОбъект.Ссылка.УникальныйИдентификатор()));
		
		// ✅ AUDIT FIX: Додаємо catalog_type для системи аудиту
		ТипСправочника = СсылкаНаЭлемент.Метаданные().Имя;
		Результат.Вставить("catalog_type", ТипСправочника);
		
		Возврат ПреобразоватьРезультатВМассив(Результат);
		
	Исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

Функция ПроверитьСуществованиеСсылкиСправочника(Параметры)
	
	Попытка
		УИД = Новый УникальныйИдентификатор(Параметры.catalog_ref);
		
		// Шукаємо елемент через існуючу функцію
		СсылкаНаЭлемент = НайтиСправочникПоУИД(УИД);
		
		Если СсылкаНаЭлемент = Неопределено Тогда
			// Елемент НЕ знайдено
			Результат = Новый Структура;
			Результат.Вставить("exists", Ложь);
			Результат.Вставить("uuid", Параметры.catalog_ref);
			Результат.Вставить("catalog_type", Неопределено);
			
			Возврат ПреобразоватьРезультатВМассив(Результат);
		Иначе
			// Елемент знайдено - витягуємо інформацію
			ТипСправочника = СсылкаНаЭлемент.Метаданные().Имя;
			ЭлементОбъект = СсылкаНаЭлемент.ПолучитьОбъект();
			
			Результат = Новый Структура;
			Результат.Вставить("exists", Истина);
			Результат.Вставить("uuid", Параметры.catalog_ref);
			Результат.Вставить("catalog_type", ТипСправочника);
			Результат.Вставить("code", ЭлементОбъект.Код);
			Результат.Вставить("name", ЭлементОбъект.Наименование);
			Результат.Вставить("deletion_mark", ЭлементОбъект.ПометкаУдаления);
			Результат.Вставить("presentation", Строка(СсылкаНаЭлемент));
			
			Возврат ПреобразоватьРезультатВМассив(Результат);
		КонецЕсли;
		
	Исключение
		// Якщо UUID невалідний або інша помилка
		Результат = Новый Структура;
		Результат.Вставить("exists", Ложь);
		Результат.Вставить("uuid", Параметры.catalog_ref);
		Результат.Вставить("catalog_type", Неопределено);
		Результат.Вставить("error", ОписаниеОшибки());
		
		Возврат ПреобразоватьРезультатВМассив(Результат);
	КонецПопытки;
	
КонецФункции

#КонецОбласти

#Область ВспомогательныеФункции

Функция НайтиСправочникПоУИД(УИД)
	
	МетаданныеСправочников = Метаданные.Справочники;
	
	Для Каждого МетаСправочник Из МетаданныеСправочников Цикл
		Попытка
			МенеджерСправочника = Справочники[МетаСправочник.Имя];
			Ссылка = МенеджерСправочника.ПолучитьСсылку(УИД);
			
			// КРИТИЧНО: перевірка існування
			ЭлементОбъект = Ссылка.ПолучитьОбъект();
			Если ЭлементОбъект <> Неопределено Тогда
				Возврат Ссылка;
			КонецЕсли;
		Исключение
			Продолжить;
		КонецПопытки;
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции

Функция ПреобразоватьЗначение(Значение)
	
	Если ТипЗнч(Значение) = Тип("Строка") И СтрНайти(Значение, "T") > 0 Тогда
		Попытка
			Возврат XMLЗначение(Тип("Дата"), Значение);
		Исключение
		КонецПопытки;
	КонецЕсли;
	
	Если ТипЗнч(Значение) = Тип("Строка") И СтрДлина(Значение) = 36 Тогда
		Попытка
			УИД = Новый УникальныйИдентификатор(Значение);
			СсылкаНаОбъект = НайтиОбъектПоУИД(УИД);
			Если СсылкаНаОбъект <> Неопределено Тогда
				Возврат СсылкаНаОбъект;
			КонецЕсли;
		Исключение
		КонецПопытки;
	КонецЕсли;
	
	Возврат Значение;
	
КонецФункции

Функция НайтиОбъектПоУИД(УИД)
	
	// Спочатку шукаємо в справочниках
	СсылкаСправочника = НайтиСправочникПоУИД(УИД);
	Если СсылкаСправочника <> Неопределено Тогда
		Возврат СсылкаСправочника;
	КонецЕсли;
	
	// Потім в документах
	МетаданныеДокументов = Метаданные.Документы;
	
	Для Каждого МетаДокумент Из МетаданныеДокументов Цикл
		Попытка
			МенеджерДокумента = Документы[МетаДокумент.Имя];
			Ссылка = МенеджерДокумента.ПолучитьСсылку(УИД);
			
			ДокументОбъект = Ссылка.ПолучитьОбъект();
			Если ДокументОбъект <> Неопределено Тогда
				Возврат Ссылка;
			КонецЕсли;
		Исключение
			Продолжить;
		КонецПопытки;
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции

Функция ПреобразоватьРезультатВМассив(Структура)
	
	МассивСодержимого = Новый Массив;
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", mcp_ОбщегоНазначения.СтруктураВJSON(Структура));
	
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Возврат МассивСодержимого;
	
КонецФункции

#КонецОбласти

#КонецОбласти
