#Область ПрограммныйИнтерфейс

// Добавляет инструменты контейнера в таблицу
//
// Параметры:
//  Инструменты - ТаблицаЗначений - таблица для регистрации инструментов
//
Процедура ДобавитьИнструменты(Инструменты) Экспорт
	
	ДобавитьИнструментCreateDocument(Инструменты);
	ДобавитьИнструментUpdateDocument(Инструменты);
	ДобавитьИнструментPostDocument(Инструменты);
	ДобавитьИнструментUnpostDocument(Инструменты);
	ДобавитьИнструментFindDocumentRef(Инструменты);
	ДобавитьИнструментDeleteDocument(Инструменты);
	ДобавитьИнструментCheckDocumentRefExists(Инструменты);
	
КонецПроцедуры

// Выполняет инструмент контейнера
//
// Параметры:
//  ИмяИнструмента - Строка - имя инструмента
//  Параметры - Структура - параметры выполнения
//
// Возвращаемое значение:
//  Произвольный - результат выполнения
//
Функция ВыполнитьИнструмент(ИмяИнструмента, Параметры) Экспорт
	
	Если ИмяИнструмента = "create_document" Тогда
		Возврат СоздатьДокумент(Параметры);
	ИначеЕсли ИмяИнструмента = "update_document" Тогда
		Возврат ОбновитьДокумент(Параметры);
	ИначеЕсли ИмяИнструмента = "post_document" Тогда
		Возврат ПровестиДокумент(Параметры);
	ИначеЕсли ИмяИнструмента = "unpost_document" Тогда
		Возврат ОтменитьПроведениеДокумента(Параметры);
	ИначеЕсли ИмяИнструмента = "find_document_ref" Тогда
		Возврат НайтиСсылкуДокумента(Параметры);
	ИначеЕсли ИмяИнструмента = "delete_document" Тогда
		Возврат УстановитьПометкуУдаленияДокумента(Параметры);
	ИначеЕсли ИмяИнструмента = "check_document_ref_exists" Тогда
		Возврат ПроверитьСуществованиеДокумента(Параметры);
	Иначе
		ВызватьИсключение СтрШаблон("Неизвестный инструмент: %1", ИмяИнструмента);
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область РегистрацияИнструментов

Процедура ДобавитьИнструментCreateDocument(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"doc_type",
		"string",
		"Тип документа (ТОЧНА назва з metadata!). Приклад: ПоступлениеТоваровУслуг",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"data",
		"object",
		"Дані документа: реквізити та табличні частини. Використовуй ТОЧНІ назви полів з get_metadata_structure!",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"post",
		"boolean",
		"Провести документ після створення",
		Ложь
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"create_document",
		"Створити новий документ в 1С. КРИТИЧНО: спочатку перевір структуру через get_metadata_structure!",
		СхемаПараметров
	);
	
КонецПроцедуры

Процедура ДобавитьИнструментUpdateDocument(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"doc_ref",
		"string",
		"Посилання на документ у вигляді рядка UUID",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"data",
		"object",
		"Нові дані для оновлення",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"post",
		"boolean",
		"Провести після оновлення"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"update_document",
		"Оновити існуючий документ в 1С",
		СхемаПараметров
	);
	
КонецПроцедуры

Процедура ДобавитьИнструментPostDocument(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"doc_ref",
		"string",
		"Посилання на документ (UUID)",
		,
		Истина
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"post_document",
		"Провести документ в 1С",
		СхемаПараметров
	);
	
КонецПроцедуры

Процедура ДобавитьИнструментUnpostDocument(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"doc_ref",
		"string",
		"Посилання на документ (UUID)",
		,
		Истина
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"unpost_document",
		"Скасувати проведення документа в 1С",
		СхемаПараметров
	);
	
КонецПроцедуры

Процедура ДобавитьИнструментFindDocumentRef(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"doc_type",
		"string",
		"Тип документа (ТОЧНА назва з metadata!). Приклад: ВводОстатков",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"number",
		"string",
		"Номер документа для пошуку",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"date",
		"string",
		"Дата документа в форматі ISO (YYYY-MM-DDTHH:mm:ss)",
		,
		Истина
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"find_document_ref",
		"Знайти документ за типом, номером і датою та отримати його UUID для використання в post_document/unpost_document/delete_document. КРИТИЧНО: використовуй цей інструмент перед операціями з документом знайденим через execute_query!",
		СхемаПараметров
	);
	
КонецПроцедуры

Процедура ДобавитьИнструментDeleteDocument(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"doc_ref",
		"string",
		"Посилання на документ (UUID)",
		,
		Истина
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"delete_document",
		"Встановити помітку на видалення документа в 1С",
		СхемаПараметров
	);
	
КонецПроцедуры

Процедура ДобавитьИнструментCheckDocumentRefExists(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"doc_ref",
		"string",
		"UUID посилання на документ для перевірки існування та визначення типу",
		,
		Истина
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"check_document_ref_exists",
		"Швидка перевірка чи існує документ з заданим UUID та визначення його типу (doc_type). Використовується системою аудиту для визначення типу документа перед захопленням BEFORE стану.",
		СхемаПараметров
	);
	
КонецПроцедуры

#КонецОбласти

#Область РеализацияИнструментов

Функция СоздатьДокумент(Параметры)
	
	Попытка
		ТипДокумента = Параметры.doc_type;
		Данные = Параметры.data;
		Провести = Ложь;
		
		Если Параметры.Свойство("post") Тогда
			Провести = Параметры.post;
		КонецЕсли;
		
		МенеджерДокумента = Документы[ТипДокумента];
		НовыйДокумент = МенеджерДокумента.СоздатьДокумент();
		
		Для Каждого КлючЗначение Из Данные Цикл
			ИмяРеквизита = КлючЗначение.Ключ;
			ЗначениеРеквизита = КлючЗначение.Значение;
			
			Если ТипЗнч(ЗначениеРеквизита) = Тип("Массив") Тогда
				ЗаполнитьТабличнуюЧасть(НовыйДокумент, ИмяРеквизита, ЗначениеРеквизита);
			Иначе
				НовыйДокумент[ИмяРеквизита] = ПреобразоватьЗначение(ЗначениеРеквизита);
			КонецЕсли;
		КонецЦикла;
		
		Если Провести Тогда
			НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение);
			Статус = "posted";
		Иначе
			НовыйДокумент.Записать();
			Статус = "saved";
		КонецЕсли;
		
		Результат = СформироватьРезультатУспех("create", Статус, НовыйДокумент);
		
		Возврат ПреобразоватьРезультатВМассив(Результат);
		
	Исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

Функция ОбновитьДокумент(Параметры)
	
	Попытка
		УИД = Новый УникальныйИдентификатор(Параметры.doc_ref);
		Данные = Параметры.data;
		
		СсылкаНаДокумент = НайтиДокументПоУИД(УИД);
		
		Если СсылкаНаДокумент = Неопределено Тогда
			ВызватьИсключение "Документ не найден по UUID: " + Параметры.doc_ref;
		КонецЕсли;
		
		ДокументОбъект = СсылкаНаДокумент.ПолучитьОбъект();
		
		Для Каждого КлючЗначение Из Данные Цикл
			ИмяРеквизита = КлючЗначение.Ключ;
			ЗначениеРеквизита = КлючЗначение.Значение;
			
			Если ТипЗнч(ЗначениеРеквизита) = Тип("Массив") Тогда
				ЗаполнитьТабличнуюЧасть(ДокументОбъект, ИмяРеквизита, ЗначениеРеквизита);
			Иначе
				ДокументОбъект[ИмяРеквизита] = ПреобразоватьЗначение(ЗначениеРеквизита);
			КонецЕсли;
		КонецЦикла;
		
		Провести = Неопределено;
		Если Параметры.Свойство("post") Тогда
			Провести = Параметры.post;
		КонецЕсли;
		
		Если Провести = Истина Тогда
			ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
			Статус = "posted";
		ИначеЕсли Провести = Ложь Тогда
			ДокументОбъект.Записать();
			Статус = "saved";
		Иначе
			Если ДокументОбъект.Проведен Тогда
				ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
				Статус = "posted";
			Иначе
				ДокументОбъект.Записать();
				Статус = "saved";
			КонецЕсли;
		КонецЕсли;
		
		Результат = СформироватьРезультатУспех("update", Статус, ДокументОбъект);
		
		Возврат ПреобразоватьРезультатВМассив(Результат);
		
	Исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

Функция ПровестиДокумент(Параметры)
	
	Попытка
		УИД = Новый УникальныйИдентификатор(Параметры.doc_ref);
		СсылкаНаДокумент = НайтиДокументПоУИД(УИД);
		
		Если СсылкаНаДокумент = Неопределено Тогда
			ВызватьИсключение "Документ не найден";
		КонецЕсли;
		
		ДокументОбъект = СсылкаНаДокумент.ПолучитьОбъект();
		ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
		
		Результат = Новый Структура;
		Результат.Вставить("success", Истина);
		Результат.Вставить("posted", Истина);
		Результат.Вставить("ref", Строка(ДокументОбъект.Ссылка.УникальныйИдентификатор()));
		
		// ✅ AUDIT FIX: Додаємо doc_type для системи аудиту
		ТипДокумента = СсылкаНаДокумент.Метаданные().Имя;
		Результат.Вставить("doc_type", ТипДокумента);
		
		Возврат ПреобразоватьРезультатВМассив(Результат);
		
	Исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

Функция ОтменитьПроведениеДокумента(Параметры)
	
	Попытка
		УИД = Новый УникальныйИдентификатор(Параметры.doc_ref);
		СсылкаНаДокумент = НайтиДокументПоУИД(УИД);
		
		Если СсылкаНаДокумент = Неопределено Тогда
			ВызватьИсключение "Документ не найден";
		КонецЕсли;
		
		ДокументОбъект = СсылкаНаДокумент.ПолучитьОбъект();
		ДокументОбъект.Записать(РежимЗаписиДокумента.ОтменаПроведения);
		
		Результат = Новый Структура;
		Результат.Вставить("success", Истина);
		Результат.Вставить("posted", Ложь);
		Результат.Вставить("ref", Строка(ДокументОбъект.Ссылка.УникальныйИдентификатор()));
		
		// ✅ AUDIT FIX: Додаємо doc_type для системи аудиту
		ТипДокумента = СсылкаНаДокумент.Метаданные().Имя;
		Результат.Вставить("doc_type", ТипДокумента);
		
		Возврат ПреобразоватьРезультатВМассив(Результат);
		
	Исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

Функция НайтиСсылкуДокумента(Параметры)
	
	Попытка
		ТипДокумента = Параметры.doc_type;
		Номер = Параметры.number;
		ДатаСтрока = Параметры.date;
		
		// Преобразуем дату из ISO формата
		Дата = XMLЗначение(Тип("Дата"), ДатаСтрока);
		
		// Получаем начало и конец дня для поиска
		НачалоДня = НачалоДня(Дата);
		КонецДня = КонецДня(Дата);
		
		// Создаем запрос для поиска
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|    Ссылка
		|ИЗ
		|    Документ." + ТипДокумента + " КАК Документ
		|ГДЕ
		|    Документ.Номер = &Номер
		|    И Документ.Дата >= &НачалоДня
		|    И Документ.Дата <= &КонецДня";
		
		Запрос.УстановитьПараметр("Номер", Номер);
		Запрос.УстановитьПараметр("НачалоДня", НачалоДня);
		Запрос.УстановитьПараметр("КонецДня", КонецДня);
		
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		Если Выборка.Следующий() Тогда
			// Документ найден
			СсылкаДокумента = Выборка.Ссылка;
			УИД = Строка(СсылкаДокумента.УникальныйИдентификатор());
			
			ДокументОбъект = СсылкаДокумента.ПолучитьОбъект();
			
			РезультатПоиска = Новый Структура;
			РезультатПоиска.Вставить("found", Истина);
			РезультатПоиска.Вставить("uuid", УИД);
			РезультатПоиска.Вставить("doc_type", ТипДокумента);
			РезультатПоиска.Вставить("number", Строка(ДокументОбъект.Номер));
			РезультатПоиска.Вставить("date", Формат(ДокументОбъект.Дата, "ДФ=yyyy-MM-ddTHH:mm:ss"));
			РезультатПоиска.Вставить("posted", ДокументОбъект.Проведен);
			РезультатПоиска.Вставить("presentation", Строка(СсылкаДокумента));
			
			Возврат ПреобразоватьРезультатВМассив(РезультатПоиска);
		Иначе
			// Документ не найден
			РезультатПоиска = Новый Структура;
			РезультатПоиска.Вставить("found", Ложь);
			РезультатПоиска.Вставить("error", "Документ не найден");
			РезультатПоиска.Вставить("doc_type", ТипДокумента);
			РезультатПоиска.Вставить("number", Номер);
			РезультатПоиска.Вставить("date", ДатаСтрока);
			
			Возврат ПреобразоватьРезультатВМассив(РезультатПоиска);
		КонецЕсли;
		
	Исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

Функция УстановитьПометкуУдаленияДокумента(Параметры)
	
	Попытка
		УИД = Новый УникальныйИдентификатор(Параметры.doc_ref);
		СсылкаНаДокумент = НайтиДокументПоУИД(УИД);
		
		Если СсылкаНаДокумент = Неопределено Тогда
			ВызватьИсключение "Документ не найден";
		КонецЕсли;
		
		ДокументОбъект = СсылкаНаДокумент.ПолучитьОбъект();
		ДокументОбъект.УстановитьПометкуУдаления(Истина);
		
		Результат = Новый Структура;
		Результат.Вставить("success", Истина);
		Результат.Вставить("deletion_mark", Истина);
		Результат.Вставить("ref", Строка(ДокументОбъект.Ссылка.УникальныйИдентификатор()));
		
		// ✅ AUDIT FIX: Додаємо doc_type для системи аудиту
		ТипДокумента = СсылкаНаДокумент.Метаданные().Имя;
		Результат.Вставить("doc_type", ТипДокумента);
		
		Возврат ПреобразоватьРезультатВМассив(Результат);
		
	Исключение
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

// ✅ AUDIT FIX: Новий інструмент для системи аудиту
Функция ПроверитьСуществованиеДокумента(Параметры)
	
	Попытка
		УИД = Новый УникальныйИдентификатор(Параметры.doc_ref);
		СсылкаНаДокумент = НайтиДокументПоУИД(УИД);
		
		Результат = Новый Структура;
		Результат.Вставить("exists", Ложь);
		Результат.Вставить("doc_ref", Параметры.doc_ref);
		
		Если СсылкаНаДокумент <> Неопределено Тогда
			// Документ знайдено - отримуємо metadata
			ДокументОбъект = СсылкаНаДокумент.ПолучитьОбъект();
			
			Результат.exists = Истина;
			Результат.Вставить("doc_type", СсылкаНаДокумент.Метаданные().Имя);
			Результат.Вставить("number", Строка(ДокументОбъект.Номер));
			Результат.Вставить("date", Формат(ДокументОбъект.Дата, "ДФ=yyyy-MM-ddTHH:mm:ss"));
			Результат.Вставить("posted", ДокументОбъект.Проведен);
			Результат.Вставить("deletion_mark", ДокументОбъект.ПометкаУдаления);
		КонецЕсли;
		
		Возврат ПреобразоватьРезультатВМассив(Результат);
		
	Исключение
		РезультатОшибки = Новый Структура;
		РезультатОшибки.Вставить("exists", Ложь);
		РезультатОшибки.Вставить("doc_ref", Параметры.doc_ref);
		РезультатОшибки.Вставить("error", ОписаниеОшибки());
		Возврат ПреобразоватьРезультатВМассив(РезультатОшибки);
	КонецПопытки;
	
КонецФункции

#КонецОбласти

#Область ВспомогательныеФункции

Процедура ЗаполнитьТабличнуюЧасть(ДокументОбъект, ИмяТабличнойЧасти, МассивСтрок)
	
	ТабличнаяЧасть = ДокументОбъект[ИмяТабличнойЧасти];
	ТабличнаяЧасть.Очистить();
	
	Для Каждого СтрокаДанных Из МассивСтрок Цикл
		НоваяСтрока = ТабличнаяЧасть.Добавить();
		
		Для Каждого Реквизит Из СтрокаДанных Цикл
			НоваяСтрока[Реквизит.Ключ] = ПреобразоватьЗначение(Реквизит.Значение);
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

Функция ПреобразоватьЗначение(Значение)
	
	Если ТипЗнч(Значение) = Тип("Строка") И СтрНайти(Значение, "T") > 0 Тогда
		Попытка
			Возврат XMLЗначение(Тип("Дата"), Значение);
		Исключение
		КонецПопытки;
	КонецЕсли;
	
	Если ТипЗнч(Значение) = Тип("Строка") И СтрДлина(Значение) = 36 Тогда
		Попытка
			УИД = Новый УникальныйИдентификатор(Значение);
			СсылкаНаОбъект = НайтиОбъектПоУИД(УИД);
			Если СсылкаНаОбъект <> Неопределено Тогда
				Возврат СсылкаНаОбъект;
			КонецЕсли;
		Исключение
		КонецПопытки;
	КонецЕсли;
	
	Возврат Значение;
	
КонецФункции



Функция НайтиДокументПоУИД(УИД)
	
	МетаданныеДокументов = Метаданные.Документы;
	
	Для Каждого МетаДокумент Из МетаданныеДокументов Цикл
		Попытка
			МенеджерДокумента = Документы[МетаДокумент.Имя];
			Ссылка = МенеджерДокумента.ПолучитьСсылку(УИД);
			
			// КРИТИЧНО: как в твоем примере - проверяем через ПолучитьОбъект()
			ДокументОбъект = Ссылка.ПолучитьОбъект();
			Если ДокументОбъект <> Неопределено Тогда
				Возврат Ссылка;
			КонецЕсли;
		Исключение
			Продолжить;
		КонецПопытки;
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции


Функция НайтиОбъектПоУИД(УИД)
	
	СсылкаДокумента = НайтиДокументПоУИД(УИД);
	Если СсылкаДокумента <> Неопределено Тогда
		Возврат СсылкаДокумента;
	КонецЕсли;
	
	МетаданныеСправочников = Метаданные.Справочники;
	
	Для Каждого МетаСправочник Из МетаданныеСправочников Цикл
		МенеджерСправочника = Справочники[МетаСправочник.Имя];
		Ссылка = МенеджерСправочника.ПолучитьСсылку(УИД);
		
		Если НЕ Ссылка.Пустая() Тогда
			Возврат Ссылка;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции

Функция СформироватьРезультатУспех(Режим, Статус, ДокументОбъект)
	
	Результат = Новый Структура;
	Результат.Вставить("success", Истина);
	Результат.Вставить("mode", Режим);
	Результат.Вставить("status", Статус);
	Результат.Вставить("ref", Строка(ДокументОбъект.Ссылка.УникальныйИдентификатор()));
	Результат.Вставить("number", ДокументОбъект.Номер);
	Результат.Вставить("date", Формат(ДокументОбъект.Дата, "ДФ=yyyy-MM-ddTHH:mm:ss"));
	
	// ✅ AUDIT FIX: Додаємо doc_type для системи аудиту
	ТипДокумента = ДокументОбъект.Ссылка.Метаданные().Имя;
	Результат.Вставить("doc_type", ТипДокумента);
	
	Возврат Результат;
	
КонецФункции

Функция ПреобразоватьРезультатВМассив(Структура)
	
	МассивСодержимого = Новый Массив;
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", mcp_ОбщегоНазначения.СтруктураВJSON(Структура));
	
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Возврат МассивСодержимого;
	
КонецФункции

#КонецОбласти

#КонецОбласти
