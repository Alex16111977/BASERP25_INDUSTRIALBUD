
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ПроверитьНаличиеДанныхКОбработке();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗаполнитьСтоимость(Команда)
	
	ДлительнаяОперация = ЗаполнитьСтоимостьНаСервере();
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
	ОписаниеОповещения = Новый ОписаниеОповещения("ПослеВыполненияЗадания", ЭтотОбъект);
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация, ОписаниеОповещения, ПараметрыОжидания);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ПроверитьНаличиеДанныхКОбработке()
	
	ИспользоватьУчетСебестоимости = ПолучитьФункциональнуюОпцию("ИспользоватьУчетСебестоимости");
	ДатаНачалаУчетаСебестоимости = Константы.ДатаНачалаУчетаСебестоимости.Получить();
	
	Если ИспользоватьУчетСебестоимости
		И НЕ ЗначениеЗаполнено(ДатаНачалаУчетаСебестоимости) Тогда
		
		Элементы.ИнформационнаяНадпись.Заголовок = НСтр("ru='При включенном учете себестоимости заполнение стоимости не требуется.';uk='При включеному обліку собівартості заповнення вартості не потрібне.'");
		Элементы.ФормаЗаполнитьСтоимость.Доступность = Ложь;
			
		Возврат; 
	КонецЕсли;
	
	Если НЕ Обработки.ЗаполнениеФактическойСтоимостиВНАПриОтключенномУчетеСебестоимости.ЕстьДокументыКОбработке() Тогда
		
		Элементы.ИнформационнаяНадпись.Заголовок = НСтр("ru='Нет документов, в которых требуется заполнить стоимость.';uk='Немає документів, в яких потрібно заповнити вартість.'");
		Элементы.ФормаЗаполнитьСтоимость.Доступность = Ложь;
		
		Возврат;
		
	КонецЕсли;
	
	Если ИспользоватьУчетСебестоимости Тогда
		
		ЗаголовокНадписи = НСтр("ru='Учет себестоимости ведется с %1.
|Обнаружены документы до этой даты, в которых стоимость, указанная в документе, отличается от фактической.
|Требуется заполнить фактическую стоимость в документе по данным расчета стоимости.'
|;uk='Облік собівартості ведеться з %1.
|Виявлено документи до цієї дати, в яких вартість, яка зазначена в документі, відрізняється від фактичної.
|Потрібно заповнити фактичну вартість в документі за даними розрахунку вартості.'");
		
		ЗаголовокНадписи = СтрШаблон(ЗаголовокНадписи, Формат(ДатаНачалаУчетаСебестоимости, "ДЛФ=D"));
		
	Иначе
		
		ЗаголовокНадписи = НСтр("ru='Учет себестоимости отключен.
|Обнаружены документы, в которых стоимость, указанная в документе, отличается от фактической.
|Требуется заполнить фактическую стоимость в документе по данным расчета стоимости.'
|;uk='Облік собівартості відключений.
|Виявлено документи, в яких вартість, яка зазначена в документі, відрізняється від фактичної.
|Потрібно заповнити фактичну вартість в документі за даними розрахунку вартості.'");
		
	КонецЕсли; 
	
	Элементы.ИнформационнаяНадпись.Заголовок = ЗаголовокНадписи;
	
	Элементы.ФормаЗаполнитьСтоимость.Доступность = Истина;
	
КонецПроцедуры

&НаСервере
Функция ЗаполнитьСтоимостьНаСервере()
	
	ПараметрыВыполненияВФоне = ДлительныеОперации.ПараметрыВыполненияВФоне(УникальныйИдентификатор);
	ПараметрыВыполненияВФоне.НаименованиеФоновогоЗадания = 
		Метаданные.Обработки.ЗаполнениеФактическойСтоимостиВНАПриОтключенномУчетеСебестоимости.Синоним;
	
	Результат = ДлительныеОперации.ВыполнитьВФоне(
		"Обработки.ЗаполнениеФактическойСтоимостиВНАПриОтключенномУчетеСебестоимости.ЗаполнитьСтоимость",
		Новый Структура,
		ПараметрыВыполненияВФоне);
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура ПослеВыполненияЗадания(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если Результат.Статус = "Ошибка" Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Результат.КраткоеПредставлениеОшибки);
		Возврат;
	КонецЕсли;
	
	ПослеВыполненияЗаданияНаСервере(Результат.АдресРезультата);
	
КонецПроцедуры

&НаСервере
Процедура ПослеВыполненияЗаданияНаСервере(АдресРезультата)

	Если ЭтоАдресВременногоХранилища(АдресРезультата) Тогда
		
		ТекстОшибки = ПолучитьИзВременногоХранилища(АдресРезультата);
		
		Если ТекстОшибки <> Неопределено Тогда
			
			ЗаголовокНадписи = НСтр("ru='При заполнении стоимости возникла ошибка:
|%1'
|;uk='При заповненні вартості виникла помилка:
|%1'");
			
			ЗаголовокНадписи = СтрШаблон(ЗаголовокНадписи, ТекстОшибки);
			Элементы.ИнформационнаяНадпись.Заголовок = ЗаголовокНадписи;
			
			Возврат;
		КонецЕсли; 
		
	КонецЕсли; 
	
	ПроверитьНаличиеДанныхКОбработке();

КонецПроцедуры

#КонецОбласти
