// Создает элемент справочника "Сотрудники" на основании элемента справочника "ФизическиеЛица"
// Перед созданием проверяет, существует ли уже сотрудник для данного физического лица
//
// Параметры:
//   ФизическоеЛицоСсылка - СправочникСсылка.ФизическиеЛица - ссылка на физическое лицо
//   ГоловнаяОрганизацияСсылка - СправочникСсылка.Организации - организация для сотрудника (необязательный)
//
// Возвращаемое значение:
//   СправочникСсылка.Сотрудники - созданный или найденный сотрудник, или Неопределено в случае ошибки
//
Функция СоздатьСотрудникаИзФизическогоЛица(ФизическоеЛицоСсылка, ГоловнаяОрганизацияСсылка = Неопределено) Экспорт

	// Проверка входных параметров
	Если НЕ ЗначениеЗаполнено(ФизическоеЛицоСсылка) Тогда
		Сообщить("Ошибка: Не указано физическое лицо!");
		Возврат Неопределено;
	КонецЕсли;

	// Проверяем, существует ли уже сотрудник для данного физического лица
	СуществующийСотрудник = НайтиСотрудникаПоФизическомуЛицу(ФизическоеЛицоСсылка);

	Если ЗначениеЗаполнено(СуществующийСотрудник) Тогда
		Сообщить("Сотрудник для физического лица """ + Строка(ФизическоеЛицоСсылка) + """ уже существует: " + Строка(СуществующийСотрудник));
		Возврат СуществующийСотрудник;
	КонецЕсли;

	// Создаем нового сотрудника
	Попытка
		НовыйСотрудник = Справочники.Сотрудники.СоздатьЭлемент();

		// Заполняем основные реквизиты
		НовыйСотрудник.ФизическоеЛицо = ФизическоеЛицоСсылка;
		НовыйСотрудник.Наименование = Строка(ФизическоеЛицоСсылка);

		// Заполняем организацию, если указана
		Если ЗначениеЗаполнено(ГоловнаяОрганизацияСсылка) Тогда
			НовыйСотрудник.ГоловнаяОрганизация = ГоловнаяОрganизацияСсылка;
		КонецЕсли;

		// Записываем элемент
		НовыйСотрудник.Записать();

		Сообщить("Создан новый сотрудник: " + Строка(НовыйСотрудник) + " для физического лица: " + Строка(ФизическоеЛицоСсылка));

		Возврат НовыйСотрудник.Ссылка;

	Исключение
		Сообщить("Ошибка при создании сотрудника: " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;

КонецФункции

// Ищет сотрудника по физическому лицу
//
// Параметры:
//   ФизическоеЛицоСсылка - СправочникСсылка.ФизическиеЛица - ссылка на физическое лицо
//
// Возвращаемое значение:
//   СправочникСсылка.Сотрудники - найденный сотрудник или пустая ссылка
//
Функция НайтиСотрудникаПоФизическомуЛицу(ФизическоеЛицоСсылка) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Сотрудники.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.Сотрудники КАК Сотрудники
		|ГДЕ
		|	Сотрудники.ФизическоеЛицо = &ФизическоеЛицо
		|	И НЕ Сотрудники.ПометкаУдаления";

	Запрос.УстановитьПараметр("ФизическоеЛицо", ФизическоеЛицоСсылка);

	Результат = Запрос.Выполнить();

	Если Результат.Пустой() Тогда
		Возврат Справочники.Сотрудники.ПустаяСсылка();
	Иначе
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;

КонецФункции

// Создает сотрудников для списка физических лиц
//
// Параметры:
//   СписокФизическихЛиц - Массив из СправочникСсылка.ФизическиеЛица - массив ссылок на физические лица
//   ГоловнаяОрганизацияСсылка - СправочникСсылка.Организации - организация для сотрудников (необязательный)
//
// Возвращаемое значение:
//   Структура - результат обработки:
//     * Создано - Число - количество созданных сотрудников
//     * УжеСуществовало - Число - количество сотрудников, которые уже существовали
//     * Ошибок - Число - количество ошибок при создании
//
Функция СоздатьСотрудниковМассово(СписокФизическихЛиц, ГоловнаяОрганизацияСсылка = Неопределено) Экспорт

	Результат = Новый Структура;
	Результат.Вставить("Создано", 0);
	Результат.Вставить("УжеСуществовало", 0);
	Результат.Вставить("Ошибок", 0);

	Для Каждого ФизЛицо Из СписокФизическихЛиц Цикл

		// Проверяем, существует ли уже сотрудник
		СуществующийСотрудник = НайтиСотрудникаПоФизическомуЛицу(ФизЛицо);

		Если ЗначениеЗаполнено(СуществующийСотрудник) Тогда
			Результат.УжеСуществовало = Результат.УжеСуществовало + 1;
			Продолжить;
		КонецЕсли;

		// Создаем нового сотрудника
		НовыйСотрудник = СоздатьСотрудникаИзФизическогоЛица(ФизЛицо, ГоловнаяОрганизацияСсылка);

		Если ЗначениеЗаполнено(НовыйСотрудник) Тогда
			Результат.Создано = Результат.Создано + 1;
		Иначе
			Результат.Ошибок = Результат.Ошибок + 1;
		КонецЕсли;

	КонецЦикла;

	// Выводим итоговое сообщение
	Сообщить("Обработка завершена:");
	Сообщить("  Создано новых сотрудников: " + Строка(Результат.Создано));
	Сообщить("  Уже существовало: " + Строка(Результат.УжеСуществовало));
	Сообщить("  Ошибок: " + Строка(Результат.Ошибок));

	Возврат Результат;

КонецФункции

// Процедура выполнения обработки
//
Процедура Выполнить() Экспорт

	Если ЗначениеЗаполнено(ФизическоеЛицо) Тогда
		СоздатьСотрудникаИзФизическогоЛица(ФизическоеЛицо, ГоловнаяОрганизация);
	Иначе
		Сообщить("Не указано физическое лицо для создания сотрудника!");
	КонецЕсли;

КонецПроцедуры
