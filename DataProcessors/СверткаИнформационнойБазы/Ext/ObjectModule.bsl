#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

Перем ВалютаРегламентированногоУчета, ВалютаУправленческогоУчета, КурсыВалют;
Перем Комментарий_УдалитьПриСверткеБазы, Комментарий_НеУдалятьПриСверткеБазы, Комментарий_СформированСверткойБазы, Комментарий_СкорректированСверткойБазы;
Перем ТаблицаОстаткиНаСкладахПоПомещениям;
Перем ТаблицаОстаткиНаСкладахПоСериям;
Перем ИспользоватьНазначения;
Перем ТаблицаОстаткиНаСкладахПоНазначению;
Перем КоличествоСтрокВДокументеВводаОстатков;
Перем ОтраженоИзменениеДокументов;
Перем СтруктураИспользованиеИтоговРегистровНакопления;
Перем СкладскиеЯчейки_ЗонаПриемки;
Перем НепериодическиеРСПодчиненныеРегистратору;

//++ НЕ УТ
Перем ОбъектыПодсистемыЗУП;
//-- НЕ УТ

#Область СлужебныеПроцедурыИФункции

// Функция возвращает список объектов метаданных
//
// Параметры
//  Нет 
//
// Возвращаемое значение:
//  Соответствие - Ключи - названия объектов метаданных, Значения - сами метаданные.
Функция ПолучитьТипыОбъектовМД() 
	
	МассивРез = Новый Структура();
	МассивРез.Вставить("Документ", Метаданные.Документы);
	МассивРез.Вставить("Задача", Метаданные.Задачи);
	МассивРез.Вставить("РегистрНакопления", Метаданные.РегистрыНакопления);
	МассивРез.Вставить("РегистрСведений", Метаданные.РегистрыСведений);
	//++ НЕ УТ
	МассивРез.Вставить("РегистрБухгалтерии", Метаданные.РегистрыБухгалтерии);
	//-- НЕ УТ
	Возврат МассивРез;
	
КонецФункции

//++ НЕ УТ
Процедура ПолучитьОбъектыПодсистемыЗУП()
	ОбъектыПодсистемыЗУП = Новый Массив;
	МетаДокументы = Метаданные.Документы;
	МетаРегистрыСведений = Метаданные.РегистрыСведений;

	Для Каждого ОбъектМД Из Метаданные.Подсистемы.Зарплата.Состав Цикл
		Если МетаДокументы.Содержит(ОбъектМД)
			Или МетаРегистрыСведений.Содержит(ОбъектМД) Тогда
			ОбъектыПодсистемыЗУП.Добавить(ОбъектМД);
		КонецЕсли;
	КонецЦикла;
	ОбъектыПодсистемыЗУП.Добавить(Метаданные.РегистрыНакопления.БухгалтерскиеВзаиморасчетыССотрудниками);
	ОбъектыПодсистемыЗУП.Добавить(Метаданные.РегистрыСведений.ПредельныеСуммыУдержанийСотрудников);

	// Регистры, которые двигаются документом ПереносДанных, все попадают в исключения.
	Для Каждого ОбъектМД Из Метаданные.Документы.ПереносДанных.Движения Цикл
		Если ОбъектыПодсистемыЗУП.Найти(ОбъектМД) = Неопределено Тогда
			ОбъектыПодсистемыЗУП.Добавить(ОбъектМД);
		КонецЕсли;
	КонецЦикла;
	// Документы Ведомость на выплату зарплаты добавим.
	ОбъектыПодсистемыЗУП.Добавить(Метаданные.Документы.ВедомостьНаВыплатуЗарплатыВБанк);
	ОбъектыПодсистемыЗУП.Добавить(Метаданные.Документы.ВедомостьНаВыплатуЗарплатыВКассу);
	ОбъектыПодсистемыЗУП.Добавить(Метаданные.Документы.ВедомостьНаВыплатуЗарплатыПеречислением);
	ОбъектыПодсистемыЗУП.Добавить(Метаданные.Документы.ВедомостьНаВыплатуЗарплатыРаздатчиком);

	// Документ ОтражениеЗарплаты в фин учете - исключение из правила, его надо удалить из списка.
	Индекс = ОбъектыПодсистемыЗУП.Найти(Метаданные.Документы.ОтражениеЗарплатыВФинансовомУчете);
	Если Индекс <> Неопределено Тогда
		ОбъектыПодсистемыЗУП.Удалить(Индекс);
	КонецЕсли;
КонецПроцедуры
//-- НЕ УТ

Процедура ПолучитьНепериодическиеРСПодчиненныеРегистратору()
	НепериодическиеРСПодчиненныеРегистратору = Новый Массив;
	Для Каждого РС Из Метаданные.РегистрыСведений Цикл
		Если РС.ПериодичностьРегистраСведений = Метаданные.СвойстваОбъектов.ПериодичностьРегистраСведений.Непериодический 
			И РС.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору Тогда
		НепериодическиеРСПодчиненныеРегистратору.Добавить(РС);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

// Функция возвращает способ удаления движений для типа объекта метаданных
//
// Параметры
//  ТипОбъектаМД - элемент соответствия, полученного функцией ПолчитьМассивТиповОбъектовМД() 
//  ОбъектМД - метаданные, для которых нужно получить способ свертки
//
// Возвращаемое значение:
//  Строка - способ удаления движений для данного объекта
Функция ПолучитьПризнакУдаленияДвижений(ТипОбъектаМД, ОбъектМД)
	УдалятьДвижения = Ложь;
	//Определим способ свертки по типу объекта метаданных
	Если ТипОбъектаМД.Ключ = "РегистрСведений" ТОгда
		Если (ОбъектМД.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору) Тогда
			УдалятьДвижения = Истина;
		Иначе
			УдалятьДвижения = Ложь;
		КонецЕсли;
	ИначеЕсли ТипОбъектаМД.Ключ = "РегистрНакопления" ТОгда
		УдалятьДвижения = Истина;
	//++ НЕ УТ
	ИначеЕсли ТипОбъектаМД.Ключ = "РегистрБухгалтерии" ТОгда
		УдалятьДвижения = Истина;
	//-- НЕ УТ
	ИначеЕсли ТипОбъектаМД.Ключ = "Задача" ИЛИ ТипОбъектаМД.Ключ = "Документ" ТОгда
		УдалятьДвижения = Истина;
	КонецЕсли;
	
	Возврат УдалятьДвижения;
	
КонецФункции

// Процедура выводит сообщение о ходе процесса свертки
//
// Параметры
//  Нет 
// 
Процедура СообщениеСвертки(ТекстСообщения, ЭтоОшибка = Ложь, ОписаниеОшибки = Неопределено) 
	
	ПараметрыЖурнала = Новый Структура();
	ПараметрыЖурнала.Вставить("ГруппаСобытий", НСтр("ru='СверткаИБ';uk='СверткаИБ'"));
	ПараметрыЖурнала.Вставить("Метаданные", Неопределено);
	ПараметрыЖурнала.Вставить("Данные", Неопределено);
	Если ЭтоОшибка Тогда
		УровеньЖурнала = УровеньЖурналаРегистрации.Ошибка;
	Иначе
		УровеньЖурнала = УровеньЖурналаРегистрации.Информация;
	КонецЕсли;
	ОбщегоНазначенияУТ.ЗаписатьВЖурналСообщитьПользователю(ПараметрыЖурнала, УровеньЖурнала, ,ТекстСообщения,ОписаниеОшибки);
КонецПроцедуры

//Процедура формирует и выводит сообщение о формировании документов ввода остатков
Процедура ВывестиСообщениеСформированыДокументы(ИмяДокумента, ХозОперация = "", Обработаны = Ложь)
	Если Обработаны Тогда
		ТекстСообщения = НСтр("ru='Обработаны документы %1% (%2%)';uk='Опрацьовані документи %1% (%2%)'");
	Иначе
		ТекстСообщения = НСтр("ru='Сформированы документы %1% %2%';uk='Сформовані документи %1% %2%'");
	КонецЕсли;
	ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Метаданные.Документы[ИмяДокумента].Синоним);
	Если ХозОперация = "" Тогда
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "(%2%)", "");
	Иначе
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%2%", ХозОперация);
	КонецЕсли;
	СообщениеСвертки(ТекстСообщения);
КонецПроцедуры

//Получает массив, содержащий имена документов ввода остатков
Функция ТипыДокументовВводаОстатков(ОбрабатыватьЗаказы)
	МассивТипов = Новый Массив;
	МассивТипов.Добавить("УстановкаБлокировокЯчеек");
	МассивТипов.Добавить("УстановкаКвотАссортимента");
	МассивТипов.Добавить("ИзменениеАссортимента");
	МассивТипов.Добавить("РегистрацияЦенНоменклатурыПоставщика");
	МассивТипов.Добавить("УстановкаЦенНоменклатуры");
	
	МассивТипов.Добавить("ВводОстатковВзаиморасчетов");
	МассивТипов.Добавить("ВводОстатковДенежныхСредств");
	МассивТипов.Добавить("ВводОстатковОПродажахЗаПрошлыеПериоды");
	МассивТипов.Добавить("ВводОстатковПоФинансовымИнструментам");
	МассивТипов.Добавить("ВводОстатковПрочиеРасходы");
	МассивТипов.Добавить("ВводОстатковПрочихАктивовПассивов");
	МассивТипов.Добавить("ВводОстатковРасчетовПоЭквайрингу");
	МассивТипов.Добавить("ВводОстатковСПодотчетниками");
	МассивТипов.Добавить("ВводОстатковТоваров");

	МассивТипов.Добавить("ОтборРазмещениеТоваров");
	МассивТипов.Добавить("ЗаявкаНаРасходованиеДенежныхСредств");
	МассивТипов.Добавить("НачислениеИСписаниеБонусныхБаллов");
	МассивТипов.Добавить("ПервичныйДокумент");
	МассивТипов.Добавить("ПриемкаТоваровНаХранение");
	//++ НЕ УТ
	МассивТипов.Добавить("УстановкаЗначенийНефинансовыхПоказателей");
	МассивТипов.Добавить("НормативРаспределенияПлановПродажПоКатегориям");
	МассивТипов.Добавить("ПоступлениеОтПереработчика"); 
	МассивТипов.Добавить("ОперацияБух");
	//-- НЕ УТ
	//++ НЕ УТКА
	МассивТипов.Добавить("ВводОстатковНМАМеждународныйУчет");
	МассивТипов.Добавить("ВводОстатковОСМеждународныйУчет");
	МассивТипов.Добавить("РазрешениеНаЗаменуМатериалов");
	МассивТипов.Добавить("УстановкаЗначенийНаработки");
	//-- НЕ УТКА

	Если ОбрабатыватьЗаказы Тогда
		МассивТипов.Добавить("ЗаказКлиента");
		МассивТипов.Добавить("ЗаказНаВнутреннееПотребление");
		МассивТипов.Добавить("ЗаказНаПеремещение");
		МассивТипов.Добавить("ЗаказНаСборку");
		МассивТипов.Добавить("ЗаказПоставщику");
		МассивТипов.Добавить("ЗаявкаНаВозвратТоваровОтКлиента");
		//++ НЕ УТ
		МассивТипов.Добавить("ЗаказМатериаловВПроизводство");
		МассивТипов.Добавить("ЗаказПереработчику"); 
		//-- НЕ УТ
		//++ НЕ УТКА
		МассивТипов.Добавить("ЗаказНаПроизводство");
		МассивТипов.Добавить("ЗаказДавальца");
		МассивТипов.Добавить("ЗаказНаРемонт");
		//-- НЕ УТКА
	КонецЕсли;
	Возврат МассивТипов;
КонецФункции

//Функция получает массив документов ввода остатков для последующего проведения, удаления или исключения из списка удаляемых документов
//Параметр - Действие (строка), от него зависит по каким условиям будут отбираться документы
Функция ДокументыВводаОстатковПодлежащиеОбработке(Действие)
	
	Если Действие = "проведение" Тогда
		ДопУсловие = " И НЕ Док.ПометкаУдаления И НЕ Док.Проведен
		| И Док.Комментарий ПОДОБНО &Комментарий_СформированСверткойБазы
		| И Док.Дата >= &НачДата";
	ИначеЕсли Действие = "удаление" Тогда
		ДопУсловие = " И Док.Дата >= &НачДата  И НЕ Док.ПометкаУдаления
		|И Док.Комментарий ПОДОБНО &Комментарий_СформированСверткойБазы";
	ИначеЕсли Действие = "исключение" Тогда
		ДопУсловие = " И (Док.Дата >= &НачДата И Док.Комментарий ПОДОБНО &Комментарий_СформированСверткойБазы ИЛИ
		|Док.Комментарий ПОДОБНО &Комментарий_НеУдалятьПриСверткеБазы)";
	КонецЕсли;
	//Документы Заказ и Заявка на возврат обрабатываются только на этапе исключение. 
	//У них не бывает коммента %Сформирован обработкой свертки базы% 
	ОбрабатыватьЗаказы = ?(Действие = "исключение", Истина, Ложь);
	ТипыДокументов = ТипыДокументовВводаОстатков(ОбрабатыватьЗаказы);
	
	ТекстЗапроса = "";
	Для Каждого ИмяДокумента ИЗ ТипыДокументов Цикл
		
		Если ТекстЗапроса <> "" Тогда
			ТекстЗапроса = ТекстЗапроса + "
			|ОБЪЕДИНИТЬ ВСЕ
			|";
		КонецЕсли;
		// У некоторых документов реквизит Комментарий отсутствует.
		ДопУсловиеДляВидаДокумента = ДопУсловие;
		Если ИмяДокумента = "ПервичныйДокумент" Тогда
			ДопУсловиеДляВидаДокумента = "";
		//++ НЕ УТКА
		ИначеЕсли ИмяДокумента = "РазрешениеНаЗаменуМатериалов" Тогда
			ДопУсловиеДляВидаДокумента = СтрЗаменить(ДопУсловие, ".Комментарий", ".УказаниеПоПрименению");
		//-- НЕ УТКА
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + "ВЫБРАТЬ
		|Док.Ссылка КАК Ссылка
		|ИЗ Документ."+ИмяДокумента+" КАК Док
		|ГДЕ Док.Дата <= &КонДата "+ ДопУсловиеДляВидаДокумента +"
		|";
	КонецЦикла;
	Если Действие = "проведение" Тогда
		// Отдельно добавить Возвраты от клиентов, обработанные при свертке и находящиеся после свертки базы.
		ТекстЗапроса = ТекстЗапроса + "
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|Док.Ссылка КАК Ссылка
		|ИЗ Документ.ВозвратТоваровОтКлиента КАК Док
		|ГДЕ Док.Дата >= &НачДата И Док.Комментарий ПОДОБНО &Комментарий_СкорректированСверткойБазы
		|";

	КонецЕсли;

	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("НачДата", НачалоДня(ДатаСверткиИБ));
	Запрос.УстановитьПараметр("КонДата", КонецДня(ДатаСверткиИБ));
	Запрос.УстановитьПараметр("Комментарий_СформированСверткойБазы", "%"+НСтр("ru='Сформирован обработкой свертки базы';uk='Сформований обробкою згортки бази'")+"%");
	Запрос.УстановитьПараметр("Комментарий_НеУдалятьПриСверткеБазы", "%"+НСтр("ru='Не удалять при свертке базы';uk='Не вилучати при згортці бази'")+"%");
	Запрос.УстановитьПараметр("Комментарий_СкорректированСверткойБазы", "%"+НСтр("ru='[Скорректирован обработкой свертки базы]';uk='[Скоригований обробкою згортки бази]'"));
	
	Результат = Запрос.Выполнить();
	МассивДокументов = Новый Массив;
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			МассивДокументов.Добавить(Выборка.Ссылка);
		КонецЦикла;
	КонецЕсли;
	
	
	Возврат МассивДокументов;
КонецФункции

// Процедура определяет ситуацию, когда при изменении своей даты документ 
//  оказывается в другом периоде нумерации документов, и в это м случае
//  присваивает документу новый уникальный номер.
//
// Параметры:
//  ДокументОбъект         - контекст документа,из которого вызвана процедура 
//  НачальнаяДатаДокумента - начальная дата документа 
// 
Процедура ПроверитьНомерДокумента(ДокументОбъект, НачальнаяДатаДокумента) 

	// Определяем назначенную для данного вида документов периодичность смены номера
	ПериодСменыНомера = ДокументОбъект.Метаданные().ПериодичностьНомера;

	//В зависимости от установленной периодичности смены номеров,
	//определяем разность старой и новой датами документа.
	Если ПериодСменыНомера = Метаданные.СвойстваОбъектов.ПериодичностьНомераДокумента.Год Тогда
		РазностьДат = НачалоГода(НачальнаяДатаДокумента) - НачалоГода(ДокументОбъект.Дата);

	ИначеЕсли ПериодСменыНомера = Метаданные.СвойстваОбъектов.ПериодичностьНомераДокумента.Квартал Тогда
		РазностьДат = НачалоКвартала(НачальнаяДатаДокумента) - НачалоКвартала(ДокументОбъект.Дата);

	ИначеЕсли ПериодСменыНомера = Метаданные.СвойстваОбъектов.ПериодичностьНомераДокумента.Месяц Тогда
		РазностьДат = НачалоМесяца(НачальнаяДатаДокумента) - НачалоМесяца(ДокументОбъект.Дата);

	ИначеЕсли ПериодСменыНомера = Метаданные.СвойстваОбъектов.ПериодичностьНомераДокумента.День Тогда
		РазностьДат = НачальнаяДатаДокумента - ДокументОбъект.Дата;

	Иначе
		Возврат;

	КонецЕсли;

	Если РазностьДат <> 0 Тогда
		ДокументОбъект.Номер = "";
	КонецЕсли;

КонецПроцедуры // ПроверитьНомерДокумента()

//Процедура записывает в константу параметров свертки факт изменения документов в ходе создания документов ввода остатков
Процедура ЗафиксироватьИзменениеДокументовВПараметрСвертки()
	Если ОтраженоИзменениеДокументов Тогда
		Возврат;
	КонецЕсли;
	УстановитьПараметрСвертки("ИзмененыДокументы");
	ОтраженоИзменениеДокументов = Истина;
КонецПроцедуры

Процедура УстановитьПараметрСвертки(ИмяПараметра, ЗначениеПараметра = Истина) Экспорт
	СтруктураПараметрыСвертки = Константы.ПараметрыСверткиИБ.Получить().Получить();
	Если ТипЗнч(СтруктураПараметрыСвертки) <> Тип("Структура") Тогда
		СтруктураПараметрыСвертки = Новый Структура;
	ИначеЕсли СтруктураПараметрыСвертки.Свойство(ИмяПараметра) Тогда
		//Возможно, уже установлено 
		Если СтруктураПараметрыСвертки[ИмяПараметра] = ЗначениеПараметра Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;

	СтруктураПараметрыСвертки.Вставить(ИмяПараметра, ЗначениеПараметра);
	СтруктураПараметрыСверткиХранилище = Новый ХранилищеЗначения(СтруктураПараметрыСвертки);
	Константы.ПараметрыСверткиИБ.Установить(СтруктураПараметрыСверткиХранилище);
КонецПроцедуры

#Область ПроведениеДокументовВводаОстатков

// Процедура проводит документы ввода остатков 
// 
Процедура ПровестиДокументыВводаОстатков() Экспорт
	МассивДокументов = ДокументыВводаОстатковПодлежащиеОбработке("проведение");
	Для каждого ДокСсылка ИЗ МассивДокументов Цикл
		ДокОбъект = ДокСсылка.ПолучитьОбъект();
		ДокОбъект.ДополнительныеСвойства.Вставить("СверткаИБ", Истина); 
		Попытка
			//Док ОтборРазмещениеТоваров - особый алгоритм. Последовательное проведение в разных статусах
			Если ТипЗнч(ДокСсылка) = Тип("ДокументСсылка.ОтборРазмещениеТоваров") Тогда
				ДокОбъект.Статус = Перечисления.СтатусыОтборовРазмещенийТоваров.ВРаботе;
				ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
				ДокОбъект.Статус = Перечисления.СтатусыОтборовРазмещенийТоваров.ВыполненоБезОшибок;
			КонецЕсли;
			ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
			СообщениеСвертки(НСтр("ru='Проведен';uk='Проведено'")+": "+ ДокОбъект.Ссылка);
		Исключение
			СообщениеСвертки(НСтр("ru='Не удалось провести документ';uk='Не вдалося провести документ'")+" :" + ДокОбъект.Ссылка, Истина, ОписаниеОшибки());
		КонецПопытки;
	КонецЦикла;
	// Включить обратно контроль остатков, если надо.
	СтруктураПараметрыСвертки = Константы.ПараметрыСверткиИБ.Получить().Получить();
	Если ТипЗнч(СтруктураПараметрыСвертки) = Тип("Структура") Тогда
		Если СтруктураПараметрыСвертки.Свойство("СброшенКонтрольОстатковТоварыОрганизаций")
			И СтруктураПараметрыСвертки.СброшенКонтрольОстатковТоварыОрганизаций Тогда
			Константы.КонтролироватьОстаткиТоваровОрганизаций.Установить(Истина);
			СтруктураПараметрыСвертки.СброшенКонтрольОстатковТоварыОрганизаций = Ложь;
			СтруктураПараметрыСверткиХранилище = Новый ХранилищеЗначения(СтруктураПараметрыСвертки);
			Константы.ПараметрыСверткиИБ.Установить(СтруктураПараметрыСверткиХранилище);
		КонецЕсли; 
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область ПроцедурыУдаленияОбъектовМетаданныхИДвижений

//Функция определяет, используется ли в итогах хотя бы одно измерение регистра накопления
Функция ИспользуютсяИтогиРегистраНакопления(ИмяРегистра)
	ИспользованиеИтогов = Неопределено;
	СтруктураИспользованиеИтоговРегистровНакопления.Свойство(ИмяРегистра, ИспользованиеИтогов);
	Если ИспользованиеИтогов <> Неопределено Тогда
		Возврат ИспользованиеИтогов;
	КонецЕсли;
	ИспользованиеИтогов = Ложь;
	Для Каждого ИзмерениеРегистра ИЗ Метаданные.РегистрыНакопления[ИмяРегистра].Измерения Цикл
		Если ИзмерениеРегистра.ИспользованиеВИтогах Тогда
			ИспользованиеИтогов = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	СтруктураИспользованиеИтоговРегистровНакопления.Вставить(ИмяРегистра,ИспользованиеИтогов);
	Возврат ИспользованиеИтогов;
КонецФункции

// Процедура производит свертку по переданному объекту метаданных
//
Процедура УдалитьДвиженияПоОбъектуМД(ТекСтрока, ТипОбъектаМД, МассивПропускаемыхДокументов, МассивУдаляемыхДокументов)
		
	СообщениеСвертки(НСтр("ru='Начало очистки';uk='Початок очищення'")+ ": " + ТипОбъектаМД + "." + ТекСтрока.ОбъектМД);
	
	Если (ВРЕГ(ТипОбъектаМД) = "РЕГИСТРНАКОПЛЕНИЯ") Тогда
		ЕстьИтоги = ИспользуютсяИтогиРегистраНакопления(ТекСтрока.ОбъектМД);
		Если ЕстьИтоги Тогда
			РегистрыНакопления[ТекСтрока.ОбъектМД].УстановитьИспользованиеИтогов(Ложь);
		КонецЕсли;
		
		Попытка
			УдалитьДвиженияПоРегиструСРегистратором(ТипОбъектаМД, ТекСтрока.ОбъектМД,МассивПропускаемыхДокументов, МассивУдаляемыхДокументов);
			
		Исключение
			СообщениеСвертки(НСтр("ru='Ошибка при очистке';uk='Помилка при очищенні'")+ ": " + ТипОбъектаМД + "." + ТекСтрока.ОбъектМД, Истина, ОписаниеОшибки());
			Возврат;
			
		КонецПопытки;	
		Если ЕстьИтоги Тогда
			РегистрыНакопления[ТекСтрока.ОбъектМД].УстановитьИспользованиеИтогов(Истина);
		КонецЕсли;
	//++ НЕ УТ
	ИначеЕсли (ВРЕГ(ТипОбъектаМД) = "РЕГИСТРБУХГАЛТЕРИИ") Тогда
		Попытка
			УдалитьДвиженияПоРегиструСРегистратором(ТипОбъектаМД, ТекСтрока.ОбъектМД,МассивПропускаемыхДокументов, МассивУдаляемыхДокументов);
			
		Исключение
			СообщениеСвертки(НСтр("ru='Ошибка при очистке';uk='Помилка при очищенні'")+ ": " + ТипОбъектаМД + "." + ТекСтрока.ОбъектМД, Истина, ОписаниеОшибки());
			Возврат;
			
		КонецПопытки;	

	//-- НЕ УТ
	ИначеЕсли ВРЕГ(ТипОбъектаМД) = "РЕГИСТРСВЕДЕНИЙ" Тогда
		ТекРег = Метаданные.РегистрыСведений.Найти(ТекСтрока.ОбъектМД);
		
		Попытка
			Если (ТекРег.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору) Тогда
				Если ТекРег.ПериодичностьРегистраСведений = Метаданные.СвойстваОбъектов.ПериодичностьРегистраСведений.Непериодический Тогда
					// Такие движения удаляем при пометке на удаление регистратора.
					Возврат;
				КонецЕсли;
				УдалитьДвиженияПоРегиструСРегистратором(ТипОбъектаМД, ТекСтрока.ОбъектМД, МассивПропускаемыхДокументов, МассивУдаляемыхДокументов);
			КонецЕсли;	
			
		Исключение
			СообщениеСвертки(НСтр("ru='Ошибка при очистке';uk='Помилка при очищенні'")+ ": " + ТипОбъектаМД + "." + ТекСтрока.ОбъектМД, Истина, ОписаниеОшибки());
			Возврат;
			
		КонецПопытки;	
		
	ИначеЕсли ВРЕГ(ТипОбъектаМД) = "ДОКУМЕНТ" Тогда
		ПометитьНаУдалениеДокументы(ТекСтрока.ОбъектМД, МассивПропускаемыхДокументов, МассивУдаляемыхДокументов);
		
	ИначеЕсли ВРЕГ(ТипОбъектаМД) = "ЗАДАЧА" Тогда
		ПометитьНаУдалениеЗадачи(ТекСтрока.ОбъектМД);
	КонецЕсли;
	
	СообщениеСвертки(НСтр("ru='Окончание очистки';uk='Закінчення очищення'")+ ": " + ТипОбъектаМД + "." + ТекСтрока.ОбъектМД);
	
КонецПроцедуры	

// Процедура производит удаление движений по дату свертки
//
// Параметры
//  ДеревоСпособовСвертки	- дерево значений, содержащее объекты для свертки  
//
Процедура УдалитьДвиженияПоДатуСвертки() Экспорт
	ТаблицаУдаленияДвиженийПоОбъектамМетаданных = Новый ТаблицаЗначений;
	ТаблицаУдаленияДвиженийПоОбъектамМетаданных.Колонки.Добавить("ТипОбъектаМД");
	ТаблицаУдаленияДвиженийПоОбъектамМетаданных.Колонки.Добавить("ОбъектМД");

	МассивТиповОбъектовМД = ПолучитьТипыОбъектовМД();

	//++ НЕ УТ
	ПолучитьОбъектыПодсистемыЗУП();
	//-- НЕ УТ
	ПолучитьНепериодическиеРСПодчиненныеРегистратору();
	Для Каждого ТипОбъектаМД Из МассивТиповОбъектовМД Цикл
		Для Каждого ОбъектМД из ТипОбъектаМД.Значение Цикл
			//++ НЕ УТ
			Если ОбъектыПодсистемыЗУП.Найти(ОбъектМД) <> Неопределено Тогда
				Продолжить;
			КонецЕсли;
			//-- НЕ УТ
			ПризнакУдаленияДвижений = ПолучитьПризнакУдаленияДвижений(ТипОбъектаМД, ОбъектМД);
			Если ПризнакУдаленияДвижений = Ложь Тогда
				Продолжить;
			КонецЕсли;

			НоваяСтрокаОбъектМД = ТаблицаУдаленияДвиженийПоОбъектамМетаданных.Добавить();
			НоваяСтрокаОбъектМД.ТипОбъектаМД = ТипОбъектаМД.Ключ;
			НоваяСтрокаОбъектМД.ОбъектМД = ОбъектМД.Имя;
		КонецЦикла;
	КонецЦикла;
	ТаблицаУдаленияДвиженийПоОбъектамМетаданных.Сортировать("ТипОбъектаМД, ОбъектМД");
	
	//Получим массив исключаемых документов - некоторые типы документов, 
	//	у которых комментарий содержит строку "Не удалять при свертке базы" либо "Сформирован обработкой свертки базы"
	МассивПропускаемыхДокументов = ДокументыВводаОстатковПодлежащиеОбработке("исключение");
	
	//Получим массив удаляемых документов после даты свертки - таких, у которых 
	//комментарий содержит строку "Удалить при свертке базы"
	МассивТипов = Новый Массив;
	МассивТипов.Добавить("ПриходныйОрдерНаТовары");
	МассивТипов.Добавить("РасходныйОрдерНаТовары");
	МассивТипов.Добавить("ПоступлениеТоваровНаСклад");

	Запрос = Новый Запрос;
	ТекстЗапроса = "";
	Для Каждого ТипДокумента ИЗ МассивТипов Цикл
		ТекстЗапроса = ТекстЗапроса + ?(ТекстЗапроса <> "", "ОБЪЕДИНИТЬ ВСЕ "," ") + " ВЫБРАТЬ
		|Ссылка
		|ИЗ Документ."+ТипДокумента+"
		|ГДЕ Дата > &КонДата И Комментарий ПОДОБНО &ПодлежитУдалению
		|";
	КонецЦикла;
	Запрос.УстановитьПараметр("КонДата", КонецДня(ДатаСверткиИБ));
	Запрос.УстановитьПараметр("ПодлежитУдалению", "%"+Комментарий_УдалитьПриСверткеБазы+"%");

	Запрос.Текст = ТекстЗапроса;
	МассивУдаляемыхДокументов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");

	Для Каждого ТекСтрока Из ТаблицаУдаленияДвиженийПоОбъектамМетаданных Цикл
		Если (ВРЕГ(ТекСтрока.ТипОбъектаМД) = "ДОКУМЕНТ") 
			ИЛИ (ВРЕГ(ТекСтрока.ТипОбъектаМД) = "ЗАДАЧА") Тогда
			//Обработаем на 2ой итерации
			
		Иначе

			//Удаляются записи регистров
			УдалитьДвиженияПоОбъектуМД(ТекСтрока, ТекСтрока.ТипОбъектаМД, МассивПропускаемыхДокументов, МассивУдаляемыхДокументов);
			
		КонецЕсли;
		
	КонецЦикла;

	// Явно пометим на удаление документы, которые должны обрабатываться в первую очередь 
	//  От них зависит удаление других документов.
	//++ НЕ УТКА
	ПометитьНаУдалениеДокументы("ЭтапПроизводства2_2", МассивПропускаемыхДокументов, МассивУдаляемыхДокументов);
	ПометитьНаУдалениеДокументы("ПроизводственнаяОперация2_2", МассивПропускаемыхДокументов, МассивУдаляемыхДокументов);
	//-- НЕ УТКА

	Для Каждого ТекСтрока Из ТаблицаУдаленияДвиженийПоОбъектамМетаданных Цикл
		Если (ВРЕГ(ТекСтрока.ТипОбъектаМД) = "ДОКУМЕНТ") 
			ИЛИ (ВРЕГ(ТекСтрока.ТипОбъектаМД) = "ЗАДАЧА") Тогда
			// Некоторые виды документов не помечаются на удаление по техническим особенностям.
			Если НРег(ТекСтрока.ОбъектМД) = НРег("РегистраторГрафикаДвиженияТоваров") Тогда
				Продолжить;
			КонецЕсли;

			//Помечаются на удаление документы и задачи
			УдалитьДвиженияПоОбъектуМД(ТекСтрока, ТекСтрока.ТипОбъектаМД, МассивПропускаемыхДокументов, МассивУдаляемыхДокументов);
			
		Иначе	
			//Уже обработано на 1й итерации
			
		КонецЕсли;	
		
	КонецЦикла;
	
	//В процессе удаления движений могли остаться регистры накопления с отключенными итогами. Включим их обратно.
	Для Каждого ТекРегистр Из Метаданные.РегистрыНакопления Цикл
		Если НЕ РегистрыНакопления[ТекРегистр.Имя].ПолучитьИспользованиеИтогов()
			И ИспользуютсяИтогиРегистраНакопления(ТекРегистр.Имя) Тогда
			РегистрыНакопления[ТекРегистр.Имя].УстановитьИспользованиеИтогов(Истина);
		КонецЕсли;
	КонецЦикла;

КонецПроцедуры

// Процедура помечает на удаление документы
//
// Параметры
//  ИмяДокумента 	- строка, содержащая имя документа как оно задано в конфигураторе,  
//  ДатаНачала 		- дата начиная с которой удаляются документы,
//  ДатаОкончания	- дата по которую удаляются документы
//
Процедура ПометитьНаУдалениеДокументы(ИмяДокумента, МассивПропускаемыхДокументов, МассивУдаляемыхДокументов)
	Если ИмяДокумента = "ЧекККМ" ИЛИ ИмяДокумента = "ЧекККМВозврат" Тогда
		// Чеки ККМ можно удалить только специальной обработкой архивирования и удаления чеков ККМ.
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТекДокумент.Ссылка КАК Документ,
	|	ТекДокумент.Дата КАК Дата
	|ИЗ
	|	Документ.#ЭтоЗаменяется# КАК ТекДокумент
	|ГДЕ
	|	(НЕ ТекДокумент.ПометкаУдаления) 
	|	И ТекДокумент.Дата <= &ДатаОкончания
	|	И ТекДокумент.Ссылка НЕ В (&МассивПропускаемыхДокументов)";
	Если МассивУдаляемыхДокументов.Количество() > 0 Тогда
		Запрос.Текст = "ВЫБРАТЬ
		|Документ, Дата
		|ИЗ (
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТекДокумент.Ссылка КАК Документ,
		|	ТекДокумент.Дата КАК Дата
		|ИЗ
		|	Документ.#ЭтоЗаменяется# КАК ТекДокумент
		|ГДЕ
		|	(НЕ ТекДокумент.ПометкаУдаления)
		|	И ТекДокумент.Дата > &ДатаОкончания
		|	И ТекДокумент.Ссылка В (&МассивУдаляемыхДокументов)
		|ОБЪЕДИНИТЬ ВСЕ
		|" + Запрос.Текст + ") КАК Свод
		|";
	КонецЕсли;
	Запрос.Текст = Запрос.Текст + "УПОРЯДОЧИТЬ ПО Дата УБЫВ";	
	Запрос.Текст = СтрЗаменить(Запрос.Текст,"#ЭтоЗаменяется#", ИмяДокумента);
	
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаСверткиИБ));
	Запрос.УстановитьПараметр("МассивПропускаемыхДокументов",    МассивПропускаемыхДокументов);
	Запрос.УстановитьПараметр("МассивУдаляемыхДокументов",    МассивУдаляемыхДокументов);

	ДокВыборка = Запрос.Выполнить().Выбрать();
	Пока ДокВыборка.Следующий() Цикл
		ФлагНаличияДвижений = Ложь;
		ТекДокумент = ДокВыборка.Документ;
		ДокОбъект = ТекДокумент.ПолучитьОбъект();
		ЕстьДвиженияПоЗУПРегистрам = Ложь;
		Для Каждого ТекДвижение Из ДокОбъект.Движения Цикл
			ТекДвижение.Прочитать();
			Если ТекДвижение.Количество() > 0 Тогда
				//++ НЕ УТ
				Если ОбъектыПодсистемыЗУП.Найти(ТекДвижение.Метаданные()) <> Неопределено Тогда
					// Документ содержит движения по ЗУП регистрам.
					// Его не надо удалять.
					ЕстьДвиженияПоЗУПРегистрам = Истина;
					Прервать;
				КонецЕсли;
				//-- НЕ УТ
				// Возможно это не периодический регистр сведений. Такие движения удаляются вместе с документом, их наличие не является ошибкой.
				Если НепериодическиеРСПодчиненныеРегистратору.Найти(ТекДвижение.Метаданные()) <> Неопределено Тогда
					Продолжить;
				КонецЕсли;
				//По документу есть движения
				ФлагНаличияДвижений = Истина;
				// Если дата движений больше чем дата свертки сообщение не выводим - это норма.
				Если ТекДвижение[0].Период < КонецДня(ДатаСверткиИБ) Тогда
					ТекстСообщения = НСтр("ru='По документу %Документ% есть движения по регистрам, пометка на удаление не выполнена';uk='За документом %Документ% є рухи по регістрах, позначка на вилучення не виконана'");
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Документ%", ДокОбъект.Ссылка);

					СообщениеСвертки(ТекстСообщения, Истина, "");
				КонецЕсли;
				Прервать;
				
			КонецЕсли;	
		КонецЦикла;
		
		Если ЕстьДвиженияПоЗУПРегистрам Тогда
			Продолжить;
		ИначеЕсли НЕ ФлагНаличияДвижений Тогда
			ДокОбъект.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
			// Особая логика
			Если ИмяДокумента = "РеализацияПодарочныхСертификатов" И ДокОбъект.Статус = Перечисления.СтатусыЧековККМ.Пробит Тогда
				ДокОбъект.Статус = Перечисления.СтатусыЧековККМ.Отложен;
				ДокОбъект.Записать(РежимЗаписиДокумента.Запись);
			КонецЕсли;
			
			// Пометка на удаление попытка №1
			ПометкаУстановлена = Истина;
			ТекстСообщения = "";
			ОписаниеОшибки = "";
			Попытка
				ДокОбъект.УстановитьПометкуУдаления(Истина);
			Исключение
				ПометкаУстановлена = Ложь;
				ОписаниеОшибки = ОписаниеОшибки();
				ТекстСообщения = НСтр("ru='Не удалось пометить на удаление документ %Документ%';uk='Не вдалося відмітити для вилучення документ %Документ%'");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Документ%", ТекДокумент);
			КонецПопытки;	
			Если НЕ ПометкаУстановлена Тогда
				// чтобы не срабатывала логика отмены проведения документа.
				ПропуститьПопытку = Ложь;
				Попытка
					ДокОбъект.Проведен = Ложь;
					ДокОбъект.Записать(РежимЗаписиДокумента.Запись);
				Исключение
					ПропуститьПопытку = Истина;
				КонецПопытки;
				Если НЕ ПропуститьПопытку Тогда
					ПометкаУстановлена = Истина;

					//Пометка на удаление попытка №2 Отключаем возможные проверки при пометке удаления.
					Попытка
						ДокОбъект.УстановитьПометкуУдаления(Истина);					
					Исключение
						ПометкаУстановлена = Ложь; 
						ТекстСообщения = НСтр("ru='Не удалось пометить на удаление документ %Документ%';uk='Не вдалося відмітити для вилучення документ %Документ%'");
						ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Документ%", ТекДокумент);
						ОписаниеОшибки = ОписаниеОшибки();  
					КонецПопытки;
				КонецЕсли;
			КонецЕсли;
			// Пометка на удаление попытка №3
			Если НЕ ПометкаУстановлена Тогда
				ДокОбъект.ОбменДанными.Загрузка = Истина;
				ПометкаУстановлена = Истина;
				Попытка
					ДокОбъект.УстановитьПометкуУдаления(Истина);
				Исключение
					ПометкаУстановлена = Ложь; 
					ТекстСообщения = НСтр("ru='Не удалось пометить на удаление документ %Документ%';uk='Не вдалося відмітити для вилучення документ %Документ%'");
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Документ%", ТекДокумент);
					ОписаниеОшибки = ОписаниеОшибки();  
				КонецПопытки;
			КонецЕсли;
			
			Если НЕ ПометкаУстановлена Тогда
				СообщениеСвертки(ТекстСообщения, Истина, ОписаниеОшибки);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Процедура помечает на удаление задачи
//
// Параметры
//  ИмяЗадачи 	- строка, содержащая имя задачи как оно задано в конфигураторе,  
//  ДатаНачала 		- дата начиная с которой удаляются документы,
//  ДатаОкончания	- дата по которую удаляются документы
//
Процедура ПометитьНаУдалениеЗадачи(ИмяЗадачи)
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТекЗадача.Ссылка КАК Задача
	|ИЗ
	|	Задача.#ЭтоЗаменяется# КАК ТекЗадача
	|ГДЕ
	|	(НЕ ТекЗадача.ПометкаУдаления)
	|	И ТекЗадача.Дата <= &ДатаОкончания
	|	И ТекЗадача.Выполнена
	|	#УсловияПоТипуЗадачи#";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст,"#ЭтоЗаменяется#", ИмяЗадачи);
	УсловияДляЗадачи = "";
	Если ИмяЗадачи = "ЗадачаИсполнителя" Тогда
		УсловияДляЗадачи = "И ТекЗадача.СрокИсполнения <= &ДатаОкончания И ТекЗадача.БизнесПроцесс.Завершен";
	КонецЕсли;
	Запрос.Текст = СтрЗаменить(Запрос.Текст,"#УсловияПоТипуЗадачи#", УсловияДляЗадачи);
	
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаСверткиИБ));
	
	ЗадачаВыборка = Запрос.Выполнить().Выбрать();
	
	Пока ЗадачаВыборка.Следующий() Цикл
		ТекЗадача = ЗадачаВыборка.Задача;
		ЗадачаОбъект = ТекЗадача.ПолучитьОбъект();
		
		Попытка
			ЗадачаОбъект.УстановитьПометкуУдаления(Истина);
		Исключение
			ТекстСообщения = НСтр("ru='Не удалось пометить на удаление задачу %Документ%';uk='Не вдалося відмітити для вилучення задачу %Документ%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Документ%", ЗадачаВыборка.Задача);
			СообщениеСвертки(ТекстСообщения, Истина, ОписаниеОшибки());

		КонецПопытки;	
	КонецЦикла;
	
КонецПроцедуры

// Процедура очищает регистры накопления и регистры сведений, подчиненные регистратору
//
// Параметры
//  ТипОбъектаМД - строка, содержащая тип объекта метаданных,  
//  ИмяРегистра  - строка, содержащая имя регистра,
//  ДатаНачала 	 - дата, начиная с которой происходит чистка регистра,
//  ДатаОкончания- дата, по которую очищается регистр
//
Процедура УдалитьДвиженияПоРегиструСРегистратором(ТипОбъектаМД, ИмяРегистра, МассивПропускаемыхДокументов, МассивУдаляемыхДокументов) 
			
	ТекстЗапроса = "ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 10000
				|	Регистр.Регистратор КАК Регистратор
				|ИЗ
				|	" + ТипОбъектаМД + "."+ИмяРегистра+" КАК Регистр
				|ГДЕ
				|	Регистр.Период <= &ДатаКон
				|	И Регистр.Регистратор НЕ В (&МассивПропускаемыхДокументов)"; 
	//++ НЕ УТ
	Если НРег(ТипОбъектаМД) = "регистрсведений" Тогда
		МетаданныеРегистра = Метаданные.РегистрыСведений[ИмяРегистра];
	ИначеЕсли НРег(ТипОбъектаМД) = "регистрнакопления" Тогда
		МетаданныеРегистра = Метаданные.РегистрыНакопления[ИмяРегистра];
	ИначеЕсли НРег(ТипОбъектаМД) = "регистрбухгалтерии" Тогда
		МетаданныеРегистра = Метаданные.РегистрыБухгалтерии[ИмяРегистра];
	КонецЕсли;
	Для Каждого ЗУПОбъект Из ОбъектыПодсистемыЗУП Цикл
		Если Метаданные.Документы.Содержит(ЗУПОбъект) 
			И ЗУПОбъект.Движения.Содержит(МетаданныеРегистра) Тогда
			ТекстЗапроса = ТекстЗапроса + Символы.ПС + "И Регистр.Регистратор НЕ В (ВЫБРАТЬ РАЗЛИЧНЫЕ Ссылка ИЗ Документ." + ЗУПОбъект.Имя + ")";
		КонецЕсли;
	КонецЦикла;
	//-- НЕ УТ
	Если МассивУдаляемыхДокументов.Количество()>0 Тогда
	   ТекстЗапроса = ТекстЗапроса + "
				|ОБЪЕДИНИТЬ ВСЕ
				|ВЫБРАТЬ РАЗЛИЧНЫЕ 
				|	Регистр.Регистратор КАК Регистратор
				|ИЗ
				|	" + ТипОбъектаМД + "."+ИмяРегистра+" КАК Регистр
				|ГДЕ
				|	Регистр.Период > &ДатаКон
				| И Регистр.Регистратор В (&МассивУдаляемыхДокументов)
				|";
	КонецЕсли;
	Пока Истина Цикл
				
		Запрос = Новый Запрос;
		Запрос.Текст = ТекстЗапроса;
				
		Запрос.УстановитьПараметр("ДатаКон", КонецДня(ДатаСверткиИБ));
		Запрос.УстановитьПараметр("МассивПропускаемыхДокументов", МассивПропускаемыхДокументов);
		Запрос.УстановитьПараметр("МассивУдаляемыхДокументов", МассивУдаляемыхДокументов);

		Результат = Запрос.Выполнить();
		
		Если Результат.Пустой() Тогда
			Прервать;
		КонецЕсли;
		
		Строка = Результат.Выбрать();
		Пока Строка.Следующий() Цикл
			//++ НЕ УТ
			Если ОбъектыПодсистемыЗУП.Найти(Строка.Регистратор.Метаданные()) <> Неопределено Тогда
				Продолжить;
			КонецЕсли;
			//-- НЕ УТ
			Если ВРЕГ(ТипОбъектаМД) = "РЕГИСТРНАКОПЛЕНИЯ" Тогда
				НаборЗаписей = РегистрыНакопления[ИмяРегистра].СоздатьНаборЗаписей();
			ИначеЕсли ВРЕГ(ТипОбъектаМД) = "РЕГИСТРСВЕДЕНИЙ" Тогда
				НаборЗаписей = РегистрыСведений[ИмяРегистра].СоздатьНаборЗаписей();
			//++ НЕ УТ
			ИначеЕсли ВРЕГ(ТипОбъектаМД) = "РЕГИСТРБУХГАЛТЕРИИ" Тогда
				НаборЗаписей = РегистрыБухгалтерии[ИмяРегистра].СоздатьНаборЗаписей();
			//-- НЕ УТ
			Иначе
				СообщениеСвертки(НСтр("ru='Не известный тип объекта метаданных';uk='Не відомий тип об''єкта метаданих'") + " " + ТипОбъектаМД);
				Возврат;
			КонецЕсли;	
				
			НаборЗаписей.Отбор.Регистратор.Установить(Строка.Регистратор);
			//Чтобы не выполнялись запросы при записи набора записей
			НаборЗаписей.ОбменДанными.Загрузка = Истина;
			НаборЗаписей.Записать();
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры	

#КонецОбласти

#Область ПроцедурыФормированияДокументовВводаОстатков

// Процедура формирует документы ввода остатков 
//
Процедура СформироватьДокументыВводаОстатков(ПовторныйЗапуск = Ложь) Экспорт
	
	// Формирование документов запускается повторно после ошибки
	// Надо удалить документы, созданные на предыдущем этапе
	Если ПовторныйЗапуск Тогда
		МассивДокументов = ДокументыВводаОстатковПодлежащиеОбработке("удаление");
		Для каждого ДокСсылка ИЗ МассивДокументов Цикл
			ДокОбъект = ДокСсылка.ПолучитьОбъект();
			ДокОбъект.Удалить();
		КонецЦикла;
	КонецЕсли;
	ОтраженоИзменениеДокументов = Ложь;
	Если Константы.ИспользоватьДатыЗапретаИзменения.Получить() = Истина Тогда
		// Отключение использования даты запрета.
		Константы.ИспользоватьДатыЗапретаИзменения.Установить(Ложь);
		УстановитьПараметрСвертки("СброшенаДатаЗапрета");
	КонецЕсли;
	Если Константы.КонтролироватьОстаткиТоваровОрганизаций.Получить() = Истина Тогда
		// Отключение контроля остатков товаров организаций.
		Константы.КонтролироватьОстаткиТоваровОрганизаций.Установить(Ложь);
		УстановитьПараметрСвертки("СброшенКонтрольОстатковТоварыОрганизаций");
	КонецЕсли;
	// Последовательный вызов процедур формирования документов ввода остатков
	// 1. Регистры сведений
	СформироватьДокументыВводаОстатковИзменениеАссортимента();
	СформироватьДокументыВводаОстатковКвотыАссортимента();
	СформироватьДокументыВводаОстатковЦеныНоменклатуры();
	СформироватьДокументыВводаОстатковЦеныНоменклатурыПоставщиков();
	ОбработатьБлокировкиСкладскихЯчеек();

	// 2. Регистры накопления

	ОбработатьОстаткиДенежныеСредстваКПоступлениюИСписанию();
	// 2.1 Деньги
	СформироватьДокументыВводаОстатковДенежныеСредства("Безналичные");
	СформироватьДокументыВводаОстатковДенежныеСредства("ВКассахККМ");
	СформироватьДокументыВводаОстатковДенежныеСредства("Наличные");
	СформироватьДокументыВводаОстатковДенежныеСредства("УПодотчетныхЛиц");
	СформироватьДокументыВводаОстатковДенежныеСредстваКВыплате();
	
	// 2.2 Расчеты
	СформироватьДокументыВводаОстатковРасчеты("РасчетыСКлиентами");
	СформироватьДокументыВводаОстатковРасчеты("РасчетыСПоставщиками");
	СформироватьДокументыВводаОстатковРасчеты("РасчетыМеждуОрганизациями");
	СформироватьДокументыВводаОстатковРасчетыПоЭквайрингу();
	СформироватьДокументыВводаОстатковРасчетыПоКредитамИДепозитам();
	
	// 2.3 Товары
	// Таблицы остатков на складах используется для разных товаров (и собственных, и комиссионных)
	ПолучитьТаблицыОстатковНаСкладах();

	СформироватьДокументыВводаОстатковТоварыСобственные();
	СформироватьДокументыВводаОстатковТоварыКомиссионные();
	СформироватьДокументыВводаОстатковВозвратнаяТара();
	СформироватьДокументыВводаОстатковТоварыВЯчейках();
	СформироватьДокументыВводаОстатковТМЦВЭксплуатации();
	СформироватьДокументыВводаОстатковТоварыПринятые();
	
	// 2.4 Заказы
	СформироватьДокументыВводаОстатковЗаказыКлиентов();
	СформироватьДокументыВводаОстатковЗаказыПоставщикам();
	СформироватьДокументыВводаОстатковЗаказыВнутренние("ЗаказыНаВнутреннееПотребление", "ЗаказНаВнутреннееПотребление");
	СформироватьДокументыВводаОстатковЗаказыВнутренние("ЗаказыНаПеремещение", "ЗаказНаПеремещение");
	СформироватьДокументыВводаОстатковЗаказыВнутренние("ЗаказыНаСборку", "ЗаказНаСборку");
	СформироватьДокументыВводаОстатковЗаявкиНаВозврат();
	
	// 2.5 Подарочные сертификаты
	СформироватьДокументыВводаОстатковПодарочныеСертификаты();
	
	// 2.6 Расходы, фин результат, продажи за прошлые периоды
	СформироватьДокументыВводаОстатковПрочиеРасходы();
	СформироватьДокументыВводаОстатковФинансовыйРезультат();
	СформироватьДокументыВводаОстатковПродажи();
	
	// 2.7 Ордерная схема
	ОбработатьОстаткиТоварыКОтгрузке();
	ОбработатьОстаткиТоварыКПоступлению();
	ОбработатьОстаткиТоварыКОтбору();
	ОбработатьОстаткиТоваровУПартнеров();
	
	// 2.8 Себестоимость товаров в возвратах.
	ОбработатьВозвратыТоваровОтКлиентов();
	
	// 2.9 Бонусные баллы
	СформироватьДокументыВводаОстатковБонусныеБаллы();
	
	// 2.10 Прочие активы и пассивы
	СформироватьДокументыВводаОстатковПрочиеАктивыПассивы();
	
	//++ НЕ УТКА
	СформироватьДокументыВводаОстатковАналогиВПроизводстве();
	СформироватьДокументыВводаОстатковЗаказыНаПроизводство();
	СформироватьДокументыВводаОстатковЗаказыДавальцу();
	СформироватьДокументыВводаОстатковЗаказыНаРемонт();
	СформироватьДокументыОСНМАМеждународныйУчет();
	СформироватьДокументыУстановкаЗначенийНаработки();
	//-- НЕ УТКА
	//++ НЕ УТ
	СформироватьДокументыУстановкаЗначенийНефинансовыхПоказателей();
	ОбработатьНормативыРаспределенияПлановПродаж();
	СформироватьДокументыВводаОстатковЗаказыМатериаловВПроизводство();
	СформироватьДокументыВводаОстатковЗаказыПереработчику();
	СформироватьДокументыВводаОстатковПоступлениеОтПереработчика();
	СформироватьДокументыВводаОстатковПередачаПереработчику();
	СформироватьДокументыВводаОстатковМатериалыВПроизводстве();
	СформироватьДокументыВводаОстатковВнеоборотныхАктивов();
	СформироватьБухОстатки();
	//-- НЕ УТ
КонецПроцедуры

#КонецОбласти

#Область ПроцедурыСозданияЛокальныхДокументовВводаОстатков

Процедура СформироватьДокументыВводаОстатковИзменениеАссортимента()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.ОбъектПланирования КАК ОбъектПланирования,
	|ТабРег.РольАссортимента КАК РольАссортимента,
	|ТабРег.ВидЦены КАК ВидЦены,
	|ВЫБОР КОГДА ТабРег.РазрешеныЗакупки И ТабРег.РазрешеныПродажи ТОГДА Значение(Перечисление.СтадииАссортимента.РазрешеныЗакупкиИПродажи)
	|	КОГДА ТабРег.РазрешеныЗакупки ТОГДА Значение(Перечисление.СтадииАссортимента.РазрешеныТолькоЗакупки)
	|	КОГДА ТабРег.РазрешеныПродажи ТОГДА Значение(Перечисление.СтадииАссортимента.РазрешеныТолькоПродажи)
	|	ИНАЧЕ Значение(Перечисление.СтадииАссортимента.ЗапрещеныЗакупкиИПродажи)  
	|КОНЕЦ КАК Стадия
	|ИЗ РегистрСведений.Ассортимент.СрезПоследних(&ГраницаОст) КАК ТабРег
	|ИТОГИ ПО ОбъектПланирования, Стадия";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	КоличествоСформированныхДокументов = 1;

	ВыборкаОбъектПланирования = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаОбъектПланирования.Следующий() Цикл
		ВыборкаСтадия = ВыборкаОбъектПланирования.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаСтадия.Следующий() Цикл
			ДокОст = Документы.ИзменениеАссортимента.СоздатьДокумент();
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаСтадия, Ложь);
			ДокОст.ДатаНачалаДействия = КонецДня(ДатаСверткиИБ);
			ДокОст.Операция = Перечисления.ОперацииИзмененияАссортимента.ИзменениеВАссортименте;

			ВыборкаДетали = ВыборкаСтадия.Выбрать();
			Пока ВыборкаДетали.Следующий() Цикл
				НоваяСтрока = ДокОст.Товары.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаДетали);
				Если ДокОст.Товары.Количество() >= КоличествоСтрокВДокументеВводаОстатков Тогда
					//Запишем документ ввода остатков и создадим новый
					ДокОст.Записать(РежимЗаписиДокумента.Запись);
					КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
					РеквизитыШапкиДокумента = Новый Структура("Дата, ДатаНачалаДействия, Операция, Стадия, ОбъектПланирования, Ответственный");
					ЗаполнитьЗначенияСвойств(РеквизитыШапкиДокумента, ДокОст);
					
					ДокОст = Документы.ИзменениеАссортимента.СоздатьДокумент();
					ЗаполнитьЗначенияСвойств(ДокОст, РеквизитыШапкиДокумента);
					ДокОст.Комментарий = Комментарий_СформированСверткойБазы + " ["+КоличествоСформированныхДокументов+"]";
				КонецЕсли;
			КонецЦикла;
			Если ДокОст.Товары.Количество() > 0 Тогда
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	ВывестиСообщениеСформированыДокументы("ИзменениеАссортимента");

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковКвотыАссортимента()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.ТоварнаяКатегория КАК ТоварнаяКатегория,
	|ТабРег.ОбъектПланирования КАК ОбъектПланирования,
	|ТабРег.Марка КАК Марка,
	|ТабРег.Квота КАК Квота,
	|ТабРег.ПроцентОтклонения КАК ПроцентОтклонения,
	|&ДатаОст КАК ДатаНачалаДействия
	|ИЗ РегистрСведений.КвотыАссортимента.СрезПоследних(&ГраницаОст) КАК ТабРег
	|ИТОГИ ПО ОбъектПланирования";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	КоличествоСформированныхДокументов = 1;
	ВыборкаОбъектПланирования = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаОбъектПланирования.Следующий() Цикл
		ДокОст = Документы.УстановкаКвотАссортимента.СоздатьДокумент();
		ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаОбъектПланирования, Ложь);
		ДокОст.ДатаНачалаДействия = ДокОст.Дата;
		ВыборкаДетали = ВыборкаОбъектПланирования.Выбрать();
		Пока ВыборкаДетали.Следующий() Цикл
			НоваяСтрока = ДокОст.ТоварныеКатегории.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаДетали);
			Если ДокОст.ТоварныеКатегории.Количество() >= КоличествоСтрокВДокументеВводаОстатков Тогда
				//Запишем документ ввода остатков и создадим новый
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
				
				ДокОст = Документы.УстановкаКвотАссортимента.СоздатьДокумент();
				ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаОбъектПланирования, Ложь);
			КонецЕсли;
		КонецЦикла;
		Если ДокОст.ТоварныеКатегории.Количество() > 0 Тогда
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
		КонецЕсли;
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы("УстановкаКвотАссортимента");
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковЦеныНоменклатуры()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.ВидЦены КАК ВидЦены,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.Цена КАК Цена,
	|ТабРег.Упаковка КАК Упаковка
	|ИЗ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ГраницаОст) КАК ТабРег
	|ГДЕ ТабРег.Цена <> 0
	|ИТОГИ ПО ВидЦены";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	КоличествоСформированныхДокументов = 1;
	ВыборкаВидЦены = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаВидЦены.Следующий() Цикл
		ДокОст = Документы.УстановкаЦенНоменклатуры.СоздатьДокумент();
		ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаВидЦены, Ложь);
		ДокОст.Согласован = Истина;
		ДокОст.Статус = Перечисления.СтатусыУстановокЦенНоменклатуры.Согласован;
		
		СтрокаВидыЦен = ДокОст.ВидыЦен.Добавить();
		СтрокаВидыЦен.ВидЦены = ВыборкаВидЦены.ВидЦены;
		ВыборкаДетали = ВыборкаВидЦены.Выбрать();
		Пока ВыборкаДетали.Следующий() Цикл
			НоваяСтрока = ДокОст.Товары.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаДетали);
			Если ДокОст.Товары.Количество() >= КоличествоСтрокВДокументеВводаОстатков Тогда
				//Запишем документ ввода остатков и создадим новый
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
				
				ДокОст = Документы.УстановкаЦенНоменклатуры.СоздатьДокумент();
				ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаВидЦены, Ложь);
				ДокОст.Согласован = Истина;
				ДокОст.Статус = Перечисления.СтатусыУстановокЦенНоменклатуры.Согласован;

				СтрокаВидыЦен = ДокОст.ВидыЦен.Добавить();
				СтрокаВидыЦен.ВидЦены = ВыборкаВидЦены.ВидЦены;
			КонецЕсли;
		КонецЦикла;
		Если ДокОст.Товары.Количество() > 0 Тогда
			КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
		КонецЕсли;
		
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы("УстановкаЦенНоменклатуры");
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковЦеныНоменклатурыПоставщиков()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ТабРег.Номенклатура КАК Номенклатура,
	|	ТабРег.НоменклатураПоставщика КАК НоменклатураПоставщика,
	|	ТабРег.Характеристика КАК Характеристика,
	|	ТабРег.ВидЦеныПоставщика КАК ВидЦеныПоставщика,
	|	ТабРег.Партнер КАК Партнер,
	|	ТабРег.Цена КАК Цена,
	|	ТабРег.Упаковка КАК Упаковка
	|ИЗ РегистрСведений.ЦеныНоменклатурыПоставщиков.СрезПоследних(&ГраницаОст) КАК ТабРег
	|ИТОГИ ПО Партнер";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	КоличествоСформированныхДокументов = 1;
	ВыборкаПартнер = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаПартнер.Следующий() Цикл
		ДокОст = Документы.РегистрацияЦенНоменклатурыПоставщика.СоздатьДокумент();
		ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаПартнер, Ложь);
		ВыборкаДетали = ВыборкаПартнер.Выбрать();
		Пока ВыборкаДетали.Следующий() Цикл
			НоваяСтрока = ДокОст.Товары.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаДетали);
			Если ДокОст.Товары.Количество() >= КоличествоСтрокВДокументеВводаОстатков Тогда
				//Запишем документ ввода остатков и создадим новый
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
				
				ДокОст = Документы.РегистрацияЦенНоменклатурыПоставщика.СоздатьДокумент();
				ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаПартнер, Ложь);

			КонецЕсли;
		КонецЦикла;
		Если ДокОст.Товары.Количество() > 0 Тогда
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
		КонецЕсли;
		
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы("РегистрацияЦенНоменклатурыПоставщика");
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковДенежныеСредства(ВидДС)
	Запрос = Новый Запрос;
	ИмяДокумента = "ВводОстатковДенежныхСредств";
	Если ВидДС = "Безналичные" Тогда
		Запрос.Текст = "ВЫБРАТЬ 
		|ТабРег.Организация КАК Организация,
		|ТабРег.БанковскийСчет КАК БанковскийСчет,
		|ТабРег.СуммаОстаток КАК Сумма,
		|ТабРег.СуммаУпрОстаток КАК СуммаУпр,
		|ТабРег.СуммаРеглОстаток КАК СуммаРегл,
		|ТабРег.БанковскийСчет.ВалютаДенежныхСредств КАК Валюта,
		|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковНаБанковскихСчетах) КАК ХозяйственнаяОперация
		|ИЗ РегистрНакопления.ДенежныеСредстваБезналичные.Остатки(&ГраницаОст) КАК ТабРег
		|ГДЕ ТабРег.СуммаОстаток > 0 
		|ИТОГИ ПО ХозяйственнаяОперация, Организация";
		ИмяТЧ = "БанковскиеСчета";
		ДопИнформация = НСтр("ru='денежные средства на банковских счетах';uk='грошові кошти на банківських рахунках'");
	ИначеЕсли ВидДС = "ВКассахККМ" Тогда
		Запрос.Текст = "ВЫБРАТЬ 
		|ТабРег.Организация КАК Организация,
		|ТабРег.КассаККМ КАК КассаККМ,
		|ТабРег.СуммаОстаток КАК Сумма,
		|ТабРег.СуммаУпрОстаток КАК СуммаУпр,
		|ТабРег.СуммаРеглОстаток КАК СуммаРегл,
		|ТабРег.КассаККМ.ВалютаДенежныхСредств КАК Валюта,
		|ВЫБОР КОГДА ТабРег.СуммаОстаток > 0 Тогда
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковВАвтономныхКассахККМПоРозничнойВыручке)
		|ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковВАвтономныхКассахККМКОформлениюОтчетовОРозничныхПродажах) КОНЕЦ КАК ХозяйственнаяОперация
		|ИЗ РегистрНакопления.ДенежныеСредстваВКассахККМ.Остатки(&ГраницаОст) КАК ТабРег
		|ГДЕ ТабРег.СуммаОстаток <> 0
		|ИТОГИ ПО ХозяйственнаяОперация, Организация";
		ИмяТЧ = "КассыККМ";
		ДопИнформация = НСтр("ru='денежные средства в кассах ККМ';uk='грошові кошти в касах ККМ'");
	ИначеЕсли ВидДС = "Наличные" Тогда
		Запрос.Текст = "ВЫБРАТЬ 
		|ТабРег.Организация КАК Организация,
		|ТабРег.Касса КАК Касса,
		|ТабРег.СуммаОстаток КАК Сумма,
		|ТабРег.СуммаУпрОстаток КАК СуммаУпр,
		|ТабРег.СуммаРеглОстаток КАК СуммаРегл,
		|ТабРег.Касса.ВалютаДенежныхСредств КАК Валюта,
		|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковВКассах) КАК ХозяйственнаяОперация
		|ИЗ РегистрНакопления.ДенежныеСредстваНаличные.Остатки(&ГраницаОст) КАК ТабРег
		|ГДЕ ТабРег.СуммаОстаток > 0
		|ИТОГИ ПО ХозяйственнаяОперация, Организация";

		ИмяТЧ = "Кассы";
		ДопИнформация = НСтр("ru='денежные средства наличные';uk='готівка'");
	ИначеЕсли ВидДС = "УПодотчетныхЛиц" Тогда	
		Запрос.Текст = "ВЫБРАТЬ 
		|ТабРег.Организация КАК Организация,
		|ТабРег.ПодотчетноеЛицо КАК ПодотчетноеЛицо,
		|ТабРег.ЦельВыдачи КАК СтатьяДвиженияДенежныхСредств,
		|ТабРег.СуммаОстаток КАК Сумма,
		|ТабРег.СуммаУпрОстаток КАК СуммаУпр,
		|ТабРег.СуммаРеглОстаток КАК СуммаРегл,
		|ТабРег.Валюта КАК Валюта,
		|ВЫБОР КОГДА ТабРег.СуммаОстаток > 0 Тогда
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковЗадолженностиПодотчетников)
		|ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковПерерасходовПодотчетныхСредств) КОНЕЦ КАК ХозяйственнаяОперация
		|ИЗ РегистрНакопления.ДенежныеСредстваУПодотчетныхЛиц.Остатки(&ГраницаОст) КАК ТабРег
		|ГДЕ ТабРег.СуммаОстаток <> 0
		|ИТОГИ ПО ХозяйственнаяОперация, Организация";

		ИмяТЧ = "РасчетыСПодотчетниками";
		ДопИнформация = НСтр("ru='денежные средства у подотчетных лиц';uk='грошові кошти у підзвітних осіб'");
		ИмяДокумента = "ВводОстатковСПодотчетниками";

	Иначе
		Возврат;
	КонецЕсли;
	
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;

	КоличествоСформированныхДокументов = 1;
	ВыборкаТипОперации = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаТипОперации.Следующий() Цикл
		ВыборкаОрганизация = ВыборкаТипОперации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаОрганизация.Следующий() Цикл
			ДокОст = Документы[ИмяДокумента].СоздатьДокумент();
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаОрганизация);
			ВыборкаДетали = ВыборкаОрганизация.Выбрать();
			Пока ВыборкаДетали.Следующий() Цикл
				НоваяСтрока = ДокОст[ИмяТЧ].Добавить();
				
				ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаДетали);
				Если ВыборкаДетали.Сумма < 0 И (ВидДС = "ВКассахККМ" ИЛИ ВидДС = "УПодотчетныхЛиц") Тогда
					НоваяСтрока.Сумма = (-1)*ВыборкаДетали.Сумма;
					НоваяСтрока.СуммаРегл = (-1)*ВыборкаДетали.СуммаРегл;
				КонецЕсли;
				Если НоваяСтрока.СуммаРегл = 0 Тогда
					// Заполнение суммы регл из курсов валют.
					Если ВыборкаДетали.Валюта = ВалютаРегламентированногоУчета Тогда
						НоваяСтрока.СуммаРегл = НоваяСтрока.Сумма;
					Иначе
						КоэффициентПересчета = КурсыВалют.Получить(ВыборкаДетали.Валюта);
						Если КоэффициентПересчета = Неопределено Тогда
							КоэффициентПересчета = 
								РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(
															ВыборкаДетали.Валюта, 
															ВалютаРегламентированногоУчета, ДокОст.Дата);
							КурсыВалют.Вставить(ВыборкаДетали.ВалютаВзаиморасчетов, КоэффициентПересчета); 
						КонецЕсли;
						НоваяСтрока.СуммаРегл = Окр(НоваяСтрока.Сумма * КоэффициентПересчета, 2, 1);
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
		КонецЦикла;
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы(ИмяДокумента, ДопИнформация);
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковРасчеты(ВидРасчетов)
	Запрос = Новый Запрос;
	Если ВидРасчетов = "РасчетыСКлиентами" Тогда
			Запрос.Текст = "ВЫБРАТЬ 
			|ТабРег.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов КАК ОбъектРасчетов,
			|ТабРег.Валюта КАК ВалютаВзаиморасчетов,
			|Сумма(ЕстьNULL(ТабРег.СуммаОстаток,0)) КАК Сумма
			|ПОМЕСТИТЬ РасчетыСКлиентамиЗадолженность
			|ИЗ РегистрНакопления.РасчетыСКлиентами.Остатки(&ГраницаОст, АналитикаУчетаПоПартнерам.Партнер<>ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)) КАК ТабРег
			|ГДЕ ЕстьNULL(ТабРег.СуммаОстаток,0) > 0
			|СГРУППИРОВАТЬ ПО
			|ТабРег.АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов,
			|ТабРег.Валюта
			|;
			|//////////////////////////
			|ВЫБРАТЬ
			|ТабРег.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов КАК ОбъектРасчетов,
			|ТабРег.Валюта КАК ВалютаВзаиморасчетов,
			|(-1)*Сумма(ЕстьNULL(ТабРег.СуммаОстаток,0)) КАК Сумма
			|ПОМЕСТИТЬ РасчетыСКлиентамиАвансы
			|ИЗ РегистрНакопления.РасчетыСКлиентами.Остатки(&ГраницаОст, АналитикаУчетаПоПартнерам.Партнер<>ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)) КАК ТабРег
			|ГДЕ ЕстьNULL(ТабРег.СуммаОстаток,0) < 0
			|СГРУППИРОВАТЬ ПО
			|ТабРег.АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов,
			|ТабРег.Валюта
			|;
			|//////////////////////////
			|ВЫБРАТЬ
			|Свод.АналитикаУчетаПоПартнерам.Организация КАК Организация,
			|Свод.АналитикаУчетаПоПартнерам.Партнер КАК Партнер,
			|Свод.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|Свод.АналитикаУчетаПоПартнерам.Контрагент КАК Контрагент,
			|Свод.ОбъектРасчетов.Объект КАК ОбъектРасчетов,
			|Свод.ОбъектРасчетов КАК ОбъектРасчетовОтправитель,
			|Свод.ОбъектРасчетов.НомерВходящегоДокумента КАК НомерРасчетногоДокумента,
			|Свод.ОбъектРасчетов.ДатаВходящегоДокумента КАК ДатаРасчетногоДокумента,
			|Свод.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
			|Свод.Сумма КАК Сумма,
			|Свод.ДатаПлатежа КАК ДатаПлатежа,
			|Свод.ТипОперации КАК ХозяйственнаяОперация
			|ИЗ (
			|	ВЫБРАТЬ
			|	ТабРег.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|	ТабРег.ОбъектРасчетов КАК ОбъектРасчетов,
			|	ТабРег.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
			|	ТабРег.Сумма КАК Сумма,
			|	ТабРегОбороты.Период КАК ДатаПлатежа,
			|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковЗадолженностиКлиентов) КАК ТипОперации
			|	ИЗ РасчетыСКлиентамиЗадолженность КАК ТабРег
			|	ЛЕВОЕ СОЕДИНЕНИЕ
			| 		РегистрНакопления.РасчетыСКлиентами.Обороты(,&ГраницаОст,День, АналитикаУчетаПоПартнерам.Партнер<>ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)) КАК ТабРегОбороты
			|	ПО 	ТабРег.АналитикаУчетаПоПартнерам = ТабРегОбороты.АналитикаУчетаПоПартнерам  И
			| 		ТабРег.ОбъектРасчетов = ТабРегОбороты.ОбъектРасчетов  И
			| 		ТабРег.ВалютаВзаиморасчетов = ТабРегОбороты.Валюта И
			|		ТабРегОбороты.СуммаРасход > 0
			|ОБЪЕДИНИТЬ ВСЕ
			|	ВЫБРАТЬ
			|	ТабРег.АналитикаУчетаПоПартнерам,
			|	ТабРег.ОбъектРасчетов,
			|	ТабРег.ВалютаВзаиморасчетов,
			|	ТабРег.Сумма,
			|	null КАК ДатаПлатежа,
			|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковАвансовКлиентов) КАК ТипОперации
			|	ИЗ РасчетыСКлиентамиАвансы КАК ТабРег
			|	) КАК Свод
			|УПОРЯДОЧИТЬ ПО
			|Свод.ТипОперации, 
			|Свод.АналитикаУчетаПоПартнерам, Свод.ОбъектРасчетов, Свод.ДатаПлатежа УБЫВ
			|";
		ИначеЕсли ВидРасчетов = "РасчетыСПоставщиками" Тогда
			Запрос.Текст = "ВЫБРАТЬ 
			|ТабРег.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов КАК ОбъектРасчетов,
			|ТабРег.Валюта КАК ВалютаВзаиморасчетов,
			|(-1) * Сумма(ЕстьNULL(ТабРег.СуммаОстаток,0)) КАК Сумма
			|ПОМЕСТИТЬ РасчетыСПоставщикамиЗадолженность
			|ИЗ РегистрНакопления.РасчетыСПоставщиками.Остатки(&ГраницаОст,АналитикаУчетаПоПартнерам.Партнер<>ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)) КАК ТабРег
			|ГДЕ ЕстьNULL(ТабРег.СуммаОстаток,0) < 0
			|СГРУППИРОВАТЬ ПО
			|ТабРег.АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов,
			|ТабРег.Валюта
			|;
			|//////////////////////////
			|ВЫБРАТЬ
			|ТабРег.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов КАК ОбъектРасчетов,
			|ТабРег.Валюта КАК ВалютаВзаиморасчетов,
			|Сумма(ЕстьNULL(ТабРег.СуммаОстаток,0)) КАК Сумма
			|ПОМЕСТИТЬ РасчетыСПоставщикамиАвансы
			|ИЗ РегистрНакопления.РасчетыСПоставщиками.Остатки(&ГраницаОст,АналитикаУчетаПоПартнерам.Партнер<>ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)) КАК ТабРег
			|ГДЕ ЕстьNULL(ТабРег.СуммаОстаток,0) > 0
			|СГРУППИРОВАТЬ ПО
			|ТабРег.АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов,
			|ТабРег.Валюта
			|;
			|//////////////////////////
			|ВЫБРАТЬ
			|Свод.АналитикаУчетаПоПартнерам.Организация КАК Организация,
			|Свод.АналитикаУчетаПоПартнерам.Партнер КАК Партнер,
			|Свод.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|Свод.АналитикаУчетаПоПартнерам.Контрагент КАК Контрагент,
			|Свод.ОбъектРасчетов.Объект КАК ОбъектРасчетов,
			|Свод.ОбъектРасчетов КАК ОбъектРасчетовОтправитель,
			|Свод.ОбъектРасчетов.НомерВходящегоДокумента КАК НомерРасчетногоДокумента,
			|Свод.ОбъектРасчетов.ДатаВходящегоДокумента КАК ДатаРасчетногоДокумента, 
			|Свод.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
			|Свод.Сумма КАК Сумма,
			|Свод.ДатаПлатежа КАК ДатаПлатежа,
			|Свод.ТипОперации КАК ХозяйственнаяОперация
			|ИЗ
			|(ВЫБРАТЬ
			|	ТабРег.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|	ТабРег.ОбъектРасчетов КАК ОбъектРасчетов,
			|	ТабРег.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
			|	ТабРег.Сумма КАК Сумма,
			|	ТабРегОбороты.Период КАК ДатаПлатежа,
			|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковЗадолженностиПоставщикам) КАК ТипОперации
			|	ИЗ РасчетыСПоставщикамиЗадолженность КАК ТабРег
			|	ЛЕВОЕ СОЕДИНЕНИЕ 
			| 		РегистрНакопления.РасчетыСПоставщиками.Обороты(,&ГраницаОст,День,АналитикаУчетаПоПартнерам.Партнер<>ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)) КАК ТабРегОбороты
			|		ПО 	ТабРег.АналитикаУчетаПоПартнерам = ТабРегОбороты.АналитикаУчетаПоПартнерам  И
			| 		ТабРег.ОбъектРасчетов = ТабРегОбороты.ОбъектРасчетов  И
			| 		ТабРег.ВалютаВзаиморасчетов = ТабРегОбороты.Валюта И
			|		ТабРегОбороты.СуммаПриход > 0
			|	ОБЪЕДИНИТЬ ВСЕ
			//АВАНСЫ
			|	ВЫБРАТЬ
			|	ТабРег.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|	ТабРег.ОбъектРасчетов КАК ОбъектРасчетов,
			|	ТабРег.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
			|	ТабРег.Сумма КАК Сумма,
			|	null КАК ДатаПлатежа,
			|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковАвансовПоставщикам) КАК ТипОперации
			|	ИЗ РасчетыСПоставщикамиАвансы КАК ТабРег
			|) КАК Свод
			|УПОРЯДОЧИТЬ ПО
			|Свод.ТипОперации, 
			|Свод.АналитикаУчетаПоПартнерам.Организация, Свод.АналитикаУчетаПоПартнерам.Партнер, Свод.ОбъектРасчетов, Свод.ДатаПлатежа УБЫВ
			|";
		ИначеЕсли ВидРасчетов = "РасчетыМеждуОрганизациями" Тогда
			Запрос.Текст = "ВЫБРАТЬ 
			|ТабРег.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов КАК ОбъектРасчетов,
			|ТабРег.Валюта КАК ВалютаВзаиморасчетов,
			|Сумма(ЕстьNULL(ТабРег.СуммаОстаток,0)) КАК Сумма
			|ПОМЕСТИТЬ РасчетыСКлиентамиЗадолженность
			|ИЗ РегистрНакопления.РасчетыСКлиентами.Остатки(&ГраницаОст, АналитикаУчетаПоПартнерам.Партнер=ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)) КАК ТабРег
			|ГДЕ ЕстьNULL(ТабРег.СуммаОстаток,0) > 0
			|СГРУППИРОВАТЬ ПО
			|ТабРег.АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов,
			|ТабРег.Валюта
			|;
			|//////////////////////////
			|ВЫБРАТЬ
			|ТабРег.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов КАК ОбъектРасчетов,
			|ТабРег.Валюта КАК ВалютаВзаиморасчетов,
			|(-1)*Сумма(ЕстьNULL(ТабРег.СуммаОстаток,0)) КАК Сумма
			|ПОМЕСТИТЬ РасчетыСКлиентамиАвансы
			|ИЗ РегистрНакопления.РасчетыСКлиентами.Остатки(&ГраницаОст, АналитикаУчетаПоПартнерам.Партнер=ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)) КАК ТабРег
			|ГДЕ ЕстьNULL(ТабРег.СуммаОстаток,0) < 0
			|СГРУППИРОВАТЬ ПО
			|ТабРег.АналитикаУчетаПоПартнерам,
			|ТабРег.ОбъектРасчетов,
			|ТабРег.Валюта
			|;
			|//////////////////////////
			|ВЫБРАТЬ
			|Свод.АналитикаУчетаПоПартнерам.Организация КАК Организация,
			|Свод.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|Свод.АналитикаУчетаПоПартнерам.Контрагент КАК ОрганизацияПолучатель,
			|Свод.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
			|Свод.Сумма КАК Сумма,
			|Свод.ОбъектРасчетов.Объект КАК ОбъектРасчетов,
			|Свод.ОбъектРасчетов КАК ОбъектРасчетовОтправитель,
			|Свод.ОбъектРасчетов КАК ОбъектРасчетовПолучатель,
			|Свод.ОбъектРасчетов.НомерВходящегоДокумента КАК НомерРасчетногоДокумента,
			|Свод.ОбъектРасчетов.ДатаВходящегоДокумента КАК ДатаРасчетногоДокумента, 
			|Свод.ДатаПлатежа КАК ДатаПлатежа,
			|Свод.ТипОперации КАК ХозяйственнаяОперация
			|ИЗ (
			|	ВЫБРАТЬ
			|	ТабРег.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
			|	ТабРег.ОбъектРасчетов КАК ОбъектРасчетов,
			|	ТабРег.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
			|	ТабРег.Сумма КАК Сумма,
			|	ТабРегОбороты.Период КАК ДатаПлатежа,
			|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковРасчетовМеждуОрганизациямиПоРеализациям) КАК ТипОперации
			|	ИЗ РасчетыСКлиентамиЗадолженность КАК ТабРег
			|	ЛЕВОЕ СОЕДИНЕНИЕ
			|		РегистрНакопления.РасчетыСКлиентами.Обороты(,&ГраницаОст,День,АналитикаУчетаПоПартнерам.Партнер=ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)) КАК ТабРегОбороты
			|	ПО 	ТабРег.АналитикаУчетаПоПартнерам = ТабРегОбороты.АналитикаУчетаПоПартнерам  И
			| 		ТабРег.ОбъектРасчетов = ТабРегОбороты.ОбъектРасчетов  И
			| 		ТабРег.ВалютаВзаиморасчетов = ТабРегОбороты.Валюта И
			|		ТабРегОбороты.СуммаРасход > 0
			|ОБЪЕДИНИТЬ ВСЕ
			|	ВЫБРАТЬ
			|	ТабРег.АналитикаУчетаПоПартнерам,
			|	ТабРег.ОбъектРасчетов,
			|	ТабРег.ВалютаВзаиморасчетов,
			|	ТабРег.Сумма,
			|	null КАК ДатаПлатежа,
			|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковРасчетовМеждуОрганизациямиПоАвансам)КАК ТипОперации
			|	ИЗ РасчетыСКлиентамиАвансы КАК ТабРег
			|	) КАК Свод
			|УПОРЯДОЧИТЬ ПО
			|Свод.ТипОперации, 
			|Свод.АналитикаУчетаПоПартнерам.Контрагент, Свод.ОбъектРасчетов, Свод.ДатаПлатежа УБЫВ
			|";

		КонецЕсли;
		ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
		
		Результат = Запрос.Выполнить();
		Если Результат.Пустой() ТОгда
			Возврат;
		КонецЕсли;
		//Курсы валют на дату свертки
		КурсыВалют = Новый Соответствие;
		КоличествоСформированныхДокументов = 1; 
		Выборка = Результат.Выбрать();
		Пока Выборка.СледующийПоЗначениюПоля("ХозяйственнаяОперация") Цикл
			ИмяТабличнойЧасти = "РасчетыСПартнерами";
			ИмяГруппировкиПолучатель = "Партнер";
			Если ВидРасчетов = "РасчетыМеждуОрганизациями" Тогда
				ИмяТабличнойЧасти = "РасчетыМеждуОрганизациями";
				ИмяГруппировкиПолучатель = "ОрганизацияПолучатель";
			КонецЕсли;
			ИспользоватьДоговоры = Ложь;
			Если ВидРасчетов = "РасчетыМеждуОрганизациями" Тогда
				ИспользоватьДоговоры = Константы.ИспользоватьДоговорыМеждуОрганизациями.Получить();
			ИначеЕсли ВидРасчетов = "РасчетыСКлиентами" Тогда
				ИспользоватьДоговоры = Константы.ИспользоватьДоговорыСКлиентами.Получить();
			Иначе
				ИспользоватьДоговоры = Константы.ИспользоватьДоговорыСПоставщиками.Получить();
			КонецЕсли;
			Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
				Пока Выборка.СледующийПоЗначениюПоля(ИмяГруппировкиПолучатель) Цикл
					Если  ВидРасчетов = "РасчетыМеждуОрганизациями" Тогда
						ДокОст = Документы.ВводОстатков.СоздатьДокумент();
					Иначе
						ДокОст = Документы.ВводОстатковВзаиморасчетов.СоздатьДокумент();
					КонецЕсли;
					ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
					Если  ВидРасчетов = "РасчетыМеждуОрганизациями" И ЗначениеЗаполнено(ДокОст.Контрагент) И НЕ ЗначениеЗаполнено(ДокОст.Партнер) Тогда
						ДокОст.Партнер = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокОст.Контрагент, "Партнер");
					КонецЕсли; 

					// Сведения для счета фактуры на аванс.
					ДатаРасчетногоДокумента = Неопределено;
					НомерРасчетногоДокумента = Неопределено;
					ДатаПлатежа = Неопределено;
					Контрагент = Неопределено;
					Сумма = 0;
					Пока Выборка.СледующийПоЗначениюПоля("ОбъектРасчетов") Цикл
						НоваяСтрока = ДокОст[ИмяТабличнойЧасти].Добавить();
						ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
						Если Выборка.ВалютаВзаиморасчетов = ВалютаРегламентированногоУчета Тогда
							НоваяСтрока.СуммаРегл = НоваяСтрока.Сумма;
						Иначе
							КоэффициентПересчета = КурсыВалют.Получить(Выборка.ВалютаВзаиморасчетов);
							Если КоэффициентПересчета = Неопределено Тогда
								КоэффициентПересчета = 
									РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(
																Выборка.ВалютаВзаиморасчетов, 
																ВалютаРегламентированногоУчета, ДокОст.Дата);
								КурсыВалют.Вставить(Выборка.ВалютаВзаиморасчетов, КоэффициентПересчета); 
							КонецЕсли;
							
							НоваяСтрока.СуммаРегл = Окр(НоваяСтрока.Сумма * КоэффициентПересчета, 2, 1);
						КонецЕсли;
						Если Выборка.ВалютаВзаиморасчетов = ВалютаУправленческогоУчета Тогда
							НоваяСтрока.СуммаУпр = НоваяСтрока.Сумма;
						Иначе
							КоэффициентПересчета = РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(Выборка.ВалютаВзаиморасчетов, ВалютаУправленческогоУчета, ДокОст.Дата);
							НоваяСтрока.СуммаУпр = Окр(НоваяСтрока.Сумма * КоэффициентПересчета, 2, 1);
						КонецЕсли;
						Если НЕ ЗначениеЗаполнено(ДокОст.Валюта) Тогда
							ДокОст.Валюта = Выборка.ВалютаВзаиморасчетов;
						КонецЕсли;
						// Документ расчетов.
						Если ИмяТабличнойЧасти = "РасчетыСПартнерами" Тогда
							НоваяСтрока.ДокументРасчетов = СоздатьПервичныйДокументДляСтрокиРасчетов(ДокОст, Выборка.ОбъектРасчетов, НоваяСтрока);
						КонецЕсли;

						//Выборка по дате платежа, Датой платежа устанавливается самая поздняя из платежей
						Если Выборка.Следующий() И ЗначениеЗаполнено(Выборка.ДатаПлатежа) Тогда
							НоваяСтрока.ДатаПлатежа = Выборка.ДатаПлатежа;
						Иначе
							НоваяСтрока.ДатаПлатежа = ДокОст.Дата;
						КонецЕсли;
						Если ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковАвансовПоставщикам 
							Или ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковАвансовКлиентов Тогда
							Сумма = НоваяСтрока.СуммаРегл + Сумма;
							ДатаПлатежа = Выборка.ДатаПлатежа;
							ДатаРасчетногоДокумента = Выборка.ДатаРасчетногоДокумента;
							НомерРасчетногоДокумента = Выборка.НомерРасчетногоДокумента;
							Контрагент = Выборка.Контрагент;	
						КонецЕсли;

						Если ДокОст[ИмяТабличнойЧасти].Количество() >= КоличествоСтрокВДокументеВводаОстатков Тогда
							ДокОст.Записать(РежимЗаписиДокумента.Запись);
							
							Если  ВидРасчетов = "РасчетыМеждуОрганизациями" Тогда
								ДокОст = Документы.ВводОстатков.СоздатьДокумент();
							Иначе
								ДокОст = Документы.ВводОстатковВзаиморасчетов.СоздатьДокумент();
							КонецЕсли;
							КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
							ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
						КонецЕсли;
					КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("ОбъектРасчетов") Цикл
					Если ДокОст[ИмяТабличнойЧасти].Количество() > 0 Тогда
						ДокОст.Записать(РежимЗаписиДокумента.Запись);
						КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
					КонецЕсли;
				КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
			КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
			ВывестиСообщениеСформированыДокументы("ВводОстатковВзаиморасчетов", Выборка.ХозяйственнаяОперация);
		КонецЦикла;  //Пока Выборка.СледующийПоЗначениюПоля("ХозяйственнаяОперация") Цикл
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковРасчетыПоЭквайрингу()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|ТабРегРасчеты.ТипДенежныхСредств КАК ТипДенежныхСредств,
	|ТабРегРасчеты.Организация КАК Организация,
	|ТабРегРасчеты.Валюта КАК Валюта,
	|ТабРегРасчеты.ЭквайринговыйТерминал КАК ЭквайринговыйТерминал,
	|ТабРегРасчеты.НомерПлатежнойКарты КАК НомерПлатежнойКарты,
	|ТабРегРасчеты.ДатаПлатежа КАК ДатаПлатежа,
	|ТабРегРасчеты.СуммаОстаток КАК Сумма,
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковДенежныхСредствКПоступлениюОтЭквайера) КАК ХозяйственнаяОперация
	|ИЗ РегистрНакопления.РасчетыПоЭквайрингу.Остатки(&ГраницаОст) КАК ТабРегРасчеты
	|ГДЕ ТабРегРасчеты.СуммаОстаток > 0
	|УПОРЯДОЧИТЬ ПО
	|	ТабРегРасчеты.Организация";
	
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	КоличествоСформированныхДокументов = 1;

	Выборка = Результат.Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		ДокОст = Документы.ВводОстатковРасчетовПоЭквайрингу.СоздатьДокумент();
		ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);

		Пока Выборка.Следующий() Цикл
			НоваяСтрока = ДокОст.РасчетыПоЭквайрингу.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
			Если ДокОст.РасчетыПоЭквайрингу.Количество() >= КоличествоСтрокВДокументеВводаОстатков Тогда
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
				ДокОст = Документы.ВводОстатковРасчетовПоЭквайрингу.СоздатьДокумент();
				ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
			КонецЕсли;
		КонецЦикла;
		Если ДокОст.РасчетыПоЭквайрингу.Количество()>0 Тогда
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
		КонецЕсли;
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы("ВводОстатковРасчетовПоЭквайрингу", Перечисления.ХозяйственныеОперации.ВводОстатковДенежныхСредствКПоступлениюОтЭквайера);
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковРасчетыПоКредитамИДепозитам()
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|ТабРег.АналитикаУчетаПоПартнерам.Организация КАК Организация,
	|ТабРег.АналитикаУчетаПоПартнерам.Партнер КАК Партнер,
	|ТабРег.АналитикаУчетаПоПартнерам.Контрагент КАК Контрагент,
	|ТабРег.ТипСуммы КАК ТипСуммы,
	|ТабРег.Договор КАК Договор,
	|ТабРег.Договор.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|ТабРег.СуммаОстаток КАК Сумма,
	|ТабРег.СуммаРеглОстаток КАК СуммаРегл,
	|ТабРег.СуммаУпрОстаток КАК СуммаУпр,
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковПоДоговорамКредитовИДепозитов) КАК ХозяйственнаяОперация
	|ИЗ РегистрНакопления.РасчетыПоФинансовымИнструментам.Остатки(&ГраницаОст, Договор ССЫЛКА Справочник.ДоговорыКредитовИДепозитов) КАК ТабРег
	|УПОРЯДОЧИТЬ ПО
	|	Организация";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	КоличествоСформированныхДокументов = 1;
	
	Выборка = Результат.Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		ДокОст = Документы.ВводОстатковПоФинансовымИнструментам.СоздатьДокумент();
		ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);

		Пока Выборка.Следующий() Цикл
			НоваяСтрока = ДокОст.РасчетыПоФинансовымИнструментам.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
			// Суммы должны быть > 0 
			Если Выборка.Сумма < 0 Тогда
				НоваяСтрока.Сумма = (-1) * Выборка.Сумма;
			КонецЕсли;
			Если Выборка.СуммаРегл < 0 Тогда
				НоваяСтрока.СуммаРегл = (-1) * Выборка.СуммаРегл;
			КонецЕсли;
			Если Выборка.СуммаУпр < 0 Тогда
				НоваяСтрока.СуммаУпр = (-1) * Выборка.СуммаУпр;
			КонецЕсли;

			Если ДокОст.РасчетыПоФинансовымИнструментам.Количество() >= КоличествоСтрокВДокументеВводаОстатков Тогда
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
				ДокОст = Документы.ВводОстатковПоФинансовымИнструментам.СоздатьДокумент();
				ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
			КонецЕсли;
		КонецЦикла;
		Если ДокОст.РасчетыПоФинансовымИнструментам.Количество()>0 Тогда
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
		КонецЕсли;
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы("ВводОстатковПоФинансовымИнструментам", Перечисления.ХозяйственныеОперации.ВводОстатковПоДоговорамКредитовИДепозитов);

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковТоварыСобственные()
	МенеджерВТ = Новый МенеджерВременныхТаблиц;
	//Заполнение ключевых временных таблиц
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
	ДатаПереходаНаПартии22 = Константы.ДатаПереходаНаПартионныйУчетВерсии22.Получить();
	Если РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии22()
		И ДатаПереходаНаПартии22 < КонецДня(ДатаСверткиИБ) Тогда
		Запрос.Текст = "ВЫБРАТЬ 
		|ПартииПоСебестоимости.Организация,
		|ПартииПоСебестоимости.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|ПартииПоСебестоимости.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|ПартииПоСебестоимости.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
		|ПартииПоСебестоимости.ВидЗапасов.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
		|ПартииПоСебестоимости.АналитикаУчетаПартий.Поставщик КАК Партнер,
		|ПартииПоСебестоимости.АналитикаУчетаПартий.НалоговоеНазначение КАК НалоговоеНазначение,
		|ПартииПоСебестоимости.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|Сумма(ПартииПоСебестоимости.СтоимостьОстаток + ПартииПоСебестоимости.ДопРасходыОстаток
		//++ НЕ УТ
		|	+ ПартииПоСебестоимости.ТрудозатратыОстаток + ПартииПоСебестоимости.ПостатейныеПостоянныеСНДСОстаток
		|	+ ПартииПоСебестоимости.ПостатейныеПеременныеСНДСОстаток
		//-- НЕ УТ
		|		) КАК Сумма,
		|Сумма(ПартииПоСебестоимости.СтоимостьБезНДСОстаток + ПартииПоСебестоимости.ДопРасходыБезНДСОстаток
		//++ НЕ УТ
		|	+ ПартииПоСебестоимости.ТрудозатратыОстаток + ПартииПоСебестоимости.ПостатейныеПостоянныеБезНДСОстаток
		|	+ ПартииПоСебестоимости.ПостатейныеПеременныеБезНДСОстаток
		//-- НЕ УТ
		|		) КАК СуммаБезНДС,
		|Сумма(ПартииПоСебестоимости.СтоимостьОстаток + ПартииПоСебестоимости.ДопРасходыОстаток
		|	- ПартииПоСебестоимости.СтоимостьБезНДСОстаток - ПартииПоСебестоимости.ДопРасходыБезНДСОстаток
		//++ НЕ УТ
		|	+ ПартииПоСебестоимости.ПостатейныеПостоянныеСНДСОстаток + ПартииПоСебестоимости.ПостатейныеПеременныеСНДСОстаток
		|	- ПартииПоСебестоимости.ПостатейныеПостоянныеБезНДСОстаток - ПартииПоСебестоимости.ПостатейныеПеременныеБезНДСОстаток
		//-- НЕ УТ
		|	) КАК СуммаНДС,
		|0 КАК НДСРегл,
		|Сумма(ПартииПоСебестоимости.СтоимостьРеглОстаток + ПартииПоСебестоимости.ДопРасходыРеглОстаток
		//++ НЕ УТ
		|	+ ПартииПоСебестоимости.ТрудозатратыРеглОстаток + ПартииПоСебестоимости.ПостатейныеПостоянныеРеглОстаток
		|	+ ПартииПоСебестоимости.ПостатейныеПеременныеРеглОстаток
		//-- НЕ УТ
		|		) КАК СуммаРегл,
		|Сумма(ПартииПоСебестоимости.КоличествоОстаток) КАК Количество
		|
		|ПОМЕСТИТЬ ТаблицаОстатковПоПартиям
		
		|ИЗ РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаОст, РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|					И АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)) КАК ПартииПоСебестоимости
		|СГРУППИРОВАТЬ ПО ПартииПоСебестоимости.Организация, 
		|	ПартииПоСебестоимости.АналитикаУчетаНоменклатуры, 
		|	ПартииПоСебестоимости.ВидЗапасов.ГруппаФинансовогоУчета,
		|	ПартииПоСебестоимости.АналитикаУчетаПартий.НалоговоеНазначение, 
		|	ПартииПоСебестоимости.АналитикаУчетаПартий.СтавкаНДС, 
		|	ПартииПоСебестоимости.АналитикаУчетаПартий.Поставщик
		|";
	Иначе	
		Запрос.Текст = "ВЫБРАТЬ 
		|ПартииТоваровОрганизаций.Организация,
		|ПартииТоваровОрганизаций.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|ПартииТоваровОрганизаций.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|ПартииТоваровОрганизаций.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
		|ПартииТоваровОрганизаций.ВидЗапасов.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
		|ПартииТоваровОрганизаций.АналитикаУчетаПартий.Поставщик КАК Партнер,
		|ПартииТоваровОрганизаций.АналитикаУчетаПартий.НалоговоеНазначение КАК НалоговоеНазначение,
		|ПартииТоваровОрганизаций.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|Сумма(ПартииТоваровОрганизаций.СтоимостьОстаток + ЕстьNULL(ПартииРасходов.СтоимостьОстаток, 0)+ ЕстьNULL(ПартииЗатрат.СтоимостьОстаток, 0)) КАК Сумма,
		|Сумма(ПартииТоваровОрганизаций.СтоимостьБезНДСОстаток + ЕстьNULL(ПартииРасходов.СтоимостьБезНДСОстаток, 0)+ ЕстьNULL(ПартииЗатрат.СтоимостьБезНДСОстаток, 0))  КАК СуммаБезНДС,
		|Сумма(ПартииТоваровОрганизаций.СтоимостьОстаток + ЕстьNULL(ПартииРасходов.СтоимостьОстаток, 0) + ЕстьNULL(ПартииЗатрат.СтоимостьОстаток, 0)) -
		|Сумма(ПартииТоваровОрганизаций.СтоимостьБезНДСОстаток + ЕстьNULL(ПартииРасходов.СтоимостьБезНДСОстаток, 0) + ЕстьNULL(ПартииЗатрат.СтоимостьБезНДСОстаток, 0)) КАК СуммаНДС,
		|Сумма(ПартииТоваровОрганизаций.НДСРеглОстаток + ЕстьNULL(ПартииРасходов.НДСРеглОстаток, 0)+ ЕстьNULL(ПартииЗатрат.НДСРеглОстаток, 0)) КАК НДСРегл,
		|Сумма(ПартииТоваровОрганизаций.СтоимостьРеглОстаток + ЕстьNULL(ПартииРасходов.СтоимостьРеглОстаток, 0)+ ЕстьNULL(ПартииЗатрат.СтоимостьРеглОстаток, 0)) КАК СуммаРегл,
		|Сумма(ПартииТоваровОрганизаций.КоличествоОстаток) КАК Количество
		|
		|ПОМЕСТИТЬ ТаблицаОстатковПоПартиям
		
		|ИЗ РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&ГраницаОст, (ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
		|							И АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад))) КАК ПартииТоваровОрганизаций
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров.Остатки(&ГраницаОст) КАК ПартииРасходов
		|ПО ПартииРасходов.Организация = ПартииТоваровОрганизаций.Организация И
		|		ПартииРасходов.АналитикаУчетаНоменклатуры = ПартииТоваровОрганизаций.АналитикаУчетаНоменклатуры И
		|		ПартииРасходов.ВидЗапасов = ПартииТоваровОрганизаций.ВидЗапасов  И
		|		ПартииРАсходов.ДокументПоступления = ПартииТоваровОрганизаций.ДокументПоступления
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииЗатратНаВыпуск.Остатки(&ГраницаОст) КАК ПартииЗатрат
		|ПО ПартииЗатрат.Организация = ПартииТоваровОрганизаций.Организация И
		|		ПартииЗатрат.АналитикаУчетаПродукции = ПартииТоваровОрганизаций.АналитикаУчетаНоменклатуры И
		|		ПартииЗатрат.ДокументПоступления = ПартииТоваровОрганизаций.ДокументПоступления
		|СГРУППИРОВАТЬ ПО ПартииТоваровОрганизаций.Организация, 
		|	ПартииТоваровОрганизаций.АналитикаУчетаНоменклатуры, 
		|	ПартииТоваровОрганизаций.ВидЗапасов.ГруппаФинансовогоУчета,
		|	ПартииТоваровОрганизаций.АналитикаУчетаПартий.НалоговоеНазначение, 
		|	ПартииТоваровОрганизаций.АналитикаУчетаПартий.СтавкаНДС, 
		|	ПартииТоваровОрганизаций.АналитикаУчетаПартий.Поставщик
		|";
	КонецЕсли;
	Запрос.Текст = Запрос.Текст + ";
	|////////////////////////
	|ВЫБРАТЬ
	|ТабРег.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|ТабРег.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|ТабРег.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
	|ТабРег.Организация КАК Организация,  
	|ВЫБОР КОГДА ТабРегСебестоимость.НалоговоеНазначение IS NOT NULL ТОГДА 
	|	ТабРегСебестоимость.НалоговоеНазначение
	|ИНАЧЕ ТабРег.ВидЗапасов.НалоговоеНазначение КОНЕЦ КАК НалоговоеНазначение,
	|ТабРег.ВидЗапасов.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|ТабРег.НомерГТД КАК НомерГТД,
	|Сумма(ТабРег.КоличествоОстаток) КАК Количество,
	|Сумма(ЕстьNULL(ТабРегСебестоимость.СтоимостьОстаток, 0) + ЕстьNULL(ТабРегСебестоимость.ДопРасходыОстаток, 0)
	//++ НЕ УТ
	|	+ ЕстьNULL(ТабРегСебестоимость.ТрудозатратыОстаток, 0) + ЕстьNULL(ТабРегСебестоимость.ПостатейныеПостоянныеСНДСОстаток, 0)
	|	+ ЕстьNULL(ТабРегСебестоимость.ПостатейныеПеременныеСНДСОстаток, 0)
	//-- НЕ УТ
	|		) КАК Сумма,
	|Сумма(ЕстьNULL(ТабРегСебестоимость.СтоимостьБезНДСОстаток, 0) + ЕстьNULL(ТабРегСебестоимость.ДопРасходыБезНДСОстаток, 0)
	//++ НЕ УТ
	|	+ ЕстьNULL(ТабРегСебестоимость.ТрудозатратыОстаток, 0) + ЕстьNULL(ТабРегСебестоимость.ПостатейныеПостоянныеБезНДСОстаток, 0)
	|	+ ЕстьNULL(ТабРегСебестоимость.ПостатейныеПеременныеБезНДСОстаток, 0)
	//-- НЕ УТ
	|		) КАК СуммаБезНДС,
	|Сумма(ЕстьNULL(ТабРегСебестоимость.СтоимостьРеглОстаток, 0) + ЕстьNULL(ТабРегСебестоимость.ДопРасходыРеглОстаток, 0)
	//++ НЕ УТ
	|	+ ЕстьNULL(ТабРегСебестоимость.ТрудозатратыРеглОстаток, 0) + ЕстьNULL(ТабРегСебестоимость.ПостатейныеПостоянныеРеглОстаток, 0)
	|	+ ЕстьNULL(ТабРегСебестоимость.ПостатейныеПеременныеРеглОстаток, 0)
	//-- НЕ УТ
	|		) КАК СуммаРегл,
	|Сумма(ЕстьNULL(ТабРегСебестоимость.КоличествоОстаток, 0)) КАК Сумма_Количество,
	|Сумма(ЕстьNULL(ПринятаяТара.КоличествоОстаток, 0)) КАК КоличествоТара
	|
	|ПОМЕСТИТЬ ТаблицаОстатковТовары
	|
	|ИЗ РегистрНакопления.ТоварыОрганизаций.Остатки(&ГраницаОст,  
	|								ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|								И АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|												) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаОст, 
	|				РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	//++ НЕ УТ
	|				ИЛИ РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	//-- НЕ УТ
	|				) КАК ТабРегСебестоимость
	|ПО 
	|	ТабРег.Организация = ТабРегСебестоимость.Организация  И
	|	(ТабРег.ВидЗапасов = ТабРегСебестоимость.ВидЗапасов)  И
	|	ТабРег.АналитикаУчетаНоменклатуры = ТабРегСебестоимость.АналитикаУчетаНоменклатуры
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПринятаяВозвратнаяТара.Остатки(&ГраницаОст) КАК ПринятаяТара
	|	ПО ПринятаяТара.Номенклатура = ТабРег.АналитикаУчетаНоменклатуры.Номенклатура 
	|	И ПринятаяТара.Характеристика = ТабРег.АналитикаУчетаНоменклатуры.Характеристика
	|ГДЕ ТабРег.КоличествоОстаток > 0 И ЕстьNULL(ПринятаяТара.КоличествоОстаток, 0) = 0
	|СГРУППИРОВАТЬ ПО ТабРег.Организация, 
	|	ТабРег.АналитикаУчетаНоменклатуры, 
	|	ТабРег.ВидЗапасов.ГруппаФинансовогоУчета,  
	|ВЫБОР КОГДА ТабРегСебестоимость.НалоговоеНазначение IS NOT NULL ТОГДА 
	|	ТабРегСебестоимость.НалоговоеНазначение
	|ИНАЧЕ ТабРег.ВидЗапасов.НалоговоеНазначение КОНЕЦ,
	|	ТабРег.НомерГТД
	|;
	|////////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.Склад КАК Склад,
	|ТабРег.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|ТабРег.Организация КАК Организация,
	|ТабРег.НомерГТД КАК НомерГТД,
	|Сумма(ТабРег.Количество) КАК Количество,
	|Сумма(ТабРег.Сумма) КАК Сумма,
	|Сумма(ТабРег.СуммаБезНДС) КАК СуммаБезНДС,
	|Сумма(ТабРег.СуммаРегл) КАК СуммаРегл,
	|Сумма(ТабРег.Сумма_Количество) КАК Сумма_Количество,
	|Сумма(ТабРег.КоличествоТара) КАК КоличествоТара
	|
	|ПОМЕСТИТЬ ТаблицаОстатковТоварыСвод
	|
	|ИЗ ТаблицаОстатковТовары КАК ТабРег 
	|СГРУППИРОВАТЬ ПО 
	|	ТабРег.Номенклатура,
	|	ТабРег.Характеристика,
	|	ТабРег.Склад,
	|	ТабРег.ГруппаФинансовогоУчета,
	|	ТабРег.Организация,
	|	ТабРег.НомерГТД
	|;
	|////////////////////////////////////////////////////////////////////////////////////////////////
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Запрос.Выполнить();
	//1. Остатки - на основе регистра партий
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВТ;

	Запрос.Текст = "ВЫБРАТЬ
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.Склад КАК Склад,
	|ТабРег.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|ТабРег.Организация КАК Организация,
	|Сумма(ТабРег.Количество) КАК Количество,
	|Сумма(ТабРег.Сумма) КАК Сумма,
	|Сумма(ТабРег.СуммаБезНДС) КАК СуммаБезНДС,
	|Сумма(ТабРег.СуммаРегл) КАК СуммаРегл,
	|Сумма(ТабРег.Сумма_Количество) КАК Сумма_Количество,
	|Сумма(ТабРег.КоличествоТара) КАК КоличествоТара
	|
	|ПОМЕСТИТЬ ТаблицаОстатковТоварыСводБезГТД
	|
	|ИЗ ТаблицаОстатковТоварыСвод КАК ТабРег 
	|СГРУППИРОВАТЬ ПО 
	|	ТабРег.Номенклатура,
	|	ТабРег.Характеристика,
	|	ТабРег.Склад,
	|	ТабРег.ГруппаФинансовогоУчета,
	|	ТабРег.Организация
	|;
	|////////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|ТаблицаОстатковПоПартиям.Организация КАК Организация,
	|ТаблицаОстатковПоПартиям.Склад КАК Склад,
	|ТаблицаОстатковПоПартиям.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|ТаблицаОстатковПоПартиям.Партнер КАК Партнер,
	|ТаблицаОстатковПоПартиям.Номенклатура КАК Номенклатура,
	|ТаблицаОстатковПоПартиям.Характеристика КАК Характеристика,
	|ТаблицаОстатковПоПартиям.НалоговоеНазначение КАК НалоговоеНазначение,
	|ТаблицаОстатковПоПартиям.СтавкаНДС КАК СтавкаНДС,
	|ТаблицаОстатковПоПартиям.Количество КАК Количество,
	|ЕстьNULL(ТаблицаОстатковТоварыСводБезГТД.Количество,0) КАК КоличествоМаксимум,
	|ТаблицаОстатковПоПартиям.Сумма КАК Сумма,
	|ТаблицаОстатковПоПартиям.СуммаБезНДС КАК СуммаБезНДС,
	|ТаблицаОстатковПоПартиям.СуммаНДС КАК СуммаНДС,
	|ТаблицаОстатковПоПартиям.НДСРегл КАК НДСРегл,
	|ТаблицаОстатковПоПартиям.СуммаРегл КАК СуммаРегл
	|ПОМЕСТИТЬ ТоварыЕстьКорректныеОстаткиПоПартиям
	|ИЗ ТаблицаОстатковПоПартиям
	|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаОстатковТоварыСводБезГТД
	|ПО ТаблицаОстатковТоварыСводБезГТД.Организация = ТаблицаОстатковПоПартиям.Организация
	|	И  ТаблицаОстатковТоварыСводБезГТД.Склад = ТаблицаОстатковПоПартиям.Склад
	|	И  (ТаблицаОстатковТоварыСводБезГТД.ГруппаФинансовогоУчета = ТаблицаОстатковПоПартиям.ГруппаФинансовогоУчета)
	|	И  ТаблицаОстатковТоварыСводБезГТД.Номенклатура = ТаблицаОстатковПоПартиям.Номенклатура
	|	И  ТаблицаОстатковТоварыСводБезГТД.Характеристика = ТаблицаОстатковПоПартиям.Характеристика
	|ГДЕ ТаблицаОстатковПоПартиям.Количество > 0 
	|	И ЕстьNULL(ТаблицаОстатковТоварыСводБезГТД.Количество,0) > 0
	|;
	|////////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|ТаблицаТовары.Организация КАК Организация,
	|ТаблицаТовары.Склад КАК Склад,
	|ТаблицаТовары.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|ТаблицаТовары.Партнер КАК Партнер,
	|ТаблицаТовары.Номенклатура КАК Номенклатура,
	|ТаблицаТовары.Характеристика КАК Характеристика,
	|ТаблицаТовары.НалоговоеНазначение КАК НалоговоеНазначение,
	|ТаблицаТовары.СтавкаНДС КАК СтавкаНДС,
	|ТаблицаТовары.Количество КАК Количество,
	|ТаблицаТовары.КоличествоМаксимум КАК КоличествоМаксимум,
	|ТаблицаТовары.Сумма КАК Сумма,
	|ТаблицаТовары.СуммаБезНДС КАК СуммаБезНДС,
	|ТаблицаТовары.СуммаНДС КАК СуммаНДС,
	|ТаблицаТовары.НДСРегл КАК НДСРегл,
	|ТаблицаТовары.СуммаРегл КАК СуммаРегл,
	|ЕстьNULL(ТаблицаТовары.Склад.ИспользоватьСкладскиеПомещения, ЛОЖЬ) КАК ИспользоватьСкладскиеПомещения,
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковСобственныхТоваров) КАК ХозяйственнаяОперация
	|ИЗ ТоварыЕстьКорректныеОстаткиПоПартиям КАК ТаблицаТовары
	|УПОРЯДОЧИТЬ ПО 
	|	ТаблицаТовары.Организация,
	|	ТаблицаТовары.Склад,
	|	ТаблицаТовары.НалоговоеНазначение,
	|	ТаблицаТовары.Партнер
	|;
	|////////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.Склад КАК Склад,
	|ТабРег.Организация КАК Организация,
	|ТабРег.НомерГТД КАК НомерГТД,
	|Сумма(ТабРег.Количество) КАК Количество
	|ИЗ ТаблицаОстатковТоварыСвод КАК ТабРег
	|ГДЕ ТабРег.НомерГТД <> ЗНАЧЕНИЕ(Справочник.НоменклатураГТД.ПустаяСсылка)
	|СГРУППИРОВАТЬ ПО 
	|	ТабРег.Номенклатура,
	|	ТабРег.Характеристика,
	|	ТабРег.Склад,
	|	ТабРег.Организация,
	|	ТабРег.НомерГТД
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	КоличествоСформированныхДокументов = 1;
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	ТаблицаОстатковПоГТД = РезультатЗапроса[3].Выгрузить();
	Выборка = РезультатЗапроса[2].Выбрать();
	ОбработатьРезультатЗапросаСобственныеТовары(Выборка, КоличествоСформированныхДокументов, Истина, ТаблицаОстатковПоГТД);
	
	//2. Остатки без партий - на основе регистра ТоварыОрганизаций
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
	Запрос.Текст = "ВЫБРАТЬ
	|	ТаблицаОстатковСвод.Организация КАК Организация,
	|	ТаблицаОстатковСвод.Склад КАК Склад,
	|	ТаблицаОстатковСвод.Номенклатура КАК Номенклатура,
	|	ТаблицаОстатковСвод.Характеристика КАК Характеристика,
	|	Сумма(ТаблицаОстатковСвод.Количество) КАК Количество
	|ПОМЕСТИТЬ ТоварыБезПартий
	|ИЗ
	|(ВЫБРАТЬ
	|	ТоварыЕстьКорректныеОстаткиПоПартиям.Организация КАК Организация,
	|	ТоварыЕстьКорректныеОстаткиПоПартиям.Склад КАК Склад,
	|	ТоварыЕстьКорректныеОстаткиПоПартиям.Номенклатура КАК Номенклатура,
	|	ТоварыЕстьКорректныеОстаткиПоПартиям.Характеристика КАК Характеристика,
	|	ВЫБОР КОГДА ТоварыЕстьКорректныеОстаткиПоПартиям.Количество < ТоварыЕстьКорректныеОстаткиПоПартиям.КоличествоМаксимум ТОГДА
	|		(-1) * ТоварыЕстьКорректныеОстаткиПоПартиям.Количество
	|	ИНАЧЕ (-1) * ТоварыЕстьКорректныеОстаткиПоПартиям.КоличествоМаксимум
	|	КОНЕЦ КАК Количество
	|	ИЗ ТоварыЕстьКорректныеОстаткиПоПартиям
	|	ОБЪЕДИНИТЬ ВСЕ
	|	ВЫБРАТЬ
	|	ТаблицаОстатковТоварыСводБезГТД.Организация КАК Организация,
	|	ТаблицаОстатковТоварыСводБезГТД.Склад КАК Склад,
	|	ТаблицаОстатковТоварыСводБезГТД.Номенклатура КАК Номенклатура,
	|	ТаблицаОстатковТоварыСводБезГТД.Характеристика КАК Характеристика,
	|	ТаблицаОстатковТоварыСводБезГТД.Количество КАК Количество
	|	ИЗ ТаблицаОстатковТоварыСводБезГТД) КАК ТаблицаОстатковСвод
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаОстатковСвод.Организация,
	|	ТаблицаОстатковСвод.Склад,
	|	ТаблицаОстатковСвод.Номенклатура,
	|	ТаблицаОстатковСвод.Характеристика
	|;
	|ВЫБРАТЬ
	|	Организация, 
	|	Склад, 
	|	Номенклатура, 
	|	Характеристика,
	|	ГруппаФинансовогоУчета,       
	|	МАКСИМУМ(НалоговоеНазначение) КАК НалоговоеНазначение,
	|	МАКСИМУМ(Партнер) КАК Партнер,
	|	МАКСИМУМ(СтавкаНДС) КАК СтавкаНДС,
	|	Сумма(Сумма) КАК Сумма,
	|	Сумма(СуммаБезНДС) КАК СуммаБезНДС,
	|	Сумма(СуммаНДС) КАК СуммаНДС,
	|	Сумма(НДСРегл) КАК НДСРегл,
	|	Сумма(СуммаРегл) КАК СуммаРегл,
	|	Сумма(Количество) КАК Количество
	|ПОМЕСТИТЬ ТаблицаОстатковПоПартиямСвернутая
	|ИЗ ТаблицаОстатковПоПартиям                                
	|ГДЕ 
	|	(Организация, Склад, Номенклатура, Характеристика) В (ВЫБРАТЬ Организация, Склад, Номенклатура, Характеристика ИЗ ТоварыБезПартий)
	|СГРУППИРОВАТЬ ПО Организация, Склад, Номенклатура, Характеристика, ГруппаФинансовогоУчета
	|;
	|ВЫБРАТЬ                
	|ТоварыБезПартий.Организация КАК Организация,
	|ТоварыБезПартий.Склад КАК Склад,
	|ВЫБОР КОГДА ТаблицаОстатковТовары.ГруппаФинансовогоУчета ЕСТЬ NULL
	|		ИЛИ ТаблицаОстатковТовары.ГруппаФинансовогоУчета = ЗНАЧЕНИЕ(Справочник.ГруппыФинансовогоУчетаНоменклатуры.ПустаяСсылка) ТОГДА
	|		ТаблицаОстатковПоПартиямСвернутая.ГруппаФинансовогоУчета ИНАЧЕ ТаблицаОстатковТовары.ГруппаФинансовогоУчета
	|КОНЕЦ КАК ГруппаФинансовогоУчета,
	|ТаблицаОстатковПоПартиямСвернутая.Партнер КАК Партнер,
	
	|ТоварыБезПартий.Номенклатура КАК Номенклатура,
	|ТоварыБезПартий.Характеристика КАК Характеристика,
	|ВЫБОР КОГДА 
	|		ТаблицаОстатковТовары.НалоговоеНазначение ЕСТЬ NULL ТОГДА
	|		ТаблицаОстатковПоПартиямСвернутая.НалоговоеНазначение ИНАЧЕ ТаблицаОстатковТовары.НалоговоеНазначение
	|	КОНЕЦ	КАК НалоговоеНазначение,
	|ТаблицаОстатковПоПартиямСвернутая.СтавкаНДС КАК СтавкаНДС,
	|ЕстьNULL(ТоварыБезПартий.Склад.ИспользоватьСкладскиеПомещения, ЛОЖЬ) КАК ИспользоватьСкладскиеПомещения,

	|ТоварыБезПартий.Количество КАК Количество,
	|ТаблицаОстатковТоварыСвод.Сумма КАК Себестоимость_Стоимость,
	|ТаблицаОстатковТоварыСвод.СуммаБезНДС КАК Себестоимость_СтоимостьБезНДС,
	|ТаблицаОстатковТоварыСвод.СуммаРегл КАК Себестоимость_СтоимостьРегл,
	|ТаблицаОстатковТоварыСвод.Сумма_Количество КАК Себестоимость_Количество,
	
	|ЕстьNULL(ТаблицаОстатковПоПартиямСвернутая.Сумма,0) КАК Сумма,
	|ЕстьNULL(ТаблицаОстатковПоПартиямСвернутая.СуммаБезНДС,0) КАК СуммаБезНДС,
	|ЕстьNULL(ТаблицаОстатковПоПартиямСвернутая.СуммаНДС,0) КАК СуммаНДС,
	|ЕстьNULL(ТаблицаОстатковПоПартиямСвернутая.НДСРегл,0) КАК НДСРегл,
	|ЕстьNULL(ТаблицаОстатковПоПартиямСвернутая.СуммаРегл,0) КАК СуммаРегл,
	|ЕстьNULL(ТаблицаОстатковПоПартиямСвернутая.Количество,0) КАК Партии_Количество,
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковСобственныхТоваров) КАК ХозяйственнаяОперация
	
	|ИЗ ТоварыБезПартий
	|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаОстатковТоварыСводБезГТД КАК ТаблицаОстатковТоварыСвод
	|ПО ТаблицаОстатковТоварыСвод.Организация = ТоварыБезПартий.Организация
	|	И  ТаблицаОстатковТоварыСвод.Склад = ТоварыБезПартий.Склад
	|	И  ТаблицаОстатковТоварыСвод.Номенклатура = ТоварыБезПартий.Номенклатура
	|	И  ТаблицаОстатковТоварыСвод.Характеристика = ТоварыБезПартий.Характеристика
	|
	|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаОстатковТовары                    
	|ПО ТаблицаОстатковТовары.Организация = ТоварыБезПартий.Организация
	|	И  ТаблицаОстатковТовары.Склад = ТоварыБезПартий.Склад
	|	И  ТаблицаОстатковТовары.Номенклатура = ТоварыБезПартий.Номенклатура
	|	И  ТаблицаОстатковТовары.Характеристика = ТоварыБезПартий.Характеристика
	|	И  ТаблицаОстатковТовары.НалоговоеНазначение <> ЗНАЧЕНИЕ(Справочник.НалоговыеНазначенияАктивовИЗатрат.ПустаяСсылка)
	|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаОстатковПоПартиямСвернутая        
	|ПО ТоварыБезПартий.Организация = ТаблицаОстатковПоПартиямСвернутая.Организация
	|	И  ТоварыБезПартий.Склад = ТаблицаОстатковПоПартиямСвернутая.Склад
	|	И  ТоварыБезПартий.Номенклатура = ТаблицаОстатковПоПартиямСвернутая.Номенклатура
	|	И  ТоварыБезПартий.Характеристика = ТаблицаОстатковПоПартиямСвернутая.Характеристика
	|ГДЕ ТоварыБезПартий.Количество > 0
	|УПОРЯДОЧИТЬ ПО      
	|	ТоварыБезПартий.Организация,
	|	ТоварыБезПартий.Склад,
	|	ТаблицаОстатковПоПартиямСвернутая.Партнер,
	|	ВЫБОР КОГДА 
	|		ТаблицаОстатковТовары.НалоговоеНазначение Is null ТОГДА
	|		ТаблицаОстатковПоПартиямСвернутая.НалоговоеНазначение ИНАЧЕ ТаблицаОстатковТовары.НалоговоеНазначение
	|	КОНЕЦ
	|	";
	
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Выборка = Запрос.Выполнить().Выбрать();
	ОбработатьРезультатЗапросаСобственныеТовары(Выборка, КоличествоСформированныхДокументов, Ложь, ТаблицаОстатковПоГТД);

	ВывестиСообщениеСформированыДокументы("ВводОстатковТоваров", Перечисления.ХозяйственныеОперации.ВводОстатковСобственныхТоваров);
	МенеджерВТ = Неопределено;
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковТоварыКомиссионные()
	//1. Товары принятые на комиссию
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|ТабРег.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|ТабРег.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
	|ТабРег.Организация КАК Организация,
	|ТабРег.НомерГТД КАК НомерГТД,
	|ТабРег.ВидЗапасов.Контрагент.Партнер КАК Партнер,
	|ТабРег.ВидЗапасов.Контрагент КАК Контрагент,
	|ТабРег.ВидЗапасов.ВладелецТовара КАК Комитент,
	|ТабРег.ВидЗапасов.Соглашение КАК СоглашениеСКомитентом,
	|ТабРег.ВидЗапасов.Валюта КАК Валюта,
	|ТабРег.ВидЗапасов.Договор КАК Договор,
	|ВЫБОР КОГДА ТабСтоимость.НалоговоеНазначение IS NOT NULL ТОГДА 
	|	ТабСтоимость.НалоговоеНазначение
	|ИНАЧЕ ТабРег.ВидЗапасов.НалоговоеНазначение КОНЕЦ КАК НалоговоеНазначение,
	|ЕстьNULL(ТабРег.АналитикаУчетаНоменклатуры.МестоХранения.ИспользоватьСкладскиеПомещения, ЛОЖЬ) КАК ИспользоватьСкладскиеПомещения,
	|Сумма(ТабРег.КоличествоОстаток) КАК Количество,
	|Сумма(ЕстьNULL(ТабСтоимость.СтоимостьЗабалансоваяОстаток, 0)) КАК Сумма,
	|Сумма(ЕстьNULL(ТабСтоимость.СтоимостьЗабалансоваяОстаток, 0)) КАК СуммаБезНДС,
	|Сумма(ЕстьNULL(ТабСтоимость.СтоимостьЗабалансоваяРеглОстаток, 0)) КАК СуммаРегл,
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковТоваровПолученныхНаКомиссию) КАК ХозяйственнаяОперация
	
	|ИЗ РегистрНакопления.ТоварыОрганизаций.Остатки(&ГраницаОст, 
	|								ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|								И АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаОст, 
	|								РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию) ) КАК ТабСтоимость
	|ПО  ТабРег.АналитикаУчетаНоменклатуры = ТабСтоимость.АналитикаУчетаНоменклатуры
	|	И ТабРег.Организация = ТабСтоимость.Организация
	|	И (ТабРег.ВидЗапасов = ТабСтоимость.ВидЗапасов)
	|СГРУППИРОВАТЬ ПО
	|ТабРег.АналитикаУчетаНоменклатуры,
	|ТабРег.Организация ,
	|ТабРег.НомерГТД ,
	|ТабРег.ВидЗапасов.Контрагент.Партнер ,
	|ТабРег.ВидЗапасов.Контрагент ,
	|ТабРег.ВидЗапасов.ВладелецТовара ,
	|ТабРег.ВидЗапасов.Соглашение ,
	|ТабРег.ВидЗапасов.Валюта ,
	|ТабРег.ВидЗапасов.Договор ,
	|ЕстьNULL(ТабРег.АналитикаУчетаНоменклатуры.МестоХранения.ИспользоватьСкладскиеПомещения, ЛОЖЬ),
	|ВЫБОР КОГДА ТабСтоимость.НалоговоеНазначение IS NOT NULL ТОГДА 
	|	ТабСтоимость.НалоговоеНазначение
	|ИНАЧЕ ТабРег.ВидЗапасов.НалоговоеНазначение КОНЕЦ
	|ИМЕЮЩИЕ Сумма(ТабРег.КоличествоОстаток) > 0 
	|УПОРЯДОЧИТЬ ПО Организация, Склад, Партнер, Комитент, НалоговоеНазначение";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	КоличествоСформированныхДокументов = 1;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("Комитент") Цикл
					Пока Выборка.СледующийПоЗначениюПоля("НалоговоеНазначение") Цикл
						ДокОст = Документы.ВводОстатковТоваров.СоздатьДокумент();
						ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
						ДокОст.ОтражатьСебестоимость = Истина;
						Если НЕ ЗначениеЗаполнено(ДокОст.НалоговоеНазначение) Тогда
							ДокОст.НалоговоеНазначение = Справочники.НалоговыеНазначенияАктивовИЗатрат.НДС_Облагаемая;
						КонецЕсли;
						Если НЕ ЗначениеЗаполнено(ДокОст.Партнер) Тогда
							ДокОст.Партнер = Выборка.Комитент;
							ПартнерыИКонтрагенты.ЗаполнитьКонтрагентаПартнераПоУмолчанию(ДокОст.Партнер, ДокОст.Контрагент);
						КонецЕсли;
						ДокОст.ЦенаВключаетНДС = Истина;
						СоответствиеДокументовПоПомещениям = Новый Соответствие();
						Пока Выборка.Следующий() Цикл
							ВыбранныеВариантыПомещений = Новый Массив;

							//Определим помещение
							Если Выборка.ИспользоватьСкладскиеПомещения Тогда
								ПодобратьПодходящиеПомещения(Выборка, ВыбранныеВариантыПомещений, Выборка.Количество);
							КонецЕсли; //Если Выборка.ИспользоватьСкладскиеПомещения Тогда
							
							Если НЕ Выборка.ИспользоватьСкладскиеПомещения ИЛИ ВыбранныеВариантыПомещений.Количество() = 0 Тогда
								ИспользоватьАдресноеХранение = СкладыСервер.ИспользоватьАдресноеХранение(ДокОст.Склад, ДокОст.Помещение, ДокОст.Дата, Истина);

								Если ИспользоватьАдресноеХранение И НЕ ЗначениеЗаполнено(ДокОст.ЗонаПриемки) Тогда
									ДокОст.ЗонаПриемки = ПолучитьЯчейкуЗонаПриемки(ДокОст.Склад, ДокОст.Помещение);
								КонецЕсли;

								НоваяСтрока = ДокОст.Товары.Добавить();
								ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
								ЗаполнитьДанныеПоУпаковкам(НоваяСтрока);
								НоваяСтрока.СтавкаНДС = Перечисления.СтавкиНДС.БезНДС;
							Иначе
								КоличествоРаспределить = Выборка.Количество;
								Цена = Выборка.Сумма / Выборка.Количество;
								ЦенаРегл = Выборка.СуммаРегл / Выборка.Количество;

								Для Каждого СтрокаПомещение ИЗ ВыбранныеВариантыПомещений Цикл
									ТекПомещение = СтрокаПомещение.Помещение;
									НайтиСоздатьДокументОстатковПоПомещению(Выборка, ТекПомещение, ДокОст, СоответствиеДокументовПоПомещениям, КоличествоСформированныхДокументов);
									
									НоваяСтрока = ДокОст.Товары.Добавить();
									ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
									НоваяСтрока.СтавкаНДС = Перечисления.СтавкиНДС.БезНДС;

									//Пересчитаем суммы и количества в соответствии с остатком по помещению
									КоличествоПоПомещению = Мин(КоличествоРаспределить, СтрокаПомещение.Количество);
									СтрокаПомещение.Количество = СтрокаПомещение.Количество - КоличествоПоПомещению;
									КоэффициентПересчета = 1;
									Если КоличествоПоПомещению <> НоваяСтрока.Количество Тогда
										КоэффициентПересчета = КоличествоПоПомещению / Выборка.Количество;
										НоваяСтрока.Количество = КоличествоПоПомещению;
									КонецЕсли;
									//Заполним связанные данные
									ЗаполнитьДанныеПоУпаковкам(НоваяСтрока);
									НоваяСтрока.Сумма = Окр(НоваяСтрока.Количество * Цена,2);
									НоваяСтрока.СуммаРегл = Окр(НоваяСтрока.Количество * ЦенаРегл,2);
									КоличествоРаспределить = КоличествоРаспределить - НоваяСтрока.Количество;
									Если КоличествоРаспределить <=0 Тогда
										Прервать;
									КонецЕсли;
								КонецЦикла; //Для Каждого СтрокаПомещение ИЗ ВыбранныеВариантыПомещений Цикл
								Если КоличествоРаспределить > 0 Тогда
									//не все распределилось по помещениям
									//Возможно, это товары к поступлению по ордерной схеме
									//Попытка определить помещение
									//Если не нашлось - будет пустое помещение
									ТекПомещение = ПроверитьПоступлениеПоОрдеру(Выборка, КоличествоРаспределить);
									НайтиСоздатьДокументОстатковПоПомещению(Выборка, ТекПомещение, ДокОст, СоответствиеДокументовПоПомещениям, КоличествоСформированныхДокументов);
									НоваяСтрока = ДокОст.Товары.Добавить();
									ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
									НоваяСтрока.Количество = КоличествоРаспределить;
									ЗаполнитьДанныеПоУпаковкам(НоваяСтрока);
									НоваяСтрока.Сумма = Окр(НоваяСтрока.Количество * Цена,2);
									НоваяСтрока.СуммаРегл = Окр(НоваяСтрока.Количество * ЦенаРегл,2);
								КонецЕсли;
							КонецЕсли;
						КонецЦикла;  //Пока Выборка.Следующий() Цикл
						ДокОст.Записать(РежимЗаписиДокумента.Запись);
						СоответствиеДокументовПоПомещениям.Вставить(ДокОст.Помещение, ДокОст.Ссылка);
						Для Каждого ЭлементСоответствия ИЗ СоответствиеДокументовПоПомещениям Цикл
							ДокОст = ЭлементСоответствия.Значение.ПолучитьОбъект();
							Если ДокОст.Товары.Количество()=0 Тогда
								ДокОст.Удалить();
								Продолжить;
							КонецЕсли;

							Если НЕ ЗначениеЗаполнено(ДокОст.ХозяйственнаяОперация) Тогда
								ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковТоваровПолученныхНаКомиссию;
							КонецЕсли;
							ИспользоватьАдресноеХранение = СкладыСервер.ИспользоватьАдресноеХранение(ДокОст.Склад, ДокОст.Помещение, ДокОст.Дата, Истина);
							Если ИспользоватьАдресноеХранение И НЕ ЗначениеЗаполнено(ДокОст.ЗонаПриемки) Тогда
								ДокОст.ЗонаПриемки = ПолучитьЯчейкуЗонаПриемки(ДокОст.Склад, ДокОст.Помещение);
							КонецЕсли;

							//Заполним серии для тех строк, где это необходимо
							ЗаполнитьСерииТоваров(ДокОст);
							//Заполним назначения товаров если это необходимо
							ЗаполнитьНазначенияТоваров(ДокОст);
							ДокОст.Записать(РежимЗаписиДокумента.Запись);
						КонецЦикла;  //Для Каждого ЭлементСоответствия ИЗ СоответствиеДокументовПоПомещениям Цикл
					КонецЦикла; //НалоговоеНазначение
				КонецЦикла;   //Пока Выборка.СледующийПоЗначениюПоля("Комитент") Цикл
			КонецЦикла;  //Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
		КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
	КонецЦикла;  //Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковТоваров", 
			Перечисления.ХозяйственныеОперации.ВводОстатковТоваровПолученныхНаКомиссию);
	КонецЕсли;

	//2. Товары переданные на комиссию
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|ТабРег.АналитикаУчетаНоменклатуры.Партнер КАК Партнер,
	|ТабРег.Соглашение КАК Соглашение,
	|ТабРег.Организация КАК Организация,
	|ТабРег.НомерГТД КАК НомерГТД,
	|Сумма(ТабРег.КоличествоОстаток) КАК Количество
	|ПОМЕСТИТЬ ТабОстатки	
	|ИЗ РегистрНакопления.ТоварыПереданныеНаКомиссию.Остатки(&ГраницаОст, ) КАК ТабРег
	|СГРУППИРОВАТЬ ПО
	|ТабРег.АналитикаУчетаНоменклатуры,
	|ТабРег.АналитикаУчетаНоменклатуры.Партнер,
	|ТабРег.Соглашение,
	|ТабРег.Организация,
	|ТабРег.НомерГТД 
	|;
	|ВЫБРАТЬ 
	|ТабРег.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|ТабРег.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|ТабРег.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|ТабРег.Партнер КАК Партнер,
	|ТабРег.Соглашение КАК СоглашениеСКомиссионером,
	|ТабРег.Организация КАК Организация,
	|ТабРег.НомерГТД КАК НомерГТД,
	|ВЫБОР КОГДА ЕстьNULL(ТабРегСебестоимость.СтоимостьОстаток,0) > 0 ТОГДА
	|	ТабРегСебестоимость.НалоговоеНазначение
	|КОГДА ТабРегПартии.АналитикаУчетаПартий.НалоговоеНазначение IS NULL ТОГДА
	|	ЗНАЧЕНИЕ(Справочник.НалоговыеНазначенияАктивовИЗатрат.НДС_Облагаемая)
	|ИНАЧЕ ТабРегПартии.АналитикаУчетаПартий.НалоговоеНазначение КОНЕЦ КАК НалоговоеНазначение,
	|Сумма(ТабРег.Количество) КАК Количество,
	|Сумма(ЕстьNULL(ТабРегСебестоимость.СтоимостьОстаток,0) + ЕстьNULL(ТабРегСебестоимость.ДопРасходыОстаток,0)) КАК Сумма,
	|Сумма(ЕстьNULL(ТабРегСебестоимость.СтоимостьБезНДСОстаток,0) + ЕстьNULL(ТабРегСебестоимость.ДопРасходыБезНДСОстаток,0)) КАК СуммаБезНДС,
	|Сумма(ЕстьNULL(ТабРегСебестоимость.СтоимостьОстаток,0) + ЕстьNULL(ТабРегСебестоимость.ДопРасходыОстаток,0) -
	|	(ЕстьNULL(ТабРегСебестоимость.СтоимостьБезНДСОстаток,0) - ЕстьNULL(ТабРегСебестоимость.ДопРасходыБезНДСОстаток,0))) КАК СуммаНДС,
	|Сумма(ЕстьNULL(ТабРегСебестоимость.СтоимостьРеглОстаток,0)) КАК СуммаРегл,
	|ВЫБОР КОГДА Сумма(ЕстьNULL(ТабРегСебестоимость.КоличествоОстаток,0)) > 0 ТОГДА
	|	 Сумма(ЕстьNULL(ТабРегСебестоимость.СтоимостьОстаток,0)) / Сумма(ТабРегСебестоимость.КоличествоОстаток)
	|ИНАЧЕ 0 КОНЕЦ КАК Цена,
	|Сумма(ЕстьNULL(ТабРегПартии.КоличествоОстаток,0)) КАК КоличествоПартии,
	|Сумма(ЕстьNULL(ТабРегПартии.СтоимостьОстаток,0)) КАК СуммаПартии,
	|Сумма(ЕстьNULL(ТабРегПартии.СтоимостьБезНДСОстаток,0)) КАК СуммаБезНДСПартии,
	|Сумма(ЕстьNULL(ТабРегПартии.СтоимостьОстаток,0) - ЕстьNULL(ТабРегПартии.СтоимостьБезНДСОстаток,0)) КАК НДСПартии,
	|Сумма(ЕстьNULL(ТабРегПартии.СтоимостьРеглОстаток,0)) КАК СуммаРеглПартии,
	|Сумма(ЕстьNULL(ТабРегПартии.НДСРеглОстаток,0)) КАК НДСРеглПартии,
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковТоваровПереданныхНаКомиссию) КАК ХозяйственнаяОперация
	
	|ИЗ ТабОстатки КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаОст, РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию))  КАК ТабРегСебестоимость
	|	ПО ТабРег.Организация = ТабРегСебестоимость.Организация 
	|	И ТабРег.АналитикаУчетаНоменклатуры = ТабРегСебестоимость.АналитикаУчетаНоменклатуры
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровПереданныеНаКомиссию.Остатки(&ГраницаОст) КАК ТабРегПартии
	|ПО ТабРег.Организация = ТабРегПартии.Организация 
	|	И ТабРег.АналитикаУчетаНоменклатуры = ТабРегПартии.АналитикаУчетаНоменклатуры
	|ГДЕ ТабРег.Количество > 0
	|СГРУППИРОВАТЬ ПО
	|	ТабРег.АналитикаУчетаНоменклатуры,
	|	ТабРег.Партнер,
	|	ТабРег.Соглашение,
	|	ТабРег.Организация,
	|ВЫБОР КОГДА ЕстьNULL(ТабРегСебестоимость.СтоимостьОстаток,0) > 0 ТОГДА
	|	ТабРегСебестоимость.НалоговоеНазначение
	|КОГДА ТабРегПартии.АналитикаУчетаПартий.НалоговоеНазначение IS NULL ТОГДА
	|	ЗНАЧЕНИЕ(Справочник.НалоговыеНазначенияАктивовИЗатрат.НДС_Облагаемая)
	|ИНАЧЕ ТабРегПартии.АналитикаУчетаПартий.НалоговоеНазначение КОНЕЦ,
	|	ТабРег.НомерГТД
	|УПОРЯДОЧИТЬ ПО 
	|	ТабРег.Организация,
	|	ТабРег.Партнер,
	|	ТабРег.Соглашение,
	|ВЫБОР КОГДА ЕстьNULL(ТабРегСебестоимость.СтоимостьОстаток,0) > 0 ТОГДА
	|	ТабРегСебестоимость.НалоговоеНазначение
	|КОГДА ТабРегПартии.АналитикаУчетаПартий.НалоговоеНазначение IS NULL ТОГДА
	|	ЗНАЧЕНИЕ(Справочник.НалоговыеНазначенияАктивовИЗатрат.НДС_Облагаемая)
	|ИНАЧЕ ТабРегПартии.АналитикаУчетаПартий.НалоговоеНазначение КОНЕЦ
	|";

	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	КоличествоСформированныхДокументов = 1;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("СоглашениеСКомиссионером") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("НалоговоеНазначение") Цикл
					ДокОст = Документы.ВводОстатковТоваров.СоздатьДокумент();
					ДокОст.ЦенаВключаетНДС = Истина;
					ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
					Если НЕ ЗначениеЗаполнено(ДокОст.НалоговоеНазначение) Тогда
						ДокОст.НалоговоеНазначение = Справочники.НалоговыеНазначенияАктивовИЗатрат.НДС_Облагаемая;
					КонецЕсли;
					Пока Выборка.Следующий() Цикл

						НоваяСтрока = ДокОст.Товары.Добавить();
						ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
						Если НоваяСтрока.Сумма = 0 И Выборка.КоличествоПартии > 0 И Выборка.СуммаПартии Тогда
							//Заполним по данным из регистра партий
							НоваяСтрока.Цена  = Окр(Выборка.СуммаПартии / Выборка.КоличествоПартии, 2);
							КоэффициентПересчета = НоваяСтрока.Количество / Выборка.КоличествоПартии;
							НоваяСтрока.Сумма = Окр(КоэффициентПересчета * Выборка.СуммаПартии, 2);
							НоваяСтрока.СуммаБезНДС = Окр(КоэффициентПересчета * Выборка.СуммаБезНДСПартии, 2);
							НоваяСтрока.НДСРегл = Окр(КоэффициентПересчета * Выборка.НДСРеглПартии, 2);
							НоваяСтрока.СуммаНДС = Окр(КоэффициентПересчета * Выборка.НДСПартии, 2);
							НоваяСтрока.СуммаРегл = Окр(КоэффициентПересчета * Выборка.СуммаРеглПартии, 2);

						КонецЕсли;
						
						НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество;
						Если НоваяСтрока.СуммаНДС > 0 Тогда
							НоваяСтрока.СтавкаНДС = Перечисления.СтавкиНДС.НДС20;
							Если НоваяСтрока.НДСРегл = 0 И НоваяСтрока.Сумма <> 0 И НоваяСтрока.СуммаРегл <> 0 Тогда
								НоваяСтрока.НДСРегл = Окр(НоваяСтрока.Сумма*НоваяСтрока.СуммаНДС / НоваяСтрока.СуммаРегл,2);
							КонецЕсли;
						КонецЕсли;
						
						Если ДокОст.Товары.Количество() >= КоличествоСтрокВДокументеВводаОстатков Тогда
							ДокОст.Записать(РежимЗаписиДокумента.Запись);
							КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
							
							ДокОст = Документы.ВводОстатковТоваров.СоздатьДокумент();
							ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
							ДокОст.ЦенаВключаетНДС = Истина;
						КонецЕсли;
					КонецЦикла; //Пока Выборка.Следующий() Цикл
					Если ДокОст.Товары.Количество() > 0 Тогда
						ДокОст.Записать(РежимЗаписиДокумента.Запись);
						КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
					КонецЕсли;
				КонецЦикла;   //Пока Выборка.СледующийПоЗначениюПоля("НалоговоеНазначение") Цикл 
			КонецЦикла;  //Пока Выборка.СледующийПоЗначениюПоля("СоглашениеСКомиссионером") Цикл
		КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
	КонецЦикла;  //Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковТоваров", 
											Перечисления.ХозяйственныеОперации.ВводОстатковТоваровПереданныхНаКомиссию);
	КонецЕсли;
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковВозвратнаяТара()
	//1. Переданная возвратная тара
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.Партнер КАК Партнер,
	|ТабРег.ВидЗапасов КАК ВидЗапасов,
	|ТабРег.ДокументПередачи.Валюта КАК Валюта,
	|ТабРег.КоличествоОстаток КАК Количество,
	|ТабРег.СуммаОстаток КАК Сумма,
	|ТабРег.ВидЗапасов.Организация КАК Организация,
	|ТабРег.НомерГТД КАК НомерГТД,
	|ТабРег.ПредусмотренЗалог КАК ПредусмотренЗалогЗаТару,
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковВозвратнойТарыПереданнойКлиентам) КАК ХозяйственнаяОперация
	|ИЗ РегистрНакопления.ПереданнаяВозвратнаяТара.Остатки(&ГраницаОст) КАК ТабРег
	|ГДЕ ТабРег.КоличествоОстаток > 0
	|УПОРЯДОЧИТЬ ПО Организация, Партнер";
	
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	КоличествоСформированныхДокументов = 1;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
			ДокОст = Документы.ВводОстатковТоваров.СоздатьДокумент();
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);

			Пока Выборка.Следующий() Цикл

				НоваяСтрока = ДокОст.Товары.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
				Если НЕ ЗначениеЗаполнено(ДокОст.НалоговоеНазначение) Тогда
					ДокОст.НалоговоеНазначение = Справочники.НалоговыеНазначенияАктивовИЗатрат.НДС_Облагаемая;
				КонецЕсли;
				Если Выборка.Валюта = ВалютаРегламентированногоУчета 
					ИЛИ НЕ ЗначениеЗаполнено(Выборка.Валюта) Тогда
					НоваяСтрока.СуммаРегл = Выборка.Сумма;
					КоэффициентПересчета = РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(ВалютаРегламентированногоУчета, ВалютаУправленческогоУчета, ДокОст.Дата);
					НоваяСтрока.Сумма = Окр(КоэффициентПересчета * Выборка.Сумма, 2);
				ИначеЕсли Выборка.Валюта = ВалютаУправленческогоУчета Тогда
					КоэффициентПересчета = РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(Выборка.Валюта, ВалютаРегламентированногоУчета, ДокОст.Дата);
					НоваяСтрока.СуммаРегл = Окр(КоэффициентПересчета * Выборка.Сумма, 2);
				Иначе
					КоэффициентПересчетаУпр = РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(Выборка.Валюта, ВалютаУправленческогоУчета, ДокОст.Дата);
					КоэффициентПересчетаРегл = РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(Выборка.Валюта, ВалютаРегламентированногоУчета, ДокОст.Дата);
					НоваяСтрока.СуммаРегл = Окр(КоэффициентПересчетаРегл * Выборка.Сумма, 2);
					НоваяСтрока.Сумма = Окр(КоэффициентПересчетаУпр * Выборка.Сумма, 2);
				КонецЕсли;
				Если НоваяСтрока.Количество > 0 Тогда
					НоваяСтрока.Цена = Окр(НоваяСтрока.Сумма / НоваяСтрока.Количество,2)
				КонецЕсли;
				НоваяСтрока.СуммаБезНДС = НоваяСтрока.Сумма;
				НоваяСтрока.СуммаСНДС = НоваяСтрока.Сумма;
				НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество;

				Если ДокОст.Товары.Количество() >= КоличествоСтрокВДокументеВводаОстатков Тогда
					ДокОст.Записать(РежимЗаписиДокумента.Запись);
					КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
					
					ДокОст = Документы.ВводОстатковТоваров.СоздатьДокумент();
					ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
				КонецЕсли;
			КонецЦикла; //Пока Выборка.Следующий() Цикл
			Если ДокОст.Товары.Количество() > 0 Тогда
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковТоваров", 
											Перечисления.ХозяйственныеОперации.ВводОстатковВозвратнойТарыПереданнойКлиентам);
	КонецЕсли;
	
	//2. Принятая возвратная тара
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ЕстьNULL(ТабРегТовары.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)) КАК Организация,
	|ТабРег.Партнер КАК Партнер,
	|ЕстьNULL(ТабРегТовары.АналитикаУчетаНоменклатуры.МестоХранения, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) КАК Склад,
	|ЕстьNULL(ТабРегТовары.АналитикаУчетаНоменклатуры.МестоХранения.ИспользоватьСкладскиеПомещения, ЛОЖЬ) КАК ИспользоватьСкладскиеПомещения,
	
	|ТабРегТовары.НомерГТД КАК НомерГТД,
	|ТабРегТовары.ВидЗапасов КАК ВидЗапасов,
	|ТабРег.КоличествоОстаток КАК Количество,
	|ТабРег.СуммаОстаток КАК Сумма,
	|ТабРег.ПредусмотренЗалог КАК ПредусмотренЗалогЗаТару,
	|ВЫБОР КОГДА ТабРег.КоличествоОстаток > 0 ТОГДА
	|ТабРег.СуммаОстаток / ТабРег.КоличествоОстаток
	|ИНАЧЕ 0 КОНЕЦ КАК Цена, 
	|%ТекстНалоговоеНазначение%
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковВозвратнойТарыПринятойОтПоставщиков) КАК ХозяйственнаяОперация
	|ИЗ РегистрНакопления.ПринятаяВозвратнаяТара.Остатки(&ГраницаОст) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ  РегистрНакопления.ТоварыОрганизаций.Остатки(&ГраницаОст,
	|												АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)) КАК ТабРегТовары
	|	ПО ТабРег.Номенклатура = ТабРегТовары.АналитикаУчетаНоменклатуры.Номенклатура И
	|		ТабРег.Характеристика = ТабРегТовары.АналитикаУчетаНоменклатуры.Характеристика И
	|	    (ТабРег.ДокументПоступления.Организация = ТабРегТовары.Организация ИЛИ
	|		ТабРег.ДокументПоступления.Организация ЕСТЬ NULL)
	|%ТекстЛевоеСоединение% 
	|
	|ГДЕ ТабРег.КоличествоОстаток > 0
	|УПОРЯДОЧИТЬ ПО 
	|	ЕстьNULL(ТабРегТовары.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)),
	|	Партнер, НалоговоеНазначение,
	|	ЕстьNULL(ТабРегТовары.АналитикаУчетаНоменклатуры.МестоХранения, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка))";
	ДатаПереходаНаПартии22 = Константы.ДатаПереходаНаПартионныйУчетВерсии22.Получить();
	Если РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии22()
		И ДатаПереходаНаПартии22 < КонецДня(ДатаСверткиИБ) Тогда
		ТекстЛевоеСоединение = "ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаОст) КАК ТабРегПартии
		|	ПО ТабРегТовары.АналитикаУчетаНоменклатуры = ТабРегПартии.АналитикаУчетаНоменклатуры И
		|		ТабРегТовары.Организация = ТабРегПартии.Организация И 
		|		(ТабРегТовары.ВидЗапасов = ТабРегПартии.ВидЗапасов) И
		|		ТабРег.Партнер = ТабРегПартии.АналитикаУчетаПартий.Поставщик";
		ТекстНалоговоеНазначение = "ЕстьNULL(ТабРегПартии.НалоговоеНазначение, ТабРегТовары.ВидЗапасов.НалоговоеНазначение) КАК НалоговоеНазначение,";
	Иначе
		ТекстЛевоеСоединение = "ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&ГраницаОст) КАК ТабРегПартии
		|	ПО ТабРегТовары.АналитикаУчетаНоменклатуры = ТабРегПартии.АналитикаУчетаНоменклатуры И
		|		ТабРегТовары.Организация = ТабРегПартии.Организация И 
		|		ТабРегТовары.ВидЗапасов = ТабРегПартии.ВидЗапасов";
		ТекстНалоговоеНазначение = "ЕстьNULL(ТабРегПартии.АналитикаУчетаПартий.НалоговоеНазначение, ТабРегТовары.ВидЗапасов.НалоговоеНазначение) КАК НалоговоеНазначение,";
	КонецЕсли;
	Запрос.Текст = СтрЗаменить(Запрос.Текст,"%ТекстЛевоеСоединение%",ТекстЛевоеСоединение);
	Запрос.Текст = СтрЗаменить(Запрос.Текст,"%ТекстНалоговоеНазначение%",ТекстНалоговоеНазначение);

	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	КоличествоСформированныхДокументов = 1;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("НалоговоеНазначение") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
					ДокОст = Документы.ВводОстатковТоваров.СоздатьДокумент();
					ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
					Если НЕ ЗначениеЗаполнено(ДокОст.НалоговоеНазначение) Тогда
						ДокОст.НалоговоеНазначение = Справочники.НалоговыеНазначенияАктивовИЗатрат.НДС_Облагаемая;
					КонецЕсли;
					ДокОст.Валюта = ВалютаРегламентированногоУчета;
					СоответствиеДокументовПоПомещениям = Новый Соответствие();

					Пока Выборка.Следующий() Цикл
						ВыбранныеВариантыПомещений = Новый Массив;

						//Определим помещение
						Если Выборка.ИспользоватьСкладскиеПомещения Тогда
							ПодобратьПодходящиеПомещения(Выборка, ВыбранныеВариантыПомещений, Выборка.Количество);
						КонецЕсли; //Если Выборка.ИспользоватьСкладскиеПомещения Тогда
						Если НЕ Выборка.ИспользоватьСкладскиеПомещения ИЛИ ВыбранныеВариантыПомещений.Количество() = 0 Тогда
							НоваяСтрока = ДокОст.Товары.Добавить();
							ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
						
							НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество;

							НоваяСтрока.СуммаБезНДС = НоваяСтрока.Сумма;
							НоваяСтрока.СуммаРегл = НоваяСтрока.Сумма;
						Иначе
							КоличествоРаспределить = Выборка.Количество;
							Для Каждого СтрокаПомещение ИЗ ВыбранныеВариантыПомещений Цикл
								ТекПомещение = СтрокаПомещение.Помещение;
								НайтиСоздатьДокументОстатковПоПомещению(Выборка, ТекПомещение, ДокОст, СоответствиеДокументовПоПомещениям, КоличествоСформированныхДокументов);
								
								НоваяСтрока = ДокОст.Товары.Добавить();
								ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
								//Пересчитаем суммы и количества в соответствии с остатком по помещению
								КоличествоПоПомещению = Мин(КоличествоРаспределить, СтрокаПомещение.Количество);
								СтрокаПомещение.Количество = СтрокаПомещение.Количество - КоличествоПоПомещению;
								Если КоличествоПоПомещению <> НоваяСтрока.Количество Тогда
									КоэффициентПересчета = КоличествоПоПомещению / Выборка.Количество;
									НоваяСтрока.Количество = КоличествоПоПомещению;
									НоваяСтрока.Сумма = Окр(Выборка.Сумма * КоэффициентПересчета, 2);
								КонецЕсли;
								//Заполним связанные данные
								НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество;
								НоваяСтрока.СуммаБезНДС = НоваяСтрока.Сумма;
								НоваяСтрока.СуммаРегл = НоваяСтрока.Сумма;

								КоличествоРаспределить = КоличествоРаспределить - НоваяСтрока.Количество;
								Если КоличествоРаспределить <=0 Тогда
									Прервать;
								КонецЕсли;
							КонецЦикла; //Для Каждого СтрокаПомещение ИЗ ВыбранныеВариантыПомещений Цикл
							Если КоличествоРаспределить > 0 Тогда
								ТекПомещение = ПроверитьПоступлениеПоОрдеру(Выборка, КоличествоРаспределить);
								НайтиСоздатьДокументОстатковПоПомещению(Выборка, ТекПомещение, ДокОст, СоответствиеДокументовПоПомещениям, КоличествоСформированныхДокументов);
								
								НоваяСтрока = ДокОст.Товары.Добавить();
								ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
								//Пересчитаем суммы и количества в соответствии с остатком по помещению
								КоличествоПоПомещению = КоличествоРаспределить;
								СтрокаПомещение.Количество = СтрокаПомещение.Количество - КоличествоПоПомещению;
								Если КоличествоПоПомещению <> НоваяСтрока.Количество Тогда
									КоэффициентПересчета = КоличествоПоПомещению / Выборка.Количество;
									НоваяСтрока.Количество = КоличествоПоПомещению;
									НоваяСтрока.Сумма = Окр(Выборка.Сумма * КоэффициентПересчета, 2);
								КонецЕсли;
								//Заполним связанные данные
								НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество;
								НоваяСтрока.СуммаБезНДС = НоваяСтрока.Сумма;
								НоваяСтрока.СуммаРегл = НоваяСтрока.Сумма;
							КонецЕсли;
							
						КонецЕсли;
					КонецЦикла; //Пока Выборка.Следующий() Цикл
					ДокОст.Записать(РежимЗаписиДокумента.Запись);
					СоответствиеДокументовПоПомещениям.Вставить(ДокОст.Помещение, ДокОст.Ссылка);
					Для Каждого ЭлементСоответствия ИЗ СоответствиеДокументовПоПомещениям Цикл
						ДокОст = ЭлементСоответствия.Значение.ПолучитьОбъект();
						Если ДокОст.Товары.Количество()=0 Тогда
							ДокОст.Удалить();
							Продолжить;
						КонецЕсли;
						Если НЕ ЗначениеЗаполнено(ДокОст.ХозяйственнаяОперация) Тогда
							ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковВозвратнойТарыПринятойОтПоставщиков;
						КонецЕсли;
						ДокОст.Контрагент = ПартнерыИКонтрагенты.ПолучитьКонтрагентаПартнераПоУмолчанию(ДокОст.Партнер);
						ДокОст.Записать(РежимЗаписиДокумента.Запись);
					КонецЦикла;  //Для Каждого ЭлементСоответствия ИЗ СоответствиеДокументовПоПомещениям Цикл
				КонецЦикла; //Склад
			КонецЦикла; //НалоговоеНазначение
		КонецЦикла;  //Партнер
	КонецЦикла; //Организация
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковТоваров", 
									Перечисления.ХозяйственныеОперации.ВводОстатковВозвратнойТарыПринятойОтПоставщиков);
	КонецЕсли;

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковТоварыВЯчейках()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|	Номенклатура КАК Номенклатура,
	|	Характеристика КАК Характеристика,
	|	Серия КАК Серия,
	|	Склад КАК Склад,
	|	Помещение КАК Помещение,
	|	Сумма(ВНаличииОстаток) КАК Количество
	|ПОМЕСТИТЬ ТаблицаНаСкладе
	|ИЗ РегистрНакопления.ТоварыНаСкладах.Остатки(&ГраницаОст,)
	|ГДЕ ВНаличииОстаток>0
	|СГРУППИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	Серия,
	|	Склад,
	|	Помещение
	|;
	|ВЫБРАТЬ 
	|	ТабРег.Номенклатура КАК Номенклатура,
	|	ТабРег.Характеристика КАК Характеристика,
	|	ТабРег.Упаковка КАК Упаковка,
	|	ТабРег.Ячейка КАК Ячейка,
	|	ТабРег.Серия КАК Серия,
	|	ТабРег.Ячейка.Владелец КАК Склад,
	|	ТабРег.Ячейка.Помещение КАК Помещение,
	|	Сумма(ТабРег.ВНаличииОстаток) КАК Количество,
	|	Сумма(ЕстьNULL(ТаблицаНаСкладе.Количество, 0)) КАК Остаток,
	|	ЗНАЧЕНИЕ(Перечисление.СтатусыОтборовРазмещенийТоваров.ВыполненоБезОшибок) КАК Статус,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтбораРазмещенияТоваров.Размещение) КАК ВидОперации
	|ИЗ РегистрНакопления.ТоварыВЯчейках.Остатки(&ГраницаОст, ) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаНаСкладе
	|ПО ТабРег.Номенклатура = ТаблицаНаСкладе.Номенклатура
	|	И ТабРег.Характеристика = ТаблицаНаСкладе.Характеристика
	|	И ТабРег.Ячейка.Владелец = ТаблицаНаСкладе.Склад
	|	И ТабРег.Серия = ТаблицаНаСкладе.Серия
	|	И ТабРег.Ячейка.Помещение = ТаблицаНаСкладе.Помещение
	|СГРУППИРОВАТЬ ПО
	|	ТабРег.Номенклатура,
	|	ТабРег.Характеристика,
	|	ТабРег.Упаковка,
	|	ТабРег.Ячейка,
	|	ТабРег.Серия,
	|	ТабРег.Ячейка.Владелец,
	|	ТабРег.Ячейка.Помещение
	|ИМЕЮЩИЕ Сумма(ТабРег.ВНаличииОстаток) > 0 И Сумма(ЕстьNULL(ТаблицаНаСкладе.Количество, 0)) > 0
	|УПОРЯДОЧИТЬ ПО Склад, Помещение, Номенклатура, Характеристика, Серия";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	
	КоличествоСформированныхДокументов = 1;
	Выборка = Результат.Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Помещение") Цикл
			ДокОст = Документы.ОтборРазмещениеТоваров.СоздатьДокумент();
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка, Ложь);
			ДокОст.ЗонаПриемки = ПолучитьЯчейкуЗонаПриемки(Выборка.Склад, Выборка.Помещение);
			Пока Выборка.СледующийПоЗначениюПоля("Номенклатура") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("Характеристика") Цикл
					Пока Выборка.СледующийПоЗначениюПоля("Серия") Цикл
						КоличествоОстаток = Выборка.Остаток;
						Пока Выборка.Следующий() Цикл
							Если КоличествоОстаток = 0 Тогда
								Прервать;
							КонецЕсли;
							НоваяСтрока = ДокОст.ТоварыРазмещение.Добавить();
							ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
							НоваяСтрока.Количество = Мин(Выборка.Количество, КоличествоОстаток);
							НоваяСтрока.КоличествоРазмещено = НоваяСтрока.Количество;
							НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество;
							НоваяСтрока.КоличествоУпаковокРазмещено = НоваяСтрока.Количество;
							КоличествоОстаток = КоличествоОстаток - НоваяСтрока.Количество; 
						КонецЦикла;  // Ячейка
					КонецЦикла; // Серия
				КонецЦикла; // Характеристика
			КонецЦикла; // Номенклатура
		КонецЦикла;  //Помещение
		ПараметрыУказанияСерий = Новый ФиксированнаяСтруктура(НоменклатураСервер.ПараметрыУказанияСерий(ДокОст, Документы.ОтборРазмещениеТоваров));
		НоменклатураСервер.ЗаполнитьСтатусыУказанияСерий(ДокОст,ПараметрыУказанияСерий.Размещение);

		ДокОст.Записать(РежимЗаписиДокумента.Запись);
	КонецЦикла;  //Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
	ВывестиСообщениеСформированыДокументы("ОтборРазмещениеТоваров");
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковТМЦВЭксплуатации()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|	ТабРег.Организация 		КАК Организация,
	|	ТабРег.Подразделение 	КАК Подразделение,
	|	ТабРег.ФизическоеЛицо 	КАК ФизическоеЛицо,
	|	ТабРег.Номенклатура 	КАК Номенклатура,
	|	ТабРег.Характеристика	КАК Характеристика,
	|	ТабРег.Партия 			КАК ПартияТМЦВЭксплуатации,
	|	ТабРег.Партия.КатегорияЭксплуатации 	КАК КатегорияЭксплуатации,
	|	ТабРег.Партия.Дата 						КАК ДатаПередачиВЭксплуатацию,
	|	ТабРег.Партия.СтатьяРасходов 			КАК СтатьяРасходов,
	|	ТабРег.Партия.АналитикаРасходов 		КАК АналитикаРасходов,
	|	Сумма(ТабРег.КоличествоОборот) КАК Количество,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковТМЦВЭксплуатации) КАК ХозяйственнаяОперация
	|ИЗ РегистрНакопления.ТМЦВЭксплуатации.Обороты(,&ГраницаОст, ) КАК ТабРег
	|СГРУППИРОВАТЬ ПО
	|	ТабРег.Организация,
	|	ТабРег.Подразделение,
	|	ТабРег.ФизическоеЛицо,
	|	ТабРег.Номенклатура,
	|	ТабРег.Характеристика,
	|	ТабРег.Партия
	|ИМЕЮЩИЕ Сумма(ТабРег.КоличествоОборот) > 0
	|УПОРЯДОЧИТЬ ПО Организация, Подразделение, ФизическоеЛицо, Номенклатура, Характеристика, Партия";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	КоличествоСформированныхДокументов = 1;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Подразделение") Цикл
			ДокОст = Документы.ВводОстатковТМЦВЭксплуатации.СоздатьДокумент();
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка, Ложь);
			Пока Выборка.Следующий() Цикл
				НоваяСтрока = ДокОст.ТМЦВЭксплуатации.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
			КонецЦикла;
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
		КонецЦикла;
	КонецЦикла;
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковТМЦВЭксплуатации", 
									Перечисления.ХозяйственныеОперации.ВводОстатковТМЦВЭксплуатации);
	КонецЕсли;

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковДенежныеСредстваКВыплате()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|	ТабРег.ЗаявкаНаРасходованиеДенежныхСредств КАК ЗаявкаНаРасходованиеДенежныхСредств,
	|	ТабРег.БанковскийСчетКасса КАК БанковскийСчетКасса,
	|	ВЫРАЗИТЬ(ТабРег.Получатель КАК Справочник.Контрагенты).Партнер КАК Партнер,
	|	ВЫРАЗИТЬ(ТабРег.Получатель КАК Справочник.ФизическиеЛица) КАК ФизЛицо,
	|	ТабРег.СуммаКонечныйОстаток КАК СуммаКонечныйОстаток,
	|	ТабРег.СуммаПриход КАК СуммаПриход,
	|	ТабРег.СуммаРасход КАК СуммаРасход
	|ИЗ РегистрНакопления.ДенежныеСредстваКВыплате.ОстаткиИОбороты(,&ГраницаОст) КАК ТабРег
	|ГДЕ ТабРег.СуммаКонечныйОстаток<0
	|ИТОГИ Сумма(ТабРег.СуммаКонечныйОстаток), Сумма(ТабРег.СуммаПриход), Сумма(ТабРег.СуммаРасход)
	|ПО ЗаявкаНаРасходованиеДенежныхСредств";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	ТаблицаДетали = Новый ТаблицаЗначений;
	ТаблицаДетали.Колонки.Добавить("БанковскийСчетКасса");
	ТаблицаДетали.Колонки.Добавить("Партнер");
	ТаблицаДетали.Колонки.Добавить("ФизЛицо");
	ТаблицаДетали.Колонки.Добавить("СуммаКонечныйОстаток");
	
	ВыборкаЗаявкаНаРасход = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаЗаявкаНаРасход.Следующий() Цикл
		Если ВыборкаЗаявкаНаРасход.СуммаПриход = 0 Тогда
			//По заявке еще не было выполнения. Оставляем исходную заявку, помечаем ее комментарием
			ДокОст = ВыборкаЗаявкаНаРасход.ЗаявкаНаРасходованиеДенежныхСредств.ПолучитьОбъект();
			ДокОст.Комментарий = СокрЛП(ДокОст.Комментарий)+ "#" + Комментарий_НеУдалятьПриСверткеБазы;
			ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина); 
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
			Продолжить;
		КонецЕсли;
		//По заявке уже было выполнение. Создаем новую заявку на остаток суммы: копируем существующую и корректируем
		ДокОст = ВыборкаЗаявкаНаРасход.ЗаявкаНаРасходованиеДенежныхСредств.Скопировать();
		ТекстКомментария = Комментарий_СформированСверткойБазы + " [" + НСтр("ru='Остатки по документу';uk='Залишки по документу'")+" %Документ%]";
		ТекстКомментария = СтрЗаменить(ТекстКомментария, "%Документ%", 
										ВыборкаЗаявкаНаРасход.ЗаявкаНаРасходованиеДенежныхСредств);
		ДокОст.Комментарий = ТекстКомментария;
		ДокОст.Дата = КонецДня(ДатаСверткиИБ);
		Если ДокОст.РаспределениеПоСчетам.Количество() > 1
			Или (ДокОст.РасшифровкаПлатежа.Количество() + ДокОст.ЛицевыеСчетаСотрудников.Количество()) > 1 Тогда
			ВыборкаДетали = ВыборкаЗаявкаНаРасход.Выбрать();
			ТаблицаДетали.Очистить();
			Пока ВыборкаДетали.Следующий() Цикл
				СтрокаТаб = ТаблицаДетали.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаТаб, ВыборкаДетали);
			КонецЦикла;
		КонецЕсли;
		
		// Корректировка ТЧ Распределение по счетам
		Если ДокОст.РаспределениеПоСчетам.Количество() = 1 Тогда
			ДокОст.РаспределениеПоСчетам[0].Сумма = ВыборкаЗаявкаНаРасход.СуммаКонечныйОстаток;
		Иначе
			ТаблицаРаспределениеПоСчетам = ТаблицаДетали.Скопировать();
			ТаблицаРаспределениеПоСчетам.Свернуть("БанковскийСчетКасса", "СуммаКонечныйОстаток");
			МассивУдаляемыхСтрок = Новый Массив;
			Для Каждого СтрокаТЧ Из ДокОст.РаспределениеПоСчетам Цикл
				СтруктураПоиска = Новый Структура("БанковскийСчетКасса", СтрокаТЧ.БанковскийСчетКасса);
				МассивСтрокДетали = ТаблицаРаспределениеПоСчетам.НайтиСтроки(СтруктураПоиска);
				Если  МассивСтрокДетали.Количество() = 0 Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					Продолжить;
				ИначеЕсли МассивСтрокДетали[0].СуммаКонечныйОстаток = 0 Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					Продолжить;
				КонецЕсли;
				Если СтрокаТЧ.Сумма > МассивСтрокДетали[0].СуммаКонечныйОстаток Тогда
					СтрокаТЧ.Сумма = МассивСтрокДетали[0].СуммаКонечныйОстаток;
					МассивСтрокДетали[0].СуммаКонечныйОстаток = 0;
				ИначеЕсли СтрокаТЧ.Сумма = МассивСтрокДетали[0].СуммаКонечныйОстаток Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					МассивСтрокДетали[0].СуммаКонечныйОстаток = 0;
				Иначе
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					МассивСтрокДетали[0].СуммаКонечныйОстаток = МассивСтрокДетали[0].СуммаКонечныйОстаток - СтрокаТЧ.Сумма;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		Для Ном = 0 ПО МассивУдаляемыхСтрок.Количество()-1 Цикл
			ДокОст.РаспределениеПоСчетам.Удалить(МассивУдаляемыхСтрок[Ном]);
		КонецЦикла;
		// Корректировка ТЧ Расшифровка платежа и Лицевые счета сотрудников
		ТаблицаДетали.Свернуть("Партнер, ФизЛицо", "СуммаКонечныйОстаток");
		МассивУдаляемыхСтрок = Новый Массив;
		Если ДокОст.ЛицевыеСчетаСотрудников.Количество() = 1 И ТаблицаДетали.Количество() = 1 Тогда
			ДокОст.ЛицевыеСчетаСотрудников[0].Сумма = ВыборкаЗаявкаНаРасход.СуммаКонечныйОстаток;
		Иначе
			Для Каждого СтрокаТЧ Из ДокОст.ЛицевыеСчетаСотрудников Цикл
				Если НЕ ЗначениеЗаполнено(СтрокаТЧ.ФизическоеЛицо) Тогда
					Продолжить;
				КонецЕсли;
				СтруктураПоиска = Новый Структура("ФизЛицо", СтрокаТЧ.ФизическоеЛицо);
				МассивСтрокДетали = ТаблицаДетали.НайтиСтроки(СтруктураПоиска);
				Если  МассивСтрокДетали.Количество() = 0 Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					Продолжить;
				КонецЕсли;
				Если МассивСтрокДетали[0].СуммаКонечныйОстаток = 0 Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					Продолжить;
				КонецЕсли;
				Если СтрокаТЧ.Сумма > МассивСтрокДетали[0].СуммаКонечныйОстаток Тогда
					СтрокаТЧ.Сумма = МассивСтрокДетали[0].СуммаКонечныйОстаток;
					МассивСтрокДетали[0].СуммаКонечныйОстаток = 0;
				ИначеЕсли СтрокаТЧ.Сумма = МассивСтрокДетали[0].СуммаКонечныйОстаток Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					МассивСтрокДетали[0].СуммаКонечныйОстаток = 0;
				Иначе
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					МассивСтрокДетали[0].СуммаКонечныйОстаток = МассивСтрокДетали[0].СуммаКонечныйОстаток - СтрокаТЧ.Сумма;
				КонецЕсли;
			КонецЦикла;
			Для Ном = 0 ПО МассивУдаляемыхСтрок.Количество()-1 Цикл
				ДокОст.ЛицевыеСчетаСотрудников.Удалить(МассивУдаляемыхСтрок[Ном]);
			КонецЦикла;
		КонецЕсли;
		
		МассивУдаляемыхСтрок = Новый Массив;

		Если ДокОст.РасшифровкаПлатежа.Количество() = 1 И ТаблицаДетали.Количество() = 1 Тогда
			//Строка только одна - просто меняем сумму
			//Сумму взаиморасчетов меняем пропорционально измерению суммы
			ДокОст.РасшифровкаПлатежа[0].СуммаВзаиморасчетов = Окр(ДокОст.РасшифровкаПлатежа[0].СуммаВзаиморасчетов * ВыборкаЗаявкаНаРасход.СуммаКонечныйОстаток / ДокОст.РасшифровкаПлатежа[0].Сумма, 2);
			ДокОст.РасшифровкаПлатежа[0].Сумма = ВыборкаЗаявкаНаРасход.СуммаКонечныйОстаток;
		Иначе
			//Меняем табличную часть в соответствии с остатками
			
			Для Каждого СтрокаТЧ Из ДокОст.РасшифровкаПлатежа Цикл
				Если НЕ ЗначениеЗаполнено(СтрокаТЧ.Партнер) Тогда
					Продолжить;
				КонецЕсли;
				СтруктураПоиска = Новый Структура("Партнер", СтрокаТЧ.Партнер);
				МассивСтрокДетали = ТаблицаДетали.НайтиСтроки(СтруктураПоиска);
				Если  МассивСтрокДетали.Количество() = 0 Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					Продолжить;
				КонецЕсли;
				Если МассивСтрокДетали[0].СуммаКонечныйОстаток = 0 Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					Продолжить;
				КонецЕсли;
				Если СтрокаТЧ.Сумма > МассивСтрокДетали[0].СуммаКонечныйОстаток Тогда
					УменьшитьСуммуВзаиморасчетов = Окр(СтрокаТЧ.СуммаВзаиморасчетов * МассивСтрокДетали[0].СуммаКонечныйОстаток / СтрокаТЧ.Сумма, 2);
					СтрокаТЧ.СуммаВзаиморасчетов = СтрокаТЧ.СуммаВзаиморасчетов - УменьшитьСуммуВзаиморасчетов;
					СтрокаТЧ.Сумма = МассивСтрокДетали[0].СуммаКонечныйОстаток;

					МассивСтрокДетали[0].СуммаКонечныйОстаток = 0;
				ИначеЕсли СтрокаТЧ.Сумма = МассивСтрокДетали[0].СуммаКонечныйОстаток Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					МассивСтрокДетали[0].СуммаКонечныйОстаток = 0;
				Иначе
					МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
					МассивСтрокДетали[0].СуммаКонечныйОстаток = МассивСтрокДетали[0].СуммаКонечныйОстаток - СтрокаТЧ.Сумма;
				КонецЕсли;
			КонецЦикла;
			Для Ном = 0 ПО МассивУдаляемыхСтрок.Количество()-1 Цикл
				ДокОст.РасшифровкаПлатежа.Удалить(МассивУдаляемыхСтрок[Ном]);
			КонецЦикла;
		КонецЕсли; //Если ДокОст.РасшифровкаПлатежа.Количество() = 1 И ТаблицаДетали.Количество() = 1 Тогда
		ДокОст.Записать(РежимЗаписиДокумента.Проведение);
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы("ЗаявкаНаРасходованиеДенежныхСредств");
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковЗаказыВнутренние(ИмяРегистра, ИмяЗаказа)
	Запрос = Новый Запрос;
	ТекстЗапроса = "ВЫБРАТЬ 
	|ТабРег.%1% КАК Заказ,
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.Серия КАК Серия,
	|ТабРег.ЗаказаноКонечныйОстаток КАК КОформлениюКонечныйОстаток,
	|ТабРег.ЗаказаноРасход КАК ЗаказаноРасход
	|ИЗ РегистрНакопления.%2%.ОстаткиИОбороты(,&ГраницаОст) КАК ТабРег
	|ГДЕ ТабРег.ЗаказаноКонечныйОстаток > 0
	//++ НЕ УТ
	|%3%
	//-- НЕ УТ
	|ИТОГИ Максимум(ТабРег.ЗаказаноКонечныйОстаток), Максимум(ТабРег.ЗаказаноРасход), 
	|	Максимум(Серия), Максимум(Номенклатура), Максимум(Характеристика)
	|ПО Заказ";
	//++ НЕ УТ
	Если ИмяРегистра = "ЗаказыНаВнутреннееПотребление" Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%3%", "И ТабРег.%1% ССЫЛКА Документ.ЗаказНаВнутреннееПотребление");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%3%", "");
	КонецЕсли;
	//-- НЕ УТ
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1%", ИмяЗаказа);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%2%", ИмяРегистра);

	Запрос.Текст = ТекстЗапроса;
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	
	МассивРегистров = РегистрыНакопленияДокумента(ИмяЗаказа);
	
	ВыборкаЗаказ = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаЗаказ.Следующий() Цикл
		Если ВыборкаЗаказ.ЗаказаноРасход = 0 Тогда
			//Заказ не начал выполняться. Оставляем его как есть
			ДокОст = ВыборкаЗаказ.Заказ.ПолучитьОбъект();
			Если ДокОст <> Неопределено Тогда
				ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
				ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КонецЕсли;
			Продолжить;
		КонецЕсли;
		//Заказ начал выполняться. Надо изменить заказ в соответствии с текущим состоянием заказа
		ДокОст = ВыборкаЗаказ.Заказ.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		ЗафиксироватьИзменениеДокументовВПараметрСвертки();

		ВыборкаСтрокаЗаказа = ВыборкаЗаказ.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Для Каждого СтрокаТЧ Из ДокОст.Товары Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			КонецЕсли;
			
			СтруктураОтбора = Новый Структура("Номенклатура, Характеристика, Серия");
			Если ВыборкаСтрокаЗаказа.НайтиСледующий(СтруктураОтбора) Тогда
				Если СтрокаТЧ.Количество = ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток Тогда
					//Строку менять не требуется
				Иначе
					//Разделим строку на две, исполненную часть пометим как отмененную
					//Новая строка - копия старой строки
					НоваяСтрокаТЧ = ДокОст.Товары.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрокаТЧ, СтрокаТЧ);
					НоваяСтрокаТЧ.КодСтроки = 0;
					НоваяСтрокаТЧ.Отменено = Истина;

					СтрокаТЧ.Количество = ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток;
					СтрокаТЧ.КоличествоУпаковок = СтрокаТЧ.КоличествоУпаковок * СтрокаТЧ.Количество / НоваяСтрокаТЧ.Количество;
					
					НоваяСтрокаТЧ.Количество = НоваяСтрокаТЧ.Количество - СтрокаТЧ.Количество;
					НоваяСтрокаТЧ.КоличествоУпаковок = НоваяСтрокаТЧ.КоличествоУпаковок - СтрокаТЧ.КоличествоУпаковок;

				КонецЕсли;
			Иначе
				//Остатка по этой строке нет - отменим строку
				СтрокаТЧ.Отменено = Истина;
			КонецЕсли;
			ВыборкаСтрокаЗаказа.Сбросить();
		КонецЦикла;
		//Очистим движения данного заказа, чтобы при перепроведении не мешал контроль остатков.
		ОчиститьНаборыЗаписейДвиженийДокумента(МассивРегистров, ВыборкаЗаказ.Заказ);
		// Очистим движеняи регистра Внутренние заказы по данному заказу, чтобы при проведении не мешал контроль остатков.
		УдалитьДвиженияПоЗаказу(ИмяРегистра, ИмяЗаказа, ВыборкаЗаказ.Заказ);

		ПровестиИлиЗаписатьДокумент(ДокОст);
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы(ИмяЗаказа,,Истина);
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковЗаказыКлиентов()

	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.ЗаказКлиента КАК Заказ,
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.Склад КАК Склад,
	|ТабРег.Серия КАК Серия,
	|ТабРег.ЗаказаноКонечныйОстаток КАК ЗаказаноКонечныйОстаток,
	|ТабРег.СуммаКонечныйОстаток КАК СуммаКонечныйОстаток,
	|ТабРег.ЗаказаноРасход КАК ЗаказаноРасход
	|ИЗ РегистрНакопления.ЗаказыКлиентов.ОстаткиИОбороты(,&ГраницаОст, , , ЗаказКлиента ССЫЛКА Документ.ЗаказКлиента) КАК ТабРег
	|ГДЕ (ТабРег.ЗаказаноКонечныйОстаток>0 ИЛИ ТабРег.ЗаказаноРасход>0) 
	|ИТОГИ Максимум(ТабРег.ЗаказаноКонечныйОстаток), Максимум(ТабРег.СуммаКонечныйОстаток), Максимум(ТабРег.ЗаказаноРасход), 
	|	Максимум(Серия), Максимум(Номенклатура), Максимум(Характеристика)
	|ПО Заказ";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	//Определим причину отмены заказов
	ПричинаОтменыЗаказа = Справочники.ПричиныОтменыЗаказовКлиентов.НайтиПоНаименованию(НСтр("ru='#Свертка базы';uk='#Згортка бази'"));
	Если ПричинаОтменыЗаказа = Неопределено ИЛИ ПричинаОтменыЗаказа.Пустая() Тогда
		ПричинаОтменыЗаказаОбъект = Справочники.ПричиныОтменыЗаказовКлиентов.СоздатьЭлемент();
		ПричинаОтменыЗаказаОбъект.Наименование = НСтр("ru='#Свертка базы';uk='#Згортка бази'");
		ПричинаОтменыЗаказаОбъект.Записать();
		ПричинаОтменыЗаказа = ПричинаОтменыЗаказаОбъект.Ссылка;
	КонецЕсли;
	
	МассивРегистров = РегистрыНакопленияДокумента("ЗаказКлиента");

	ВыборкаЗаказ = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаЗаказ.Следующий() Цикл
		//Заказ в целом выполнился - пропускаем
		Если ВыборкаЗаказ.ЗаказаноКонечныйОстаток <= 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Если ВыборкаЗаказ.ЗаказаноРасход = 0 Тогда
			//По заказу есть остатки, он не начал выполняться. Оставляем его как есть
			ДокОст = ВыборкаЗаказ.Заказ.ПолучитьОбъект();
			Если ДокОст <> Неопределено Тогда
				ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
				ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КонецЕсли;
			Продолжить;
		КонецЕсли;
		//Заказ начал выполняться. Надо сформировать остатки в соответствии с текущим состоянием заказа
		ДокОст = ВыборкаЗаказ.Заказ.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		ЗафиксироватьИзменениеДокументовВПараметрСвертки();
		
		ВыборкаСтрокаЗаказа = ВыборкаЗаказ.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Для Каждого СтрокаТЧ Из ДокОст.Товары Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			КонецЕсли;
			
			СтруктураОтбора = Новый Структура("Номенклатура, Характеристика, Серия");
			ЗаполнитьЗначенияСвойств(СтруктураОтбора, СтрокаТЧ);
			Если ВыборкаСтрокаЗаказа.НайтиСледующий(СтруктураОтбора) Тогда
				Если ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток = СтрокаТЧ.Количество Тогда
					//Строку менять не требуется
				ИначеЕсли ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток = 0 Тогда
					//Строка выполнена полностью. Ее надо отменить
					СтрокаТЧ.Отменено = Истина;
					СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
				Иначе
					//Разделим строку на две, исполненную часть пометим как отмененную
					//Новая строка - копия старой строки
					НоваяСтрокаТЧ = ДокОст.Товары.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрокаТЧ, СтрокаТЧ);
					НоваяСтрокаТЧ.КодСтроки = 0;
					НоваяСтрокаТЧ.КлючСвязи = 0;
					НоваяСтрокаТЧ.Отменено = Истина;
					НоваяСтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;

					КоличествоСтарое = СтрокаТЧ.Количество;
					СтрокаТЧ.Количество = ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток;
					КоэффициентПересчета = СтрокаТЧ.Количество / КоличествоСтарое;
					СтрокаТЧ.Сумма = ВыборкаСтрокаЗаказа.СуммаКонечныйОстаток;
					//Пересчитаем другие суммы по количеству
					СтрокаТЧ.СуммаНДС = Окр(СтрокаТЧ.СуммаНДС * КоэффициентПересчета,2);
					СтрокаТЧ.КоличествоУпаковок = СтрокаТЧ.КоличествоУпаковок * КоэффициентПересчета;
					СтрокаТЧ.СуммаСНДС = Окр(СтрокаТЧ.СуммаСНДС * КоэффициентПересчета,2);
					//Если есть скидки, перезаполним
					Если СтрокаТЧ.СуммаРучнойСкидки > 0 ИЛИ СтрокаТЧ.СуммаАвтоматическойСкидки > 0 Тогда
						СтрокаТЧ.СуммаРучнойСкидки = Окр(СтрокаТЧ.СуммаРучнойСкидки * КоэффициентПересчета,2);
						СтрокаТЧ.СуммаАвтоматическойСкидки = Окр(СтрокаТЧ.СуммаАвтоматическойСкидки * КоэффициентПересчета,2);
						СтрокиСкидки = ДокОст.СкидкиНаценки.НайтиСтроки(Новый Структура("КлючСвязи", СтрокаТЧ.КлючСвязи));
						Для Каждого СтрокаСкидки ИЗ СтрокиСкидки Цикл
							СтрокаСкидки.Сумма = Окр(СтрокаСкидки.Сумма * КоэффициентПересчета,2);
						КонецЦикла;
					КонецЕсли;
					
					//Скорректируем данные новой строки ТЧ
					НоваяСтрокаТЧ.Количество = НоваяСтрокаТЧ.Количество - СтрокаТЧ.Количество;
					НоваяСтрокаТЧ.Сумма = НоваяСтрокаТЧ.Сумма - СтрокаТЧ.Сумма;
					НоваяСтрокаТЧ.СуммаНДС = НоваяСтрокаТЧ.СуммаНДС - СтрокаТЧ.СуммаНДС;
					НоваяСтрокаТЧ.КоличествоУпаковок = НоваяСтрокаТЧ.КоличествоУпаковок - СтрокаТЧ.КоличествоУпаковок;
					НоваяСтрокаТЧ.СуммаСНДС = НоваяСтрокаТЧ.СуммаСНДС - СтрокаТЧ.СуммаСНДС;
					НоваяСтрокаТЧ.СуммаРучнойСкидки = НоваяСтрокаТЧ.СуммаРучнойСкидки - СтрокаТЧ.СуммаРучнойСкидки;
					НоваяСтрокаТЧ.СуммаАвтоматическойСкидки = НоваяСтрокаТЧ.СуммаАвтоматическойСкидки - СтрокаТЧ.СуммаАвтоматическойСкидки;
				КонецЕсли;
			Иначе
				//Остатка по этой строке нет - отменим строку
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
			КонецЕсли;
			ВыборкаСтрокаЗаказа.Сбросить();
		КонецЦикла;
		//Изменение этапов оплаты
		Если ДокОст.ЭтапыГрафикаОплаты.Количество() > 0 Тогда
			Если ДокОст.ЭтапыГрафикаОплаты.Количество()=1 Тогда
				ДокОст.ЭтапыГрафикаОплаты[0].СуммаПлатежа = ВыборкаЗаказ.СуммаКонечныйОстаток;
			Иначе
				//убираем лишние суммы пропорционально с каждой строки
				Коэффициент = ВыборкаЗаказ.СуммаКонечныйОстаток / ДокОст.ЭтапыГрафикаОплаты.Итог("СуммаПлатежа");
				ЗаказСумма = ВыборкаЗаказ.СуммаКонечныйОстаток;
				Для каждого СтрокаТЧ Из ДокОст.ЭтапыГрафикаОплаты Цикл
					Если ЗаказСумма = 0 Тогда
						Прервать;
					КонецЕсли;
					СтрокаТЧ.СуммаПлатежа = Окр(СтрокаТЧ.СуммаПлатежа * Коэффициент, 2);
					ЗаказСумма = ЗаказСумма - СтрокаТЧ.СуммаПлатежа;
				КонецЦикла;
				Если ЗаказСумма <> 0 Тогда
					ДокОст.ЭтапыГрафикаОплаты[0].СуммаПлатежа = ДокОст.ЭтапыГрафикаОплаты[0].СуммаПлатежа + ЗаказСумма;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		//Очистим движения данного заказа, чтобы при перепроведении не мешал контроль остатков
		ОчиститьНаборыЗаписейДвиженийДокумента(МассивРегистров, ВыборкаЗаказ.Заказ);
		// Очистим движеняи регистра Заказы... по данному заказу, чтобы при проведении не мешал контроль остатков.
		УдалитьДвиженияПоЗаказу("ЗаказыКлиентов", "ЗаказКлиента", ВыборкаЗаказ.Заказ);

		ПровестиИлиЗаписатьДокумент(ДокОст);
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы("ЗаказКлиента",,Истина);

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковЗаказыПоставщикам()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.ЗаказПоставщику КАК Заказ,
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.КодСтроки КАК КодСтроки,
	|ТабРег.Склад КАК Склад,
	|ТабРег.ЗаказаноКонечныйОстаток КАК ЗаказаноКонечныйОстаток,
	|ТабРег.ЗаказаноРасход КАК ЗаказаноРасход
	|ИЗ РегистрНакопления.ЗаказыПоставщикам.ОстаткиИОбороты(,&ГраницаОст, , , ЗаказПоставщику ССЫЛКА Документ.ЗаказПоставщику) КАК ТабРег
	|ГДЕ ТабРег.ЗаказаноКонечныйОстаток>0 ИЛИ ТабРег.ЗаказаноРасход > 0
	|ИТОГИ Сумма(ТабРег.ЗаказаноКонечныйОстаток), Сумма(ТабРег.ЗаказаноРасход) 
	|ПО Заказ
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	ПричинаОтменыЗаказа = Справочники.ПричиныОтменыЗаказовПоставщикам.НайтиПоНаименованию(НСтр("ru='#Свертка базы';uk='#Згортка бази'"));
	Если ПричинаОтменыЗаказа = Неопределено ИЛИ ПричинаОтменыЗаказа.Пустая() Тогда
		ПричинаОтменыЗаказаОбъект = Справочники.ПричиныОтменыЗаказовПоставщикам.СоздатьЭлемент();
		ПричинаОтменыЗаказаОбъект.Наименование = НСтр("ru='#Свертка базы';uk='#Згортка бази'");
		ПричинаОтменыЗаказаОбъект.ИнициаторОтменыЗаказовПоставщикам = 
														Перечисления.ИнициаторОтменыЗаказовПоставщикам.НашеПредприятие;
		ПричинаОтменыЗаказаОбъект.Записать();
		ПричинаОтменыЗаказа = ПричинаОтменыЗаказаОбъект.Ссылка;
	КонецЕсли;
	
	МассивРегистров = РегистрыНакопленияДокумента("ЗаказПоставщику");

	ВыборкаЗаказ = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаЗаказ.Следующий() Цикл
		Если ВыборкаЗаказ.ЗаказаноКонечныйОстаток <= 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Если ВыборкаЗаказ.ЗаказаноРасход = 0 Тогда
			//Заказ не начал выполняться. Оставляем его как есть
			ДокОст = ВыборкаЗаказ.Заказ.ПолучитьОбъект();
			Если ДокОст <> Неопределено Тогда
				ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
				ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КонецЕсли;
			Продолжить;
		КонецЕсли;
		//Заказ начал выполняться. Надо сформировать остатки в соответствии с текущим состоянием заказа
		ДокОст = ВыборкаЗаказ.Заказ.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		ЗафиксироватьИзменениеДокументовВПараметрСвертки();

		СуммаПоЗаказу = 0;
		ТребуетсяКорректировка = Новый Массив;
		ВыборкаСтрокаЗаказа = ВыборкаЗаказ.Выбрать();
		Для Каждого СтрокаТЧ Из ДокОст.Товары Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			КонецЕсли;
			
			СтруктураОтбора = Новый Структура("Номенклатура, Характеристика, КодСтроки");
			ЗаполнитьЗначенияСвойств(СтруктураОтбора, СтрокаТЧ);
			Если ВыборкаСтрокаЗаказа.НайтиСледующий(СтруктураОтбора) Тогда
				Если ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток = СтрокаТЧ.Количество Тогда
					//Строка не меняется
					СуммаПоЗаказу = СуммаПоЗаказу + СтрокаТЧ.СуммаСНДС;
				ИначеЕсли ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток <= 0 Тогда
					//Строка отменяется целиком
					СтрокаТЧ.Отменено = Истина;
					СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
					// Если значение отрицательное, нужна корректировка по разрезу номенклатура-характеристика-склад (пересорт по коду строки)
					Если ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток < 0 Тогда
						СтруктураДляКорректировки = Новый Структура("Номенклатура, Характеристика, Склад");
						ЗаполнитьЗначенияСвойств(СтруктураДляКорректировки, СтрокаТЧ);
						ТребуетсяКорректировка.Добавить(СтруктураДляКорректировки);
					КонецЕсли;
				Иначе
					//Разобъем строку на две, исполненную  часть пометим как отмененную
					НоваяСтрокаТЧ = ДокОст.Товары.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрокаТЧ, СтрокаТЧ);
					НоваяСтрокаТЧ.Отменено = Истина;
					НоваяСтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
					НоваяСтрокаТЧ.КодСтроки = 0;
					
					КоличествоСтарое = СтрокаТЧ.Количество;
					СтрокаТЧ.Количество = ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток;
					КоэффициентПересчета = СтрокаТЧ.Количество / КоличествоСтарое;
					Если ЗначениеЗаполнено(СтрокаТЧ.Упаковка) Тогда
						СтрокаТЧ.КоличествоУпаковок = КоэффициентПересчета * СтрокаТЧ.КоличествоУпаковок;
					Иначе
						СтрокаТЧ.КоличествоУпаковок = СтрокаТЧ.Количество;
					КонецЕсли;
					//Пересчет сумм по количеству
					СтрокаТЧ.Сумма = Окр(СтрокаТЧ.Сумма * КоэффициентПересчета,2);
					СтрокаТЧ.СуммаРучнойСкидки = Окр(СтрокаТЧ.СуммаРучнойСкидки * КоэффициентПересчета,2);
					СтрокаТЧ.СуммаНДС = Окр(СтрокаТЧ.СуммаНДС * КоэффициентПересчета,2);
					СтрокаТЧ.СуммаСНДС = Окр(СтрокаТЧ.СуммаСНДС * КоэффициентПересчета,2);
					СуммаПоЗаказу = СуммаПоЗаказу + СтрокаТЧ.СуммаСНДС;
					
					//Пересчет в новой строке
					НоваяСтрокаТЧ.Количество = НоваяСтрокаТЧ.Количество - СтрокаТЧ.Количество;
					НоваяСтрокаТЧ.КоличествоУпаковок = НоваяСтрокаТЧ.КоличествоУпаковок - СтрокаТЧ.КоличествоУпаковок;
					НоваяСтрокаТЧ.Сумма = НоваяСтрокаТЧ.Сумма - СтрокаТЧ.Сумма;
					НоваяСтрокаТЧ.СуммаРучнойСкидки = НоваяСтрокаТЧ.СуммаРучнойСкидки - СтрокаТЧ.СуммаРучнойСкидки;
					НоваяСтрокаТЧ.СуммаНДС = НоваяСтрокаТЧ.СуммаНДС - СтрокаТЧ.СуммаНДС;
					НоваяСтрокаТЧ.СуммаСНДС = НоваяСтрокаТЧ.СуммаСНДС - СтрокаТЧ.СуммаСНДС;

				КонецЕсли;
			Иначе
				//Остатка по этой строке нет - отменим строку
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
			КонецЕсли;
			ВыборкаСтрокаЗаказа.Сбросить();
		КонецЦикла; // Для Каждого СтрокаТЧ Из ДокОст.Товары Цикл
		// Корректировка в случае пересорта количества в остатках по кодам строк.
		Если ТребуетсяКорректировка.Количество() > 0 Тогда
			Для Каждого ЭлементКорректировки Из ТребуетсяКорректировка Цикл
				НадоЗаказать = 0;
				ВыборкаСтрокаЗаказа.Сбросить();
				Пока ВыборкаСтрокаЗаказа.НайтиСледующий(ЭлементКорректировки) Цикл
					НадоЗаказать = НадоЗаказать + ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток;
				КонецЦикла;
				СтрокиЗаказа = ДокОст.Товары.НайтиСтроки(ЭлементКорректировки);
				КоличествоВЗаказе = 0;
				Для Каждого СтрокаЗаказа Из СтрокиЗаказа Цикл
					Если НЕ СтрокаЗаказа.Отменено И СтрокаЗаказа.Количество > 0 Тогда
						КоличествоВЗаказе = КоличествоВЗаказе + СтрокаЗаказа.Количество;
					КонецЕсли;
				КонецЦикла;
				Если КоличествоВЗаказе = НадоЗаказать Тогда
					Продолжить;
				КонецЕсли;
				КоличествоПрибавить = ?(КоличествоВЗаказе < НадоЗаказать,НадоЗаказать - КоличествоВЗаказе,0);
				КоличествоОтнять = ?(КоличествоВЗаказе > НадоЗаказать,КоличествоВЗаказе - НадоЗаказать,0);
				Для Каждого СтрокаТЧ Из СтрокиЗаказа Цикл
					Если НЕ СтрокаТЧ.Отменено И СтрокаТЧ.Количество > 0 Тогда
						КоличествоСтарое = СтрокаТЧ.Количество;
						СуммаСтарая = СтрокаТЧ.СуммаСНДС;
						Если КоличествоПрибавить > 0 Тогда
							СтрокаТЧ.Количество = СтрокаТЧ.Количество + КоличествоПрибавить;
							КоличествоПрибавить = 0;
						ИначеЕсли КоличествоОтнять > СтрокаТЧ.Количество Тогда
							 // Сбросим количество целиком - отменим строку. Остаток количества заберем у следующей строки.
							СтрокаТЧ.Отменено = Истина;
							СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
							СуммаЗаказа = СуммаЗаказа - СтрокаТЧ.СуммаСНДС;
							КоличествоОтнять = КоличествоОтнять - СтрокаТЧ.Количество;
							Продолжить;
						Иначе
							СтрокаТЧ.Количество = СтрокаТЧ.Количество - КоличествоОтнять;
							КоличествоОтнять = 0;
						КонецЕсли;
						КоэффициентПересчета = СтрокаТЧ.Количество / КоличествоСтарое;
						Если ЗначениеЗаполнено(СтрокаТЧ.Упаковка) Тогда
							СтрокаТЧ.КоличествоУпаковок = КоэффициентПересчета * СтрокаТЧ.КоличествоУпаковок;
						Иначе
							СтрокаТЧ.КоличествоУпаковок = СтрокаТЧ.Количество;
						КонецЕсли;
						//Пересчет сумм по количеству.
						СтрокаТЧ.Сумма = Окр(СтрокаТЧ.Сумма * КоэффициентПересчета,2);
						СтрокаТЧ.СуммаРучнойСкидки = Окр(СтрокаТЧ.СуммаРучнойСкидки * КоэффициентПересчета,2);
						СтрокаТЧ.СуммаНДС = Окр(СтрокаТЧ.СуммаНДС * КоэффициентПересчета,2);
						СтрокаТЧ.СуммаСНДС = Окр(СтрокаТЧ.СуммаСНДС * КоэффициентПересчета,2);
						СуммаПоЗаказу = СуммаПоЗаказу + СтрокаТЧ.СуммаСНДС - СуммаСтарая;
						
						Если КоличествоПрибавить = 0 И КоличествоОтнять = 0 Тогда
							Прервать;
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЦикла;
		КонецЕсли;   // Если ТребуетсяКорректировка.Количество() > 0 Тогда
		//Изменение этапов оплаты
		Если ДокОст.ЭтапыГрафикаОплаты.Количество() > 0 Тогда
			Если ДокОст.ЭтапыГрафикаОплаты.Количество()=1 Тогда
				ДокОст.ЭтапыГрафикаОплаты[0].СуммаПлатежа = СуммаПоЗаказу;
			Иначе
				//убираем лишние суммы пропорционально с каждой строки
				Коэффициент = СуммаПоЗаказу / ДокОст.ЭтапыГрафикаОплаты.Итог("СуммаПлатежа");
				ЗаказСумма = СуммаПоЗаказу;
				Для каждого СтрокаТЧ Из ДокОст.ЭтапыГрафикаОплаты Цикл
					Если ЗаказСумма = 0 Тогда
						Прервать;
					КонецЕсли;
					СтрокаТЧ.СуммаПлатежа = Окр(СтрокаТЧ.СуммаПлатежа * Коэффициент, 2);
					ЗаказСумма = ЗаказСумма - СтрокаТЧ.СуммаПлатежа;
				КонецЦикла;
				Если ЗаказСумма <> 0 Тогда
					ДокОст.ЭтапыГрафикаОплаты[0].СуммаПлатежа = ДокОст.ЭтапыГрафикаОплаты[0].СуммаПлатежа + ЗаказСумма;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		//Очистим движения данного заказа, чтобы при перепроведении не мешал контроль остатков.
		ОчиститьНаборыЗаписейДвиженийДокумента(МассивРегистров, ВыборкаЗаказ.Заказ);
		// Удалим движения по регистру ЗаказыПоставщикам по этому заказу до даты свертки, чтобы не мешал контроль остатков.
		УдалитьДвиженияПоЗаказу("ЗаказыПоставщикам", "ЗаказПоставщику",  ВыборкаЗаказ.Заказ);
		
		ПровестиИлиЗаписатьДокумент(ДокОст);
	КонецЦикла; // Пока ВыборкаЗаказ.Следующий() Цикл
	ВывестиСообщениеСформированыДокументы("ЗаказПоставщику",,Истина);

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковЗаявкиНаВозврат()
	//1. Возвращаемые товары
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.ЗаявкаНаВозвратТоваровОтКлиента КАК Заказ,
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.КодСтроки КАК КодСтроки,
	|ТабРег.ЗаявкаНаВозвратТоваровОтКлиента.Комментарий КАК Комментарий,
	|ТабРег.ЗаявленоКонечныйОстаток КАК ЗаявленоКонечныйОстаток,
	|ТабРег.ЗаявленоРасход КАК ЗаявленоРасход
	|ИЗ РегистрНакопления.ЗаявкиНаВозвратТоваровОтКлиентов.ОстаткиИОбороты(,&ГраницаОст) КАК ТабРег
	|ГДЕ ТабРег.ЗаявленоКонечныйОстаток>0 ИЛИ ТабРег.ЗаявленоРасход>0
	|ИТОГИ Сумма(ТабРег.ЗаявленоКонечныйОстаток), Сумма(ТабРег.ЗаявленоРасход)
	|ПО Заказ";

	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	МассивРегистров = РегистрыНакопленияДокумента("ЗаявкаНаВозвратТоваровОтКлиента");
	
	ВыборкаЗаказ = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаЗаказ.Следующий() Цикл
		Если ВыборкаЗаказ.ЗаявленоКонечныйОстаток = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Если ВыборкаЗаказ.ЗаявленоРасход = 0 Тогда
			//Заказ не начал выполняться. Оставляем его как есть
			ДокОст = ВыборкаЗаказ.Заказ.ПолучитьОбъект();
			Если ДокОст <> Неопределено Тогда
				ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
				ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КонецЕсли;
			Продолжить;
		КонецЕсли;
		//Заказ начал выполняться. Надо сформировать остатки в соответствии с текущим состоянием заказа
		ДокОст = ВыборкаЗаказ.Заказ.ПолучитьОбъект();
		Если ДокОст <> Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ЗафиксироватьИзменениеДокументовВПараметрСвертки();
		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		//Очистим движения данного заказа, чтобы при перепроведении не мешал контроль остатков
		ОчиститьНаборыЗаписейДвиженийДокумента(МассивРегистров, ВыборкаЗаказ.Заказ);

		ВыборкаСтрокаЗаказа = ВыборкаЗаказ.Выбрать();
		Для Каждого СтрокаТЧ Из ДокОст.ВозвращаемыеТовары Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			КонецЕсли;
			
			СтруктураОтбора = Новый Структура("Номенклатура, Характеристика, КодСтроки");
			ЗаполнитьЗначенияСвойств(СтруктураОтбора, СтрокаТЧ);

			Если ВыборкаСтрокаЗаказа.НайтиСледующий(СтруктураОтбора) Тогда
				Если ВыборкаСтрокаЗаказа.ЗаявленоКонечныйОстаток = 0 Тогда
					СтрокаТЧ.Отменено = Истина;
					ВыборкаСтрокаЗаказа.Сбросить();
					Продолжить;
				КонецЕсли;
				
				КоличествоСтарое = СтрокаТЧ.Количество;
				СтрокаТЧ.Количество = ВыборкаСтрокаЗаказа.ЗаявленоКонечныйОстаток;
				КоэффициентПересчета = СтрокаТЧ.Количество / КоличествоСтарое;
				Если ЗначениеЗаполнено(СтрокаТЧ.Упаковка) Тогда
					СтрокаТЧ.КоличествоУпаковок = КоэффициентПересчета * СтрокаТЧ.КоличествоУпаковок;
				Иначе
					СтрокаТЧ.КоличествоУпаковок = СтрокаТЧ.Количество;
				КонецЕсли;
				//Пересчет сумм по количеству
				СтрокаТЧ.Сумма = Окр(СтрокаТЧ.Сумма * КоэффициентПересчета,2);
				СтрокаТЧ.СуммаНДС = Окр(СтрокаТЧ.СуммаНДС * КоэффициентПересчета,2);
				СтрокаТЧ.СуммаСНДС = Окр(СтрокаТЧ.СуммаСНДС * КоэффициентПересчета,2);
			Иначе
				//Остатка по этой строке нет - отменим строку
				СтрокаТЧ.Отменено = Истина;
			КонецЕсли;
			ВыборкаСтрокаЗаказа.Сбросить();
		КонецЦикла;
		
		ПровестиИлиЗаписатьДокумент(ДокОст);
	КонецЦикла;

	//2. Заменяющие товары
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.ЗаказКлиента КАК Заказ,
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.КодСтроки КАК КодСтроки,
	|ТабРег.Склад КАК Склад,
	|ТабРег.ЗаказаноКонечныйОстаток КАК ЗаказаноКонечныйОстаток,
	|ТабРег.СуммаКонечныйОстаток КАК СуммаКонечныйОстаток,
	|ТабРег.ЗаказаноРасход КАК ЗаказаноРасход
	|ИЗ РегистрНакопления.ЗаказыКлиентов.ОстаткиИОбороты(,&ГраницаОст) КАК ТабРег
	|ГДЕ (ТабРег.ЗаказаноКонечныйОстаток>0 ИЛИ ТабРег.ЗаказаноРасход>0) 
	|	И ТабРег.ЗаказКлиента ССЫЛКА Документ.ЗаявкаНаВозвратТоваровОтКлиента
	|ИТОГИ Максимум(ТабРег.ЗаказаноКонечныйОстаток), Максимум(ТабРег.СуммаКонечныйОстаток), Максимум(ТабРег.ЗаказаноРасход), 
	|	Максимум(КодСтроки), Максимум(Номенклатура), Максимум(Характеристика)
	|ПО Заказ, КодСтроки";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	
	//Определим причину отмены заказов
	ПричинаОтменыЗаказа = Справочники.ПричиныОтменыЗаказовКлиентов.НайтиПоНаименованию(НСтр("ru='#Свертка базы';uk='#Згортка бази'"));
	Если ПричинаОтменыЗаказа = Неопределено ИЛИ ПричинаОтменыЗАказа.Пустая() Тогда
		ПричинаОтменыЗаказаОбъект = Справочники.ПричиныОтменыЗаказовКлиентов.СоздатьЭлемент();
		ПричинаОтменыЗаказаОбъект.Наименование = НСтр("ru='#Свертка базы';uk='#Згортка бази'");
		ПричинаОтменыЗаказаОбъект.Записать();
		ПричинаОтменыЗаказа = ПричинаОтменыЗаказаОбъект.Ссылка;
	КонецЕсли;
	
	Результат = Запрос.Выполнить();
	ВыборкаЗаказ = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаЗаказ.Следующий() Цикл
		Если ВыборкаЗаказ.ЗаказаноКонечныйОстаток = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Если ВыборкаЗаказ.ЗаказаноРасход = 0 Тогда
			//Заказ не начал выполняться. Оставляем его как есть
			ДокОст = ВыборкаЗаказ.Заказ.ПолучитьОбъект();
			Если ДокОст <> Неопределено Тогда
				ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
				ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КонецЕсли;
			Продолжить;
		КонецЕсли;
		//Заказ начал выполняться. Надо сформировать остатки в соответствии с текущим состоянием заказа
		ДокОст = ВыборкаЗаказ.Заказ.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ЗафиксироватьИзменениеДокументовВПараметрСвертки();
		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		//Очистим движения данного заказа, чтобы при перепроведении не мешал контроль остатков
		Для Каждого Рег ИЗ МассивРегистров Цикл
			НаборЗаписей = РегистрыНакопления[Рег].СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаЗаказ.Заказ);
			НаборЗаписей.Записать();
		КонецЦикла;

		ВыборкаСтрокаЗаказа = ВыборкаЗаказ.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Для Каждого СтрокаТЧ Из ДокОст.ЗаменяющиеТовары Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			КонецЕсли;
			
			СтруктураОтбора = Новый Структура("Номенклатура, Характеристика, КодСтроки");
			ЗаполнитьЗначенияСвойств(СтруктураОтбора, СтрокаТЧ);

			Если ВыборкаСтрокаЗаказа.НайтиСледующий(СтруктураОтбора) Тогда
				Если ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток = СтрокаТЧ.Количество Тогда
					//Заказанное количество не поменялось. Оставляем строку без изменений
				ИначеЕсли ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток = 0 Тогда
					СтрокаТЧ.Отменено = Истина;
					СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
				Иначе
					//Разделим строку на две, исполненную часть пометим как отмененную
					//Новая строка - копия старой строки
					НоваяСтрокаТЧ = ДокОст.ЗаменяющиеТовары.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрокаТЧ, СтрокаТЧ);
					НоваяСтрокаТЧ.КодСтроки = 0;
					НоваяСтрокаТЧ.КлючСвязи = 0;
					НоваяСтрокаТЧ.Отменено = Истина;
					НоваяСтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
					
					КоличествоСтарое = СтрокаТЧ.Количество;
					СтрокаТЧ.Количество = ВыборкаСтрокаЗаказа.ЗаказаноКонечныйОстаток;
					КоэффициентПересчета = СтрокаТЧ.Количество / КоличествоСтарое;
					СтрокаТЧ.Сумма = ВыборкаСтрокаЗаказа.СуммаКонечныйОстаток;
					//Пересчитаем другие суммы по количеству
					СтрокаТЧ.СуммаНДС = Окр(СтрокаТЧ.СуммаНДС * КоэффициентПересчета,2);
					СтрокаТЧ.КоличествоУпаковок = СтрокаТЧ.КоличествоУпаковок * КоэффициентПересчета;
					СтрокаТЧ.СуммаСНДС = Окр(СтрокаТЧ.СуммаСНДС * КоэффициентПересчета,2);
					//Если есть скидки, перезаполним
					Если СтрокаТЧ.СуммаРучнойСкидки > 0 ИЛИ СтрокаТЧ.СуммаАвтоматическойСкидки > 0 Тогда
						СтрокаТЧ.СуммаРучнойСкидки = Окр(СтрокаТЧ.СуммаРучнойСкидки * КоэффициентПересчета,2);
						СтрокаТЧ.СуммаАвтоматическойСкидки = Окр(СтрокаТЧ.СуммаАвтоматическойСкидки * КоэффициентПересчета,2);
						СтрокиСкидки = ДокОст.СкидкиНаценки.НайтиСтроки(Новый Структура("КлючСвязи", СтрокаТЧ.КлючСвязи));
						Для Каждого СтрокаСкидки ИЗ СтрокиСкидки Цикл
							СтрокаСкидки.Сумма = Окр(СтрокаСкидки.Сумма * КоэффициентПересчета,2);
						КонецЦикла;
					КонецЕсли;
					
					//Скорректируем данные новой строки ТЧ
					НоваяСтрокаТЧ.Количество = НоваяСтрокаТЧ.Количество - СтрокаТЧ.Количество;
					НоваяСтрокаТЧ.Сумма = НоваяСтрокаТЧ.Сумма - СтрокаТЧ.Сумма;
					НоваяСтрокаТЧ.СуммаНДС = НоваяСтрокаТЧ.СуммаНДС - СтрокаТЧ.СуммаНДС;
					НоваяСтрокаТЧ.КоличествоУпаковок = НоваяСтрокаТЧ.КоличествоУпаковок - СтрокаТЧ.КоличествоУпаковок;
					НоваяСтрокаТЧ.СуммаСНДС = НоваяСтрокаТЧ.СуммаСНДС - СтрокаТЧ.СуммаСНДС;
					НоваяСтрокаТЧ.СуммаРучнойСкидки = НоваяСтрокаТЧ.СуммаРучнойСкидки - СтрокаТЧ.СуммаРучнойСкидки;
					НоваяСтрокаТЧ.СуммаАвтоматическойСкидки = НоваяСтрокаТЧ.СуммаАвтоматическойСкидки - СтрокаТЧ.СуммаАвтоматическойСкидки;
				КонецЕсли;
			Иначе
				//Остатка по этой строке нет - отменим строку целиком
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
			КонецЕсли;
			ВыборкаСтрокаЗаказа.Сбросить();
		КонецЦикла;
		//Изменение этапов оплаты
		Если ДокОст.ЭтапыГрафикаОплаты.Количество() > 0 Тогда
			Если ДокОст.ЭтапыГрафикаОплаты.Количество()=1 Тогда
				ДокОст.ЭтапыГрафикаОплаты[0].СуммаПлатежа = ВыборкаЗаказ.СуммаКонечныйОстаток;
			Иначе
				//убираем лишние суммы пропорционально с каждой строки
				Коэффициент = ВыборкаЗаказ.СуммаКонечныйОстаток / ДокОст.ЭтапыГрафикаОплаты.Итог("СуммаПлатежа");
				ЗаказСумма = ВыборкаЗаказ.СуммаКонечныйОстаток;
				Для каждого СтрокаТЧ Из ДокОст.ЭтапыГрафикаОплаты Цикл
					Если ЗаказСумма = 0 Тогда
						Прервать;
					КонецЕсли;
					СтрокаТЧ.СуммаПлатежа = Окр(СтрокаТЧ.СуммаПлатежа * Коэффициент, 2);
					ЗаказСумма = ЗаказСумма - СтрокаТЧ.СуммаПлатежа;
				КонецЦикла;
				Если ЗаказСумма <> 0 Тогда
					ДокОст.ЭтапыГрафикаОплаты[0].СуммаПлатежа = ДокОст.ЭтапыГрафикаОплаты[0].СуммаПлатежа + ЗаказСумма;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		ПровестиИлиЗаписатьДокумент(ДокОст);
	КонецЦикла;

	ВывестиСообщениеСформированыДокументы("ЗаявкаНаВозвратТоваровОтКлиента",,Истина);

КонецПроцедуры

Процедура ОбработатьОстаткиДенежныеСредстваКПоступлениюИСписанию()
	Запрос = Новый Запрос;
	
	Запрос.Текст = "ВЫБРАТЬ 
	|	ТабРег.Организация,
	|	ТабРег.БанковскийСчет,
	|	ТабРег.КЗачислениюОстаток КАК КЗачислениюОстаток,
	|	ТабРег.КСписаниюОстаток КАК КСписаниюОстаток,
	|	ТабРегОбороты.Регистратор КАК Документ,
	|	ВЫБОР КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Дата
	|	КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.СписаниеБезналичныхДенежныхСредств).Дата
	|	КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.РасходныйКассовыйОрдер ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.РасходныйКассовыйОрдер).Дата
	|	КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.ПриходныйКассовыйОрдер ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.ПриходныйКассовыйОрдер).Дата
	|	КОНЕЦ КАК Дата,
	|	ВЫБОР КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Проведен
	|	КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.СписаниеБезналичныхДенежныхСредств).Проведен
	|	КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.РасходныйКассовыйОрдер ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.РасходныйКассовыйОрдер).Проведен
	|	КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.ПриходныйКассовыйОрдер ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.ПриходныйКассовыйОрдер).Проведен
	|	КОНЕЦ КАК ДокументПроведен,
	|	ЕстьNULL(ТабРегОбороты.КСписаниюПриход,0) КАК КСписаниюПриход,
	|	ЕстьNULL(ТабРегОбороты.КЗачислениюПриход,0) КАК КЗачислениюПриход
	|ИЗ РегистрНакопления.ДенежныеСредстваБезналичные.Остатки(&ГраницаОст) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ
	|	РегистрНакопления.ДенежныеСредстваБезналичные.Обороты(,&ГраницаОст,Регистратор) КАК ТабРегОбороты
	|ПО ТабРег.Организация = ТабРегОбороты.Организация
	|И ТабРег.БанковскийСчет = ТабРегОбороты.БанковскийСчет 
	|ГДЕ ТабРегОбороты.Регистратор ЕСТЬ НЕ NULL
	|	И ((ТабРег.КЗачислениюОстаток > 0 И ЕстьNULL(ТабРегОбороты.КЗачислениюПриход,0) > 0) 
	|	ИЛИ (ТабРег.КСписаниюОстаток > 0 И ЕстьNULL(ТабРегОбороты.КСписаниюПриход,0) > 0))
	|УПОРЯДОЧИТЬ ПО 
	|	ВЫБОР КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.ПоступлениеБезналичныхДенежныхСредств ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.ПоступлениеБезналичныхДенежныхСредств).Дата
	|	КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.СписаниеБезналичныхДенежныхСредств ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.СписаниеБезналичныхДенежныхСредств).Дата
	|	КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.РасходныйКассовыйОрдер ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.РасходныйКассовыйОрдер).Дата
	|	КОГДА ТабРегОбороты.Регистратор ССЫЛКА Документ.ПриходныйКассовыйОрдер ТОГДА
	|		ВЫРАЗИТЬ(ТабРегОбороты.Регистратор КАК Документ.ПриходныйКассовыйОрдер).Дата
	|	КОНЕЦ УБЫВ
	|ИТОГИ
	|	Сумма(ТабРег.КЗачислениюОстаток),
	|	Сумма(ТабРег.КСписаниюОстаток)
	|ПО
	|	ТабРег.Организация,
	|	ТабРег.БанковскийСчет 
	|";

	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	ЗафиксироватьИзменениеДокументовВПараметрСвертки();

	//Документ, сформировавший начальный остаток, надо перенести после даты свертки
	ВыборкаОрганизация = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаОрганизация.Следующий() Цикл
		ВыборкаБанковскийСчет = ВыборкаОрганизация.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаБанковскийСчет.Следующий() Цикл
			СуммаКЗачислению = ВыборкаБанковскийСчет.КЗачислениюОстаток;
			СуммаКСписанию = ВыборкаБанковскийСчет.КСписаниюОстаток;
			Выборка = ВыборкаБанковскийСчет.Выбрать();
			Пока Выборка.Следующий() Цикл
				Если СуммаКЗачислению = 0 И СуммаКСписанию = 0 Тогда
					Прервать;
				КонецЕсли;
				ПереноситьДокумент = Ложь;
				Если Выборка.КЗачислениюПриход > 0 Тогда
					Если Выборка.КЗачислениюПриход > СуммаКЗачислению Тогда
						Продолжить;
					КонецЕсли;
					ДокОст = Выборка.Документ.ПолучитьОбъект();
					Если ДокОст = Неопределено тогда
						Продолжить;
					КонецЕсли;
					СуммаКЗачислению = СуммаКЗачислению - Выборка.КЗачислениюПриход;
					ПереноситьДокумент = Истина;
				ИначеЕсли Выборка.КСписаниюПриход > 0 Тогда
					Если Выборка.КСписаниюПриход > СуммаКСписанию Тогда
						Продолжить;
					КонецЕсли;
					ДокОст = Выборка.Документ.ПолучитьОбъект();
					Если ДокОст = Неопределено тогда
						Продолжить;
					КонецЕсли;
					СуммаКСписанию = СуммаКСписанию - Выборка.КСписаниюПриход;
					ПереноситьДокумент = Истина;
				КонецЕсли;
				Если НЕ ПереноситьДокумент Тогда
					Продолжить;
				КонецЕсли;
				ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
				Если Выборка.ДокументПроведен Тогда
					// Сначала записать документ с отменой проведения.
					Попытка
						ДокОст.Записать(РежимЗаписиДокумента.ОтменаПроведения);
					Исключение
						ТекстСообщения = НСтр("ru='Не удалось отменить проведение документа';uk='Не вдалося скасувати проведення документа'") + ": " + СокрЛП(ДокОст.Ссылка);
						СообщениеСвертки(ТекстСообщения, Истина, ОписаниеОшибки());
						Продолжить;
					КонецПопытки;
				КонецЕсли;
				ДокОст.Дата = КонецДня(ДатаСверткиИБ) + 1;
				ПроверитьНомерДокумента(ДокОст, Выборка.Дата);
				Если ТипЗнч(Выборка.Документ) <> Тип("ДокументСсылка.ОтчетБанкаПоОперациямЭквайринга") Тогда
					ТекстКомментария = НСтр("ru='[Перенесен обработкой свертки базы][Был %1%]';uk='[Перенесено обробкою згортки бази] [Був %1%]'");
					ТекстКомментария = СтрЗаменить(ТекстКомментария,"%1%", СокрЛП(Выборка.Документ));
					ДокОст.Комментарий = ТекстКомментария;
				КонецЕсли;
				Если Выборка.ДокументПроведен Тогда
					// Проведение измененного документа.
					ПроведенУспешно = Ложь;
					Попытка
						ДокОст.Записать(РежимЗаписиДокумента.Проведение);
						ПроведенУспешно = Истина;
					Исключение
						ТекстСообщения = НСтр("ru='Не удалось провести документ';uk='Не вдалося провести документ'") + ": " + СокрЛП(ДокОст.Ссылка);
						СообщениеСвертки(ТекстСообщения, Истина, ОписаниеОшибки());
					КонецПопытки;
					Если НЕ ПроведенУспешно Тогда
						ДокОст.Записать(РежимЗаписиДокумента.Запись);
					КонецЕсли;
				Иначе
					ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
	ТекстСообщения = НСтр("ru='Обработаны Денежные средства безналичные к зачислению и Денежные средства безналичные к списанию';uk='Оброблені Грошові кошти безготівкові до зарахування та Грошові кошти безготівкові до списання'");
	СообщениеСвертки(ТекстСообщения);
КонецПроцедуры

Процедура ОбработатьОстаткиТоварыКОтгрузке()
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ 
	|ТабРег.ДокументОтгрузки КАК ДокументОтгрузки,
	|ТабРегОбороты.Регистратор КАК ДокументОрдер,
	|ТабРег.КОтгрузкеОстаток КАК КОтгрузке,
	|ТабРегОбороты.КОтгрузкеРасход КАК Отгружено
	|ИЗ РегистрНакопления.ТоварыКОтгрузке.Остатки(&ГраницаОст) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКОтгрузке.Обороты(&ГраницаОст,,Регистратор) КАК ТабРегОбороты
	|ПО ТабРегОбороты.ДокументОтгрузки = ТабРег.ДокументОтгрузки 
	|ГДЕ ТабРег.КОтгрузкеОстаток > 0  И ТабРегОбороты.Регистратор ЕСТЬ НЕ NULL
	|";
	
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	МассивОрдеров = Новый Массив;
	Пока Выборка.Следующий() Цикл
		ДокОст = Выборка.ДокументОрдер.ПолучитьОбъект();
		Если ДокОст = Неопределено тогда
			Продолжить;
		КонецЕсли;

		ДокОст.Комментарий = Комментарий_УдалитьПриСверткеБазы;
		ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
		ДокОст.Записать(РежимЗаписиДокумента.Проведение);
		МассивОрдеров.Добавить(Выборка.ДокументОрдер);
	КонецЦикла;
	
	//Поиск документов Отбор, размещение товаров оформленных по ордеру
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ 
	|Док.Ссылка КАК ДокументОтбора
	|ИЗ Документ.ОтборРазмещениеТоваров КАК Док
	|ГДЕ Док.Распоряжение В (&МассивОрдеров) И НЕ Док.ПометкаУдаления
	|";
	Запрос.УстановитьПараметр("МассивОрдеров", МассивОрдеров);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ДокОст = Выборка.ДокументОтбора.ПолучитьОбъект();
		Если ДокОст = Неопределено тогда
			Продолжить;
		КонецЕсли;

		ДокОст.Комментарий = Комментарий_УдалитьПриСверткеБазы;
		ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
		ДокОст.Записать(РежимЗаписиДокумента.Запись);
	КонецЦикла;
	
	СообщениеСвертки(НСтр("ru='Обработаны Товары к отгрузке';uk='Оброблені Товари до відвантаження'"));

КонецПроцедуры

Процедура ОбработатьОстаткиТоварыКПоступлению()
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ТабРег.ДокументПоступления КАК ДокументПоступления,
	|	ТабРегОбороты.Регистратор КАК ДокументОрдер,
	|	ТабРег.КОформлениюОрдеровОстаток КАК КПоступлению,
	|	ТабРег.КОформлениюПоступленийПоРаспоряжениюОстаток КАК КОформлению
	|ИЗ РегистрНакопления.ТоварыКПоступлению.Остатки(&ГраницаОст) КАК ТабРег
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКПоступлению.Обороты(&ГраницаОст,,Регистратор) КАК ТабРегОбороты
	|ПО ТабРегОбороты.ДокументПоступления = ТабРег.ДокументПоступления 
	|ГДЕ ТабРег.КОформлениюОрдеровОстаток > 0 Или ТабРег.КОформлениюПоступленийПоРаспоряжениюОстаток > 0
	|ИТОГИ Сумма(КПоступлению), Сумма(КОформлению) ПО ДокументПоступления";
	
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	ВыборкаДокументПоступления = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаДокументПоступления.Следующий() Цикл
		ТипДокументаПоступления = ТипЗнч(ВыборкаДокументПоступления.ДокументПоступления);
		Если ТипДокументаПоступления = Тип("ДокументСсылка.ЗаказПоставщику") ИЛИ
			ТипДокументаПоступления = Тип("ДокументСсылка.ЗаявкаНаВозвратТоваровОтКлиента") Тогда
			Если Найти(ВыборкаДокументПоступления.ДокументПоступления.Комментарий, Комментарий_НеУдалятьПриСверткеБазы) > 0 Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		ВыборкаОрдер = ВыборкаДокументПоступления.Выбрать();
		Пока ВыборкаОрдер.Следующий() Цикл
			Если НЕ ЗначениеЗаполнено(ВыборкаОрдер.ДокументОрдер) Тогда
				Продолжить;
			КонецЕсли;

			ДокОст = ВыборкаОрдер.ДокументОрдер.ПолучитьОбъект();
			Если ДокОст = Неопределено тогда
				Продолжить;
			КонецЕсли;

			ДокОст.Комментарий = Комментарий_УдалитьПриСверткеБазы;
			ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
			ДокОст.Записать(РежимЗаписиДокумента.Проведение);
		КонецЦикла;
	КонецЦикла;
	СообщениеСвертки(НСтр("ru='Обработаны Товары к поступлению';uk='Опрацьовані Товари до надхдження'"));

КонецПроцедуры

Процедура ОбработатьОстаткиТоварыКОтбору()
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ 
	|ТабРег.Распоряжение КАК Распоряжение,
	|ТабРегОбороты.Регистратор КАК ДокументОтбор,
	|ТабРег.КОтборуОстаток КАК КОтбору
	|ИЗ РегистрНакопления.ТоварыКОтбору.Остатки(&ГраницаОст) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКОтбору.Обороты(&ГраницаОст,,Регистратор) КАК ТабРегОбороты
	|ПО ТабРегОбороты.Распоряжение = ТабРег.Распоряжение 
	|ГДЕ ТабРег.КОтборуОстаток > 0
	|ИТОГИ Максимум(КОтбору) ПО ТабРег.Распоряжение";
	
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	ВыборкаРаспоряжение = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаРаспоряжение.Следующий() Цикл
		ВыборкаОтбор = ВыборкаРаспоряжение.Выбрать();
		Пока ВыборкаОтбор.Следующий() Цикл
			Если НЕ ЗначениеЗаполнено(ВыборкаОтбор.ДокументОтбор) Тогда
				Продолжить;
			КонецЕсли;

			ДокОст = ВыборкаОтбор.ДокументОтбор.ПолучитьОбъект();
			Если ДокОст = Неопределено тогда
				Продолжить;
			КонецЕсли;

			ДокОст.Комментарий = Комментарий_УдалитьПриСверткеБазы;
			ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
			ДокОст.Записать(РежимЗаписиДокумента.Проведение);
		КонецЦикла;
	КонецЦикла;
	СообщениеСвертки(НСтр("ru='Обработаны Товары к отбору';uk='Оброблені Товари до відбору'"));

КонецПроцедуры

Процедура ОбработатьБлокировкиСкладскихЯчеек()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ 
	|Регистратор КАК Документ
	|ИЗ РегистрСведений.БлокировкиСкладскихЯчеек
	|ГДЕ Регистратор ССЫЛКА Документ.УстановкаБлокировокЯчеек
	|И Регистратор.Дата <= &ДатаОст";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		ДокОст = Выборка.Документ.ПолучитьОбъект();
		Если ДокОст = Неопределено тогда
			Продолжить;
		КонецЕсли;

		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
		ДокОст.Записать(РежимЗаписиДокумента.Проведение);
	КонецЦикла;
	СообщениеСвертки(НСтр("ru='Обработаны Блокировки складских ячеек';uk='Оброблені Блокування складських комірок'"));

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковПодарочныеСертификаты()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ИсторияПСРег.ПодарочныйСертификат КАК ПодарочныйСертификат,
	|Максимум(ИсторияПСРег.Регистратор) КАК РегистраторАктивации,
	|Максимум(ИсторияПСРег.Период) КАК ДатаАктивации
	|ПОМЕСТИТЬ ИсторияПС
	|ИЗ  РегистрСведений.ИсторияПодарочныхСертификатов КАК ИсторияПСРег
	|ГДЕ ИсторияПСРег.Период <= &ДатаОст И
	|	ИсторияПСРег.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыПодарочныхСертификатов.Активирован)
	|СГРУППИРОВАТЬ ПО ИсторияПСРег.ПодарочныйСертификат 
	|;
	|ВЫБРАТЬ
	|ОстаткиПС.ПодарочныйСертификат.Владелец КАК ВидПодарочногоСертификата,
	|ОстаткиПС.ПодарочныйСертификат.Владелец.Валюта КАК ВалютаПодарочногоСертификата,
	|ОстаткиПС.ПодарочныйСертификат КАК ПодарочныйСертификат,
	|ОстаткиПС.ПодарочныйСертификат.Штрихкод КАК Штрихкод,
	|ОстаткиПС.ПодарочныйСертификат.МагнитныйКод КАК МагнитныйКод,
	|ОстаткиПС.ПодарочныйСертификат.Код КАК СерийныйНомер,
	|ОстаткиПС.СуммаОстаток КАК СуммаВВалютеСертификата,
	|ЕстьNULL(ИсторияПС.ДатаАктивации, &ДатаОст) КАК ДатаАктивации,
	|ЕстьNULL(ИсторияПС.РегистраторАктивации.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)) КАК Организация,
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковПодарочныхСертификатов) КАК ХозяйственнаяОперация
	|ИЗ РегистрНакопления.ПодарочныеСертификаты.Остатки(&ГраницаОст) КАК ОстаткиПС
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ИсторияПодарочныхСертификатов.СрезПоследних(&ГраницаОст) КАК СрезПС
	|ПО ОстаткиПС.ПодарочныйСертификат = СрезПС.ПодарочныйСертификат
	|ЛЕВОЕ СОЕДИНЕНИЕ ИсторияПС КАК ИсторияПС
	|ПО ИсторияПС.ПодарочныйСертификат = ОстаткиПС.ПодарочныйСертификат
	|ГДЕ ОстаткиПС.СуммаОстаток > 0 И
	|	ИсторияПС.ДатаАктивации ЕСТЬ НЕ NULL И
	|	(СрезПС.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыПодарочныхСертификатов.Активирован) ИЛИ
	|	СрезПС.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыПодарочныхСертификатов.ЧастичноПогашен))
	|УПОРЯДОЧИТЬ ПО 
	|	ЕстьNULL(ИсторияПС.РегистраторАктивации.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)), 
	|	ВидПодарочногоСертификата, 
	|	ЕстьNULL(ИсторияПС.ДатаАктивации, &ДатаОст), 
	|	ПодарочныйСертификат";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	КоличествоСформированныхДокументов = 1;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("ВидПодарочногоСертификата") Цикл
			ДокОст = Документы.ВводОстатковОПродажахЗаПрошлыеПериоды.СоздатьДокумент();
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
			Пока Выборка.Следующий() Цикл
				НоваяСтрока = ДокОст.ПодарочныеСертификаты.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
				Если Выборка.ВалютаПодарочногоСертификата = ВалютаРегламентированногоУчета Тогда
					НоваяСтрока.СуммаРегл = Выборка.СуммаВВалютеСертификата;
				Иначе
					КоэффициентПересчета = КурсыВалют.Получить(Выборка.ВалютаПодарочногоСертификата);
					Если КоэффициентПересчета = Неопределено Тогда
						КоэффициентПересчета = 
							РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(
														Выборка.ВалютаПодарочногоСертификата, 
														ВалютаРегламентированногоУчета, ДокОст.Дата);
						КурсыВалют.Вставить(Выборка.ВалютаПодарочногоСертификата, КоэффициентПересчета); 
					КонецЕсли;
					
					НоваяСтрока.СуммаРегл = Окр(Выборка.Выборка.СуммаВВалютеСертификата * КоэффициентПересчета, 2, 1);
				КонецЕсли;
				Если Выборка.ВалютаПодарочногоСертификата = ВалютаУправленческогоУчета Тогда
					НоваяСтрока.СуммаУпр = Выборка.СуммаВВалютеСертификата;
				Иначе
					КоэффициентПересчета = РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(Выборка.СуммаВВалютеСертификата, ВалютаУправленческогоУчета, ДокОст.Дата);
					НоваяСтрока.СуммаУпр = Окр(Выборка.СуммаВВалютеСертификата * КоэффициентПересчета, 2, 1);
				КонецЕсли;
				
				Если ДокОст.ПодарочныеСертификаты.Количество() >= КоличествоСтрокВДокументеВводаОстатков Тогда
					ДокОст.Записать(РежимЗаписиДокумента.Запись);
					КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
					ДокОст = Документы.ВводОстатковОПродажахЗаПрошлыеПериоды.СоздатьДокумент();
					ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
				КонецЕсли;
			КонецЦикла;
			Если ДокОст.ПодарочныеСертификаты.Количество() > 0 Тогда
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
			КонецЕсли;
		КонецЦикла;  //Пока Выборка.СледующийПоЗначениюПоля("ВидПодарочногоСертификата") Цикл
	КонецЦикла;//Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковОПродажахЗаПрошлыеПериоды",Перечисления.ХозяйственныеОперации.ВводОстатковПодарочныхСертификатов);
	КонецЕсли;
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковПрочиеРасходы()
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ 
	|	ТабРег.Организация КАК Организация,
	|	ТабРег.Подразделение КАК Подразделение,
	|	ТабРег.СтатьяРасходов КАК СтатьяРасходов,
	|	ТабРег.АналитикаРасходов КАК АналитикаРасходов,
	|	Сумма(ТабРег.СуммаОстаток) КАК Сумма,
	|	Сумма(ТабРег.СуммаУпрОстаток) КАК СуммаУпр,
	|	Сумма(ТабРег.СуммаБезНДСОстаток) КАК СуммаБезНДС,
	|	Сумма(ТабРег.СуммаРеглОстаток) КАК СуммаРегл,
	|	Сумма(ТабРег.ПостояннаяРазницаОстаток) КАК СуммаПР,
	|	Сумма(ТабРег.ВременнаяРазницаОстаток) КАК СуммаВР,
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковПрочихРасходов) КАК ХозяйственнаяОперация
	|ИЗ РегистрНакопления.ПрочиеРасходы.Остатки(&ГраницаОст) КАК ТабРег
	|СГРУППИРОВАТЬ ПО
	|	ТабРег.Организация,
	|	ТабРег.Подразделение,
	|	ТабРег.СтатьяРасходов,
	|	ТабРег.АналитикаРасходов
	|ИМЕЮЩИЕ Сумма(ТабРег.СуммаОстаток) > 0
	|	ИЛИ Сумма(ТабРег.СуммаУпрОстаток) > 0
	|	ИЛИ Сумма(ТабРег.СуммаБезНДСОстаток) > 0
	|	ИЛИ Сумма(ТабРег.СуммаРеглОстаток) > 0
	|	ИЛИ Сумма(ТабРег.ПостояннаяРазницаОстаток) > 0
	|	ИЛИ Сумма(ТабРег.ВременнаяРазницаОстаток) > 0
	|УПОРЯДОЧИТЬ ПО Организация, Подразделение";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	КоличествоСформированныхДокументов = 1;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Подразделение") Цикл
			ДокОст = Документы.ВводОстатковПрочиеРасходы.СоздатьДокумент();
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
			Пока Выборка.Следующий() Цикл
				НоваяСтрока = ДокОст.ПрочиеРасходы.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
				НоваяСтрока.СуммаНДС = Макс(НоваяСтрока.Сумма - НоваяСтрока.СуммаБезНДС, 0);
				Если НоваяСтрока.СуммаНДС > 0 И НоваяСтрока.СуммаРегл > 0 
					И НоваяСтрока.Сумма > 0 Тогда
					НоваяСтрока.НДСРегл = Окр(НоваяСтрока.СуммаНДС * НоваяСтрока.СуммаРегл / НоваяСтрока.Сумма, 0);
				КонецЕсли;
				ЗаполнитьСтавкуНДСВСтрокеДокумента(НоваяСтрока);
				// Без суммы документ не проведется.
				Если НоваяСтрока.Сумма = 0 Тогда
					НоваяСтрока.Сумма = 0.01;
				КонецЕсли;
			КонецЦикла;
			КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
		КонецЦикла;
	КонецЦикла;
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковПрочиеРасходы", 
									Перечисления.ХозяйственныеОперации.ВводОстатковПрочихРасходов);
	КонецЕсли;

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковФинансовыйРезультат()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ТабРег.Организация КАК Организация,
	|	ТабРег.Подразделение КАК Подразделение,
	|	ТабРег.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ТабРег.СтатьяРасходов КАК СтатьяРасходов,
	|	ТабРег.СтатьяДоходов КАК СтатьяДоходов,
	|	КОНЕЦПЕРИОДА(ТабРег.Период, Месяц) КАК ДатаОтражения,
	|	СУММА(ТабРег.ДоходыОборот) КАК СуммаДоходов,
	|	СУММА(ТабРег.РасходыОборот) КАК СуммаРасходов,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковФинансовогоРезультатаЗаПрошлыеПериоды) КАК ХозяйственнаяОперация
	|ИЗ
	|	РегистрНакопления.ФинансовыеРезультаты.Обороты(, &ГраницаОст, Месяц, ) КАК ТабРег
	|
	|СГРУППИРОВАТЬ ПО
	|	ТабРег.Организация,
	|	ТабРег.Подразделение,
	|	ТабРег.НаправлениеДеятельности,
	|	ТабРег.СтатьяРасходов,
	|	ТабРег.СтатьяДоходов,
	|	КОНЕЦПЕРИОДА(ТабРег.Период, Месяц)
	|ИМЕЮЩИЕ
	|	(СУММА(ТабРег.ДоходыОборот) > 0
	|		ИЛИ СУММА(ТабРег.РасходыОборот) > 0)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	Подразделение";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() ТОгда
		Возврат;
	КонецЕсли;
	КоличествоСформированныхДокументов = 1;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Подразделение") Цикл
			ДокОст = Документы.ВводОстатковОПродажахЗаПрошлыеПериоды.СоздатьДокумент();
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
			Пока Выборка.Следующий() Цикл
				Если Выборка.СуммаДоходов > 0 Тогда
					НоваяСтрока = ДокОст.ФинансовыйРезультатДоходы.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
				КонецЕсли;
				Если Выборка.СуммаРасходов > 0 Тогда
					НоваяСтрока = ДокОст.ФинансовыйРезультатРасходы.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
				КонецЕсли;
			КонецЦикла;
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
		КонецЦикла;
	КонецЦикла;
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковОПродажахЗаПрошлыеПериоды", 
									Перечисления.ХозяйственныеОперации.ВводОстатковФинансовогоРезультатаЗаПрошлыеПериоды);
	КонецЕсли;

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковПродажи()
	//Оптовые продажи

	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)) КАК Организация,
	|	ТабРег.Подразделение КАК Подразделение,
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Партнер, ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)) КАК Партнер,
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Контрагент, ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)) КАК Контрагент,
	|	ТабРег.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ЕстьNULL(РегистрАналитикаУчетаНоменклатуры.Номенклатура, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) КАК Номенклатура,
	|	ЕстьNULL(РегистрАналитикаУчетаНоменклатуры.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК Характеристика,
	|	ВЫРАЗИТЬ(РегистрАналитикаУчетаНоменклатуры.Номенклатура КАК Справочник.Номенклатура).СтавкаНДС КАК СтавкаНДС,
	|	ТабРег.Склад КАК Склад,
	|	ТабРег.Соглашение КАК Соглашение,
	|	ТабРег.Договор КАК Договор,
	|	ТабРег.Менеджер КАК Менеджер,
	|	ТабРег.ВидЗапасов КАК ВидЗапасов,
	|	КОНЕЦПЕРИОДА(ТабРег.Период, МЕСЯЦ) КАК ДатаОтражения,
	|	СУММА(ТабРег.КоличествоОборот) КАК Количество,
	|	СУММА(ТабРег.СуммаВыручкиОборот) КАК Сумма,
	|	СУММА(ТабРег.СуммаВыручкиБезНДСОборот) КАК СуммаБезНДС,
	|	СУММА(ТабРег.СуммаВыручкиРеглОборот) КАК СуммаРегл,
	|	СУММА(ТабРег.СуммаВыручкиСНДСРеглОборот) КАК СуммаСНДСРегл,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковОптовыхПродажЗаПрошлыеПериоды) КАК ХозяйственнаяОперация
	|ИЗ
	|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(, &ГраницаОст, Регистратор) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
	|	ПО ТабРег.АналитикаУчетаПоПартнерам = РегистрАналитикаУчетаПоПартнерам.КлючАналитики
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК РегистрАналитикаУчетаНоменклатуры
	|	ПО ТабРег.АналитикаУчетаНоменклатуры = РегистрАналитикаУчетаНоменклатуры.КлючАналитики
	|ГДЕ
	|	НЕ ТабРег.Регистратор ССЫЛКА Документ.ОтчетОРозничныхПродажах
	|СГРУППИРОВАТЬ ПО
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)),
	|	ТабРег.Подразделение,
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Партнер, ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)),
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Контрагент, ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)),
	|	ТабРег.АналитикаУчетаНоменклатуры,
	|	ЕстьNULL(РегистрАналитикаУчетаНоменклатуры.Номенклатура, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)),
	|	ЕстьNULL(РегистрАналитикаУчетаНоменклатуры.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)),
	|	ВЫРАЗИТЬ(РегистрАналитикаУчетаНоменклатуры.Номенклатура КАК Справочник.Номенклатура).СтавкаНДС,
	|	ТабРег.Склад,
	|	ТабРег.Соглашение,
	|	ТабРег.Договор,
	|	ТабРег.Менеджер,
	|	ТабРег.ВидЗапасов,
	|	КОНЕЦПЕРИОДА(ТабРег.Период, МЕСЯЦ)
	|ИМЕЮЩИЕ
	|	(СУММА(ТабРег.КоличествоОборот) > 0
	|		ИЛИ СУММА(ТабРег.СуммаВыручкиОборот) > 0
	|		ИЛИ СУММА(ТабРег.СуммаВыручкиРеглОборот) > 0)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)),
	|	ТабРег.Подразделение,
	|	ТабРег.Склад,
	|	ТабРег.Менеджер,
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Партнер, ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)),
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Контрагент, ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)),
	|	ТабРег.Соглашение,
	|	ТабРег.Договор
	|	";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	КоличествоСформированныхДокументов = 1;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Подразделение") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("Менеджер") Цикл
					Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
						Пока Выборка.СледующийПоЗначениюПоля("Контрагент") Цикл
							Пока Выборка.СледующийПоЗначениюПоля("Соглашение") Цикл
								Пока Выборка.СледующийПоЗначениюПоля("Договор") Цикл
									ДокОст = Документы.ВводОстатковОПродажахЗаПрошлыеПериоды.СоздатьДокумент();
									ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
									Пока Выборка.Следующий() Цикл
										НоваяСтрока = ДокОст.ОптовыеПродажи.Добавить();
										ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
										НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество;
										НоваяСтрока.СуммаНДС = НоваяСтрока.Сумма - НоваяСтрока.СуммаБезНДС;
										НоваяСтрока.НДСРегл = Выборка.СуммаСНДСРегл - НоваяСтрока.СуммаРегл;
										Если НоваяСтрока.Количество > 0 Тогда
											НоваяСтрока.Цена = Окр(НоваяСтрока.Сумма / НоваяСтрока.Количество, 2);
										КонецЕсли;
										ЗаполнитьСтавкуНДСВСтрокеДокумента(НоваяСтрока);
									КонецЦикла;
									ДокОст.Записать(РежимЗаписиДокумента.Запись);
								КонецЦикла; //Договор
							КонецЦикла; //Соглашение
						КонецЦикла; //Контрагент
					КонецЦикла; //Партнер
				КонецЦикла; //Менеджер
			КонецЦикла; //Склад
		КонецЦикла; //Подразделение
	КонецЦикла; //Организация
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковОПродажахЗаПрошлыеПериоды", 
									Перечисления.ХозяйственныеОперации.ВводОстатковОптовыхПродажЗаПрошлыеПериоды);
	КонецЕсли;
	//Розничные продажи
	ИспользуютсяКартыЛояльности = ПолучитьФункциональнуюОпцию("ИспользоватьКартыЛояльности");
	Если НЕ ИспользуютсяКартыЛояльности Тогда
		Возврат;
	КонецЕсли;
	
	// Розничные продажи.
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	Максимум(Владелец.ДатаНачалаДействия) КАК ДатаНачала,
	|	Партнер,
	|	Контрагент
	|ПОМЕСТИТЬ КартыПартнеров
	|ИЗ Справочник.КартыЛояльности
	|ГДЕ Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыКартЛояльности.Действует)
	|	И Владелец.ДатаНачалаДействия <= &ДатаОст
	|	И Владелец.Персонализирована
	|СГРУППИРОВАТЬ ПО
	|	Партнер,
	|	Контрагент
	|;
	|ВЫБРАТЬ
	|	КартыПартнеров.Партнер,
	|	КартыПартнеров.Контрагент,
	|	КартыЛояльности.Ссылка КАК КартаЛояльности,
	|	КартыЛояльности.Штрихкод,
	|	КартыЛояльности.МагнитныйКод,
	|	КартыЛояльности.Владелец КАК ВидКартыЛояльности
	|ПОМЕСТИТЬ КартыЛояльности
	|ИЗ КартыПартнеров
	|ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Справочник.КартыЛояльности КАК КартыЛояльности
	|ПО КартыПартнеров.Партнер = КартыЛояльности.Партнер
	|	И КартыПартнеров.Контрагент = КартыЛояльности.Контрагент
	|	И КартыПартнеров.ДатаНачала = КартыЛояльности.Владелец.ДатаНачалаДействия
	|;
	|ВЫБРАТЬ
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)) КАК Организация,
	|	ТабРег.Подразделение КАК Подразделение,
	|	ТабРег.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	РегистрАналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	РегистрАналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	РегистрАналитикаУчетаНоменклатуры.Номенклатура.СтавкаНДС КАК СтавкаНДС,
	|	ТабРег.Склад КАК Склад,
	|	ТабРег.Менеджер КАК Менеджер,
	|	ТабРег.ВидЗапасов КАК ВидЗапасов,
	|	КОНЕЦПЕРИОДА(ТабРег.Период, МЕСЯЦ) КАК ДатаОтражения,
	|	РегистрАналитикаУчетаПоПартнерам.Партнер,
	|	РегистрАналитикаУчетаПоПартнерам.Контрагент,
	|	КартыЛояльности.Штрихкод,
	|	КартыЛояльности.МагнитныйКод,
	|	КартыЛояльности.КартаЛояльности,
	|	КартыЛояльности.ВидКартыЛояльности,
	|	СУММА(ТабРег.КоличествоОборот) КАК Количество,
	|	СУММА(ТабРег.СуммаВыручкиОборот) КАК Сумма,
	|	СУММА(ТабРег.СуммаВыручкиБезНДСОборот) КАК СуммаБезНДС,
	|	СУММА(ТабРег.СуммаВыручкиРеглОборот) КАК СуммаРегл,
	|	СУММА(ТабРег.СуммаВыручкиСНДСРеглОборот) КАК СуммаСНДСРегл,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковРозничныхПродажЗаПрошлыеПериоды) КАК ХозяйственнаяОперация
	|ИЗ
	|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(, &ГраницаОст, Регистратор, ) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК РегистрАналитикаУчетаПоПартнерам
	|	ПО ТабРег.АналитикаУчетаПоПартнерам = РегистрАналитикаУчетаПоПартнерам.КлючАналитики
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК РегистрАналитикаУчетаНоменклатуры
	|	ПО ТабРег.АналитикаУчетаНоменклатуры = РегистрАналитикаУчетаНоменклатуры.КлючАналитики
	|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КартыЛояльности КАК КартыЛояльности
	|	ПО РегистрАналитикаУчетаПоПартнерам.Партнер = КартыЛояльности.Партнер
	|		И РегистрАналитикаУчетаПоПартнерам.Контрагент = КартыЛояльности.Контрагент
	|ГДЕ ТабРег.Регистратор ССЫЛКА Документ.ОтчетОРозничныхПродажах
	|СГРУППИРОВАТЬ ПО
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)),
	|	ТабРег.Подразделение,
	|	ТабРег.АналитикаУчетаНоменклатуры,
	|	РегистрАналитикаУчетаНоменклатуры.Номенклатура,
	|	РегистрАналитикаУчетаНоменклатуры.Характеристика,
	|	РегистрАналитикаУчетаПоПартнерам.Партнер,
	|	РегистрАналитикаУчетаПоПартнерам.Контрагент,
	|	КартыЛояльности.Штрихкод,
	|	КартыЛояльности.МагнитныйКод,
	|	КартыЛояльности.КартаЛояльности,
	|	КартыЛояльности.ВидКартыЛояльности,
	|	ТабРег.Склад,
	|	ТабРег.Менеджер,
	|	ТабРег.ВидЗапасов,
	|	КОНЕЦПЕРИОДА(ТабРег.Период, МЕСЯЦ)
	|ИМЕЮЩИЕ
	|	(СУММА(ТабРег.КоличествоОборот) > 0
	|		ИЛИ СУММА(ТабРег.СуммаВыручкиОборот) > 0
	|		ИЛИ СУММА(ТабРег.СуммаВыручкиРеглОборот) > 0)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЕстьNULL(РегистрАналитикаУчетаПоПартнерам.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)),
	|	ТабРег.Подразделение,
	|	ТабРег.Склад,
	|	ТабРег.Менеджер
	|	";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	КоличествоСформированныхДокументов = 1;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Подразделение") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("Менеджер") Цикл
					ДокОст = Документы.ВводОстатковОПродажахЗаПрошлыеПериоды.СоздатьДокумент();
					ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
					Пока Выборка.Следующий() Цикл
						НоваяСтрока = ДокОст.РозничныеПродажи.Добавить();
						ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
						НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество;
						НоваяСтрока.СуммаНДС = НоваяСтрока.Сумма - НоваяСтрока.СуммаБезНДС;
						НоваяСтрока.НДСРегл = Выборка.СуммаСНДСРегл - НоваяСтрока.СуммаРегл;
						Если НоваяСтрока.Количество > 0 Тогда
							НоваяСтрока.Цена = Окр(НоваяСтрока.Сумма / НоваяСтрока.Количество, 2);
						КонецЕсли;
						ЗаполнитьСтавкуНДСВСтрокеДокумента(НоваяСтрока);
					КонецЦикла;
					ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КонецЦикла; //Менеджер
			КонецЦикла; //Склад
		КонецЦикла; //Подразделение
	КонецЦикла; //Организация
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковОПродажахЗаПрошлыеПериоды", 
									Перечисления.ХозяйственныеОперации.ВводОстатковРозничныхПродажЗаПрошлыеПериоды);
	КонецЕсли;

КонецПроцедуры

Процедура ОбработатьВозвратыТоваровОтКлиентов()
	// Обработке подлежат возвраты от клиентов после даты свертки, 
	// документ реализации до даты свертки и себестоимость по данным документа продажи.
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Возврат.Ссылка КАК ДокументВозврат,
	|	Возврат.ДокументРеализации КАК ДокументРеализации,
	|	Возврат.КодСтроки КАК КодСтроки,
	|	Возврат.Номенклатура КАК Номенклатура,
	|	Возврат.Характеристика КАК Характеристика, 
	|	Возврат.Количество КАК Количество
	|ПОМЕСТИТЬ ВозвратыКОбработке
	|ИЗ Документ.ВозвратТоваровОтКлиента.Товары КАК Возврат
	|ГДЕ Возврат.Ссылка.Дата > &ДатаОст
	|	И Возврат.СпособОпределенияСебестоимости = ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимости.ИзДокументаПродажи)
	|	И (ВЫРАЗИТЬ(Возврат.ДокументРеализации КАК Документ.РеализацияТоваровУслуг).Дата < &ДатаОст
	|		ИЛИ ВЫРАЗИТЬ(Возврат.ДокументРеализации КАК Документ.ОтчетОРозничныхПродажах).Дата < &ДатаОст)
	|	И (ВЫРАЗИТЬ(Возврат.ДокументРеализации КАК Документ.РеализацияТоваровУслуг) <> ЗНАЧЕНИЕ(Документ.РеализацияТоваровУслуг.ПустаяСсылка)
	|		ИЛИ ВЫРАЗИТЬ(Возврат.ДокументРеализации КАК Документ.ОтчетОРозничныхПродажах) <> ЗНАЧЕНИЕ(Документ.ОтчетОРозничныхПродажах.ПустаяСсылка))
	|;
	|////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Свод.ДокументВозврат,
	|	Свод.ДокументРеализации,
	|	Свод.КодСтроки,
	|	Свод.Номенклатура,
	|	Свод.Характеристика,
	|	Свод.Количество,
	|	ВЫБОР КОГДА Свод.КоличествоПродажа = 0 ИЛИ Свод.СуммаПродажа = 0 ТОГДА 1
	|	ИНАЧЕ 
	|		Свод.СуммаПродажа / Свод.КоличествоПродажа
	|	КОНЕЦ КАК ЦенаСебестоимость,
	|	ВЫБОР КОГДА Свод.КоличествоПродажа = 0 ИЛИ Свод.СуммаБезНДСПродажа = 0 ТОГДА 1
	|	ИНАЧЕ 
	|		Свод.СуммаБезНДСПродажа / Свод.КоличествоПродажа
	|	КОНЕЦ КАК ЦенаСебестоимостьБезНДС,
	|	ВЫБОР КОГДА Свод.КоличествоПродажа = 0 ИЛИ Свод.СуммаРеглПродажа = 0 ТОГДА 1
	|	ИНАЧЕ 
	|		Свод.СуммаРеглПродажа / Свод.КоличествоПродажа
	|	КОНЕЦ КАК ЦенаСебестоимостьРегл
	|ИЗ
	|(	ВЫБРАТЬ
	|		Возвраты.ДокументВозврат,
	|		Возвраты.ДокументРеализации,
	|		Возвраты.КодСтроки,
	|		Возвраты.Номенклатура,
	|		Возвраты.Характеристика,
	|		МАКСИМУМ(Возвраты.Количество) КАК Количество,
	|		СУММА(ЕстьNULL(Себестоимость.Количество,0)) КАК КоличествоПродажа,
	|		СУММА(ЕстьNULL(Себестоимость.Стоимость,0)) КАК СуммаПродажа,
	|		СУММА(ЕстьNULL(Себестоимость.СтоимостьБезНДС,0)) КАК СуммаБезНДСПродажа,
	|		СУММА(ЕстьNULL(Себестоимость.СтоимостьРегл,0)) КАК СуммаРеглПродажа
	|	ИЗ ВозвратыКОбработке КАК Возвраты
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК Себестоимость
	|	ПО Возвраты.ДокументРеализации = Себестоимость.Регистратор
	|		И Возвраты.Номенклатура = Себестоимость.АналитикаУчетаНоменклатуры.Номенклатура
	|		И Возвраты.Характеристика = Себестоимость.АналитикаУчетаНоменклатуры.Характеристика
	|	СГРУППИРОВАТЬ ПО
	|		Возвраты.ДокументВозврат,
	|		Возвраты.ДокументРеализации,
	|		Возвраты.КодСтроки,
	|		Возвраты.Номенклатура,
	|		Возвраты.Характеристика
	|) КАК Свод
	|УПОРЯДОЧИТЬ ПО
	|	Свод.ДокументВозврат";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("ДокументВозврат") Цикл
		ДокОст = Выборка.ДокументВозврат.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ВозвратПроведен = ДокОст.Проведен;
		ДокументИзменен = Ложь;
		Пока Выборка.Следующий() Цикл
			СтруктураПоиска = Новый Структура("КодСтроки, Номенклатура, Характеристика");
			// Страховка на случай дублей строк с одинаковыми кодами и с разными способами определения.
			СтруктураПоиска.Вставить("СпособОпределенияСебестоимости", Перечисления.СпособыОпределенияСебестоимости.ИзДокументаПродажи);
			ЗаполнитьЗначенияСвойств(СтруктураПоиска, Выборка);
			СтрокиТовары = ДокОст.Товары.НайтиСтроки(СтруктураПоиска);
			Если СтрокиТовары.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			Для Каждого СтрокаТовары Из СтрокиТовары Цикл
				СтрокаТовары.Себестоимость = Окр(СтрокаТовары.Количество * Выборка.ЦенаСебестоимость, 2);
				СтрокаТовары.СебестоимостьБезНДС = Окр(СтрокаТовары.Количество * Выборка.ЦенаСебестоимостьБезНДС, 2);
				СтрокаТовары.СебестоимостьРегл = Окр(СтрокаТовары.Количество * Выборка.ЦенаСебестоимостьРегл, 2);
				СтрокаТовары.СпособОпределенияСебестоимости = Перечисления.СпособыОпределенияСебестоимости.Вручную;
				ДокументИзменен = Истина;
			КонецЦикла;
		КонецЦикла;
		Если ДокументИзменен Тогда
			ДокОст.Комментарий = Комментарий_СкорректированСверткойБазы;
			ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
			// Проведение будет выполнено позднее, при проведении документов ввода остатков.
			Если ВозвратПроведен Тогда
				ДокОст.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			Иначе
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	СообщениеСвертки(НСтр("ru='Обработаны Возвраты от клиентов с расчетом себестоимости по документу продажи';uk='Опрацьовані Повернення від клієнтів з розрахунком собівартості за документом продажу'"));
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковБонусныеБаллы()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.БонуснаяПрограммаЛояльности КАК БонуснаяПрограммаЛояльности,
	|ТабРег.Партнер КАК Партнер,
	|ТабРег.НачисленоОстаток КАК Начислено,
	|ТабРег.КСписаниюОстаток КАК КСписанию
	|ИЗ РегистрНакопления.БонусныеБаллы.Остатки(&ГраницаОст) КАК ТабРег
	|ИТОГИ ПО ТабРег.БонуснаяПрограммаЛояльности";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	КоличествоСформированныхДокументов = 1;
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	ВыборкаПрограмма = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаПрограмма.Следующий() Цикл
		ДокОст = Документы.НачислениеИСписаниеБонусныхБаллов.СоздатьДокумент();
		ДокОст.Дата = КонецДня(ДатаСверткиИБ);
		ДокОст.Комментарий = Комментарий_СформированСверткойБазы+" ["+КоличествоСформированныхДокументов+"]";
		ЗаполнитьЗначенияСвойств(ДокОст, ВыборкаПрограмма);
		ДокОст.ВидПравила = Перечисления.ВидыПравилНачисленияБонусныхБаллов.Начисление;

		ВыборкаПартнеры = ВыборкаПрограмма.Выбрать();
		Пока ВыборкаПартнеры.Следующий() Цикл
			Баллы = ВыборкаПартнеры.Начислено - ВыборкаПартнеры.КСписанию;
			Если Баллы <= 0 Тогда
				Продолжить;
			КонецЕсли;
			СтрокаБонусы = ДокОст.Начисление.Добавить();
			СтрокаБонусы.Партнер = ВыборкаПартнеры.Партнер;
			СтрокаБонусы.Баллы = Баллы;
		КонецЦикла;
		КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
		ДокОст.Записать(РежимЗаписиДокумента.Запись);
	КонецЦикла;
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("НачислениеИСписаниеБонусныхБаллов", 
									"Начисление");
	КонецЕсли;

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковПрочиеАктивыПассивы()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабРег.Организация КАК Организация,
	|ТабРег.Подразделение КАК Подразделение,
	|ТабРег.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|ТабРег.Статья КАК Статья,
	|ТабРег.Аналитика КАК Аналитика,
	|ТабРег.СуммаОстаток КАК Сумма
	|ИЗ РегистрНакопления.ПрочиеАктивыПассивы.Остатки(&ГраницаОст) КАК ТабРег
	|ГДЕ ТабРег.СуммаОстаток <> 0
	|ИТОГИ ПО Организация, Подразделение";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	КоличествоСформированныхДокументов = 1;
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	ВыборкаОрганизация = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаОрганизация.Следующий() Цикл
		ВыборкаПодразделение = ВыборкаОрганизация.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПодразделение.Следующий() Цикл
			ДокОст = Документы.ВводОстатковПрочихАктивовПассивов.СоздатьДокумент();
			ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковПрочихАктивовПассивов;
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаПодразделение, Ложь);

			Выборка = ВыборкаПодразделение.Выбрать();
			
			Пока Выборка.Следующий() Цикл
				СтрАП = ДокОст.ПрочиеАктивыПассивы.Добавить();
				ЗаполнитьЗначенияСвойств(СтрАП, Выборка);
			КонецЦикла;
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
			КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
		КонецЦикла;
	КонецЦикла;
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковПрочихАктивовПассивов", 
									СокрЛП(Перечисления.ХозяйственныеОперации.ВводОстатковПрочихАктивовПассивов));
	КонецЕсли;

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковТоварыПринятые()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Серия КАК Серия,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
	|ТабТоварыОрг.Организация КАК Организация,
	|ТабТоварыОрг.НомерГТД КАК НомерГТД,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Партнер КАК Партнер,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Контрагент КАК Контрагент,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Договор.ВалютаВзаиморасчетов КАК Валюта,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Договор КАК Договор,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Номенклатура.СтавкаНДС КАК СтавкаНДС,
	|Сумма(ТабТоварыОрг.КоличествоОстаток) КАК КоличествоПоОрганизации,
	|Сумма(ЕстьNULL(ТабСтоимость.СтоимостьЗабалансоваяОстаток, 0)) КАК Сумма,
	|Сумма(ЕстьNULL(ТабСтоимость.СтоимостьЗабалансоваяРеглОстаток, 0)) КАК СуммаРегл,
	|ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемНаХранениеСПравомПродажи) КАК ХозяйственнаяОперация
	|ИЗ РегистрНакопления.ТоварыОрганизаций.Остатки(&ГраницаОст, 
	|								ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ТоварНаХраненииСПравомПродажи)
	|					И АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)) КАК ТабТоварыОрг
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаОст, 
	|				РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
	|				ИЛИ РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаХраненииСПравомПродажи)) КАК ТабСтоимость
	|ПО  ТабТоварыОрг.АналитикаУчетаНоменклатуры = ТабСтоимость.АналитикаУчетаНоменклатуры
	|	И ТабТоварыОрг.Организация = ТабСтоимость.Организация
	|	И (ТабТоварыОрг.ВидЗапасов = ТабСтоимость.ВидЗапасов)
	|СГРУППИРОВАТЬ ПО
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Номенклатура,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Характеристика,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Серия,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.МестоХранения,
	|ТабТоварыОрг.Организация,
	|ТабТоварыОрг.НомерГТД,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Партнер,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Контрагент,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Договор.ВалютаВзаиморасчетов,
	|ТабТоварыОрг.АналитикаУчетаНоменклатуры.Договор
	|ИМЕЮЩИЕ Сумма(ТабТоварыОрг.КоличествоОстаток) > 0 
	|УПОРЯДОЧИТЬ ПО Организация, Склад, Партнер, Контрагент, Договор";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	КоличествоСформированныхДокументов = 1;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
				// Вид цены первый попавший либо из последнего документа, либо из справочника.
				ЗапросВидЦены = Новый Запрос;
				ЗапросВидЦены.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
				|Ссылка.ВидЦеныПоставщика КАК ВидЦены
				|ИЗ Документ.ПриемкаТоваровНаХранение
				|ГДЕ Дата < &ДатаОст И Проведен И Партнер = &Партнер";
				ЗапросВидЦены.УстановитьПараметр("Партнер", Выборка.Партнер);
				ЗапросВидЦены.УстановитьПараметр("ДатаОст", НачалоДня(ДатаСверткиИБ)-1);
				ВыборкаВидЦены = ЗапросВидЦены.Выполнить().Выбрать();
				Если ВыборкаВидЦены.Следующий() Тогда
					ВидЦеныПоставщика = ВыборкаВидЦены.ВидЦены;
				Иначе
					ВыборкаВидЦены = Справочники.ВидыЦенПоставщиков.Выбрать(,Выборка.Партнер);
					ВыборкаВидЦены.Следующий();
					ВидЦеныПоставщика = ВыборкаВидЦены.Ссылка;
				КонецЕсли;

				Пока Выборка.СледующийПоЗначениюПоля("Контрагент") Цикл
					Пока Выборка.СледующийПоЗначениюПоля("Договор") Цикл
						ДокОст = Документы.ПриемкаТоваровНаХранение.СоздатьДокумент();
						ДокОст.Дата = КонецДня(ДатаСверткиИБ);
						ДокОст.Комментарий = Комментарий_СформированСверткойБазы+" ["+КоличествоСформированныхДокументов+"]";
						ДокОст.Автор =  ПользователиКлиентСервер.ТекущийПользователь();
						ЗаполнитьЗначенияСвойств(ДокОст, Выборка);

						ДокОст.ВидЦеныПоставщика = ВидЦеныПоставщика;
						Пока Выборка.Следующий() Цикл
							НоваяСтрока = ДокОст.Товары.Добавить();
							ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);       
							НоваяСтрока.Количество = Выборка.КоличествоПоОрганизации;
							НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество;
							Цена = 0; 
							ЦенаРегл = 0;
							Если Выборка.Сумма > 0 Тогда
								Цена = Окр(Выборка.Сумма / Выборка.КоличествоПоОрганизации, 2);
								Если Выборка.Валюта = ВалютаУправленческогоУчета Тогда
									НоваяСтрока.Цена = Цена;
								КонецЕсли;
							КонецЕсли;
							Если Выборка.СуммаРегл > 0 Тогда
								ЦенаРегл = Окр(Выборка.СуммаРегл / Выборка.КоличествоПоОрганизации, 2);
								Если Выборка.Валюта = ВалютаРегламентированногоУчета Тогда
									НоваяСтрока.Цена = ЦенаРегл;
								КонецЕсли;
							КонецЕсли;
							Если НоваяСтрока.Цена = 0 Тогда
								КоэффициентПересчета = РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(ВалютаУправленческогоУчета, Выборка.Валюта, ДокОст.Дата);
								НоваяСтрока.Цена = Окр(Цена * КоэффициентПересчета, 2);
							КонецЕсли;
							НоваяСтрока.Сумма = Окр(НоваяСтрока.Цена * НоваяСтрока.Количество, 2);
							НоваяСтрока.СуммаНДС = ЦенообразованиеКлиентСервер.РассчитатьСуммуНДС(НоваяСтрока.Сумма, НоваяСтрока.СтавкаНДС, Ложь);
							НоваяСтрока.СуммаСНДС = НоваяСтрока.Сумма + НоваяСтрока.СуммаСНДС;
						КонецЦикла;  //Пока Выборка.Следующий() Цикл
						
						Если ДокОст.Товары.Количество() > 0 Тогда
							ДокОст.Записать(РежимЗаписиДокумента.Запись);
							ДокОст.СуммаДокумента = ДокОст.Товары.Итог("СуммаСНДС");
							КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
						КонецЕсли;
					КонецЦикла; //Договор
				КонецЦикла; //Контрагент
			КонецЦикла; // партнер
		КонецЦикла; //Склад
	КонецЦикла; //Организация
	ВывестиСообщениеСформированыДокументы("ПриемкаТоваровНаХранение");

КонецПроцедуры

Процедура ОбработатьОстаткиТоваровУПартнеров()
	// 1. Ситуация документ "Приобретение товаров услуг" до свертки, "Поступление товаров на склад" после свертки.
	// Документ ПоступлениеТоваров, закрывающий положительный остаток по регистру, удаляется.
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ 
	|ЕстьNULL(ТабРегОбороты.Регистратор, ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровНаСклад.ПустаяСсылка)) КАК ДокументПоступление,
	|ТабРег.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|ТабРег.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|ТабРег.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
	|ТабРег.АналитикаУчетаНоменклатуры.Серия КАК Серия,
	|ТабРег.ВидЗапасов КАК ВидЗапасов,
	|ТабРег.НомерГТД КАК НомерГТД,
	|Сумма(ТабРег.КоличествоОстаток) КАК Передано,
	|Сумма(ТабРегОбороты.КоличествоРасход) КАК Поступило
	|ИЗ РегистрНакопления.ТоварыОрганизаций.Остатки(&ГраницаОст, АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций.Обороты(&ГраницаОст,,Регистратор,АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)) КАК ТабРегОбороты
	|ПО ТабРегОбороты.АналитикаУчетаНоменклатуры = ТабРег.АналитикаУчетаНоменклатуры 
	|	И ТабРегОбороты.НомерГТД = ТабРег.НомерГТД 
	|СГРУППИРОВАТЬ ПО
	|	ТабРегОбороты.Регистратор,
	|	ТабРег.АналитикаУчетаНоменклатуры,
	|	ТабРег.ВидЗапасов,
	|	ТабРег.НомерГТД
	|ИМЕЮЩИЕ Сумма(ТабРег.КоличествоОстаток) > 0  И ТабРегОбороты.Регистратор ЕСТЬ НЕ NULL
	|УПОРЯДОЧИТЬ ПО 
	|	ЕстьNULL(ТабРегОбороты.Регистратор, ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровНаСклад.ПустаяСсылка)),
	|	ТабРег.АналитикаУчетаНоменклатуры.Номенклатура,
	|	ТабРег.АналитикаУчетаНоменклатуры.Характеристика,
	|	ТабРег.АналитикаУчетаНоменклатуры.Назначение,
	|	ТабРег.АналитикаУчетаНоменклатуры.Серия,
	|	ТабРег.ВидЗапасов,
	|	ТабРег.НомерГТД";
	
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("ДокументПоступление") Цикл
		ДокОст = Выборка.ДокументПоступление.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		ИначеЕсли ТипЗнч(ДокОст) <> Тип("ДокументОбъект.ПоступлениеТоваровНаСклад") Тогда
			Продолжить;
		КонецЕсли;
		МассивСтрокТоварыКУдалению = Новый Массив;
		МассивСтрокСерииКУдалению = Новый Массив;

		ДокументИзменен = Ложь;
		Пока Выборка.СледующийПоЗначениюПоля("Номенклатура") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("Характеристика") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("Назначение") Цикл
					Пока Выборка.СледующийПоЗначениюПоля("НомерГТД") Цикл
						Пока Выборка.СледующийПоЗначениюПоля("ВидЗапасов") Цикл
							Пока Выборка.СледующийПоЗначениюПоля("Серия") Цикл
								КоличествоТовары = Выборка.КоличествоПередано;
								КоличествоСерии = Выборка.КоличествоПередано;
								
								ПараметрыПоискаСтрок = Новый Структура();
								ПараметрыПоискаСтрок.Вставить("Номенклатура");
								ПараметрыПоискаСтрок.Вставить("Характеристика");
								ПараметрыПоискаСтрок.Вставить("Серия");
								ПараметрыПоискаСтрок.Вставить("Назначение");
								ПараметрыПоискаСтрок.Вставить("ВидЗапасов");
								ПараметрыПоискаСтрок.Вставить("НомерГТД");
								ЗаполнитьЗначенияСвойств(ПараметрыПоискаСтрок, Выборка);
								
								МассивСтрокТовары = ДокОст.Товары.НайтиСтроки(ПараметрыПоискаСтрок);
								Если МассивСтрокТовары.Количество() = 0 И ЗначениеЗаполнено(Выборка.Серия) Тогда
									// Попытка поиска без учета серии
									ПараметрыПоискаСтрок.Серия = Справочники.СерииНоменклатуры.ПустаяСсылка();
									МассивСтрокТовары = ДокОст.Товары.НайтиСтроки(ПараметрыПоискаСтрок);
								КонецЕсли;
								СкорректироватьКоличествоВТЧДокумента(МассивСтрокТовары, КоличествоТовары, МассивСтрокТоварыКУдалению, ДокументИзменен);
								Если ДокОст.Серии.Количество() > 0 И ЗначениеЗаполнено(Выборка.Серия) Тогда
									ПараметрыПоискаСтрок = Новый Структура();
									ПараметрыПоискаСтрок.Вставить("Номенклатура");
									ПараметрыПоискаСтрок.Вставить("Характеристика");
									ПараметрыПоискаСтрок.Вставить("Серия");
									ПараметрыПоискаСтрок.Вставить("Назначение");
									МассивСтрокСерии = ДокОст.Серии.НайтиСтроки(ПараметрыПоискаСтрок);
									СкорректироватьКоличествоВТЧДокумента(МассивСтрокСерии, КоличествоСерии, МассивСтрокСерииКУдалению, ДокументИзменен);
								КонецЕсли;
							КонецЦикла;  //Серия
						КонецЦикла;//ВидЗапасов
					КонецЦикла; //НомерГТД
				КонецЦикла; //Назначение
			КонецЦикла; //Характеристика
		КонецЦикла; //Номенклатура
		Для Каждого СтрокаТовары Из МассивСтрокТоварыКУдалению Цикл
			ДокОст.Товары.Удалить(СтрокаТовары);
			ДокументИзменен = Истина;
		КонецЦикла;
		Для Каждого СтрокаСерии Из МассивСтрокСерииКУдалению Цикл
			ДокОст.Серии.Удалить(СтрокаСерии);
			ДокументИзменен = Истина;
		КонецЦикла;
		Если ДокументИзменен Тогда
			ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
			Если ДокОст.Товары.Количество() = 0 Тогда
				// Документ можно удалить целиком.
				ДокОст.Комментарий = Комментарий_УдалитьПриСверткеБазы;
				ДокОст.Записать(РежимЗаписиДокумента.Проведение);
			Иначе
				ДокОст.Комментарий = Комментарий_СкорректированСверткойБазы;
				ДокОст.Записать(РежимЗаписиДокумента.Проведение);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	// 2. Ситуация документ "Поступление товаров на склад" до свертки, "Приобретение товаров услуг" после свертки.
	// Документ "Поступление товаров на склад" переносится в дату свертки, корректируется в соответствии с остатками.
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ 
	|ЕстьNULL(ТабРегОбороты.Регистратор, ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровНаСклад.ПустаяСсылка)) КАК ДокументПоступление,
	|ТабРег.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|ТабРег.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|ТабРег.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
	|ТабРег.АналитикаУчетаНоменклатуры.Серия КАК Серия,
	|ТабРег.ВидЗапасов КАК ВидЗапасов,
	|ТабРег.НомерГТД КАК НомерГТД,
	|Сумма(ТабРег.КоличествоОстаток) КАК Передано,
	|Сумма(ТабРегОбороты.КоличествоРасход) КАК Поступило
	|ИЗ РегистрНакопления.ТоварыОрганизаций.Остатки(&ГраницаОст,АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций.Обороты(,&ГраницаОст,Регистратор,АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)) КАК ТабРегОбороты
	|ПО ТабРегОбороты.АналитикаУчетаНоменклатуры = ТабРег.АналитикаУчетаНоменклатуры 
	|	И ТабРегОбороты.НомерГТД = ТабРег.НомерГТД 
	|СГРУППИРОВАТЬ ПО
	|	ТабРегОбороты.Регистратор,
	|	ТабРег.АналитикаУчетаНоменклатуры,
	|	ТабРег.ВидЗапасов,
	|	ТабРег.НомерГТД
	|ИМЕЮЩИЕ Сумма(ТабРег.КоличествоОстаток) < 0  И ТабРегОбороты.Регистратор ЕСТЬ НЕ NULL
	|УПОРЯДОЧИТЬ ПО 
	|	ЕстьNULL(ТабРегОбороты.Регистратор, ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровНаСклад.ПустаяСсылка)),
	|	ТабРег.АналитикаУчетаНоменклатуры,
	|	ТабРег.ВидЗапасов,
	|	ТабРег.НомерГТД
	|";
	
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("ДокументПоступление") Цикл
		ДокОст = Выборка.ДокументПоступление.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		ИначеЕсли ТипЗнч(ДокОст) <> Тип("ДокументОбъект.ПоступлениеТоваровНаСклад") Тогда
			Продолжить;
		КонецЕсли;
		МассивСтрокТоварыКУдалению = Новый Массив;
		МассивСтрокСерииКУдалению = Новый Массив;

		ДокументИзменен = Ложь;
		Пока Выборка.СледующийПоЗначениюПоля("Номенклатура") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("Характеристика") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("Назначение") Цикл
					Пока Выборка.СледующийПоЗначениюПоля("НомерГТД") Цикл
						Пока Выборка.СледующийПоЗначениюПоля("ВидЗапасов") Цикл
							Пока Выборка.СледующийПоЗначениюПоля("Серия") Цикл
								КоличествоТовары = (-1) * Выборка.КоличествоПередано;
								КоличествоСерии = (-1) * Выборка.КоличествоПередано;
								
								ПараметрыПоискаСтрок = Новый Структура();
								ПараметрыПоискаСтрок.Вставить("Номенклатура");
								ПараметрыПоискаСтрок.Вставить("Характеристика");
								ПараметрыПоискаСтрок.Вставить("Серия");
								ПараметрыПоискаСтрок.Вставить("Назначение");
								ПараметрыПоискаСтрок.Вставить("ВидЗапасов");
								ПараметрыПоискаСтрок.Вставить("НомерГТД");
								ЗаполнитьЗначенияСвойств(ПараметрыПоискаСтрок, Выборка);
								
								МассивСтрокТовары = ДокОст.Товары.НайтиСтроки(ПараметрыПоискаСтрок);
								Если МассивСтрокТовары.Количество() = 0 И ЗначениеЗаполнено(Выборка.Серия) Тогда
									// Попытка поиска без учета серии
									ПараметрыПоискаСтрок.Серия = Справочники.СерииНоменклатуры.ПустаяСсылка();
									МассивСтрокТовары = ДокОст.Товары.НайтиСтроки(ПараметрыПоискаСтрок);
								КонецЕсли;
								СкорректироватьКоличествоВТЧДокумента(МассивСтрокТовары, КоличествоТовары, МассивСтрокТоварыКУдалению, ДокументИзменен);
								Если ДокОст.Серии.Количество() > 0 И ЗначениеЗаполнено(Выборка.Серия) Тогда
									ПараметрыПоискаСтрок = Новый Структура();
									ПараметрыПоискаСтрок.Вставить("Номенклатура");
									ПараметрыПоискаСтрок.Вставить("Характеристика");
									ПараметрыПоискаСтрок.Вставить("Серия");
									ПараметрыПоискаСтрок.Вставить("Назначение");
									МассивСтрокСерии = ДокОст.Серии.НайтиСтроки(ПараметрыПоискаСтрок);
									СкорректироватьКоличествоВТЧДокумента(МассивСтрокСерии, КоличествоСерии, МассивСтрокСерииКУдалению, ДокументИзменен);
								КонецЕсли;
							КонецЦикла;  //Серия
						КонецЦикла;//ВидЗапасов
					КонецЦикла; //НомерГТД
				КонецЦикла; //Назначение
			КонецЦикла; //Характеристика
		КонецЦикла; //Номенклатура
		Для Каждого СтрокаТовары Из МассивСтрокТоварыКУдалению Цикл
			ДокОст.Товары.Удалить(СтрокаТовары);
			ДокументИзменен = Истина;
		КонецЦикла;
		Для Каждого СтрокаСерии Из МассивСтрокСерииКУдалению Цикл
			ДокОст.Серии.Удалить(СтрокаСерии);
			ДокументИзменен = Истина;
		КонецЦикла;
		Если ДокументИзменен Тогда
			ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
			Если ДокОст.Товары.Количество() = 0 Тогда
				// Документ можно удалить целиком.
				ДокОст.Комментарий = Комментарий_УдалитьПриСверткеБазы;
				ДокОст.Записать(РежимЗаписиДокумента.Проведение);
			Иначе
				ДокОст.Комментарий = Комментарий_СкорректированСверткойБазы;
				ДокОст.Дата = ДатаСверткиИБ;
				ДокОст.Записать(РежимЗаписиДокумента.Проведение);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	СообщениеСвертки(НСтр("ru='Обработаны Товары у партнеров';uk='Опрацьовані Товари у партнерів'"));
КонецПроцедуры

//++ НЕ УТКА
Процедура СформироватьДокументыВводаОстатковЗаказыНаПроизводство()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	Распоряжение КАК Заказ,
	|	Номенклатура КАК Номенклатура,
	|	Характеристика КАК Характеристика,
	|	КодСтроки КАК КодСтроки,
	|	Серия КАК Серия,
	|	Назначение КАК Назначение,
	|	НазначениеОтправителя КАК НазначениеОтправителя,
	|	Получатель КАК Получатель,
	|	ЗаказаноОстаток КАК Количество,
	|	ЛОЖЬ КАК Отражено
	|ПОМЕСТИТЬ Материалы    // ТЧ МатериалыИУслуги
	|ИЗ РегистрНакопления.ЗаказыМатериаловВПроизводство.Остатки(&ГраницаОст, Распоряжение ССЫЛКА Документ.ЗаказНаПроизводство) КАК ТабРег
	|ГДЕ ТабРег.ЗаказаноОстаток > 0 
	|	И Распоряжение.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовНаПроизводство.Закрыт)
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Распоряжение КАК Заказ,
	|	КодСтрокиПродукция,
	|	КодСтрокиЭтапыГрафик,
	|	Этап,
	|	Подразделение,
	|	ЗапланированоЗаказомОборот КАК ЗапланированоЗаказом,
	|	ВыполненоОборот КАК Выполнено,
	|	БракОборот КАК Брак,
	|	ЗапланированоЗаказомОборот - ВыполненоОборот - БракОборот КАК ОсталосьВыполнить
	|ПОМЕСТИТЬ Этапы    // ТЧ Этапы
	|ИЗ РегистрНакопления.ЭтапыПроизводства.Обороты(,&ГраницаОст) КАК ТабРег
	|ГДЕ (ЗапланированоЗаказомОборот - ВыполненоОборот - БракОборот) > 0 И Распоряжение.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовНаПроизводство.Закрыт)
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаказНаПроизводство КАК Заказ,
	|	ВидРабот,
	|	КодСтрокиПродукция,
	|	КодСтрокиЭтапыГрафик,
	|	Этап,
	|	ПоЗаказуОстаток КАК Количество
	|ПОМЕСТИТЬ Трудозатраты  // ТЧ Трудозатраты
	|ИЗ РегистрНакопления.ЗаказыНаПроизводствоТрудозатраты.Остатки(&ГраницаОст) КАК ТабТрудозатраты
	|ГДЕ ЗаказНаПроизводство.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовНаПроизводство.Закрыт)
	|	И ПоЗаказуОстаток > 0
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаказНаПроизводство КАК Заказ,
	|	КодСтрокиПродукция,
	|	КодСтрокиЭтапыГрафик,
	|	ЗаказаноОстаток КАК Количество
	|ПОМЕСТИТЬ Спецификации  
	|ИЗ РегистрНакопления.ЗаказыНаПроизводствоСпецификации.Остатки(&ГраницаОст, ЗаказНаПроизводство ССЫЛКА Документ.ЗаказНаПроизводство) КАК ТабСпецификации
	|ГДЕ ЗаказНаПроизводство.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовНаПроизводство.Закрыт)
	|	И ЗаказаноОстаток > 0
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Заказ
	|ИЗ (
	|ВЫБРАТЬ Заказ
	|ИЗ Материалы
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ Заказ
	|ИЗ Этапы
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ Заказ
	|ИЗ Трудозатраты
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ Заказ
	|ИЗ Спецификации
	|) КАК СводЗаказов
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ *
	|ИЗ Материалы
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ *
	|ИЗ Этапы
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ *
	|ИЗ Трудозатраты
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ *
	|ИЗ Спецификации
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	ТаблицаЗаказов = Результат[0].Выгрузить();
	Если ТаблицаЗаказов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	ТаблицаМатериалы = Результат[1].Выгрузить();
	ТаблицаЭтапы = Результат[2].Выгрузить();
	ТаблицаТрудозатраты = Результат[3].Выгрузить();
	ТаблицаСпецификации = Результат[4].Выгрузить();
	МассивРегистровНакопления = РегистрыНакопленияДокумента("ЗаказНаПроизводство");
	Для Каждого СтрокаЗаказ Из ТаблицаЗаказов Цикл
		Заказ = СтрокаЗаказ.Заказ;
		ДокОст = Заказ.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ЗафиксироватьИзменениеДокументовВПараметрСвертки();
		//Очистим движения данного заказа, чтобы при перепроведении не мешал контроль остатков
		ОчиститьНаборыЗаписейДвиженийДокумента(МассивРегистровНакопления, Заказ);

		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		
		СтруктураПоиска = Новый Структура("Заказ", Заказ);
		СтрокиМатериалы = Неопределено;
		СтрокиТрудозатраты = Неопределено;
		СтрокиЭтапы = Неопределено;
		СтрокиСпецификации = Неопределено;
		Если ТаблицаМатериалы.Количество() > 0 Тогда
			СтрокиМатериалы = ТаблицаМатериалы.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		Если ТаблицаТрудозатраты.Количество() > 0 Тогда
			СтрокиТрудозатраты = ТаблицаТрудозатраты.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		Если ТаблицаЭтапы.Количество() > 0 Тогда
			СтрокиЭтапы = ТаблицаЭтапы.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		Если ТаблицаСпецификации.Количество() > 0 Тогда
			СтрокиСпецификации = ТаблицаСпецификации.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		МассивКодовСтрокКУдалению = Новый Массив;
		Для Каждого СтрокаТЧ Из ДокОст.МатериалыИУслуги Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			КонецЕсли;
			КодСтроки = СтрокаТЧ.КодСтроки;
			КодСтрокиНайден = Ложь;
			Если СтрокиМатериалы <> Неопределено Тогда
				Для Каждого СтрокаТаб Из СтрокиМатериалы Цикл
					Если СтрокаТаб.КодСтроки = КодСтроки Тогда
						КодСтрокиНайден = Истина;
						ИзменятьГрафик = (СтрокаТаб.Количество <> СтрокаТЧ.Количество);
						// Перепишем значения реквизитов - возможно они скорректировались.
						ЗаполнитьЗначенияСвойств(СтрокаТЧ, СтрокаТаб, "Номенклатура, Характеристика, Количество, Серия, Назначение");
						СтрокаТЧ.Подразделение = СтрокаТаб.Получатель;
						Если ИзменятьГрафик Тогда
							СтрокиГрафик = ДокОст.МатериалыИУслугиГрафик.НайтиСтроки(Новый Структура("КлючСвязиМатериалыИУслуги", СтрокаТЧ.КлючСвязи));
							КоличествоОсталось = СтрокаТаб.Количество;
							Для Каждого СтрокаГрафик Из СтрокиГрафик Цикл
								Если КоличествоОсталось = 0 Тогда
									ДокОст.МатериалыИУслугиГрафик.УдалитьСтроку(СтрокаГрафик);
									Продолжить;
								КонецЕсли;
								СтрокаГрафик.Количество = Мин(СтрокаГрафик.Количество, КоличествоОсталось);
								КоличествоОсталось = КоличествоОсталось - СтрокаГрафик.Количество;
							КонецЦикла;
						КонецЕсли;
						СтрокаТаб.Отражено = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			Если НЕ КодСтрокиНайден Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокиГрафик = ДокОст.МатериалыИУслугиГрафик.НайтиСтроки(Новый Структура("КлючСвязиМатериалыИУслуги", СтрокаТЧ.КлючСвязи));
				Для Каждого СтрокаГрафик Из СтрокиГрафик Цикл
					ДокОст.МатериалыИУслугиГрафик.УдалитьСтроку(СтрокаГрафик);
				КонецЦикла;
			КонецЕсли;
		КонецЦикла; // ТЧ Материалы обход строк.
		// Возможно следует добавить новые строки.
		Если СтрокиМатериалы <> Неопределено Тогда
			Для Каждого СтрокаТаб Из СтрокиМатериалы Цикл
				Если СтрокаТаб.Отражено Тогда
					Продолжить;
				КонецЕсли;
				СтрокаТЧ = ДокОст.МатериалыИУслуги.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаТЧ, СтрокаТаб);
				СтрокаТаб.Отражено = Истина;
			КонецЦикла;
		КонецЕсли;
		// ТЧ Трудозатраты
		МассивСтрокТрудозатратыКУдалению = Новый Массив;
		Для Каждого СтрокаТЧ Из ДокОст.Трудозатраты Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			КонецЕсли;
			КодСтрокиНайден = Ложь;
			Если СтрокиТрудозатраты <> Неопределено Тогда
				Для Каждого СтрокаТаб Из СтрокиТрудозатраты Цикл
					Если СтрокаТаб.ВидРабот = СтрокаТЧ.ВидРабот
						И СтрокаТаб.КодСтрокиПродукция = СтрокаТЧ.КлючСвязиПродукция 
						И СтрокаТаб.КодСтрокиЭтапыГрафик = СтрокаТЧ.КлючСвязиЭтапы Тогда
						КодСтрокиНайден = Истина;
						ИзменятьГрафик = Ложь;
						Если СтрокаТЧ.Количество > СтрокаТаб.Количество Тогда
							СтрокаТЧ. Количество = СтрокаТаб.Количество;
							ИзменятьГрафик = Истина;
						КонецЕсли;
						
						Если ИзменятьГрафик Тогда
							СтрокиГрафик = ДокОст.ТрудозатратыГрафик.НайтиСтроки(Новый Структура("КлючСвязиТрудозатраты", СтрокаТЧ.КлючСвязи));
							КоличествоОсталось = СтрокаТаб.Количество;
							Для Каждого СтрокаГрафик Из СтрокиГрафик Цикл
								Если КоличествоОсталось = 0 Тогда
									ДокОст.ТрудозатратыГрафик.УдалитьСтроку(СтрокаГрафик);
									Продолжить;
								КонецЕсли;
								СтрокаГрафик.Количество = Мин(СтрокаГрафик.Количество, КоличествоОсталось);
								КоличествоОсталось = КоличествоОсталось - СтрокаГрафик.Количество;
							КонецЦикла;
						КонецЕсли;
						СтрокаТаб.Отражено = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			Если НЕ КодСтрокиНайден Тогда
				МассивСтрокТрудозатратыКУдалению.Добавить(СтрокаТЧ);
				СтрокиГрафик = ДокОст.ТрудозатратыГрафик.НайтиСтроки(Новый Структура("КлючСвязиТрудозатраты", СтрокаТЧ.КлючСвязи));
				Для Каждого СтрокаГрафик Из СтрокиГрафик Цикл
					ДокОст.ТрудозатратыГрафик.УдалитьСтроку(СтрокаГрафик);
				КонецЦикла;
			КонецЕсли;
		КонецЦикла; //Для Каждого СтрокаТЧ Из ДокОст.Трудозатраты Цикл
		Для Каждого СтрокаТЧ Из МассивСтрокТрудозатратыКУдалению Цикл
			ДокОст.Трудозатраты.УдалитьСтроку(СтрокаТЧ);
		КонецЦикла;
		// ТЧ ЭтапыПроизводства
		МассивСтрокЭтапыГрафикКУдалению = Новый Массив;
		Для Каждого СтрокаТЧ Из ДокОст.ЭтапыГрафик Цикл
			КодСтроки = СтрокаТЧ.КодСтроки;
			КодСтрокиНайден = Ложь;
			Если СтрокиЭтапы <> Неопределено Тогда
				Для Каждого СтрокаТаб Из СтрокиЭтапы Цикл
					Если СтрокаТаб.КодСтрокиЭтапыГрафик = КодСтроки
						И СтрокаТаб.КодСтрокиПродукция = СтрокаТЧ.КлючСвязиПродукция Тогда
						КодСтрокиНайден = Истина;
						Если СтрокаТаб.ЗапланированоЗаказом <> СтрокаТаб.ОсталосьВыполнить Тогда
							// Нужна корректировка количества продукции.
							КоличествоОсталось = СтрокаТаб.ОсталосьВыполнить;
							СтрокиПродукция = ДокОст.Продукция.НайтиСтроки(Новый Структура("КлючСвязи", СтрокаТЧ.КлючСвязиПродукция));
							Для Каждого СтрокаПродукция Из СтрокиПродукция Цикл
								Если КоличествоОсталось = 0 Тогда
									ДокОст.Продукция.УдалитьСтроку(СтрокаПродукция);
									Продолжить;
								КонецЕсли;
								КоличествоСтроки = Мин(СтрокаПродукция.Количество, КоличествоОсталось);
								СтрокаПродукция.Количество = КоличествоСтроки;
								КоличествоОсталось = КоличествоОсталось - КоличествоСтроки;
							КонецЦикла;
						КонецЕсли;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			Если НЕ КодСтрокиНайден Тогда
				МассивСтрокЭтапыГрафикКУдалению.Добавить(СтрокаТЧ);
				СтрокиПродукция = ДокОст.Продукция.НайтиСтроки(Новый Структура("КлючСвязи", СтрокаТЧ.КлючСвязиПродукция));
				Для Каждого СтрокаПродукция Из СтрокиПродукция Цикл
					ДокОст.Продукция.УдалитьСтроку(СтрокаПродукция);
				КонецЦикла;
				СтрокиПродукция = ДокОст.ПродукцияГрафик.НайтиСтроки(Новый Структура("КлючСвязиПродукция", СтрокаТЧ.КлючСвязиПродукция));
				Для Каждого СтрокаПродукция Из СтрокиПродукция Цикл
					ДокОст.ПродукцияГрафик.УдалитьСтроку(СтрокаПродукция);
				КонецЦикла;
				СтрокиЭтапы = ДокОст.Этапы.НайтиСтроки(Новый Структура("КлючСвязиЭтапы, КлючСвязиПродукция", СтрокаТЧ.КлючСвязиЭтапы, СтрокаТЧ.КлючСвязиПродукция));
				Для Каждого СтрокаЭтап Из СтрокиЭтапы Цикл
					ДокОст.Этапы.УдалитьСтроку(СтрокаЭтап);
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
		Для Каждого СтрокаЭтапы ИЗ МассивСтрокЭтапыГрафикКУдалению Цикл
			ДокОст.ЭтапыГрафик.УдалитьСтроку(СтрокаЭтапы);
		КонецЦикла;
		// ТЧ ВыходныеИзделия
		МассивСтрокВыходныеИзделияКУдалению = Новый Массив;
		Для Каждого СтрокаТЧ Из ДокОст.ВыходныеИзделия Цикл
			КлючНайден = Ложь; 
			Если СтрокиСпецификации <> Неопределено Тогда
				Для Каждого СтрокаТаб Из СтрокиСпецификации Цикл
					Если СтрокаТЧ.КлючСвязиПродукция = СтрокаТаб.КодСтрокиПродукция
						И СтрокаТЧ.КлючСвязиЭтапыГрафик = СтрокаТаб.КодСтрокиЭтапыГрафик Тогда
						КоличествоОсталось = Мин(СтрокаТЧ.Количество, СтрокаТаб.Количество);
						Если СтрокаТЧ.Количество > КоличествоОсталось Тогда
							СтрокаТЧ.Количество = КоличествоОсталось;
							СтрокиГрафик = ДокОст.ВыходныеИзделияГрафик.НайтиСтроки("КлючСвязиВыходныеИзделия", СтрокаТЧ.КлючСвязи);
							Для Каждого СтрокаГрафик Из СтрокиГрафик Цикл
								Если КоличествоОсталось = 0 Тогда
									ДокОст.ВыходныеИзделияГрафик.Удалить(СтрокаГрафик);
									Продолжить;
								КонецЕсли;
								СтрокаГрафик.Количество = Мин(КоличествоОсталось, СтрокаГрафик.Количество);
								КоличествоОсталось = КоличествоОсталось - СтрокаГрафик.Количество;
							КонецЦикла;
						КонецЕсли;
						КлючНайден = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			Если НЕ КлючНайден Тогда
				МассивСтрокВыходныеИзделияКУдалению.Добавить(СтрокаТЧ);
			КонецЕсли;
		КонецЦикла;
		Для Каждого СтрокаТЧ Из МассивСтрокВыходныеИзделияКУдалению Цикл
			СтрокиГрафик = ДокОст.ВыходныеИзделияГрафик.НайтиСтроки("КлючСвязиВыходныеИзделия", СтрокаТЧ.КлючСвязи);
			Для Каждого СтрокаГрафик Из СтрокиГрафик Цикл
				ДокОст.ВыходныеИзделияГрафик.Удалить(СтрокаГрафик);
			КонецЦикла;
			ДокОст.ВыходныеИзделия.Удалить(СтрокаТЧ);
		КонецЦикла;
		// ТЧ ВозвратныеОтходы
		МассивСтрокВОКУдалению = Новый Массив;
		Для Каждого СтрокаТЧ Из ДокОст.ВозвратныеОтходы Цикл
			КлючНайден = Ложь;
			Если СтрокиСпецификации <> Неопределено Тогда
				Для Каждого СтрокаТаб Из СтрокиСпецификации Цикл
					Если СтрокаТЧ.КлючСвязиПродукция = СтрокаТаб.КодСтрокиПродукция
						И СтрокаТЧ.КлючСвязиЭтапы = СтрокаТаб.КодСтрокиЭтапыГрафик Тогда
						КоличествоОсталось = Мин(СтрокаТЧ.Количество, СтрокаТаб.Количество);
						Если СтрокаТЧ.Количество > КоличествоОсталось Тогда
							СтрокаТЧ.Количество = КоличествоОсталось;
							СтрокиГрафик = ДокОст.ВозвратныеОтходыГрафик.НайтиСтроки("КлючСвязиВозвратныеОтходы", СтрокаТЧ.КлючСвязи);
							Для Каждого СтрокаГрафик Из СтрокиГрафик Цикл
								Если КоличествоОсталось = 0 Тогда
									ДокОст.ВозвратныеОтходыГрафик.Удалить(СтрокаГрафик);
									Продолжить;
								КонецЕсли;
								СтрокаГрафик.Количество = Мин(КоличествоОсталось, СтрокаГрафик.Количество);
								КоличествоОсталось = КоличествоОсталось - СтрокаГрафик.Количество;
							КонецЦикла;
						КонецЕсли;
						КлючНайден = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			Если НЕ КлючНайден Тогда
				МассивСтрокВОКУдалению.Добавить(СтрокаТЧ);
			КонецЕсли;
		КонецЦикла;
		Для Каждого СтрокаТЧ Из МассивСтрокВОКУдалению Цикл
			СтрокиГрафик = ДокОст.ВозвратныеОтходыГрафик.НайтиСтроки("КлючСвязиВыходныеИзделия", СтрокаТЧ.КлючСвязи);
			Для Каждого СтрокаГрафик Из СтрокиГрафик Цикл
				ДокОст.ВозвратныеОтходыГрафик.Удалить(СтрокаГрафик);
			КонецЦикла;
			ДокОст.ВозвратныеОтходы.Удалить(СтрокаТЧ);
		КонецЦикла;  
		ПровестиИлиЗаписатьДокумент(ДокОст);
	КонецЦикла;
	СообщениеСвертки(НСтр("ru='Обработаны Заказы на производство';uk='Опрацьовані Замовлення на виробництво'")); 

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковЗаказыДавальцу()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|ТабРег.ЗаказКлиента КАК Заказ,
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.КодСтроки КАК КодСтроки,
	|ТабРег.Склад КАК Склад,
	|ТабРег.Серия КАК Серия,
	|ТабРег.КОформлениюОстаток КАК Количество
	|ПОМЕСТИТЬ Продукция
	|ИЗ РегистрНакопления.ЗаказыКлиентов.Остатки(&ГраницаОст, ЗаказКлиента ССЫЛКА Документ.ЗаказДавальца
	|									И ЗаказКлиента.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовДавальцев.Закрыт)) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ
	| РегистрНакопления.УслугиДавальцуКОформлению.Остатки(&ГраницаОст, ЗаказДавальца.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовДавальцев.Закрыт)) КАК ТабУслуги
	|ПО ТабРег.Номенклатура = ТабУслуги.Номенклатура
	|	И ТабРег.Характеристика = ТабУслуги.Характеристика
	|	И ТабРег.ЗаказКлиента = ТабУслуги.ЗаказДавальца
	|ГДЕ ТабРег.КОформлениюОстаток>0  
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|ТабРег.ЗаказПоставщику КАК Заказ,
	|ТабРег.Номенклатура КАК Номенклатура,
	|ТабРег.Характеристика КАК Характеристика,
	|ТабРег.КодСтроки КАК КодСтроки,
	|ТабРег.Склад КАК Склад,
	|ТабРег.ЗаказаноОстаток КАК Количество
	|ПОМЕСТИТЬ Материалы
	|ИЗ РегистрНакопления.ЗаказыПоставщикам.Остатки(&ГраницаОст, ЗаказПоставщику ССЫЛКА Документ.ЗаказДавальца
	|										И ЗаказПоставщику.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовДавальцев.Закрыт)) КАК ТабРег
	|ГДЕ ТабРег.ЗаказаноОстаток>0
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Заказ
	|ИЗ (
	|ВЫБРАТЬ Заказ ИЗ Продукция
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ Заказ ИЗ Материалы
	|) КАК Свод
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ * ИЗ Продукция
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ * ИЗ Материалы
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	ТаблицаЗаказов = Результат[0].Выгрузить();
	Если ТаблицаЗаказов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	ТаблицаПродукция = Результат[1].Выгрузить();
	ТаблицаМатериалы = Результат[2].Выгрузить();
	МассивРегистровНакопления = РегистрыНакопленияДокумента("ЗаказДавальца");
	//Определим причину отмены заказов
	ПричинаОтменыЗаказа = Справочники.ПричиныОтменыЗаказовКлиентов.НайтиПоНаименованию(НСтр("ru='#Свертка базы';uk='#Згортка бази'"));
	Если ПричинаОтменыЗаказа = Неопределено ИЛИ ПричинаОтменыЗАказа.Пустая() Тогда
		ПричинаОтменыЗаказаОбъект = Справочники.ПричиныОтменыЗаказовКлиентов.СоздатьЭлемент();
		ПричинаОтменыЗаказаОбъект.Наименование = НСтр("ru='#Свертка базы';uk='#Згортка бази'");
		ПричинаОтменыЗаказаОбъект.Записать();
		ПричинаОтменыЗаказа = ПричинаОтменыЗаказаОбъект.Ссылка;
	КонецЕсли;
	
	Для Каждого СтрокаЗаказ Из ТаблицаЗаказов Цикл
		Заказ = СтрокаЗаказ.Заказ;
		ДокОст = Заказ.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ЗафиксироватьИзменениеДокументовВПараметрСвертки();
		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		
		СтруктураПоиска = Новый Структура("Заказ", Заказ);
		СтрокиМатериалы = Неопределено;
		СтрокиПродукция = Неопределено;
		Если ТаблицаМатериалы.Количество() > 0 Тогда
			СтрокиМатериалы = ТаблицаМатериалы.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		Если ТаблицаПродукция.Количество() > 0 Тогда
			СтрокиПродукция = ТаблицаПродукция.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		// ТЧ Материалы
		Для Каждого СтрокаТЧ Из ДокОст.Материалы Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			ИначеЕсли СтрокиМатериалы = Неопределено Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
				Продолжить;
			КонецЕсли;
			КодСтрокиНайден = Ложь;
			Для Каждого СтрокаТаб Из СтрокиМатериалы Цикл
				Если СтрокаТаб.КодСтроки = СтрокаТЧ.КодСтроки Тогда
					КодСтрокиНайден = Истина;
					Если СтрокаТаб.Количество <> СтрокаТЧ.Количество Тогда
						СтрокаТЧ.Количество = СтрокаТаб.Количество;
						СтрокаТЧ.Сумма = СтрокаТаб.Сумма;
						СтрокаТЧ.Цена = Окр(СтрокаТаб.Сумма / СтрокаТаб.Количество,2);
					КонецЕсли;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Если НЕ КодСтрокиНайден Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
			КонецЕсли;
		КонецЦикла;
		// ТЧ Продукция
		Для Каждого СтрокаТЧ Из ДокОст.Продукция Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			ИначеЕсли СтрокиПродукция = Неопределено Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
				Продолжить;
			КонецЕсли;
			КодСтрокиНайден = Ложь;
			Для Каждого СтрокаТаб Из СтрокиПродукция Цикл
				Если СтрокаТаб.КодСтроки = СтрокаТЧ.КодСтроки
					И СтрокаТаб.Номенклатура = СтрокаТЧ.Номенклатура Тогда
					КодСтрокиНайден = Истина;
					Если СтрокаТаб.Количество <> СтрокаТЧ.Количество Тогда
						СтрокаТЧ.Количество = СтрокаТаб.Количество;
						СтрокаТЧ.Сумма = СтрокаТаб.Сумма;
						СтрокаТЧ.Цена = Окр(СтрокаТаб.Сумма / СтрокаТаб.Количество,2);
					КонецЕсли;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Если НЕ КодСтрокиНайден Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
			КонецЕсли;
		КонецЦикла;
		//Очистим движения данного заказа, чтобы при перепроведении не мешал контроль остатков
		ОчиститьНаборыЗаписейДвиженийДокумента(МассивРегистровНакопления, Заказ);
		// Очистим движеняи регистра Заказы... по данному заказу, чтобы при проведении не мешал контроль остатков.
		УдалитьДвиженияПоЗаказу("ЗаказыПоставщикам", "ЗаказПоставщику", Заказ);

		ПровестиИлиЗаписатьДокумент(ДокОст);
	КонецЦикла;
	СообщениеСвертки(НСтр("ru='Обработаны Заказы давальца';uk='Опрацьовані Замовлення давальця'")); 
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковЗаказыНаРемонт()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ПланСрез.ОбъектЭксплуатации КАК Узел,
	|	ПланСрез.ВидРемонта,
	|	ПланСрез.РемонтныйЦикл,
	|	Максимум(ПланТаблица.Период) КАК Период,
	|	Максимум(ПланТаблица.Регистратор) КАК ЗаказНаРемонт
	|ПОМЕСТИТЬ ПланРемонтаПоЗаказам
	|ИЗ РегистрСведений.ПланРемонтов.СрезПоследних(&ГраницаОст) КАК ПланСрез
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПланРемонтов КАК ПланТаблица
	|	ПО ПланТаблица.ОбъектЭксплуатации = ПланСрез.ОбъектЭксплуатации
	|		И ПланТаблица.ВидРемонта = ПланСрез.ВидРемонта
	|		И ПланТаблица.РемонтныйЦикл = ПланСрез.РемонтныйЦикл
	|		И ПланТаблица.Период <= &ДатаОст
	|		И ПланТаблица.Регистратор ССЫЛКА Документ.ЗаказНаРемонт
	|СГРУППИРОВАТЬ ПО 
	|	ПланСрез.ОбъектЭксплуатации,
	|	ПланСрез.ВидРемонта,
	|	ПланСрез.РемонтныйЦикл
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаказНаРемонт,
	|	РабочийЦентр,
	|	ДатаНачала,
	|	ДатаЗавершения
	|ПОМЕСТИТЬ РемонтыРабочихЦентров
	|ИЗ РегистрСведений.РемонтыРабочихЦентров
	|ГДЕ ДатаЗавершения > &ДатаОст
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Ссылка
	|ПОМЕСТИТЬ АктуальныеЗаказы
	|ИЗ Документ.ЗаказНаРемонт
	|ГДЕ Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовНаРемонт.Закрыт)
	|	И (Ссылка В (ВЫБРАТЬ ЗаказНаРемонт Из ПланРемонтаПоЗаказам)
	|		ИЛИ Ссылка В (ВЫБРАТЬ ЗаказНаРемонт ИЗ РемонтыРабочихЦентров))
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаказНаВнутреннееПотребление КАК ЗаказНаРемонт,
	|	Номенклатура,
	|	Характеристика,
	|	КодСтроки,
	|	Склад,
	|	Серия,
	|	ЗаказаноОстаток КАК Заказано,
	|	КОформлениюОстаток КАК КОформлению
	|ПОМЕСТИТЬ МатериалыИРаботы
	|ИЗ РегистрНакопления.ЗаказыНаВнутреннееПотребление.Остатки(&ГраницаОст,
	|				ЗаказНаВнутреннееПотребление ССЫЛКА Документ.ЗаказНаРемонт) КАК ТабМатериалыИРаботы
	|ГДЕ ЗаказНаВнутреннееПотребление В (ВЫБРАТЬ РАЗЛИЧНЫЕ Ссылка ИЗ АктуальныеЗаказы)
	|	И ЗаказаноОстаток > 0
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Распоряжение КАК ЗаказНаРемонт,
	|	ВидРабот,
	|	КодСтрокиРаспоряжения КАК КодСтроки,
	|	КоличествоОстаток КАК Количество
	|ПОМЕСТИТЬ Трудозатраты
	|ИЗ РегистрНакопления.ТрудозатратыКОформлению.Остатки(&ГраницаОст,
	|				Распоряжение ССЫЛКА Документ.ЗаказНаРемонт) КАК ТабТрудозатраты
	|ГДЕ Распоряжение В (ВЫБРАТЬ РАЗЛИЧНЫЕ Ссылка ИЗ АктуальныеЗаказы)
	|	И КоличествоОстаток > 0
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Ссылка
	|ИЗ АктуальныеЗаказы
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ *
	|ИЗ МатериалыИРаботы
	|;
	|//////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ *
	|ИЗ Трудозатраты
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	ТаблицаЗаказовНаРемонт = Результат[0].Выгрузить();
	Если ТаблицаЗаказовНаРемонт.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	ТаблицаМатериалыИРаботы = Результат[1].Выгрузить();
	ТаблицаТрудозатраты = Результат[2].Выгрузить();
	МассивРегистровНакопления = РегистрыНакопленияДокумента("ЗаказНаРемонт");
	Для Каждого СтрокаЗаказ Из ТаблицаЗаказовНаРемонт Цикл
		ЗаказНаРемонт = СтрокаЗаказ.ЗаказНаРемонт;
		ДокОст = ЗаказНаРемонт.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ЗафиксироватьИзменениеДокументовВПараметрСвертки();

		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		
		СтруктураПоиска = Новый Структура("ЗаказНаРемонт", ЗаказНаРемонт);
		СтрокиМатериалы = Неопределено;
		СтрокиТрудозатраты = Неопределено;
		Если ТаблицаМатериалыИРаботы.Количество() > 0 Тогда
			СтрокиМатериалы = ТаблицаМатериалыИРаботы.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		Если ТаблицаТрудозатраты.Количество() > 0 Тогда
			СтрокиТрудозатраты = ТаблицаТрудозатраты.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		// ТЧ МатериалыИРаботы
		Если СтрокиМатериалы <> Неопределено И СтрокиМатериалы.Количество() > 0 Тогда
			СчетчикКодов = ПолучитьМаксимальныйКодСтроки(ДокОст.МатериалыИРаботы);
			Для Каждого СтрокаТЧ Из ДокОст.МатериалыИРаботы Цикл
				Если СтрокаТЧ.Отменено Тогда
					Продолжить;
				КонецЕсли;
				КодСтроки = СтрокаТЧ.КодСтроки;
				КодНайден = Ложь;
				
				Для Каждого СтрокаТаб Из СтрокиМатериалы Цикл
					Если СтрокаТаб.КодСтроки <> КодСтроки Тогда
						Продолжить;
					КонецЕсли;
					КодНайден = Истина;
					Если СтрокаТаб.Заказано < СтрокаТЧ.Количество Тогда
						// Добавляем строку с отмененным количеством
						НовСтрока = ДокОст.МатериалыИРаботы.Добавить();
						ЗаполнитьЗначенияСвойств(НовСтрока, СтрокаТЧ);
						НовСтрока.Количество = СтрокаТЧ.Количество - СтрокаТаб.Заказано;
						НовСтрока.Отменено = Истина;
						НовСтрока.КодСтроки = СчетчикКодов;
						СчетчикКодов = СчетчикКодов + 1;
						// Корректируем реальное количество
						СтрокаТЧ.Количество = СтрокаТаб.Заказано;
					КонецЕсли;
					Прервать;
				КонецЦикла;
				Если НЕ КодНайден Тогда
					СтрокаТЧ.Отменено = Истина;
				КонецЕсли;
			КонецЦикла;
		ИначеЕсли ДокОст.МатериалыИРаботы.Количество() > 0 Тогда
			// Отменить все строки ТЧ
			УстановитьОтменуСтрокТабличнойЧасти(ДокОст, "МатериалыИРаботы");
		КонецЕсли;
		// ТЧ Трудозатраты
		Если СтрокиТрудозатраты <> Неопределено И СтрокиТрудозатраты.Количество() > 0 Тогда
			СчетчикКодов = ПолучитьМаксимальныйКодСтроки(ДокОст.Трудозатраты);
			Для Каждого СтрокаТЧ Из ДокОст.Трудозатраты Цикл
				Если СтрокаТЧ.Отменено Тогда
					Продолжить;
				КонецЕсли;
				КодСтроки = СтрокаТЧ.КодСтроки;
				КодНайден = Ложь;
				Если СтрокиТрудозатраты = Неопределено Тогда
					СтрокаТЧ.Отменено = Истина;
					Продолжить;
				КонецЕсли;
				Для Каждого СтрокаТаб Из СтрокиТрудозатраты Цикл
					Если СтрокаТаб.КодСтроки = КодСтроки Тогда
						КодНайден = Истина;
						Если СтрокаТаб.Количество < СтрокаТЧ.Количество Тогда
							// Добавляем строку с отмененным количеством
							НовСтрока = ДокОст.Трудозатраты.Добавить();
							ЗаполнитьЗначенияСвойств(НовСтрока, СтрокаТЧ);
							НовСтрока.Количество = СтрокаТЧ.Количество - СтрокаТаб.Количество;
							НовСтрока.Отменено = Истина;
							НовСтрока.КодСтроки = СчетчикКодов;
							СчетчикКодов = СчетчикКодов + 1;
							// Корректируем реальное количество
							СтрокаТЧ.Количество = СтрокаТаб.Количество;
						КонецЕсли;
						Прервать;
					КонецЕсли;
				КонецЦикла;
				Если НЕ КодНайден Тогда
					СтрокаТЧ.Отменено = Истина;
				КонецЕсли;
			КонецЦикла;
		ИначеЕсли ДокОст.Трудозатраты.Количество() > 0 Тогда
			УстановитьОтменуСтрокТабличнойЧасти(ДокОст, "Трудозатраты");
		КонецЕсли;
		//Очистим движения данного заказа, чтобы при перепроведении не мешал контроль остатков
		ОчиститьНаборыЗаписейДвиженийДокумента(МассивРегистровНакопления, ЗаказНаРемонт);
		// Удалим движения по регистру Заказы... по этому заказу до даты свертки, чтобы не мешал контроль остатков.
		УдалитьДвиженияПоЗаказу("ЗаказыНаВнутреннееПотребление", "ЗаказНаВнутреннееПотребление", ЗаказНаРемонт);

		ПровестиИлиЗаписатьДокумент(ДокОст);
	КонецЦикла;
	СообщениеСвертки(НСтр("ru='Обработаны Заказы на ремонт';uk='Опрацьовані Замовлення на ремонт'")); 

КонецПроцедуры

Процедура СформироватьДокументыОСНМАМеждународныйУчет()
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	СведенияОС.ОсновноеСредство,
	|	ДетальнаяЗапись.Период КАК ДатаПринятияКУчету,
	|	СведенияОС.Организация,
	|	СведенияОС.Подразделение,
	|	СведенияОС.ИнвентарныйНомер,
	|	СведенияОС.СчетУчета,
	|	СведенияОС.ВидАктива,
	|	СведенияОС.ЛиквидационнаяСтоимость,
	|	СведенияОС.ЛиквидационнаяСтоимостьПредставления,
	|	СведенияОС.ПорядокУчета,
	|	СведенияОС.МетодНачисленияАмортизации,
	|	СведенияОС.СчетАмортизации,
	|	СведенияОС.СрокИспользования,
	|	СведенияОС.ПоказательНаработки,
	|	СведенияОС.ОбъемНаработки,
	|	СведенияОС.КоэффициентУскорения,
	|	СведенияОС.СтатьяРасходов,
	|	СведенияОС.АналитикаРасходов
	|ИЗ РегистрСведений.ОсновныеСредстваМеждународныйУчет.СрезПоследних(&ГраницаОст) КАК СведенияОС
	|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ОсновныеСредстваМеждународныйУчет КАК ДетальнаяЗапись
	|	ПО ДетальнаяЗапись.ОсновноеСредство = СведенияОС.ОсновноеСредство
	|	И (ДетальнаяЗапись.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОС.ПринятоКУчету)
	|		ИЛИ ДетальнаяЗапись.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОС.ПринятоКЗабалансовомуУчету))
	|ГДЕ СведенияОС.Состояние <> ЗНАЧЕНИЕ(Перечисление.СостоянияОС.СнятоСУчета)
	|ИТОГИ ПО 
	|	СведенияОС.Организация,
	|	СведенияОС.СчетУчета,
	|	СведенияОС.СчетАмортизации";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	КоличествоСформированныхДокументов = 1;
	Результат = Запрос.Выполнить();
	ТекстЗапросаСтоимость = "ВЫБРАТЬ
	   |	МеждународныйОстатки.Субконто1 КАК Объект,
	   |	Сумма(МеждународныйОстатки.СуммаОстатокДт) КАК ПервоначальнаяСтоимость,
	   |	Сумма(МеждународныйОстатки.СуммаОстатокКт) КАК НакопленнаяАмортизация,
	   |	Сумма(МеждународныйОстатки.СуммаПредставленияОстатокДт) КАК ПервоначальнаяСтоимостьПредставления,
	   |	Сумма(МеждународныйОстатки.СуммаПредставленияОстатокКт) КАК НакопленнаяАмортизацияПредставления
	   |ИЗ
	   |	РегистрБухгалтерии.Международный.Остатки(&ГраницаОст, Счет В ИЕРАРХИИ (&СчетУчета)
	   |		ИЛИ Счет В ИЕРАРХИИ (&СчетАмортизации), &ВидыСубконто, 
	   |		Организация = &Организация) КАК МеждународныйОстатки
	   |СГРУППИРОВАТЬ ПО МеждународныйОстатки.Субконто1";
	ВидыСубконто = Новый Массив;
	ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.ОсновныеСредства);
	ВыборкаОрганизации = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	КоличествоСформированныхДокументов = 1;
	Пока ВыборкаОрганизации.Следующий() Цикл
		ВыборкаСчетДт = ВыборкаОрганизации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаСчетДт.Следующий() Цикл
			ВыборкаСчетКт = ВыборкаСчетДт.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаСчетКт.Следующий() Цикл
				ЗапросСтоимость = Новый Запрос;
				ЗапросСтоимость.Текст = ТекстЗапросаСтоимость;
				ЗаполнитьПараметрыЗапросаДатаСвертки(ЗапросСтоимость);
				ЗапросСтоимость.УстановитьПараметр("ВидыСубконто", ВидыСубконто);
				ЗапросСтоимость.УстановитьПараметр("Организация", ВыборкаСчетКт.Организация);
				ЗапросСтоимость.УстановитьПараметр("СчетУчета", ВыборкаСчетКт.СчетУчета);
				ЗапросСтоимость.УстановитьПараметр("СчетАмортизации", ВыборкаСчетКт.СчетАмортизации);
				ТаблицаСтоимость = ЗапросСтоимость.Выполнить().Выгрузить();
				Выборка = ВыборкаСчетКт.Выбрать();
				Пока Выборка.Следующий() Цикл
					СтрокаСтоимость = ТаблицаСтоимость.НайтиСтроки(Новый Структура("Объект", Выборка.ОсновноеСредство));
					Если СтрокаСтоимость.Количество() = 0 Тогда
						Продолжить;
					КонецЕсли;
					ДокОст = Документы.ВводОстатковОСМеждународныйУчет.СоздатьДокумент();
					ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка, Ложь);
					ЗаполнитьЗначенияСвойств(ДокОст, СтрокаСтоимость[0]);
					ДокОст.Записать(РежимЗаписиДокумента.Запись);
					КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковОСМеждународныйУчет", "");
	КонецЕсли;
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	СведенияНМА.НематериальныйАктив,
	|	ДетальнаяЗапись.Период КАК ДатаПринятияКУчету,
	|	СведенияНМА.Организация,
	|	СведенияНМА.Подразделение,
	|	СведенияНМА.СчетУчета,
	|	СведенияНМА.ЛиквидационнаяСтоимость,
	|	СведенияНМА.ЛиквидационнаяСтоимостьПредставления,
	|	СведенияНМА.ПорядокУчета,
	|	СведенияНМА.МетодНачисленияАмортизации,
	|	СведенияНМА.СчетАмортизации,
	|	СведенияНМА.СрокИспользования,
	|	СведенияНМА.ОбъемНаработки,
	|	СведенияНМА.КоэффициентУскорения,
	|	СведенияНМА.СтатьяРасходов,
	|	СведенияНМА.АналитикаРасходов
	|ИЗ РегистрСведений.НематериальныеАктивыМеждународныйУчет.СрезПоследних(&ГраницаОст) КАК СведенияНМА
	|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.НематериальныеАктивыМеждународныйУчет КАК ДетальнаяЗапись
	|	ПО ДетальнаяЗапись.НематериальныйАктив = СведенияНМА.НематериальныйАктив
	|	И ДетальнаяЗапись.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияНМА.ПринятКУчету)
	|ГДЕ СведенияНМА.Состояние <> ЗНАЧЕНИЕ(Перечисление.СостоянияНМА.Списан)
	|ИТОГИ ПО 
	|	СведенияНМА.Организация,
	|	СведенияНМА.СчетУчета,
	|	СведенияНМА.СчетАмортизации";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	КоличествоСформированныхДокументов = 1;
	Результат = Запрос.Выполнить();
	ВидыСубконто = Новый Массив;
	ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконтоМеждународные.НематериальныеАктивы);
	ВыборкаОрганизации = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	КоличествоСформированныхДокументов = 1;
	Пока ВыборкаОрганизации.Следующий() Цикл
		ВыборкаСчетДт = ВыборкаОрганизации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаСчетДт.Следующий() Цикл
			ВыборкаСчетКт = ВыборкаСчетДт.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаСчетКт.Следующий() Цикл
				ЗапросСтоимость = Новый Запрос;
				ЗапросСтоимость.Текст = ТекстЗапросаСтоимость;
				ЗаполнитьПараметрыЗапросаДатаСвертки(ЗапросСтоимость);
				ЗапросСтоимость.УстановитьПараметр("ВидыСубконто", ВидыСубконто);
				ЗапросСтоимость.УстановитьПараметр("Организация", ВыборкаСчетКт.Организация);
				ЗапросСтоимость.УстановитьПараметр("СчетУчета", ВыборкаСчетКт.СчетУчета);
				ЗапросСтоимость.УстановитьПараметр("СчетАмортизации", ВыборкаСчетКт.СчетАмортизации);
				ТаблицаСтоимость = ЗапросСтоимость.Выполнить().Выгрузить();
				Выборка = ВыборкаСчетКт.Выбрать();
				Пока Выборка.Следующий() Цикл
					СтрокаСтоимость = ТаблицаСтоимость.НайтиСтроки(Новый Структура("Объект", Выборка.НематериальныйАктив));
					Если СтрокаСтоимость.Количество() = 0 Тогда
						Продолжить;
					КонецЕсли;
					ДокОст = Документы.ВводОстатковНМАМеждународныйУчет.СоздатьДокумент();
					ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка, Ложь);
					ЗаполнитьЗначенияСвойств(ДокОст, СтрокаСтоимость[0]);
					ДокОст.Записать(РежимЗаписиДокумента.Запись);
					КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковНМАМеждународныйУчет", "");
	КонецЕсли;

КонецПроцедуры

Процедура СформироватьДокументыУстановкаЗначенийНаработки()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ОбъектЭксплуатации,
	|	ПоказательНаработки,
	|	Значение,
	|	СреднесуточноеЗначение
	|ИЗ РегистрСведений.НаработкиОбъектовЭксплуатации.СрезПоследних(&ГраницаОст)";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	КоличествоСформированныхДокументов = 1;
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	ДокОст = Документы.УстановкаЗначенийНаработки.СоздатьДокумент();
	ДокОст.Дата = КонецДня(ДатаСверткиИБ);
	ДокОст.Комментарий = Комментарий_СформированСверткойБазы;
	ДокОст.Ответственный =  ПользователиКлиентСервер.ТекущийПользователь();
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		Стр = ДокОст.Наработки.Добавить();
		ЗаполнитьЗначенияСвойств(Стр, Выборка);
	КонецЦикла;
	ДокОст.Записать(РежимЗаписиДокумента.Запись);
	ВывестиСообщениеСформированыДокументы("УстановкаЗначенийНаработки");

КонецПроцедуры

Процедура УстановитьОтменуСтрокТабличнойЧасти(ДокОбъект, ИмяТЧ)
	Для Каждого СтрокаТЧ Из ДокОбъект[ИмяТЧ] Цикл
		СтрокаТЧ.Отменено = Истина;
	КонецЦикла;
КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковАналогиВПроизводстве()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	// Шапка документа
	|	ЗаказНаПроизводство, 
	|	Спецификация,
	|	Изделие, 
	|	ХарактеристикаИзделия, 
	|	ЗаказКлиента, 
	|	Подразделение, 
	|	ПериодЗавершения КАК ДатаОкончанияДействия, 
	// ТЧ Материалы
	|	Материал,
	|	ХарактеристикаМатериала,
	|	КоличествоУпаковокМатериала,
	|	УпаковкаМатериала, 
	|	КлючСвязиСпецификация,
	// ТЧ Аналоги
	|	Аналог, 
	|	ХарактеристикаАналога,
	|	УпаковкаАналога, 
	|	КоличествоУпаковокАналога
	|ИЗ РегистрСведений.АналогиМатериалов.СрезПоследних(&ГраницаОст) КАК ТабРег
	|ГДЕ ПериодЗавершения > &ДатаОст ИЛИ ПериодЗавершения = ДАТАВРЕМЯ(1,1,1)
	|ИТОГИ ПО 
	|	ПериодЗавершения,
	|	ЗаказНаПроизводство, 
	|	ЗаказКлиента, 
	|	Подразделение, 
	|	Изделие, 
	|	ХарактеристикаИзделия, 
	|	Спецификация
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	КоличествоДокументовВводаОстатков = 1;
	ВыборкаПериод = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаПериод.Следующий() Цикл
		ВыборкаЗПР = ВыборкаПериод.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаЗПР.Следующий() Цикл
			ВыборкаЗКЛ = ВыборкаЗПР.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаЗКЛ.Следующий() Цикл
				ВыборкаПодр = ВыборкаЗКЛ.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				Пока ВыборкаПодр.Следующий() Цикл
					ВыборкаИзд = ВыборкаПодр.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
					Пока ВыборкаИзд.Следующий() Цикл
						ВыборкаХарИзд = ВыборкаИзд.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам); 
						Пока ВыборкаХарИзд.Следующий() Цикл
							ВыборкаСпец = ВыборкаХарИзд.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
							Пока ВыборкаСпец.Следующий() Цикл
								ДокОст = Документы.РазрешениеНаЗаменуМатериалов.СоздатьДокумент();
								ДокОст.Дата = КонецДня(ДатаСверткиИБ);
								ДокОст.ДатаНачалаДействия = КонецДня(ДатаСверткиИБ);
								ДокОст.УказаниеПоПрименению = Комментарий_СформированСверткойБазы+" ["+КоличествоДокументовВводаОстатков+"]";
								ДокОст.Ответственный =  ПользователиКлиентСервер.ТекущийПользователь();
								ДокОст.Статус = Перечисления.СтатусыРазрешенийНаЗаменуМатериалов.Утверждено;
								ЗаполнитьЗначенияСвойств(ДокОст, ВыборкаСпец);
								Выборка = ВыборкаСпец.Выбрать();
								Пока Выборка.Следующий() Цикл
									// Строка Материалы
									Если ЗначениеЗаполнено(Выборка.Материал) Тогда
										СтрокаМатериал = ДокОст.Материалы.Добавить();
										СтрокаМатериал.Номенклатура = Выборка.Материал;
										СтрокаМатериал.Характеристика = Выборка.ХарактеристикаМатериала;
										СтрокаМатериал.КлючСвязиСпецификация = Выборка.КлючСвязиСпецификация;
										СтрокаМатериал.КоличествоУпаковок = Выборка.КоличествоУпаковокМатериала;
										СтрокаМатериал.Упаковка = Выборка.УпаковкаМатериала;
									КонецЕсли;
									// Строка Аналоги
									Если ЗначениеЗаполнено(Выборка.Аналог) Тогда
										СтрокаАналог = ДокОст.Аналоги.Добавить();
										СтрокаАналог.КоличествоУпаковок = Выборка.КоличествоУпаковокАналога;
										СтрокаАналог.Номенклатура = Выборка.Аналог;
										СтрокаАналог.Упаковка = Выборка.УпаковкаАналога;
										СтрокаАналог.Характеристика = Выборка.ХарактеристикаАналога;
									КонецЕсли;
								КонецЦикла;
								ДокОст.Записать(РежимЗаписиДокумента.Запись);
								КоличествоДокументовВводаОстатков = КоличествоДокументовВводаОстатков + 1;
							КонецЦикла;
						КонецЦикла;
					КонецЦикла;
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	Если КоличествоДокументовВводаОстатков > 0 Тогда
		ВывестиСообщениеСформированыДокументы("РазрешениеНаЗаменуМатериалов", 
									"");
	КонецЕсли;
КонецПроцедуры

//-- НЕ УТКА

//++ НЕ УТ
Процедура СформироватьДокументыУстановкаЗначенийНефинансовыхПоказателей()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	Организация,
	|	Сценарий,
	|	Подразделение,
	|	НефинансовыйПоказатель КАК Показатель,
	|	Аналитика1,
	|	Аналитика2,
	|	Аналитика3,
	|	Аналитика4,
	|	Аналитика5,
	|	Аналитика6,
	|	НомерПодПериода,
	|	ЗначениеПоказателя,
	|	Валюта,
	|	ДатаОкончания КАК ОкончаниеПериода
	|ИЗ РегистрСведений.ЗначенияНефинансовыхПоказателей.СрезПоследних(&ГраницаОст)";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	КоличествоДокументовВводаОстатков = 1;
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		ДокОст = Документы.УстановкаЗначенийНефинансовыхПоказателей.СоздатьДокумент();
		ДокОст.Дата = КонецДня(ДатаСверткиИБ);
		ДокОст.НачалоПериода = КонецДня(ДатаСверткиИБ);
		ДокОст.Комментарий = Комментарий_СформированСверткойБазы+" ["+КоличествоДокументовВводаОстатков+"]";
		ДокОст.Ответственный =  ПользователиКлиентСервер.ТекущийПользователь();
		ДокОст.ВидОперации = Перечисления.ВидыОперацийУстановкиЗначенийНефинансовыхПоказателей.ВводЗначенияПоказателя;
		ЗаполнитьЗначенияСвойств(ДокОст, Выборка);
		СтрЗначение = ДокОст.ЗначенияПоказателей.Добавить();
		ЗаполнитьЗначенияСвойств(СтрЗначение, Выборка);
		ДокОст.Записать(РежимЗаписиДокумента.Запись);
		КоличествоДокументовВводаОстатков = КоличествоДокументовВводаОстатков + 1;
	КонецЦикла;
	// Дата регистратора до даты свертки а дата движения после даты свертки. Такие документы переносятся после даты свертки.
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ДанныеРегистра.Период,
	|	ДанныеРегистра.Регистратор КАК Ссылка
	|ИЗ РегистрСведений.ЗначенияНефинансовыхПоказателей КАК ДанныеРегистра
	|ЛЕВОЕ СОЕДИНЕНИЕ Документ.УстановкаЗначенийНефинансовыхПоказателей КАК ДанныеДокумента
	|ПО ДанныеРегистра.Регистратор = ДанныеДокумента.Ссылка
	|ГДЕ ДанныеДокумента.Дата <= &ДатаОст И ДанныеРегистра.Период > &ДатаОст";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		ДокОст = Выборка.Ссылка.ПолучитьОбъект();
		ДокОст.Дата = КонецДня(ДатаСверткиИБ);
		ДокОст.НачалоПериода = КонецДня(ДатаСверткиИБ);
		ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина); 
		ДокОст.Комментарий = Комментарий_СформированСверткойБазы+" ["+КоличествоДокументовВводаОстатков+"]";
		ДокОст.Записать(РежимЗаписиДокумента.Запись);
		КоличествоДокументовВводаОстатков = КоличествоДокументовВводаОстатков + 1;
	КонецЦикла;
	
	ВывестиСообщениеСформированыДокументы("УстановкаЗначенийНефинансовыхПоказателей", 
									"");

КонецПроцедуры

Процедура ОбработатьНормативыРаспределенияПлановПродаж()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|	Норматив,
	|	Норматив.Комментарий КАК Комментарий
	|ИЗ РегистрСведений.НормативыРаспределенияПлановПродажПоКатегориям.СрезПоследних(&ГраницаОст)
	|ГДЕ Действует = Истина";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		Если СтрНайти(Выборка.Комментарий, Комментарий_НеУдалятьПриСверткеБазы) Тогда
			Продолжить;
		КонецЕсли;
		ДокОбъект = Выборка.Норматив.ПолучитьОбъект();
		ДополнитьКомментарийДокумента(ДокОбъект,Комментарий_НеУдалятьПриСверткеБазы);
		ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
	КонецЦикла;
	СообщениеСвертки(НСтр("ru='Обработаны Нормативы распределения планов продаж по категориям';uk='Опрацьовані Нормативи розподілу планів продажів по категоріях'")); 
КонецПроцедуры

Функция ПолучитьМаксимальныйКодСтроки(ТабЧасть)
	КодМакс = 0;
	Для Каждого СтрТЧ Из ТабЧасть Цикл
		Если СтрТЧ.КодСтроки > КодМакс Тогда
			КодМакс = СтрТЧ.КодСтроки;
		КонецЕсли;
	КонецЦикла;
	Возврат КодМакс + 1;
КонецФункции

Процедура СформироватьДокументыВводаОстатковЗаказыМатериаловВПроизводство()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	Распоряжение КАК Заказ,
	|	Номенклатура КАК Номенклатура,
	|	Характеристика КАК Характеристика,
	|	КодСтроки КАК КодСтроки,
	|	Серия КАК Серия,
	|	ЗаказаноОстаток КАК Количество
	|ИЗ РегистрНакопления.ЗаказыМатериаловВПроизводство.Остатки(&ГраницаОст, Распоряжение ССЫЛКА Документ.ЗаказМатериаловВПроизводство) КАК ТабРег
	|ГДЕ ТабРег.ЗаказаноОстаток > 0
	|ИТОГИ ПО Распоряжение";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	МассивРегистровНакопления = РегистрыНакопленияДокумента("ЗаказМатериаловВПроизводство");

	ВыборкаЗаказы = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаЗаказы.Следующий() Цикл
		ДокОст = ВыборкаЗаказы.Заказ.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ЗафиксироватьИзменениеДокументовВПараметрСвертки();

		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		СчетчикКодов = ПолучитьМаксимальныйКодСтроки(ДокОст.Товары);
		Выборка = ВыборкаЗаказы.Выбрать();
		Для Каждого СтрТЧ Из ДокОст.Товары Цикл
			Если СтрТЧ.Отменено Тогда
				Продолжить;
			КонецЕсли;
			Если Выборка.НайтиСледующий(Новый Структура("КодСтроки", СтрТЧ.КодСтроки)) Тогда
				Если Выборка.Количество < СтрТЧ.Количество Тогда
					// Новая строка с отмененным количеством.
					НовСтр = ДокОст.Товары.Добавить();
					ЗаполнитьЗначенияСвойств(НовСтр, СтрТЧ);
					НовСтр.Отменено = Истина;
					НовСтр.Количество = СтрТЧ.Количество - Выборка.Количество;
					НовСтр.КодСтроки = СчетчикКодов;
					СчетчикКодов = СчетчикКодов + 1;
					// Корректировка количества в найденной строке.
					СтрТЧ.Количество = Выборка.Количество;
				КонецЕсли;
			Иначе
				СтрТЧ.Отменено = Истина;
			КонецЕсли;
		КонецЦикла;
		//Очистим движения данного заказа, чтобы при перепроведении не мешал контроль остатков
		ОчиститьНаборыЗаписейДвиженийДокумента(МассивРегистровНакопления, ВыборкаЗаказы.Заказ);

		ПровестиИлиЗаписатьДокумент(ДокОст);
	КонецЦикла;
	СообщениеСвертки(НСтр("ru='Обработаны Заказы материалов в производство';uk='Опрацьовані Замовлення матеріалів у виробництво'")); 

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковЗаказыПереработчику()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ТабРег.ЗаказКлиента КАК Заказ,
	|	ТабРег.Номенклатура КАК Номенклатура,
	|	ТабРег.Характеристика КАК Характеристика,
	|	ТабРег.КодСтроки КАК КодСтроки,
	|	ТабРег.Склад КАК Склад,
	|	ТабРег.Серия КАК Серия,
	|	ТабРег.ЗаказаноОстаток КАК Количество,
	|	ТабРег.СуммаОстаток КАК Сумма
	|ПОМЕСТИТЬ Материалы
	|ИЗ РегистрНакопления.ЗаказыКлиентов.Остатки(&ГраницаОст, ЗаказКлиента ССЫЛКА Документ.ЗаказПереработчику
	|									И ЗаказКлиента.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовПереработчикам.Закрыт)) КАК ТабРег
	|ГДЕ ТабРег.ЗаказаноОстаток>0  
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабРег.ЗаказПоставщику КАК Заказ,
	|	ТабРег.Номенклатура КАК Номенклатура,
	|	ТабРег.Характеристика КАК Характеристика,
	|	ТабРег.КодСтроки КАК КодСтроки,
	|	ТабРег.Склад КАК Склад,
	|	ТабРег.ЗаказаноОстаток КАК Количество
	|ПОМЕСТИТЬ ПродукцияРазвернуто
	|ИЗ РегистрНакопления.ЗаказыПоставщикам.Остатки(&ГраницаОст, ЗаказПоставщику ССЫЛКА Документ.ЗаказПереработчику
	|										И ЗаказПоставщику.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовПереработчикам.Закрыт)) КАК ТабРег
	|ГДЕ ТабРег.ЗаказаноОстаток>0 
	|ОБЪЕДИНИТЬ ВСЕ
	// Остатки которые закроются поступлением от переработчика.
	|ВЫБРАТЬ
	|	ТабРег.Распоряжение,
	|	ТабРег.АналитикаУчетаНоменклатуры.Номенклатура,
	|	ТабРег.АналитикаУчетаНоменклатуры.Характеристика,
	|	ТабРег.КодСтроки,
	|	ТабРег.АналитикаУчетаНоменклатуры.МестоХранения,
	|	ТабРег.КоличествоОстаток
	|ИЗ
	|	РегистрНакопления.ТоварыПолученныеОтПереработчика.Остатки(&ГраницаОст, Распоряжение ССЫЛКА Документ.ЗаказПереработчику
	|							И АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)) КАК ТабРег
	|ГДЕ ТабРег.КоличествоОстаток>0 
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Заказ,
	|	Номенклатура,
	|	Характеристика,
	|	КодСтроки,
	|	Склад,
	|	Сумма(Количество),
	|	ЛОЖЬ КАК Отражено
	|ПОМЕСТИТЬ Продукция
	|ИЗ
	|ПродукцияРазвернуто
	|СГРУППИРОВАТЬ ПО
	|	Заказ,
	|	Номенклатура,
	|	Характеристика,
	|	КодСтроки,
	|	Склад
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаказПереработчику КАК Заказ,
	|	СуммаОстаток КАК Сумма
	|ПОМЕСТИТЬ УслугиПереработчиковКОформлению
	|ИЗ РегистрНакопления.УслугиПереработчиковКОформлению.Остатки(&ГраницаОст, ЗаказПереработчику.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовПереработчикам.Закрыт))
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Заказ
	|ИЗ (
	|ВЫБРАТЬ Заказ
	|ИЗ Материалы
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ Заказ
	|ИЗ Продукция
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ Заказ
	|ИЗ УслугиПереработчиковКОформлению
	|) КАК СводЗаказов
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ *
	|ИЗ Материалы
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ *
	|ИЗ Продукция
	|;
	|////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ *
	|ИЗ УслугиПереработчиковКОформлению 
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	ТаблицаЗаказов = Результат[0].Выгрузить();
	Если ТаблицаЗаказов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	ТаблицаМатериалы = Результат[1].Выгрузить();
	ТаблицаПродукция = Результат[2].Выгрузить();
	ТаблицаУслуги = Результат[3].Выгрузить();
	МассивРегистровНакопления = РегистрыНакопленияДокумента("ЗаказПереработчику");
	
	//Определим причину отмены заказов
	ПричинаОтменыЗаказа = Справочники.ПричиныОтменыЗаказовКлиентов.НайтиПоНаименованию(НСтр("ru='#Свертка базы';uk='#Згортка бази'"));
	Если ПричинаОтменыЗаказа = Неопределено ИЛИ ПричинаОтменыЗАказа.Пустая() Тогда
		ПричинаОтменыЗаказаОбъект = Справочники.ПричиныОтменыЗаказовКлиентов.СоздатьЭлемент();
		ПричинаОтменыЗаказаОбъект.Наименование = НСтр("ru='#Свертка базы';uk='#Згортка бази'");
		ПричинаОтменыЗаказаОбъект.Записать();
		ПричинаОтменыЗаказа = ПричинаОтменыЗаказаОбъект.Ссылка;
	КонецЕсли;
	
	Для Каждого СтрокаЗаказ Из ТаблицаЗаказов Цикл
		Заказ = СтрокаЗаказ.Заказ;
		ДокОст = Заказ.ПолучитьОбъект();
		Если ДокОст = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		ЗафиксироватьИзменениеДокументовВПараметрСвертки();

		ДополнитьКомментарийДокумента(ДокОст, Комментарий_НеУдалятьПриСверткеБазы);
		
		СтруктураПоиска = Новый Структура("Заказ", Заказ);
		СтрокиМатериалы = Неопределено;
		СтрокиПродукция = Неопределено;
		СтрокиУслуги = Неопределено;
		СтрокиСпецификации = Неопределено;
		Если ТаблицаМатериалы.Количество() > 0 Тогда
			СтрокиМатериалы = ТаблицаМатериалы.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		Если ТаблицаПродукция.Количество() > 0 Тогда
			СтрокиПродукция = ТаблицаПродукция.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		Если ТаблицаУслуги.Количество() > 0 Тогда
			СтрокиУслуги = ТаблицаУслуги.НайтиСтроки(СтруктураПоиска);
		КонецЕсли;
		Если СтрокиУслуги = Неопределено Тогда
			ДокОст.СуммаДокумента = 0;
		Иначе
			ДокОст.СуммаДокумента = СтрокиУслуги[0].Сумма;
		КонецЕсли;
		// ТЧ Материалы
		Для Каждого СтрокаТЧ Из ДокОст.Материалы Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			ИначеЕсли СтрокиМатериалы = Неопределено Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
				Продолжить;
			КонецЕсли;
			КодСтрокиНайден = Ложь;
			Для Каждого СтрокаТаб Из СтрокиМатериалы Цикл
				Если СтрокаТаб.КодСтроки = СтрокаТЧ.КодСтроки Тогда
					КодСтрокиНайден = Истина;
					Если СтрокаТаб.Количество <> СтрокаТЧ.Количество Тогда
						СтрокаТЧ.Количество = СтрокаТаб.Количество;
						СтрокаТЧ.Сумма = СтрокаТаб.Сумма;
						СтрокаТЧ.Цена = Окр(СтрокаТаб.Сумма / СтрокаТаб.Количество,2);
					КонецЕсли;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Если НЕ КодСтрокиНайден Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
			КонецЕсли;
		КонецЦикла;
		// ТЧ Продукция
		Для Каждого СтрокаТЧ Из ДокОст.Продукция Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			ИначеЕсли СтрокиПродукция = Неопределено Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
				Продолжить;
			КонецЕсли;
			КодСтрокиНайден = Ложь;
			Для Каждого СтрокаТаб Из СтрокиПродукция Цикл
				Если СтрокаТаб.КодСтроки = СтрокаТЧ.КодСтроки
					И СтрокаТаб.Номенклатура = СтрокаТЧ.Номенклатура Тогда
					КодСтрокиНайден = Истина;
					Если СтрокаТаб.Количество <> СтрокаТЧ.Количество Тогда
						СтрокаТЧ.Количество = СтрокаТаб.Количество;
					КонецЕсли;
					СтрокаТаб.Отражено = Истина;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Если НЕ КодСтрокиНайден Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
			КонецЕсли;
		КонецЦикла;
		// ТЧ ВозвратныеОтходы
		Для Каждого СтрокаТЧ Из ДокОст.ВозвратныеОтходы Цикл
			Если СтрокаТЧ.Отменено Тогда
				Продолжить;
			ИначеЕсли СтрокиПродукция = Неопределено Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
				Продолжить;
			КонецЕсли;
			КодСтрокиНайден = Ложь;
			Для Каждого СтрокаТаб Из СтрокиПродукция Цикл
				Если СтрокаТаб.КодСтроки = СтрокаТЧ.КодСтроки
					И СтрокаТаб.Номенклатура = СтрокаТЧ.Номенклатура Тогда
					КодСтрокиНайден = Истина;
					СтрокаТаб.Отражено = Истина;
					Если СтрокаТаб.Количество <> СтрокаТЧ.Количество Тогда
						СтрокаТЧ.Количество = СтрокаТаб.Количество;
						СтрокаТЧ.Сумма = СтрокаТЧ.Цена * СтрокаТЧ.Количество;
					КонецЕсли;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Если НЕ КодСтрокиНайден Тогда
				СтрокаТЧ.Отменено = Истина;
				СтрокаТЧ.ПричинаОтмены = ПричинаОтменыЗаказа;
			КонецЕсли;
		КонецЦикла;
		// Добавление строк продукции.
		Для Каждого СтрокаТаб Из СтрокиПродукция Цикл
			Если СтрокаТаб.Отражено Тогда
				Продолжить;
			КонецЕсли;
			СтрокаТЧ = ДокОст.Продукция.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТЧ, СтрокаТаб);
			СтрокаТаб.Отражено = Истина;
		КонецЦикла;
		//Очистим движения данного заказа, чтобы при перепроведении не мешал контроль остатков
		ОчиститьНаборыЗаписейДвиженийДокумента(МассивРегистровНакопления, Заказ);
		// Удалим движения по регистру Заказы... по этому заказу до даты свертки, чтобы не мешал контроль остатков.
		УдалитьДвиженияПоЗаказу("ЗаказыКлиентов", "ЗаказКлиента", Заказ);
		УдалитьДвиженияПоЗаказу("ЗаказыПоставщикам", "ЗаказПоставщику", Заказ);

		ПровестиИлиЗаписатьДокумент(ДокОст);
	КонецЦикла;
	СообщениеСвертки(НСтр("ru='Обработаны Заказы переработчику';uk='Опрацьовані Замовлення переробнику'")); 

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковПоступлениеОтПереработчика()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
		|	ТабРег.Организация КАК Организация,
		|	ВЫБОР КОГДА ТабРег.Распоряжение ССЫЛКА Документ.ЗаказПереработчику Тогда
		|		ТабРег.Распоряжение 
		|	ИНАЧЕ NULL КОНЕЦ КАК ЗаказПереработчику,
		|	ТабРег.КодСтроки,
		|	ТабРег.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ТабРег.КоличествоОстаток КАК Количество,
		|	ТабРег.Распоряжение.Контрагент КАК Контрагент,
		|	ТабРег.Распоряжение.Партнер КАК Партнер,
		|	ТабРег.Распоряжение.Договор КАК Договор
		|ПОМЕСТИТЬ ОстаткиЗаполненоРаспоряжение
		|ИЗ РегистрНакопления.ТоварыПолученныеОтПереработчика.Остатки(&ГраницаОст,
		|	(ВЫРАЗИТЬ(Распоряжение КАК Документ.ЗаказПереработчику) <> ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка)
		|		ИЛИ ВЫРАЗИТЬ(Распоряжение КАК Документ.ПоступлениеОтПереработчика) <> ЗНАЧЕНИЕ(Документ.ПоступлениеОтПереработчика.ПустаяСсылка))
		|															) КАК ТабРег
		|ГДЕ ТабРег.КоличествоОстаток > 0
		|;
		|//////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабРег.Организация КАК Организация,
		|	ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) КАК ЗаказПереработчику,
		|	ТабРег.КодСтроки,
		|	ТабРег.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ТабРег.КоличествоКонечныйОстаток КАК Количество,
		|	ВЫБОР КОГДА ТабРег.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика ТОГДА
		|		ВЫРАЗИТЬ(ТабРег.Регистратор КАК Документ.ПоступлениеОтПереработчика).Договор
		|	КОГДА ТабРег.Регистратор ССЫЛКА Документ.ОтчетПереработчика ТОГДА
		|		ВЫРАЗИТЬ(ТабРег.Регистратор КАК Документ.ОтчетПереработчика).Договор
		|	КОНЕЦ КАК Договор,
		|	ВЫБОР КОГДА ТабРег.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика ТОГДА
		|		ВЫРАЗИТЬ(ТабРег.Регистратор КАК Документ.ПоступлениеОтПереработчика).Контрагент
		|	КОГДА ТабРег.Регистратор ССЫЛКА Документ.ОтчетПереработчика ТОГДА
		|		ВЫРАЗИТЬ(ТабРег.Регистратор КАК Документ.ОтчетПереработчика).Контрагент
		|	КОНЕЦ КАК Контрагент,
		|	ВЫБОР КОГДА ТабРег.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика ТОГДА
		|		ВЫРАЗИТЬ(ТабРег.Регистратор КАК Документ.ПоступлениеОтПереработчика).Партнер
		|	КОГДА ТабРег.Регистратор ССЫЛКА Документ.ОтчетПереработчика ТОГДА
		|		ВЫРАЗИТЬ(ТабРег.Регистратор КАК Документ.ОтчетПереработчика).Партнер
		|	КОНЕЦ КАК Партнер,
		|	ТабРег.КоличествоПриход КАК КоличествоПриход
		|ПОМЕСТИТЬ ОстаткиПустоеРаспоряжение
		|ИЗ
		|	РегистрНакопления.ТоварыПолученныеОтПереработчика.ОстаткиИОбороты(, &ГраницаОст, Регистратор,,
		|	(ВЫРАЗИТЬ(Распоряжение КАК Документ.ЗаказПереработчику) = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка)
		|		И ВЫРАЗИТЬ(Распоряжение КАК Документ.ПоступлениеОтПереработчика) = ЗНАЧЕНИЕ(Документ.ПоступлениеОтПереработчика.ПустаяСсылка))
		|															) КАК ТабРег
		|ГДЕ ТабРег.КоличествоКонечныйОстаток > 0 И ТабРег.КоличествоПриход > 0
		|;
		|//////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Организация,
		|	ЗаказПереработчику,
		|	КодСтроки,
		|	АналитикаУчетаНоменклатуры,
		|	Контрагент,
		|	Партнер,
		|	Договор,
		|	Сумма(Количество) КАК Количество
		|ПОМЕСТИТЬ ОстаткиПоКоличеству
		|ИЗ
		|	(ВЫБРАТЬ
		|		Организация,
		|		ЗаказПереработчику,
		|		КодСтроки,
		|		АналитикаУчетаНоменклатуры,
		|		Контрагент,
		|		Партнер,
		|		Договор,
		|		Количество
		|	ИЗ ОстаткиЗаполненоРаспоряжение
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ
		|		Организация,
		|		ЗаказПереработчику,
		|		КодСтроки,
		|		АналитикаУчетаНоменклатуры,
		|		Контрагент,
		|		Партнер,
		|		Договор,
		|		Количество
		|	ИЗ ОстаткиПустоеРаспоряжение) КАК Свод
		|СГРУППИРОВАТЬ ПО
		|	Организация,
		|	ЗаказПереработчику,
		|	КодСтроки,
		|	АналитикаУчетаНоменклатуры,
		|	Контрагент,
		|	Партнер,
		|	Договор
		|;
		|//////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабРег.Организация,
		|	ТабРег.ЗаказПереработчику,
		|	ТабРег.Контрагент,
		|	ТабРег.Договор,
		|	ВЫРАЗИТЬ(ТабРег.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады) КАК Склад,
		|	ТабРег.Партнер,
		|	ТабРег.Договор.ВалютаВзаиморасчетов КАК Валюта,
		|	ТабРег.КодСтроки,
		|	ТабРег.АналитикаУчетаНоменклатуры,
		|	ТабРег.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ТабРег.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ВЫБОР КОГДА ЕстьNULL(ТабРегПартии.КоличествоОстаток, 0) = 0 ТОГДА 0 
		|		ИНАЧЕ	ВЫРАЗИТЬ(ТабРегПартии.СтоимостьОстаток / ТабРегПартии.КоличествоОстаток КАК ЧИСЛО(31,2)) 
		|	КОНЕЦ КАК Цена,
		|	ТабРег.Количество
		|	ИЗ ОстаткиПоКоличеству КАК ТабРег
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&ГраницаОст) КАК ТабРегПартии
		|	ПО ТабРег.АналитикаУчетаНоменклатуры = ТабРегПартии.АналитикаУчетаНоменклатуры И
		|		ТабРег.Организация = ТабРегПартии.Организация И 
		|		ТабРегПартии.ВидЗапасов.Договор = ТабРег.Договор
		|ИТОГИ ПО 
		|	ТабРег.Организация,
		|	ТабРег.ЗаказПереработчику, 
		|	ТабРег.Контрагент, 
		|	ТабРег.Договор, 
		|	ТабРег.АналитикаУчетаНоменклатуры.МестоХранения
		|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	КоличествоСформированныхДокументов = 1;
	ВыборкаОрганизация = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаОрганизация.Следующий() Цикл
		ВыборкаЗаказ = ВыборкаОрганизация.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаЗаказ.Следующий() Цикл
			ВыборкаКонтрагент = ВыборкаЗаказ.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаКонтрагент.Следующий() Цикл
				ВыборкаДоговор = ВыборкаКонтрагент.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				Пока ВыборкаДоговор.Следующий() Цикл
					ВыборкаСклад = ВыборкаДоговор.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
					Пока ВыборкаСклад.Следующий() Цикл

						ДокОст = Документы.ПоступлениеОтПереработчика.СоздатьДокумент();
						ДокОст.Дата = КонецДня(ДатаСверткиИБ);
						ДокОст.Комментарий = Комментарий_СформированСверткойБазы+" ["+КоличествоСформированныхДокументов+"]";
						ДокОст.Автор =  ПользователиКлиентСервер.ТекущийПользователь();
						ЗаполнитьЗначенияСвойств(ДокОст, ВыборкаСклад);

						ДокОст.ПоступлениеПоЗаказам = ЗначениеЗаполнено(ВыборкаСклад.ЗаказПереработчику);
						Выборка = ВыборкаДоговор.Выбрать();
						Пока Выборка.Следующий() Цикл
							Стр = ДокОст.Товары.Добавить();
							ЗаполнитьЗначенияСвойств(Стр, Выборка);
							Стр.Сумма = Окр(Стр.Количество * Стр.Цена, 2);
							Стр.КоличествоУпаковок = Стр.Количество;
						КонецЦикла;
						ДокОст.Записать(РежимЗаписиДокумента.Запись);
						КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
					КонецЦикла; // ВыборкаСклад
				КонецЦикла; // ВыборкаДоговор 
			КонецЦикла; // ВыборкаКонтрагент
		КонецЦикла; // ВыборкаЗаказ
	КонецЦикла; // ВыборкаОрганизация
	ВывестиСообщениеСформированыДокументы("ПоступлениеОтПереработчика");

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковПередачаПереработчику()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ТабРег.ВидЗапасов.Организация КАК Организация,
	|	ТабСебестоимость.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	ВЫРАЗИТЬ(ТабРег.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Партнеры) КАК Партнер,
	|	ТабРег.ВидЗапасов,
	|	ТабРег.АналитикаУчетаНоменклатуры,
	|	ТабРег.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	ТабРег.АналитикаУчетаНоменклатуры.Номенклатура.СтавкаНДС КАК СтавкаНДС,
	|	ТабРег.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ВЫБОР КОГДА ЕстьNULL(ТабСебестоимость.КоличествоОстаток, 0) = 0 ТОГДА 0
	|	ИНАЧЕ ВЫРАЗИТЬ(ТабСебестоимость.СтоимостьОстаток / ТабСебестоимость.КоличествоОстаток КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК Цена,
	|	ВЫБОР КОГДА ЕстьNULL(ТабСебестоимость.КоличествоОстаток, 0) = 0 ТОГДА 0
	|	ИНАЧЕ ВЫРАЗИТЬ(ТабСебестоимость.СтоимостьРеглОстаток / ТабСебестоимость.КоличествоОстаток КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК ЦенаРегл,
	|	ВЫБОР КОГДА ЕстьNULL(ТабСебестоимость.КоличествоОстаток, 0) = 0 ТОГДА 0
	|	ИНАЧЕ ВЫРАЗИТЬ(ТабСебестоимость.СтоимостьУпрОстаток / ТабСебестоимость.КоличествоОстаток КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК ЦенаУпр,
	|	ВЫБОР КОГДА ЕстьNULL(ТабСебестоимость.КоличествоОстаток, 0) = 0 ТОГДА 0
	|	ИНАЧЕ ВЫРАЗИТЬ(ТабСебестоимость.СтоимостьБезНДСОстаток / ТабСебестоимость.КоличествоОстаток КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК ЦенаБезНДС,
	|	ТабРег.КоличествоОстаток КАК Количество,
	|	ЕстьNULL(ТабСебестоимость.КоличествоОстаток, 0) КАК КоличествоПартии
	|ИЗ РегистрНакопления.ТоварыПереданныеПереработчику.Остатки(&ГраницаОст) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаОст, 
	|	РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)) КАК ТабСебестоимость
	|ПО ТабРег.АналитикаУчетаНоменклатуры = ТабСебестоимость.АналитикаУчетаНоменклатуры
	|	И (ТабРег.ВидЗапасов = ТабСебестоимость.ВидЗапасов)
	|ГДЕ ТабРег.КоличествоОстаток > 0
	|ИТОГИ ПО
	|	ТабРег.ВидЗапасов.Организация,
	|	ТабСебестоимость.ВидДеятельностиНДС,
	|	ВЫРАЗИТЬ(ТабРег.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Партнеры)
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	КоличествоСформированныхДокументов = 1;
	ВыборкаОрганизация = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаОрганизация.Следующий() Цикл
		ВыборкаНалогообложение = ВыборкаОрганизация.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаНалогообложение.Следующий() Цикл
			ВыборкаКонтрагент = ВыборкаНалогообложение.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаКонтрагент.Следующий() Цикл
				ДокОст = Документы.ВводОстатковТоваров.СоздатьДокумент();
				ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаКонтрагент);
				Если НЕ ЗначениеЗаполнено(ДокОст.ВидДеятельностиНДС) Тогда
					ПараметрыУчетаПоОрганизации = УчетНДСУП.ПараметрыУчетаПоОрганизации(ДокОст.Организация, ДокОст.Дата);
					ДокОст.ВидДеятельностиНДС = ПараметрыУчетаПоОрганизации.ОсновнойВидДеятельностиНДСЗакупки;
				КонецЕсли;
				ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковМатериаловПереданныхПереработчикам;
				ПартнерыИКонтрагенты.ЗаполнитьКонтрагентаПартнераПоУмолчанию(ДокОст.Партнер, ДокОст.Контрагент, Истина);
				Выборка = ВыборкаКонтрагент.Выбрать();
				Пока Выборка.Следующий() Цикл
					Стр = ДокОст.Товары.Добавить();
					ЗаполнитьЗначенияСвойств(Стр, Выборка);
					Если Выборка.КоличествоПартии < Выборка.Количество
						И Выборка.КоличествоПартии > 0 Тогда
						Стр.Количество = Выборка.КоличествоПартии;
					КонецЕсли;
					Стр.КоличествоУпаковок = Стр.Количество;
					Стр.СуммаБезНДС = ?(Выборка.ЦенаБезНДС > 0, Окр(Выборка.ЦенаБезНДС * Стр.Количество, 2), 0);
					Стр.Сумма = ?(Выборка.Цена > 0 ,Окр(Выборка.Цена * Стр.Количество, 2),0);
					Стр.СуммаРегл = ?(Выборка.ЦенаРегл > 0, Окр(Выборка.ЦенаРегл * Стр.Количество, 2), 0);
					Стр.СуммаНДС = Стр.Сумма - Стр.СуммаБезНДС;
					Стр.НДСРегл = ?(Стр.Сумма = 0, 0, Стр.СуммаНДС * (Стр.СуммаРегл / Стр.Сумма));
				КонецЦикла;
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
			КонецЦикла;  //ВыборкаКонтрагент
		КонецЦикла;  //ВыборкаНалогообложение
	КонецЦикла;    //ВыборкаОрганизация
	ВывестиСообщениеСформированыДокументы("ВводОстатковТоваров", 
									Перечисления.ХозяйственныеОперации.ВводОстатковМатериаловПереданныхПереработчикам);

КонецПроцедуры

Процедура СформироватьДокументыВводаОстатковМатериалыВПроизводстве()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|	ТабРег.Организация,
	|	ТабРег.Номенклатура,
	|	ТабРег.Характеристика,
	|	ТабСтоимость.АналитикаУчетаНоменклатуры,
	|	ТабСтоимость.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	ТабРег.Подразделение,
	|	ТабРег.Серия,
	|	ВЫБОР КОГДА ЕстьNULL(ТабСтоимость.КоличествоОстаток, 0) = 0 ТОГДА 0
	|	ИНАЧЕ ВЫРАЗИТЬ(ТабСтоимость.СтоимостьОстаток / ТабСтоимость.КоличествоОстаток КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК Цена,
	|	ВЫБОР КОГДА ЕстьNULL(ТабСтоимость.КоличествоОстаток, 0) = 0 ТОГДА 0
	|	ИНАЧЕ ВЫРАЗИТЬ(ТабСтоимость.СтоимостьРеглОстаток / ТабСтоимость.КоличествоОстаток КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК ЦенаРегл,
	|	ВЫБОР КОГДА ЕстьNULL(ТабСтоимость.КоличествоОстаток, 0) = 0 ТОГДА 0
	|	ИНАЧЕ ВЫРАЗИТЬ(ТабСтоимость.СтоимостьУпрОстаток / ТабСтоимость.КоличествоОстаток КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК ЦенаУпр,
	|	ВЫБОР КОГДА ЕстьNULL(ТабСтоимость.КоличествоОстаток, 0) = 0 ТОГДА 0
	|	ИНАЧЕ ВЫРАЗИТЬ(ТабСтоимость.СтоимостьБезНДСОстаток / ТабСтоимость.КоличествоОстаток КАК ЧИСЛО(31,2))
	|	КОНЕЦ КАК ЦенаБезНДС,
	|	ТабРег.КоличествоОстаток КАК Количество,
	|	ЕстьNULL(ТабСтоимость.КоличествоОстаток, 0) КАК КоличествоПартии
	|ИЗ РегистрНакопления.МатериалыИРаботыВПроизводстве.Остатки(&ГраницаОст, Подразделение ССЫЛКА Справочник.СтруктураПредприятия) КАК ТабРег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Остатки(&ГраницаОст, 
	|				РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|				ИЛИ РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)) КАК ТабСтоимость
	|ПО  ТабРег.Номенклатура = ТабСтоимость.АналитикаУчетаНоменклатуры.Номенклатура
	|	И ТабРег.Организация = ТабСтоимость.Организация
	|	И ТабРег.Характеристика = ТабСтоимость.АналитикаУчетаНоменклатуры.Характеристика
	|	И ТабРег.Подразделение = ТабСтоимость.АналитикаУчетаНоменклатуры.МестоХранения
	|ГДЕ ТабРег.КоличествоОстаток > 0
	|ИТОГИ ПО 
	|	ТабРег.Организация,
	|	ТабСтоимость.ВидДеятельностиНДС,
	|	ТабРег.Подразделение";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);

	КоличествоСформированныхДокументов = 1;
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	ВыборкаОрганизации = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаОрганизации.Следующий() Цикл
		ВыборкаНалогообложение = ВыборкаОрганизации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаНалогообложение.Следующий() Цикл
			ВыборкаПодразделение = ВыборкаНалогообложение.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаПодразделение.Следующий() Цикл
				ДокОст = Документы.ВводОстатковТоваров.СоздатьДокумент();
				ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаПодразделение);
				ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковМатериаловПереданныхВПроизводство;
				Выборка = ВыборкаПодразделение.Выбрать();
				Пока Выборка.Следующий() Цикл
					Стр = ДокОст.Товары.Добавить();
					ЗаполнитьЗначенияСвойств(Стр, Выборка);
					Если Выборка.КоличествоПартии < Выборка.Количество
						И Выборка.КоличествоПартии > 0 Тогда
						Стр.Количество = Выборка.КоличествоПартии;
					КонецЕсли;
					Стр.КоличествоУпаковок = Стр.Количество;
					Стр.СуммаБезНДС = ?(Выборка.ЦенаБезНДС > 0, Окр(Выборка.ЦенаБезНДС * Стр.Количество, 2), 0);
					Стр.Сумма = ?(Выборка.Цена > 0 ,Окр(Выборка.Цена * Стр.Количество, 2),0);
					Стр.СуммаРегл = ?(Выборка.ЦенаРегл > 0, Окр(Выборка.ЦенаРегл * Стр.Количество, 2), 0);
					Стр.СуммаНДС = Стр.Сумма - Стр.СуммаБезНДС;
					Стр.НДСРегл = ?(Стр.Сумма = 0, 0, Стр.СуммаНДС * (Стр.СуммаРегл / Стр.Сумма));
				КонецЦикла;
				ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы("ВводОстатковТоваров", 
									Перечисления.ХозяйственныеОперации.ВводОстатковМатериаловПереданныхВПроизводство);

КонецПроцедуры

//-- НЕ УТ

Функция ПреобразоватьСсылкуВПервичныйДокумент(ДокументСсылка, ДокументДата, ДокументНомер, ТипПервичногоДокумента = Неопределено, Сумма = 0, СуммаРегл = 0)
	Если НЕ ЗначениеЗаполнено(ДокументСсылка) Тогда
		Возврат Неопределено;
	КонецЕсли;
	ТипСсылки = ТипЗнч(ДокументСсылка);
	Если ТипСсылки = Тип("ДокументСсылка.ПервичныйДокумент") Тогда
		Возврат ДокументСсылка;
	КонецЕсли;
	СведенияКонтрагентДоговор = Неопределено;
	СведенияВходящийДокумент = Неопределено;
	Если ТипПервичногоДокумента = Неопределено Тогда
		Если ТипСсылки = Тип("ДокументСсылка.АктВыполненныхРабот")
			Или ТипСсылки = Тип("ДокументСсылка.ВозвратТоваровОтКлиента")
			Или ТипСсылки = Тип("ДокументСсылка.ОтчетОРозничныхПродажах")
			Или ТипСсылки = Тип("ДокументСсылка.ОтчетКомиссионера")
			Или ТипСсылки = Тип("ДокументСсылка.ОтчетКомиссионераОСписании")
			Или ТипСсылки = Тип("ДокументСсылка.РеализацияПодарочныхСертификатов")
			Или ТипСсылки = Тип("ДокументСсылка.РеализацияУслугПрочихАктивов")
			Или ТипСсылки = Тип("ДокументСсылка.КорректировкаРеализации")
			Или ТипСсылки = Тип("ДокументСсылка.ЗаказКлиента")
			Или ТипСсылки = Тип("ДокументСсылка.РеализацияТоваровУслуг")
			Или ТипСсылки = Тип("ДокументСсылка.ВыкупВозвратнойТарыКлиентом") Тогда

			ТипПервичногоДокумента = Перечисления.ТипыПервичныхДокументов.РеализацияКлиенту;
		ИначеЕсли ТипСсылки = Тип("ДокументСсылка.ПриобретениеТоваровУслуг")
			Или ТипСсылки = Тип("ДокументСсылка.ПриобретениеУслугПрочихАктивов")
			Или ТипСсылки = Тип("ДокументСсылка.ЗаказПоставщику")
			Или ТипСсылки = Тип("ДокументСсылка.ВозвратТоваровПоставщику")
			Или ТипСсылки = Тип("ДокументСсылка.ОтчетКомитенту")
			Или ТипСсылки = Тип("ДокументСсылка.ОтчетКомитентуОСписании")
			Или ТипСсылки = Тип("ДокументСсылка.ТаможеннаяДекларацияИмпорт")
			Или ТипСсылки = Тип("ДокументСсылка.ВыкупПринятыхНаХранениеТоваров") 
			//++ НЕ УТ
			Или ТипСсылки = Тип("ДокументСсылка.ПоступлениеПредметовЛизинга")
			Или ТипСсылки = Тип("ДокументСсылка.ПоступлениеОтПереработчика")
			//-- НЕ УТ
			Или ТипСсылки = Тип("ДокументСсылка.КорректировкаПриобретения")
			Или ТипСсылки = Тип("ДокументСсылка.ВыкупВозвратнойТарыУПоставщика") Тогда

			ТипПервичногоДокумента = Перечисления.ТипыПервичныхДокументов.ПриобретениеУПоставщика;
		ИначеЕсли ТипСсылки = Тип("ДокументСсылка.ОперацияПоПлатежнойКарте") Тогда
			ТипПервичногоДокумента = Перечисления.ТипыПервичныхДокументов.ОплатаОтКлиента;
		Иначе
			ТипПервичногоДокумента = Перечисления.ТипыПервичныхДокументов.ВнутренняяНакладная; 
		КонецЕсли;
	КонецЕсли;
	СтруктураРеквизитовШапки = Новый Структура("Организация, Контрагент, Партнер, Договор, Валюта, ДатаВходящегоДокумента, НомерВходящегоДокумента, СуммаДокумента, СуммаВзаиморасчетов, ПорядокРасчетов");
	ЗаполнитьЗначенияСвойств(СтруктураРеквизитовШапки,ДокументСсылка);
	Если НЕ ЗначениеЗаполнено(СтруктураРеквизитовШапки.ДатаВходящегоДокумента) ИЛИ НЕ ЗначениеЗаполнено(СтруктураРеквизитовШапки.НомерВходящегоДокумента) Тогда
		СтруктураРеквизитовШапки.ДатаВходящегоДокумента = ДокументДата;
		СтруктураРеквизитовШапки.НомерВходящегоДокумента = ДокументНомер;
	КонецЕсли;
	ЗапросПД = Новый Запрос;
	ЗапросПД.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	|	Ссылка
	|ИЗ Документ.ПервичныйДокумент
	|ГДЕ ТипПервичногоДокумента = &Тип И Организация = &Организация И Контрагент = &Контрагент И Договор = &Договор
	|	И ДатаВходящегоДокумента = &ДатаВходящегоДокумента И НомерВходящегоДокумента = &НомерВходящегоДокумента
	|	И Валюта = &Валюта";
	ЗапросПД.УстановитьПараметр("Тип", ТипПервичногоДокумента);
	ЗапросПД.УстановитьПараметр("Организация", СтруктураРеквизитовШапки.Организация);
	ЗапросПД.УстановитьПараметр("Контрагент", СтруктураРеквизитовШапки.Контрагент);
	ЗапросПД.УстановитьПараметр("Договор", СтруктураРеквизитовШапки.Договор);
	ЗапросПД.УстановитьПараметр("Валюта", СтруктураРеквизитовШапки.Валюта);
	ЗапросПД.УстановитьПараметр("НомерВходящегоДокумента", СтруктураРеквизитовШапки.НомерВходящегоДокумента);
	ЗапросПД.УстановитьПараметр("ДатаВходящегоДокумента", СтруктураРеквизитовШапки.ДатаВходящегоДокумента);
	Выборка = ЗапросПД.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	КонецЕсли;
	ПервичныйДок = Документы.ПервичныйДокумент.СоздатьДокумент();
	ПервичныйДок.ТипПервичногоДокумента = ТипПервичногоДокумента;
	ЗаполнитьЗначенияСвойств(ПервичныйДок, СтруктураРеквизитовШапки);
	Если НЕ ЗначениеЗаполнено(ПервичныйДок.Партнер) И ЗначениеЗаполнено(ПервичныйДок.Контрагент) Тогда
		ПервичныйДок.Партнер = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПервичныйДок.Контрагент,"Партнер");
	КонецЕсли;
	ПервичныйДок.Дата = ДатаСверткиИБ;
	Если Сумма <> 0 Тогда
		ПервичныйДок.СуммаДокумента = Сумма;
	ИначеЕсли НЕ ЗначениеЗаполнено(ПервичныйДок.СуммаДокумента) И ЗначениеЗаполнено(СтруктураРеквизитовШапки.СуммаВзаиморасчетов) Тогда
		ПервичныйДок.СуммаДокумента = СтруктураРеквизитовШапки.СуммаВзаиморасчетов
	КонецЕсли;
	Если СуммаРегл <> 0 Тогда
		ПервичныйДок.СуммаРегл = СуммаРегл;
	КонецЕсли;
	Если ЗначениеЗаполнено(ПервичныйДок.СуммаДокумента) И ЗначениеЗаполнено(ПервичныйДок.Валюта)
		И НЕ ЗначениеЗаполнено(ПервичныйДок.СуммаРегл) Тогда
		Если ПервичныйДок.Валюта = ВалютаРегламентированногоУчета Тогда
			ПервичныйДок.СуммаРегл = ПервичныйДок.СуммаДокумента;
		Иначе
			КоэффициентПересчета = КурсыВалют.Получить(ПервичныйДок.Валюта);
			Если КоэффициентПересчета = Неопределено Тогда
				КоэффициентПересчета = 
					РаботаСКурсамиВалютУТ.ПолучитьКоэффициентПересчетаИзВалютыВВалюту(
												ПервичныйДок.Валюта, 
												ВалютаРегламентированногоУчета, ДатаСверткиИБ);
				КурсыВалют.Вставить(ПервичныйДок.Валюта, КоэффициентПересчета); 
			КонецЕсли;
					
			ПервичныйДок.СуммаРегл = Окр(ПервичныйДок.СуммаДокумента * КоэффициентПересчета, 2, 1);
		КонецЕсли;
	КонецЕсли;
	
	ПервичныйДок.Комментарий = Комментарий_СформированСверткойБазы+" ["+СокрЛП(ДокументСсылка)+"]";
	Если НЕ ЗначениеЗаполнено(ПервичныйДок.ПорядокРасчетов) Тогда
		// Не удалось заполнить из реквизитов документа
		Если ЗначениеЗаполнено(СтруктураРеквизитовШапки.Договор) Тогда
			ПервичныйДок.ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов;
		Иначе
			ПервичныйДок.ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоНакладным;
		КонецЕсли;
	КонецЕсли;
	ПервичныйДок.ОбменДанными.Загрузка = Истина;
	
	ПервичныйДок.Записать(РежимЗаписиДокумента.Запись);
	Возврат ПервичныйДок.Ссылка;
КонецФункции

//++ НЕ УТ

Процедура СформироватьДокументыВводаОстатковВнеоборотныхАктивов()
	Если (Константы.ИспользоватьВнеоборотныеАктивы2_2.Получить() = Истина
		И ВнеоборотныеАктивыЛокализация.ДатаНачалаУчетаВнеоборотныхАктивов2_4() > ДатаСверткиИБ)
		ИЛИ Константы.ИспользоватьВнеоборотныеАктивы2_4.Получить() = Ложь Тогда
		Возврат;
	КонецЕсли;
	// 1. ОС
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВводОстатковОсновныхСредств) КАК ХозяйственнаяОперация,
	|	СтоимостьОС.Организация,
	|	СтоимостьОС.ОсновноеСредство,
	|	СтоимостьОС.Подразделение,
	|	СтоимостьОС.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|	СтоимостьОС.НаправлениеДеятельности КАК НаправлениеДеятельности, 
	|	СтоимостьОС.СтоимостьОстаток КАК ТекущаяСтоимостьУУ,
	|	СтоимостьОС.СтоимостьРеглОстаток КАК ТекущаяСтоимостьБУ,
	|	СтоимостьОС.СтоимостьНУОстаток КАК ТекущаяСтоимостьНУ,
	|	СтоимостьОС.СтоимостьЦФОстаток КАК ТекущаяСтоимостьБУЦФ,
	|	СтоимостьОС.СтоимостьНУЦФОстаток КАК ТекущаяСтоимостьНУЦФ,
	|	СтоимостьОС.РезервПереоценкиСтоимостиОстаток КАК РезервПереоценкиСтоимости,
	|	СтоимостьОС.РезервПереоценкиСтоимостиРеглОстаток КАК РезервПереоценкиСтоимостиРегл,
	|	СтоимостьОС.ЗалоговаяСтоимостьОстаток КАК ЗалоговаяСтоимость,
	
	|	(-1)*АмортизацияОС.АмортизацияОстаток КАК НакопленнаяАмортизацияУУ,
	|	(-1)*АмортизацияОС.АмортизацияРеглОстаток КАК НакопленнаяАмортизацияБУ,
	|	(-1)*АмортизацияОС.АмортизацияНУОстаток КАК НакопленнаяАмортизацияНУ,
	|	(-1)*АмортизацияОС.АмортизацияЦФОстаток КАК НакопленнаяАмортизацияБУЦФ,
	|	(-1)*АмортизацияОС.АмортизацияНУЦФОстаток КАК НакопленнаяАмортизацияНУЦФ,
	
	|	(-1)*АмортизацияОС.РезервПереоценкиАмортизацииОстаток КАК РезервПереоценкиАмортизации,
	|	(-1)*АмортизацияОС.РезервПереоценкиАмортизацииРеглОстаток КАК РезервПереоценкиАмортизацииРегл,
	
	|	МестонахождениеОС.МОЛ КАК МОЛ,
	|	ЕстьNULL(МестонахождениеОС.Местонахождение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)) КАК Местонахождение,
	|	МестонахождениеОС.АдресМестонахождения КАК АдресМестонахождения,
	|	МестонахождениеОС.Арендатор КАК Арендатор,
	|	МестонахождениеОС.ПодразделениеАрендатора КАК ПодразделениеАрендатора,
	|	МестонахождениеОС.МОЛАрендатора КАК МОЛАрендатора,
	|	МестонахождениеОС.АдресМестонахожденияЗначение КАК АдресМестонахожденияЗначение,
	
	|	ПорядокУчетаОС.ГруппаФинансовогоУчета КАК ПорядокУчетаОС_ГруппаФинансовогоУчета,
	|	ПорядокУчетаОС.ПоказательНаработки КАК ПоказательНаработки,
	|	ПорядокУчетаОС.ОбъемНаработки КАК ОбъемНаработки,
	
	|	ПорядокУчетаОСБУ.Состояние КАК ПорядокУчетаОСБУ_Состояние,
	|	ЕстьNULL(ПорядокУчетаОСБУ.НачислятьАмортизациюБУ, ЛОЖЬ) КАК НачислятьАмортизациюБУ,
	|	ЕстьNULL(ПорядокУчетаОСБУ.НачислятьАмортизациюНУ, ЛОЖЬ) КАК НачислятьАмортизациюНУ,
	|	ПорядокУчетаОСБУ.СтатьяРасходовБУ КАК СтатьяРасходовБУ,
	|	ПорядокУчетаОСБУ.АналитикаРасходовБУ КАК АналитикаРасходовБУ,
	|	ПорядокУчетаОСБУ.ПередаватьРасходыВДругуюОрганизацию КАК ПорядокУчетаОСБУ_ПередаватьРасходыВДругуюОрганизацию,
	|	ПорядокУчетаОСБУ.ОрганизацияПолучательРасходов КАК ПорядокУчетаОСБУ_ОрганизацияПолучательРасходов,
	|	ЕстьNULL(ПорядокУчетаОСБУ.НалоговоеНазначение, ЗНАЧЕНИЕ(Справочник.НалоговыеНазначенияАктивовИЗатрат.ПустаяСсылка)) КАК НалоговоеНазначение, 
	|	ЕстьNULL(ПорядокУчетаОСБУ.НалоговаяГруппаОС, ЗНАЧЕНИЕ(Справочник.НалоговыеГруппыОсновныхСредств.ПустаяСсылка)) КАК НалоговаяГруппаОС,
	|	ПорядокУчетаОСУУ.Состояние КАК ПорядокУчетаОСУУ_Состояние,
	|	ЕстьNULL(ПорядокУчетаОСУУ.НачислятьАмортизациюУУ, ЛОЖЬ) КАК НачислятьАмортизациюУУ,
	|	ПорядокУчетаОСУУ.СпособОтраженияРасходов КАК ПорядокУчетаОСУУ_СпособОтраженияРасходов,
	|	ПорядокУчетаОСУУ.СтатьяРасходов КАК СтатьяРасходовУУ,
	|	ПорядокУчетаОСУУ.АналитикаРасходов КАК АналитикаРасходовУУ,
	|	ПорядокУчетаОСУУ.ПередаватьРасходыВДругуюОрганизацию КАК ПорядокУчетаОСУУ_ПередаватьРасходыВДругуюОрганизацию,
	|	ПорядокУчетаОСУУ.ОрганизацияПолучательРасходов КАК ПорядокУчетаОСУУ_ОрганизацияПолучательРасходов,
	
	|	ПервоначальныеСведенияОС.ПорядокУчетаУУ КАК ПорядокУчетаУУ,
	|	ПервоначальныеСведенияОС.МетодНачисленияАмортизацииБУ КАК МетодНачисленияАмортизацииБУ,
	|	ПервоначальныеСведенияОС.МетодНачисленияАмортизацииНУ КАК МетодНачисленияАмортизацииНУ,
	|	ПервоначальныеСведенияОС.ПервоначальнаяСтоимостьУУ КАК ПервоначальнаяСтоимостьУУ,
	|	ПервоначальныеСведенияОС.ПервоначальнаяСтоимостьБУ КАК ПервоначальнаяСтоимостьБУ,
	|	ПервоначальныеСведенияОС.ПервоначальнаяСтоимостьНУ КАК ПервоначальнаяСтоимостьНУ,
	|	ПервоначальныеСведенияОС.ДатаВводаВЭксплуатациюБУ КАК ДатаПринятияКУчетуБУ,
	|	ПервоначальныеСведенияОС.ДатаВводаВЭксплуатациюУУ КАК ДатаПринятияКУчетуУУ,
	
	|	ЕстьNULL(ПараметрыЦелевогоФинансированияОС.ПрименениеЦелевогоФинансирования, ЛОЖЬ) КАК ПрименениеЦелевогоФинансирования,
	|	ПараметрыЦелевогоФинансированияОС.СтатьяДоходов КАК СтатьяДоходов,
	|	ПараметрыЦелевогоФинансированияОС.АналитикаДоходов КАК АналитикаДоходов,
	|	СостоянияОС.Состояние КАК Состояние,
	|	ПараметрыАмортизацииОСБУ.ГрафикАмортизации КАК ГрафикАмортизации, 
	|	ПараметрыАмортизацииОСБУ.СрокИспользованияДляВычисленияАмортизации КАК СрокИспользованияДляВычисленияАмортизации,
	|	ПараметрыАмортизацииОСБУ.СрокИспользованияДляВычисленияАмортизацииНУ КАК СрокИспользованияДляВычисленияАмортизацииНУ,
	|	ПараметрыАмортизацииОСБУ.ОбъемПродукцииРаботДляВычисленияАмортизации КАК ОбъемНаработкиОстаточныйБУ,
	|	ПараметрыАмортизацииОСБУ.СрокПолезногоИспользованияБУ КАК СрокИспользованияБУ,

	|	ПараметрыАмортизацииОСБУ.СрокПолезногоИспользованияНУ КАК СрокИспользованияНУ,
	|	ПараметрыАмортизацииОСБУ.СтоимостьДляВычисленияАмортизации КАК СтоимостьДляВычисленияАмортизацииБУ,
	|	ПараметрыАмортизацииОСБУ.СтоимостьДляВычисленияАмортизацииЦФ КАК СтоимостьДляВычисленияАмортизацииЦФ,

	|	ПараметрыАмортизацииОСУУ.КоэффициентУскорения КАК КоэффициентУскоренияУУ,
	|	ПараметрыАмортизацииОСУУ.ЛиквидационнаяСтоимость КАК ЛиквидационнаяСтоимость,
	|	ПараметрыАмортизацииОСУУ.СрокИспользования КАК СрокИспользованияУУ,
	|	ПараметрыАмортизацииОСУУ.СтоимостьДляВычисленияАмортизации КАК СтоимостьДляВычисленияАмортизацииУУ,
	|	ПараметрыАмортизацииОСУУ.МетодНачисленияАмортизации КАК МетодНачисленияАмортизацииУУ,
	|	ПараметрыАмортизацииОСУУ.ЛиквидационнаяСтоимостьРегл КАК ЛиквидационнаяСтоимостьРегл,
	|	ПараметрыАмортизацииОСУУ.ОбъемПродукцииРаботДляВычисленияАмортизации КАК ОбъемНаработкиОстаточныйУУ,
	
	|	ВЫБОР КОГДА ПорядокУчетаОСУУ.Состояние ЕСТЬ NULL ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ ИСТИНА КОНЕЦ КАК ОтражатьВУпрУчете,
	|	ВЫБОР КОГДА ПорядокУчетаОСБУ.Состояние ЕСТЬ NULL ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ ИСТИНА КОНЕЦ КАК ОтражатьВРеглУчете
	|ИЗ РегистрНакопления.СтоимостьОС.Остатки(&ГраницаОст) КАК СтоимостьОС
	|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокУчетаОСБУ.СрезПоследних(&ГраницаОст) КАК СостоянияОС
	|	ПО СостоянияОС.ОсновноеСредство = СтоимостьОС.ОсновноеСредство
	|	И СостоянияОС.Организация = СтоимостьОС.Организация
	|	И (СостоянияОС.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОС.ПринятоКУчету)
	|		ИЛИ СостоянияОС.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОС.ПринятоКЗабалансовомуУчету))
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.АмортизацияОС.Остатки(&ГраницаОст) КАК АмортизацияОС
	|	ПО СтоимостьОС.Организация = АмортизацияОС.Организация
	|	И СтоимостьОС.ОсновноеСредство = АмортизацияОС.ОсновноеСредство
	|	И СтоимостьОС.НаправлениеДеятельности = АмортизацияОС.НаправлениеДеятельности
	|	И СтоимостьОС.Подразделение = АмортизацияОС.Подразделение
	|ЛЕВОЕ СОЕДИНЕНИЕ РасходыПоИмуществу КАК РасходыПоИмуществу
	|ПО РасходыПоИмуществу.Организация = СтоимостьОС.Организация
	|	И РасходыПоИмуществу.ОсновноеСредство = СтоимостьОС.ОсновноеСредство
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МестонахождениеОС.СрезПоследних(&ГраницаОст) КАК МестонахождениеОС
	|ПО МестонахождениеОС.ОсновноеСредство = СтоимостьОС.ОсновноеСредство
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокУчетаОС.СрезПоследних(&ГраницаОст) КАК ПорядокУчетаОС
	|ПО ПорядокУчетаОС.ОсновноеСредство = СтоимостьОС.ОсновноеСредство
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокУчетаОСБУ.СрезПоследних(&ГраницаОст) КАК ПорядокУчетаОСБУ
	|ПО ПорядокУчетаОСБУ.ОсновноеСредство = СтоимостьОС.ОсновноеСредство
	|	И (ПорядокУчетаОСБУ.Организация = СтоимостьОС.Организация
	|		ИЛИ ПорядокУчетаОСБУ.Организация = МестонахождениеОС.Организация)
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокУчетаОСУУ.СрезПоследних(&ГраницаОст) КАК ПорядокУчетаОСУУ
	|ПО ПорядокУчетаОСУУ.ОсновноеСредство = СтоимостьОС.ОсновноеСредство
	|	И (ПорядокУчетаОСУУ.Организация = СтоимостьОС.Организация
	|		ИЛИ ПорядокУчетаОСУУ.Организация = МестонахождениеОС.Организация)
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПервоначальныеСведенияОС.СрезПоследних(&ГраницаОст) КАК ПервоначальныеСведенияОС
	|ПО ПервоначальныеСведенияОС.ОсновноеСредство = СтоимостьОС.ОсновноеСредство
	|	И (ПервоначальныеСведенияОС.Организация = СтоимостьОС.Организация
	|		ИЛИ ПервоначальныеСведенияОС.Организация = МестонахождениеОС.Организация)
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПараметрыЦелевогоФинансированияОС.СрезПоследних(&ГраницаОст) КАК ПараметрыЦелевогоФинансированияОС
	|ПО ПараметрыЦелевогоФинансированияОС.ОсновноеСредство = СтоимостьОС.ОсновноеСредство
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПараметрыАмортизацииОСБУ.СрезПоследних(&ГраницаОст) КАК ПараметрыАмортизацииОСБУ
	|ПО ПараметрыАмортизацииОСБУ.ОсновноеСредство = СтоимостьОС.ОсновноеСредство
	|		И (ПараметрыАмортизацииОСБУ.Организация = СтоимостьОС.Организация
	|			ИЛИ ПараметрыАмортизацииОСБУ.Организация = МестонахождениеОС.Организация)
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПараметрыАмортизацииОСУУ.СрезПоследних(&ГраницаОст) КАК ПараметрыАмортизацииОСУУ
	|ПО ПараметрыАмортизацииОСУУ.ОсновноеСредство = СтоимостьОС.ОсновноеСредство
	|		И (ПараметрыАмортизацииОСУУ.Организация = СтоимостьОС.Организация
	|			ИЛИ ПараметрыАмортизацииОСУУ.Организация = МестонахождениеОС.Организация)
	|УПОРЯДОЧИТЬ ПО ХозяйственнаяОперация, 
	|	СтоимостьОС.Организация, СтоимостьОС.ГруппаФинансовогоУчета, 
	|	ВЫБОР КОГДА ПорядокУчетаОСУУ.Состояние ЕСТЬ NULL ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ ИСТИНА КОНЕЦ,
	|	ВЫБОР КОГДА ПорядокУчетаОСБУ.Состояние ЕСТЬ NULL ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ ИСТИНА КОНЕЦ, 
	|	ЕстьNULL(МестонахождениеОС.Местонахождение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	КоличествоСформированныхДокументов = 1;
	Результат = Запрос.Выполнить();
	
	Если НЕ Результат.Пустой() Тогда
		ЗапросМодернизация = Новый Запрос;
		ЗапросМодернизация.Текст = "ВЫБРАТЬ
		|	Организация,
		|	ОсновноеСредство,
		|	Период КАК ДатаМодернизации,
		|	НазваниеДокумента КАК НазваниеДокументаМодернизации,
		|	НомерДокумента КАК НомерДокументаМодернизации,
		|	Событие КАК СобытиеМодернизации
		|ИЗ РегистрСведений.СобытияОСОрганизаций 
		|ГДЕ Событие.ВидСобытияОС = ЗНАЧЕНИЕ(Перечисление.ВидыСобытийОС.Модернизация)
		|	И Период < &ДатаОст
		|УПОРЯДОЧИТЬ ПО Период УБЫВ";
		ЗаполнитьПараметрыЗапросаДатаСвертки(ЗапросМодернизация);
		ТабМодернизация = ЗапросМодернизация.Выполнить().Выгрузить();
		
		ЗапросПринятиеКУчету = Новый Запрос;
		ЗапросПринятиеКУчету.Текст = "ВЫБРАТЬ
		|	Организация,
		|	ОсновноеСредство,
		|	Период КАК ДатаПринятияКУчету,
		|	НазваниеДокумента КАК НазваниеДокументаПринятияКУчету,
		|	НомерДокумента КАК НомерДокументаПринятияКУчету,
		|	Событие КАК СобытиеПринятияКУчету
		|ИЗ РегистрСведений.СобытияОСОрганизаций 
		|ГДЕ Событие.ВидСобытияОС = ЗНАЧЕНИЕ(Перечисление.ВидыСобытийОС.ПринятиеКУчету)
		|	ИЛИ Событие.ВидСобытияОС = ЗНАЧЕНИЕ(Перечисление.ВидыСобытийОС.ПринятиеКУчетуСВводомВЭксплуатацию)
		|	И Период < &ДатаОст
		|УПОРЯДОЧИТЬ ПО Период УБЫВ";
		ЗаполнитьПараметрыЗапросаДатаСвертки(ЗапросПринятиеКУчету);
		ТабПринятиеКУчету = ЗапросПринятиеКУчету.Выполнить().Выгрузить();
	КонецЕсли;
	
	Выборка = Результат.Выбрать();

	Пока Выборка.СледующийПоЗначениюПоля("ХозяйственнаяОперация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("ГруппаФинансовогоУчета") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("ОтражатьВУпрУчете") Цикл
					Пока Выборка.СледующийПоЗначениюПоля("ОтражатьВРеглУчете") Цикл
						Пока Выборка.СледующийПоЗначениюПоля("Местонахождение") Цикл 
							ДокОст = Документы.ВводОстатковВнеоборотныхАктивов2_4.СоздатьДокумент();
							ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка, Ложь);
							ДокОст.ОтражатьВРеглУчете = Истина;
							ДокОст.ОтражатьВУпрУчете = Истина;
							ДокОст.ВидАктивов = Перечисления.ВидыВнеоборотныхАктивов.ОсновноеСредство;
							Пока Выборка.Следующий() Цикл
								// Проверка на пустое ОС
								Если НЕ ЗначениеЗаполнено(Выборка.ОсновноеСредство) Тогда
									Продолжить;
								КонецЕсли;
								ЭтоАрендованноеОС = (Выборка.Состояние = Перечисления.СостоянияОС.ПринятоКЗабалансовомуУчету);
								Если ЭтоАрендованноеОС Тогда
									Стр = ДокОст.АрендованныеОС.Добавить();
									ЗаполнитьЗначенияСвойств(Стр, Выборка);
									Стр.ДатаПринятияКУчету = Выборка.ДатаПринятияКУчетуБУ;
									Продолжить;
								КонецЕсли;
								Стр = ДокОст.ОС.Добавить();
								ЗаполнитьЗначенияСвойств(Стр, Выборка);
                                Если НЕ ЗначениеЗаполнено(Стр.НалоговоеНазначение) Тогда
									Стр.НалоговоеНазначение = Выборка.НалоговоеНазначение;
								КонецЕсли;
								
								// Группа фин учета - может быть в нескольких регистрах.
								Если НЕ ЗначениеЗаполнено(Стр.ГруппаФинансовогоУчета) Тогда
									Стр.ГруппаФинансовогоУчета = Выборка.ПорядокУчетаОС_ГруппаФинансовогоУчета;
								КонецЕсли;
								// Данные модернизации.
								СтрокиМодернизация = ТабМодернизация.НайтиСтроки(Новый Структура("Организация, ОсновноеСредство", Выборка.Организация, Выборка.ОсновноеСредство));
								Если СтрокиМодернизация.Количество() > 0 Тогда
									Стр.ОбъемНаработкиОстаточныйБУ = Выборка.СрокИспользованияБУ;
									Стр.ОбъемНаработкиОстаточныйУУ = Выборка.СрокИспользованияУУ;
									ЗаполнитьЗначенияСвойств(Стр, СтрокиМодернизация[0], "НазваниеДокументаМодернизации, НомерДокументаМодернизации");
								КонецЕсли;
								// Данные принятия к учету.
								СтрокиУчет = ТабПринятиеКУчету.НайтиСтроки(Новый Структура("Организация, ОсновноеСредство", Выборка.Организация, Выборка.ОсновноеСредство));
								Если СтрокиУчет.Количество() > 0 Тогда
									ЗаполнитьЗначенияСвойств(Стр, СтрокиУчет[0], "НазваниеДокументаПринятияКУчету, НомерДокументаПринятияКУчету");
								КонецЕсли;
								Стр.ЕстьРезервПереоценки = (Стр.РезервПереоценкиСтоимости > 0 Или Стр.РезервПереоценкиАмортизации > 0);
								Стр.ЕстьРезервПереоценкиРегл = (Стр.РезервПереоценкиСтоимостиРегл > 0 Или Стр.РезервПереоценкиАмортизацииРегл > 0);
								Стр.ОрганизацияПолучательРасходов = ?(ЗначениеЗаполнено(Выборка.ПорядокУчетаОСБУ_ОрганизацияПолучательРасходов),
										Выборка.ПорядокУчетаОСБУ_ОрганизацияПолучательРасходов, Выборка.ПорядокУчетаОСУУ_ОрганизацияПолучательРасходов);
								Стр.ПередаватьРасходыВДругуюОрганизацию = ?(ЗначениеЗаполнено(Выборка.ПорядокУчетаОСБУ_ПередаватьРасходыВДругуюОрганизацию),
										Выборка.ПорядокУчетаОСБУ_ПередаватьРасходыВДругуюОрганизацию, Выборка.ПорядокУчетаОСУУ_ПередаватьРасходыВДругуюОрганизацию);
							КонецЦикла; //Детали
							Если ДокОст.ОС.Количество() > 0 Тогда
								КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
								ДокОст.Записать(РежимЗаписиДокумента.Запись);
							КонецЕсли;
							
						КонецЦикла; // Местонахождение
					КонецЦикла; //ОтражатьВРеглУчете
				КонецЦикла; //ОтражатьВУпрУчете
			КонецЦикла; //ГруппаФинансовогоУчета
		КонецЦикла; //Организация
	КонецЦикла; //ХозяйственнаяОперация

	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковВнеоборотныхАктивов2_4", НСтр("ru='Остатки основных средств';uk='Залишки основних засобів'"));
	КонецЕсли;
	// 2. НМА
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	СтоимостьНМА.НематериальныйАктив КАК НематериальныйАктив,
	|	МестоУчетаНМА.Организация КАК Организация,
	|	МестоУчетаНМА.Подразделение КАК Местонахождение,
	|	СтоимостьНМА.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|	СтоимостьНМА.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	СтоимостьНМА.СтоимостьОстаток КАК ТекущаяСтоимостьУУ,
	|	СтоимостьНМА.СтоимостьРеглОстаток КАК ТекущаяСтоимостьБУ,
	|	СтоимостьНМА.СтоимостьНУОстаток КАК ТекущаяСтоимостьНУ,
	|	СтоимостьНМА.СтоимостьЦФОстаток КАК ТекущаяСтоимостьБУЦФ,
	|	СтоимостьНМА.СтоимостьНУЦФОстаток КАК ТекущаяСтоимостьНУЦФ,
	|	СтоимостьНМА.РезервПереоценкиСтоимостиОстаток КАК РезервПереоценкиСтоимости,
	|	СтоимостьНМА.РезервПереоценкиСтоимостиРеглОстаток КАК РезервПереоценкиСтоимостиРегл,
	
	|	(-1)*АмортизацияНМА.АмортизацияОстаток КАК НакопленнаяАмортизацияУУ,
	|	(-1)*АмортизацияНМА.АмортизацияРеглОстаток КАК НакопленнаяАмортизацияБУ,
	|	(-1)*АмортизацияНМА.АмортизацияНУОстаток КАК НакопленнаяАмортизацияНУ,
	|	(-1)*АмортизацияНМА.АмортизацияЦФОстаток КАК НакопленнаяАмортизацияБУЦФ,
	|	(-1)*АмортизацияНМА.АмортизацияНУЦФОстаток КАК НакопленнаяАмортизацияНУЦФ,
	|	(-1)*АмортизацияНМА.РезервПереоценкиАмортизацииОстаток КАК РезервПереоценкиАмортизации,
	|	(-1)*АмортизацияНМА.РезервПереоценкиАмортизацииРеглОстаток КАК РезервПереоценкиАмортизацииРегл,
	
	|	ПервоначальныеСведенияНМА.ДатаПринятияКУчетуБУ КАК ДатаПринятияКУчетуБУ,
	|	ПервоначальныеСведенияНМА.ДатаПринятияКУчетуУУ КАК ДатаПринятияКУчетуУУ,
	|	ПервоначальныеСведенияНМА.ПервоначальнаяСтоимостьУУ КАК ПервоначальнаяСтоимостьУУ,
	|	ПервоначальныеСведенияНМА.ПервоначальнаяСтоимостьБУ КАК ПервоначальнаяСтоимостьБУ,
	|	ПервоначальныеСведенияНМА.ПервоначальнаяСтоимостьНУ КАК ПервоначальнаяСтоимостьНУ,
	|	ПервоначальныеСведенияНМА.МетодНачисленияАмортизацииБУ КАК МетодНачисленияАмортизацииБУ,
	|	ПервоначальныеСведенияНМА.МетодНачисленияАмортизацииНУ КАК МетодНачисленияАмортизацииНУ,
	
	|	ПараметрыЦФ.СтатьяДоходов КАК СтатьяДоходов,
	|	ПараметрыЦФ.АналитикаДоходов КАК АналитикаДоходов,
	|	ПараметрыЦФ.ПрименениеЦелевогоФинансирования КАК ПрименениеЦелевогоФинансирования,
	
	|	ПорядокУчетаНМА.ОбъемНаработки КАК ОбъемНаработки,
	
	|	ПорядокУчетаНМАУУ.АналитикаРасходов КАК АналитикаРасходовУУ,
	|	ПорядокУчетаНМАУУ.СтатьяРасходов КАК СтатьяРасходовУУ,
	|	ПорядокУчетаНМАУУ.НачислятьАмортизациюУУ КАК НачислятьАмортизациюУУ,
	|	ПорядокУчетаНМАУУ.ПередаватьРасходыВДругуюОрганизацию КАК ПередаватьРасходыВДругуюОрганизациюУУ,
	|	ПорядокУчетаНМАУУ.ОрганизацияПолучательРасходов КАК ОрганизацияПолучательРасходовУУ,
	|	ВЫБОР КОГДА ПорядокУчетаНМАУУ.НачислятьАмортизациюУУ ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.ПорядокУчетаСтоимостиВнеоборотныхАктивов.НачислятьАмортизацию)
	|	ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ПорядокУчетаСтоимостиВнеоборотныхАктивов.НеНачислятьАмортизацию)
	|	КОНЕЦ 						КАК ПорядокУчетаУУ, 
	
	|	ПорядокУчетаНМАБУ.АналитикаРасходовБУ КАК АналитикаРасходовБУ,
	|	ПорядокУчетаНМАБУ.СтатьяРасходовБУ КАК СтатьяРасходовБУ,
	|	ПорядокУчетаНМАБУ.ПередаватьРасходыВДругуюОрганизацию КАК ПередаватьРасходыВДругуюОрганизациюБУ,
	|	ПорядокУчетаНМАБУ.ОрганизацияПолучательРасходов КАК ОрганизацияПолучательРасходовБУ,
	|	ПорядокУчетаНМАБУ.НачислятьАмортизациюБУ КАК НачислятьАмортизациюБУ,
	|	ПорядокУчетаНМАБУ.НачислятьАмортизациюНУ КАК НачислятьАмортизациюНУ,
	|	ПорядокУчетаНМАБУ.НалоговоеНазначение КАК НалоговоеНазначение,
	|	ПорядокУчетаНМАБУ.НалоговаяГруппаОС КАК НалоговаяГруппаОС,
	
	|	ПараметрыАмортизацииНМАБУ.СрокПолезногоИспользованияБУ КАК СрокИспользованияБУ,
	|	ПараметрыАмортизацииНМАБУ.СрокПолезногоИспользованияНУ КАК СрокИспользованияНУ,

	|	ПараметрыАмортизацииНМАУУ.СрокИспользования КАК СрокИспользованияУУ,
	|	ПараметрыАмортизацииНМАУУ.КоэффициентУскорения КАК КоэффициентУскоренияУУ,
	|	ПараметрыАмортизацииНМАУУ.МетодНачисленияАмортизации КАК МетодНачисленияАмортизацииУУ,
	|	ПараметрыАмортизацииНМАУУ.ЛиквидационнаяСтоимость КАК ЛиквидационнаяСтоимость, 

	|	ВЫБОР КОГДА ПорядокУчетаНМАУУ.Состояние ЕСТЬ NULL ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ ИСТИНА КОНЕЦ КАК ОтражатьВУпрУчете,
	|	ВЫБОР КОГДА ПорядокУчетаНМАБУ.Состояние ЕСТЬ NULL ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ ИСТИНА КОНЕЦ КАК ОтражатьВРеглУчете
	|ИЗ РегистрНакопления.СтоимостьНМА.Остатки(&ГраницаОст) КАК СтоимостьНМА
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МестоУчетаНМА.СрезПоследних(&ГраницаОст) КАК МестоУчетаНМА
	|ПО СтоимостьНМА.НематериальныйАктив = МестоУчетаНМА.НематериальныйАктив
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.АмортизацияНМА.Остатки(&ГраницаОст) КАК АмортизацияНМА
	|ПО СтоимостьНМА.НематериальныйАктив = АмортизацияНМА.НематериальныйАктив
	|	И (СтоимостьНМА.Организация = АмортизацияНМА.Организация
	|		ИЛИ МестоУчетаНМА.Организация = АмортизацияНМА.Организация)
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокУчетаНМА.СрезПоследних(&ГраницаОст) КАК ПорядокУчетаНМА
	|ПО СтоимостьНМА.НематериальныйАктив = ПорядокУчетаНМА.НематериальныйАктив
	|	И (СтоимостьНМА.Организация = ПорядокУчетаНМА.Организация
	|		ИЛИ МестоУчетаНМА.Организация = ПорядокУчетаНМА.Организация)
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокУчетаНМАУУ.СрезПоследних(&ГраницаОст) КАК ПорядокУчетаНМАУУ
	|ПО СтоимостьНМА.НематериальныйАктив = ПорядокУчетаНМАУУ.НематериальныйАктив
	|	И (СтоимостьНМА.Организация = ПорядокУчетаНМАУУ.Организация
	|		ИЛИ МестоУчетаНМА.Организация = ПорядокУчетаНМАУУ.Организация)
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокУчетаНМАБУ.СрезПоследних(&ГраницаОст) КАК ПорядокУчетаНМАБУ
	|ПО СтоимостьНМА.НематериальныйАктив = ПорядокУчетаНМАБУ.НематериальныйАктив
	|	И (СтоимостьНМА.Организация = ПорядокУчетаНМАБУ.Организация
	|		ИЛИ МестоУчетаНМА.Организация = ПорядокУчетаНМАБУ.Организация)
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПервоначальныеСведенияНМА.СрезПоследних(&ГраницаОст) КАК ПервоначальныеСведенияНМА
	|ПО СтоимостьНМА.НематериальныйАктив = ПервоначальныеСведенияНМА.НематериальныйАктив
	|	И (СтоимостьНМА.Организация = ПервоначальныеСведенияНМА.Организация
	|		ИЛИ МестоУчетаНМА.Организация = ПервоначальныеСведенияНМА.Организация)
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПараметрыЦелевогоФинансированияНМА.СрезПоследних(&ГраницаОст) КАК ПараметрыЦФ
	|ПО СтоимостьНМА.НематериальныйАктив = ПараметрыЦФ.НематериальныйАктив
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПараметрыАмортизацииНМАБУ.СрезПоследних(&ГраницаОст) КАК ПараметрыАмортизацииНМАБУ
	|ПО СтоимостьНМА.НематериальныйАктив = ПараметрыАмортизацииНМАБУ.НематериальныйАктив
	|	И (СтоимостьНМА.Организация = ПараметрыАмортизацииНМАБУ.Организация
	|		ИЛИ МестоУчетаНМА.Организация = ПараметрыАмортизацииНМАБУ.Организация)
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПараметрыАмортизацииНМАУУ.СрезПоследних(&ГраницаОст) КАК ПараметрыАмортизацииНМАУУ
	|ПО СтоимостьНМА.НематериальныйАктив = ПараметрыАмортизацииНМАУУ.НематериальныйАктив
	|	И (СтоимостьНМА.Организация = ПараметрыАмортизацииНМАУУ.Организация
	|		ИЛИ МестоУчетаНМА.Организация = ПараметрыАмортизацииНМАУУ.Организация)

	|ГДЕ (ПорядокУчетаНМАУУ.Состояние <> ЗНАЧЕНИЕ(Перечисление.СостоянияНМА.Списан)
	|	ИЛИ ПорядокУчетаНМАБУ.Состояние <> ЗНАЧЕНИЕ(Перечисление.СостоянияНМА.Списан))
	|ИТОГИ ПО
	|	МестоУчетаНМА.Организация,
	|	МестоУчетаНМА.Подразделение,
	|	ВЫБОР КОГДА ПорядокУчетаНМАУУ.Состояние ЕСТЬ NULL ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ ИСТИНА КОНЕЦ,
	|	ВЫБОР КОГДА ПорядокУчетаНМАБУ.Состояние ЕСТЬ NULL ТОГДА
	|		ЛОЖЬ
	|	ИНАЧЕ ИСТИНА КОНЕЦ
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	КоличествоСформированныхДокументов = 1;
	Результат = Запрос.Выполнить();
	ВыборкаОрганизация = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаОрганизация.Следующий() Цикл
		ВыборкаПодразделение = ВыборкаОрганизация.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПодразделение.Следующий() Цикл
			ВыборкаУУ = ВыборкаПодразделение.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаУУ.Следующий() Цикл
				ВыборкаБУ = ВыборкаУУ.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				Пока ВыборкаБУ.Следующий() Цикл
					ДокОст = Документы.ВводОстатковВнеоборотныхАктивов2_4.СоздатьДокумент();
					ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковНМАиРасходовНаНИОКР;
					ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, ВыборкаБУ, Ложь);
					ДокОст.ОтражатьВРеглУчете = Истина;
					ДокОст.ОтражатьВУпрУчете = Истина;
					ДокОст.ВидАктивов = Перечисления.ВидыВнеоборотныхАктивов.НМА;
					Выборка = ВыборкаБУ.Выбрать();
					Пока Выборка.Следующий() Цикл
						Стр = ДокОст.НМА.Добавить();
						ЗаполнитьЗначенияСвойств(Стр, Выборка);
						Если Выборка.ПередаватьРасходыВДругуюОрганизациюБУ Или Выборка.ПередаватьРасходыВДругуюОрганизациюУУ Тогда
							Стр.ПередаватьРасходыВДругуюОрганизацию = Истина;
							Стр.ОрганизацияПолучательРасходов = ?(ЗначениеЗаполнено(Выборка.ОрганизацияПолучательРасходовБУ),
									Выборка.ОрганизацияПолучательРасходовБУ, Выборка.ОрганизацияПолучательРасходовУУ);
						КонецЕсли;
						Стр.ЕстьРезервПереоценки = Стр.РезервПереоценкиАмортизации > 0 Или Стр.РезервПереоценкиСтоимости > 0;
						Стр.ЕстьРезервПереоценкиРегл = Стр.РезервПереоценкиАмортизацииРегл > 0 Или Стр.РезервПереоценкиСтоимостиРегл > 0;
					КонецЦикла;
					КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
					ДокОст.Записать(РежимЗаписиДокумента.Запись);
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	Если КоличествоСформированныхДокументов > 1 Тогда
		ВывестиСообщениеСформированыДокументы("ВводОстатковВнеоборотныхАктивов2_4", НСтр("ru='Остатки нематериальных активов';uk='Залишки нематеріальних активів'"));
	КонецЕсли;
КонецПроцедуры

Процедура СформироватьБухОстатки()
	СчетаБаланс = Новый Массив;
	// забаланс
	СчетаЗабаланс = Новый Массив;

	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет КАК КорСчет,
	|	ХозрасчетныйОстатки.Счет КАК СчетДт,
	|	ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.Вспомогательный) КАК СчетКт,
	|	ХозрасчетныйОстатки.Субконто1,
	|	ХозрасчетныйОстатки.Субконто2,
	|	ХозрасчетныйОстатки.Субконто3,
	|	ХозрасчетныйОстатки.Организация КАК Организация,
	|	ХозрасчетныйОстатки.Валюта КАК ВалютаДт,
	|	NULL КАК ВалютаКт,
	|	ХозрасчетныйОстатки.Подразделение КАК ПодразделениеДт,
	|	NULL КАК ПодразделениеКт,
	|	ХозрасчетныйОстатки.НаправлениеДеятельности КАК НаправлениеДеятельностиДт,
	|	NULL КАК НаправлениеДеятельностиКт,
	|	ХозрасчетныйОстатки.СуммаОстатокДт КАК Сумма,
	|	ХозрасчетныйОстатки.ВалютнаяСуммаОстатокДт КАК ВалютнаяСумма,
	|	ХозрасчетныйОстатки.КоличествоОстатокДт КАК Количество,
	|	ХозрасчетныйОстатки.СуммаНУОстатокДт КАК СуммаНУ,
	|	ХозрасчетныйОстатки.СуммаПРОстатокДт КАК СуммаПР,
	|	ХозрасчетныйОстатки.СуммаВРОстатокДт КАК СуммаВР,
	|	ХозрасчетныйОстатки.СуммаУУОстатокДт КАК СуммаУУ,
	|	ХозрасчетныйОстатки.СуммаФООстатокДт КАК СуммаФО,
	|	ХозрасчетныйОстатки.Счет.ВидыСубконто.(
	|		ВидСубконто КАК ВидСубконто
	|	) КАК ВидыСубконто
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(&ГраницаОст, Счет В ИЕРАРХИИ (&СчетаБаланс)) КАК ХозрасчетныйОстатки
	|ГДЕ
	|	ЕстьNULL(ХозрасчетныйОстатки.СуммаОстатокДт,0) <> 0 
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.Вспомогательный),
	|	ХозрасчетныйОстатки.Счет,
	|	ХозрасчетныйОстатки.Субконто1,
	|	ХозрасчетныйОстатки.Субконто2,
	|	ХозрасчетныйОстатки.Субконто3,
	|	ХозрасчетныйОстатки.Организация,
	|	NULL,
	|	ХозрасчетныйОстатки.Валюта,
	|	NULL,
	|	ХозрасчетныйОстатки.Подразделение,
	|	NULL,
	|	ХозрасчетныйОстатки.НаправлениеДеятельности, 
	|	ХозрасчетныйОстатки.СуммаОстатокКт,
	|	ХозрасчетныйОстатки.ВалютнаяСуммаОстатокКт,
	|	ХозрасчетныйОстатки.КоличествоОстатокКт,
	|	ХозрасчетныйОстатки.СуммаНУОстатокКт,
	|	ХозрасчетныйОстатки.СуммаПРОстатокКт,
	|	ХозрасчетныйОстатки.СуммаВРОстатокКт,
	|	ХозрасчетныйОстатки.СуммаУУОстатокКт,
	|	ХозрасчетныйОстатки.СуммаФООстатокКт,
	|	ХозрасчетныйОстатки.Счет.ВидыСубконто.(
	|		ВидСубконто
	|	)
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(&ГраницаОст, Счет В ИЕРАРХИИ (&СчетаБаланс)) КАК ХозрасчетныйОстатки
	|ГДЕ
	|	ЕстьNULL(ХозрасчетныйОстатки.СуммаОстатокКт,0) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ХозрасчетныйОстатки.Счет,
	|	NULL,
	|	ХозрасчетныйОстатки.Субконто1,
	|	ХозрасчетныйОстатки.Субконто2,
	|	ХозрасчетныйОстатки.Субконто3,
	|	ХозрасчетныйОстатки.Организация,
	|	ХозрасчетныйОстатки.Валюта,
	|	NULL,
	|	ХозрасчетныйОстатки.Подразделение,
	|	NULL,
	|	ХозрасчетныйОстатки.НаправлениеДеятельности, 
	|	NULL,
	|	ХозрасчетныйОстатки.СуммаОстатокДт,
	|	ХозрасчетныйОстатки.ВалютнаяСуммаОстатокДт,
	|	ХозрасчетныйОстатки.КоличествоОстатокДт,
	|	ХозрасчетныйОстатки.СуммаНУОстатокДт,
	|	ХозрасчетныйОстатки.СуммаПРОстатокДт,
	|	ХозрасчетныйОстатки.СуммаВРОстатокДт,
	|	ХозрасчетныйОстатки.СуммаУУОстатокДт,
	|	ХозрасчетныйОстатки.СуммаФООстатокДт,
	|	ХозрасчетныйОстатки.Счет.ВидыСубконто.(
	|		ВидСубконто КАК ВидСубконто
	|	) КАК ВидыСубконто
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(&ГраницаОст, Счет В ИЕРАРХИИ (&СчетаЗабаланс)) КАК ХозрасчетныйОстатки
	|ГДЕ
	|	ЕстьNULL(ХозрасчетныйОстатки.СуммаОстатокДт,0) <> 0 
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	NULL,
	|	ХозрасчетныйОстатки.Счет,
	|	ХозрасчетныйОстатки.Субконто1,
	|	ХозрасчетныйОстатки.Субконто2,
	|	ХозрасчетныйОстатки.Субконто3,
	|	ХозрасчетныйОстатки.Организация,
	|	NULL,
	|	ХозрасчетныйОстатки.Валюта,
	|	NULL,
	|	ХозрасчетныйОстатки.Подразделение,
	|	NULL,
	|	ХозрасчетныйОстатки.НаправлениеДеятельности, 
	|	ХозрасчетныйОстатки.СуммаОстатокКт,
	|	ХозрасчетныйОстатки.ВалютнаяСуммаОстатокКт,
	|	ХозрасчетныйОстатки.КоличествоОстатокКт,
	|	ХозрасчетныйОстатки.СуммаНУОстатокКт,
	|	ХозрасчетныйОстатки.СуммаПРОстатокКт,
	|	ХозрасчетныйОстатки.СуммаВРОстатокКт,
	|	ХозрасчетныйОстатки.СуммаУУОстатокКт,
	|	ХозрасчетныйОстатки.СуммаФООстатокКт,
	|	ХозрасчетныйОстатки.Счет.ВидыСубконто.(
	|		ВидСубконто
	|	)
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(&ГраницаОст, Счет В ИЕРАРХИИ (&СчетаЗабаланс)) КАК ХозрасчетныйОстатки
	|ГДЕ
	|	ЕстьNULL(ХозрасчетныйОстатки.СуммаОстатокКт,0) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация, КорСчет
	|ИТОГИ ПО
	|	Организация, КорСчет";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Запрос.УстановитьПараметр("СчетаБаланс", СчетаБаланс);
	Запрос.УстановитьПараметр("СчетаЗабаланс", СчетаЗабаланс);
	КоличествоСформированныхДокументов = 1;
	ВыборкаОрганизации = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаОрганизации.Следующий() Цикл
		ВыборкаКС = ВыборкаОрганизации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаКС.Следующий() Цикл
			ДокОст = Документы.ОперацияБух.СоздатьДокумент();
			СуммаОперации = 0;
			СуммаОперацииУУ = 0;
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов,ВыборкаКС,Ложь);
			ДокОст.ДополнительныеСвойства.Вставить("СверткаИБ", Истина);
			ДокОст.Записать(РежимЗаписиДокумента.Проведение);
			ДокОстСсылка = ДокОст.Ссылка;
			РБНаборЗаписей = РегистрыБухгалтерии.Хозрасчетный.СоздатьНаборЗаписей();
			РБНаборЗаписей.Отбор.Регистратор.Установить(ДокОстСсылка);

			ВыборкаКС = ВыборкаОрганизации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаКС.Следующий() Цикл
				Выборка = ВыборкаКС.Выбрать();
				Пока Выборка.Следующий() Цикл
					Проводка = РБНаборЗаписей.Добавить();
					Проводка.Период = ДокОст.Дата;
					ЗаполнитьЗначенияСвойств(Проводка, Выборка);
					ЗначенияАналитики = Новый Структура("Субконто1, Субконто2, Субконто3");
					ЗаполнитьЗначенияСвойств(ЗначенияАналитики, Выборка);
					Если ЗначениеЗаполнено(Выборка.СчетДт) И
						Выборка.СчетДт <> ПланыСчетов.Хозрасчетный.Вспомогательный Тогда
						ВидыСубконтоДт = Выборка.ВидыСубконто.Выгрузить();
						// Аналитика дебета.
						Для НомерСубконто = 1 По ВидыСубконтоДт.Количество() Цикл
							Проводка.СубконтоДт[ВидыСубконтоДт[НомерСубконто - 1].ВидСубконто] = ЗначенияАналитики["Субконто"+НомерСубконто];
						КонецЦикла;
					КонецЕсли;
					Если ЗначениеЗаполнено(Выборка.СчетКт) И
						Выборка.СчетКт <> ПланыСчетов.Хозрасчетный.Вспомогательный Тогда
						ВидыСубконтоКт = Выборка.ВидыСубконто.Выгрузить();

						// Аналитика кредита.
						Для НомерСубконто = 1 По ВидыСубконтоКт.Количество() Цикл
							Проводка.СубконтоКт[ВидыСубконтоКт[НомерСубконто - 1].ВидСубконто] = ЗначенияАналитики["Субконто"+НомерСубконто];
						КонецЦикла;
					КонецЕсли;
					СуммаОперации = СуммаОперации + Выборка.Сумма;
					СуммаОперацииУУ = СуммаОперацииУУ + Выборка.СуммаУУ;
				КонецЦикла;
				ДокОст.СуммаОперации = СуммаОперации;
				ДокОст.СуммаУУ = СуммаОперацииУУ;
				ДокОст.Записать(РежимЗаписиДокумента.Проведение);
				РБНаборЗаписей.Записать();
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	ВывестиСообщениеСформированыДокументы("ОперацияБух");

КонецПроцедуры

//-- НЕ УТ

Процедура СкорректироватьКоличествоВТЧДокумента(МассивСтрокТЧ, КоличествоПередано, МассивСтрокКУдалению, ДокументИзменен)
	Для Каждого СтрокаТЧ Из МассивСтрокТЧ Цикл
		Если СтрокаТЧ.Количество > КоличествоПередано Тогда
			СтрокаТЧ.Количество = СтрокаТЧ.Количество - КоличествоПередано;
			КоличествоПередано = 0;
			ДокументИзменен = Истина;
		Иначе
			МассивСтрокКУдалению.Добавить(СтрокаТЧ);
			КоличествоПередано = КоличествоПередано - СтрокаТЧ.Количество;
		КонецЕсли;
		Если КоличествоПередано = 0 Тогда
			Возврат;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Функция СоздатьПервичныйДокументДляСтрокиРасчетов(ДокОст, ОбъектРасчетов, СтрокаРасчетов)
	Если ТипЗнч(ОбъектРасчетов) = Тип("ДокументСсылка.ПервичныйДокумент") Тогда
		Возврат ОбъектРасчетов;
	КонецЕсли;
	Если ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковЗадолженностиКлиентов Тогда
		ТипПервичногоДокумента = Перечисления.ТипыПервичныхДокументов.РеализацияКлиенту;
	ИначеЕсли ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковЗадолженностиПоставщикам Тогда
		ТипПервичногоДокумента = Перечисления.ТипыПервичныхДокументов.ПриобретениеУПоставщика;
	ИначеЕсли ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковАвансовКлиентов Тогда
		ТипПервичногоДокумента = Перечисления.ТипыПервичныхДокументов.ОплатаОтКлиента;
	ИначеЕсли ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковАвансовПоставщикам Тогда
		ТипПервичногоДокумента = Перечисления.ТипыПервичныхДокументов.ОплатаПоставщику; 
	КонецЕсли;
	// Попытка создать первичный документ по объекту расчетов
	Если ЗначениеЗаполнено(ОбъектРасчетов)
		И НЕ (ТипЗнч(ОбъектРасчетов) = Тип("СправочникСсылка.ДоговорыКонтрагентов")
		Или ТипЗнч(ОбъектРасчетов) = Тип("СправочникСсылка.ДоговорыМеждуОрганизациями")) Тогда
		СтруктураРеквизитовШапки = Новый Структура("Дата, Номер");
		ЗаполнитьЗначенияСвойств(СтруктураРеквизитовШапки,ОбъектРасчетов);
		Если СтруктураРеквизитовШапки.Свойство("Дата") И СтруктураРеквизитовШапки.Свойство("Номер") Тогда
			ПДСсылка = ПреобразоватьСсылкуВПервичныйДокумент(ОбъектРасчетов, СтруктураРеквизитовШапки.Дата, СтруктураРеквизитовШапки.Номер, ТипПервичногоДокумента, СтрокаРасчетов.Сумма, СтрокаРасчетов.СуммаРегл);
			Если ЗначениеЗаполнено(ПДСсылка) Тогда
				// Если объект расчетов заполнен подменяем его на первичный документ - убираем ссылку на документ сворачиваемого периода.
				Если ЗначениеЗаполнено(СтрокаРасчетов.ОбъектРасчетов) Тогда
					СтрокаРасчетов.ОбъектРасчетов = ПДСсылка;
				КонецЕсли;
				Возврат ПДСсылка;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	// Создание первичного документа по строке ввода остатков.

	ПервичныйДок = Документы.ПервичныйДокумент.СоздатьДокумент();
	ПервичныйДок.ТипПервичногоДокумента = ТипПервичногоДокумента;
	ПервичныйДок.Дата = ДатаСверткиИБ;
	ЗаполнитьЗначенияСвойств(ПервичныйДок, ДокОст, "Организация");
	ЗаполнитьЗначенияСвойств(ПервичныйДок, СтрокаРасчетов, "Договор, СуммаРегл, Партнер, Контрагент");
	ПервичныйДок.Валюта = СтрокаРасчетов.ВалютаВзаиморасчетов;
	ПервичныйДок.СуммаДокумента = СтрокаРасчетов.Сумма;
	Если ЗначениеЗаполнено(СтрокаРасчетов.НомерРасчетногоДокумента) Тогда
		ПервичныйДок.НомерВходящегоДокумента = СтрокаРасчетов.НомерРасчетногоДокумента;
	Иначе
		ПервичныйДок.НомерВходящегоДокумента = ""+ДокОст.Номер+"/"+СтрокаРасчетов.НомерСтроки;
	КонецЕсли;
	Если ЗначениеЗаполнено(СтрокаРасчетов.ДатаРасчетногоДокумента) Тогда
		ПервичныйДок.ДатаВходящегоДокумента = СтрокаРасчетов.ДатаРасчетногоДокумента;
	Иначе
		ПервичныйДок.ДатаВходящегоДокумента = ПервичныйДок.Дата;
	КонецЕсли;
	ПредставлениеДокументаОстатков = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ввод начальных остатков № %1 от %2 / %3';uk='Введення початкових залишків № %1 від %2 / %3'"), ДокОст.Номер, ДокОст.Дата, СтрокаРасчетов.НомерСтроки);
	ПервичныйДок.Комментарий = Комментарий_СформированСверткойБазы+" ["+ПредставлениеДокументаОстатков + "]";
	Если ЗначениеЗаполнено(ПервичныйДок.Договор) Тогда
		ПервичныйДок.ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоДоговорамКонтрагентов;
	Иначе
		ПервичныйДок.ПорядокРасчетов = Перечисления.ПорядокРасчетов.ПоНакладным;
	КонецЕсли;
	ПервичныйДок.ОбменДанными.Загрузка = Истина;
	ПервичныйДок.Записать(РежимЗаписиДокумента.Запись);
	// Если объект расчетов пуст, подставим туда созданный первичный документ.
	Если НЕ ЗначениеЗаполнено(СтрокаРасчетов.ОбъектРасчетов)
		// Объект расчетов из выборки не подходит по типу к реквизиту табличной части.
		Или СтрокаРасчетов.ОбъектРасчетов <> ОбъектРасчетов Тогда
		СтрокаРасчетов.ОбъектРасчетов = ПервичныйДок.Ссылка;
	КонецЕсли;
	Возврат ПервичныйДок.Ссылка;
КонецФункции

#КонецОбласти

#Область ВспомогательныеПроцедурыДляФормированияДокументовВводаОстатков

Процедура ПолучитьТаблицыОстатковНаСкладах()
	//Остатки, по которым будут заполняться серии и помещения
	
	//Остатки на складах по помещениям
	Запрос = Новый Запрос; 
	Запрос.Текст = "ВЫБРАТЬ 
	|ТоварыНаСкладах.Номенклатура КАК Номенклатура,
	|ТоварыНаСкладах.Характеристика КАК Характеристика,
	|ТоварыНаСкладах.Склад КАК Склад,
	|ТоварыНаСкладах.Помещение КАК Помещение,
	|ТоварыНаСкладах.Назначение КАК Назначение,
	|ТоварыНаСкладах.ВНаличииОстаток КАК Количество
	|ИЗ РегистрНакопления.ТоварыНаСкладах.Остатки(&ГраницаОст,  
	|					Склад.ИспользоватьСкладскиеПомещения = Истина
	|				)	КАК ТоварыНаСкладах
	|ГДЕ ВНаличииОстаток>0";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Результат = Запрос.Выполнить();
	ТаблицаОстаткиНаСкладахПоПомещениям = Результат.Выгрузить();
	
	ТаблицаОстаткиНаСкладахПоНазначению = Новый ТаблицаЗначений;
	Если ИспользоватьНазначения Тогда
		ТаблицаОстаткиНаСкладахПоНазначению = ТаблицаОстаткиНаСкладахПоПомещениям.Скопировать();
		ТаблицаОстаткиНаСкладахПоНазначению.Индексы.Добавить("Номенклатура, Характеристика, Склад, Помещение");
	КонецЕсли;
	ТаблицаОстаткиНаСкладахПоПомещениям.Индексы.Добавить("Номенклатура, Характеристика, Склад");

	//Остатки по сериям для  стратегии Авторасчет серий по FEFO
	Запрос = Новый Запрос; 

	Запрос.Текст = "ВЫБРАТЬ
	|	Номенклатура,
	|	Характеристика,
	|	Серия,
	|	Назначение,
	|	Склад,
	|	Помещение,
	|	Сумма(КоличествоОстаток) КАК КоличествоОстаток
	|ПОМЕСТИТЬ ОстаткиСерийПоFEFO
	|ИЗ (
	|	ВЫБРАТЬ 
	|		ДвиженияСерийТоваров.Номенклатура КАК Номенклатура,
	|		ДвиженияСерийТоваров.Характеристика КАК Характеристика,
	|		ДвиженияСерийТоваров.Серия КАК Серия,
	|		ДвиженияСерийТоваров.Назначение КАК Назначение,
	|		ДвиженияСерийТоваров.Отправитель КАК Склад,
	|		ДвиженияСерийТоваров.ПомещениеОтправителя КАК Помещение,
	|		(-1)*ДвиженияСерийТоваров.Количество КАК КоличествоОстаток
		|ИЗ РегистрНакопления.ДвиженияСерийТоваров КАК ДвиженияСерийТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыНоменклатуры.ПолитикиУчетаСерий КАК ТЧПолитикаУчетаСерий
	|		ПО ТЧПолитикаУчетаСерий.Склад = ДвиженияСерийТоваров.Отправитель
	|			И ТЧПолитикаУчетаСерий.Ссылка = ДвиженияСерийТоваров.Номенклатура.ВидНоменклатуры
	|	ГДЕ ТЧПолитикаУчетаСерий.ПолитикаУчетаСерий.ТипПолитики = ЗНАЧЕНИЕ(Перечисление.ТипыПолитикУказанияСерий.АвторасчетПоFEFOОстатковСерий)
	|		И ДвиженияСерийТоваров.Отправитель ССЫЛКА Справочник.Склады
	|	ОБЪЕДИНИТЬ ВСЕ
	|	ВЫБРАТЬ
	|		ДвиженияСерийТоваров.Номенклатура КАК Номенклатура,
	|		ДвиженияСерийТоваров.Характеристика КАК Характеристика,
	|		ДвиженияСерийТоваров.Серия КАК Серия,
	|		ДвиженияСерийТоваров.Назначение КАК Назначение,
	|		ДвиженияСерийТоваров.Получатель КАК Склад,
	|		ДвиженияСерийТоваров.ПомещениеПолучателя КАК Помещение,
	|		ДвиженияСерийТоваров.Количество КАК КоличествоОстаток
	|	ИЗ РегистрНакопления.ДвиженияСерийТоваров КАК ДвиженияСерийТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыНоменклатуры.ПолитикиУчетаСерий КАК ТЧПолитикаУчетаСерий
	|		ПО ТЧПолитикаУчетаСерий.Склад = ДвиженияСерийТоваров.Получатель
	|			И ТЧПолитикаУчетаСерий.Ссылка = ДвиженияСерийТоваров.Номенклатура.ВидНоменклатуры
	|	ГДЕ ТЧПолитикаУчетаСерий.ПолитикаУчетаСерий.ТипПолитики = ЗНАЧЕНИЕ(Перечисление.ТипыПолитикУказанияСерий.АвторасчетПоFEFOОстатковСерий)
	|		И ДвиженияСерийТоваров.Получатель ССЫЛКА Справочник.Склады
	|	) КАК ТабСвод
	|СГРУППИРОВАТЬ ПО 
	|	Номенклатура,
	|	Характеристика,
	|	Серия,
	|	Назначение,
	|	Склад,
	|	Помещение
	|;
	|ВЫБРАТЬ 
	|	ТоварыНаСкладах.Склад КАК Склад,
	|	ТоварыНаСкладах.Помещение КАК Помещение,
	|	ТоварыНаСкладах.Номенклатура КАК Номенклатура,
	|	ТоварыНаСкладах.Характеристика КАК Характеристика,
	|	ТоварыНаСкладах.Серия КАК Серия,
	|	ТоварыНаСкладах.Назначение КАК Назначение,
	|	ОстаткиСерийПоFEFO.Серия КАК СерияПоFEFO,
	|	ЕстьNULL(ОстаткиСерийПоFEFO.КоличествоОстаток,0) КАК КоличествоПоFEFO,
	|	ТоварыНаСкладах.ВНаличииОстаток КАК Количество
	|ИЗ РегистрНакопления.ТоварыНаСкладах.Остатки(&ГраницаОст, 
	|							(Склад.ИспользоватьСерииНоменклатуры = Истина 
	|							И Номенклатура.ВидНоменклатуры.ИспользоватьСерии = Истина) 
	|				)	КАК ТоварыНаСкладах
	|ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиСерийПоFEFO 
	|ПО  ТоварыНаСкладах.Номенклатура = ОстаткиСерийПоFEFO.Номенклатура И
	|	ТоварыНаСкладах.Характеристика = ОстаткиСерийПоFEFO.Характеристика И
	|	ТоварыНаСкладах.Склад = ОстаткиСерийПоFEFO.Склад И
	|	ТоварыНаСкладах.Помещение = ОстаткиСерийПоFEFO.Помещение И
	|	ТоварыНаСкладах.Назначение = ОстаткиСерийПоFEFO.Назначение И
	|	ЕстьNULL(ОстаткиСерийПоFEFO.КоличествоОстаток,0) > 0 
	|ГДЕ ВНаличииОстаток>0 
	|УПОРЯДОЧИТЬ ПО
	|	ТоварыНаСкладах.Склад,
	|	ТоварыНаСкладах.Помещение,
	|	ТоварыНаСкладах.Номенклатура,
	|	ТоварыНаСкладах.Характеристика,
	|	ТоварыНаСкладах.Серия,
	|	ТоварыНаСкладах.Назначение,
	|	ОстаткиСерийПоFEFO.Серия.ГоденДо Убыв
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Выборка = Запрос.Выполнить().Выбрать();
	
	ТаблицаОстаткиНаСкладахПоСериям = Новый ТаблицаЗначений;
	Для Каждого КолонкаТЗ Из ТаблицаОстаткиНаСкладахПоПомещениям.Колонки Цикл
		ТаблицаОстаткиНаСкладахПоСериям.Колонки.Добавить(КолонкаТЗ.Имя, КолонкаТЗ.ТипЗначения);
	КонецЦикла;
	ТаблицаОстаткиНаСкладахПоСериям.Колонки.Добавить("Серия");
	Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Помещение") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("Номенклатура") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("Характеристика") Цикл
					Пока Выборка.СледующийПоЗначениюПоля("Серия") Цикл
						Пока Выборка.СледующийПоЗначениюПоля("Назначение") Цикл
							Если ЗначениеЗаполнено(Выборка.Серия) Тогда
								НоваяСтрока = ТаблицаОстаткиНаСкладахПоСериям.Добавить();
								ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
								Продолжить;
							КонецЕсли;
							//Серии вычисляем по FEFO
							КоличествоРаспределить = Выборка.Количество;
							Пока Выборка.Следующий() Цикл
								Если Выборка.КоличествоПоFEFO <= 0 ИЛИ НЕ ЗначениеЗаполнено(Выборка.СерияПоFEFO) Тогда
									Продолжить;
								КонецЕсли;
								НоваяСтрока = ТаблицаОстаткиНаСкладахПоСериям.Добавить();
								ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
								НоваяСтрока.Серия = Выборка.СерияПоFEFO;
								НоваяСтрока.Количество = Мин(Выборка.КоличествоПоFEFO, КоличествоРаспределить);
								КоличествоРаспределить = КоличествоРаспределить - НоваяСтрока.Количество;
								Если КоличествоРаспределить = 0 Тогда
									Прервать;
								КонецЕсли;
							КонецЦикла;
							Если КоличествоРаспределить > 0 Тогда
								//Недостающее запишем с пустой серией
								НоваяСтрока = ТаблицаОстаткиНаСкладахПоСериям.Добавить();
								ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
								НоваяСтрока.Количество = КоличествоРаспределить;
							КонецЕсли;
						КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Назначение")
					КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Серия") Цикл
				КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Характеристика") Цикл
			КонецЦикла;//Пока Выборка.СледующийПоЗначениюПоля("Номенклатура") Цикл
		КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Помещение") Цикл
	КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
	ТаблицаОстаткиНаСкладахПоСериям.Индексы.Добавить("Номенклатура, Характеристика, Склад, Помещение");
КонецПроцедуры

Процедура ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, ПорядковыйНомерДокумента, Выборка, ЗаполнятьФлагиОтраженияВУчетах = Истина)
	ДокОст.Дата = КонецДня(ДатаСверткиИБ);
	ДокОст.Комментарий = Комментарий_СформированСверткойБазы+?(ПорядковыйНомерДокумента>0," ["+ПорядковыйНомерДокумента+"]","");
	ДокОст.Ответственный =  ПользователиКлиентСервер.ТекущийПользователь();
	ЗаполнитьЗначенияСвойств(ДокОст, Выборка);
	Если ЗаполнятьФлагиОтраженияВУчетах Тогда
		ДокОст.ОтражатьВОперативномУчете = Истина;
		Если ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
			ДокОст.ОтражатьВБУиНУ = Истина;
			ДокОст.ОтражатьВУУ = Истина;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура ОбработатьРезультатЗапросаСобственныеТовары(Выборка, КоличествоСформированныхДокументов, ЕстьСФ = Ложь, ТаблицаОстатковПоГТД = Неопределено)
	Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
		Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
			Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
				Пока Выборка.СледующийПоЗначениюПоля("НалоговоеНазначение") Цикл
						ДокОст = Документы.ВводОстатковТоваров.СоздатьДокумент();
						ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка);
						ДокОст.ОтражатьСебестоимость = Истина;
						Если НЕ ЗначениеЗаполнено(ДокОст.НалоговоеНазначение) Тогда
							ДокОст.НалоговоеНазначение = Справочники.НалоговыеНазначенияАктивовИЗатрат.НДС_Облагаемая
						КонецЕсли;
						ДокОст.ЦенаВключаетНДС = Истина;

						СоответствиеДокументовПоПомещениям = Новый Соответствие();

						Пока Выборка.Следующий() Цикл
							ВыбранныеВариантыПомещений = Новый Массив;
							Если ЕстьСФ Тогда
								КоличествоРаспределить = Мин(Выборка.Количество, Выборка.КоличествоМаксимум);
							Иначе 
								КоличествоРаспределить = Выборка.Количество;
							КонецЕсли;
							
							//Определим помещение
							Если Выборка.ИспользоватьСкладскиеПомещения Тогда
								ПодобратьПодходящиеПомещения(Выборка, ВыбранныеВариантыПомещений, КоличествоРаспределить);
							КонецЕсли; //Если Выборка.ИспользоватьСкладскиеПомещения Тогда
							Если НЕ Выборка.ИспользоватьСкладскиеПомещения ИЛИ ВыбранныеВариантыПомещений.Количество() = 0 Тогда
								ИспользоватьАдресноеХранение = СкладыСервер.ИспользоватьАдресноеХранение(ДокОст.Склад, ДокОст.Помещение, ДокОст.Дата, Истина);
								Если ИспользоватьАдресноеХранение И НЕ ЗначениеЗаполнено(ДокОст.ЗонаПриемки) Тогда
									ДокОст.ЗонаПриемки = ПолучитьЯчейкуЗонаПриемки(ДокОст.Склад, ДокОст.Помещение);
								КонецЕсли;
								НоваяСтрока = ДокОст.Товары.Добавить();
								ЗаполнитьСуммыИКоличестваТабличнойЧасти(НоваяСтрока, Выборка, ЕстьСФ);
							Иначе
								
								Для Каждого СтрокаПомещение ИЗ ВыбранныеВариантыПомещений Цикл
									ТекПомещение = СтрокаПомещение.Помещение;
									НайтиСоздатьДокументОстатковПоПомещению(Выборка, ТекПомещение, ДокОст, СоответствиеДокументовПоПомещениям, КоличествоСформированныхДокументов);

									НоваяСтрока = ДокОст.Товары.Добавить();
									ЗаполнитьСуммыИКоличестваТабличнойЧасти(НоваяСтрока, Выборка, ЕстьСФ);
									
									//Пересчитаем суммы и количества в соответствии с остатком по помещению
									КоличествоПоПомещению = Мин(КоличествоРаспределить, СтрокаПомещение.Количество);
									СтрокаПомещение.Количество = СтрокаПомещение.Количество - КоличествоПоПомещению;
									Если КоличествоПоПомещению <> НоваяСтрока.Количество Тогда
										КоэффициентПересчета = КоличествоПоПомещению / Выборка.Количество;
										НоваяСтрока.Количество = КоличествоПоПомещению;
										НоваяСтрока.Сумма = ОКР(КоэффициентПересчета * НоваяСтрока.Сумма,2);
										НоваяСтрока.СуммаБезНДС = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаБезНДС,2);
										НоваяСтрока.СуммаСНДС = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаСНДС,2);
										НоваяСтрока.СуммаНДС = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаНДС,2);
										НоваяСтрока.СуммаРегл = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаРегл,2);
										НоваяСтрока.НДСРегл = ОКР(КоэффициентПересчета * НоваяСтрока.НДСРегл,2);
									КонецЕсли;
									//Заполним связанные данные
									ЗаполнитьДанныеПоУпаковкам(НоваяСтрока);
									КоличествоРаспределить = КоличествоРаспределить - НоваяСтрока.Количество;
									Если КоличествоРаспределить <=0 Тогда
										Прервать;
									КонецЕсли;
								КонецЦикла; //Для Каждого СтрокаПомещение ИЗ ВыбранныеВариантыПомещений Цикл
								Если КоличествоРаспределить > 0 Тогда
									//не все распределилось по помещениям
									//Возможно, это товары к поступлению по ордерной схеме
									//Попытка определить помещение
									//Если не нашлось - будет пустое помещение
									ТекПомещение = ПроверитьПоступлениеПоОрдеру(Выборка, КоличествоРаспределить);
									НайтиСоздатьДокументОстатковПоПомещению(Выборка, ТекПомещение, ДокОст, СоответствиеДокументовПоПомещениям, КоличествоСформированныхДокументов);
									НоваяСтрока = ДокОст.Товары.Добавить();
									ЗаполнитьСуммыИКоличестваТабличнойЧасти(НоваяСтрока, Выборка, ЕстьСФ);
									КоэффициентПересчета = КоличествоРаспределить / Выборка.Количество;
									НоваяСтрока.Количество = КоличествоРаспределить;
									НоваяСтрока.Сумма = ОКР(КоэффициентПересчета * НоваяСтрока.Сумма,2);
									НоваяСтрока.СуммаБезНДС = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаБезНДС,2);
									НоваяСтрока.СуммаСНДС = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаСНДС,2);
									НоваяСтрока.СуммаНДС = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаНДС,2);
									НоваяСтрока.СуммаРегл = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаРегл,2);
									НоваяСтрока.НДСРегл = ОКР(КоэффициентПересчета * НоваяСтрока.НДСРегл,2);
									ЗаполнитьДанныеПоУпаковкам(НоваяСтрока);
								КонецЕсли;
							КонецЕсли;  //Если НЕ Выборка.ИспользоватьСкладскиеПомещения ИЛИ ВыбранныеВариантыПомещений.Количество() = 0 Тогда
						КонецЦикла; //Пока Выборка.Следующий() Цикл
						ДокОст.Записать(РежимЗаписиДокумента.Запись);
						СоответствиеДокументовПоПомещениям.Вставить(ДокОст.Помещение, ДокОст.Ссылка);
						Для Каждого ЭлементСоответствия ИЗ СоответствиеДокументовПоПомещениям Цикл
							ДокОст = ЭлементСоответствия.Значение.ПолучитьОбъект();
							Если ДокОст.Товары.Количество()=0 Тогда
								ДокОст.Удалить();
								Продолжить;
							КонецЕсли;
							ДокОст.ОтражатьСебестоимость = Истина;

							Если НЕ ЗначениеЗаполнено(ДокОст.ХозяйственнаяОперация) Тогда
								ДокОст.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВводОстатковСобственныхТоваров;
							КонецЕсли;
							ИспользоватьАдресноеХранение = СкладыСервер.ИспользоватьАдресноеХранение(ДокОст.Склад, ДокОст.Помещение, ДокОст.Дата, Истина);
							Если ИспользоватьАдресноеХранение И НЕ ЗначениеЗаполнено(ДокОст.ЗонаПриемки) Тогда
								ДокОст.ЗонаПриемки = ПолучитьЯчейкуЗонаПриемки(ДокОст.Склад, ДокОст.Помещение);
							КонецЕсли;
							// Заполним сведения о ГТД если они есть (для документов, заполняемых на основе данных по партиям).
							Если ТаблицаОстатковПоГТД <> Неопределено И ТаблицаОстатковПоГТД.Количество() > 0 Тогда
								Для Каждого СтрТовары Из ДокОст.Товары Цикл
									ВестиУчетПоГТД = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрТовары.Номенклатура, "ВестиУчетПоГТД");
									Если НЕ ВестиУчетПоГТД Тогда
										Продолжить;
									ИначеЕсли ЗначениеЗаполнено(СтрТовары.НомерГТД) Тогда
										// Уже распределили.
										Продолжить;
									КонецЕсли;
									
									СтруктураПоиска = Новый Структура();
									СтруктураПоиска.Вставить("Организация",      ДокОст.Организация);
									СтруктураПоиска.Вставить("Склад",                   ДокОст.Склад);
									СтруктураПоиска.Вставить("Номенклатура",   СтрТовары.Номенклатура); 
									СтруктураПоиска.Вставить("Характеристика", СтрТовары.Характеристика);

									СтрокиГТД = ТаблицаОстатковПоГТД.НайтиСтроки(СтруктураПоиска);
									Если СтрокиГТД.Количество() = 0 Тогда
										Продолжить;
									КонецЕсли;
									КоличествоРаспределить = СтрТовары.Количество;
									Для Каждого СтрокаГТД Из СтрокиГТД Цикл
										Если КоличествоРаспределить = 0 Тогда
											Прервать;
										ИначеЕсли СтрокаГТД.Количество = 0 Тогда
											Продолжить;
										КонецЕсли;
										Если СтрокаГТД.Количество >= СтрТовары.Количество Тогда
											СтрТовары.НомерГТД = СтрокаГТД.НомерГТД;
											КоличествоРаспределить = 0;
											СтрокаГТД.Количество = СтрокаГТД.Количество - СтрТовары.Количество;
										Иначе
											// Количества по ГТД не хватает на всю строку.
											КоличествоРаспределить = КоличествоРаспределить - СтрокаГТД.Количество;
											// Создаем новую строку с заполненным ГТД на имеющееся количество.
											НоваяСтрока = ДокОст.Товары.Добавить();
											ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрТовары);
											НоваяСтрока.НомерГТД = СтрокаГТД.НомерГТД;
											НоваяСтрока.Количество = СтрокаГТД.Количество;
											КоэффициентПересчета = НоваяСтрока.Количество / СтрТовары.Количество;
											НоваяСтрока.Сумма = ОКР(КоэффициентПересчета * НоваяСтрока.Сумма,2);
											НоваяСтрока.СуммаБезНДС = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаБезНДС,2);
											НоваяСтрока.СуммаСНДС = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаСНДС,2);
											НоваяСтрока.СуммаНДС = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаНДС,2);
											НоваяСтрока.СуммаРегл = ОКР(КоэффициентПересчета * НоваяСтрока.СуммаРегл,2);
											НоваяСтрока.НДСРегл = ОКР(КоэффициентПересчета * НоваяСтрока.НДСРегл,2);
											ЗаполнитьДанныеПоУпаковкам(НоваяСтрока);

											// Уменьшаем количество в текущей строке.
											КоэффициентПересчета = КоличествоРаспределить / СтрТовары.Количество;
											СтрТовары.Количество = КоличествоРаспределить;
											СтрТовары.Сумма = ОКР(КоэффициентПересчета * СтрТовары.Сумма,2);
											СтрТовары.СуммаБезНДС = ОКР(КоэффициентПересчета * СтрТовары.СуммаБезНДС,2);
											СтрТовары.СуммаСНДС = ОКР(КоэффициентПересчета * СтрТовары.СуммаСНДС,2);
											СтрТовары.СуммаНДС = ОКР(КоэффициентПересчета * СтрТовары.СуммаНДС,2);
											СтрТовары.СуммаРегл = ОКР(КоэффициентПересчета * СтрТовары.СуммаРегл,2);
											СтрТовары.НДСРегл = ОКР(КоэффициентПересчета * СтрТовары.НДСРегл,2);
											ЗаполнитьДанныеПоУпаковкам(СтрТовары);

										КонецЕсли;
									КонецЦикла;
									
								КонецЦикла;
							КонецЕсли;
							//Заполним серии для тех строк, где это необходимо
							ЗаполнитьСерииТоваров(ДокОст);
							//Заполним назначения товаров
							ЗаполнитьНазначенияТоваров(ДокОст);
							Если НЕ ЗначениеЗаполнено(ДокОст.Контрагент) И ЗначениеЗаполнено(ДокОст.Партнер) Тогда
								ДокОст.Контрагент = ПартнерыИКонтрагенты.ПолучитьКонтрагентаПартнераПоУмолчанию(ДокОст.Партнер);
							КонецЕсли;
							ДокОст.Записать(РежимЗаписиДокумента.Запись);
						КонецЦикла;  //Для Каждого ЭлементСоответствия ИЗ СоответствиеДокументовПоПомещениям Цикл
				КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("НалоговоеНазначение") Цикл
			КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Партнер") Цикл
		КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Склад") Цикл
	КонецЦикла; //Пока Выборка.СледующийПоЗначениюПоля("Организация") Цикл
КонецПроцедуры

Функция ПроверитьПоступлениеПоОрдеру(Выборка, КоличествоПоступило)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|РегКПоступлению.ДокументПоступления КАК Док
	|ПОМЕСТИТЬ Распоряжения
	|ИЗ РегистрНакопления.ТоварыКПоступлению.Остатки(&ГраницаОст, Номенклатура = &Номенклатура 
	|												И Склад = &Склад 
	|												И Характеристика = &Характеристика) КАК РегКПоступлению
	|ГДЕ КОформлениюОрдеровОстаток > 0 
	|	И НЕ (РегКПоступлению.ДокументПоступления ССЫЛКА Справочник.СоглашенияСПоставщиками)
	|	И РегКПоступлению.ДокументПоступления.Организация = &Организация
	|;
	|ВЫБРАТЬ
	|ВЫРАЗИТЬ(РегОбороты.Регистратор КАК ДОкумент.ПриходныйОрдерНаТовары).Помещение КАК Помещение,
	|Сумма(РегОбороты.КОформлениюОрдеровРасход) КАК Количество
	|ИЗ РегистрНакопления.ТоварыКПоступлению.Обороты(&ГраницаОст,,Регистратор,
	|										Номенклатура = &Номенклатура
	|										И Склад = &Склад 
	|										И Характеристика = &Характеристика 
	|										И ДокументПоступления В (ВЫБРАТЬ Док ИЗ Распоряжения)
	|										) КАК РегОбороты
	|ГДЕ РегОбороты.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары И РегОбороты.КОформлениюОрдеровРасход > 0
	|СГРУППИРОВАТЬ ПО ВЫРАЗИТЬ(РегОбороты.Регистратор КАК ДОкумент.ПриходныйОрдерНаТовары).Помещение
	|";
	ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос);
	Запрос.УстановитьПараметр("Номенклатура", Выборка.Номенклатура);
	Запрос.УстановитьПараметр("Характеристика", Выборка.Характеристика);
	Запрос.УстановитьПараметр("Организация", Выборка.Организация);
	Запрос.УстановитьПараметр("Склад", Выборка.Склад);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат Справочники.СкладскиеПомещения.ПустаяСсылка();
	КонецЕсли;
	ВыборкаПоОрдеру = Результат.Выбрать();
	Пока ВыборкаПоОрдеру.Следующий() Цикл
		Если ВыборкаПоОрдеру.Количество >= КоличествоПоступило Тогда
			Возврат ВыборкаПоОрдеру.Помещение;
		КонецЕсли;
	КонецЦикла;
	Возврат Справочники.СкладскиеПомещения.ПустаяСсылка();
КонецФункции

Процедура ЗаполнитьСуммыИКоличестваТабличнойЧасти(НоваяСтрока, Выборка, ЕстьСФ)
	// Заполнение через промежуточную структуру чтобы не анализировать какие поля есть в выборке.
	ДанныеВыборки = Новый Структура("Номенклатура, Характеристика, Количество, СтавкаНДС, НомерГТД");
	ЗаполнитьЗначенияСвойств(ДанныеВыборки, Выборка);
	ЗаполнитьЗначенияСвойств(НоваяСтрока, ДанныеВыборки);
	Если ЗначениеЗаполнено(Выборка.ГруппаФинансовогоУчета) Тогда
		СтруктураРеквизитов = Новый Структура("ГруппаФинансовогоУчета, ТипЗапасов, Организация",Выборка.ГруппаФинансовогоУчета, Перечисления.ТипыЗапасов.Товар, Выборка.Организация);
		НоваяСтрока.ВидЗапасов = Справочники.ВидыЗапасов.ВидЗапасовДокумента(Выборка.Организация, , СтруктураРеквизитов);
	КонецЕсли;
	//Заполнение сумм и количества
	Если ЕстьСФ Тогда
		Если Выборка.Количество <= Выборка.КоличествоМаксимум Тогда
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка,"Сумма, СуммаБезНДС, СуммаНДС, СуммаРегл, НДСРегл");
		Иначе
			НоваяСтрока.Количество = Выборка.КоличествоМаксимум;
			КоэффициентПересчета = Выборка.КоличествоМаксимум / Выборка.Количество;
			НоваяСтрока.Сумма = Окр(КоэффициентПересчета * Выборка.Сумма, 2);
			НоваяСтрока.СуммаБезНДС = Окр(КоэффициентПересчета * Выборка.СуммаБезНДС, 2);
			НоваяСтрока.СуммаНДС = НоваяСтрока.Сумма - НоваяСтрока.СуммаБезНДС;
			НоваяСтрока.СуммаРегл = Окр(КоэффициентПересчета * Выборка.СуммаРегл, 2);
			НоваяСтрока.НДСРегл = Окр(КоэффициентПересчета * Выборка.НДСРегл, 2);
		КонецЕсли;
	Иначе
		Если Выборка.Партии_Количество > 0 И Выборка.Сумма > 0 Тогда
			Если Выборка.Партии_Количество = Выборка.Количество Тогда
				ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка,"Сумма, СуммаБезНДС, СуммаНДС, СуммаРегл, НДСРегл");
			Иначе
				КоэффициентПересчета = Выборка.Количество / Выборка.Партии_Количество;
				НоваяСтрока.Сумма = Окр(КоэффициентПересчета * Выборка.Сумма, 2);
				НоваяСтрока.СуммаБезНДС = Окр(КоэффициентПересчета * Выборка.СуммаБезНДС, 2);
				НоваяСтрока.СуммаНДС = НоваяСтрока.Сумма - НоваяСтрока.СуммаБезНДС;
				НоваяСтрока.СуммаРегл = Окр(КоэффициентПересчета * Выборка.СуммаРегл, 2);
				НоваяСтрока.НДСРегл = Окр(КоэффициентПересчета * Выборка.НДСРегл, 2);
			КонецЕсли;
		ИначеЕсли Выборка.Себестоимость_Стоимость > 0 И Выборка.Себестоимость_Количество > 0 Тогда
			//Суммы заполняем по данным о себестоимости
			КоэффициентПересчета = Выборка.Количество / Выборка.Себестоимость_Количество;
			НоваяСтрока.Сумма = Окр(КоэффициентПересчета * Выборка.Себестоимость_Стоимость, 2);
			НоваяСтрока.СуммаБезНДС = Окр(КоэффициентПересчета * Выборка.Себестоимость_СтоимостьБезНДС, 2);
			НоваяСтрока.СуммаНДС = НоваяСтрока.Сумма - НоваяСтрока.СуммаБезНДС;
			НоваяСтрока.СуммаРегл = Окр(КоэффициентПересчета * Выборка.Себестоимость_СтоимостьРегл, 2);
			НоваяСтрока.НДСРегл = ?(НоваяСтрока.СуммаНДС = 0, 0, Окр(НоваяСтрока.СуммаРегл * НоваяСтрока.СуммаНДС / НоваяСтрока.Сумма,2));
		КонецЕсли;
	КонецЕсли;
	
	//Заполним связанные данные
	ЗаполнитьДанныеПоУпаковкам(НоваяСтрока);
	Если НоваяСтрока.Количество > 0 Тогда
		НоваяСтрока.Цена = Окр(НоваяСтрока.Сумма / НоваяСтрока.Количество,2);
	КонецЕсли;
	Если  НЕ ЗначениеЗаполнено(НоваяСтрока.СтавкаНДС) Тогда
		Если НоваяСтрока.СуммаНДС <> 0 Тогда
			НоваяСтрока.СтавкаНДС = УчетНДСЛокализация.СтавкаНДСПоПеречислению(Перечисления.СтавкиНДС.НДС20);
		Иначе
			НоваяСтрока.СтавкаНДС = Справочники.СтавкиНДС.БезНДС;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура ПодобратьПодходящиеПомещения(Выборка, ВыбранныеВариантыПомещений, Количество, УчитыватьСерии = Ложь)
	//Определим помещение
	СтруктураОтбора = Новый Структура("Номенклатура, Характеристика, Склад");
	Если УчитыватьСерии Тогда
		СтруктураОтбора.Вставить("Серия");
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(СтруктураОтбора, Выборка);
	
	МассивСтрокОстаткиПоПомещениям = ТаблицаОстаткиНаСкладахПоПомещениям.НайтиСтроки(СтруктураОтбора);
	//проход №1 - ищем все количество в одном помещении, берем наименьшее из возможных
	ПодходящиеВарианты = Новый Массив;
	
	Для Каждого СтрокаОстаток ИЗ МассивСтрокОстаткиПоПомещениям Цикл
		Если СтрокаОстаток.Количество < Количество Тогда
			Продолжить;
		КонецЕсли;
		ПодходящиеВарианты.Добавить(СтрокаОстаток);
	КонецЦикла;
	Если ПодходящиеВарианты.Количество() > 0 Тогда
		ОптимальныйВариант = Неопределено;
		Для Каждого СтрокаОстаток ИЗ ПодходящиеВарианты Цикл
			Если ОптимальныйВариант = Неопределено Тогда
				ОптимальныйВариант = СтрокаОстаток;
			ИначеЕсли ОптимальныйВариант.Количество > СтрокаОстаток.Количество Тогда
				ОптимальныйВариант = СтрокаОстаток;
			КонецЕсли;
		КонецЦикла;
		ВыбранныеВариантыПомещений.Добавить(ОптимальныйВариант);
	Иначе
		//Надо распределить количество по нескольким помещениям
		КоличествоРаспределить = Количество;
		Для Каждого СтрокаОстаток ИЗ МассивСтрокОстаткиПоПомещениям Цикл
			Если СтрокаОстаток.Количество <= 0 Тогда
				Продолжить;
			КонецЕсли;
			ВыбранныеВариантыПомещений.Добавить(СтрокаОстаток);
			КоличествоРаспределить = КоличествоРаспределить - СтрокаОстаток.Количество;
			Если КоличествоРаспределить <= 0 Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;  //Если ПодходящиеВарианты.Количество() > 0 Тогда

КонецПроцедуры

Процедура НайтиСоздатьДокументОстатковПоПомещению(Выборка, ТекПомещение, ДокОст, 
													СоответствиеДокументовПоПомещениям, 
													КоличествоСформированныхДокументов)
	Если ТекПомещение = ДокОст.Помещение Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ДокОст.Помещение) И ДокОст.Товары.Количество()=0 Тогда
		ДокОст.Помещение = ТекПомещение;
		ДокОст.Записать(РежимЗаписиДокумента.Запись);
		СоответствиеДокументовПоПомещениям.Вставить(ТекПомещение, ДокОст.Ссылка);
	Иначе
		ДокОст.Записать(РежимЗаписиДокумента.Запись);
		СоответствиеДокументовПоПомещениям.Вставить(ДокОст.Помещение, ДокОст.Ссылка);
		
		ДокСсылка = СоответствиеДокументовПоПомещениям.Получить(ТекПомещение);
		Если ДокСсылка = Неопределено Тогда
			КоличествоСформированныхДокументов = КоличествоСформированныхДокументов + 1;
			
			ДокОст = Документы.ВводОстатковТоваров.СоздатьДокумент();
			ЗаполнитьШапкуДокументаВводаОстатков(ДокОст, КоличествоСформированныхДокументов, Выборка, Истина);
			ДокОст.ОтражатьСебестоимость = Истина;
			ДокОст.Помещение = ТекПомещение;
			ДокОст.Записать(РежимЗаписиДокумента.Запись);
			СоответствиеДокументовПоПомещениям.Вставить(ТекПомещение, ДокОст.Ссылка);
		Иначе
			ДокОст = ДокСсылка.ПолучитьОбъект();
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Процедура ЗаполнитьСерииТоваров(ДокОст)
	ПараметрыУказанияСерий = Новый ФиксированнаяСтруктура(НоменклатураСервер.ПараметрыУказанияСерий(ДокОст, Документы.ВводОстатков));
	НоменклатураСервер.ЗаполнитьСтатусыУказанияСерий(ДокОст,ПараметрыУказанияСерий);
	
	Для Каждого СтрокаТовары Из ДокОст.Товары Цикл
		Если СтрокаТовары.СтатусУказанияСерий = 0 Тогда
			Продолжить;
		КонецЕсли;
		СтруктураОтбора = Новый Структура("Номенклатура, Характеристика, Склад, Помещение");
		ЗаполнитьЗначенияСвойств(СтруктураОтбора, СтрокаТовары);
		СтруктураОтбора.Склад = ДокОст.Склад;
		СтруктураОтбора.Помещение = ДокОст.Помещение;

		СтрокиСерии = ТаблицаОстаткиНаСкладахПоСериям.НайтиСтроки(СтруктураОтбора);
		Если СтрокиСерии.Количество() > 0 Тогда
			КоличествоРаспределить = СтрокаТовары.Количество;
			Для каждого СтрокаСерии ИЗ СтрокиСерии Цикл
				Если КоличествоРаспределить = 0 Тогда
					Прервать;
				КонецЕсли;
				Если СтрокаСерии.Количество = 0 Тогда
					Продолжить;
				КонецЕсли;
				НоваяСтрокаСерии = ДокОст.Серии.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрокаСерии, СтрокаСерии);
				НоваяСтрокаСерии.Количество = Мин(СтрокаСерии.Количество, КоличествоРаспределить);
				НоваяСтрокаСерии.КоличествоУпаковок = НоваяСтрокаСерии.Количество;
				
				КоличествоРаспределить = КоличествоРаспределить - НоваяСтрокаСерии.Количество;
				СтрокаСерии.Количество = СтрокаСерии.Количество - НоваяСтрокаСерии.Количество;
			КонецЦикла;
		Иначе
			СтрокаТовары.СтатусУказанияСерий = 0;
		КонецЕсли;
	КонецЦикла;  //Для Каждого СтрокаТовары Из ДокОст.Товары Цикл
	НоменклатураСервер.ЗаполнитьСтатусыУказанияСерий(ДокОст,ПараметрыУказанияСерий);

КонецПроцедуры

Процедура ЗаполнитьНазначенияТоваров(ДокОст)
	Если НЕ ИспользоватьНазначения Тогда
		Возврат;
	КонецЕсли;
	МассивСтрокКУдалению = Новый Массив;
	Для Каждого СтрокаТовары Из ДокОст.Товары Цикл
		Если СтрокаТовары.Количество = 0 Тогда
			МассивСтрокКУдалению.Добавить(СтрокаТовары);
			Продолжить;
		КонецЕсли;
		
		СтруктураОтбора = Новый Структура("Номенклатура, Характеристика, Склад, Помещение");
		ЗаполнитьЗначенияСвойств(СтруктураОтбора, СтрокаТовары);
		СтруктураОтбора.Склад = ДокОст.Склад;
		СтруктураОтбора.Помещение = ДокОст.Помещение;
		СтрокиНазначение = ТаблицаОстаткиНаСкладахПоНазначению.НайтиСтроки(СтруктураОтбора);
		Если СтрокиНазначение.Количество() = 0 Тогда
			Продолжить;
		ИначеЕсли СтрокиНазначение.Количество() = 1 И
			СтрокиНазначение[0].Количество = СтрокаТовары.Количество Тогда
			СтрокаТовары.Назначение = СтрокиНазначение[0].Назначение;
			СтрокиНазначение[0].Количество = 0;
			Продолжить;
		КонецЕсли;
		
		КоличествоРаспределить = СтрокаТовары.Количество;
		Для каждого СтрокаНазначение ИЗ СтрокиНазначение Цикл
			Если КоличествоРаспределить = 0 Тогда
				Прервать;
			КонецЕсли;
			Если СтрокаНазначение.Количество = 0 ИЛИ НЕ ЗначениеЗаполнено(СтрокаНазначение.Назначение) Тогда
				Продолжить;
			КонецЕсли;
			НоваяСтрокаТовары = ДокОст.Товары.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаТовары, СтрокаТовары);
			НоваяСтрокаТовары.Количество = Мин(СтрокаНазначение.Количество, КоличествоРаспределить);
			НоваяСтрокаТовары.КоличествоУпаковок = НоваяСтрокаТовары.Количество;
			НоваяСтрокаТовары.Назначение = СтрокаНазначение.Назначение;
			
			КоличествоРаспределить = КоличествоРаспределить - НоваяСтрокаТовары.Количество;
			СтрокаНазначение.Количество = СтрокаНазначение.Количество - НоваяСтрокаТовары.Количество;
		КонецЦикла;
		Если КоличествоРаспределить = 0 Тогда
			//Удалим старую строку в ТЧ Товары, которая распределилась полностью по назначениям
			МассивСтрокКУдалению.Добавить(СтрокаТовары);
		Иначе
			//Уменьшим количество в старой строке товаров на то, что не удалось распределить
			СтрокаТовары.Количество = КоличествоРаспределить;
			СтрокаТовары.КоличествоУпаковок = КоличествоРаспределить;
		КонецЕсли;
	КонецЦикла;
	Для Каждого СтрокаКУдалению ИЗ МассивСтрокКУдалению Цикл
		ДокОст.Товары.Удалить(СтрокаКУдалению);
	КонецЦикла;
КонецПроцедуры

Функция ПолучитьЯчейкуЗонаПриемки(Склад, Помещение)
	ТекЗонаПриемки = Неопределено;
	СтрТаб = СкладскиеЯчейки_ЗонаПриемки.НайтиСтроки(Новый Структура("Склад, Помещение", Склад, Помещение));
	Если СтрТаб.Количество() > 0 Тогда
		ТекЗонаПриемки = СтрТаб[0].ЗонаПриемки;
	КонецЕсли;
	
	Если ТекЗонаПриемки = Неопределено Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		|	Ссылка
		|ИЗ Справочник.СкладскиеЯчейки
		|ГДЕ Владелец = &Склад И ТипСкладскойЯчейки = ЗНАЧЕНИЕ(Перечисление.ТипыСкладскихЯчеек.Приемка)
		|	И Помещение = &Помещение
		|	И НЕ ПометкаУдаления";
		Запрос.УстановитьПараметр("Склад", Склад);
		Запрос.УстановитьПараметр("Помещение", Помещение);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			ТекЗонаПриемки = Выборка.Ссылка;
		Иначе
			ЯчейкаОбъект = Справочники.СкладскиеЯчейки.СоздатьЭлемент();
			ЯчейкаОбъект.Владелец = Склад;
			ЯчейкаОбъект.ТипСкладскойЯчейки = Перечисления.ТипыСкладскихЯчеек.Приемка;
			ЯчейкаОбъект.Помещение = Помещение;
			ЯчейкаОбъект.ИспользованиеПериодичностиИнвентаризацииЯчейки = Перечисления.ВариантыИспользованияПериодическойИнвентаризацииЯчеек.НеИспользовать;
			ЯчейкаОбъект.Код = НСтр("ru='Приемка';uk='Приймання'");
			ЯчейкаОбъект.Наименование = НСтр("ru='Зона приемки';uk='Зона приймання'");
			ЯчейкаОбъект.Записать();
		КонецЕсли;
		СтрТаб = СкладскиеЯчейки_ЗонаПриемки.Добавить();
		СтрТаб.Склад = Склад;
		СтрТаб.Помещение = Помещение;
		СтрТаб.ЗонаПриемки = ТекЗонаПриемки;
	КонецЕсли;
	Возврат ТекЗонаПриемки;
КонецФункции

Процедура ЗаполнитьДанныеПоУпаковкам(СтрокаТЧ)
	ТекНоменклатура = СтрокаТЧ.Номенклатура;
	Если НЕ ЗначениеЗаполнено(ТекНоменклатура) Тогда
		Возврат;
	КонецЕсли;
	ДанныеУпаковки = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ТекНоменклатура, "ИспользоватьУпаковки, НаборУпаковок");
	Если НЕ ДанныеУпаковки.ИспользоватьУпаковки ИЛИ НЕ ЗначениеЗаполнено(ДанныеУпаковки.НаборУпаковок) Тогда
		СтрокаТЧ.КоличествоУпаковок = СтрокаТЧ.Количество;
		Возврат;
	КонецЕсли;
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	|	Ссылка,
	|	Числитель,
	|	Знаменатель
	|ИЗ Справочник.УпаковкиЕдиницыИзмерения
	|ГДЕ Владелец = &Владелец И НЕ ПометкаУдаления
	|УПОРЯДОЧИТЬ ПО Числитель";
	Если ДанныеУпаковки.НаборУпаковок = Справочники.НаборыУпаковок.ИндивидуальныйДляНоменклатуры Тогда
		Запрос.УстановитьПараметр("Владелец", ТекНоменклатура);
	Иначе
		Запрос.УстановитьПараметр("Владелец", ДанныеУпаковки.НаборУпаковок);
	КонецЕсли;
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		СтрокаТЧ.Упаковка = Выборка.Ссылка;
		СтрокаТЧ.КоличествоУпаковок = Окр(СтрокаТЧ.Количество * Выборка.Знаменатель / Выборка.Числитель, 3);
	Иначе
		СтрокаТЧ.КоличествоУпаковок = СтрокаТЧ.Количество;
	КонецЕсли;
	
КонецПроцедуры

Процедура ДополнитьКомментарийДокумента(ДокОст, ТекстДополнения)
	Если Найти(СокрЛП(ДокОст.Комментарий), ТекстДополнения) = 0 Тогда
		ДокОст.Комментарий = СокрЛП(ДокОст.Комментарий) + "#" + ТекстДополнения;
	КонецЕсли;
КонецПроцедуры

Процедура ЗаполнитьПараметрыЗапросаДатаСвертки(Запрос)
	Запрос.УстановитьПараметр("ГраницаОст", Новый Граница(КонецДня(ДатаСверткиИБ),ВидГраницы.Включая));
	Запрос.УстановитьПараметр("ДатаОст", КонецДня(ДатаСверткиИБ));
КонецПроцедуры

Функция РегистрыНакопленияДокумента(ИмяЗаказа)
	МассивРегистров = Новый Массив;
	Для Каждого Регистр ИЗ Метаданные.Документы[ИмяЗаказа].Движения Цикл
		Если Найти(НРег(Регистр.ПолноеИмя()),"сведений")>0 Тогда
			Продолжить;
		КонецЕсли;
		МассивРегистров.Добавить(Регистр.Имя);
	КонецЦикла;
	Возврат МассивРегистров;
КонецФункции

Процедура ОчиститьНаборыЗаписейДвиженийДокумента(МассивРегистровНакопления, ЗаказСсылка)
	Для Каждого Рег ИЗ МассивРегистровНакопления Цикл
		НаборЗаписей = РегистрыНакопления[Рег].СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ЗаказСсылка);
		Попытка
			НаборЗаписей.Записать();
		Исключение
			ТекстСообщения = НСтр("ru='Ошибка при очистке движений документа: %ЗаказСсылка%, регистр накопления %ИмяРегистра%';uk='Помилка при очищенні рухів документа: %ЗаказСсылка%, регістр накопичення %ИмяРегистра%'");
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения,ЗаказСсылка, Рег);
			СообщениеСвертки(ТекстСообщения, Истина, ОписаниеОшибки());
		КонецПопытки;
	КонецЦикла;
КонецПроцедуры

Процедура УдалитьДвиженияПоЗаказу(ИмяРегистра, ИмяИзмерения, ЗаказСсылка)
	ЗапросЗаказы = Новый Запрос;
	ЗапросЗаказы.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Регистратор
	|ИЗ РегистрНакопления."+ИмяРегистра+".Обороты(,&ГраницаОст, Регистратор, "+ИмяИзмерения+" = &Заказ)";
	ЗаполнитьПараметрыЗапросаДатаСвертки(ЗапросЗаказы);
	ЗапросЗаказы.УстановитьПараметр("Заказ", ЗаказСсылка);
	ВыборкаЗаказы = ЗапросЗаказы.Выполнить().Выбрать();
	Пока ВыборкаЗаказы.Следующий() Цикл
		НаборЗаписей = РегистрыНакопления[ИмяРегистра].СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаЗаказы.Регистратор);
		НаборЗаписей.ОбменДанными.Загрузка = Истина;
		Попытка
			НаборЗаписей.Записать();
		Исключение
			СообщениеСвертки(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка при очистке регистра %1 по регистратору %2';uk='Помилка при очищенні регістра %1 по реєстратору %2'"), ИмяРегистра, ВыборкаЗаказы.Регистратор), Истина, ОписаниеОшибки());
		КонецПопытки;
	КонецЦикла;

КонецПроцедуры

Процедура ПровестиИлиЗаписатьДокумент(ДокОбъект)
	ЕстьОшибкаПроведения = Ложь;
	Попытка
		ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
	Исключение
		ЕстьОшибкаПроведения = Истина;
		СообщениеСвертки(НСтр("ru='Ошибка при проведении документа';uk='Помилка при проведенні документа'")+ ": " + ДокОбъект, Истина, ОписаниеОшибки());
	КонецПопытки;
	Если ЕстьОшибкаПроведения Тогда
		Попытка
			ДокОбъект.Записать(РежимЗаписиДокумента.Запись);
		Исключение
			СообщениеСвертки(НСтр("ru='Ошибка при записи документа';uk='Помилка при записі документа'")+ ": " + ДокОбъект, Истина, ОписаниеОшибки());
		КонецПопытки;
	КонецЕсли;
КонецПроцедуры

Процедура ЗаполнитьСтавкуНДСВСтрокеДокумента(СтрокаДокумента)
	Если НЕ ЗначениеЗаполнено(СтрокаДокумента.СтавкаНДС) Тогда
		СтрокаДокумента.СтавкаНДС = Справочники.СтавкиНДС.БезНДС;
		Если СтрокаДокумента.СуммаНДС > 0 
			И СтрокаДокумента.СуммаБезНДС > 0 Тогда
			СтрокаДокумента.СтавкаНДС = Справочники.СтавкиНДС.БезНДС;
			КНДС = СтрокаДокумента.Сумма / СтрокаДокумента.СуммаБезНДС;
			Если КНДС > 1.19 Тогда
				СтрокаДокумента.СтавкаНДС = УчетНДСЛокализация.СтавкаНДСПоПеречислению(Перечисления.СтавкиНДС.НДС20);
			ИначеЕсли КНДС > 1.13 Тогда
				СтрокаДокумента.СтавкаНДС = УчетНДСЛокализация.СтавкаНДСПоПеречислению(Перечисления.СтавкиНДС.НДС14);
			ИначеЕсли КНДС > 1 Тогда
				СтрокаДокумента.СтавкаНДС = УчетНДСЛокализация.СтавкаНДСПоПеречислению(Перечисления.СтавкиНДС.НДС7);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
ВалютаУправленческогоУчета = Константы.ВалютаУправленческогоУчета.Получить();

КурсыВалют = Новый Соответствие;
Комментарий_УдалитьПриСверткеБазы = НСтр("ru='[Удалить при свертке базы]';uk='[Видалити під час згортки бази]'");
Комментарий_НеУдалятьПриСверткеБазы = НСтр("ru='[Не удалять при свертке базы]';uk='[Не видаляти під час згортки бази]'");
Комментарий_СформированСверткойБазы = НСтр("ru='[Сформирован обработкой свертки базы]';uk='[Сформований обробкою згортки бази]'");
Комментарий_СкорректированСверткойБазы = НСтр("ru='[Скорректирован обработкой свертки базы]';uk='[Скоригований обробкою згортки бази]'");
КоличествоСтрокВДокументеВводаОстатков = 10000;
ИспользоватьНазначения = Константы.ИспользоватьОбособленноеОбеспечениеЗаказов.Получить();
СкладскиеЯчейки_ЗонаПриемки = Новый ТаблицаЗначений;
СкладскиеЯчейки_ЗонаПриемки.Колонки.Добавить("Склад");
СкладскиеЯчейки_ЗонаПриемки.Колонки.Добавить("Помещение");
СкладскиеЯчейки_ЗонаПриемки.Колонки.Добавить("ЗонаПриемки");
#КонецОбласти
СтруктураИспользованиеИтоговРегистровНакопления = Новый Структура;
#КонецОбласти

#КонецЕсли