# Аналіз подвійного руху в регістрі "ПрочиеАктивыПассивы"

## Документ
- **Номер**: Поступление безналичных ДС 00DL-5499 від 26.09.2025
- **UUID**: 3c8fbe8f-9ae0-11f0-80ff-00155dce3d04
- **Сума**: 234 855,00 грн
- **Операція**: Возврат ДС от поставщика

## Проблема
Регістр накопичення "ПрочиеАктивыПассивы" (в інтерфейсі - "Активы и пассивы") має подвійне списання:
- **Расход**: Выданные авансы - **469 710,00** (= 234 855 × 2) ❌
- **Приход**: Денежные средства - **234 855,00** ✅

---

## Ланцюжок формування рухів

### 1. Документ ПоступлениеБезналичныхДенежныхСредств

**Файл**: `Documents/ПоступлениеБезналичныхДенежныхСредств/Ext/ManagerModule.bsl`

Процедура проведення викликає:
```1c
// Рядок 4541
ВзаиморасчетыСервер.ПроведениеВозвратаОплатыОтПоставщика(
    Запрос,
    ТекстыЗапроса,
    Регистры,
    ТекстВозврат,
    ТекстПереносЗадолженности
);
```

Передаються **ДВА** текстових запити:
1. `ТекстВозврат` (рядки 4450-4488) - основний повернення
2. `ТекстПереносЗадолженности` (рядки 4490-4539) - перенос авансу

### 2. ВзаиморасчетыСервер

**Файл**: `CommonModules/ВзаиморасчетыСервер/Ext/Module.bsl`

Процедура `ПроведениеВозвратаОплатыОтПоставщика` (рядок 9148):
```1c
// Рядок 9177 - основні рухи
МассивТекстов.Добавить(УвеличитьНашуЗадолженностьПоставщику(Операция));

// Рядок 9185 - додаткові рухи якщо є перенос
Если ЗначениеЗаполнено(ТекстПереносРасчетов) Тогда
    МассивТекстов.Добавить(ОтразитьПереносРасчетовСПоставщиком(Запрос, Операция));
КонецЕсли;
```

### 3. Регістр РасчетыСПоставщикамиПоСрокам

Рухи формуються в регістр `РасчетыСПоставщиками`, який при новій архітектурі взаєморозрахунків записується в `РасчетыСПоставщикамиПоСрокам`.

### 4. Обробка ДвиженияАктивовПассивов

**Файл**: `DataProcessors/ДвиженияАктивовПассивов/Ext/ManagerModule.bsl`

Процедура `ДобавитьДвиженияДокумента` (рядок 72) формує рухи по регістру `ПрочиеАктивыПассивы` на основі даних регістру `РасчетыСПоставщикамиПоСрокам`.

Функція `ДобавитьТекстЗапросаРасчетыСПоставщикамиПоСрокам` (рядок 1291) формує записи:
- Стаття **"ЗадолженностьПередПоставщиками"** - по полю `ДолгУпр`
- Стаття **"ВыданныеАвансы"** - по полю `ПредоплатаУпр` (рядок 1391)

---

## Локалізація причини подвоєння

### ГІПОТЕЗА 1: Подвійний запис через перенос авансу ✅ НАЙБІЛЬШ ІМОВІРНА

**Умова виникнення**:
В документі є рядок у табличній частині `РасшифровкаПлатежа` з `ОбъектРасчетов`, який ВІДРІЗНЯЄТЬСЯ від `ОбъектРасчетов` в шапці документа.

**Запит ТекстПереносЗадолженности (рядки 4534-4538)**:
```sql
ГДЕ
    Таблица.Ссылка В (&Ссылка)
    И Документ.ХозяйственнаяОперация В (...)
    И ОбъектыРасчетов.Ссылка <> ОбъектРасчетовПлатеж.Ссылка  -- КЛЮЧОВА УМОВА!
    И Документ.ПроведеноБанком
```

**Механізм подвоєння**:
1. `ТекстВозврат` формує рухи по `ОбъектРасчетов` з шапки: **-234 855** (списання авансу)
2. `ТекстПереносЗадолженности` формує ДОДАТКОВІ рухи переносу: **-234 855** (перенос на інший об'єкт розрахунків)
3. **РАЗОМ**: 469 710 = 234 855 × 2

### ГІПОТЕЗА 2: Дублювання через два з'єднання

В запиті `ТекстВозвратАвансаПогашениеДолга` (модуль локалізації, рядки 379-390) є два INNER JOIN з однією тимчасовою таблицею:

```sql
ВНУТРЕННЕЕ СОЕДИНЕНИЕ
    РасчетыСПоставщиками КАК РасчетыПоПретензиям
ПО
    РасчетыПоПретензиям.ДокументОбъектаРасчетов = Операция.Ссылка

ВНУТРЕННЕЕ СОЕДИНЕНИЕ
    РасчетыСПоставщиками КАК Расчеты
ПО
    Расчеты.Ссылка = Операция.Ссылка
```

Це може призводити до декартового добутку при наявності кількох записів.

### ГІПОТЕЗА 3: Конфлікт оперативного та регламентованого обліку

Рухи можуть формуватися окремо:
- Через `ПоступлениеБезналичныхДенежныхСредствЛокализация` (регл. облік)
- Через `ВзаиморасчетыСервер` (оперативний облік)

---

## Рекомендації для перевірки

### Крок 1: Перевірити дані документа
```sql
ВЫБРАТЬ
    Ссылка.ОбъектРасчетов КАК ОбъектРасчетовШапка,
    РасшифровкаПлатежа.ОбъектРасчетов КАК ОбъектРасчетовСтрока,
    РасшифровкаПлатежа.СуммаВзаиморасчетов
ИЗ
    Документ.ПоступлениеБезналичныхДенежныхСредств.РасшифровкаПлатежа
ГДЕ
    Ссылка = &ДокументСсылка
```

### Крок 2: Перевірити рухи по РасчетыСПоставщикамиПоСрокам
```sql
ВЫБРАТЬ
    Период, ВидДвижения, ОбъектРасчетов,
    ПредоплатаУпр, ДолгУпр, ХозяйственнаяОперация
ИЗ
    РегистрНакопления.РасчетыСПоставщикамиПоСрокам
ГДЕ
    Регистратор = &ДокументСсылка
```

### Крок 3: Перевірити рухи по ПрочиеАктивыПассивы
```sql
ВЫБРАТЬ
    Период, ВидДвижения, Статья, Сумма, Источник
ИЗ
    РегистрНакопления.ПрочиеАктивыПассивы
ГДЕ
    Регистратор = &ДокументСсылка
```

---

## Ключові файли для аналізу

| Файл | Рядки | Опис |
|------|-------|------|
| `Documents/ПоступлениеБезналичныхДенежныхСредств/Ext/ManagerModule.bsl` | 4448-4543 | Формування запитів для розрахунків з постачальниками |
| `CommonModules/ПоступлениеБезналичныхДенежныхСредствЛокализация/Ext/Module.bsl` | 302-511 | Запити для регл. обліку (ТекстВозвратАвансаПогашениеДолга, ТекстВозвратДС) |
| `CommonModules/ВзаиморасчетыСервер/Ext/Module.bsl` | 9148-9199 | ПроведениеВозвратаОплатыОтПоставщика |
| `DataProcessors/ДвиженияАктивовПассивов/Ext/ManagerModule.bsl` | 1291-1443 | ДобавитьТекстЗапросаРасчетыСПоставщикамиПоСрокам |

---

## Очікуваний результат після виправлення

```
Расход: Выданные авансы - 234 855,00 ✅ (замість 469 710)
Приход: Денежные средства - 234 855,00 ✅
```

---

## Дата аналізу
22 листопада 2025 р.
